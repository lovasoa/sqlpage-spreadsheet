function e(e,t,n,r){Object.defineProperty(e,t,{get:n,set:r,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire26fc,n=t.register;n("ejawP",function(n,r){let o,s,i,a,l,u;e(n.exports,"SelectionMoveType",function(){return O}),e(n.exports,"SheetsSelectionsService",function(){return D}),e(n.exports,"DISABLE_NORMAL_SELECTIONS",function(){return V}),e(n.exports,"INTERCEPTOR_POINT",function(){return W}),e(n.exports,"InterceptCellContentPriority",function(){return L}),e(n.exports,"SheetInterceptorService",function(){return G}),e(n.exports,"SetRangeValuesUndoMutationFactory",function(){return el}),e(n.exports,"SetRangeValuesMutation",function(){return eu}),e(n.exports,"generateNullCellValue",function(){return eh}),e(n.exports,"ClearSelectionAllCommand",function(){return ep}),e(n.exports,"ClearSelectionContentCommand",function(){return eI}),e(n.exports,"ClearSelectionFormatCommand",function(){return eC}),e(n.exports,"InsertSheetMutation",function(){return ef}),e(n.exports,"getSheetCommandTarget",function(){return eS}),e(n.exports,"RemoveSheetMutation",function(){return eb}),e(n.exports,"CopySheetCommand",function(){return eM}),e(n.exports,"MoveRangeMutation",function(){return e_}),e(n.exports,"IRefSelectionsService",function(){return eN}),e(n.exports,"RefSelectionsService",function(){return eO}),e(n.exports,"getSelectionsService",function(){return eD}),e(n.exports,"SetSelectionsOperation",function(){return eP}),e(n.exports,"alignToMergedCellsBorders",function(){return eA}),e(n.exports,"getCellAtRowCol",function(){return eV}),e(n.exports,"setEndForRange",function(){return eW}),e(n.exports,"getPrimaryForRange",function(){return e$}),e(n.exports,"isSingleCellSelection",function(){return ej}),e(n.exports,"copyRangeStyles",function(){return eH}),e(n.exports,"MoveRangeCommand",function(){return eG}),e(n.exports,"UnitObject",function(){return eJ}),e(n.exports,"WorksheetCopyPermission",function(){return eX}),e(n.exports,"WorksheetSetCellStylePermission",function(){return eQ}),e(n.exports,"WorksheetSetCellValuePermission",function(){return e1}),e(n.exports,"WorksheetViewPermission",function(){return e5}),e(n.exports,"WorksheetSetRowStylePermission",function(){return e4}),e(n.exports,"WorksheetSetColumnStylePermission",function(){return e7}),e(n.exports,"WorksheetInsertRowPermission",function(){return e9}),e(n.exports,"WorksheetInsertColumnPermission",function(){return tt}),e(n.exports,"WorksheetInsertHyperlinkPermission",function(){return tr}),e(n.exports,"WorksheetDeleteRowPermission",function(){return ts}),e(n.exports,"WorksheetDeleteColumnPermission",function(){return ta}),e(n.exports,"WorksheetFilterPermission",function(){return td}),e(n.exports,"WorksheetEditPermission",function(){return tg}),e(n.exports,"WorkbookCommentPermission",function(){return tI}),e(n.exports,"WorkbookEditablePermission",function(){return tR}),e(n.exports,"WorkbookMoveSheetPermission",function(){return ty}),e(n.exports,"WorkbookDeleteSheetPermission",function(){return tM}),e(n.exports,"WorkbookHideSheetPermission",function(){return t_}),e(n.exports,"WorkbookRenameSheetPermission",function(){return tE}),e(n.exports,"WorkbookCreateSheetPermission",function(){return tx}),e(n.exports,"WorkbookViewPermission",function(){return tO}),e(n.exports,"WorkbookCopyPermission",function(){return tA}),e(n.exports,"WorkbookManageCollaboratorPermission",function(){return t$}),e(n.exports,"RangeProtectionPermissionEditPoint",function(){return tH}),e(n.exports,"RangeProtectionPermissionViewPoint",function(){return tG}),e(n.exports,"SetRangeValuesCommand",function(){return tq}),e(n.exports,"DeleteRangeMoveLeftCommand",function(){return tK}),e(n.exports,"DeleteRangeMoveUpCommand",function(){return tZ}),e(n.exports,"InsertRowMutation",function(){return t0}),e(n.exports,"InsertColMutation",function(){return t2}),e(n.exports,"RemoveRowMutation",function(){return t3}),e(n.exports,"RemoveColMutation",function(){return t6}),e(n.exports,"InsertRangeMoveDownCommand",function(){return t7}),e(n.exports,"InsertRangeMoveRightCommand",function(){return t9}),e(n.exports,"InsertRowCommand",function(){return nt}),e(n.exports,"InsertRowBeforeCommand",function(){return nn}),e(n.exports,"InsertRowAfterCommand",function(){return nr}),e(n.exports,"InsertColCommand",function(){return ns}),e(n.exports,"InsertColBeforeCommand",function(){return ni}),e(n.exports,"InsertColAfterCommand",function(){return na}),e(n.exports,"InsertSheetCommand",function(){return nl}),e(n.exports,"MoveRowsMutation",function(){return nd}),e(n.exports,"MoveColsMutation",function(){return nm}),e(n.exports,"MoveRowsCommand",function(){return nI}),e(n.exports,"MoveColsCommand",function(){return nR}),e(n.exports,"RemoveRowCommand",function(){return nS}),e(n.exports,"RemoveColCommand",function(){return ny}),e(n.exports,"RemoveSheetCommand",function(){return nb}),e(n.exports,"AddMergeUndoMutationFactory",function(){return nM}),e(n.exports,"AddWorksheetMergeMutation",function(){return nU}),e(n.exports,"RemoveMergeUndoMutationFactory",function(){return n_}),e(n.exports,"RemoveWorksheetMergeMutation",function(){return nT}),e(n.exports,"RemoveWorksheetMergeCommand",function(){return nE}),e(n.exports,"BorderStyleManagerService",function(){return nN}),e(n.exports,"SetBorderBasicCommand",function(){return nD}),e(n.exports,"SetBorderCommand",function(){return nW}),e(n.exports,"SetColHiddenMutation",function(){return nL}),e(n.exports,"SetColVisibleMutation",function(){return nB}),e(n.exports,"SetSpecificColsVisibleCommand",function(){return nH}),e(n.exports,"SetSelectedColsVisibleCommand",function(){return nF}),e(n.exports,"SetColHiddenCommand",function(){return nG}),e(n.exports,"SetFrozenMutationFactory",function(){return nJ}),e(n.exports,"SetFrozenMutation",function(){return nK}),e(n.exports,"SetFrozenCommand",function(){return nX}),e(n.exports,"SetRowVisibleMutation",function(){return n0}),e(n.exports,"SetRowHiddenMutation",function(){return n2}),e(n.exports,"SetSpecificRowsVisibleCommand",function(){return n5}),e(n.exports,"SetSelectedRowsVisibleCommand",function(){return n3}),e(n.exports,"SetRowHiddenCommand",function(){return n4}),e(n.exports,"SetStyleCommand",function(){return n9}),e(n.exports,"SetBoldCommand",function(){return re}),e(n.exports,"SetItalicCommand",function(){return rt}),e(n.exports,"SetUnderlineCommand",function(){return rn}),e(n.exports,"SetStrikeThroughCommand",function(){return rr}),e(n.exports,"SetFontFamilyCommand",function(){return ro}),e(n.exports,"SetFontSizeCommand",function(){return rs}),e(n.exports,"SetTextColorCommand",function(){return ri}),e(n.exports,"ResetTextColorCommand",function(){return ra}),e(n.exports,"SetBackgroundColorCommand",function(){return rl}),e(n.exports,"ResetBackgroundColorCommand",function(){return ru}),e(n.exports,"SetVerticalTextAlignCommand",function(){return rd}),e(n.exports,"SetHorizontalTextAlignCommand",function(){return rc}),e(n.exports,"SetTextWrapCommand",function(){return rm}),e(n.exports,"SetTextRotationCommand",function(){return rh}),e(n.exports,"SetTabColorMutation",function(){return rp}),e(n.exports,"SetTabColorCommand",function(){return rI}),e(n.exports,"SetWorksheetActiveOperation",function(){return rC}),e(n.exports,"SetWorksheetActivateCommand",function(){return rR}),e(n.exports,"SetWorksheetColWidthMutation",function(){return rv}),e(n.exports,"DeltaColumnWidthCommand",function(){return rS}),e(n.exports,"SetColWidthCommand",function(){return rw}),e(n.exports,"SetWorksheetHideMutation",function(){return rb}),e(n.exports,"SetWorksheetHideCommand",function(){return rM}),e(n.exports,"SetWorksheetNameMutation",function(){return r_}),e(n.exports,"SetWorksheetNameCommand",function(){return rT}),e(n.exports,"SetWorksheetOrderMutation",function(){return rk}),e(n.exports,"SetWorksheetOrderCommand",function(){return rx}),e(n.exports,"SetWorksheetRowAutoHeightMutationFactory",function(){return rD}),e(n.exports,"SetWorksheetRowHeightMutation",function(){return rP}),e(n.exports,"SetWorksheetRowIsAutoHeightMutation",function(){return rA}),e(n.exports,"SetWorksheetRowAutoHeightMutation",function(){return rV}),e(n.exports,"DeltaRowHeightCommand",function(){return rW}),e(n.exports,"SetRowHeightCommand",function(){return r$}),e(n.exports,"SetWorksheetRowIsAutoHeightCommand",function(){return rL}),e(n.exports,"SetWorksheetShowCommand",function(){return rj}),e(n.exports,"rangeMerge",function(){return rz}),e(n.exports,"INumfmtService",function(){return rY}),e(n.exports,"factorySetNumfmtUndoMutation",function(){return rJ}),e(n.exports,"transformCellsToRange",function(){return rQ}),e(n.exports,"SetNumfmtMutation",function(){return rK}),e(n.exports,"RemoveNumfmtMutation",function(){return rX}),e(n.exports,"factoryRemoveNumfmtUndoMutation",function(){return rZ}),e(n.exports,"InsertDefinedNameCommand",function(){return r1}),e(n.exports,"RemoveDefinedNameCommand",function(){return r2}),e(n.exports,"SetDefinedNameCommand",function(){return r5}),e(n.exports,"ScrollToCellOperation",function(){return r3}),e(n.exports,"WorksheetProtectionRuleModel",function(){return on}),e(n.exports,"AddWorksheetProtectionMutation",function(){return or}),e(n.exports,"SetWorksheetProtectionMutation",function(){return oo}),e(n.exports,"DeleteWorksheetProtectionMutation",function(){return os}),e(n.exports,"RangeProtectionRuleModel",function(){return od}),e(n.exports,"getAllWorksheetPermissionPoint",function(){return oc}),e(n.exports,"getAllWorksheetPermissionPointByPointPanel",function(){return om}),e(n.exports,"defaultWorksheetPermissionPoint",function(){return oh}),e(n.exports,"WorksheetProtectionPointModel",function(){return oR}),e(n.exports,"SetWorksheetPermissionPointsMutation",function(){return ob}),e(n.exports,"SetWorksheetPermissionPointsCommand",function(){return oM}),e(n.exports,"AddRangeProtectionMutation",function(){return o_}),e(n.exports,"DeleteRangeProtectionMutation",function(){return oU}),e(n.exports,"AddRangeProtectionCommand",function(){return oT}),e(n.exports,"DeleteRangeProtectionCommand",function(){return oE}),e(n.exports,"SetRangeProtectionMutation",function(){return ok}),e(n.exports,"ReorderRangeMutation",function(){return oO}),e(n.exports,"MAX_CELL_PER_SHEET_KEY",function(){return oA}),e(n.exports,"EffectRefRangId",function(){return oX}),e(n.exports,"handleMoveRows",function(){return o5}),e(n.exports,"handleMoveCols",function(){return o6}),e(n.exports,"handleMoveRange",function(){return o8}),e(n.exports,"handleIRemoveCol",function(){return st}),e(n.exports,"handleIRemoveRow",function(){return sn}),e(n.exports,"handleInsertRow",function(){return si}),e(n.exports,"handleInsertCol",function(){return sa}),e(n.exports,"handleInsertRangeMoveDown",function(){return sl}),e(n.exports,"handleInsertRangeMoveRight",function(){return sd}),e(n.exports,"handleDeleteRangeMoveLeft",function(){return sm}),e(n.exports,"handleDeleteRangeMoveUp",function(){return sg}),e(n.exports,"runRefRangeMutations",function(){return sC}),e(n.exports,"handleDefaultRangeChangeWithEffectRefCommands",function(){return sR}),e(n.exports,"handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests",function(){return sf}),e(n.exports,"handleCommonDefaultRangeChangeWithEffectRefCommands",function(){return sv}),e(n.exports,"handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests",function(){return sS}),e(n.exports,"RefRangeService",function(){return sO}),e(n.exports,"getAddMergeMutationRangeByType",function(){return sG}),e(n.exports,"MERGE_CELL_INTERCEPTOR_CHECK",function(){return sq}),e(n.exports,"MergeCellController",function(){return sz}),e(n.exports,"getAllWorkbookPermissionPoint",function(){return s3}),e(n.exports,"defaultWorkbookPermissionPoints",function(){return s4}),e(n.exports,"getAllRangePermissionPoint",function(){return il}),e(n.exports,"RangeProtectionRenderModel",function(){return ip}),e(n.exports,"IExclusiveRangeService",function(){return iV}),e(n.exports,"UniverSheetsPlugin",function(){return iq}),e(n.exports,"COMMAND_LISTENER_SKELETON_CHANGE",function(){return iz}),e(n.exports,"COMMAND_LISTENER_VALUE_CHANGE",function(){return iY}),e(n.exports,"SELECTION_CONTROL_BORDER_BUFFER_WIDTH",function(){return iJ}),e(n.exports,"SELECTION_CONTROL_BORDER_BUFFER_COLOR",function(){return iK}),e(n.exports,"getNormalSelectionStyle",function(){return iX}),e(n.exports,"convertSelectionDataToRange",function(){return iZ}),e(n.exports,"transformCellDataToSelectionData",function(){return i0}),e(n.exports,"AddMergeRedoSelectionsOperationFactory",function(){return i1}),e(n.exports,"AddMergeUndoSelectionsOperationFactory",function(){return i2}),e(n.exports,"expandToContinuousRange",function(){return ae}),e(n.exports,"checkRangesEditablePermission",function(){return at}),e(n.exports,"AddWorksheetMergeCommand",function(){return ai}),e(n.exports,"AddWorksheetMergeAllCommand",function(){return aa}),e(n.exports,"AddWorksheetMergeVerticalCommand",function(){return al}),e(n.exports,"AddWorksheetMergeHorizontalCommand",function(){return au}),e(n.exports,"addMergeCellsUtil",function(){return ad});var d,c,m=t("7yNYd"),h=t("86b1c"),g=t("k2g5B"),p=t("5LPkb"),I=t("hciHF"),C=t("i54iF"),R=t("3yupB"),f=t("c3hg1"),v=t("1mjSk"),S=t("23cfA"),w=t("2jrJe"),y=t("2BOVU"),b=t("lMvMU"),I=t("hciHF"),w=t("2jrJe"),M=Object.defineProperty,U=(e,t,n)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,_=(e,t)=>M(e,"name",{value:t,configurable:!0}),T=(e,t,n)=>U(e,"symbol"!=typeof t?t+"":t,n),E=Object.defineProperty,k=Object.getOwnPropertyDescriptor,x=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?k(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&E(t,n,s),s},"__decorateClass$i"),N=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$f"),O=((o=O||{})[o.MOVE_START=0]="MOVE_START",o[o.MOVING=1]="MOVING",o[o.MOVE_END=2]="MOVE_END",o);let D=(_(c=class extends m.RxDisposable{constructor(e){super(),T(this,"selectionMoveStart$"),T(this,"selectionMoving$"),T(this,"selectionMoveEnd$"),T(this,"_workbookSelections",/* @__PURE__ */new Map),this._instanceSrv=e,this._init()}get _currentSelectionPos(){let e=this._instanceSrv.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!e)return null;let t=e.getActiveSheet();return{unitId:e.getUnitId(),sheetId:t.getSheetId()}}get currentSelectionParam(){return this._currentSelectionPos}_init(){let e=this._instanceSrv.getCurrentTypeOfUnit$(m.UniverInstanceType.UNIVER_SHEET).pipe((0,f.shareReplay)(1),(0,w.takeUntil)(this.dispose$));this.selectionMoveStart$=e.pipe((0,S.switchMap)(e=>e?this._ensureWorkbookSelection(e.getUnitId()).selectionMoveStart$:(0,R.of)())),this.selectionMoving$=e.pipe((0,S.switchMap)(e=>e?this._ensureWorkbookSelection(e.getUnitId()).selectionMoving$:(0,R.of)())),this.selectionMoveEnd$=e.pipe((0,S.switchMap)(e=>e?this._ensureWorkbookSelection(e.getUnitId()).selectionMoveEnd$:(0,R.of)([]))),this._instanceSrv.getTypeOfUnitDisposed$(m.UniverInstanceType.UNIVER_SHEET).pipe((0,w.takeUntil)(this.dispose$)).subscribe(e=>{this._removeWorkbookSelection(e.getUnitId())})}clear(){this._workbookSelections.forEach(e=>e.clear())}getCurrentSelections(){return this._getCurrentSelections()}getCurrentLastSelection(){let e=this._getCurrentSelections();return null==e?void 0:e[e.length-1]}addSelections(e,t,n){if("string"==typeof e){this._ensureWorkbookSelection(e).addSelections(t,n);return}let r=this._currentSelectionPos;if(!r)throw Error("[SheetsSelectionsService]: cannot find current selection position!");let{unitId:o,sheetId:s}=r;this._ensureWorkbookSelection(o).addSelections(s,e)}setSelections(e,t,n,r){if("string"==typeof e){this._ensureWorkbookSelection(e).setSelections(t,n,null!=r?r:2);return}let o=this._currentSelectionPos;if(!o)throw Error("[SheetsSelectionsService]: cannot find current selection position!");let{unitId:s,sheetId:i}=o;this._ensureWorkbookSelection(s).setSelections(i,null!=e?e:n,null!=t?t:2)}clearCurrentSelections(){this._getCurrentSelections().splice(0)}isOverlapping(){let e=this.getCurrentSelections();return null!=e&&e.some(({range:t},n)=>e.some(({range:e},r)=>n!==r&&t.startRow<=e.endRow&&t.endRow>=e.startRow&&t.startColumn<=e.endColumn&&t.endColumn>=e.startColumn))}_getCurrentSelections(){let e=this._currentSelectionPos;if(!e)return[];let{unitId:t,sheetId:n}=e;return this._ensureWorkbookSelection(t).getSelectionOfWorksheet(n)}getWorkbookSelections(e){return this._ensureWorkbookSelection(e)}_ensureWorkbookSelection(e){let t=this._workbookSelections.get(e);if(!t){let n=this._instanceSrv.getUnit(e);if(!n)throw Error(`[SheetsSelectionsService]: cannot resolve unit with id "${e}"!`);t=new A(n),this._workbookSelections.set(e,t)}return t}_removeWorkbookSelection(e){this._workbookSelections.delete(e)}},"SheetsSelectionsService"),c);D=x([N(0,m.IUniverInstanceService)],D);let P=class extends m.Disposable{constructor(e){super(),T(this,"_selectionMoveStart$",new v.Subject),T(this,"selectionMoveStart$",this._selectionMoveStart$.asObservable()),T(this,"_selectionMoving$",new v.Subject),T(this,"selectionMoving$",this._selectionMoving$.asObservable()),T(this,"_selectionMoveEnd$",new p.BehaviorSubject([])),T(this,"selectionMoveEnd$",this._selectionMoveEnd$.asObservable()),T(this,"_beforeSelectionMoveEnd$",new p.BehaviorSubject([])),T(this,"beforeSelectionMoveEnd$",this._beforeSelectionMoveEnd$.asObservable()),T(this,"_worksheetSelections",/* @__PURE__ */new Map),this._workbook=e}dispose(){super.dispose(),this._beforeSelectionMoveEnd$.complete(),this._selectionMoveEnd$.complete(),this._selectionMoving$.complete(),this._selectionMoveStart$.complete()}clear(){this._worksheetSelections.clear(),this._emitOnEnd([])}addSelections(e,t){let n=this._ensureSheetSelection(e);n.push(...t),this._emitOnEnd(n)}setSelections(e,t=[],n){switch(this._ensureSheetSelection(e).length=0,this._ensureSheetSelection(e).push(...t),n){case 0:this._selectionMoveStart$.next(t);break;case 1:this._selectionMoving$.next(t);break;default:this._emitOnEnd(t)}}getCurrentSelections(){return this._getCurrentSelections()}getSelectionOfWorksheet(e){return this._worksheetSelections.has(e)?this._worksheetSelections.get(e):[]}_getCurrentSelections(){return this.getSelectionOfWorksheet(this._workbook.getActiveSheet().getSheetId())}getCurrentLastSelection(){let e=this._getCurrentSelections();return e[e.length-1]}_ensureSheetSelection(e){let t=this._worksheetSelections.get(e);return t||(t=[],this._worksheetSelections.set(e,t)),t}_emitOnEnd(e){this._beforeSelectionMoveEnd$.next(e),this._selectionMoveEnd$.next(e)}};_(P,"WorkbookSelections");let A=P,V="DISABLE_NORMAL_SELECTIONS",W={CELL_CONTENT:(0,m.createInterceptorKey)("CELL_CONTENT"),ROW_FILTERED:(0,m.createInterceptorKey)("ROW_FILTERED")};var $,L=((s=L||{})[s.DATA_VALIDATION=9]="DATA_VALIDATION",s[s.NUMFMT=10]="NUMFMT",s),j=Object.defineProperty,B=Object.getOwnPropertyDescriptor,H=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?B(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&j(t,n,s),s},"__decorateClass$h"),F=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$e");let G=($=class extends m.Disposable{constructor(e){super(),T(this,"_interceptorsByName",/* @__PURE__ */new Map),T(this,"_commandInterceptors",[]),T(this,"_rangeInterceptors",[]),T(this,"_beforeCommandInterceptor",[]),T(this,"_workbookDisposables",/* @__PURE__ */new Map),T(this,"_worksheetDisposables",/* @__PURE__ */new Map),this._univerInstanceService=e,this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(m.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{this._interceptWorkbook(e)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(m.UniverInstanceType.UNIVER_SHEET).subscribe(e=>this._disposeWorkbookInterceptor(e))),this.intercept(W.CELL_CONTENT,{priority:-1,handler(e,t){let n=t.worksheet.getCellRaw(t.row,t.col);return e?{...n,...e}:n}})}dispose(){super.dispose(),this._workbookDisposables.forEach(e=>e.dispose()),this._workbookDisposables.clear(),this._worksheetDisposables.clear()}interceptCommand(e){if(this._commandInterceptors.includes(e))throw Error("[SheetInterceptorService]: Interceptor already exists!");return this._commandInterceptors.push(e),this._commandInterceptors.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)}),this.disposeWithMe((0,m.toDisposable)(()=>(0,m.remove)(this._commandInterceptors,e)))}interceptBeforeCommand(e){if(this._beforeCommandInterceptor.includes(e))throw Error("[SheetInterceptorService]: Interceptor already exists!");return this._beforeCommandInterceptor.push(e),this._beforeCommandInterceptor.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)}),this.disposeWithMe((0,m.toDisposable)(()=>(0,m.remove)(this._beforeCommandInterceptor,e)))}async beforeCommandExecute(e){return(await Promise.all(this._beforeCommandInterceptor.map(t=>t.performCheck(e)))).every(e=>e)}interceptRanges(e){if(this._rangeInterceptors.includes(e))throw Error("[SheetInterceptorService]: Interceptor already exists!");return this._rangeInterceptors.push(e),this._rangeInterceptors.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)}),this.disposeWithMe((0,m.toDisposable)(()=>(0,m.remove)(this._rangeInterceptors,e)))}onCommandExecute(e){let t=this._commandInterceptors.map(t=>t.getMutations(e));return{preUndos:t.map(e=>{var t;return null!=(t=e.preUndos)?t:[]}).flat(),undos:t.map(e=>e.undos).flat(),preRedos:t.map(e=>{var t;return null!=(t=e.preRedos)?t:[]}).flat(),redos:t.map(e=>e.redos).flat()}}generateMutationsByRanges(e){let t=this._rangeInterceptors.map(t=>t.getMutations(e));return{preUndos:t.map(e=>{var t;return null!=(t=e.preUndos)?t:[]}).flat(),undos:t.map(e=>e.undos).flat(),preRedos:t.map(e=>{var t;return null!=(t=e.preRedos)?t:[]}).flat(),redos:t.map(e=>e.redos).flat()}}intercept(e,t){this._interceptorsByName.has(e)||this._interceptorsByName.set(e,[]);let n=this._interceptorsByName.get(e);return n.push(t),this._interceptorsByName.set(e,n.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)})),this.disposeWithMe((0,m.toDisposable)(()=>(0,m.remove)(this._interceptorsByName.get(e),t)))}fetchThroughInterceptors(e){let t=this._interceptorsByName.get(e);return(0,m.composeInterceptors)(t||[])}_interceptWorkbook(e){let t=new m.DisposableCollection,n=e.getUnitId(),r=this,o=/* @__PURE__ */_(t=>{let o=t.getSheetId();t.__interceptViewModel(s=>{let i=new m.DisposableCollection;r._worksheetDisposables.set(q(n,t),i),i.add(s.registerCellContentInterceptor({getCell:(s,i)=>r.fetchThroughInterceptors(W.CELL_CONTENT)(t.getCellRaw(s,i),{unitId:n,subUnitId:o,row:s,col:i,worksheet:t,workbook:e})})),i.add(s.registerRowFilteredInterceptor({getRowFiltered:s=>!!r.fetchThroughInterceptors(W.ROW_FILTERED)(!1,{unitId:n,subUnitId:o,row:s,workbook:e,worksheet:t})}))})},"interceptViewModel");e.getSheets().forEach(e=>o(e)),t.add(e.sheetCreated$.subscribe(e=>o(e))),t.add((0,m.toDisposable)(()=>e.getSheets().forEach(e=>this._disposeSheetInterceptor(n,e)))),t.add(e.sheetDisposed$.subscribe(e=>this._disposeSheetInterceptor(n,e))),this._workbookDisposables.set(n,t)}_disposeWorkbookInterceptor(e){let t=e.getUnitId(),n=this._workbookDisposables.get(t);n&&(n.dispose(),this._workbookDisposables.delete(t))}_disposeSheetInterceptor(e,t){let n=q(e,t),r=this._worksheetDisposables.get(n);r&&(r.dispose(),this._worksheetDisposables.delete(n))}},_($,"SheetInterceptorService"),$);function q(e,t){return`${e}|${t.getSheetId()}`}function z(e,t,n){var r;let o=e.getStyleByCell(t);null==o&&delete t.s,"string"==typeof n.s&&(n.s=e.get(n.s));let s=K(o,n.s?n.s:null);s&&(0,m.Tools).removeNull(s),(0,m.Tools).isEmptyObject(s)?delete t.s:t.s=e.setValue(s);let i=n.v?`${n.v}\r
`:"";!n.p&&t.p&&(i&&i!==(null==(r=t.p.body)?void 0:r.dataStream)?delete t.p:Z(t.p,n.s?n.s:null))}function Y(e,t){if(!t||!Object.keys(t).length)return e;let n=e||{};for(let e in t)"bd"===e?n[e]=J(n[e]||{},t[e]):e in n||(n[e]=null);return n}function J(e,t){if(!t||!Object.keys(t).length)return e;for(let n in t)n in e||(e[n]=null);return e}function K(e,t,n=!1){if(null===t)return t;if(void 0===t)return e;let r=(0,m.Tools).deepClone(e)||{};for(let e in t)n&&["bd","tr","td","ht","vt","tb","pd","bg"].includes(e)||(e in r&&"bd"===e?r[e]=Object.assign(r[e],t[e]):r[e]=t[e]);return"cl"in r&&("ul"in r&&r.ul&&(r.ul.cl=r.cl),"ol"in r&&r.ol&&(r.ol.cl=r.cl),"st"in r&&r.st&&(r.st.cl=r.cl)),r}function X(e,t){return e.some(e=>e.startIndex===t)?X(e,t+1):t}function Z(e,t){var n;if(null==e.body)return;Array.isArray(e.body.textRuns)||(e.body.textRuns=[]);let r=0,o=[],s=(null==(n=e.body)?void 0:n.paragraphs)||[];for(let n of e.body.textRuns){let{st:e,ed:i,ts:a={}}=n;if(r<e){let n={st:r,ed:e},s=K({},t,!0);s&&(0,m.Tools).removeNull(s),(0,m.Tools).isEmptyObject(s)||(n.ts=s),o.push(n)}let l=K(a,t,!0);l&&(0,m.Tools).removeNull(l),(0,m.Tools).isEmptyObject(l)?delete n.ts:n.ts=l,o.push(n),r=X(s,i)}let i=e.body.dataStream.endsWith(`\r
`)?e.body.dataStream.length-2:e.body.dataStream.length;if(r<i){let e={st:r,ed:i},n=K({},t,!0);n&&(0,m.Tools).removeNull(n),(0,m.Tools).isEmptyObject(n)||(e.ts=n),o.push(e)}e.body.textRuns=(0,m.normalizeTextRuns)(o)}function Q(e,t,n){if(t.t)return t.t;if(null===t.v)return null;let r=e.getStyleByCell(t),o=e.getStyleByCell(n);if(n.t===m.CellValueType.FORCE_STRING){if(!en(o)&&void 0!==t.v){if((0,m.isRealNum)(t.v))return m.CellValueType.NUMBER;if((0,m.isBooleanString)(`${t.v}`))return m.CellValueType.BOOLEAN}return m.CellValueType.FORCE_STRING}return et(r)?en(r)?m.CellValueType.STRING:ee(t,n):en(o)?m.CellValueType.STRING:ee(t,n)}function ee(e,t){return void 0!==e.v?er(e.v,e.t):er(t.v,t.t)}function et(e){var t;return!!(null!=(t=null==e?void 0:e.n)&&t.pattern)}function en(e){var t;return(null==(t=null==e?void 0:e.n)?void 0:t.pattern)===y.DEFAULT_TEXT_FORMAT}function er(e,t){return null===e?null:"string"==typeof e?(0,m.isRealNum)(e)?(0==+e||1==+e)&&t===m.CellValueType.BOOLEAN?m.CellValueType.BOOLEAN:m.CellValueType.NUMBER:(0,m.isBooleanString)(e)?m.CellValueType.BOOLEAN:m.CellValueType.STRING:"number"==typeof e?(0===e||1===e)&&t===m.CellValueType.BOOLEAN?m.CellValueType.BOOLEAN:m.CellValueType.NUMBER:"boolean"==typeof e?m.CellValueType.BOOLEAN:m.CellValueType.FORCE_STRING}function eo(e,t){return e.t===m.CellValueType.FORCE_STRING?m.CellValueType.FORCE_STRING:t===y.DEFAULT_TEXT_FORMAT?m.CellValueType.STRING:er(e.v,e.t)}function es(e,t){return e===m.CellValueType.NUMBER?Number(t.v):e===m.CellValueType.BOOLEAN?ei(t.v)?1:0:e===m.CellValueType.STRING||e===m.CellValueType.FORCE_STRING?`${t.v}`:t.v}function ei(e){if("string"==typeof e){if("TRUE"===e.toUpperCase())return!0;if("FALSE"===e.toUpperCase())return!1;if((0,m.isSafeNumeric)(e)){if(0===Number(e))return!1;if(1===Number(e))return!0}}if("number"==typeof e){if(0===e)return!1;if(1===e)return!0}return"boolean"==typeof e?e:null}function ea(e){return null==e?null:(void 0===e.f&&(e.f=null),void 0===e.si&&(e.si=null),void 0===e.p&&(e.p=null),void 0===e.v&&(e.v=null),void 0===e.t&&(e.t=null),void 0===e.s&&(e.s=null),void 0===e.custom&&(e.custom=null),e)}G=H([F(0,m.IUniverInstanceService)],G),_(q,"getWorksheetDisposableID"),_(z,"handleStyle"),_(Y,"transformStyle"),_(J,"transformBorders"),_(K,"mergeStyle"),_(X,"skipParagraphs"),_(Z,"mergeRichTextStyle"),_(Q,"getCellType"),_(ee,"checkCellValueTypeByValue"),_(et,"hasNumberFormat"),_(en,"isTextFormat"),_(er,"checkCellValueType"),_(eo,"getCellTypeByPattern"),_(es,"getCellValue"),_(ei,"extractBooleanValue"),_(ea,"setNull");let el=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,cellValue:o}=t,s=e.get(m.IUniverInstanceService).getUniverSheetInstance(n);if(null==s)throw Error("workbook is null error!");let i=s.getSheetBySheetId(r);if(null==i)throw Error("worksheet is null error!");let a=i.getCellMatrix(),l=s.getStyles(),u=new m.ObjectMatrix;return new(0,m.ObjectMatrix)(o).forValue((e,t,n)=>{let r=(0,m.Tools).deepClone(null==a?void 0:a.getValue(e,t))||{},o=l.getStyleByCell(r),s=l.getStyleByCell(n);r.s=Y(o,s),u.setValue(e,t,ea(r))}),{...t,options:{},cellValue:u.getMatrix()}},"SetRangeValuesUndoMutationFactory"),eu={id:"sheet.mutation.set-range-values",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{cellValue:n,subUnitId:r,unitId:o}=t,s=e.get(m.IUniverInstanceService).getUnit(o);if(!s)return!1;let i=s.getSheetBySheetId(r);if(!i)return!1;let a=i.getCellMatrix(),l=s.getStyles();return new(0,m.ObjectMatrix)(n).forValue((e,t,n)=>{if(n){let r=a.getValue(e,t)||{},o=Q(l,n,r);void 0!==n.f&&(r.f=n.f),void 0!==n.si&&(r.si=n.si),void 0!==n.p&&(r.p=n.p),void 0!==n.v&&(r.v=es(o,n)),void 0!==r.v&&(r.t=o,r.v=es(o,r)),void 0!==n.s&&z(l,r,n),void 0!==n.custom&&(r.custom=n.custom),a.setValue(e,t,(0,m.Tools).removeNull(r))}else null==a||a.setValue(e,t,{})}),!0},"handler")},ed=/* @__PURE__ */_((e,t,n="")=>e.reduce((e,r)=>{let o=r&&r[t];return"string"!=typeof o?console.warn(r,`${t} is not string`):o?(e[o]||(e[o]=[]),e[o].push(r)):e[n].push(r),e},{}),"groupByKey"),ec=/* @__PURE__ */_((e=0)=>{let t=e;return /* @__PURE__ */_(function(){return t++},"getKey")},"createUniqueKey");function em(e){let t=new m.ObjectMatrix;return e.forEach(e=>{let{startRow:n,startColumn:r,endRow:o,endColumn:s}=e;for(let e=n;e<=o;e++)for(let n=r;n<=s;n++)t.setValue(e,n,null)}),t.clone()}function eh(e){let t=new m.ObjectMatrix;return e.forEach(e=>{let{startRow:n,startColumn:r,endRow:o,endColumn:s}=e;for(let e=n;e<=o;e++)for(let n=r;n<=s;n++)t.setValue(e,n,{v:null,p:null,f:null,si:null,custom:null})}),t.clone()}function eg(e){let t=new m.ObjectMatrix;return e.forEach(e=>{let{startRow:n,startColumn:r,endRow:o,endColumn:s}=e;for(let e=n;e<=o;e++)for(let n=r;n<=s;n++)t.setValue(e,n,{s:null})}),t.clone()}_(em,"generateNullCell"),_(eh,"generateNullCellValue"),_(eg,"generateNullCellStyle");let ep={id:"sheet.command.clear-selection-all",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(m.IUniverInstanceService),r=e.get(m.ICommandService),o=e.get(D),s=e.get(m.IUndoRedoService),i=e.get(G),a=n.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getUnitId(),u=a.getActiveSheet();if(!u)return!1;let d=u.getSheetId(),c=null==(t=o.getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=c&&c.length))return!1;let h=[],g=[],p={subUnitId:d,unitId:l,cellValue:em(c)},I=el(e,p);h.push({id:eu.id,params:p}),g.push({id:eu.id,params:I});let C=i.onCommandExecute({id:ep.id});return h.push(...C.redos),g.unshift(...C.undos),!!(0,m.sequenceExecute)(h,r)&&(s.pushUndoRedo({unitID:l,undoMutations:g,redoMutations:h}),!0)},"handler")},eI={id:"sheet.command.clear-selection-content",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(m.IUniverInstanceService),r=e.get(m.ICommandService),o=e.get(D),s=e.get(m.IUndoRedoService),i=e.get(G),a=n.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getUnitId(),u=a.getActiveSheet();if(!u)return!1;let d=u.getSheetId(),c=null==(t=o.getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=c&&c.length))return!1;let h={subUnitId:d,unitId:l,cellValue:eh(c)},g=el(e,h),p=i.onCommandExecute({id:eI.id}),I=[{id:eu.id,params:h},...p.redos],C=[...p.undos,{id:eu.id,params:g}];return!!(0,m.sequenceExecute)(I,r).result&&(s.pushUndoRedo({unitID:l,undoMutations:C,redoMutations:I}),!0)},"handler")},eC={id:"sheet.command.clear-selection-format",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(m.IUniverInstanceService),r=e.get(m.ICommandService),o=e.get(D),s=e.get(m.IUndoRedoService),i=e.get(G),a=n.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getUnitId(),u=a.getActiveSheet();if(!u)return!1;let d=u.getSheetId(),c=null==(t=o.getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=c&&c.length))return!1;let h=[],g=[],p={subUnitId:d,unitId:l,cellValue:eg(c)},I=el(e,p);h.push({id:eu.id,params:p}),g.push({id:eu.id,params:I});let C=i.onCommandExecute({id:eC.id});return h.push(...C.redos),g.unshift(...C.undos),!!(0,m.sequenceExecute)(h,r)&&(s.pushUndoRedo({unitID:l,undoMutations:g,redoMutations:h}),!0)},"handler")},eR=/* @__PURE__ */_((e,t)=>({subUnitId:t.sheet.id,unitId:t.unitId,subUnitName:t.sheet.name}),"InsertSheetUndoMutationFactory"),ef={id:"sheet.mutation.insert-sheet",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService),{sheet:r,index:o,unitId:s}=t,i=n.getUniverSheetInstance(s);return!!i&&i.addWorksheet(r.id,o,r)},"handler")};function ev(e,t){let{unitId:n}=t,r=n?e.getUniverSheetInstance(n):e.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);return r?{workbook:r,unitId:r.getUnitId()}:null}function eS(e,t={}){let{unitId:n,subUnitId:r}=t,o=n?e.getUniverSheetInstance(n):e.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!o)return null;let s=r?o.getSheetBySheetId(r):o.getActiveSheet(!0);return s?{worksheet:s,workbook:o,unitId:o.getUnitId(),subUnitId:s.getSheetId()}:null}function ew(e,t){let{unitId:n,subUnitId:r}=t,o=e.getUniverSheetInstance(n);if(!o)return null;let s=o.getSheetBySheetId(r);return s?{worksheet:s,workbook:o}:null}_(ev,"getSheetCommandTargetWorkbook"),_(eS,"getSheetCommandTarget"),_(ew,"getSheetMutationTarget");let ey=/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService),{subUnitId:r,unitId:o}=t,s=ew(n,t);if(!s)throw Error("[RemoveSheetUndoMutationFactory]: Worksheet is null error!");let{workbook:i,worksheet:a}=s,l=a.getConfig();return{index:i.getConfig().sheetOrder.findIndex(e=>e===r),sheet:l,unitId:o}},"RemoveSheetUndoMutationFactory"),eb={id:"sheet.mutation.remove-sheet",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService),{subUnitId:r,unitId:o}=t,s=n.getUniverSheetInstance(o);return!!s&&s.removeSheet(r)},"handler")},eM={type:m.CommandType.COMMAND,id:"sheet.command.copy-sheet",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),o=e.get(m.IUniverInstanceService),s=e.get(m.LocaleService),i=eS(o,t);if(!i)return!1;let{workbook:a,worksheet:l,unitId:u}=i,d=(0,m.Tools).deepClone(l.getConfig());d.name=eU(a,s,d.name),d.id=(0,m.Tools).generateRandomId();let c={index:a.getSheetIndex(l)+1,sheet:d,unitId:u},h=eR(e,c);return!!n.syncExecuteCommand(ef.id,c)&&(r.pushUndoRedo({unitID:u,undoMutations:[{id:eb.id,params:h}],redoMutations:[{id:ef.id,params:c}]}),!0)},"handler")};function eU(e,t,n){let r=n+t.t("sheets.tabs.sheetCopy",""),o=2;for(;e.checkSheetName(r);)r=n+t.t("sheets.tabs.sheetCopy",`${o}`),o++;return r}_(eU,"getCopyUniqueSheetName");let e_={id:"sheet.mutation.move-range",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{from:n,to:r}=t;if(!n||!r)return!1;let o=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let s=o.getSheetBySheetId(t.from.subUnitId),i=o.getSheetBySheetId(t.to.subUnitId);if(!s||!i)return!1;let a=s.getCellMatrix(),l=i.getCellMatrix();return new(0,m.ObjectMatrix)(n.value).forValue((e,t,n)=>{a.setValue(e,t,n)}),new(0,m.ObjectMatrix)(r.value).forValue((e,t,n)=>{l.setValue(e,t,n)}),!0},"handler")};var eT=Object.defineProperty,eE=Object.getOwnPropertyDescriptor,ek=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?eE(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&eT(t,n,s),s},"__decorateClass$g"),ex=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$d");let eN=(0,m.createIdentifier)("sheets-formula.ref-selections.service"),eO=(_(r7=class extends D{constructor(e){super(e)}_init(){let e=this._getAliveWorkbooks$().pipe((0,w.takeUntil)(this.dispose$));this.selectionMoveStart$=e.pipe((0,S.switchMap)(e=>(0,C.merge)(...e.map(e=>e.selectionMoveStart$)))),this.selectionMoving$=e.pipe((0,S.switchMap)(e=>(0,C.merge)(...e.map(e=>e.selectionMoving$)))),this.selectionMoveEnd$=e.pipe((0,S.switchMap)(e=>(0,C.merge)(...e.map(e=>e.selectionMoveEnd$))))}_getAliveWorkbooks$(){let e=this._instanceSrv.getAllUnitsForType(m.UniverInstanceType.UNIVER_SHEET);e.forEach(e=>this._ensureWorkbookSelection(e.getUnitId()));let t=new p.BehaviorSubject(e);return this.disposeWithMe(this._instanceSrv.getTypeOfUnitAdded$(m.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{this._ensureWorkbookSelection(e.getUnitId()),t.next([...t.getValue(),e])})),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(m.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{this._removeWorkbookSelection(e.getUnitId()),t.next(t.getValue().filter(t=>t!==e))})),t.pipe((0,I.map)(e=>e.map(e=>this._ensureWorkbookSelection(e.getUnitId()))))}},"RefSelectionsService"),r7);function eD(e){let t=e.get(m.IContextService).getContextValue(V);return e.get(t?eN:D)}eO=ek([ex(0,m.IUniverInstanceService)],eO),_(eD,"getSelectionsService");let eP={id:"sheet.operation.set-selections",type:m.CommandType.OPERATION,handler:/* @__PURE__ */_((e,t)=>{if(!t)return!1;let{selections:n,type:r,unitId:o,subUnitId:s}=t;return eD(e).setSelections(o,s,[...n],r),!0},"handler")};function eA(e,t,n=!0){let r=t.getMatrixWithMergedCells(...(0,m.selectionToArray)(e)),o=[];if(r.forValue((t,n,r)=>{if(void 0!==r.colSpan&&void 0!==r.rowSpan){let s={startRow:t,startColumn:n,endRow:t+r.rowSpan-1,endColumn:n+r.colSpan-1};(0,m.Rectangle).contains(e,s)||o.push(s)}}),0===o.length)return e;let s=(0,m.Rectangle).union(e,...o);return n?eA(s,t,n):s}function eV(e,t,n){let r=null;return n.getMatrixWithMergedCells(e,t,e,t).forValue((e,t,n)=>(r={actualRow:e,actualColumn:t,startRow:e,startColumn:t,isMerged:void 0!==n.rowSpan||void 0!==n.colSpan,isMergedMainCell:void 0!==n.rowSpan&&void 0!==n.colSpan,endRow:e+(void 0!==n.rowSpan?n.rowSpan-1:0),endColumn:t+(void 0!==n.colSpan?n.colSpan-1:0),rangeType:m.RANGE_TYPE.NORMAL},!1)),r||{actualColumn:t,actualRow:e,startRow:e,startColumn:t,endRow:e,endColumn:t,isMerged:!1,isMergedMainCell:!1,rangeType:m.RANGE_TYPE.NORMAL}}function eW(e,t,n){let{startRow:r,startColumn:o,endRow:s,endColumn:i}=e;return Number.isNaN(r)&&(e.startRow=0),Number.isNaN(s)&&(e.endRow=t-1),Number.isNaN(o)&&(e.startColumn=0),Number.isNaN(i)&&(e.endColumn=n-1),e}function e$(e,t){let n=Number.isNaN(e.startRow)?0:e.startRow,r=Number.isNaN(e.startColumn)?0:e.startColumn,o=t.getMergedCell(n,r);return o?{...o,actualRow:n,actualColumn:r,rangeType:m.RANGE_TYPE.NORMAL,isMerged:!0,isMergedMainCell:!0}:{startRow:n,startColumn:r,endRow:e.startRow,endColumn:e.startColumn,actualRow:n,actualColumn:r,rangeType:m.RANGE_TYPE.NORMAL,isMerged:!1,isMergedMainCell:!1}}_(eA,"alignToMergedCellsBorders"),_(eV,"getCellAtRowCol"),_(eW,"setEndForRange"),_(e$,"getPrimaryForRange");let eL=/* @__PURE__ */_((e,t,n)=>({id:eP.id,params:{unitId:t.getUnitId(),subUnitId:n.getSheetId(),selections:[{range:e,primary:e$(e,n)}]}}),"followSelectionOperation");function ej(e){if(!e)return!1;let{range:t,primary:n}=e;return(0,m.Rectangle).equals(t,n)}function eB(e){function t(t,n){function r(t){for(let r=t.startRow;r<=t.endRow;r++)if(!e.getRowFiltered(r))for(let e=t.startColumn;e<=t.endColumn;e++)n(r,e,t)}_(r,"iterate"),r(t)}return _(t,"forOperableEach"),{forOperableEach:t}}function eH(e,t,n,r,o,s,i){let a={};for(let l=t;l<=n;l++)for(let t=r;t<=o;t++){let n=s?e.getCell(i,t):e.getCell(l,i);n&&n.s&&(a[l]||(a[l]={}),a[l][t]={s:n.s})}return a}_(ej,"isSingleCellSelection"),_(eB,"createRangeIteratorWithSkipFilteredRows"),_(eH,"copyRangeStyles");let eF="sheet.command.move-range",eG={type:m.CommandType.COMMAND,id:eF,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=e.get(m.IUniverInstanceService),a=e.get(m.ErrorService),l=e.get(m.LocaleService),u=e.get(G),d=eS(i);if(!d||!await u.beforeCommandExecute({id:eG.id,params:t}))return!1;let{worksheet:c,subUnitId:h,unitId:g}=d,p=eq(e,{unitId:g,subUnitId:h,range:t.fromRange},{unitId:g,subUnitId:h,range:t.toRange});if(null===p)return a.emit(l.t("sheets.info.acrossMergedCell")),!1;let I=u.onCommandExecute({id:eG.id,params:{...t}}),C=[...null!=(n=I.preRedos)?n:[],...p.redos,...I.redos,{id:eP.id,params:{unitId:g,subUnitId:h,selections:[{range:t.toRange,primary:e$(t.toRange,c)}]}}],R=[...null!=(r=I.preUndos)?r:[],...p.undos,...I.undos,{id:eP.id,params:{unitId:g,subUnitId:h,selections:[{range:t.fromRange,primary:e$(t.fromRange,c)}]}}];return!!(0,m.sequenceExecute)(C,o).result&&(s.pushUndoRedo({unitID:g,undoMutations:R,redoMutations:C}),!0)},"handler")};function eq(e,t,n,r=!1){let o=[],s=[],{range:i,subUnitId:a,unitId:l}=t,{range:u,subUnitId:d}=n,c=e.get(m.IUniverInstanceService).getUniverSheetInstance(l),h=null==c?void 0:c.getSheetBySheetId(d),g=null==c?void 0:c.getSheetBySheetId(a),p=null==h?void 0:h.getCellMatrix(),I=null==g?void 0:g.getCellMatrix();if(h&&g&&p&&I){let e=eA(u,h,!1);if(!(0,m.Rectangle).equals(u,e)&&!r)return null;let c=new m.ObjectMatrix,g=new m.ObjectMatrix;(0,m.Range).foreach(i,(e,t)=>{c.setValue(e,t,(0,m.Tools).deepClone(I.getValue(e,t))),g.setValue(e,t,null)});let C=new m.ObjectMatrix,R=new m.ObjectMatrix;(0,m.Range).foreach(u,(e,t)=>{C.setValue(e,t,(0,m.Tools).deepClone(p.getValue(e,t)))}),(0,m.Range).foreach(i,(e,t)=>{let n=(0,m.cellToRange)(e,t),r=(0,m.Rectangle).getRelativeRange(n,i),o=(0,m.Rectangle).getPositionRange(r,u);R.setValue(o.startRow,o.startColumn,(0,m.Tools).deepClone(I.getValue(e,t)))});let f={fromRange:t.range,toRange:n.range,from:{value:g.getMatrix(),subUnitId:a},to:{value:R.getMatrix(),subUnitId:d},unitId:l},v={fromRange:n.range,toRange:t.range,from:{value:c.getMatrix(),subUnitId:a},to:{value:C.getMatrix(),subUnitId:d},unitId:l};o.push({id:e_.id,params:f}),s.push({id:e_.id,params:v})}return{redos:o,undos:s}}_(eq,"getMoveRangeUndoRedoMutations");var ez=((i=ez||{})[i.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",i[i.UNIVER_DOC=1]="UNIVER_DOC",i[i.UNIVER_SHEET=2]="UNIVER_SHEET",i[i.UNIVER_SLIDE=3]="UNIVER_SLIDE",i[i.UNIVER_PROJECT=4]="UNIVER_PROJECT",i[i.UNRECOGNIZED=-1]="UNRECOGNIZED",i),eY=((a=eY||{})[a.View=0]="View",a[a.Edit=1]="Edit",a[a.ManageCollaborator=2]="ManageCollaborator",a[a.Print=3]="Print",a[a.Duplicate=4]="Duplicate",a[a.Comment=5]="Comment",a[a.Copy=6]="Copy",a[a.Share=7]="Share",a[a.Export=8]="Export",a[a.MoveWorksheet=9]="MoveWorksheet",a[a.DeleteWorksheet=10]="DeleteWorksheet",a[a.HideWorksheet=11]="HideWorksheet",a[a.RenameWorksheet=12]="RenameWorksheet",a[a.CreateWorksheet=13]="CreateWorksheet",a[a.SetWorksheetStyle=14]="SetWorksheetStyle",a[a.EditWorksheetCell=15]="EditWorksheetCell",a[a.InsertHyperlink=16]="InsertHyperlink",a[a.Sort=17]="Sort",a[a.Filter=18]="Filter",a[a.PivotTable=19]="PivotTable",a[a.FloatImg=20]="FloatImg",a[a.History=21]="History",a[a.RwHgtClWdt=22]="RwHgtClWdt",a[a.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",a[a.ViewFilter=24]="ViewFilter",a[a.MoveSheet=25]="MoveSheet",a[a.DeleteSheet=26]="DeleteSheet",a[a.HideSheet=27]="HideSheet",a[a.CopySheet=28]="CopySheet",a[a.RenameSheet=29]="RenameSheet",a[a.CreateSheet=30]="CreateSheet",a[a.SelectProtectedCells=31]="SelectProtectedCells",a[a.SelectUnProtectedCells=32]="SelectUnProtectedCells",a[a.SetCellStyle=33]="SetCellStyle",a[a.SetCellValue=34]="SetCellValue",a[a.SetRowStyle=35]="SetRowStyle",a[a.SetColumnStyle=36]="SetColumnStyle",a[a.InsertRow=37]="InsertRow",a[a.InsertColumn=38]="InsertColumn",a[a.DeleteRow=39]="DeleteRow",a[a.DeleteColumn=40]="DeleteColumn",a[a.EditExtraObject=41]="EditExtraObject",a[a.Delete=42]="Delete",a[a.RecoverHistory=43]="RecoverHistory",a[a.ViewHistory=44]="ViewHistory",a[a.UNRECOGNIZED=-1]="UNRECOGNIZED",a),eJ=((l=eJ||{})[l.Unkonwn=0]="Unkonwn",l[l.Workbook=1]="Workbook",l[l.Worksheet=2]="Worksheet",l[l.SelectRange=3]="SelectRange",l[l.Document=4]="Document",l[l.Slide=5]="Slide",l[l.UNRECOGNIZED=-1]="UNRECOGNIZED",l);let eK=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.Copy),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.Copy}_${e}_${t}`}};_(eK,"WorksheetCopyPermission");let eX=eK;_(class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.SelectProtectedCells),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.SelectProtectedCells}_${e}_${t}`}},"WorksheetSelectProtectedCellsPermission"),_(class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.SelectUnProtectedCells),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.SelectUnProtectedCells}_${e}_${t}`}},"WorksheetSelectUnProtectedCellsPermission");let eZ=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.SetCellStyle),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.SetCellStyle}_${e}_${t}`}};_(eZ,"WorksheetSetCellStylePermission");let eQ=eZ,e0=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.SetCellValue),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.SetCellValue}_${e}_${t}`}};_(e0,"WorksheetSetCellValuePermission");let e1=e0,e2=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.View),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.View}_${e}_${t}`}};_(e2,"WorksheetViewPermission");let e5=e2,e3=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.SetRowStyle),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.SetRowStyle}_${e}_${t}`}};_(e3,"WorksheetSetRowStylePermission");let e4=e3,e6=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.SetColumnStyle),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.SetColumnStyle}_${e}_${t}`}};_(e6,"WorksheetSetColumnStylePermission");let e7=e6,e8=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.InsertRow),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.InsertRow}_${e}_${t}`}};_(e8,"WorksheetInsertRowPermission");let e9=e8,te=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.InsertColumn),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.InsertColumn}_${e}_${t}`}};_(te,"WorksheetInsertColumnPermission");let tt=te,tn=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.InsertHyperlink),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.InsertHyperlink}_${e}_${t}`}};_(tn,"WorksheetInsertHyperlinkPermission");let tr=tn,to=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.DeleteRow),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.DeleteRow}_${e}_${t}`}};_(to,"WorksheetDeleteRowPermission");let ts=to,ti=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.DeleteColumn),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.DeleteColumn}_${e}_${t}`}};_(ti,"WorksheetDeleteColumnPermission");let ta=ti,tl=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.Sort),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.Sort}_${e}_${t}`}};_(tl,"WorksheetSortPermission");let tu=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.Filter),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.Filter}_${e}_${t}`}};_(tu,"WorksheetFilterPermission");let td=tu,tc=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.PivotTable),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.PivotTable}_${e}_${t}`}};_(tc,"WorksheetPivotTablePermission");let tm=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.EditExtraObject),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.EditExtraObject}_${e}_${t}`}};_(tm,"WorksheetEditExtraObjectPermission"),_(class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.ManageCollaborator),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.ManageCollaborator}_${e}_${t}`}},"WorksheetManageCollaboratorPermission");let th=class{constructor(e,t){T(this,"value",!0),T(this,"type",eJ.Worksheet),T(this,"status",m.PermissionStatus.INIT),T(this,"id"),T(this,"subType",eY.Edit),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eY.Edit}_${e}_${t}`}};_(th,"WorksheetEditPermission");let tg=th,tp=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.Comment),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.Comment}_${e}`}};_(tp,"WorkbookCommentPermission");let tI=tp,tC=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.Edit),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.Edit}_${e}`}};_(tC,"WorkbookEditablePermission");let tR=tC,tf=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.Duplicate),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.Duplicate}_${e}`}};_(tf,"WorkbookDuplicatePermission");let tv=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.Print),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.Print}_${e}`}};_(tv,"WorkbookPrintPermission");let tS=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.Export),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.Export}_${e}`}};_(tS,"WorkbookExportPermission");let tw=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.MoveSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.MoveSheet}_${e}`}};_(tw,"WorkbookMoveSheetPermission");let ty=tw,tb=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.DeleteSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.DeleteSheet}_${e}`}};_(tb,"WorkbookDeleteSheetPermission");let tM=tb,tU=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.HideSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.HideSheet}_${e}`}};_(tU,"WorkbookHideSheetPermission");let t_=tU,tT=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.RenameSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.RenameSheet}_${e}`}};_(tT,"WorkbookRenameSheetPermission");let tE=tT,tk=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.CreateSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.CreateSheet}_${e}`}};_(tk,"WorkbookCreateSheetPermission");let tx=tk;_(class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.History),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.History}_${e}`}},"WorkbookHistoryPermission");let tN=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.View),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.View}_${e}`}};_(tN,"WorkbookViewPermission");let tO=tN,tD=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.Share),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.Share}_${e}`}};_(tD,"WorkbookSharePermission");let tP=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.Copy),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.Copy}_${e}`}};_(tP,"WorkbookCopyPermission");let tA=tP,tV=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"subType",eY.CopySheet),T(this,"status",m.PermissionStatus.INIT),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.CopySheet}_${e}`}};_(tV,"WorkbookCopySheetPermission");let tW=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.ManageCollaborator),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.ManageCollaborator}_${e}`}};_(tW,"WorkbookManageCollaboratorPermission");let t$=tW,tL=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.ViewHistory),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.ViewHistory}_${e}`}};_(tL,"WorkbookViewHistoryPermission");let tj=class{constructor(e){T(this,"id"),T(this,"value",!0),T(this,"type",eJ.Workbook),T(this,"status",m.PermissionStatus.INIT),T(this,"subType",eY.RecoverHistory),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eY.RecoverHistory}_${e}`}};_(tj,"WorkbookRecoverHistoryPermission");let tB=class{constructor(e,t,n){T(this,"type",eJ.SelectRange),T(this,"subType",eY.Edit),T(this,"status",m.PermissionStatus.INIT),T(this,"value",!0),T(this,"id"),T(this,"unitId"),T(this,"subUnitId"),T(this,"permissionId"),this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${eJ.SelectRange}.${eY.Edit}.${n}`}};_(tB,"RangeProtectionPermissionEditPoint");let tH=tB,tF=class{constructor(e,t,n){T(this,"type",eJ.SelectRange),T(this,"subType",eY.View),T(this,"status",m.PermissionStatus.INIT),T(this,"value",!0),T(this,"id"),T(this,"unitId"),T(this,"subUnitId"),T(this,"permissionId"),this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${eJ.SelectRange}.${eY.View}.${n}`}};_(tF,"RangeProtectionPermissionViewPoint");let tG=tF,tq={id:"sheet.command.set-range-values",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n;let r;let o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=e.get(m.IUniverInstanceService),a=e.get(D),l=e.get(G),u=e.get(m.IPermissionService),d=eS(i,{subUnitId:t.subUnitId,unitId:t.unitId});if(!d)return!1;let{subUnitId:c,unitId:h}=d,{value:g,range:p}=t,I=p?[p]:null==(n=a.getCurrentSelections())?void 0:n.map(e=>e.range);if(!I||!I.length||!u.getPermissionPoint(new tg(h,c).id))return!1;let C=new m.ObjectMatrix;if((0,m.Tools).isArray(g))for(let e=0;e<I.length;e++){let{startRow:t,startColumn:n,endRow:r,endColumn:o}=I[e];for(let e=0;e<=r-t;e++)for(let r=0;r<=o-n;r++)C.setValue(e+t,r+n,g[e][r])}else if((0,m.isICellData)(g))for(let e=0;e<I.length;e++){let{startRow:t,startColumn:n,endRow:r,endColumn:o}=I[e];for(let e=t;e<=r;e++)for(let t=n;t<=o;t++)C.setValue(e,t,g)}else r=g;let R={subUnitId:c,unitId:h,cellValue:null!=r?r:C.getMatrix()},f=el(e,R),v=o.syncExecuteCommand(eu.id,R),{undos:S,redos:w}=l.onCommandExecute({id:tq.id,params:{...R,range:I}}),y=(0,m.sequenceExecute)([...w],o);return!!v&&!!y.result&&(s.pushUndoRedo({unitID:h,undoMutations:[{id:eu.id,params:f},...S],redoMutations:[{id:eu.id,params:R},...w]}),!0)},"handler")};function tz(e,t){let n=[],r=[],{unitId:o,subUnitId:s,range:i,shiftDimension:a,cellValue:l={}}=t,u=e.get(m.IUniverInstanceService),d=e.get(G),c=u.getUniverSheetInstance(o),h=null==c?void 0:c.getSheetBySheetId(s);if(h){let t=h.getCellMatrix(),u=t.getDataRange();if(i.startColumn<=u.endColumn||i.startRow<=u.endRow){let l,d;if(a===m.Dimension.COLUMNS){let e=Math.min(i.endRow,u.endRow),n=0;for(let r=i.startRow;r<=e;r++){let e=t.getRow(r);n=Math.max(n,e?(0,m.getArrayLength)(e)-1:0)}l={startRow:i.startRow,startColumn:i.startColumn,endRow:e,endColumn:n};let r=i.endColumn-i.startColumn+1;d={startRow:i.startRow,startColumn:l.startColumn+r,endRow:e,endColumn:l.endColumn+r}}else{let e=Math.min(i.endColumn,u.endColumn),t=u.endRow;l={startRow:i.startRow,startColumn:i.startColumn,endRow:t,endColumn:e};let n=i.endRow-i.startRow+1;d={startRow:l.startRow+n,startColumn:i.startColumn,endRow:l.endRow+n,endColumn:e}}let c=eq(e,{unitId:o,subUnitId:s,range:l},{unitId:o,subUnitId:s,range:d},!0);c&&(n.push(...c.redos),r.push(...c.undos))}if(0===Object.entries(l).length)for(let e=i.startRow;e<=i.endRow;e++){l[e]||(l[e]={});for(let t=i.startColumn;t<=i.endColumn;t++)l[e][t]=null}let c={subUnitId:s,unitId:o,cellValue:l},g=el(e,c),{undos:p,redos:I}=d.onCommandExecute({id:tq.id,params:{...c,range:i}});n.push({id:eu.id,params:c},...I),r.push({id:eu.id,params:g},...p)}return{redo:n,undo:r}}function tY(e,t){let n=[],r=[],{unitId:o,subUnitId:s,range:i,shiftDimension:a}=t,l=e.get(m.IUniverInstanceService),u=e.get(G),d=l.getUniverSheetInstance(o),c=null==d?void 0:d.getSheetBySheetId(s);if(c){let t=c.getCellMatrix(),l=t.getDataRange(),d={subUnitId:s,unitId:o,cellValue:em([i])},h=el(e,d),g=u.onCommandExecute({id:tq.id,params:d});if(n.push({id:eu.id,params:d},...g.redos),r.push(...g.undos,{id:eu.id,params:h}),i.startColumn<=l.endColumn||i.startRow<=l.endRow){let u=null,d=null;if(a===m.Dimension.COLUMNS&&i.endColumn<l.endColumn){let e=Math.min(i.endRow,l.endRow),n=0;for(let r=i.startRow;r<=e;r++){let e=t.getRow(r);n=Math.max(n,e?(0,m.getArrayLength)(e)-1:0)}u={startRow:i.startRow,startColumn:i.endColumn+1,endRow:e,endColumn:n};let r=i.endColumn-i.startColumn+1;d={startRow:i.startRow,startColumn:u.startColumn-r,endRow:e,endColumn:u.endColumn-r}}if(a===m.Dimension.ROWS&&i.endRow<l.endRow){let e=Math.min(i.endColumn,l.endColumn),t=l.endRow;u={startRow:i.endRow+1,startColumn:i.startColumn,endRow:t,endColumn:e};let n=i.endRow-i.startRow+1;d={startRow:u.startRow-n,startColumn:i.startColumn,endRow:u.endRow-n,endColumn:e}}if(u&&d){let t=eq(e,{unitId:o,subUnitId:s,range:u},{unitId:o,subUnitId:s,range:d},!0);t&&(n.push(...t.redos),r.push(...t.undos))}}}return{redo:n,undo:r}}_(tz,"getInsertRangeMutations"),_(tY,"getRemoveRangeMutations"),_(function(e,t,n,r,o,s){let{startRow:i,endRow:a,startColumn:l,endColumn:u}=t;if(o===m.Dimension.ROWS){let t=a-i+1;for(let r=n;r>=i;r--)for(let n=l;n<=u;n++){let o=e.getValue(r,n);null==o?e.realDeleteValue(r+t,n):e.setValue(r+t,n,o)}for(let t=a;t>=i;t--)for(let n=l;n<=u;n++)s&&s[t]&&s[t][n]?e.setValue(t,n,s[t][n]):e.realDeleteValue(t,n)}else if(o===m.Dimension.COLUMNS){let t=u-l+1;for(let n=i;n<=a;n++)for(let o=r;o>=l;o--){let r=e.getValue(n,o);null==r?e.realDeleteValue(n,o+t):e.setValue(n,o+t,r)}for(let t=i;t<=a;t++)for(let n=u;n>=l;n--)s&&s[t]&&s[t][n]?e.setValue(t,n,s[t][n]):e.realDeleteValue(t,n)}},"handleInsertRangeMutation"),_(function(e,t,n,r,o){let{startRow:s,endRow:i,startColumn:a,endColumn:l}=t,u=i-s+1,d=l-a+1;if(o===m.Dimension.ROWS)for(let t=s;t<=n;t++)for(let n=a;n<=l;n++){let r=e.getValue(t+u,n);null==r?e.realDeleteValue(t,n):e.setValue(t,n,r)}else if(o===m.Dimension.COLUMNS)for(let t=s;t<=i;t++)for(let n=a;n<=r;n++){let r=e.getValue(t,n+d);null==r?e.realDeleteValue(t,n):e.setValue(t,n,r)}},"handleDeleteRangeMutation");let tJ="sheet.command.delete-range-move-left",tK={type:m.CommandType.COMMAND,id:tJ,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let s=e.get(m.ICommandService),i=e.get(m.IUndoRedoService),a=e.get(m.IUniverInstanceService),l=e.get(D),u=e.get(G),d=eS(a);if(!d)return!1;let{worksheet:c,workbook:h,subUnitId:g,unitId:p}=d,I=null==t?void 0:t.range;if(I||(I=null==(n=l.getCurrentLastSelection())?void 0:n.range),!I)return!1;let C={range:I,subUnitId:g,unitId:p,shiftDimension:m.Dimension.COLUMNS},R=u.onCommandExecute({id:tK.id,params:{range:I}}),{redo:f,undo:v}=tY(e,C),S=[...null!=(r=R.preRedos)?r:[],...f],w=[...R.undos,...v];return S.push(...R.redos),S.push(eL(I,h,c)),w.push(...null!=(o=R.preUndos)?o:[]),!!(0,m.sequenceExecute)(S,s).result&&(i.pushUndoRedo({unitID:p,undoMutations:w.reverse(),redoMutations:S}),!0)},"handler")},tX="sheet.command.delete-range-move-up",tZ={type:m.CommandType.COMMAND,id:tX,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let s=e.get(m.ICommandService),i=e.get(m.IUndoRedoService),a=e.get(m.IUniverInstanceService),l=e.get(D),u=e.get(G),d=eS(a);if(!d)return!1;let{unitId:c,subUnitId:h,workbook:g,worksheet:p}=d,I=null==t?void 0:t.range;if(I||(I=null==(n=l.getCurrentLastSelection())?void 0:n.range),!I)return!1;let C={range:I,subUnitId:h,unitId:c,shiftDimension:m.Dimension.ROWS},R=u.onCommandExecute({id:tZ.id,params:{range:I}}),{redo:f,undo:v}=tY(e,C),S=[...null!=(r=R.preRedos)?r:[],...f],w=[...R.undos,...v];return S.push(...R.redos),S.push(eL(I,g,p)),w.push(...null!=(o=R.preUndos)?o:[]),!!(0,m.sequenceExecute)(S,s).result&&(i.pushUndoRedo({unitID:c,undoMutations:w.reverse(),redoMutations:S}),!0)},"handler")},tQ=/* @__PURE__ */_((e,t)=>{if(null==e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},"InsertRowMutationUndoFactory"),t0={id:"sheet.mutation.insert-row",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let{unitId:r,subUnitId:o,range:s,rowInfo:i}=t,a=e.get(m.IUniverInstanceService).getUniverSheetInstance(r);if(null==a)throw Error("universheet is null error!");let l=a.getSheetBySheetId(o);if(null==l)throw Error("worksheet is null error!");let u=l.getRowManager().getRowData(),d={h:l.getConfig().defaultRowHeight,hd:0},c=s.startRow,h=s.endRow-s.startRow+1;for(let e=c;e<c+h;e++)i?(0,m.insertMatrixArray)(e,null!=(n=i[e-s.startRow])?n:d,u):(0,m.insertMatrixArray)(e,d,u);return l.setRowCount(l.getRowCount()+s.endRow-s.startRow+1),l.getCellMatrix().insertRows(s.startRow,h),!0},"handler")},t1=/* @__PURE__ */_((e,t)=>{if(null==e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},"InsertColMutationUndoFactory"),t2={id:"sheet.mutation.insert-col",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let r=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==r)throw Error("universheet is null error!");let o=r.getSheetBySheetId(t.subUnitId);if(!o)return!1;let s=o.getColumnManager(),{range:i,colInfo:a}=t,l=s.getColumnData(),u=i.startColumn,d=i.endColumn-i.startColumn+1,c=o.getConfig().defaultColumnWidth;for(let e=u;e<u+d;e++){let t={w:c,hd:0};a?(0,m.insertMatrixArray)(e,null!=(n=a[e-i.startColumn])?n:t,l):(0,m.insertMatrixArray)(e,t,l)}return o.setColumnCount(o.getColumnCount()+i.endColumn-i.startColumn+1),o.getCellMatrix().insertColumns(i.startColumn,d),!0},"handler")},t5=/* @__PURE__ */_((e,t)=>{let n=t.getRowManager().getRowData(),r=e.range,o=(0,m.sliceMatrixArray)(r.startRow,r.endRow,n),s=(0,m.concatMatrixArray)({},o);return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,rowInfo:s}},"RemoveRowsUndoMutationFactory"),t3={id:"sheet.mutation.remove-rows",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=t.range,s=r.getRowManager().getRowData();for(let e=o.startRow;e<=o.endRow;e++)r.getRowFiltered(e);let i=o.endRow-o.startRow+1;return(0,m.spliceArray)(o.startRow,i,s),r.getCellMatrix().removeRows(o.startRow,i),r.setRowCount(r.getRowCount()-i),!0},"handler")},t4=/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(null==r)throw Error("worksheet is null error!");let o=r.getColumnManager().getColumnData(),s=t.range,i=(0,m.sliceMatrixArray)(s.startColumn,s.endColumn,o),a=(0,m.concatMatrixArray)({},i);return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,colInfo:a}},"RemoveColMutationFactory"),t6={id:"sheet.mutation.remove-col",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=t.range,s=r.getColumnManager().getColumnData(),i=o.endColumn-o.startColumn+1;return(0,m.spliceArray)(o.startColumn,i,s),r.setColumnCount(r.getColumnCount()-i),r.getCellMatrix().removeColumns(o.startColumn,i),!0},"handler")},t7={type:m.CommandType.COMMAND,id:"sheet.command.insert-range-move-down",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let s=e.get(m.ICommandService),i=e.get(m.IUndoRedoService),a=e.get(m.IUniverInstanceService),l=e.get(D),u=e.get(G),d=e.get(m.ErrorService),c=e.get(m.LocaleService);if(l.isOverlapping())return d.emit(c.t("sheets.info.overlappingSelections")),!1;let h=eS(a);if(!h)return!1;let{unitId:g,subUnitId:p,worksheet:I,workbook:C}=h,R=null==t?void 0:t.range;if(R||(R=null==(n=l.getCurrentLastSelection())?void 0:n.range),!R)return!1;let f=[],v=[],S=I.getCellMatrix(),w=S.getDataRange(),y=Math.max(S.getSlice(w.startRow,w.endRow,R.startColumn,R.endColumn).getDataRange().endRow+(R.endRow-R.startRow+1)-w.endRow,0);if(y>0){let t=R.startRow-1,n=I.getRowHeight(t),r={unitId:g,subUnitId:p,range:{startRow:w.endRow+1,endRow:w.endRow+y,startColumn:w.startColumn,endColumn:w.endColumn},rowInfo:Array(y).fill(void 0).map(()=>({h:n,hd:m.BooleanNumber.FALSE}))};f.push({id:t0.id,params:r});let o=tQ(e,r);v.push({id:t3.id,params:o})}let b={};(0,m.Range).foreach(R,(e,t)=>{let n=I.getCell(e,t);n&&(b[e]||(b[e]={}),b[e][t]={s:n.s})});let{redo:M,undo:U}=tz(e,{range:R,subUnitId:p,unitId:g,shiftDimension:m.Dimension.ROWS,cellValue:b});f.push(...M),v.push(...U);let _=u.onCommandExecute({id:t7.id,params:{range:R}});return f.push(..._.redos),f.push(eL(R,C,I)),v.push(...null!=(r=_.preUndos)?r:[]),f.unshift(...null!=(o=_.preRedos)?o:[]),v.unshift(..._.undos),!!(0,m.sequenceExecute)(f,s)&&(i.pushUndoRedo({unitID:g,undoMutations:v.reverse(),redoMutations:f}),!0)},"handler")},t8="sheet.command.insert-range-move-right",t9={type:m.CommandType.COMMAND,id:t8,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let s=e.get(m.ICommandService),i=e.get(m.IUndoRedoService),a=e.get(m.IUniverInstanceService),l=e.get(D),u=e.get(G),d=e.get(m.ErrorService),c=e.get(m.LocaleService);if(l.isOverlapping())return d.emit(c.t("sheets.info.overlappingSelections")),!1;let h=eS(a);if(!h)return!1;let{workbook:g,worksheet:p,unitId:I,subUnitId:C}=h,R=null==t?void 0:t.range;if(R||(R=null==(n=l.getCurrentLastSelection())?void 0:n.range),!R)return!1;let f=[],v=[],S=p.getCellMatrix(),w=S.getDataRange(),y=Math.max(S.getSlice(R.startRow,R.endRow,w.startColumn,w.endColumn).getDataRange().endColumn+(R.endColumn-R.startColumn+1)-w.endColumn,0);if(y>0){let t=R.startColumn-1,n=p.getColumnWidth(t),r={unitId:I,subUnitId:C,range:{startRow:w.startRow+1,endRow:w.endRow,startColumn:w.endColumn+1,endColumn:w.endColumn+y},colInfo:Array(y).fill(void 0).map(()=>({w:n,hd:m.BooleanNumber.FALSE}))};f.push({id:t2.id,params:r});let o=t1(e,r);v.push({id:t6.id,params:o})}let b={};(0,m.Range).foreach(R,(e,t)=>{let n=p.getCell(e,t);n&&n.s&&(b[e]||(b[e]={}),b[e][t]={s:n.s})});let{redo:M,undo:U}=tz(e,{range:R,subUnitId:C,unitId:I,shiftDimension:m.Dimension.COLUMNS,cellValue:b});f.push(...M),v.push(...U);let _=u.onCommandExecute({id:t9.id,params:{range:R}});return f.push(..._.redos),f.push(eL(R,g,p)),v.push(...null!=(r=_.preUndos)?r:[]),f.unshift(...null!=(o=_.preRedos)?o:[]),v.unshift(..._.undos),!!(0,m.sequenceExecute)(f,s).result&&(i.pushUndoRedo({unitID:I,undoMutations:v.reverse(),redoMutations:f}),!0)},"handler")},ne="sheet.command.insert-row",nt={type:m.CommandType.COMMAND,id:ne,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,s;let i=e.get(m.ICommandService),a=e.get(m.IUndoRedoService),l=e.get(m.IUniverInstanceService),u=e.get(G),d=l.getUniverSheetInstance(t.unitId),c=d.getSheetBySheetId(t.subUnitId),{range:h,direction:g,unitId:p,subUnitId:I,cellValue:C}=t,{startRow:R,endRow:f}=h,v=g===m.Direction.UP?R:R-1,S=c.getRowHeight(v),w={unitId:p,subUnitId:I,range:h,rowInfo:Array(f-R+1).fill(void 0).map(()=>({h:S,hd:m.BooleanNumber.FALSE}))},y=tQ(e,w);if(!await u.beforeCommandExecute({id:nt.id,params:w}))return!1;let b=[{id:t0.id,params:w}],M=[{id:t3.id,params:y}];C&&b.push({id:eu.id,params:{unitId:p,subUnitId:I,cellValue:C}});let U=u.onCommandExecute({id:nt.id,params:t});return b.unshift(...null!=(n=U.preRedos)?n:[]),b.push(...null!=(r=U.redos)?r:[]),b.push(eL(h,d,c)),M.unshift(...null!=(o=U.preUndos)?o:[]),M.push(...null!=(s=U.undos)?s:[]),!!(0,m.sequenceExecute)(b,i).result&&(a.pushUndoRedo({unitID:t.unitId,undoMutations:M,redoMutations:b}),!0)},"handler")},nn={type:m.CommandType.COMMAND,id:"sheet.command.insert-row-before",handler:/* @__PURE__ */_(async e=>{var t;let n;let r=null==(t=e.get(D).getCurrentSelections())?void 0:t.map(e=>e.range);if((null==r?void 0:r.length)!==1)return!1;n=r[0];let o=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let s=o.getActiveSheet();if(!s)return!1;let i=o.getUnitId(),a=s.getSheetId(),{startRow:l,endRow:u}=n,d=s.getColumnCount()-1,c=eH(s,l,u,0,d,!0,l-1),h={unitId:i,subUnitId:a,direction:m.Direction.UP,range:{startRow:l,endRow:u,startColumn:0,endColumn:d},cellValue:c};return e.get(m.ICommandService).executeCommand(nt.id,h)},"handler")},nr={type:m.CommandType.COMMAND,id:"sheet.command.insert-row-after",handler:/* @__PURE__ */_(async e=>{var t;let n;let r=null==(t=e.get(D).getCurrentSelections())?void 0:t.map(e=>e.range);if((null==r?void 0:r.length)!==1)return!1;n=r[0];let o=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let s=o.getActiveSheet();if(!s)return!1;let i=o.getUnitId(),a=s.getSheetId(),l=n.endRow-n.startRow+1,u=n.endRow+1,d=n.endRow+l,c=s.getColumnCount()-1,h=eH(s,u,d,0,c,!0,n.endRow),g={unitId:i,subUnitId:a,direction:m.Direction.DOWN,range:{startRow:u,endRow:d,startColumn:0,endColumn:c,rangeType:m.RANGE_TYPE.ROW},cellValue:h};return e.get(m.ICommandService).executeCommand(nt.id,g)},"handler")},no="sheet.command.insert-col",ns={type:m.CommandType.COMMAND,id:no,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,s;let i=e.get(m.ICommandService),a=e.get(m.IUndoRedoService),l=e.get(m.IUniverInstanceService),u=e.get(G),{range:d,direction:c,subUnitId:h,unitId:g,cellValue:p}=t,{startColumn:I,endColumn:C}=t.range,R=l.getUniverSheetInstance(t.unitId),f=R.getSheetBySheetId(t.subUnitId),v=c===m.Direction.LEFT?I:I-1,S=f.getColumnWidth(v),w={unitId:g,subUnitId:h,range:d,colInfo:Array(C-I+1).fill(void 0).map(()=>({w:S,hd:m.BooleanNumber.FALSE}))},y=t1(e,w);if(!await u.beforeCommandExecute({id:ns.id,params:w}))return!1;let b=[{id:t2.id,params:w}],M=[{id:t6.id,params:y}];p&&b.push({id:eu.id,params:{unitId:g,subUnitId:h,cellValue:p}});let U=u.onCommandExecute({id:ns.id,params:t});return b.unshift(...null!=(n=U.preRedos)?n:[]),b.push(...null!=(r=U.redos)?r:[]),b.push(eL(d,R,f)),M.unshift(...null!=(o=U.preUndos)?o:[]),M.push(...null!=(s=U.undos)?s:[]),!!(0,m.sequenceExecute)(b,i).result&&(a.pushUndoRedo({unitID:t.unitId,undoMutations:M.filter(Boolean),redoMutations:b.filter(Boolean)}),!0)},"handler")},ni={type:m.CommandType.COMMAND,id:"sheet.command.insert-col-before",handler:/* @__PURE__ */_(async e=>{let t;let n=e.get(D).getCurrentSelections();if((null==n?void 0:n.length)!==1)return!1;t=n[0].range;let r=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;let o=r.getActiveSheet();if(!o)return!1;let s=r.getUnitId(),i=o.getSheetId(),{startColumn:a,endColumn:l}=t,u=o.getRowCount()-1,d=eH(o,0,u,a,l,!1,a-1),c={unitId:s,subUnitId:i,direction:m.Direction.LEFT,range:{startColumn:a,endColumn:l,startRow:0,endRow:u,rangeType:m.RANGE_TYPE.COLUMN},cellValue:d};return e.get(m.ICommandService).executeCommand(ns.id,c)},"handler")},na={type:m.CommandType.COMMAND,id:"sheet.command.insert-col-after",handler:/* @__PURE__ */_(async e=>{let t;let n=e.get(D).getCurrentSelections();if((null==n?void 0:n.length)!==1)return!1;t=n[0].range;let r=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;let o=r.getActiveSheet();if(!o)return!1;let s=r.getUnitId(),i=o.getSheetId(),a=t.endColumn-t.startColumn+1,l=t.endColumn+1,u=t.endColumn+a,d=o.getRowCount()-1,c=eH(o,0,d,l,u,!1,t.endColumn),h={unitId:s,subUnitId:i,direction:m.Direction.RIGHT,range:{startColumn:l,endColumn:u,startRow:0,endRow:d},cellValue:c};return e.get(m.ICommandService).executeCommand(ns.id,h)},"handler")},nl={id:"sheet.command.insert-sheet",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n;let r=e.get(m.ICommandService),o=e.get(m.IUndoRedoService),s=e.get(m.IUniverInstanceService),i=e.get(m.LocaleService),a=ev(s,{unitId:null==t?void 0:t.unitId});if(!a)return!1;let{unitId:l,workbook:u}=a,d=u.getSheets().length,c=null==t?void 0:t.sheet,h=null==c?void 0:c.id,g=(0,m.mergeWorksheetSnapshotWithDefault)(c||{});t?(d=null!=(n=t.index)?n:d,g.id=h||(0,m.Tools).generateRandomId(),g.name=(null==c?void 0:c.name)||u.generateNewSheetName(`${i.t("sheets.tabs.sheet")}`)):(g.id=(0,m.Tools).generateRandomId(),g.name=u.generateNewSheetName(`${i.t("sheets.tabs.sheet")}`));let p={index:d,sheet:g,unitId:l},I=eR(e,p);return!!r.syncExecuteCommand(ef.id,p)&&(o.pushUndoRedo({unitID:l,undoMutations:[{id:eb.id,params:I}],redoMutations:[{id:ef.id,params:p}]}),!0)},"handler")};function nu(e,t){let{unitId:n,subUnitId:r,sourceRange:o,targetRange:s}=t,i=o.startRow>s.startRow,a=o.endRow-o.startRow+1;return i?{unitId:n,subUnitId:r,sourceRange:(0,m.Rectangle).clone(s),targetRange:{...o,endRow:o.endRow+a,startRow:o.startRow+a}}:{unitId:n,subUnitId:r,targetRange:(0,m.Rectangle).clone(o),sourceRange:{...s,endRow:s.endRow-a,startRow:s.startRow-a}}}_(nu,"MoveRowsMutationUndoFactory");let nd={id:"sheet.mutation.move-rows",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,sourceRange:o,targetRange:s}=t,i=e.get(m.IUniverInstanceService).getUniverSheetInstance(n);if(!i)throw Error("[MoveRowMutation] univerSheet is null!");let a=i.getSheetBySheetId(r);if(!a)throw Error("[MoveRowMutation] worksheet is null!");let l=o.startRow,u=o.endRow-o.startRow+1,d=s.startRow,c=a.getRowManager().getRowData();return(0,m.moveMatrixArray)(l,u,d,c),a.getCellMatrix().moveRows(l,u,d),!0},"handler")};function nc(e,t){let{unitId:n,subUnitId:r,sourceRange:o,targetRange:s}=t,i=o.startColumn>s.startColumn,a=o.endColumn-o.startColumn+1;return i?{unitId:n,subUnitId:r,sourceRange:(0,m.Rectangle).clone(s),targetRange:{...o,endColumn:o.endColumn+a,startColumn:o.startColumn+a}}:{unitId:n,subUnitId:r,targetRange:(0,m.Rectangle).clone(o),sourceRange:{...s,startColumn:s.startColumn-a,endColumn:s.endColumn-a}}}_(nc,"MoveColsMutationUndoFactory");let nm={id:"sheet.mutation.move-columns",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,sourceRange:o,targetRange:s}=t,i=e.get(m.IUniverInstanceService).getUniverSheetInstance(n);if(!i)throw Error("[MoveColumnMutation] univerSheet is null!");let a=i.getSheetBySheetId(r);if(!a)throw Error("[MoveColumnMutation] worksheet is null!");let l=o.startColumn,u=o.endColumn-o.startColumn+1,d=s.startColumn,c=a.getColumnManager().getColumnData();return(0,m.moveMatrixArray)(l,u,d,c),a.getCellMatrix().moveColumns(l,u,d),!0},"handler")};function nh(e,t){return t.getMergeData().some(t=>t.startRow<e&&e<=t.endRow)}function ng(e,t){return t.getMergeData().some(t=>t.startColumn<e&&e<=t.endColumn)}_(nh,"rowAcrossMergedCell"),_(ng,"columnAcrossMergedCell");let np="sheet.command.move-rows",nI={id:np,type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(D),{fromRange:{startRow:s},toRange:{startRow:i},range:a}=t,l=a?[nf(a)]:o.getCurrentSelections(),u=null==l?void 0:l.filter(e=>e.range.rangeType===m.RANGE_TYPE.ROW&&e.range.startRow<=s&&s<=e.range.endRow);if((null==u?void 0:u.length)!==1)return!1;let d=e.get(G),c=eS(e.get(m.IUniverInstanceService),t);if(!c)return!1;let{workbook:h,worksheet:g}=c,p=h.getUnitId(),I=g.getSheetId(),C=e.get(m.ErrorService),R=e.get(m.LocaleService),f=u[0].range,v=u[0].primary,S=eA(f,g,!1);if(!(0,m.Rectangle).equals(f,S))return C.emit(R.t("sheets.info.partOfCell")),!1;if(nh(i,g))return C.emit(R.t("sheets.info.acrossMergedCell")),!1;let w={...f,startRow:i,endRow:i+f.endRow-f.startRow},y={unitId:p,subUnitId:I,sourceRange:f,targetRange:w},b=nu(e,y),M=e.get(m.ICommandService),U=d.onCommandExecute({id:nI.id,params:t}),_=[...null!=(n=U.preRedos)?n:[],{id:nd.id,params:y}],T=[...null!=(r=U.preUndos)?r:[],{id:nd.id,params:b}];if(v){let e=i-s<0,t=f.endRow-f.startRow+1,n=e?w:{...w,startRow:w.startRow-t,endRow:w.endRow-t},r={unitId:p,subUnitId:I,selections:[{range:n,primary:e$(n,g),style:null}]};_.push({id:eP.id,params:r}),T.push({id:eP.id,params:{unitId:p,subUnitId:I,selections:[{range:f,primary:v,style:null}]}})}return _.push(...U.redos),T.push(...U.undos),!!(0,m.sequenceExecute)(_,M).result&&(e.get(m.IUndoRedoService).pushUndoRedo({unitID:p,undoMutations:T,redoMutations:_}),!0)},"handler")},nC="sheet.command.move-cols",nR={id:nC,type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(D),{fromRange:{startColumn:s},toRange:{startColumn:i},range:a}=t,l=a?[nf(a)]:o.getCurrentSelections(),u=null==l?void 0:l.filter(e=>e.range.rangeType===m.RANGE_TYPE.COLUMN&&e.range.startColumn<=s&&s<=e.range.endColumn);if((null==u?void 0:u.length)!==1)return!1;let d=e.get(G),c=eS(e.get(m.IUniverInstanceService),t);if(!c)return!1;let{workbook:h,worksheet:g}=c,p=h.getUnitId(),I=g.getSheetId(),C=e.get(m.ErrorService),R=e.get(m.LocaleService),f=u[0].range,v=u[0].primary,S=eA(f,g,!1);if(!(0,m.Rectangle).equals(f,S))return C.emit(R.t("sheets.info.partOfCell")),!1;if(ng(i,g))return C.emit(R.t("sheets.info.acrossMergedCell")),!1;let w={...f,startColumn:i,endColumn:i+f.endColumn-f.startColumn},y={unitId:p,subUnitId:I,sourceRange:f,targetRange:w},b=nc(e,y),M=e.get(m.ICommandService),U=d.onCommandExecute({id:nR.id,params:t}),_=[...null!=(n=U.preRedos)?n:[],{id:nm.id,params:y}],T=[...null!=(r=U.preUndos)?r:[],{id:nm.id,params:b}];if(v){let e=f.endColumn-f.startColumn+1,t=i-s<0?w:{...w,startColumn:w.startColumn-e,endColumn:w.endColumn-e},n={unitId:p,subUnitId:I,selections:[{range:t,primary:e$(t,g),style:null}]};_.push({id:eP.id,params:n}),T.push({id:eP.id,params:{unitId:p,subUnitId:I,selections:[{range:f,primary:v,style:null}]}})}return _.push(...U.redos),T.push(...U.undos),(0,m.sequenceExecute)(_,M).result&&e.get(m.IUndoRedoService).pushUndoRedo({unitID:p,undoMutations:T,redoMutations:_}),!0},"handler")};function nf(e){return{range:e,primary:null,style:null}}_(nf,"covertRangeToSelection");let nv="sheet.command.remove-row",nS={type:m.CommandType.COMMAND,id:nv,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,s;let i=e.get(D),a=e.get(G),l=null==t?void 0:t.range;if(l||(l=null==(n=i.getCurrentLastSelection())?void 0:n.range),!l)return!1;let u=eS(e.get(m.IUniverInstanceService));if(!u)return!1;let{workbook:d,worksheet:c,subUnitId:h,unitId:g}=u;l={...l,startColumn:0,endColumn:Math.max(c.getMaxColumns()-1,0)};let p=[];for(let e=l.startRow;e<=l.endRow;e++)c.getRowFiltered(e)&&p.push(e);let I=[];if(p.length){let e=[l.startRow,...p.map(e=>e+1)],t=[...p.map(e=>e-1),l.endRow];for(let n=e.length-1;n>=0;n--)e[n]<=t[n]&&I.push({startRow:e[n],endRow:t[n],startColumn:l.startColumn,endColumn:l.endColumn})}else I.push(l);if(!await a.beforeCommandExecute({id:nS.id,params:{range:l,ranges:I}}))return!1;let C=[],R=[];I.forEach(e=>{let t={unitId:g,subUnitId:h,range:e},n={unitId:g,subUnitId:h,cellValue:c.getCellMatrix().getSlice(e.startRow,e.endRow,0,c.getColumnCount()-1).getMatrix()},r=t5(t,c);C.push({id:t3.id,params:t}),R.unshift({id:t0.id,params:r},{id:eu.id,params:n})});let f=a.onCommandExecute({id:nS.id,params:{range:l,ranges:I}}),v=e.get(m.ICommandService);return!!(0,m.sequenceExecute)([...null!=(r=f.preRedos)?r:[],...C,...f.redos,eL(l,d,c)],v).result&&(e.get(m.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:[...null!=(o=f.preUndos)?o:[],...R,...f.undos],redoMutations:[...null!=(s=f.preRedos)?s:[],...C,...f.redos]}),!0)},"handler")},nw="sheet.command.remove-col",ny={type:m.CommandType.COMMAND,id:nw,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,s;let i=e.get(D),a=e.get(G),l=null==t?void 0:t.range;if(l||(l=null==(n=i.getCurrentLastSelection())?void 0:n.range),!l)return!1;let u=eS(e.get(m.IUniverInstanceService));if(!u)return!1;let{workbook:d,worksheet:c,subUnitId:h,unitId:g}=u,p={unitId:g,subUnitId:h,range:l={...l,startRow:0,endRow:Math.max(c.getMaxRows()-1,0)}},I=t4(e,p),C={unitId:g,subUnitId:h,cellValue:c.getCellMatrix().getSlice(0,c.getRowCount()-1,l.startColumn,l.endColumn).getMatrix()};if(!await a.beforeCommandExecute({id:ny.id,params:{range:l}}))return!1;let R=a.onCommandExecute({id:ny.id,params:{range:l}}),f=e.get(m.ICommandService);return!!(0,m.sequenceExecute)([...null!=(r=R.preRedos)?r:[],{id:t6.id,params:p},...R.redos,eL(l,d,c)],f).result&&(e.get(m.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:[...null!=(o=R.preUndos)?o:[],{id:t2.id,params:I},{id:eu.id,params:C},...R.undos],redoMutations:[...null!=(s=R.preRedos)?s:[],{id:t6.id,params:p},...R.redos]}),!0)},"handler")},nb={id:"sheet.command.remove-sheet",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=e.get(m.IUniverInstanceService),a=e.get(G),l=eS(i,t);if(!l)return!1;let{unitId:u,subUnitId:d,workbook:c,worksheet:h}=l;if(c.getSheets().length<=1)return!1;let g={subUnitId:d,unitId:u,subUnitName:h.getName()},p=ey(e,g),I=a.onCommandExecute({id:nb.id,params:{unitId:u,subUnitId:d}}),C=[...null!=(n=I.preRedos)?n:[],{id:eb.id,params:g},...I.redos],R=[...null!=(r=I.preUndos)?r:[],{id:ef.id,params:p},...I.undos];return!!(0,m.sequenceExecute)(C,o).result&&(s.pushUndoRedo({unitID:u,undoMutations:R,redoMutations:C}),!0)},"handler")},nM=/* @__PURE__ */_((e,t)=>{if(null==e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"AddMergeUndoMutationFactory"),nU={id:"sheet.mutation.add-worksheet-merge",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=r.getConfig().mergeData,s=t.ranges;for(let e=0;e<s.length;e++)o.push(s[e]);return r.getSpanModel().rebuild(o),!0},"handler")},n_=/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(null==r)throw Error("worksheet is null error!");let o=r.getConfig().mergeData,s=t.ranges,i=[];for(let e=0;e<s.length;e++)for(let t=o.length-1;t>=0;t--){let n=o[t],r=s[e];(0,m.Rectangle).intersects(n,r)&&i.push(o[t])}return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:i}},"RemoveMergeUndoMutationFactory"),nT={id:"sheet.mutation.remove-worksheet-merge",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=r.getConfig().mergeData,s=t.ranges;for(let e=0;e<s.length;e++)for(let t=o.length-1;t>=0;t--){let n=o[t],r=s[e];(0,m.Rectangle).intersects(n,r)&&o.splice(t,1)}return r.getSpanModel().rebuild(o),!0},"handler")},nE={type:m.CommandType.COMMAND,id:"sheet.command.remove-worksheet-merge",handler:/* @__PURE__ */_(async(e,t)=>{var n;let r=e.get(D),o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=e.get(m.IUniverInstanceService),a=(null==t?void 0:t.ranges)||(null==(n=r.getCurrentSelections())?void 0:n.map(e=>e.range));if(!(null!=a&&a.length))return!1;let l=eS(i);if(!l)return!1;let{subUnitId:u,unitId:d,worksheet:c}=l,h=c.getConfig().mergeData.filter(e=>a.some(t=>(0,m.Rectangle).intersects(t,e)));if(!h.length)return!1;let g=n_(e,{unitId:d,subUnitId:u,ranges:a}),p=r.getCurrentSelections();if(!(null!=p&&p.length))return!1;let I=(0,m.Tools).deepClone(p),C=(0,m.Tools).deepClone(p),R=C[C.length-1],{startRow:f,startColumn:v}=R.range;R.primary={startRow:f,startColumn:v,endRow:f,endColumn:v,actualRow:f,actualColumn:v,isMerged:!1,isMergedMainCell:!1};let S=nk(c,h),w={unitId:d,subUnitId:u,cellValue:S.redoParams.getMatrix()},y={unitId:d,subUnitId:u,cellValue:S.undoParams.getMatrix()},b=[{id:nT.id,params:g},{id:eu.id,params:w},{id:eP.id,params:{selections:C}}],M=[{id:nU.id,params:g},{id:eu.id,params:y},{id:eP.id,params:{selections:I}}];return!!(0,m.sequenceExecute)(b,o)&&(s.pushUndoRedo({unitID:d,undoMutations:M,redoMutations:b}),!0)},"handler")};function nk(e,t){let n=new m.ObjectMatrix,r=new m.ObjectMatrix;return t.forEach(t=>{let{startRow:o,startColumn:s,endColumn:i,endRow:a}=t,l=e.getCellMatrix().getValue(o,s);if(null!=l&&l.s)for(let e=o;e<=a;e++)for(let t=s;t<=i;t++)(e!==o||t!==s)&&(n.setValue(e,t,{s:l.s}),r.setValue(e,t,null))}),{redoParams:n,undoParams:r}}_(nk,"getSetRangeStyleParamsForRemoveMerge");let nx=class{constructor(){T(this,"_borderInfo",{type:m.BorderType.ALL,color:"#000000",style:m.BorderStyleTypes.THIN,activeBorderType:!1}),T(this,"_borderInfo$",new p.BehaviorSubject(this._borderInfo)),T(this,"borderInfo$",this._borderInfo$.asObservable())}dispose(){this._borderInfo$.complete()}setType(e){this._borderInfo.type=e,this.setActiveBorderType(!0),this.refresh()}setColor(e){this._borderInfo.color=e,this.refresh()}setStyle(e){this._borderInfo.style=e,this.refresh()}setActiveBorderType(e){this._borderInfo.activeBorderType=e}getBorderInfo(){return this._borderInfo}refresh(){this._borderInfo$.next(this._borderInfo)}};_(nx,"BorderStyleManagerService");let nN=nx;function nO(e,t){let{startRow:n,startColumn:r,endRow:o,endColumn:s}=e;for(let e=n;e<=o;e++)for(let n=r;n<=s;n++)t(e,n)}_(nO,"forEach");let nD={id:"sheet.command.set-border-basic",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{let{unitId:n,subUnitId:r,value:o}=t,{type:s,color:i,style:a}=o,l=e.get(m.ICommandService),u=e.get(nN);return u.setType(s),u.setColor(i),u.setStyle(a),l.executeCommand(nW.id,{unitId:n,subUnitId:r})},"handler")},nP={id:"sheet.command.set-border-position",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{if(!t.value)return!1;let n=e.get(m.ICommandService);return e.get(nN).setType(t.value),n.executeCommand(nW.id)},"handler")},nA={id:"sheet.command.set-border-style",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService);return e.get(nN).setStyle(t.value),n.executeCommand(nW.id)},"handler")},nV={id:"sheet.command.set-border-color",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService);return e.get(nN).setColor(t.value),n.executeCommand(nW.id)},"handler")},nW={id:"sheet.command.set-border",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n;let r=e.get(m.ICommandService),o=e.get(m.IUndoRedoService),s=e.get(m.IUniverInstanceService),i=e.get(D),a=e.get(nN),l=eS(s,t);if(!l)return!1;let{worksheet:u,unitId:d,subUnitId:c}=l,h=null==(n=i.getCurrentSelections())?void 0:n.map(e=>e.range);if(!(null!=h&&h.length))return!1;let{style:g,color:p,type:I,activeBorderType:C}=a.getBorderInfo();if(!C)return!1;let R=I===m.BorderType.TOP||I===m.BorderType.ALL||I===m.BorderType.OUTSIDE,f=I===m.BorderType.LEFT||I===m.BorderType.ALL||I===m.BorderType.OUTSIDE,v=I===m.BorderType.BOTTOM||I===m.BorderType.ALL||I===m.BorderType.OUTSIDE,S=I===m.BorderType.RIGHT||I===m.BorderType.ALL||I===m.BorderType.OUTSIDE,w=I===m.BorderType.VERTICAL||I===m.BorderType.ALL||I===m.BorderType.INSIDE,y=I===m.BorderType.HORIZONTAL||I===m.BorderType.ALL||I===m.BorderType.INSIDE,b=I.indexOf("tlbr")>-1,M=I.indexOf("tlbc")>-1,U=I.indexOf("tlmr")>-1,T=I.indexOf("bltr")>-1,E=I.indexOf("mltr")>-1,k=I.indexOf("bctr")>-1,x=h[0],N={startRow:x.startRow-1,startColumn:x.startColumn,endRow:x.startRow-1,endColumn:x.endColumn},O={startRow:x.startRow,startColumn:x.startColumn-1,endRow:x.endRow,endColumn:x.startColumn-1},P={startRow:x.endRow+1,startColumn:x.startColumn,endRow:x.endRow+1,endColumn:x.endColumn},A={startRow:x.startRow,startColumn:x.endColumn+1,endRow:x.endRow,endColumn:x.endColumn+1},V={startRow:x.startRow,startColumn:x.startColumn,endRow:x.startRow,endColumn:x.endColumn},W={startRow:x.startRow,startColumn:x.startColumn,endRow:x.endRow,endColumn:x.startColumn},$={startRow:x.endRow,startColumn:x.startColumn,endRow:x.endRow,endColumn:x.endColumn},L={startRow:x.startRow,startColumn:x.endColumn,endRow:x.endRow,endColumn:x.endColumn},j=new m.ObjectMatrix,B={s:g,cl:{rgb:p}};function H(e,t,n){e.startRow<0||e.startColumn<0||nO(e,(e,r)=>{var o,s;let i=u.getMergedCell(e,r),a=t;if(i&&(t.bc_tr||t.ml_tr||t.bl_tr||t.tl_mr||t.tl_bc||t.tl_br)){if(n){let e=(0,m.Tools).deepClone(null==(o=j.getValue(i.startRow,i.startColumn))?void 0:o.s);a=null!=e&&e.bd?Object.assign(e.bd,t):t}j.setValue(i.startRow,i.startColumn,{s:{bd:a}})}else{if(n){let n=(0,m.Tools).deepClone(null==(s=j.getValue(e,r))?void 0:s.s);a=null!=n&&n.bd?Object.assign(n.bd,t):t}j.setValue(e,r,{s:{bd:a}})}})}_(H,"setBorderStyle"),R&&(H(N,{b:null}),H(V,{t:(0,m.Tools).deepClone(B)},!0)),v&&(H(P,{t:null}),H($,{b:(0,m.Tools).deepClone(B)},!0)),f&&(H(O,{r:null}),H(W,{l:(0,m.Tools).deepClone(B)},!0)),S&&(H(A,{l:null}),H(L,{r:(0,m.Tools).deepClone(B)},!0)),b&&H(x,{tl_br:(0,m.Tools).deepClone(B)},!0),M&&H(x,{tl_bc:(0,m.Tools).deepClone(B)},!0),U&&H(x,{tl_mr:(0,m.Tools).deepClone(B)},!0),T&&H(x,{bl_tr:(0,m.Tools).deepClone(B)},!0),E&&H(x,{ml_tr:(0,m.Tools).deepClone(B)},!0),k&&H(x,{bc_tr:(0,m.Tools).deepClone(B)},!0),w&&nO(x,(e,t)=>{var n,r,o,s;let i=u.getMergedCell(e,t);if(i){if(i.endColumn!==x.endColumn){let r=null==(n=j.getValue(i.startRow,i.startColumn))?void 0:n.s;j.setValue(e,t,{s:{bd:null!=r&&r.bd?Object.assign(r.bd,{r:(0,m.Tools).deepClone(B)}):{r:(0,m.Tools).deepClone(B)}}})}if(i.startColumn!==x.startColumn){let n=null==(r=j.getValue(i.startRow,i.startColumn))?void 0:r.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{l:(0,m.Tools).deepClone(B)}):{l:(0,m.Tools).deepClone(B)}}})}}else{if(t!==x.endColumn){let n=null==(o=j.getValue(e,t))?void 0:o.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{r:(0,m.Tools).deepClone(B)}):{r:(0,m.Tools).deepClone(B)}}})}if(t!==x.startColumn){let n=null==(s=j.getValue(e,t))?void 0:s.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{l:(0,m.Tools).deepClone(B)}):{l:(0,m.Tools).deepClone(B)}}})}}}),y&&nO(x,(e,t)=>{var n,r,o,s;let i=u.getMergedCell(e,t);if(i){if(i.endRow!==x.endRow){let r=null==(n=j.getValue(i.startRow,i.startColumn))?void 0:n.s;j.setValue(e,t,{s:{bd:null!=r&&r.bd?Object.assign(r.bd,{b:(0,m.Tools).deepClone(B)}):{b:(0,m.Tools).deepClone(B)}}})}if(i.startRow!==x.startRow){let n=null==(r=j.getValue(i.startRow,i.startColumn))?void 0:r.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{t:(0,m.Tools).deepClone(B)}):{t:(0,m.Tools).deepClone(B)}}})}}else{if(e!==x.endRow){let n=null==(o=j.getValue(e,t))?void 0:o.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{b:(0,m.Tools).deepClone(B)}):{b:(0,m.Tools).deepClone(B)}}})}if(e!==x.startRow){let n=null==(s=j.getValue(e,t))?void 0:s.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{t:(0,m.Tools).deepClone(B)}):{t:(0,m.Tools).deepClone(B)}}})}}}),R||v||f||S||w||y||b||M||U||T||E||k||(H(N,{b:null}),H(V,{t:null},!0),H(P,{t:null}),H($,{b:null},!0),H(O,{r:null}),H(W,{l:null},!0),H(A,{l:null}),H(L,{r:null},!0),H(x,{tl_br:null},!0),H(x,{tl_bc:null},!0),H(x,{tl_mr:null},!0),H(x,{bl_tr:null},!0),H(x,{ml_tr:null},!0),H(x,{bc_tr:null},!0),nO(x,(e,t)=>{var n,r,o,s,i,a,l,d;let c=u.getMergedCell(e,t);if(c){if(c.endColumn!==x.endColumn){let r=null==(n=j.getValue(c.startRow,c.startColumn))?void 0:n.s;j.setValue(e,t,{s:{bd:null!=r&&r.bd?Object.assign(r.bd,{r:null}):{r:null}}})}if(c.startColumn!==x.startColumn){let n=null==(r=j.getValue(c.startRow,c.startColumn))?void 0:r.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{l:null}):{l:null}}})}if(c.endRow!==x.endRow){let n=null==(o=j.getValue(c.startRow,c.startColumn))?void 0:o.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{b:null}):{b:null}}})}if(c.startRow!==x.startRow){let n=null==(s=j.getValue(c.startRow,c.startColumn))?void 0:s.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{t:null}):{t:null}}})}}else{if(t!==x.endColumn){let n=null==(i=j.getValue(e,t))?void 0:i.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{r:null}):{r:null}}})}if(t!==x.startColumn){let n=null==(a=j.getValue(e,t))?void 0:a.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{l:null}):{l:null}}})}if(e!==x.endRow){let n=null==(l=j.getValue(e,t))?void 0:l.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{b:null}):{b:null}}})}if(e!==x.startRow){let n=null==(d=j.getValue(e,t))?void 0:d.s;j.setValue(e,t,{s:{bd:null!=n&&n.bd?Object.assign(n.bd,{t:null}):{t:null}}})}}}));let F={unitId:d,subUnitId:c,cellValue:j.getData()},G=el(e,F);return!!r.syncExecuteCommand(eu.id,F)&&(o.pushUndoRedo({unitID:d,undoMutations:[{id:eu.id,params:G}],redoMutations:[{id:eu.id,params:F}]}),!0)},"handler")},n$=/* @__PURE__ */_((e,t)=>{if(null==e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetColHiddenUndoMutationFactory"),nL={id:"sheet.mutation.set-col-hidden",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startColumn;e<n.endColumn+1;e++){let t=r.getColumnOrCreate(e);null!=t&&(t.hd=m.BooleanNumber.TRUE)}}return!0},"handler")},nj=/* @__PURE__ */_((e,t)=>{if(null==e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetColVisibleUndoMutationFactory"),nB={id:"sheet.mutation.set-col-visible",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startColumn;e<n.endColumn+1;e++){let t=r.getColumnOrCreate(e);null!=t&&(t.hd=m.BooleanNumber.FALSE)}}return!0},"handler")},nH={type:m.CommandType.COMMAND,id:"sheet.command.set-col-visible-on-cols",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let{unitId:o,subUnitId:s,ranges:i}=t,a=e.get(G),l=e.get(m.ICommandService),u=eS(e.get(m.IUniverInstanceService),{unitId:o,subUnitId:s});if(!u)return!1;let{worksheet:d}=u,c={unitId:o,subUnitId:s,ranges:i},h={unitId:o,subUnitId:s,reveal:!0,selections:i.map(e=>({range:e,primary:e$(e,d),style:null}))},g=nj(e,c),p={unitId:o,subUnitId:s,selections:nz(i).map(e=>({range:e,primary:e$(e,d),style:null}))},I=(0,m.sequenceExecute)([{id:nB.id,params:c},{id:eP.id,params:h}],l),C=a.onCommandExecute({id:nH.id,params:t}),R=(0,m.sequenceExecute)([...C.redos],l);return I.result&&R.result&&e.get(m.IUndoRedoService).pushUndoRedo({unitID:o,undoMutations:[{id:nL.id,params:g},{id:eP.id,params:p},...null!=(n=C.undos)?n:[]],redoMutations:[...null!=(r=C.preRedos)?r:[],{id:nB.id,params:c},{id:eP.id,params:h},...C.redos]}),!0},"handler")},nF={type:m.CommandType.COMMAND,id:"sheet.command.set-selected-cols-visible",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(D),r=e.get(m.ICommandService),o=null==(t=n.getCurrentSelections())?void 0:t.map(e=>e.range).filter(e=>e.rangeType===m.RANGE_TYPE.COLUMN);if(!(null!=o&&o.length))return!1;let s=eS(e.get(m.IUniverInstanceService));if(!s)return!1;let{worksheet:i,unitId:a,subUnitId:l}=s,u=o.map(e=>i.getHiddenCols(e.startColumn,e.endColumn)).flat();return r.executeCommand(nH.id,{unitId:a,subUnitId:l,ranges:u})},"handler")},nG={type:m.CommandType.COMMAND,id:"sheet.command.set-col-hidden",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,s;let i=e.get(D),a=e.get(G),l=e.get(m.IUniverInstanceService),u=e.get(m.ICommandService),d=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=i.getCurrentSelections())?void 0:r.map(e=>e.range).filter(e=>e.rangeType===m.RANGE_TYPE.COLUMN);if(!(null!=d&&d.length))return!1;let c=eS(l,t);if(!c)return!1;let{worksheet:h,unitId:g,subUnitId:p}=c,I={unitId:g,subUnitId:p,ranges:d=nq(c.worksheet,d)},C={unitId:g,subUnitId:p,selections:nz(d).map(e=>({range:e,primary:e$(e,h),style:null}))},R=n$(e,I),f={unitId:g,subUnitId:p,reveal:!0,selections:d.map(e=>({range:e,primary:e$(e,h),style:null}))},v=(0,m.sequenceExecute)([{id:nL.id,params:I},{id:eP.id,params:C}],u),S=a.onCommandExecute({id:nG.id,params:I}),w=(0,m.sequenceExecute)([...S.redos],u);return!!v.result&&!!w.result&&(e.get(m.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:[{id:nB.id,params:R},{id:eP.id,params:f},...null!=(o=S.undos)?o:[]],redoMutations:[...null!=(s=S.preRedos)?s:[],{id:nL.id,params:I},{id:eP.id,params:C},...S.redos]}),!0)},"handler")};function nq(e,t){let n=e.getRowCount()-1,r=e.getHiddenCols(),o=[];return t.forEach(e=>{let t=r.filter(t=>t.startColumn>=e.startColumn&&t.endColumn<=e.endColumn);if(t.length){let r=e.startColumn;t.forEach(e=>{e.startColumn>r&&(o.push({startColumn:r,endColumn:e.startColumn-1,startRow:0,endRow:n}),r=e.endColumn+1)}),r<=e.endColumn&&o.push({startColumn:r,endColumn:e.endColumn,startRow:0,endRow:n})}else o.push(e)}),o}function nz(e){return nY(e).map(e=>{let t=0===e.startColumn?e.endColumn+1:e.startColumn-1;return{...e,startColumn:t,endColumn:t}})}function nY(e){let t;let n=[];return e.sort((e,t)=>e.startColumn-t.startColumn).forEach(e=>{if(!t){t=e;return}t.endColumn===e.startColumn-1?t.endColumn=e.endColumn:(n.push(t),t=e)}),n.push(t),n}_(nq,"divideRangesByHiddenCols"),_(nz,"getSelectionsAfterHiding$1"),_(nY,"mergeSelections$1");let nJ=/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(null==r)throw Error("worksheet is null error!");let o=r.getConfig().freeze;return{unitId:t.unitId,subUnitId:t.subUnitId,...o}},"SetFrozenMutationFactory"),nK={id:"sheet.mutation.set-frozen",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=r.getConfig(),{startRow:s,startColumn:i,ySplit:a,xSplit:l}=t;return o.freeze={startRow:s,startColumn:i,ySplit:a,xSplit:l},!0},"handler")},nX={type:m.CommandType.COMMAND,id:"sheet.command.set-frozen",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),o=eS(e.get(m.IUniverInstanceService));if(!o)return!1;let{unitId:s,subUnitId:i,worksheet:a}=o,{startColumn:l,startRow:u,xSplit:d,ySplit:c}=t;if(u>=a.getRowCount()||l>=a.getColumnCount()||d>=a.getColumnCount()||c>=a.getRowCount())return!1;let h={unitId:s,subUnitId:i,...t},g=nJ(e,h);return!!n.syncExecuteCommand(nK.id,h)&&(r.pushUndoRedo({unitID:s,undoMutations:[{id:nK.id,params:g}],redoMutations:[{id:nK.id,params:h}]}),!0)},"handler")},nZ={type:m.CommandType.COMMAND,id:"sheet.command.set-frozen-cancel",handler:/* @__PURE__ */_(async e=>{let t=e.get(m.ICommandService),n=e.get(m.IUndoRedoService),r=eS(e.get(m.IUniverInstanceService));if(!r)return!1;let{unitId:o,subUnitId:s}=r,i={unitId:o,subUnitId:s,startRow:-1,startColumn:-1,ySplit:0,xSplit:0},a=nJ(e,i);return!!t.syncExecuteCommand(nK.id,i)&&(n.pushUndoRedo({unitID:o,undoMutations:[{id:nK.id,params:a}],redoMutations:[{id:nK.id,params:i}]}),!0)},"handler")},nQ=/* @__PURE__ */_((e,t)=>{if(null==e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetRowVisibleUndoMutationFactory"),n0={id:"sheet.mutation.set-row-visible",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startRow;e<n.endRow+1;e++){let t=r.getRowOrCreate(e);null!=t&&(t.hd=0)}}return!0},"handler")},n1=/* @__PURE__ */_((e,t)=>{if(null==e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetRowHiddenUndoMutationFactory"),n2={id:"sheet.mutation.set-row-hidden",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startRow;e<n.endRow+1;e++){let t=r.getRowOrCreate(e);null!=t&&(t.hd=1)}}return!0},"handler")},n5={type:m.CommandType.COMMAND,id:"sheet.command.set-specific-rows-visible",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let{unitId:s,subUnitId:i,ranges:a}=t,l=e.get(m.ICommandService),u=e.get(m.IUndoRedoService),d=e.get(G),c=eS(e.get(m.IUniverInstanceService),{unitId:s,subUnitId:i});if(!c)return!1;let{worksheet:h}=c,g={unitId:s,subUnitId:i,ranges:a},p={unitId:s,subUnitId:i,reveal:!0,selections:a.map(e=>({range:e,primary:e$(e,h),style:null}))},I=nQ(e,g),C={unitId:s,subUnitId:i,selections:n7(a).map(e=>({range:e,primary:e$(e,h),style:null}))},R=(0,m.sequenceExecute)([{id:n0.id,params:g},{id:eP.id,params:p}],l),f=d.onCommandExecute({id:n5.id,params:t}),v=(0,m.sequenceExecute)([...f.redos],l);return R.result&&v.result&&u.pushUndoRedo({unitID:s,undoMutations:[...null!=(n=f.preUndos)?n:[],{id:n2.id,params:I},{id:eP.id,params:C},...null!=(r=f.undos)?r:[]],redoMutations:[...null!=(o=f.preRedos)?o:[],{id:n0.id,params:g},{id:eP.id,params:p},...f.redos]}),!0},"handler")},n3={type:m.CommandType.COMMAND,id:"sheet.command.set-selected-rows-visible",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(D),r=e.get(m.IUniverInstanceService),o=e.get(m.ICommandService),s=null==(t=n.getCurrentSelections())?void 0:t.map(e=>e.range).filter(e=>e.rangeType===m.RANGE_TYPE.ROW);if(!(null!=s&&s.length))return!1;let i=eS(r);if(!i)return!1;let{worksheet:a,unitId:l,subUnitId:u}=i,d=s.map(e=>a.getHiddenRows(e.startRow,e.endRow)).flat();return o.executeCommand(n5.id,{unitId:l,subUnitId:u,ranges:d})},"handler")},n4={type:m.CommandType.COMMAND,id:"sheet.command.set-rows-hidden",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,s,i,a;let l=e.get(D),u=e.get(m.ICommandService),d=e.get(m.IUndoRedoService),c=e.get(m.IUniverInstanceService),h=e.get(G),g=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=l.getCurrentSelections())?void 0:r.map(e=>e.range).filter(e=>e.rangeType===m.RANGE_TYPE.ROW);if(!(null!=g&&g.length))return!1;let p=eS(c,t);if(!p)return!1;g=n6(p.worksheet,g);let{unitId:I,subUnitId:C,worksheet:R}=p,f={unitId:I,subUnitId:C,ranges:g},v={unitId:I,subUnitId:C,selections:n7(g).map(e=>({range:e,primary:e$(e,R),style:null}))},S=n1(e,f),w={unitId:I,subUnitId:C,reveal:!0,selections:g.map(e=>({range:e,primary:e$(e,R),style:null}))},y=h.onCommandExecute({id:n4.id,params:f});return(0,m.sequenceExecute)([...null!=(o=y.preRedos)?o:[],{id:n2.id,params:f},{id:eP.id,params:v},...y.redos],u).result&&d.pushUndoRedo({unitID:I,undoMutations:[...null!=(s=y.preUndos)?s:[],{id:n0.id,params:S},{id:eP.id,params:w},...null!=(i=y.undos)?i:[]],redoMutations:[...null!=(a=y.preRedos)?a:[],{id:n2.id,params:f},{id:eP.id,params:v},...y.redos]}),!0},"handler")};function n6(e,t){let n=e.getMaxColumns()-1,r=e.getHiddenRows(),o=[];return t.forEach(e=>{let t=r.filter(t=>t.startRow>=e.startRow&&t.endRow<=e.endRow);if(t.length){let r=e.startRow;t.forEach(e=>{e.startRow>r&&(o.push({startRow:r,endRow:e.startRow-1,startColumn:0,endColumn:n}),r=e.endRow+1)}),r<=e.endRow&&o.push({startRow:r,endRow:e.endRow,startColumn:0,endColumn:n})}else o.push(e)}),o}function n7(e){return n8(e).map(e=>{let t=0===e.startRow?e.endRow+1:e.startRow-1;return{...e,startRow:t,endRow:t}})}function n8(e){let t;let n=[];return e.sort((e,t)=>e.startRow-t.startRow).forEach(e=>{if(!t){t=e;return}e.startRow===t.endRow+1?t.endRow=e.endRow:(n.push(t),t=e)}),n.push(t),n}_(n6,"divideRangesByHiddenRows"),_(n7,"getSelectionsAfterHiding"),_(n8,"mergeSelections");let n9={type:m.CommandType.COMMAND,id:"sheet.command.set-style",handler:/* @__PURE__ */_(async(e,t)=>{var n;let r=eS(e.get(m.IUniverInstanceService));if(!r)return!1;let{unitId:o,subUnitId:s,worksheet:i}=r,{range:a,style:l}=t,u=e.get(m.ICommandService),d=e.get(m.IUndoRedoService),c=e.get(D),h=a?[a]:null==(n=c.getCurrentSelections())?void 0:n.map(e=>e.range);if(!(null!=h&&h.length))return!1;let g=new m.ObjectMatrix,p=eB(i);if((0,m.Tools).isArray(l.value))for(let e=0;e<h.length;e++)p.forOperableEach(h[e],(e,t,n)=>{g.setValue(e,t,{s:{[l.type]:l.value[e-n.startRow][t-n.startColumn]}})});else for(let e=0;e<h.length;e++){let t={s:{[l.type]:l.value}};p.forOperableEach(h[e],(e,n)=>g.setValue(e,n,t))}let I={subUnitId:s,unitId:o,cellValue:g.getMatrix()},C=el(e,I),R=u.syncExecuteCommand(eu.id,I),{undos:f,redos:v}=e.get(G).onCommandExecute({id:n9.id,params:t}),S=(0,m.sequenceExecute)([...v],u);return!!R&&!!S.result&&(d.pushUndoRedo({unitID:o,undoMutations:[{id:eu.id,params:C},...f],redoMutations:[{id:eu.id,params:I},...v]}),!0)},"handler")},re={type:m.CommandType.COMMAND,id:"sheet.command.set-bold",handler:/* @__PURE__ */_(async e=>{let t=e.get(D).getCurrentLastSelection();if(!t)return!1;let n=eS(e.get(m.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,{actualRow:o,actualColumn:s}=t.primary,i={style:{type:"bl",value:r.getRange(o,s).getFontWeight()===m.FontWeight.BOLD?m.BooleanNumber.FALSE:m.BooleanNumber.TRUE}};return e.get(m.ICommandService).executeCommand(n9.id,i)},"handler")},rt={type:m.CommandType.COMMAND,id:"sheet.command.set-italic",handler:/* @__PURE__ */_(async e=>{let t=e.get(D).getCurrentLastSelection();if(!t)return!1;let n=eS(e.get(m.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,o=!0;if(t.primary){let{startRow:e,startColumn:n}=t.primary;o=r.getRange(e,n).getFontStyle()===m.FontItalic.ITALIC}let s={style:{type:"it",value:o?m.BooleanNumber.FALSE:m.BooleanNumber.TRUE}};return e.get(m.ICommandService).executeCommand(n9.id,s)},"handler")},rn={type:m.CommandType.COMMAND,id:"sheet.command.set-underline",handler:/* @__PURE__ */_(async e=>{let t=e.get(D).getCurrentLastSelection();if(!t)return!1;let n=eS(e.get(m.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,o=!0;t.primary&&(o=!!r.getRange(t.primary.startRow,t.primary.startColumn).getUnderline().s);let s={style:{type:"ul",value:{s:o?m.BooleanNumber.FALSE:m.BooleanNumber.TRUE}}};return e.get(m.ICommandService).executeCommand(n9.id,s)},"handler")},rr={type:m.CommandType.COMMAND,id:"sheet.command.set-stroke",handler:/* @__PURE__ */_(async e=>{let t=e.get(D).getCurrentLastSelection();if(!t)return!1;let n=eS(e.get(m.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,o=!0;t.primary&&(o=!!r.getRange(t.primary.actualRow,t.primary.actualColumn).getStrikeThrough().s);let s={style:{type:"st",value:{s:o?m.BooleanNumber.FALSE:m.BooleanNumber.TRUE}}};return e.get(m.ICommandService).executeCommand(n9.id,s)},"handler")},ro=(m.CommandType.COMMAND,{type:m.CommandType.COMMAND,id:"sheet.command.set-font-family",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(m.ICommandService),r={style:{type:"ff",value:t.value}};return n.executeCommand(n9.id,r)},"handler")}),rs={type:m.CommandType.COMMAND,id:"sheet.command.set-font-size",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(m.ICommandService),r={style:{type:"fs",value:t.value}};return n.executeCommand(n9.id,r)},"handler")},ri={type:m.CommandType.COMMAND,id:"sheet.command.set-text-color",handler:/* @__PURE__ */_(async(e,t)=>{if(!t||!t.value)return!1;let n=e.get(m.ICommandService),r={style:{type:"cl",value:{rgb:t.value}}};return n.executeCommand(n9.id,r)},"handler")},ra={type:m.CommandType.COMMAND,id:"sheet.command.reset-text-color",handler:/* @__PURE__ */_(async e=>e.get(m.ICommandService).executeCommand(n9.id,{style:{type:"cl",value:{rgb:null}}}),"handler")},rl={type:m.CommandType.COMMAND,id:"sheet.command.set-background-color",handler:/* @__PURE__ */_(async(e,t)=>{if(!t||!t.value)return!1;let n=e.get(m.ICommandService),r={style:{type:"bg",value:{rgb:t.value}}};return n.executeCommand(n9.id,r)},"handler")},ru={type:m.CommandType.COMMAND,id:"sheet.command.reset-background-color",handler:/* @__PURE__ */_(async e=>e.get(m.ICommandService).executeCommand(n9.id,{style:{type:"bg",value:{rgb:null}}}),"handler")},rd={type:m.CommandType.COMMAND,id:"sheet.command.set-vertical-text-align",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(m.ICommandService),r={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"vt",value:t.value}};return n.executeCommand(n9.id,r)},"handler")},rc={type:m.CommandType.COMMAND,id:"sheet.command.set-horizontal-text-align",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(m.ICommandService),r={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"ht",value:t.value}};return n.executeCommand(n9.id,r)},"handler")},rm={type:m.CommandType.COMMAND,id:"sheet.command.set-text-wrap",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(m.ICommandService),r={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"tb",value:t.value}};return n.executeCommand(n9.id,r)},"handler")},rh={type:m.CommandType.COMMAND,id:"sheet.command.set-text-rotation",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n="number"==typeof t.value?{a:t.value}:{a:0,v:m.BooleanNumber.TRUE};return e.get(m.ICommandService).executeCommand(n9.id,{style:{type:"tr",value:n}})},"handler")},rg=/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().tabColor;return{...(0,m.Tools).deepClone(t),color:n}},"SetTabColorUndoMutationFactory"),rp={id:"sheet.mutation.set-tab-color",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().tabColor=t.color,!0)},"handler")},rI={type:m.CommandType.COMMAND,id:"sheet.command.set-tab-color",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),o=eS(e.get(m.IUniverInstanceService));if(!o)return!1;let{unitId:s,subUnitId:i}=o,a={color:t.value,unitId:s,subUnitId:i},l=rg(e,a);return!!n.syncExecuteCommand(rp.id,a)&&(r.pushUndoRedo({unitID:s,undoMutations:[{id:rp.id,params:l}],redoMutations:[{id:rp.id,params:a}]}),!0)},"handler")},rC={id:"sheet.operation.set-worksheet-active",type:m.CommandType.OPERATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;for(let[,e]of n.getWorksheets())if(e.getSheetId()===t.subUnitId)return n.setActiveSheet(e),!0;return!1},"handler")},rR={type:m.CommandType.COMMAND,id:"sheet.command.set-worksheet-activate",handler:/* @__PURE__ */_((e,t,n)=>{let r=e.get(m.ICommandService),o=eS(e.get(m.IUniverInstanceService),t);if(!o)return!1;let{unitId:s,subUnitId:i}=o;return new Promise(e=>{setTimeout(()=>{e(r.syncExecuteCommand(rC.id,{unitId:s,subUnitId:i},n))},4)})},"handler")},rf=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ranges:o}=e,s={},i=t.getColumnManager();for(let e=0;e<o.length;e++){let t=o[e];for(let e=t.startColumn;e<t.endColumn+1;e++){let t=i.getColumnOrCreate(e);s[e]=t.w}}return{unitId:n,subUnitId:r,ranges:o,colWidth:s}},"SetWorksheetColWidthMutationFactory"),rv={id:"sheet.mutation.set-worksheet-col-width",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let r=eS(e.get(m.IUniverInstanceService),t);if(!r)return!1;let{worksheet:o}=r,s=o.getConfig().defaultColumnWidth,i=o.getColumnManager(),a=t.ranges;for(let e=0;e<a.length;e++){let r=a[e];for(let e=r.startColumn;e<r.endColumn+1;e++){let r=i.getColumnOrCreate(e);"number"==typeof t.colWidth?r.w=t.colWidth:r.w=null!=(n=t.colWidth[e])?n:s}}return!0},"handler")},rS={type:m.CommandType.COMMAND,id:"sheet.command.delta-column-width",handler:/* @__PURE__ */_(async(e,t)=>{let n;let r=e.get(D).getCurrentSelections();if(!(null!=r&&r.length))return!1;let o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=eS(e.get(m.IUniverInstanceService));if(!i)return!1;let{worksheet:a,unitId:l,subUnitId:u}=i,{anchorCol:d,deltaX:c}=t,h=a.getColumnWidth(d)+c,g=1===r.length&&r[0].range.rangeType===m.RANGE_TYPE.ALL,p=r.filter(e=>e.range.rangeType===m.RANGE_TYPE.COLUMN),I=g?m.RANGE_TYPE.ALL:p.some(({range:e})=>{let{startColumn:t,endColumn:n}=e;return t<=d&&d<=n})?m.RANGE_TYPE.COLUMN:m.RANGE_TYPE.NORMAL;if(I===m.RANGE_TYPE.ALL){let e=a.getRowCount();n={subUnitId:u,unitId:l,colWidth:h,ranges:Array(a.getColumnCount()).fill(void 0).map((t,n)=>({startRow:0,endRow:e-1,startColumn:n,endColumn:n}))}}else n=I===m.RANGE_TYPE.COLUMN?{subUnitId:u,unitId:l,ranges:p.map(e=>(0,m.Rectangle).clone(e.range)),colWidth:h}:{subUnitId:u,unitId:l,colWidth:h,ranges:[{startRow:0,endRow:a.getMaxRows()-1,startColumn:d,endColumn:d}]};let{undos:C,redos:R}=e.get(G).onCommandExecute({id:rS.id,params:n}),f=rf(n,a),v=o.syncExecuteCommand(rv.id,n),S=(0,m.sequenceExecute)([...R],o);return v&&S.result&&s.pushUndoRedo({unitID:l,undoMutations:[{id:rv.id,params:f},...C],redoMutations:[{id:rv.id,params:n},...R]}),!0},"handler")},rw={type:m.CommandType.COMMAND,id:"sheet.command.set-worksheet-col-width",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,s;let i=e.get(D),a=e.get(m.ICommandService),l=e.get(m.IUndoRedoService),u=e.get(G),d=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=i.getCurrentSelections())?void 0:r.map(e=>e.range);if(!(null!=d&&d.length))return!1;let c=eS(e.get(m.IUniverInstanceService),t);if(!c)return!1;let{subUnitId:h,unitId:g,worksheet:p}=c,I={subUnitId:h,unitId:g,ranges:d,colWidth:t.value},C=rf(I,p),R=a.syncExecuteCommand(rv.id,I),{undos:f,redos:v}=e.get(G).onCommandExecute({id:rw.id,params:I}),S=u.onCommandExecute({id:rw.id,params:I}),w=(0,m.sequenceExecute)([...v,...S.redos],a);return!!R&&!!w.result&&(l.pushUndoRedo({unitID:g,undoMutations:[...null!=(o=S.preUndos)?o:[],{id:rv.id,params:C},...f],redoMutations:[...null!=(s=S.preRedos)?s:[],{id:rv.id,params:I},...v]}),!0)},"handler")},ry=/* @__PURE__ */_((e,t)=>{let n=ew(e.get(m.IUniverInstanceService),t);if(!n)throw Error("[SetWorksheetHideMutationFactory]: worksheet is null error!");let{worksheet:r}=n;return{hidden:r.isSheetHidden(),unitId:t.unitId,subUnitId:r.getSheetId()}},"SetWorksheetHideMutationFactory"),rb={id:"sheet.mutation.set-worksheet-hidden",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().hidden=t.hidden,!0)},"handler")},rM={type:m.CommandType.COMMAND,id:"sheet.command.set-worksheet-hidden",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),o=e.get(m.ErrorService),s=e.get(m.LocaleService),i=eS(e.get(m.IUniverInstanceService),t);if(!i)return!1;let{workbook:a,worksheet:l,unitId:u,subUnitId:d}=i;if(l.getConfig().hidden===m.BooleanNumber.TRUE)return!1;let c={unitId:u,subUnitId:d,hidden:m.BooleanNumber.TRUE},h=ry(e,c);return 1===a.getSheets().filter(e=>e.getConfig().hidden===m.BooleanNumber.FALSE).length?(o.emit(s.t("sheets.info.hideSheet")),!1):!!n.syncExecuteCommand(rb.id,c)&&(r.pushUndoRedo({unitID:u,undoMutations:[{id:rb.id,params:h}],redoMutations:[{id:rb.id,params:c}]}),!0)},"handler")},rU=/* @__PURE__ */_((e,t)=>{let n=ew(e.get(m.IUniverInstanceService),t);if(!n)throw Error("[SetWorksheetNameMutationFactory]: worksheet is null error!");let{worksheet:r}=n;return{unitId:t.unitId,name:r.getName(),subUnitId:r.getSheetId()}},"SetWorksheetNameMutationFactory"),r_={id:"sheet.mutation.set-worksheet-name",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().name=t.name,!0)},"handler")},rT={type:m.CommandType.COMMAND,id:"sheet.command.set-worksheet-name",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=e.get(G),a=eS(e.get(m.IUniverInstanceService),t);if(!a)return!1;let{unitId:l,subUnitId:u}=a,d={subUnitId:u,name:t.name,unitId:l},c=rU(e,d),h=i.onCommandExecute({id:rT.id,params:t}),g=[...null!=(n=h.preRedos)?n:[],{id:r_.id,params:d},...h.redos],p=[...null!=(r=h.preUndos)?r:[],{id:r_.id,params:c},...h.undos];return!!await (0,m.sequenceExecute)(g,o).result&&(s.pushUndoRedo({unitID:l,undoMutations:p,redoMutations:g}),!0)},"handler")},rE=/* @__PURE__ */_((e,t)=>({...(0,m.Tools).deepClone(t),toOrder:t.fromOrder,fromOrder:t.toOrder}),"SetWorksheetOrderUndoMutationFactory"),rk={id:"sheet.mutation.set-worksheet-order",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getConfig();return r.sheetOrder.splice(t.fromOrder,1),r.sheetOrder.splice(t.toOrder,0,t.subUnitId),!0},"handler")},rx={type:m.CommandType.COMMAND,id:"sheet.command.set-worksheet-order",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),o=eS(e.get(m.IUniverInstanceService),t);if(!o)return!1;let{workbook:s,unitId:i,subUnitId:a}=o,l={fromOrder:s.getConfig().sheetOrder.indexOf(a),toOrder:t.order,unitId:i,subUnitId:a},u=rE(e,l);return!!n.syncExecuteCommand(rk.id,l)&&(r.pushUndoRedo({unitID:i,undoMutations:[{id:rk.id,params:u}],redoMutations:[{id:rk.id,params:l}]}),!0)},"handler")},rN=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ranges:o}=e,s={},i=t.getRowManager();for(let{startRow:e,endRow:t}of o)for(let n=e;n<t+1;n++){let e=i.getRowOrCreate(n);s[n]=e.h}return{unitId:n,subUnitId:r,ranges:o,rowHeight:s}},"SetWorksheetRowHeightMutationFactory"),rO=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ranges:o}=e,s={},i=t.getRowManager();for(let{startRow:e,endRow:t}of o)for(let n=e;n<=t;n++){let e=i.getRowOrCreate(n);s[n]=e.ia}return{unitId:n,subUnitId:r,ranges:o,autoHeightInfo:s}},"SetWorksheetRowIsAutoHeightMutationFactory"),rD=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rowsAutoHeightInfo:o}=e,s=[],i=t.getRowManager();for(let e of o){let{row:t}=e,{ah:n}=i.getRowOrCreate(t);s.push({row:t,autoHeight:n})}return{unitId:n,subUnitId:r,rowsAutoHeightInfo:s}},"SetWorksheetRowAutoHeightMutationFactory"),rP={id:"sheet.mutation.set-worksheet-row-height",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let{ranges:r,rowHeight:o}=t,s=eS(e.get(m.IUniverInstanceService),t);if(!s)return!1;let{worksheet:i}=s,a=i.getRowManager(),l=i.getConfig().defaultRowHeight;for(let{startRow:e,endRow:t}of r)for(let r=e;r<=t;r++){let e=a.getRowOrCreate(r);"number"==typeof o?e.h=o:e.h=null!=(n=o[r])?n:l,e.h=Math.min(2e3,e.h)}return!0},"handler")},rA={id:"sheet.mutation.set-worksheet-row-is-auto-height",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let{ranges:r,autoHeightInfo:o}=t,s=eS(e.get(m.IUniverInstanceService),t);if(!s)return!1;let i=s.worksheet.getRowManager();for(let{startRow:e,endRow:t}of r)for(let r=e;r<=t;r++){let e=i.getRowOrCreate(r);"number"==typeof o?e.ia=o:e.ia=null!=(n=o[r])?n:void 0}return!0},"handler")},rV={id:"sheet.mutation.set-worksheet-row-auto-height",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{rowsAutoHeightInfo:n}=t,r=eS(e.get(m.IUniverInstanceService),t);if(!r)return!1;let o=r.worksheet.getRowManager();for(let{row:e,autoHeight:t}of n)o.getRowOrCreate(e).ah=t;return!0},"handler")},rW={type:m.CommandType.COMMAND,id:"sheet.command.delta-row-height",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o;let s=e.get(D).getCurrentSelections(),i=e.get(G);if(!(null!=s&&s.length))return!1;let a=eS(e.get(m.IUniverInstanceService));if(!a)return!1;let{worksheet:l,subUnitId:u,unitId:d}=a,{anchorRow:c,deltaY:h}=t,g=l.getRowHeight(c)+h,p=1===s.length&&s[0].range.rangeType===m.RANGE_TYPE.ALL,I=s.filter(e=>e.range.rangeType===m.RANGE_TYPE.ROW),C=p?m.RANGE_TYPE.ALL:I.some(({range:e})=>{let{startRow:t,endRow:n}=e;return t<=c&&c<=n})?m.RANGE_TYPE.ROW:m.RANGE_TYPE.NORMAL;if(C===m.RANGE_TYPE.ALL){let e=l.getRowCount();o={subUnitId:u,unitId:d,rowHeight:g,ranges:Array(l.getColumnCount()).fill(void 0).map((t,n)=>({startRow:n,endRow:n,startColumn:0,endColumn:e-1}))}}else o=C===m.RANGE_TYPE.ROW?{subUnitId:u,unitId:d,ranges:I.map(e=>(0,m.Rectangle).clone(e.range)),rowHeight:g}:{subUnitId:u,unitId:d,rowHeight:g,ranges:[{startRow:c,endRow:c,startColumn:0,endColumn:l.getMaxColumns()-1}]};let R=rN(o,l),f={unitId:d,subUnitId:u,ranges:o.ranges,autoHeightInfo:m.BooleanNumber.FALSE},v=rO(f,l),S=e.get(m.ICommandService),w=e.get(m.IUndoRedoService),y=i.onCommandExecute({id:rW.id,params:o}),b=(0,m.sequenceExecute)([{id:rP.id,params:o},{id:rA.id,params:f}],S),M=(0,m.sequenceExecute)([...y.redos],S);return!!b.result&&!!M.result&&(w.pushUndoRedo({unitID:d,undoMutations:[...null!=(n=y.preUndos)?n:[],{id:rP.id,params:R},{id:rA.id,params:v},...y.undos],redoMutations:[...null!=(r=y.preRedos)?r:[],{id:rP.id,params:o},{id:rA.id,params:f},...y.redos]}),!0)},"handler")},r$={type:m.CommandType.COMMAND,id:"sheet.command.set-row-height",handler:/* @__PURE__ */_((e,t)=>{var n,r,o,s;let i=e.get(D),a=e.get(m.ICommandService),l=e.get(m.IUndoRedoService),u=e.get(m.IUniverInstanceService),d=e.get(G),c=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=i.getCurrentSelections())?void 0:r.map(e=>e.range);if(!(null!=c&&c.length))return!1;let h=eS(u,t);if(!h)return!1;let{unitId:g,subUnitId:p,worksheet:I}=h,C={subUnitId:p,unitId:g,ranges:c,rowHeight:t.value},R=rN(C,I),f={unitId:g,subUnitId:p,ranges:C.ranges,autoHeightInfo:m.BooleanNumber.FALSE},v=rO(f,I),S=(0,m.sequenceExecute)([{id:rP.id,params:C},{id:rA.id,params:f}],a),w=d.onCommandExecute({id:r$.id,params:C}),y=(0,m.sequenceExecute)([...w.redos],a);return!!S.result&&!!y.result&&(l.pushUndoRedo({unitID:g,undoMutations:[...null!=(o=w.preRedos)?o:[],{id:rP.id,params:R},{id:rA.id,params:v},...w.undos],redoMutations:[...null!=(s=w.preRedos)?s:[],{id:rP.id,params:C},{id:rA.id,params:f},...w.redos]}),!0)},"handler")},rL={type:m.CommandType.COMMAND,id:"sheet.command.set-row-is-auto-height",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=e.get(D),a=eS(e.get(m.IUniverInstanceService),t);if(!a)return!1;let{unitId:l,subUnitId:u,worksheet:d}=a,c=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=i.getCurrentSelections())?void 0:r.map(e=>e.range);if(!(null!=c&&c.length))return!1;let h={unitId:l,subUnitId:u,ranges:c,autoHeightInfo:m.BooleanNumber.TRUE},g=rO(h,d),p=o.syncExecuteCommand(rA.id,h),{undos:I,redos:C}=e.get(G).onCommandExecute({id:rL.id,params:h}),R=(0,m.sequenceExecute)([...C],o);return!!p&&!!R.result&&(s.pushUndoRedo({unitID:l,undoMutations:[{id:rA.id,params:g},...I],redoMutations:[{id:rA.id,params:h},...C]}),!0)},"handler")},rj={type:m.CommandType.COMMAND,id:"sheet.command.set-worksheet-show",handler:/* @__PURE__ */_(async(e,t)=>{let{unitId:n,subUnitId:r}=t,o=e.get(m.ICommandService),s=e.get(m.IUndoRedoService),i=e.get(m.IUniverInstanceService);if(!eS(e.get(m.IUniverInstanceService)))return!1;let a=i.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getSheetBySheetId(r);if(!l||l.getConfig().hidden===m.BooleanNumber.FALSE)return!1;let u={unitId:n,subUnitId:r,hidden:m.BooleanNumber.FALSE},d=ry(e,u),c=o.syncExecuteCommand(rb.id,u),h=o.syncExecuteCommand(rC.id,{unitId:n,subUnitId:r});return!!c&&!!h&&(s.pushUndoRedo({unitID:n,undoMutations:[{id:rb.id,params:d}],redoMutations:[{id:rb.id,params:u}]}),!0)},"handler")},rB=/* @__PURE__ */_(e=>{let t=new m.ObjectMatrix;return e.forEach(e=>{(0,m.Range).foreach(e,(e,n)=>{t.setValue(e,n,1)})}),t.forValue((e,n)=>{let r=t.getValue(e-1,n);r&&t.setValue(e,n,r+1)}),t},"createTopMatrixFromRanges"),rH=/* @__PURE__ */_(e=>(e.forValue((t,n)=>{let r=e.getValue(t-1,n);r&&e.setValue(t,n,r+1)}),e),"createTopMatrixFromMatrix"),rF=/* @__PURE__ */_(e=>{let t={area:0},n=/* @__PURE__ */_((e,n)=>t.area<e&&(t.area=e,t.range=n,!0),"checkArea");return e.forValue((t,r,o)=>{let s=1,i=o;n(1*i,{startRow:t-i+1,endRow:t,startColumn:r,endColumn:r});let a={startRow:t-i+1,endRow:t,startColumn:0,endColumn:r};for(let o=r-1;o>=0&&e.getValue(t,o);o--){let r=(i=Math.min(e.getValue(t,o)||0,i))*++s;a.startColumn=o,a.startRow=t-i+1,n(r,a)}}),t},"findMaximalRectangle"),rG=/* @__PURE__ */_((e,t)=>{(0,m.Range).foreach(t,(t,n)=>{e.realDeleteValue(t,n)});for(let n=t.startColumn;n<=t.endColumn;n++){let r=t.endRow+1;if(e.getValue(r,n)>0){e.setValue(r,n,1);let t=r+1;for(;e.getValue(t,n)>0;)e.setValue(t,n,e.getValue(t-1,n)+1),t++}}return e},"filterLeftMatrix"),rq=/* @__PURE__ */_(e=>{let t=[],n=rF(e);for(;n.area>0;)n.range&&(t.push(n.range),rG(e,n.range)),n=rF(e);return t},"findAllRectangle"),rz=/* @__PURE__ */_(e=>rq(rB(e)),"rangeMerge");_(class{constructor(){T(this,"_matrix",new m.ObjectMatrix)}add(...e){return e.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{this._matrix.setValue(e,t,1)})}),this}subtract(...e){return e.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{this._matrix.realDeleteValue(e,t)})}),this}merge(){return rq(rH(this._matrix))}},"RangeMergeUtil");let rY=(0,m.createIdentifier)("INumfmtService");(0,m.runOnLifecycle)(m.LifecycleStages.Ready,rY);let rJ=/* @__PURE__ */_((e,t)=>{let n=e.get(rY),{values:r,unitId:o,subUnitId:s}=t,i=[],a=[];Object.keys(r).forEach(e=>{r[e].ranges.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{let r=n.getValue(o,s,e,t);r?i.push({pattern:r.pattern,row:e,col:t}):a.push({startColumn:t,endColumn:t,startRow:e,endRow:e})})})});let l=[];if(i.length){let e=rQ(o,s,i);Object.keys(e.values).forEach(t=>{let n=e.values[t];n.ranges=rz(n.ranges)}),l.push({id:rK.id,params:rQ(o,s,i)})}return a.length&&l.push({id:rX.id,params:{unitId:o,subUnitId:s,ranges:a}}),l},"factorySetNumfmtUndoMutation"),rK={id:"sheet.mutation.set.numfmt",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{if(!t)return!1;let{values:n,refMap:r}=t,o=e.get(rY),s=t.unitId,i=t.subUnitId,a=Object.keys(n).reduce((e,t)=>{let o=r[t],s=n[t].ranges;return o&&e.push({...o,ranges:s}),e},[]);return o.setValues(s,i,a),!0},"handler")},rX={id:"sheet.mutation.remove.numfmt",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{if(!t)return!1;let{unitId:n,subUnitId:r,ranges:o}=t;return e.get(rY).deleteValues(n,r,o),!0},"handler")},rZ=/* @__PURE__ */_((e,t)=>{let n=e.get(rY),{ranges:r,unitId:o,subUnitId:s}=t,i=[];if(r.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{let r=n.getValue(o,s,e,t);r&&i.push({pattern:r.pattern,row:e,col:t})})}),!i.length)return[];let a=rQ(o,s,i);return Object.keys(a.values).forEach(e=>{let t=a.values[e];t.ranges=rz(t.ranges)}),[{id:rK.id,params:a}]},"factoryRemoveNumfmtUndoMutation"),rQ=/* @__PURE__ */_((e,t,n)=>{let r=ed(n,"pattern"),o={},s={},i=ec();return Object.keys(r).forEach(e=>{let t=r[e],n=i();o[n]={pattern:e},t.forEach(e=>{s[n]||(s[n]={ranges:[]}),s[n].ranges.push((0,m.cellToRange)(e.row,e.col))})}),{unitId:e,subUnitId:t,refMap:o,values:s}},"transformCellsToRange"),r0={id:"sheet.mutation.empty",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_(()=>!0,"handler")},r1={id:"sheet.command.insert-defined-name",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService);if(!t)return!1;let o={...t};return!!n.syncExecuteCommand(h.SetDefinedNameMutation.id,o)&&(r.pushUndoRedo({unitID:t.unitId,undoMutations:[{id:h.RemoveDefinedNameMutation.id,params:o}],redoMutations:[{id:h.SetDefinedNameMutation.id,params:o}]}),!0)},"handler")},r2={id:"sheet.command.remove-defined-name",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService);if(!t)return!1;let o={...t};return!!n.syncExecuteCommand(h.RemoveDefinedNameMutation.id,o)&&(r.pushUndoRedo({unitID:t.unitId,undoMutations:[{id:h.SetDefinedNameMutation.id,params:o}],redoMutations:[{id:h.RemoveDefinedNameMutation.id,params:o}]}),!0)},"handler")},r5={id:"sheet.command.set-defined-name",type:m.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService);return!!(t&&n.syncExecuteCommand(h.SetDefinedNameMutation.id,t.newDefinedName))&&(r.pushUndoRedo({unitID:t.unitId,undoMutations:[{id:h.SetDefinedNameMutation.id,params:t.oldDefinedName}],redoMutations:[{id:h.SetDefinedNameMutation.id,params:t.newDefinedName}]}),!0)},"handler")},r3={id:"sheet.operation.scroll-to-cell",type:m.CommandType.OPERATION,handler:/* @__PURE__ */_(()=>!0,"handler")},r4={id:"sheet.mutation.set-workbook-name",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUnit(t.unitId,m.UniverInstanceType.UNIVER_SHEET);return!!n&&(n.setName(t.name),!0)},"handler")},r6={type:m.CommandType.COMMAND,id:"sheet.command.set-workbook-name",handler:/* @__PURE__ */_(async(e,t)=>{var n;if(!e.get(m.IUniverInstanceService).getUnit(t.unitId,m.UniverInstanceType.UNIVER_SHEET))return!1;let r=e.get(G).onCommandExecute({id:r6.id,params:t}),o={name:t.name,unitId:t.unitId},s=[...null!=(n=r.preRedos)?n:[],{id:r4.id,params:o},...r.redos],i=e.get(m.ICommandService);return(0,m.sequenceExecute)(s,i).result},"handler")};var r7,r8,r9=Object.defineProperty,oe=Object.getOwnPropertyDescriptor,ot=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?oe(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&r9(t,n,s),s},"__decorateClass$f");let on=(_(r8=class{constructor(){T(this,"_model",/* @__PURE__ */new Map),T(this,"_ruleChange",new v.Subject),T(this,"_ruleRefresh",new v.Subject),T(this,"_resetOrder",new v.Subject),T(this,"ruleChange$",this._ruleChange.asObservable()),T(this,"ruleRefresh$",this._ruleRefresh.asObservable()),T(this,"resetOrder$",this._resetOrder.asObservable()),T(this,"_worksheetRuleInitStateChange",new p.BehaviorSubject(!1)),T(this,"worksheetRuleInitStateChange$",this._worksheetRuleInitStateChange.asObservable())}changeRuleInitState(e){this._worksheetRuleInitStateChange.next(e)}getSheetRuleInitState(){return this._worksheetRuleInitStateChange.value}addRule(e,t){this._ensureSubUnitMap(e).set(t.subUnitId,t),this._ruleChange.next({unitId:e,rule:t,type:"add",subUnitId:t.subUnitId})}deleteRule(e,t){var n,r,o;let s=null==(r=null==(n=this._model)?void 0:n.get(e))?void 0:r.get(t);s&&(null==(o=this._model.get(e))||o.delete(t),this._ruleChange.next({unitId:e,rule:s,type:"delete",subUnitId:t}))}setRule(e,t,n){var r,o;let s=this.getRule(e,t);s&&(null==(o=null==(r=this._model)?void 0:r.get(e))||o.set(t,n),this._ruleChange.next({unitId:e,oldRule:s,rule:n,type:"set",subUnitId:t}))}getRule(e,t){var n,r;return null==(r=null==(n=this._model)?void 0:n.get(e))?void 0:r.get(t)}toObject(){let e={};return[...this._model.keys()].forEach(t=>{let n=this._model.get(t);null!=n&&n.size&&(e[t]=[],[...n.keys()].forEach(r=>{let o=n.get(r);o&&e[t].push(o)}))}),e}fromObject(e){let t=/* @__PURE__ */new Map;Object.keys(e).forEach(n=>{let r=e[n];if(null!=r&&r.length){let e=/* @__PURE__ */new Map;r.forEach(t=>{e.set(t.subUnitId,t)}),t.set(n,e)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=/* @__PURE__ */new Map,this._model.set(e,t)),t}ruleRefresh(e){this._ruleRefresh.next(e)}resetOrder(){this._resetOrder.next(Math.random())}getTargetByPermissionId(e,t){let n=this._model.get(e);if(!n)return null;for(let[r,o]of n)if(o.permissionId===t)return[e,r]}},"WorksheetProtectionRuleModel"),r8);on=ot([(0,m.OnLifecycle)(m.LifecycleStages.Starting,on)],on);let or={id:"sheet.mutation.add-worksheet-protection",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,rule:r}=t;return e.get(on).addRule(n,r),!0},"handler")},oo={id:"sheet.mutation.set-worksheet-protection",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rule:o}=t;return e.get(on).setRule(n,r,o),!0},"handler")},os={id:"sheet.mutation.delete-worksheet-protection",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r}=t;return e.get(on).deleteRule(n,r),!0},"handler")};var oi,oa=Object.defineProperty,ol=Object.getOwnPropertyDescriptor,ou=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?ol(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&oa(t,n,s),s},"__decorateClass$e");let od=(_(oi=class{constructor(){T(this,"_model",/* @__PURE__ */new Map),T(this,"_ruleChange",new v.Subject),T(this,"ruleChange$",this._ruleChange.asObservable()),T(this,"_ruleRefresh",new v.Subject),T(this,"ruleRefresh$",this._ruleRefresh.asObservable()),T(this,"_rangeRuleInitStateChange",new p.BehaviorSubject(!1)),T(this,"rangeRuleInitStateChange$",this._rangeRuleInitStateChange.asObservable())}ruleRefresh(e){this._ruleRefresh.next(e)}getRangeRuleInitState(){return this._rangeRuleInitStateChange.value}changeRuleInitState(e){this._rangeRuleInitStateChange.next(e)}addRule(e,t,n){this._ensureRuleMap(e,t).set(n.id,n),this._ruleChange.next({unitId:e,subUnitId:t,rule:n,type:"add"})}deleteRule(e,t,n){var r,o,s,i;let a=null==(o=null==(r=this._model.get(e))?void 0:r.get(t))?void 0:o.get(n);a&&(null==(i=null==(s=this._model.get(e))?void 0:s.get(t))||i.delete(n),this._ruleChange.next({unitId:e,subUnitId:t,rule:a,type:"delete"}))}setRule(e,t,n,r){var o,s;let i=this.getRule(e,t,n);i&&(null==(s=null==(o=this._model.get(e))?void 0:o.get(t))||s.set(n,r),this._ruleChange.next({unitId:e,subUnitId:t,oldRule:i,rule:r,type:"set"}))}getRule(e,t,n){var r,o;return null==(o=null==(r=this._model.get(e))?void 0:r.get(t))?void 0:o.get(n)}getSubunitRuleList(e,t){var n;return[...((null==(n=this._model.get(e))?void 0:n.get(t))||/* @__PURE__ */new Map).values()]}_ensureRuleMap(e,t){let n=this._model.get(e);n||(n=/* @__PURE__ */new Map,this._model.set(e,n));let r=n.get(t);return r||(r=/* @__PURE__ */new Map,n.set(t,r)),r}toObject(){let e={};return[...this._model.keys()].forEach(t=>{let n=this._model.get(t),r=[...n.keys()];e[t]={},r.forEach(r=>{let o=n.get(r);e[t][r]=[...o.values()]})}),e}fromObject(e){let t=/* @__PURE__ */new Map;Object.keys(e).forEach(n=>{let r=e[n],o=/* @__PURE__ */new Map;Object.keys(r).forEach(e=>{let t=r[e].reduce((e,t)=>(e.set(t.id,t),e),/* @__PURE__ */new Map);o.set(e,t)}),t.set(n,o)}),this._model=t}deleteUnitModel(e){this._model.delete(e)}createRuleId(e,t){let n=(0,m.Tools).generateRandomId(4),r=this._ensureRuleMap(e,t);for(;r.has(n);)n=(0,m.Tools).generateRandomId(4);return n}getTargetByPermissionId(e,t){let n=this._model.get(e);if(!n)return null;for(let[r,o]of n)for(let n of o.values())if(n.permissionId===t)return[e,r];return null}},"RangeProtectionRuleModel"),oi);od=ou([(0,m.OnLifecycle)(m.LifecycleStages.Starting,od)],od);let oc=/* @__PURE__ */_(()=>[tg,e5],"getAllWorksheetPermissionPoint"),om=/* @__PURE__ */_(()=>[eX,ta,ts,tm,td,tt,e9,tr,tc,eQ,e1,e7,e4,tl],"getAllWorksheetPermissionPointByPointPanel"),oh=[eY.Copy,eY.DeleteColumn,eY.DeleteRow,eY.EditExtraObject,eY.Filter,eY.InsertColumn,eY.InsertRow,eY.InsertHyperlink,eY.PivotTable,eY.SetCellStyle,eY.SetCellValue,eY.SetColumnStyle,eY.SetRowStyle,eY.Sort];var og,op=Object.defineProperty,oI=Object.getOwnPropertyDescriptor,oC=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?oI(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&op(t,n,s),s},"__decorateClass$d");let oR=(_(og=class{constructor(){T(this,"_model",/* @__PURE__ */new Map),T(this,"_pointChange",new v.Subject),T(this,"pointChange$",this._pointChange.asObservable())}addRule(e){this._ensureSubUnitMap(e.unitId).set(e.subUnitId,e),this._pointChange.next(e)}deleteRule(e,t){var n,r,o;let s=null==(n=this._model.get(e))?void 0:n.get(t);s&&(null==(o=null==(r=this._model)?void 0:r.get(e))||o.delete(t),this._pointChange.next(s))}getRule(e,t){var n,r;return null==(r=null==(n=this._model)?void 0:n.get(e))?void 0:r.get(t)}toObject(){let e={};return[...this._model.keys()].forEach(t=>{let n=this._model.get(t);null!=n&&n.size&&(e[t]=[],[...n.keys()].forEach(r=>{let o=n.get(r);o&&e[t].push(o)}))}),e}fromObject(e){let t=/* @__PURE__ */new Map;Object.keys(e).forEach(n=>{let r=e[n];if(null!=r&&r.length){let e=/* @__PURE__ */new Map;r.forEach(t=>{e.set(t.subUnitId,t)}),t.set(n,e)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=/* @__PURE__ */new Map,this._model.set(e,t)),t}getTargetByPermissionId(e,t){let n=this._model.get(e);if(!n)return null;for(let[r,o]of n)if(o.permissionId===t)return[e,r]}},"WorksheetProtectionPointModel"),og);oR=oC([(0,m.OnLifecycle)(m.LifecycleStages.Starting,oR)],oR);var of=Object.defineProperty,ov=Object.getOwnPropertyDescriptor,oS=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?ov(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&of(t,n,s),s},"__decorateClass$c"),ow=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$c");let oy=(oW=class extends m.RxDisposable{constructor(e,t,n,r,o,s,i){super(),this._permissionService=e,this._univerInstanceService=t,this._injector=n,this._worksheetProtectionRuleModel=r,this._worksheetProtectionPointRuleModel=o,this._resourceManagerService=s,this._rangeProtectionRuleModel=i,this._init(),this._initRuleChange(),this._initRuleSnapshot(),this._initPointSnapshot()}_init(){let e=/* @__PURE__ */_(e=>{let t=e.getUnitId(),n=/* @__PURE__ */_(e=>{let n=e.getSheetId();[...oc(),...om()].forEach(e=>{let r=new e(t,n);this._permissionService.addPermissionPoint(r)})},"handleWorksheet");e.getSheets().forEach(e=>{n(e)}),e.sheetCreated$.subscribe(e=>{n(e)}),e.sheetDisposed$.subscribe(e=>{let n=e.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(t,n).forEach(e=>{[tH,tG].forEach(r=>{let o=new r(t,n,e.permissionId);this._permissionService.deletePermissionPoint(o.id)})}),[...oc(),...om()].forEach(e=>{let r=new e(t,n);this._permissionService.deletePermissionPoint(r.id)})})},"handleWorkbook");this._univerInstanceService.getAllUnitsForType(m.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this._univerInstanceService.getTypeOfUnitAdded$(m.UniverInstanceType.UNIVER_SHEET).pipe((0,w.takeUntil)(this.dispose$)).subscribe(e),this._univerInstanceService.getTypeOfUnitDisposed$(m.UniverInstanceType.UNIVER_SHEET).pipe((0,w.takeUntil)(this.dispose$)).subscribe(e=>{e.getSheets().forEach(t=>{let n=e.getUnitId(),r=t.getSheetId();oc().forEach(e=>{let t=new e(n,r);this._permissionService.deletePermissionPoint(t.id)})})})}_initRuleChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":break;case"delete":oc().forEach(t=>{let n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)});break;case"set":oc().forEach(t=>{let n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,e.rule)})}}))}_initRuleSnapshot(){let e=/* @__PURE__ */_(()=>JSON.stringify(this._worksheetProtectionRuleModel.toObject()),"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:"SHEET_WORKSHEET_PROTECTION_PLUGIN",businesses:[ez.UNIVER_SHEET],onLoad:/* @__PURE__ */_((e,t)=>{this._worksheetProtectionRuleModel.fromObject(t),Object.keys(t).forEach(t=>{oc().forEach(n=>{let r=new n(e,t);r.value=!1,this._permissionService.addPermissionPoint(r)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)},"onLoad"),onUnLoad:/* @__PURE__ */_(e=>{this._worksheetProtectionRuleModel.deleteUnitModel(e)},"onUnLoad")}))}_initPointSnapshot(){let e=/* @__PURE__ */_(()=>JSON.stringify(this._worksheetProtectionPointRuleModel.toObject()),"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:"SHEET_WORKSHEET_PROTECTION_POINT_PLUGIN",businesses:[ez.UNIVER_SHEET],onLoad:/* @__PURE__ */_((e,t)=>{this._worksheetProtectionPointRuleModel.fromObject(t),Object.keys(t).forEach(t=>{om().forEach(n=>{let r=new n(e,t);this._permissionService.addPermissionPoint(r)})})},"onLoad"),onUnLoad:/* @__PURE__ */_(e=>{this._worksheetProtectionPointRuleModel.deleteUnitModel(e)},"onUnLoad")}))}},_(oW,"WorksheetPermissionService"),oW);oy=oS([(0,m.OnLifecycle)(m.LifecycleStages.Starting,oy),ow(0,(0,m.Inject)(m.IPermissionService)),ow(1,(0,m.Inject)(m.IUniverInstanceService)),ow(2,(0,m.Inject)(m.Injector)),ow(3,(0,m.Inject)(on)),ow(4,(0,m.Inject)(oR)),ow(5,(0,m.Inject)(m.IResourceManagerService)),ow(6,(0,m.Inject)(od))],oy);let ob={id:"sheet.mutation.set-worksheet-permission-points",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{rule:n}=t;return e.get(oR).addRule(n),!0},"handler")},oM={type:m.CommandType.COMMAND,id:"sheet.command.set-worksheet-permission-points",async handler(e,t){if(!t)return!1;let n=e.get(m.ICommandService),{rule:r}=t;return n.executeCommand(ob.id,{rule:r,unitId:r.unitId,subUnitId:r.subUnitId}),!0}},oU=(/* @__PURE__ */(e,t)=>{let n=e.get(od),r=t.ruleIds.map(e=>n.getRule(t.unitId,t.subUnitId,e)).filter(e=>!!e);return{id:o_.id,params:{subUnitId:t.subUnitId,unitId:t.unitId,rules:r}}},{id:"sheet.mutation.delete-range-protection",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ruleIds:o}=t,s=e.get(od);return o.forEach(e=>{s.deleteRule(n,r,e)}),!0},"handler")}),o_=(/* @__PURE__ */e=>{let t={...e,ruleIds:e.rules.map(e=>e.id)};return{id:oU.id,params:t}},{id:"sheet.mutation.add-range-protection",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rules:o}=t,s=e.get(od);return o.forEach(e=>{s.addRule(n,r,e)}),!0},"handler")}),oT={type:m.CommandType.COMMAND,id:"sheet.command.add-range-protection",async handler(e,t){if(!t)return!1;let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),o=e.get(od),{rule:s,permissionId:i}=t,{unitId:a,subUnitId:l,ranges:u,name:d,description:c}=s,h=[{ranges:u,permissionId:i,id:o.createRuleId(a,l),name:d,description:c,unitType:s.unitType,unitId:a,subUnitId:l}];if(await n.executeCommand(o_.id,{unitId:a,subUnitId:l,rules:h})){let e=[{id:o_.id,params:{unitId:a,subUnitId:l,rules:h}}],t=[{id:oU.id,params:{unitId:a,subUnitId:l,ruleIds:h.map(e=>e.id)}}];r.pushUndoRedo({unitID:a,redoMutations:e,undoMutations:t})}return!0}},oE={type:m.CommandType.COMMAND,id:"sheet.command.delete-range-protection",async handler(e,t){if(!t)return!1;let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),{unitId:o,subUnitId:s,rule:i}=t,a={unitId:o,subUnitId:s,ruleIds:[i.id]};return await n.executeCommand(oU.id,a)&&r.pushUndoRedo({unitID:o,redoMutations:[{id:oU.id,params:a}],undoMutations:[{id:o_.id,params:{unitId:o,subUnitId:s,rules:[i]}}]}),!0}},ok={id:"sheet.mutation.set-range-protection",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rule:o,ruleId:s}=t;return e.get(od).setRule(n,r,s,o),!0},"handler")},ox=(/* @__PURE__ */(e,t)=>{let{unitId:n,subUnitId:r,ruleId:o}=t,s=e.get(od).getRule(n,r,o);return s?{id:ok.id,params:{...t,rule:s}}:null},{type:m.CommandType.COMMAND,id:"sheet.command.set-range-protection",async handler(e,t){if(!t)return!1;let n=e.get(m.ICommandService),r=e.get(od),o=e.get(m.IUndoRedoService),{rule:s,permissionId:i,oldRule:a}=t,{unitId:l,subUnitId:u,ranges:d,name:c,description:h}=s;if(s.id){let e={unitId:l,subUnitId:u,ruleId:s.id,rule:{ranges:d,permissionId:i,id:r.createRuleId(l,u),name:c,description:h}};if(await n.executeCommand(ok.id,e)){let t=[{id:ok.id,params:e}],n=[{id:ok.id,params:{unitId:l,subUnitId:u,ruleId:s.id,rule:a}}];o.pushUndoRedo({unitID:l,redoMutations:t,undoMutations:n})}}return!0}}),oN=/* @__PURE__ */_(e=>{let{order:t}=e,n={};return Object.keys(t).forEach(e=>{n[t[Number(e)]]=Number(e)}),{...e,order:n}},"ReorderRangeUndoMutationFactory"),oO={id:"sheet.mutation.reorder-range",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{subUnitId:n,unitId:r,range:o,order:s}=t,i=e.get(m.IUniverInstanceService).getUnit(r).getSheetBySheetId(n);if(!i)return!1;let a=new m.ObjectMatrix;(0,m.Range).foreach(o,(e,t)=>{if(s.hasOwnProperty(e)){let n=s[e],r=(0,m.Tools).deepClone(i.getCellRaw(n,t));a.setValue(e,t,r)}});let l=i.getCellMatrix();return a.forValue((e,t,n)=>{l.setValue(e,t,n)}),!0},"handler")},oD="sheet.command.reorder-range",oP={id:oD,type:m.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n,r;let{subUnitId:o,unitId:s,range:i,order:a}=t,l=e.get(m.ICommandService),u={id:oO.id,params:{unitId:s,subUnitId:o,order:a,range:i}},d={id:oO.id,params:oN(u.params)},c=e.get(G).onCommandExecute({id:oP.id,params:t}),h=[...null!=(n=c.preRedos)?n:[],u,...c.redos],g=[...null!=(r=c.preUndos)?r:[],d,...c.undos];return!!(0,m.sequenceExecute)(h,l).result&&(e.get(m.IUndoRedoService).pushUndoRedo({unitID:s,undoMutations:g,redoMutations:h}),!0)},"handler")},oA="maxCellsPerSheet",oV="ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY";var oW,o$,oL=Object.defineProperty,oj=Object.getOwnPropertyDescriptor,oB=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?oj(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&oL(t,n,s),s},"__decorateClass$b"),oH=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$b");let oF=(_(o$=class extends m.Disposable{constructor(e,t,n){var r;super(),this._commandService=e,this._configService=t,this._dataSyncPrimaryController=n,[eu,t2,t0,ef,e_,nd,nm,t6,t3,eb,nT,rX,nU,r4,r_,rK,oO,r0,rv].forEach(e=>{var t;this._commandService.registerCommand(e),null==(t=this._dataSyncPrimaryController)||t.registerSyncingMutations(e)}),null!=(r=this._configService.getConfig(oV))&&r||[ep,eI,eC,eM,tK,tZ,rS,rW,na,ni,ns,t7,t9,nr,nn,nt,nl,nR,eG,nI,ny,nS,nb,oP,nE,ru,ra,rl,nD,nV,nW,nP,nA,nG,nL,nB,rw,nZ,nX,nK,rc,tq,r$,n4,n2,n0,nF,n3,nH,n5,n9,rI,rp,ri,rh,rm,rd,r6,rR,rC,rM,rb,rT,rx,rk,rV,rP,rL,rA,eP,r3,r1,r2,r5,rj,oM,or,oo,os,ob,oT,oE,ox,o_,oU,ok].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e))),this._configService.setConfig(oA,3e6)}},"BasicWorksheetController"),o$);oF=oB([(0,m.OnLifecycle)(m.LifecycleStages.Starting,oF),oH(0,m.ICommandService),oH(1,m.IConfigService),oH(2,(0,m.Optional)(g.DataSyncPrimaryController))],oF);var oG,oq=Object.defineProperty,oz=Object.getOwnPropertyDescriptor,oY=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?oz(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&oq(t,n,s),s},"__decorateClass$a"),oJ=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$a");let oK=(_(oG=class extends m.Disposable{constructor(e,t){super(),this._univerInstanceService=e,this._commandService=t,this._initialize()}_initialize(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==h.SetFormulaCalculationResultMutation.id)return;let{unitData:t}=e.params,n=Object.keys(t),r=[];return n.forEach(e=>{let n=t[e];if(null==n)return!0;Object.keys(n).forEach(t=>{let o=n[t];if(null==o)return!0;let s=this._getMergedCellData(e,t,o);r.push({id:eu.id,params:{subUnitId:t,unitId:e,cellValue:s}})})}),r.every(e=>this._commandService.executeCommand(e.id,e.params,{onlyLocal:!0}))}))}_getMergedCellData(e,t,n){let r=this._univerInstanceService.getUniverSheetInstance(e),o=null==r?void 0:r.getStyles(),s=null==r?void 0:r.getSheetBySheetId(t),i=null==s?void 0:s.getCellMatrix(),a=new m.ObjectMatrix(n);return a.forValue((e,t,n)=>{let r=null==i?void 0:i.getValue(e,t),s=(0,h.handleNumfmtInCell)(r,n,o);a.setValue(e,t,s)}),a.clone()}},"CalculateResultApplyController"),oG);oK=oY([(0,m.OnLifecycle)(m.LifecycleStages.Ready,oK),oJ(0,(0,m.Inject)(m.IUniverInstanceService)),oJ(1,m.ICommandService)],oK);let oX={MoveRangeCommandId:eF,InsertRowCommandId:ne,InsertColCommandId:no,RemoveColCommandId:nw,RemoveRowCommandId:nv,DeleteRangeMoveLeftCommandId:tJ,DeleteRangeMoveUpCommandId:tX,InsertRangeMoveDownCommandId:"sheet.command.insert-range-move-down",InsertRangeMoveRightCommandId:t8,MoveColsCommandId:nC,MoveRowsCommandId:np,ReorderRangeCommandId:oD};var oZ=((u=oZ||{})[u.Set=0]="Set",u[u.Delete=1]="Delete",u[u.HorizontalMove=2]="HorizontalMove",u[u.VerticalMove=3]="VerticalMove",u[u.Unknown=4]="Unknown",u);let oQ=Number.MAX_SAFE_INTEGER,o0=/* @__PURE__ */_(e=>{let t={...e},n=Number.isNaN(t.startRow)&&Number.isNaN(t.endRow)&&!Number.isNaN(t.startColumn)&&!Number.isNaN(t.endColumn),r=Number.isNaN(t.startColumn)&&Number.isNaN(t.endColumn)&&!Number.isNaN(t.startRow)&&!Number.isNaN(t.endRow);return(t.rangeType===m.RANGE_TYPE.COLUMN||n)&&(t.startRow=0,t.endRow=oQ),(t.rangeType===m.RANGE_TYPE.ROW||r)&&(t.startColumn=0,t.endColumn=oQ),t.rangeType===m.RANGE_TYPE.ALL&&(t.startColumn=0,t.endColumn=oQ,t.startRow=0,t.endRow=oQ),t},"handleRangeTypeInput"),o1=/* @__PURE__ */_(e=>{let t=e.rangeType;return e.rangeType===m.RANGE_TYPE.COLUMN?t=m.RANGE_TYPE.ROW:e.rangeType===m.RANGE_TYPE.ROW&&(t=m.RANGE_TYPE.COLUMN),{startRow:e.startColumn,endRow:e.endColumn,startColumn:e.startRow,endColumn:e.endRow,rangeType:t}},"rotateRange"),o2=/* @__PURE__ */_((e,t,n)=>{let r={...n},o={...t},s=/* @__PURE__ */_((e,t)=>{let n=Math.max(e.start,t.start),r=Math.min(e.end,t.end);return r<n?null:{start:n,end:r}},"getIntersects"),i=/* @__PURE__ */_(e=>e.end-e.start+1,"getLength"),a=/* @__PURE__ */_((e,t)=>({start:e.start-t.start,end:e.start-t.start+e.end-e.start}),"getRelative"),l=/* @__PURE__ */_((e,t)=>({start:t.start+e.start,end:t.start+e.start+e.end-e.start}),"getAbsolute"),u=t.start>e.start;if(u){let n=Math.min(e.end,t.start)-e.start+1;o.start-=n,o.end-=n}let d=i(e),c=s(e,r),m=c&&i(c)>=i(r);if(e.end<r.start)r.start-=d,r.end-=d;else if(c){let t=i(c);if(m){let t=l(a(r,e),o);r.start=t.start,r.end=t.end}else c.start>e.start?u?(r.end-=t+d,r.start-=d):r.end-=t:u?r.end-=t:r.start>e.start&&r.end>e.end?(r.start-=d,r.end-=d+t):r.end-=t}let h=s(o,r);return m||(o.start<=r.start?(r.start+=d,r.end+=d):h&&(u?o.end<=r.start||o.start<=r.start&&o.end>=r.start?(r.start+=d,r.end+=d):o.start>=r.start&&o.start<=r.end&&(r.end+=d):r.start<o.start&&r.end>o.start?r.end+=d:(r.start>=o.end||r.start>=o.start&&r.start<=o.end)&&(r.end+=d,r.start+=d))),{step:r.start-n.start,length:i(r)-i(n)}},"handleBaseMoveRowsCols"),o5=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!r||!n)return[];let o=o0(n),s=o0(r),i=o0(t),a=o2({start:o.startRow,end:o.endRow},{start:s.startRow,end:s.endRow},{start:i.startRow,end:i.endRow});return null===a?[{type:oZ.Delete}]:[{type:oZ.VerticalMove,step:a.step||0,length:a.length||0}]},"handleMoveRows"),o3=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!n||!r)return[t];let o=n.startRow,s=n.endRow-n.startRow+1,i=r.startRow,a=new m.ObjectMatrix;return(0,m.Range).foreach(t,(e,t)=>{a.setValue(e,t,1)}),a.moveRows(o,s,i),(0,m.queryObjectMatrix)(a,e=>1===e)},"handleMoveRowsCommon"),o4=/* @__PURE__ */_((e,t)=>{let{range:n,order:r}=e.params||{};if(!n||!r)return[t];let o=new m.ObjectMatrix;(0,m.Range).foreach(t,(e,t)=>{o.setValue(e,t,1)});let s=new m.ObjectMatrix;return(0,m.Range).foreach(n,(e,t)=>{var n;if(r.hasOwnProperty(e)){let i=r[e],a=null!=(n=o.getValue(i,t))?n:0;s.setValue(e,t,a)}}),s.forValue((e,t,n)=>{o.setValue(e,t,n)}),(0,m.queryObjectMatrix)(o,e=>1===e)},"handleReorderRangeCommon"),o6=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!r||!n)return[];let o=o0(n),s=o0(r),i=o0(t),a=o2({start:o.startColumn,end:o.endColumn},{start:s.startColumn,end:s.endColumn},{start:i.startColumn,end:i.endColumn});return null===a?[{type:oZ.Delete}]:[{type:oZ.HorizontalMove,step:a.step||0,length:a.length||0}]},"handleMoveCols"),o7=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!n||!r)return[t];let o=n.startColumn,s=n.endColumn-n.startColumn+1,i=r.startColumn,a=new m.ObjectMatrix;return(0,m.Range).foreach(t,(e,t)=>{a.setValue(e,t,1)}),a.moveColumns(o,s,i),(0,m.queryObjectMatrix)(a,e=>1===e)},"handleMoveColsCommon"),o8=/* @__PURE__ */_((e,t)=>{var n,r;let o=null==(n=e.params)?void 0:n.toRange,s=null==(r=e.params)?void 0:r.fromRange;if(!o||!s)return[];let i=[];if((0,m.Rectangle).contains(o,t)&&i.push({type:oZ.Delete}),(0,m.Rectangle).contains(s,t)){i.push({type:oZ.Delete});let e=(0,m.Rectangle).getRelativeRange(t,s),n=(0,m.Rectangle).getPositionRange(e,o);return[{type:oZ.Set,range:n}]}return i},"handleMoveRange"),o9=/* @__PURE__ */_((e,t)=>{var n,r;let o=null==(n=e.params)?void 0:n.toRange,s=null==(r=e.params)?void 0:r.fromRange;if(!o||!s||!(0,m.Rectangle).intersects(s,t)&&!(0,m.Rectangle).intersects(o,t))return[t];if((0,m.Rectangle).contains(s,t)){let e=(0,m.Rectangle).getRelativeRange(t,s);return[(0,m.Rectangle).getPositionRange(e,o)]}let i=new m.ObjectMatrix;(0,m.Range).foreach(t,(e,t)=>{i.setValue(e,t,1)});let a=new m.ObjectMatrix,l=(0,m.Rectangle).getIntersects(s,t);l&&(0,m.Range).foreach(l,(e,t)=>{i.getValue(e,t)&&(i.setValue(e,t,void 0),a.setValue(e,t,1))});let u=o.startColumn-s.startColumn,d=o.startRow-s.startRow,c={startColumn:o.startColumn-u,endColumn:o.endColumn-u,startRow:o.startRow-d,endRow:o.endRow-d};return c&&(0,m.Range).foreach(c,(e,t)=>{var n;let r=e+d,o=t+u;i.setValue(r,o,null!=(n=a.getValue(e,t))?n:0)}),(0,m.queryObjectMatrix)(i,e=>1===e)},"handleMoveRangeCommon"),se=/* @__PURE__ */_((e,t)=>{let n=o0(e),r=o0(t),o=/* @__PURE__ */_(e=>e.endColumn-e.startColumn+1,"getLength"),s=/* @__PURE__ */_(e=>e.endRow-e.startRow+1,"getRowLength");if(n.startRow<=r.startRow&&n.endRow>=r.endRow){if(r.startColumn<n.startColumn&&r.endColumn>=n.startColumn&&r.endColumn<=n.endColumn||r.startColumn<n.startColumn&&r.endColumn>=n.endColumn){let e=(0,m.Rectangle).getIntersects(r,n);if(e)return{step:0,length:-o(e)}}if(r.startColumn>=n.startColumn&&r.endColumn<=n.endColumn&&s(n)>=s(r))return null;if(r.startColumn>=n.startColumn&&r.startColumn<=n.endColumn&&r.endColumn>n.endColumn){let e=(0,m.Rectangle).getIntersects(r,n);if(e){let t=-o(e);return{step:-(o(n)-o(e)),length:t}}}if(r.startColumn>n.endColumn)return{step:-o(n),length:0}}return{step:0,length:0}},"handleBaseRemoveRange"),st=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],s=se(r,t);if(s){let{step:e,length:t}=s;o.push({type:oZ.HorizontalMove,step:e,length:t})}else o.push({type:oZ.Delete});return o},"handleIRemoveCol"),sn=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],s=se(o1(r),o1(t));if(s){let{step:e,length:t}=s;o.push({type:oZ.VerticalMove,step:e,length:t})}else o.push({type:oZ.Delete});return o},"handleIRemoveRow"),sr=/* @__PURE__ */_((e,t)=>{let{range:n,order:r}=e.params||{};if(!n||!r)return[];if((0,m.Rectangle).contains(n,t)&&t.endRow===t.startRow){let e=[],n=t.startRow;for(let t in r)if(r[t]===n){let r=Number(t);return e.push({type:oZ.VerticalMove,step:r-n,length:0}),e}}return[]},"handleReorderRange"),so=/* @__PURE__ */_((e,t)=>{let n=o0(e),r=o0(t),o=/* @__PURE__ */_(e=>e.endColumn-e.startColumn+1,"getLength");if(n.startRow<=r.startRow&&n.endRow>=r.endRow){if(r.startColumn<n.startColumn&&r.endColumn>=n.startColumn&&r.endColumn<=n.endColumn||r.startColumn<n.startColumn&&r.endColumn>=n.endColumn)return{step:0,length:o(n)};if(r.startColumn>=n.startColumn&&r.endColumn<=n.endColumn||r.startColumn>n.startColumn&&r.startColumn<=n.endColumn&&r.endColumn>n.endColumn||r.startColumn>=n.endColumn)return{step:o(n),length:0}}return{step:0,length:0}},"handleBaseInsertRange");function ss(e,t,n){let r=[];if((0,m.Rectangle).contains(t,n)&&r.push({type:oZ.Delete}),(0,m.Rectangle).contains(e,n)){r.push({type:oZ.Delete});let o=(0,m.Rectangle).getRelativeRange(n,e),s=(0,m.Rectangle).getPositionRange(o,t);return[{type:oZ.Set,range:s}]}return r}_(ss,"handleBaseMoveRange");let si=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:s,length:i}=so(o1(r),o1(t));return o.push({type:oZ.VerticalMove,step:s,length:i}),o},"handleInsertRow"),sa=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:s,length:i}=so(r,t);return o.push({type:oZ.HorizontalMove,step:s,length:i}),o},"handleInsertCol"),sl=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:s,length:i}=so(o1(r),o1(t));return o.push({type:oZ.VerticalMove,step:s,length:i}),o},"handleInsertRangeMoveDown"),su=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o=r.endRow-r.startRow+1,s={...r,startRow:r.startRow,endRow:Number.POSITIVE_INFINITY},i=(0,m.Rectangle).subtract(t,s),a=(0,m.Rectangle).getIntersects(s,t);if(!a)return[t];let l=new m.ObjectMatrix;return i.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{l.setValue(e,t,1)})}),a&&(0,m.Range).foreach(a,(e,t)=>{l.setValue(e+o,t,1)}),(0,m.queryObjectMatrix)(l,e=>1===e)},"handleInsertRangeMoveDownCommon"),sd=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:s,length:i}=so(r,t);return o.push({type:oZ.HorizontalMove,step:s,length:i}),o},"handleInsertRangeMoveRight"),sc=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o=r.endColumn-r.startColumn+1,s={...r,startColumn:r.startColumn,endColumn:Number.POSITIVE_INFINITY},i=(0,m.Rectangle).subtract(t,s),a=(0,m.Rectangle).getIntersects(s,t);if(!a)return[t];let l=new m.ObjectMatrix;return i.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{l.setValue(e,t,1)})}),a&&(0,m.Range).foreach(a,(e,t)=>{l.setValue(e,t+o,1)}),(0,m.queryObjectMatrix)(l,e=>1===e)},"handleInsertRangeMoveRightCommon"),sm=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],s=se(r,t);if(s){let{step:e,length:t}=s;o.push({type:oZ.HorizontalMove,step:e,length:t})}else o.push({type:oZ.Delete});return o},"handleDeleteRangeMoveLeft"),sh=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o={startRow:r.startRow,endRow:r.endRow,startColumn:r.startColumn,endColumn:Number.POSITIVE_INFINITY},s=r.endColumn-r.startColumn+1,i=(0,m.Rectangle).getIntersects(r,t),a=(0,m.Rectangle).subtract(t,o),l=(0,m.Rectangle).getIntersects(o,t);if(!i&&!l)return[t];let u=new m.ObjectMatrix;return l&&(0,m.Range).foreach(l,(e,t)=>{u.setValue(e,t-s,1)}),i&&(0,m.Range).foreach(i,(e,t)=>{u.setValue(e,t-s,0)}),a.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{u.setValue(e,t,1)})}),(0,m.queryObjectMatrix)(u,e=>1===e)},"handleDeleteRangeMoveLeftCommon"),sg=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],s=se(o1(r),o1(t));if(s){let{step:e,length:t}=s;o.push({type:oZ.VerticalMove,step:e,length:t})}else o.push({type:oZ.Delete});return o},"handleDeleteRangeMoveUp"),sp=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o={...r,startRow:r.startRow,endRow:Number.POSITIVE_INFINITY},s=r.endRow-r.startRow+1,i=(0,m.Rectangle).getIntersects(r,t),a=(0,m.Rectangle).subtract(t,o),l=(0,m.Rectangle).getIntersects(o,t);if(!i&&!l)return[t];let u=new m.ObjectMatrix;return l&&(0,m.Range).foreach(l,(e,t)=>{u.setValue(e-s,t,1)}),i&&(0,m.Range).foreach(i,(e,t)=>{u.setValue(e-s,t,0)}),a.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{u.setValue(e,t,1)})}),(0,m.queryObjectMatrix)(u,e=>1===e)},"handleDeleteRangeMoveUpCommon"),sI=/* @__PURE__ */_((e,t)=>{var n;let r=null!=(n=e.ranges)?n:[e.range],o=new m.ObjectMatrix;return(0,m.Range).foreach(t,(e,t)=>{o.setValue(e,t,1)}),r.forEach(e=>{let t=e.startRow,n=e.endRow-t+1;o.removeRows(t,n)}),(0,m.queryObjectMatrix)(o,e=>1===e)},"handleRemoveRowCommon"),sC=/* @__PURE__ */_((e,t)=>{let n={...t};return e.forEach(e=>{switch(e.type){case oZ.Delete:n=null;break;case oZ.HorizontalMove:if(!n)return;n.startColumn+=e.step,n.endColumn+=e.step+(e.length||0);break;case oZ.VerticalMove:if(!n)return;n.startRow+=e.step,n.endRow+=e.step+(e.length||0);break;case oZ.Set:n=e.range}}),n&&(n.endColumn<n.startColumn||n.endRow<n.startRow)?null:n},"runRefRangeMutations"),sR=/* @__PURE__ */_((e,t)=>{let n=[];switch(t.id){case oX.DeleteRangeMoveLeftCommandId:n=sm(t,e);break;case oX.DeleteRangeMoveUpCommandId:n=sg(t,e);break;case oX.InsertColCommandId:n=sa(t,e);break;case oX.InsertRangeMoveDownCommandId:n=sl(t,e);break;case oX.InsertRangeMoveRightCommandId:n=sd(t,e);break;case oX.InsertRowCommandId:n=si(t,e);break;case oX.MoveColsCommandId:n=o6(t,e);break;case oX.MoveRangeCommandId:n=o8(t,e);break;case oX.MoveRowsCommandId:n=o5(t,e);break;case oX.RemoveColCommandId:n=st(t,e);break;case oX.RemoveRowCommandId:n=sn(t,e);break;case oX.ReorderRangeCommandId:n=sr(t,e)}return sC(n,e)},"handleDefaultRangeChangeWithEffectRefCommands"),sf=/* @__PURE__ */_((e,t,n)=>[tK.id,tZ.id].includes(t.id)||sy(t,n).some(t=>(0,m.Rectangle).intersects(t,e))?sR(e,t):e,"handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests"),sv=/* @__PURE__ */_((e,t)=>{let n=[];switch(t.id){case oX.DeleteRangeMoveLeftCommandId:return sh(t,e);case oX.DeleteRangeMoveUpCommandId:return sp(t,e);case oX.InsertRangeMoveDownCommandId:return su(t,e);case oX.InsertRangeMoveRightCommandId:return sc(t,e);case oX.InsertColCommandId:n=sa(t,e);break;case oX.InsertRowCommandId:n=si(t,e);break;case oX.MoveColsCommandId:return o7(t,e);case oX.MoveRangeCommandId:return o9(t,e);case oX.MoveRowsCommandId:return o3(t,e);case oX.ReorderRangeCommandId:return o4(t,e);case oX.RemoveColCommandId:n=st(t,e);break;case oX.RemoveRowCommandId:return sI(t.params,e)}return sC(n,e)},"handleCommonDefaultRangeChangeWithEffectRefCommands"),sS=/* @__PURE__ */_((e,t,n)=>[tK.id,tZ.id,t7.id,t8].includes(t.id)||sy(t,n).some(t=>(0,m.Rectangle).intersects(t,e))?sv(e,t):e,"handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests");function sw(e,t){let{id:n,params:r}=t,o={length:0,step:0,type:oZ.Unknown};switch(n){case eb.id:o.type=oZ.Delete;break;case nd.id:(o=o2({start:r.sourceRange.startRow,end:r.sourceRange.endRow},{start:r.targetRange.startRow,end:r.targetRange.endRow},{start:e.startRow,end:e.endRow})).type=oZ.VerticalMove;break;case nm.id:(o=o2({start:r.sourceRange.startColumn,end:r.sourceRange.endColumn},{start:r.targetRange.startColumn,end:r.targetRange.endColumn},{start:e.startColumn,end:e.endColumn})).type=oZ.HorizontalMove;break;case t6.id:(o=se(r.range,e))?o.type=oZ.HorizontalMove:o={step:0,length:0,type:oZ.Delete};break;case t3.id:(o=se(o1(r.range),o1(e)))?o.type=oZ.VerticalMove:o={step:0,length:0,type:oZ.Delete};break;case t0.id:(o=so(o1(r.range),o1(e))).type=oZ.VerticalMove;break;case t2.id:(o=so(r.range,e)).type=oZ.HorizontalMove;break;case e_.id:o=ss(r.fromRange||new(0,m.ObjectMatrix)(r.from).getRange(),r.toRange||new(0,m.ObjectMatrix)(r.to).getRange(),e)}return o?Array.isArray(o)?sC(o,e):sC([o],e):e}function sy(e,t){var n,r,o,s,i,a;let{selectionManagerService:l}=t;switch(e.id){case oX.MoveColsCommandId:{let t=e.params;return[t.fromRange,{...t.toRange,startColumn:t.toRange.startColumn-.5,endColumn:t.toRange.endColumn-.5}]}case oX.MoveRowsCommandId:{let t=e.params;return[t.fromRange,{...t.toRange,startRow:t.toRange.startRow-.5,endRow:t.toRange.startRow-.5}]}case oX.MoveRangeCommandId:return[e.params.fromRange,e.params.toRange];case oX.InsertRowCommandId:{let t=e.params.range;return[{...t,startRow:t.startRow-.5,endRow:t.endRow-.5}]}case oX.InsertColCommandId:{let t=e.params.range;return[{...t,startColumn:t.startColumn-.5,endColumn:t.endColumn-.5}]}case oX.RemoveRowCommandId:case oX.RemoveColCommandId:return[e.params.range];case oX.DeleteRangeMoveUpCommandId:case oX.InsertRangeMoveDownCommandId:{let t=(null==(n=e.params)?void 0:n.range)||(null==(o=null==(r=l.getCurrentSelections())?void 0:r.map(e=>e.range))?void 0:o[0]);return t?[t]:[]}case oX.DeleteRangeMoveLeftCommandId:case oX.InsertRangeMoveRightCommandId:{let t=(null==(s=e.params)?void 0:s.range)||(null==(a=null==(i=l.getCurrentSelections())?void 0:i.map(e=>e.range))?void 0:a[0]);return t?[t]:[]}case oX.ReorderRangeCommandId:{let{range:t,order:n}=e.params,r=[];for(let e=t.startRow;e<=t.endRow;e++)e in n&&r.push({startRow:e,endRow:e,startColumn:t.startColumn,endColumn:t.endColumn});return r}}}function sb(e){switch(e.id){case nm.id:{let t=e.params;return[t.sourceRange,{...t.targetRange,startColumn:t.targetRange.startColumn-.5,endColumn:t.targetRange.startColumn-.5}]}case nd.id:{let t=e.params;return[t.sourceRange,{...t.targetRange,startRow:t.targetRange.startRow-.5,endRow:t.targetRange.startRow-.5}]}case e_.id:{let t=e.params;return[new(0,m.ObjectMatrix)(t.from.value).getRange(),new(0,m.ObjectMatrix)(t.to.value).getRange()]}case t2.id:{let t=e.params.range;return[{...t,startColumn:t.startColumn-.5,endColumn:t.startColumn-.5}]}case t0.id:{let t=e.params.range;return[{...t,startRow:t.startRow-.5,endRow:t.startRow-.5}]}case t6.id:case t3.id:return[e.params.range]}}_(sw,"adjustRangeOnMutation"),_(sy,"getEffectedRangesOnCommand"),_(sb,"getEffectedRangesOnMutation");var sM=Object.defineProperty,sU=Object.getOwnPropertyDescriptor,s_=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?sU(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&sM(t,n,s),s},"__decorateClass$9"),sT=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$9");let sE=(0,m.createInterceptorKey)("MERGE_REDO"),sk=(0,m.createInterceptorKey)("MERGE_UNDO"),sx=Math.floor(Number.MAX_SAFE_INTEGER/10),sN=class extends m.Disposable{constructor(e,t,n,r,o=!1){super(),this._unitId=e,this._subUnitId=t,this._range=n,this._callback=r,this._skipIntersects=o}onMutation(e){var t,n;if((null==(t=e.params)?void 0:t.unitId)!==this._unitId)return;if(e.id===e_.id){let t=e.params;if(t.from.subUnitId!==this._subUnitId||t.to.subUnitId!==this._subUnitId)return}else if((null==(n=e.params)?void 0:n.subUnitId)!==this._subUnitId)return;if(!this._range)return;if(this._skipIntersects){if(e.id===eb.id)return;let t=sb(e);if(null!=t&&t.some(e=>(0,m.Rectangle).intersects(e,this._range)))return}let r=sw(this._range,e);if(r&&(0,m.Rectangle).equals(r,this._range))return!1;let o=this._range;this._range=r,this._callback(o,r)}};_(sN,"WatchRange");let sO=(sK=class extends m.Disposable{constructor(e,t,n,r){super(),T(this,"interceptor",new m.InterceptorManager({MERGE_REDO:sE,MERGE_UNDO:sk})),T(this,"_watchRanges",/* @__PURE__ */new Set),T(this,"_refRangeManagerMap",/* @__PURE__ */new Map),T(this,"_serializer",sW()),T(this,"_onRefRangeChange",/* @__PURE__ */_(()=>{this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */_(e=>{let t=this._univerInstanceService.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET).getActiveSheet(),n=sD(this._univerInstanceService),r=sP(this._univerInstanceService);if(!t||!n||!r)return{redos:[],undos:[],preRedos:[],preUndos:[]};let o=/* @__PURE__ */(_(()=>{switch(e.id){case oX.MoveColsCommandId:{let o=e.params,s=Math.min(o.fromRange.startColumn,o.toRange.startColumn);return this._checkRange([{...o.fromRange,startColumn:s,endColumn:t.getColumnCount()-1}],n,r)}case oX.MoveRowsCommandId:{let o=e.params,s=Math.min(o.fromRange.startRow,o.toRange.startRow);return this._checkRange([{...o.fromRange,startRow:s,endRow:t.getRowCount()-1}],n,r)}case oX.MoveRangeCommandId:return this._checkRange([e.params.fromRange,e.params.toRange],n,r);case oX.InsertRowCommandId:{let o={startRow:e.params.range.startRow,endRow:t.getRowCount()-1,startColumn:0,endColumn:t.getColumnCount()-1,rangeType:m.RANGE_TYPE.ROW};return this._checkRange([o],n,r)}case oX.InsertColCommandId:{let o=e.params.range.startColumn,s={startRow:0,endRow:t.getRowCount()-1,startColumn:o,endColumn:t.getColumnCount()-1,rangeType:m.RANGE_TYPE.COLUMN};return this._checkRange([s],n,r)}case oX.RemoveRowCommandId:{let o={startRow:e.params.range.startRow,endRow:t.getRowCount()-1,startColumn:0,endColumn:t.getColumnCount()-1,rangeType:m.RANGE_TYPE.ROW};return this._checkRange([o],n,r)}case oX.RemoveColCommandId:{let o=e.params.range.startColumn,s={startRow:0,endRow:t.getRowCount()-1,startColumn:o,endColumn:t.getColumnCount()-1,rangeType:m.RANGE_TYPE.COLUMN};return this._checkRange([s],n,r)}case oX.DeleteRangeMoveUpCommandId:case oX.InsertRangeMoveDownCommandId:{let t=e.params.range||sA(this._selectionManagerService)[0],o={startRow:t.startRow,startColumn:t.startColumn,endColumn:t.endColumn,endRow:sx};return this._checkRange([o],n,r)}case oX.DeleteRangeMoveLeftCommandId:case oX.InsertRangeMoveRightCommandId:{let t=e.params.range||sA(this._selectionManagerService)[0],o={startRow:t.startRow,startColumn:t.startColumn,endColumn:sx,endRow:t.endRow};return this._checkRange([o],n,r)}case oX.ReorderRangeCommandId:{let{range:t,order:o}=e.params,s=[];for(let e=t.startRow;e<=t.endRow;e++)e in o&&s.push({startRow:e,endRow:e,startColumn:t.startColumn,endColumn:t.endColumn});return this._checkRange(s,n,r)}}},"getEffectsCbList")()||[]).reduce((t,n)=>{let r=n(e);return t.push(r),t},[]).reduce((e,t)=>{var n,r;return e.redos.push(...t.redos),e.undos.push(...t.undos),e.preRedos.push(...null!=(n=t.preRedos)?n:[]),e.preUndos.push(...null!=(r=t.preUndos)?r:[]),e},{redos:[],undos:[],preUndos:[],preRedos:[]}),s=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(o.preRedos,null)||[],i=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(o.redos,null)||[],a=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(o.preUndos,null)||[];return{redos:i,undos:this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(o.undos,null)||[],preRedos:s,preUndos:a}},"getMutations")})},"_onRefRangeChange")),T(this,"_checkRange",/* @__PURE__ */_((e,t,n)=>{let r=sV(t,n),o=this._refRangeManagerMap.get(r);if(o){let t=/* @__PURE__ */new Set;return[...o.keys()].forEach(n=>{let r=o.get(n),s=this._serializer.deserialize(n),i={...s,startRow:+s.startRow,endRow:+s.endRow,startColumn:+s.startColumn,endColumn:+s.endColumn,rangeType:s.rangeType&&+s.rangeType};e.some(e=>(0,m.Rectangle).intersects(e,i))&&r&&r.forEach(e=>{t.add(e)})}),[...t]}return[]},"_checkRange")),T(this,"registerRefRange",/* @__PURE__ */_((e,t,n,r)=>{let o=n||sD(this._univerInstanceService),s=r||sP(this._univerInstanceService);if(!o||!s)return(0,m.toDisposable)(()=>{});let i=sV(o,s),a=this._serializer.serialize(e),l=this._refRangeManagerMap.get(i);l||(l=/* @__PURE__ */new Map,this._refRangeManagerMap.set(i,l));let u=l.get(a);return u?u.add(t):l.set(a,/* @__PURE__ */new Set([t])),(0,m.toDisposable)(()=>{let e=l.get(a);e&&(e.delete(t),e.size||(l.delete(a),l.size||this._refRangeManagerMap.delete(i)))})},"registerRefRange")),this._commandService=e,this._sheetInterceptorService=t,this._univerInstanceService=n,this._selectionManagerService=r,this._onRefRangeChange(),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_REDO,{priority:-1,handler:/* @__PURE__ */_(e=>e,"handler")}),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_UNDO,{priority:-1,handler:/* @__PURE__ */_(e=>e,"handler")})}watchRange(e,t,n,r,o){let s;0===this._watchRanges.size&&(s=this._commandService.onCommandExecuted(e=>{if(e.type!==m.CommandType.MUTATION)return!1;for(let t of this._watchRanges)t.onMutation(e)}));let i=new sN(e,t,n,r,o);this._watchRanges.add(i);let a=(0,m.toDisposable)(()=>{this._watchRanges.delete(i),0===this._watchRanges.size&&(null==s||s.dispose(),s=null)}),l=this.disposeWithMe(a);return(0,m.toDisposable)(()=>{l.dispose(),a.dispose()})}},_(sK,"RefRangeService"),sK);function sD(e){return e.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET).getUnitId()}function sP(e){var t;return null==(t=e.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET).getActiveSheet())?void 0:t.getSheetId()}function sA(e){var t;return(null==(t=e.getCurrentSelections())?void 0:t.map(e=>e.range))||[]}function sV(e,t){return`${e}_${t}`}function sW(){let e=["startRow","startColumn","endRow","endColumn","rangeType"];return{deserialize:/* @__PURE__ */_(t=>{let n=e.reduce((e,t,n)=>(e[String(n)]=t,e),{});return t.split("_").reduce((e,t,r)=>{let o=String(r);return t&&n[o]&&(e[n[o]]=t),e},{})},"deserialize"),serialize:/* @__PURE__ */_(t=>e.reduce((e,n,r)=>{let o=t[n];return void 0!==o?`${e}${r>0?"_":""}${o}`:`${e}`},""),"serialize")}}sO=s_([(0,m.OnLifecycle)(m.LifecycleStages.Ready,sO),sT(0,m.ICommandService),sT(1,(0,m.Inject)(G)),sT(2,(0,m.Inject)(m.IUniverInstanceService)),sT(3,(0,m.Inject)(D))],sO),_(sD,"getUnitId"),_(sP,"getSubUnitId"),_(sA,"getSelectionRanges"),_(sV,"getRefRangId"),_(sW,"createRangeSerializer");var s$=Object.defineProperty,sL=Object.getOwnPropertyDescriptor,sj=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?sL(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&s$(t,n,s),s},"__decorateClass$8"),sB=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$8");let sH=[t2.id,t0.id,t6.id,t3.id],sF=[nd.id,nm.id];function sG(e,t){let n=e;if(void 0!==t){let e=[];for(let r=0;r<n.length;r++){let{startRow:o,endRow:s,startColumn:i,endColumn:a}=n[r];if(t===m.Dimension.ROWS)for(let t=o;t<=s;t++){let n={startRow:t,endRow:t,startColumn:i,endColumn:a};e.push(n)}else if(t===m.Dimension.COLUMNS)for(let t=i;t<=a;t++){let n={startRow:o,endRow:s,startColumn:t,endColumn:t};e.push(n)}}n=e}return n}_(sG,"getAddMergeMutationRangeByType");let sq=(0,m.createInterceptorKey)("mergeCellPermissionCheck"),sz=(sX=class extends m.Disposable{constructor(e,t,n,r,o,s){super(),T(this,"disposableCollection",new m.DisposableCollection),T(this,"interceptor",new m.InterceptorManager({MERGE_CELL_INTERCEPTOR_CHECK:sq})),this._commandService=e,this._refRangeService=t,this._univerInstanceService=n,this._injector=r,this._sheetInterceptorService=o,this._selectionManagerService=s,this._onRefRangeChange(),this._initCommandInterceptor(),this._commandExecutedListener()}_initCommandInterceptor(){let e=this;this._sheetInterceptorService.interceptCommand({getMutations(t){var n;switch(t.id){case ep.id:case eC.id:{let t=e._univerInstanceService.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET),r=t.getUnitId(),o=t.getActiveSheet();if(!o)return{redos:[],undos:[]};let s=o.getSheetId(),i=o.getConfig().mergeData,a=null==(n=e._selectionManagerService.getCurrentSelections())?void 0:n.map(e=>e.range);if(a&&a.length>0&&a.some(e=>i.some(t=>(0,m.Rectangle).intersects(t,e)))){let t={unitId:r,subUnitId:s,ranges:a},n=n_(e._injector,t);return{redos:[{id:nT.id,params:t}],undos:[{id:nU.id,params:n}]}}}}return{redos:[],undos:[]}}}),this._sheetInterceptorService.interceptRanges({getMutations:/* @__PURE__ */_(({unitId:e,subUnitId:t,ranges:n})=>{let r=[],o=[],s={redos:r,undos:o};if(!n||!n.length)return s;let i=eS(this._univerInstanceService,{unitId:e,subUnitId:t});if(!i)return s;let{worksheet:a}=i,l=a.getMergeData().filter(e=>n.some(t=>(0,m.Rectangle).intersects(e,t)));return l.length?(r.push({id:nT.id,params:{unitId:e,subUnitId:t,ranges:l}}),o.push({id:nU.id,params:{unitId:e,subUnitId:t,ranges:l}}),{undos:o,redos:r}):s},"getMutations")})}refRangeHandle(e,t,n){switch(e.id){case oX.MoveColsCommandId:{let r=e.params;return this._handleMoveColsCommand(r,t,n)}case oX.MoveRowsCommandId:{let r=e.params;return this._handleMoveRowsCommand(r,t,n)}case nt.id:{let r=e.params,o=r.unitId||t,s=r.subUnitId||n;return this._handleInsertRowCommand(r,o,s)}case ns.id:{let r=e.params,o=r.unitId||t,s=r.subUnitId||n;return this._handleInsertColCommand(r,o,s)}case ny.id:{let r=e.params;return this._handleRemoveColCommand(r,t,n)}case nS.id:{let r=e.params;return this._handleRemoveRowCommand(r,t,n)}case eG.id:{let r=e.params;return this._handleMoveRangeCommand(r,t,n)}case t9.id:{let r=e.params;return this._handleInsertRangeMoveRightCommand(r,t,n)}case t7.id:{let r=e.params;return this._handleInsertRangeMoveDownCommand(r,t,n)}case tZ.id:{let r=e.params;return this._handleDeleteRangeMoveUpCommand(r,t,n)}case tK.id:{let r=e.params;return this._handleDeleteRangeMoveLeftCommand(r,t,n)}}return{redos:[],undos:[]}}_onRefRangeChange(){let e=/* @__PURE__ */_((e,t)=>{let n=this._univerInstanceService.getUniverSheetInstance(e);if(!n)return;let r=null==n?void 0:n.getSheetBySheetId(t);if(!r)return;this.disposableCollection.dispose();let o=r.getMergeData(),s=/* @__PURE__ */_(n=>this.refRangeHandle(n,e,t),"handler");o.forEach(n=>{this.disposableCollection.add(this._refRangeService.registerRefRange(n,s,e,t))})},"registerRefRange");this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===rR.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(o,r)}if(t.id===nU.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(n.unitId,n.subUnitId)}}));let t=this._univerInstanceService.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(t){let n=t.getActiveSheet();if(!n)return;e(t.getUnitId(),n.getSheetId())}}_handleMoveRowsCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let s=[...o.getMergeData()],i={unitId:t,subUnitId:n,ranges:[]},a={unitId:t,subUnitId:n,ranges:[]},{fromRange:l}=e,{startRow:u,endRow:d}=l;if(s.forEach(t=>{if(u<=t.startRow&&d>=t.endRow){i.ranges.push(t);let n=sC(o5({id:oX.MoveRowsCommandId,params:e},t),t);n&&a.ranges.push(n)}}),0===i.ranges.length)return this._handleNull();let c=n_(this._injector,i),m=nM(this._injector,a);return{redos:[{id:nT.id,params:i},{id:nU.id,params:a}],undos:[{id:nT.id,params:m},{id:nU.id,params:c}]}}_handleMoveColsCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let s=[...o.getMergeData()],i={unitId:t,subUnitId:n,ranges:[]},a={unitId:t,subUnitId:n,ranges:[]},{fromRange:l}=e,{startColumn:u,endColumn:d}=l;if(s.forEach(t=>{if(u<=t.startColumn&&d>=t.endColumn){i.ranges.push(t);let n=sC(o6({id:oX.MoveColsCommandId,params:e},t),t);n&&a.ranges.push(n)}}),0===i.ranges.length)return this._handleNull();let c=n_(this._injector,i),m=nM(this._injector,a);return{redos:[{id:nT.id,params:i},{id:nU.id,params:a}],undos:[{id:nT.id,params:m},{id:nU.id,params:c}]}}_handleMoveRangeCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let s=o.getMergeData(),i=s.filter(t=>(0,m.Rectangle).intersects(t,e.fromRange)),a=s.filter(t=>(0,m.Rectangle).intersects(t,e.toRange)),l=sG(i.map(t=>(0,m.Rectangle).getRelativeRange(t,e.fromRange)).map(t=>(0,m.Rectangle).getPositionRange(t,e.toRange))).filter(e=>!s.some(t=>(0,m.Rectangle).equals(e,t)));return{redos:[{id:nT.id,params:{unitId:t,subUnitId:n,ranges:i}},{id:nT.id,params:{unitId:t,subUnitId:n,ranges:a}},{id:nU.id,params:{unitId:t,subUnitId:n,ranges:l}}],undos:[{id:nT.id,params:{unitId:t,subUnitId:n,ranges:l}},{id:nU.id,params:{unitId:t,subUnitId:n,ranges:a}},{id:nU.id,params:{unitId:t,subUnitId:n,ranges:i}}]}}_handleInsertRowCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let{range:s}=e,{startRow:i,endRow:a}=s,l=(0,m.Tools).deepClone(o.getMergeData()).reduce((e,t)=>(i>t.startRow&&i<=t.endRow&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,m.Tools).deepClone(o.getMergeData()).reduce((e,t)=>(i>t.startRow&&i<=t.endRow&&(t.endRow+=a-i+1,this._checkIsMergeCell(t)&&e.push(t)),e),[]),d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h);return{redos:[{id:nT.id,params:d},{id:nU.id,params:h}],undos:[{id:nT.id,params:g},{id:nU.id,params:c}]}}_handleInsertColCommand(e,t,n){let{range:r}=e,o=sY(this._univerInstanceService,t);if(!o)return this._handleNull();let s=sJ(o,n);if(!s)return this._handleNull();let{startColumn:i,endColumn:a}=r,l=(0,m.Tools).deepClone(s.getMergeData()).reduce((e,t)=>(i>t.startColumn&&i<=t.endColumn&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,m.Tools).deepClone(s.getMergeData()).reduce((e,t)=>(i>t.startColumn&&i<=t.endColumn&&(t.endColumn+=a-i+1,this._checkIsMergeCell(t)&&e.push(t)),e),[]),d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h);return{redos:[{id:nT.id,params:d},{id:nU.id,params:h}],undos:[{id:nT.id,params:g},{id:nU.id,params:c}]}}_handleRemoveColCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let{range:s}=e,{startColumn:i,endColumn:a}=s,l=(0,m.Tools).deepClone(o.getMergeData()).reduce((e,t)=>((0,m.Rectangle).intersects(s,t)&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,m.Tools).deepClone(o.getMergeData()).reduce((e,t)=>{if((0,m.Rectangle).intersects(s,t)){if(i<=t.startColumn&&a>=t.endColumn)return e;i>=t.startColumn&&a<=t.endColumn?t.endColumn-=a-i+1:i<t.startColumn?(t.startColumn=i,t.endColumn-=a-i+1):a>t.endColumn&&(t.endColumn=i-1),this._checkIsMergeCell(t)&&e.push(t)}return e},[]),d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h),p=[{id:nT.id,params:d}],I=[{id:nU.id,params:h}];return{preUndos:[{id:nT.id,params:g}],undos:[{id:nU.id,params:c}],preRedos:p,redos:I}}_handleRemoveRowCommand(e,t,n){let{range:r}=e,o=sY(this._univerInstanceService,t);if(!o)return this._handleNull();let s=sJ(o,n);if(!s)return this._handleNull();let{startRow:i,endRow:a}=r,l=(0,m.Tools).deepClone(s.getMergeData()).reduce((e,t)=>((0,m.Rectangle).intersects(r,t)&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,m.Tools).deepClone(s.getMergeData()).reduce((e,t)=>{if((0,m.Rectangle).intersects(r,t)){if(i<=t.startRow&&a>=t.endRow)return e;i>=t.startRow&&a<=t.endRow?t.endRow-=a-i+1:i<t.startRow?(t.startRow=i,t.endRow-=a-i+1):a>t.endRow&&(t.endRow=i-1),this._checkIsMergeCell(t)&&e.push(t)}return e},[]),d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h),p=[{id:nT.id,params:d}],I=[{id:nU.id,params:h}];return{preUndos:[{id:nT.id,params:g}],undos:[{id:nU.id,params:c}],preRedos:p,redos:I}}_handleInsertRangeMoveRightCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let s=e.range,i=o.getMaxColumns()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o}=s;if((0,m.Rectangle).intersects({startRow:t,startColumn:r,endRow:n,endColumn:i},e)&&(l.push(e),(0,m.Rectangle).contains({startRow:t,startColumn:r,endRow:n,endColumn:i},e))){let t=o-r+1;u.push({startRow:e.startRow,startColumn:e.startColumn+t,endRow:e.endRow,endColumn:e.endColumn+t})}});let d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h);return{redos:[{id:nT.id,params:d},{id:nU.id,params:h}],undos:[{id:nU.id,params:c},{id:nT.id,params:g}]}}_handleInsertRangeMoveDownCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let s=e.range,i=o.getMaxRows()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,startColumn:n,endColumn:r,endRow:o}=s;if((0,m.Rectangle).intersects({startRow:t,startColumn:n,endRow:i,endColumn:r},e)&&(l.push(e),(0,m.Rectangle).contains({startRow:t,startColumn:n,endRow:i,endColumn:r},e))){let n=o-t+1;u.push({startRow:e.startRow+n,startColumn:e.startColumn,endRow:e.endRow+n,endColumn:e.endColumn})}});let d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h);return{redos:[{id:nT.id,params:d},{id:nU.id,params:h}],undos:[{id:nU.id,params:c},{id:nT.id,params:g}]}}_handleDeleteRangeMoveUpCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let s=e.range,i=o.getMaxRows()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,startColumn:n,endColumn:r,endRow:o}=s;if((0,m.Rectangle).intersects({startRow:t,startColumn:n,endRow:i,endColumn:r},e)&&(l.push(e),(0,m.Rectangle).contains({startRow:t,startColumn:n,endRow:i,endColumn:r},e))){let n=o-t+1,r=(0,m.Rectangle).moveVertical(e,-n);u.push(r)}});let d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h);return{redos:[{id:nT.id,params:d},{id:nU.id,params:h}],undos:[{id:nU.id,params:c},{id:nT.id,params:g}]}}_handleDeleteRangeMoveLeftCommand(e,t,n){let r=sY(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sJ(r,n);if(!o)return this._handleNull();let s=e.range,i=o.getMaxColumns()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o}=s;if((0,m.Rectangle).intersects({startRow:t,startColumn:r,endRow:n,endColumn:i},e)&&(l.push(e),(0,m.Rectangle).contains({startRow:t,startColumn:r,endRow:n,endColumn:i},e))){let t=o-r+1;u.push({startRow:e.startRow,startColumn:e.startColumn-t,endRow:e.endRow,endColumn:e.endColumn-t})}});let d={unitId:t,subUnitId:n,ranges:l},c=n_(this._injector,d),h={unitId:t,subUnitId:n,ranges:u},g=nM(this._injector,h);return{redos:[{id:nT.id,params:d},{id:nU.id,params:h}],undos:[{id:nU.id,params:c},{id:nT.id,params:g}]}}_checkIsMergeCell(e){return!(e.startRow===e.endRow&&e.startColumn===e.endColumn)}_handleNull(){return{redos:[],undos:[]}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(sF.includes(e.id)){if(!e.params)return;let t=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let{sourceRange:r,targetRange:o}=e.params,s=r.startColumn===o.startColumn&&r.endColumn===o.endColumn,i=s?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,a=s?r.startRow:r.startColumn,l=s?o.startRow:o.startColumn,u=n.getConfig().mergeData,d=[];u.forEach(e=>{let{startRow:t,endRow:n,startColumn:o,endColumn:u,rangeType:c}=e;(0,m.Rectangle).intersects(e,r)||(s?a<t&&l>n?(t-=i,n-=i):a>n&&l<=t&&(t+=i,n+=i):a<o&&l>u?(o-=i,u-=i):a>u&&l<=o&&(o+=i,u+=i)),e.startRow===e.endRow&&e.startColumn===e.endColumn||d.push({startRow:t,endRow:n,startColumn:o,endColumn:u,rangeType:c})}),n.setMergeData(d),this.disposableCollection.dispose();let{unitId:c,subUnitId:h}=e.params,g=/* @__PURE__ */_(e=>this.refRangeHandle(e,c,h),"handler");d.forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,g,c,h))})}if(sH.includes(e.id)){let t=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let r=n.getConfig().mergeData,o=e.params;if(!o)return;let{range:s}=o,i=e.id.includes("row"),a=e.id.includes("insert"),l=i?s.startRow:s.startColumn,u=i?s.endRow:s.endColumn,d=u-l+1,c=[];r.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o,rangeType:s}=e;a?i?l<=t&&(t+=d,n+=d):l<=r&&(r+=d,o+=d):i?u<t&&(t-=d,n-=d):u<r&&(r-=d,o-=d),e.startRow===e.endRow&&e.startColumn===e.endColumn||c.push({startRow:t,endRow:n,startColumn:r,endColumn:o,rangeType:s})}),n.setMergeData(c),this.disposableCollection.dispose();let{unitId:m,subUnitId:h}=e.params,g=/* @__PURE__ */_(e=>this.refRangeHandle(e,m,h),"handler");c.forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,g,m,h))})}}))}},_(sX,"MergeCellController"),sX);function sY(e,t){return t?e.getUniverSheetInstance(t):e.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET)}function sJ(e,t){return t?e.getSheetBySheetId(t):e.getActiveSheet()}sz=sj([(0,m.OnLifecycle)(m.LifecycleStages.Steady,sz),sB(0,(0,m.Inject)(m.ICommandService)),sB(1,(0,m.Inject)(sO)),sB(2,(0,m.Inject)(m.IUniverInstanceService)),sB(3,(0,m.Inject)(m.Injector)),sB(4,(0,m.Inject)(G)),sB(5,(0,m.Inject)(D))],sz),_(sY,"getWorkbook"),_(sJ,"getWorksheet");var sK,sX,sZ,sQ=Object.defineProperty,s0=Object.getOwnPropertyDescriptor,s1=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?s0(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&sQ(t,n,s),s},"__decorateClass$7"),s2=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$7");let s5=(_(sZ=class extends m.Disposable{constructor(e,t,n){super(),this._resourceManagerService=e,this._univerInstanceService=t,this._logService=n}getValue(e,t,n,r){let o=this._univerInstanceService.getUniverSheetInstance(e);if(!o)return;let s=null==o?void 0:o.getSheetBySheetId(t);if(!s)return;let i=o.getStyles(),a=s.getCellRaw(n,r);if(null!=a&&a.s){let e=i.get(a.s);if(null!=e&&e.n)return e.n}return null}deleteValues(e,t,n){let r=this._univerInstanceService.getUniverSheetInstance(e);if(!r)return;let o=null==r?void 0:r.getSheetBySheetId(t);if(!o)return;let s=r.getStyles();n.forEach(e=>{(0,m.Range).foreach(e,(e,t)=>{let n=o.getCellRaw(e,t);if(!n)return;let r=null==n?void 0:n.s,i={...r&&s.get(r)||{}};delete i.n;let a=s.setValue(i);n.s=a})})}setValues(e,t,n){let r=this._univerInstanceService.getUniverSheetInstance(e);if(!r)return;let o=null==r?void 0:r.getSheetBySheetId(t);if(!o)return;let s=r.getStyles(),i=o.getCellMatrix();n.forEach(e=>{e.ranges.forEach(t=>{(0,m.Range).foreach(t,(t,n)=>{let r=o.getCellRaw(t,n);if(r){let t={...s.getStyleByCell(r)||{},n:{pattern:e.pattern}},n=s.setValue(t);r.s=n;let o=eo(r,e.pattern);void 0!==r.v&&(r.t=o,r.v=es(o,r))}else{let r={n:{pattern:e.pattern}},o=s.setValue(r);o&&i.setValue(t,n,{s:o})}})})})}},"NumfmtService"),sZ);s5=s1([s2(0,m.IResourceManagerService),s2(1,m.IUniverInstanceService),s2(2,m.ILogService)],s5);let s3=/* @__PURE__ */_(()=>[tR,tv,tI,tO,tA,tS,t$,tx,tM,tE,t_,tf,tD,ty,tV,tL,tj],"getAllWorkbookPermissionPoint"),s4=[eY.Edit,eY.Print,eY.Comment,eY.View,eY.Copy,eY.Export,eY.ManageCollaborator,eY.CreateSheet,eY.DeleteSheet,eY.RenameSheet,eY.HideSheet,eY.Duplicate,eY.Share,eY.MoveSheet,eY.CopySheet,eY.RecoverHistory,eY.ViewHistory];var s6,s7=Object.defineProperty,s8=Object.getOwnPropertyDescriptor,s9=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?s8(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&s7(t,n,s),s},"__decorateClass$6"),ie=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$6");let it=(s6=class extends m.Disposable{constructor(e,t,n){super(),this._permissionService=e,this._univerInstanceService=t,this._rangeProtectionRuleModel=n,this._init()}_init(){let e=/* @__PURE__ */_(e=>{let t=e.getUnitId();s3().forEach(e=>{let n=new e(t);this._permissionService.addPermissionPoint(n)})},"handleWorkbook");this._univerInstanceService.getAllUnitsForType(m.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(m.UniverInstanceType.UNIVER_SHEET).subscribe(t=>{e(t)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(m.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{let t=e.getUnitId();e.getSheets().forEach(e=>{let n=e.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(t,n).forEach(e=>{[tH,tG].forEach(r=>{let o=new r(t,n,e.permissionId);this._permissionService.deletePermissionPoint(o.id)})}),[...oc(),...om()].forEach(e=>{let r=new e(t,n);this._permissionService.deletePermissionPoint(r.id)})}),s3().forEach(e=>{let n=new e(t);this._permissionService.deletePermissionPoint(n.id)})}))}},_(s6,"WorkbookPermissionService"),s6);it=s9([(0,m.OnLifecycle)(m.LifecycleStages.Starting,it),ie(0,(0,m.Inject)(m.IPermissionService)),ie(1,(0,m.Inject)(m.IUniverInstanceService)),ie(2,(0,m.Inject)(od))],it);var ir=Object.defineProperty,io=Object.getOwnPropertyDescriptor,is=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?io(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&ir(t,n,s),s},"__decorateClass$5"),ii=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$5");let ia=(iu=class extends m.Disposable{constructor(e,t){super(),this._definedNamesService=e,this._resourceManagerService=t,this._initialize()}_initialize(){this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */_(e=>{let t=this._definedNamesService.getDefinedNameMap(e);return t?JSON.stringify(t):""},"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:"SHEET_DEFINED_NAME_PLUGIN",businesses:[m.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */_(t=>e(t),"toJson"),parseJson:/* @__PURE__ */_(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */_(e=>{this._definedNamesService.removeUnitDefinedName(e)},"onUnLoad"),onLoad:/* @__PURE__ */_((e,t)=>{this._definedNamesService.registerDefinedNames(e,t)},"onLoad")}))}},_(iu,"DefinedNameDataController"),iu);ia=is([(0,m.OnLifecycle)(m.LifecycleStages.Ready,ia),ii(0,h.IDefinedNamesService),ii(1,m.IResourceManagerService)],ia);let il=/* @__PURE__ */_(()=>[tG,tH],"getAllRangePermissionPoint");var iu,id,ic=Object.defineProperty,im=Object.getOwnPropertyDescriptor,ih=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?im(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&ic(t,n,s),s},"__decorateClass$4"),ig=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$4");let ip=(_(id=class{constructor(e,t){T(this,"_cache",new m.LRUMap(1e4)),this._selectionProtectionRuleModel=e,this._permissionService=t,this._init()}_init(){this._permissionService.permissionPointUpdate$.pipe((0,b.filter)(e=>e.type===eJ.SelectRange),(0,b.filter)(e=>il().some(t=>e instanceof t)),(0,I.map)(e=>e)).subscribe(e=>{for(let t of this._selectionProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId))t.permissionId===e.permissionId&&t.ranges.forEach(t=>{(0,m.Range).foreach(t,(t,n)=>{let r=this._createKey(e.unitId,e.subUnitId,t,n);this._cache.delete(r)})})}),this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{var t;e.rule.ranges.forEach(t=>{(0,m.Range).foreach(t,(t,n)=>{let r=this._createKey(e.unitId,e.subUnitId,t,n);this._cache.delete(r)})}),"set"===e.type&&(null==(t=e.oldRule)||t.ranges.forEach(t=>{(0,m.Range).foreach(t,(t,n)=>{let r=this._createKey(e.unitId,e.subUnitId,t,n);this._cache.delete(r)})}))})}_createKey(e,t,n,r){return`${e}_${t}_${n}_${r}`}getCellInfo(e,t,n,r){let o=this._createKey(e,t,n,r),s=this._cache.get(o);if(s)return s;let i=this._selectionProtectionRuleModel.getSubunitRuleList(e,t);if(!i||!i.length)return[];let a=[];for(let o of i)if(o.ranges.some(e=>e.startRow<=n&&e.endRow>=n&&e.startColumn<=r&&e.endColumn>=r)){let n=il().reduce((n,r)=>{var s;let i=new r(e,t,o.permissionId),a=this._permissionService.getPermissionPoint(i.id);return n[i.subType]=null!=(s=null==a?void 0:a.value)?s:i.value,n},{});a.push({...n,ruleId:o.id,ranges:o.ranges})}return this._cache.set(o,a),a}clear(){this._cache.clear()}},"RangeProtectionRenderModel"),id);ip=ih([(0,m.OnLifecycle)(m.LifecycleStages.Ready,ip),ig(0,(0,m.Inject)(od)),ig(1,(0,m.Inject)(m.IPermissionService))],ip);var iI=Object.defineProperty,iC=Object.getOwnPropertyDescriptor,iR=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?iC(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&iI(t,n,s),s},"__decorateClass$3"),iv=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$3");let iS=[t2.id,t0.id,t6.id,t3.id],iw=[nd.id,nm.id],iy=(iE=class extends m.Disposable{constructor(e,t,n,r,o){super(),T(this,"disposableCollection",new m.DisposableCollection),this._selectionProtectionRuleModel=e,this._univerInstanceService=t,this._commandService=n,this._refRangeService=r,this._selectionProtectionRenderModel=o,this._onRefRangeChange(),this._correctPermissionRange()}_onRefRangeChange(){let e=/* @__PURE__ */_((e,t)=>{let n=this._univerInstanceService.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!n||!(null==n?void 0:n.getSheetBySheetId(t)))return;this.disposableCollection.dispose();let r=/* @__PURE__ */_(n=>this.refRangeHandle(n,e,t),"handler");this._selectionProtectionRuleModel.getSubunitRuleList(e,t).reduce((e,t)=>[...e,...t.ranges],[]).forEach(n=>{this.disposableCollection.add(this._refRangeService.registerRefRange(n,r,e,t))})},"registerRefRange");this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===rR.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(o,r)}if(t.id===ok.id||t.id===o_.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(o,r)}}));let t=this._univerInstanceService.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(t){let n=t.getActiveSheet();if(!n)return;e(t.getUnitId(),n.getSheetId())}}refRangeHandle(e,t,n){switch(e.id){case nI.id:return this._getRefRangeMutationsByMoveRows(e.params,t,n);case nR.id:return this._getRefRangeMutationsByMoveCols(e.params,t,n);case nt.id:return this._getRefRangeMutationsByInsertRows(e.params,t,n);case ns.id:return this._getRefRangeMutationsByInsertCols(e.params,t,n);case ny.id:return this._getRefRangeMutationsByDeleteCols(e.params,t,n);case nS.id:return this._getRefRangeMutationsByDeleteRows(e.params,t,n)}return{redos:[],undos:[]}}_getRefRangeMutationsByDeleteCols(e,t,n){let r=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(t=>t.ranges.some(t=>(0,m.Rectangle).intersects(t,e.range))),o=e.range;if(r.length){let e=[],s=[];return r.forEach(r=>{let i=(0,m.Tools).deepClone(r),a=i.ranges.reduce((e,t)=>{if((0,m.Rectangle).intersects(t,o)){let n=(0,m.Tools).deepClone(t),{startColumn:r,endColumn:s}=o;if(r<=n.startColumn&&s>=n.endColumn)return e;r>=n.startColumn&&s<=n.endColumn?n.endColumn-=s-r+1:r<n.startColumn?(n.startColumn=r,n.endColumn-=s-r+1):s>n.endColumn&&(n.endColumn=r-1),this._checkIsRightRange(n)&&e.push(n)}return e},[]);i.ranges=a,i.ranges.length?(e.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:i,ruleId:r.id}}),s.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:r,ruleId:r.id}})):(e.push({id:oU.id,params:{unitId:t,subUnitId:n,ruleIds:[r.id]}}),s.push({id:o_.id,params:{unitId:t,subUnitId:n,name:"",rules:[r]}}))}),{redos:e,undos:s}}return{undos:[],redos:[]}}_getRefRangeMutationsByDeleteRows(e,t,n){let r=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(t=>t.ranges.some(t=>(0,m.Rectangle).intersects(t,e.range))),o=e.range;if(r.length){let e=[],s=[];return r.forEach(r=>{let i=(0,m.Tools).deepClone(r),a=i.ranges.reduce((e,t)=>{if((0,m.Rectangle).intersects(t,o)){let n=(0,m.Tools).deepClone(t),{startRow:r,endRow:s}=o;if(r<=n.startRow&&s>=n.endRow)return e;r>=n.startRow&&s<=n.endRow?n.endRow-=s-r+1:r<n.startRow?(n.startRow=r,n.endRow-=s-r+1):s>n.endRow&&(n.endRow=r-1),this._checkIsRightRange(n)&&e.push(n)}return e},[]);i.ranges=a,e.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:i,ruleId:r.id}}),s.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:r,ruleId:r.id}})}),{redos:e,undos:s}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertCols(e,t,n){let r=e.range.startColumn,o=e.range.endColumn-e.range.startColumn+1,s=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>r>e.startColumn&&r<=e.endColumn));if(s.length){let e=[],i=[];return s.forEach(s=>{let a=(0,m.Tools).deepClone(s),l=!1;a.ranges.forEach(e=>{r>e.startColumn&&r<=e.endColumn&&(e.endColumn+=o,l=!0)}),l&&(e.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:a,ruleId:s.id}}),i.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:s,ruleId:s.id}}))}),{redos:e,undos:i}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertRows(e,t,n){let r=e.range.startRow,o=e.range.endRow-e.range.startRow+1,s=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>r>e.startRow&&r<=e.endRow));if(s.length){let e=[],i=[];return s.forEach(s=>{let a=(0,m.Tools).deepClone(s),l=!1;a.ranges.forEach(e=>{r>e.startRow&&r<=e.endRow&&(e.endRow+=o,l=!0)}),l&&(e.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:a,ruleId:s.id}}),i.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:s,ruleId:s.id}}))}),{redos:e,undos:i}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveRows(e,t,n){let r=e.toRange,o=r.startRow,s=r.endRow-r.startRow+1,i=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>o>e.startRow&&o<=e.endRow));if(i.length){let r=[],a=[];return i.forEach(i=>{let l=(0,m.Tools).deepClone(i),u=e.fromRange.startRow,d=!1;l.ranges.forEach(e=>{o>e.startRow&&o<=e.endRow&&(u<e.startRow&&(e.startRow=e.startRow-s,e.endRow=e.endRow-s),e.endRow+=s,d=!0)}),d&&(r.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:l,ruleId:i.id}}),a.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:i,ruleId:i.id}}))}),{redos:r,undos:a}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveCols(e,t,n){let r=e.toRange,o=r.startColumn,s=r.endColumn-r.startColumn+1,i=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>o>e.startColumn&&o<=e.endColumn));if(i.length){let r=[],a=[];return i.forEach(i=>{let l=(0,m.Tools).deepClone(i),u=e.fromRange.startColumn,d=!1;l.ranges.forEach(e=>{o>e.startColumn&&o<=e.endColumn&&(u<e.startColumn&&(e.startColumn=e.startColumn-s,e.endColumn=e.endColumn-s),e.endColumn+=s,d=!0)}),d&&(r.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:l,ruleId:i.id}}),a.push({id:ok.id,params:{unitId:t,subUnitId:n,rule:i,ruleId:i.id}}))}),{redos:r,undos:a}}return{undos:[],redos:[]}}_correctPermissionRange(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(iw.includes(e.id)){if(!e.params)return;let t=this._univerInstanceService.getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let{sourceRange:r,targetRange:o}=e.params,s=r.startColumn===o.startColumn&&r.endColumn===o.endColumn,i=s?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,a=s?r.startRow:r.startColumn,l=s?o.startRow:o.startColumn;this._selectionProtectionRuleModel.getSubunitRuleList(t.getUnitId(),n.getSheetId()).forEach(e=>{e.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:o,endColumn:u}=e;(0,m.Rectangle).intersects(e,r)||(s?a<t&&l>n?(t-=i,n-=i):a>n&&l<=t&&(t+=i,n+=i):a<o&&l>u?(o-=i,u-=i):a>u&&l<=o&&(o+=i,u+=i)),this._checkIsRightRange({startRow:t,endRow:n,startColumn:o,endColumn:u})&&(e.startColumn=o,e.endColumn=u,e.startRow=t,e.endRow=n)})}),this.disposableCollection.dispose();let{unitId:u,subUnitId:d}=e.params,c=/* @__PURE__ */_(e=>this.refRangeHandle(e,u,d),"handler");this._selectionProtectionRuleModel.getSubunitRuleList(u,d).reduce((e,t)=>[...e,...t.ranges],[]).forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,c,u,d))}),this._selectionProtectionRenderModel.clear()}if(iS.includes(e.id)){let t=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let r=e.params;if(!r)return;let{range:o}=r,s=e.id.includes("row"),i=e.id.includes("insert"),a=s?o.startRow:o.startColumn,l=s?o.endRow:o.endColumn,u=l-a+1;this._selectionProtectionRuleModel.getSubunitRuleList(t.getUnitId(),n.getSheetId()).forEach(e=>{e.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o}=e;i?s?a<=t&&(t+=u,n+=u):a<=r&&(r+=u,o+=u):s?l<t&&(t-=u,n-=u):l<r&&(r-=u,o-=u),this._checkIsRightRange({startRow:t,endRow:n,startColumn:r,endColumn:o})&&(e.startColumn=r,e.endColumn=o,e.startRow=t,e.endRow=n)})}),this.disposableCollection.dispose();let{unitId:d,subUnitId:c}=e.params,m=/* @__PURE__ */_(e=>this.refRangeHandle(e,d,c),"handler");this._selectionProtectionRuleModel.getSubunitRuleList(d,c).reduce((e,t)=>[...e,...t.ranges],[]).forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,m,d,c))}),this._selectionProtectionRenderModel.clear()}}))}_checkIsRightRange(e){return e.startRow<=e.endRow&&e.startColumn<=e.endColumn}},_(iE,"RangeProtectionRefRangeService"),iE);iy=iR([(0,m.OnLifecycle)(m.LifecycleStages.Ready,iy),iv(0,(0,m.Inject)(od)),iv(1,(0,m.Inject)(m.IUniverInstanceService)),iv(2,m.ICommandService),iv(3,(0,m.Inject)(sO)),iv(4,(0,m.Inject)(ip))],iy);var ib=Object.defineProperty,iM=Object.getOwnPropertyDescriptor,iU=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?iM(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&ib(t,n,s),s},"__decorateClass$2"),i_=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$2");let iT=(ik=class extends m.Disposable{constructor(e,t,n){super(),this._selectionProtectionRuleModel=e,this._permissionService=t,this._resourceManagerService=n,this._initSnapshot(),this._initRuleChange()}_initRuleChange(){this.disposeWithMe(this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":il().forEach(t=>{let n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(n)});break;case"delete":il().forEach(t=>{let n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.deletePermissionPoint(n.id)});break;case"set":e.oldRule.permissionId!==e.rule.permissionId&&il().forEach(t=>{let n=new t(e.unitId,e.subUnitId,e.oldRule.permissionId);this._permissionService.deletePermissionPoint(n.id);let r=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(r)})}}))}_initSnapshot(){let e=/* @__PURE__ */_(e=>{let t=this._selectionProtectionRuleModel.toObject()[e];return t?JSON.stringify(t):""},"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:"SHEET_RANGE_PROTECTION_PLUGIN",businesses:[ez.UNIVER_SHEET],onLoad:/* @__PURE__ */_((e,t)=>{let n=this._selectionProtectionRuleModel.toObject();n[e]=t,this._selectionProtectionRuleModel.fromObject(n);let r=[];Object.keys(t).forEach(n=>{let o=t[n];this._selectionProtectionRuleModel.getSubunitRuleList(e,n).forEach(t=>{r.push({objectID:t.permissionId,unitID:e,objectType:eJ.SelectRange,actions:[eY.View,eY.Edit]})}),o.forEach(t=>{il().forEach(r=>{let o=new r(e,n,t.permissionId);o.value=!1,this._permissionService.addPermissionPoint(o)})})})},"onLoad"),onUnLoad:/* @__PURE__ */_(e=>{this._selectionProtectionRuleModel.deleteUnitModel(e)},"onUnLoad")}))}},_(ik,"RangeProtectionService"),ik);iT=iU([i_(0,(0,m.Inject)(od)),i_(1,(0,m.Inject)(m.IPermissionService)),i_(2,(0,m.Inject)(m.IResourceManagerService))],iT);var iE,ik,ix,iN=Object.defineProperty,iO=Object.getOwnPropertyDescriptor,iD=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?iO(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&iN(t,n,s),s},"__decorateClass$1"),iP=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$1");let iA=(ix=class extends m.Disposable{constructor(e){super(),this._sheetInterceptorService=e,this._initialize()}_initialize(){this._initInterceptorCellContent()}_initInterceptorCellContent(){this.disposeWithMe(this._sheetInterceptorService.intercept(W.CELL_CONTENT,{priority:11,handler:/* @__PURE__ */_((e,t,n)=>{var r;let o=t.workbook.getStyles().getStyleByCell(e);return n(null!=(r=null==o?void 0:o.n)&&r.pattern?{...e}:(null==e?void 0:e.t)===m.CellValueType.NUMBER&&"number"==typeof(null==e?void 0:e.v)?{...e,v:(0,h.stripErrorMargin)(e.v)}:{...e})},"handler")}))}},_(ix,"NumberCellDisplayController"),ix);iA=iD([(0,m.OnLifecycle)(m.LifecycleStages.Ready,iA),iP(0,(0,m.Inject)(G))],iA);let iV=(0,m.createIdentifier)("univer.exclusive-range-service"),iW=class extends m.Disposable{constructor(){super(...arguments),T(this,"_exclusiveRanges",/* @__PURE__ */new Map)}_ensureUnitMap(e){return this._exclusiveRanges.has(e)||this._exclusiveRanges.set(e,/* @__PURE__ */new Map),this._exclusiveRanges.get(e)}_ensureSubunitMap(e,t){let n=this._ensureUnitMap(e);return n.has(t)||n.set(t,/* @__PURE__ */new Map),n.get(t)}_ensureFeature(e,t,n){let r=this._ensureSubunitMap(e,t);return r.has(n)||r.set(n,[]),r.get(n)}addExclusiveRange(e,t,n,r){this._ensureFeature(e,t,n).push(...r)}getExclusiveRanges(e,t,n){var r,o;return null==(o=null==(r=this._exclusiveRanges.get(e))?void 0:r.get(t))?void 0:o.get(n)}clearExclusiveRanges(e,t,n){this._ensureFeature(e,t,n),this._exclusiveRanges.get(e).get(t).set(n,[])}clearExclusiveRangesByGroupId(e,t,n,r){let o=this.getExclusiveRanges(e,t,n);if(o){let s=o.filter(e=>e.groupId!==r);this._exclusiveRanges.get(e).get(t).set(n,s)}}getInterestGroupId(e){let t=[];return e.forEach(e=>{var n;let r=e.range,{unitId:o,sheetId:s}=r;if(!o||!s)return;let i=null==(n=this._exclusiveRanges.get(o))?void 0:n.get(s);if(i)for(let e of i.keys()){let n=i.get(e);if(n){for(let o of n)if((0,m.Rectangle).intersects(r,o.range)){t.push(e);break}}}}),t}};_(iW,"ExclusiveRangeService");let i$={};var iL=Object.defineProperty,ij=Object.getOwnPropertyDescriptor,iB=/* @__PURE__ */_((e,t,n)=>t in e?iL(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,"__defNormalProp"),iH=/* @__PURE__ */_((e,t,n,r)=>{for(var o,s=r>1?void 0:r?ij(t,n):t,i=e.length-1;i>=0;i--)(o=e[i])&&(s=(r?o(t,n,s):o(s))||s);return r&&s&&iL(t,n,s),s},"__decorateClass"),iF=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam"),iG=/* @__PURE__ */_((e,t,n)=>iB(e,"symbol"!=typeof t?t+"":t,n),"__publicField");let iq=(_(d=class extends m.Plugin{constructor(e=i$,t,n){super(),this._config=e,this._injector=t,this._configService=n;let{...r}=this._config;this._configService.setConfig("sheets.config",r),this._initConfig(),this._initDependencies(t)}onRendered(){}_initConfig(){var e;null!=(e=this._config)&&e.onlyRegisterFormulaRelatedMutations&&this._configService.setConfig(oV,!0)}_initDependencies(e){var t,n;let r=[[nN],[D],[sO],[it],[rY,{useClass:s5}],[G],[oF],[sz],[iA],[ia],[oy],[on],[oR],[ip],[od],[iy],[iT],[iV,{useClass:iW,deps:[D]}]];null!=(t=this._config)&&t.notExecuteFormula||r.push([oK]),(0,m.mergeOverrideWithDependencies)(r,null==(n=this._config)?void 0:n.override).forEach(t=>{e.add(t)}),this._injector.get(G),this._injector.get(iT),this._injector.get(iV)}},"UniverSheetsPlugin"),d);iG(iq,"pluginName","SHEET_PLUGIN"),iG(iq,"type",m.UniverInstanceType.UNIVER_SHEET),iq=iH([(0,m.DependentOn)(h.UniverFormulaEnginePlugin),iF(1,(0,m.Inject)(m.Injector)),iF(2,m.IConfigService)],iq);let iz=[rP.id,rA.id,rV.id,rv.id,rC.id,nd.id,nm.id,nL.id,nB.id,n2.id,n0.id,t2.id,t0.id,t6.id,t3.id],iY=[eu.id,e_.id,nT.id,nU.id,oO.id],iJ=1.5,iK="rgba(255, 255, 255, 0.01)";function iX(e){let t=e.getCurrentTheme(),n=new(0,m.ColorKit)(t.primaryColor).setAlpha(.07).toRgbString();return{strokeWidth:1,stroke:t.primaryColor,fill:n,widgets:{},widgetSize:6,widgetStrokeWidth:1,widgetStroke:t.colorWhite,hasAutoFill:!0,AutofillSize:6,AutofillStrokeWidth:1,AutofillStroke:t.colorWhite,hasRowHeader:!0,rowHeaderFill:n,rowHeaderStroke:t.primaryColor,rowHeaderStrokeWidth:1,hasColumnHeader:!0,columnHeaderFill:n,columnHeaderStroke:t.primaryColor,columnHeaderStrokeWidth:1,expandCornerSize:40}}function iZ(e){let{rangeWithCoord:t,primaryWithCoord:n,style:r}=e,o={range:{startRow:t.startRow,startColumn:t.startColumn,endRow:t.endRow,endColumn:t.endColumn,rangeType:t.rangeType,unitId:t.unitId,sheetId:t.sheetId},primary:null,style:r};return null!=n&&(o.primary=iQ(n)),o}function iQ(e){let{actualRow:t,actualColumn:n,isMerged:r,isMergedMainCell:o}=e,{startRow:s,startColumn:i,endRow:a,endColumn:l}=e.mergeInfo;return{actualRow:t,actualColumn:n,isMerged:r,isMergedMainCell:o,startRow:s,startColumn:i,endRow:a,endColumn:l}}function i0(e,t,n){let r=(0,m.getCellInfoInMergeData)(e,t,n),o=(0,m.makeCellRangeToRangeData)(r);if(o)return{range:o,primary:r,style:null}}_(iX,"getNormalSelectionStyle"),_(iZ,"convertSelectionDataToRange"),_(iQ,"convertPrimaryWithCoordToPrimary"),_(i0,"transformCellDataToSelectionData");let i1=/* @__PURE__ */_((e,t,n)=>{let r=e.get(D).getCurrentSelections(),{value:o,selections:s,unitId:i,subUnitId:a}=t;if(r){let e=r[(null==r?void 0:r.length)-1].primary;if(e){let{actualColumn:t,actualRow:l}=e,{startRow:u,startColumn:d,endRow:c,endColumn:h}=s[s.length-1];if(o===m.Dimension.COLUMNS){let e=n.find(e=>e.startColumn===t&&e.endColumn===t&&l===e.startRow);e&&(h=e.endColumn,u=e.startRow,c=e.endRow)}else if(o===m.Dimension.ROWS){let e=n.find(e=>e.startRow===l&&e.endRow===l&&t===e.startColumn);e&&(c=e.endRow,d=e.startColumn,h=e.endColumn)}let g={startRow:u,startColumn:d,endRow:c,endColumn:h,actualRow:l,actualColumn:t,isMerged:!0,isMergedMainCell:u===l&&d===t},p=r.map((e,t,n)=>({range:e.range,style:null,primary:t===n.length-1?g:null}));return{id:eP.id,params:{unitId:i,subUnitId:a,selections:p}}}}return null},"AddMergeRedoSelectionsOperationFactory"),i2=/* @__PURE__ */_((e,t)=>{let n=e.get(D).getCurrentSelections(),{unitId:r,subUnitId:o}=t;if(n&&n[(null==n?void 0:n.length)-1].primary){let e={unitId:r,subUnitId:o,selections:[...n]};return{id:eP.id,params:e}}return null},"AddMergeUndoSelectionsOperationFactory");function i5(e){return null!=e&&(void 0!==e.v&&null!==e.v&&""!==e.v||void 0!==e.p)}function i3(e,t){return e&&e.spanAnchor?i5(t.getValue(e.spanAnchor.startRow,e.spanAnchor.startColumn)):i5(e)}function i4(e,t,n,r,o){let s=e.getCellMatrix(),i=e.getSpanModel().getMergedCellRange(t,n,r,o),a=new m.ObjectMatrix;return s.forValue((e,t)=>{let n=s.getValue(e,t);n&&a.setValue(e,t,n)}),i.forEach(e=>{let{startColumn:t,startRow:n,endColumn:r,endRow:o}=e;(0,m.createRowColIter)(n,o,t,r).forEach((e,i)=>{e===n&&i===t&&a.setValue(e,i,{...s.getValue(e,i),spanAnchor:{startRow:n,endRow:o,startColumn:t,endColumn:r}}),(e!==n||i!==t)&&(a.realDeleteValue(e,i),a.setValue(e,i,{spanAnchor:{startRow:n,endRow:o,startColumn:t,endColumn:r}}))})}),a}function i6(e,t,n,r){let{startRow:o,startColumn:s,endRow:i}=e,a=null,l=!1;for(let e=o;e<=i;e++){let o=t.getValue(e,s-n);if(l=l||i3(o,t),!r&&l)break;o&&o.spanAnchor&&(a=a?{startRow:Math.min(o.spanAnchor.startRow,a.startRow),startColumn:Math.min(o.spanAnchor.startColumn,a.startColumn),endRow:Math.max(o.spanAnchor.endRow,a.endRow),endColumn:Math.max(o.spanAnchor.endColumn,a.endColumn)}:{startRow:o.spanAnchor.startRow,startColumn:o.spanAnchor.startColumn,endRow:o.spanAnchor.endRow,endColumn:o.spanAnchor.endColumn})}return l?(e.startColumn=e.startColumn-n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function i7(e,t,n,r){let{startRow:o,endColumn:s,endRow:i}=e,a=null,l=!1;for(let e=o;e<=i;e++){let o=t.getValue(e,s+n);if(l=l||i3(o,t),!r&&l)break;o&&o.spanAnchor&&(a=a?{startRow:Math.min(o.spanAnchor.startRow,a.startRow),startColumn:Math.min(o.spanAnchor.startColumn,a.startColumn),endRow:Math.max(o.spanAnchor.endRow,a.endRow),endColumn:Math.max(o.spanAnchor.endColumn,a.endColumn)}:{startRow:o.spanAnchor.startRow,startColumn:o.spanAnchor.startColumn,endRow:o.spanAnchor.endRow,endColumn:o.spanAnchor.endColumn})}return l?(e.endColumn=e.endColumn+n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function i8(e,t,n,r){let{startRow:o,startColumn:s,endColumn:i}=e,a=null,l=!1;for(let e=s;e<=i;e++){let s=t.getValue(o-n,e);if(l=l||i3(s,t),!r&&l)break;s&&s.spanAnchor&&(a=a?{startRow:Math.min(s.spanAnchor.startRow,a.startRow),startColumn:Math.min(s.spanAnchor.startColumn,a.startColumn),endRow:Math.max(s.spanAnchor.endRow,a.endRow),endColumn:Math.max(s.spanAnchor.endColumn,a.endColumn)}:{startRow:s.spanAnchor.startRow,startColumn:s.spanAnchor.startColumn,endRow:s.spanAnchor.endRow,endColumn:s.spanAnchor.endColumn})}return l?(e.startRow=e.startRow-n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function i9(e,t,n,r){let{startColumn:o,endColumn:s,endRow:i}=e,a=null,l=!1;for(let e=o;e<=s;e++){let o=t.getValue(i+n,e);if(l=l||i3(o,t),!r&&l)break;o&&o.spanAnchor&&(a=a?{startRow:Math.min(o.spanAnchor.startRow,a.startRow),startColumn:Math.min(o.spanAnchor.startColumn,a.startColumn),endRow:Math.max(o.spanAnchor.endRow,a.endRow),endColumn:Math.max(o.spanAnchor.endColumn,a.endColumn)}:{startRow:o.spanAnchor.startRow,startColumn:o.spanAnchor.startColumn,endRow:o.spanAnchor.endRow,endColumn:o.spanAnchor.endColumn})}return l?(e.endRow=e.endRow+n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function ae(e,t,n){let r=n.getMaxRows(),o=n.getMaxColumns(),s=i4(n,0,0,r-1,o-1),i=n.getSnapshot().mergeData.length>0,{left:a,right:l,up:u,down:d}=t,c=!0,h={...e},g=[];for(;c;){if(c=!1,u&&0!==h.startRow){let{hasValue:e,range:t,spanAnchor:n}=i8(h,s,1,i);if(n&&g.push(n),e){h=t,c=!0;continue}}if(d&&h.endRow!==r-1){let{hasValue:e,range:t,spanAnchor:n}=i9(h,s,1,i);if(n&&g.push(n),e){h=t,c=!0;continue}}if(a&&0!==h.startColumn){let{hasValue:e,range:t,spanAnchor:n}=i6(h,s,1,i);if(n&&g.push(n),e){h=t,c=!0;continue}}if(l&&h.endColumn!==o-1){let{hasValue:e,range:t,spanAnchor:n}=i7(h,s,1,i);if(n&&g.push(n),e){h=t,c=!0;continue}}}return g.length>0&&(h=(0,m.Rectangle).union(h,...g)),h}_(i5,"cellHasValue"),_(i3,"hasValueFromMatrixWithSpanInfo"),_(i4,"getMatrixWithSpanInfo"),_(i6,"getExpandedRangeLeft"),_(i7,"getExpandedRangeRight"),_(i8,"getExpandedRangeUp"),_(i9,"getExpandedRangeDown"),_(ae,"expandToContinuousRange");let at=/* @__PURE__ */_((e,t,n,r)=>{let o=e.get(m.IPermissionService),s=e.get(od),i=o.getPermissionPoint(new tR(t).id);if(!(null!=i&&i.value))return!1;let a=o.getPermissionPoint(new tg(t,n).id);if(!(null!=a&&a.value))return!1;let l=s.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>r.some(t=>(0,m.Rectangle).intersects(e,t))));return!l.length||l.every(e=>{let r=e.permissionId,s=o.getPermissionPoint(new tH(t,n,r).id);return!!(null!=s&&s.value)})},"checkRangesEditablePermission");function an(e,t){return t.some(t=>ar(e,t))}function ar(e,t){let{startRow:n,startColumn:r,endColumn:o,endRow:s}=t,i=e.getMatrixWithMergedCells(n,r,s,o),a=!1;return i.forValue((t,o,s)=>{if(s&&(t!==n||o!==r)&&e.cellHasValue(s))return a=!0,!1}),a}function ao(e,t,n,r){let o=[],s=[],i=n.getSheetId();return r.forEach(r=>{let a={unitId:t,subUnitId:i,cellValue:as(n,r).getData()},l=el(e,a);o.push({id:eu.id,params:l}),s.push({id:eu.id,params:a})}),{undos:o,redos:s}}function as(e,t){let{startRow:n,startColumn:r,endColumn:o,endRow:s}=t,i=e.getMatrixWithMergedCells(n,r,s,o,!0),a=new m.ObjectMatrix;return i.forValue((e,t,o)=>{o&&(e!==n||t!==r)&&a.setValue(e,t,null)}),a}_(an,"checkCellContentInRanges"),_(ar,"checkCellContentInRange"),_(ao,"getClearContentMutationParamsForRanges"),_(as,"getClearContentMutationParamForRange");let ai={type:m.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(m.ICommandService),r=e.get(m.IUndoRedoService),o=e.get(m.IUniverInstanceService),s=t.unitId,i=t.subUnitId,a=sG(t.selections,t.value),l=o.getUniverSheetInstance(s).getSheetBySheetId(i),u=[],d=[],c=an(l,a),h={unitId:s,subUnitId:i,ranges:a},g={unitId:s,subUnitId:i,ranges:a};u.push({id:nT.id,params:h}),u.push({id:nU.id,params:g});let p=n_(e,h),I=nM(e,g);if(d.push({id:nT.id,params:I}),d.push({id:nU.id,params:p}),c){let t=ao(e,s,l,a);u.unshift(...t.redos),d.push(...t.undos)}return!!(0,m.sequenceExecute)(u,n).result&&(r.pushUndoRedo({unitID:s,undoMutations:d,redoMutations:u}),!0)},"handler")},aa={type:m.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-all",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(m.ICommandService),r=null==(t=e.get(D).getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=r&&r.length))return!1;let o=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let s=o.getActiveSheet();if(!s)return!1;let i=o.getUnitId(),a=s.getSheetId();return n.executeCommand(ai.id,{selections:r,unitId:i,subUnitId:a})},"handler")},al={type:m.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-vertical",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(m.ICommandService),r=null==(t=e.get(D).getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=r&&r.length))return!1;let o=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let s=o.getActiveSheet();if(!s)return!1;let i=o.getUnitId(),a=s.getSheetId();return n.executeCommand(ai.id,{value:m.Dimension.COLUMNS,selections:r,unitId:i,subUnitId:a})},"handler")},au={type:m.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-horizontal",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(m.ICommandService),r=null==(t=e.get(D).getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=r&&r.length))return!1;let o=e.get(m.IUniverInstanceService).getCurrentUnitForType(m.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let s=o.getActiveSheet();if(!s)return!1;let i=o.getUnitId(),a=s.getSheetId();return n.executeCommand(ai.id,{value:m.Dimension.ROWS,selections:r,unitId:i,subUnitId:a})},"handler")};async function ad(e,t,n,r){let o=eS(e.get(m.IUniverInstanceService),{unitId:t,subUnitId:n});if(!o)return;let{worksheet:s}=o;if(s.getMergeData().some(e=>r.some(t=>(0,m.Rectangle).intersects(t,e))))throw Error("The ranges to be merged overlap with the existing merged cells");await e.get(m.ICommandService).executeCommand(ai.id,{unitId:t,subUnitId:n,selections:r})}_(ad,"addMergeCellsUtil");let ac=/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().showGridlines;return{...(0,m.Tools).deepClone(t),hideGridlines:n}},"SetHideGridlinesUndoMutationFactory"),am={id:"sheet.mutation.set-hide-gridlines",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().showGridlines=t.hideGridlines,!0)},"handler")},ah=(m.CommandType.COMMAND,/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().rightToLeft;return{...(0,m.Tools).deepClone(t),rightToLeft:n}},"SetWorksheetRightToLeftUndoMutationFactory")),ag={id:"sheet.mutation.set-worksheet-right-to-left",type:m.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(m.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().rightToLeft=t.rightToLeft,!0)},"handler")};m.CommandType.COMMAND,/* @__PURE__ */async(e,t)=>{var n;let r=e.get(m.ICommandService),o=e.get(m.IUndoRedoService),s=eS(e.get(m.IUniverInstanceService),t);if(!s)return!1;let{unitId:i,subUnitId:a}=s,l=m.BooleanNumber.FALSE;t&&(l=null!=(n=t.rightToLeft)?n:m.BooleanNumber.FALSE);let u={rightToLeft:l,unitId:i,subUnitId:a},d=ah(e,u);return!!r.syncExecuteCommand(ag.id,u)&&(o.pushUndoRedo({unitID:i,undoMutations:[{id:ag.id,params:d}],redoMutations:[{id:ag.id,params:u}]}),!0)}}),n("23cfA",function(n,r){e(n.exports,"switchMap",function(){return a});var o=t("b7gpN"),s=t("jSzwf"),i=t("iNetn");function a(e,t){return(0,s.operate)(function(n,r){var s=null,a=0,l=!1,u=function(){return l&&!s&&r.complete()};n.subscribe((0,i.createOperatorSubscriber)(r,function(n){null==s||s.unsubscribe();var l=0,d=a++;(0,o.innerFrom)(e(n,d)).subscribe(s=(0,i.createOperatorSubscriber)(r,function(e){return r.next(t?t(n,e,d,l++):e)},function(){s=null,u()}))},function(){l=!0,u()}))})}}),n("2BOVU",function(t,n){e(t.exports,"DEFAULT_TEXT_FORMAT",function(){return r});let r="@@@"});
//# sourceMappingURL=es.9d442354.js.map
