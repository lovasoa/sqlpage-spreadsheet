!function(){function e(e,t,r,n){Object.defineProperty(e,t,{get:r,set:n,enumerable:!0,configurable:!0})}function t(e){return e&&e.__esModule?e.default:e}var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n=r.parcelRequire26fc,i=n.register;i("9WggK",function(t,r){e(t.exports,"FUniver",function(){return e7});var i=n("83KcA"),a=n("kkAWv"),o=n("D79YY"),s=n("hJKDz"),l=n("iCLKQ"),d=n("kqxPe"),u=n("11kpD"),c=n("cahIb"),h=n("70MC3"),m=n("a9FIH"),p=n("bnDm9"),g=n("GkhY6"),p=n("bnDm9"),f=n("ls2nu"),v=n("vzesf"),_=n("cXi9L"),I=n("2I3H8"),S=n("61xGp");n("g2lyD");var C,y=n("83o4E"),b=n("idZOd"),w=n("dUpWs"),y=n("83o4E"),R=n("inPpN"),E=Object.defineProperty,T=(e,t,r)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,M=(e,t)=>E(e,"name",{value:t,configurable:!0}),O=(e,t,r)=>T(e,"symbol"!=typeof t?t+"":t,r),D=Object.defineProperty,U=Object.getOwnPropertyDescriptor,P=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?U(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&D(t,r,a),a},"__decorateClass$b"),k=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$b");let N=(M(C=class{constructor(e,t,r,n,i,a){O(this,"id"),this._documentDataModel=e,this._injector=t,this._univerInstanceService=r,this._commandService=n,this._resourceManagerService=i,this._renderManagerService=a,this.id=this._documentDataModel.getUnitId()}getId(){return this._documentDataModel.getUnitId()}getName(){return this.getSnapshot().title||""}getSnapshot(){let e=this._resourceManagerService.getResourcesByType(this.id,i.UniverInstanceType.UNIVER_DOC),t=this._documentDataModel.getSnapshot();return t.resources=e,t}undo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.UndoCommand.id)}redo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.RedoCommand.id)}appendText(e){let t=this.id,{body:r}=this.getSnapshot();if(!r)throw Error("The document body is empty");let n=r.dataStream.length-2,i={startOffset:n,endOffset:n,collapsed:!0,segmentId:""},{segmentId:a}=i;return this._commandService.executeCommand(h.InsertCommand.id,{unitId:t,body:{dataStream:e},range:i,segmentId:a})}setSelection(e,t){var r;let n=null==(r=this._renderManagerService.getRenderById(this.getId()))?void 0:r.with(h.DocSelectionRenderService);null==n||n.removeAllRanges(),null==n||n.addDocRanges([{startOffset:e,endOffset:t,rangeType:i.DOC_RANGE_TYPE.TEXT}],!0)}},"FDocument"),C);N=P([k(1,(0,i.Inject)(i.Injector)),k(2,i.IUniverInstanceService),k(3,i.ICommandService),k(4,i.IResourceManagerService),k(5,o.IRenderManagerService)],N);let A={onBeforeCopy(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{t.id===c.CopyCommand.id&&e()})},onCopy(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{t.id===c.CopyCommand.id&&e()})},onBeforePaste(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{t.id===c.PasteCommand.id&&e()})},onPaste(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{t.id===c.PasteCommand.id&&e()})}},x={beforeUndo(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{if(t.id===i.UndoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopUndoElement();t&&e(t)}})},afterUndo(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{if(t.id===i.UndoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopUndoElement();t&&e(t)}})},beforeRedo(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{if(t.id===i.RedoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopRedoElement();t&&e(t)}})},afterRedo(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{if(t.id===i.RedoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopRedoElement();t&&e(t)}})}};var L,V=Object.defineProperty,F=Object.getOwnPropertyDescriptor,j=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?F(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&V(t,r,a),a},"__decorateClass$a"),H=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$a");let $=(M(L=class{constructor(e,t){O(this,"onBeforeUndo",x.beforeUndo.bind(this)),O(this,"onUndo",x.afterUndo.bind(this)),O(this,"onBeforeRedo",x.beforeRedo.bind(this)),O(this,"onRedo",x.afterRedo.bind(this)),O(this,"onBeforeCopy",A.onBeforeCopy.bind(this)),O(this,"onCopy",A.onCopy.bind(this)),O(this,"onBeforePaste",A.onBeforePaste.bind(this)),O(this,"onPaste",A.onPaste.bind(this)),this._injector=e,this._lifecycleService=t}onStarting(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,m.filter)(e=>e===i.LifecycleStages.Starting)).subscribe(e))}onReady(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,m.filter)(e=>e===i.LifecycleStages.Ready)).subscribe(e))}onRendered(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,m.filter)(e=>e===i.LifecycleStages.Rendered)).subscribe(e))}onSteady(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,m.filter)(e=>e===i.LifecycleStages.Steady)).subscribe(e))}},"FHooks"),L);$=j([H(0,(0,i.Inject)(i.Injector)),H(1,(0,i.Inject)(i.LifecycleService))],$);var B,W=Object.defineProperty,G=Object.getOwnPropertyDescriptor,Y=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?G(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&W(t,r,a),a},"__decorateClass$9"),z=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let K=(M(B=class{constructor(e,t,r,n,i){this._workbook=e,this._worksheet=t,this._filterModel=r,this._injector=n,this._commandSrv=i}getFilteredOutRows(){return Array.from(this._filterModel.filteredOutRows).sort()}getColumnFilterCriteria(e){var t;return null==(t=this._filterModel.getFilterColumn(e))?void 0:t.getColumnData()}removeColumnFilterCriteria(e){return this._commandSrv.executeCommand(_.SetSheetsFilterCriteriaCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),col:e,criteria:null})}setColumnFilterCriteria(e,t){return this._commandSrv.executeCommand(_.SetSheetsFilterCriteriaCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),col:e,criteria:t})}getRange(){let e=this._filterModel.getRange();return this._injector.createInstance(ev,this._workbook,this._worksheet,e)}removeFilterCriteria(){return this._commandSrv.executeCommand(_.ClearSheetsFilterCriteriaCommand.id)}remove(){return this._commandSrv.executeCommand(_.RemoveSheetFilterCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId()})}},"FFilter"),B);K=Y([z(3,(0,i.Inject)(i.Injector)),z(4,i.ICommandService)],K);var q,X=Object.defineProperty,Z=Object.getOwnPropertyDescriptor,Q=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&X(t,r,a),a},"__decorateClass$8"),J=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");let ee=(M(q=class{constructor(e,t,r,n,i,a){this._thread=e,this._parent=t,this._injector=r,this._commandService=n,this._univerInstanceService=i,this._threadCommentModel=a}_getRef(){var e;let t=(null==(e=this._parent)?void 0:e.ref)||this._thread.ref;return(0,a.deserializeRangeWithSheet)(t).range}getIsRoot(){return!this._parent}getCommentData(){let{children:e,...t}=this._thread;return t}getReplies(){var e;let t=this._getRef(),r=this._threadCommentModel.getCommentWithChildren(this._thread.unitId,this._thread.subUnitId,t.startRow,t.startColumn);return null==(e=null==r?void 0:r.children)?void 0:e.map(e=>this._injector.createInstance(ee,e))}getRange(){let e=this._univerInstanceService.getUnit(this._thread.unitId,i.UniverInstanceType.UNIVER_SHEET);if(!e)return null;let t=e.getSheetBySheetId(this._thread.subUnitId);if(!t)return null;let r=this._getRef();return this._injector.createInstance(ev,e,t,r)}getContent(){return this._thread.text}delete(){return this._commandService.executeCommand(this.getIsRoot()?y.DeleteCommentTreeCommand.id:y.DeleteCommentCommand.id,{commentId:this._thread.id,unitId:this._thread.unitId,subUnitId:this._thread.subUnitId})}async update(e){let t=(0,w.getDT)();return await this._commandService.executeCommand(y.UpdateCommentCommand.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,payload:{commentId:this._thread.id,text:e,updated:!0,updateT:t}})}resolve(e){return this._commandService.executeCommand(y.ResolveCommentCommand.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,commentId:this._thread.id,resolved:null!=e?e:!this._thread.resolved})}},"FThreadComment"),q);function et(e){switch(e){case"left":return i.HorizontalAlign.LEFT;case"center":return i.HorizontalAlign.CENTER;case"normal":return i.HorizontalAlign.RIGHT;default:throw Error(`Invalid horizontal alignment: ${e}`)}}function er(e){switch(e){case i.HorizontalAlign.LEFT:return"left";case i.HorizontalAlign.CENTER:return"center";case i.HorizontalAlign.RIGHT:return"normal";default:throw Error(`Invalid horizontal alignment: ${e}`)}}function en(e){switch(e){case"top":return i.VerticalAlign.TOP;case"middle":return i.VerticalAlign.MIDDLE;case"bottom":return i.VerticalAlign.BOTTOM;default:throw Error(`Invalid vertical alignment: ${e}`)}}function ei(e){switch(e){case i.VerticalAlign.TOP:return"top";case i.VerticalAlign.MIDDLE:return"middle";case i.VerticalAlign.BOTTOM:return"bottom";default:throw Error(`Invalid vertical alignment: ${e}`)}}function ea(e){return(0,i.isFormulaString)(e)?{f:e}:(0,i.isCellV)(e)?{v:e}:((0,i.isICellData)(e),e)}function eo(e,t){let r=new i.ObjectMatrix,{startRow:n,startColumn:a,endRow:o,endColumn:s}=t;if((0,i.Tools).isArray(e))for(let t=0;t<=o-n;t++)for(let i=0;i<=s-a;i++)r.setValue(t+n,i+a,ea(e[t][i]));else new(0,i.ObjectMatrix)(e).forValue((e,t,n)=>{r.setValue(e,t,ea(n))});return r.getMatrix()}function es(e,t){return!!el(e,t)&&(t.startColumn!==t.endColumn||t.startRow!==t.endRow)}function el(e,t){return e.startColumn===t.startColumn&&e.endColumn===t.endColumn&&e.startRow===t.startRow&&e.endRow===t.endRow}function ed(e,t){let r;let{componentKey:n,isVue3:a}=e,o=new i.DisposableCollection;return"string"==typeof n?r=n:(r=`External_${(0,i.generateRandomId)(6)}`,o.add(t.register(r,n,{framework:a?"vue3":"react"}))),{key:r,disposableCollection:o}}function eu(e,t){return{startRow:e.startRow,endRow:e.endRow,startColumn:0,endColumn:t.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW}}function ec(e,t){return{startRow:0,endRow:t.getRowCount()-1,startColumn:e.startColumn,endColumn:e.endColumn,rangeType:i.RANGE_TYPE.COLUMN}}ee=Q([J(2,(0,i.Inject)(i.Injector)),J(3,i.ICommandService),J(4,i.IUniverInstanceService),J(5,(0,i.Inject)(b.SheetsThreadCommentModel))],ee),M(et,"transformFacadeHorizontalAlignment"),M(er,"transformCoreHorizontalAlignment"),M(en,"transformFacadeVerticalAlignment"),M(ei,"transformCoreVerticalAlignment"),M(ea,"covertCellValue"),M(eo,"covertCellValues"),M(es,"isCellMerged"),M(el,"isSingleCell"),M(ed,"transformComponentKey"),M(eu,"covertToRowRange"),M(ec,"covertToColRange");var eh,em=Object.defineProperty,ep=Object.getOwnPropertyDescriptor,eg=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ep(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&em(t,r,a),a},"__decorateClass$7"),ef=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let ev=(eh=class{constructor(e,t,r,n,i,a,o){this._workbook=e,this._worksheet=t,this._range=r,this._injector=n,this._commandService=i,this._renderManagerService=a,this._formulaDataModel=o}getUnitId(){return this._workbook.getUnitId()}getSheetName(){return this._worksheet.getName()}getRange(){return this._range}getRow(){return this._range.startRow}getColumn(){return this._range.startColumn}getWidth(){return this._range.endColumn-this._range.startColumn+1}getHeight(){return this._range.endRow-this._range.startRow+1}getCellData(){var e;return null!=(e=this._worksheet.getCell(this._range.startRow,this._range.startColumn))?e:null}getCell(){let e=this._workbook.getUnitId(),t=this._worksheet.getSheetId();return this._renderManagerService.getRenderById(e).with(u.SheetSkeletonManagerService).getWorksheetSkeleton(t).skeleton.getCellByIndex(this._range.startRow,this._range.startColumn)}isMerged(){return es(this.getCell().mergeInfo,this._range)}getCellRect(){let{startX:e,startY:t,endX:r,endY:n}=this.getCell(),i={x:e,y:t,width:r-e,height:n-t,top:t,left:e,bottom:n,right:r};return{...i,toJSON:/* @__PURE__ */M(()=>JSON.stringify(i),"toJSON")}}getCellStyleData(){var e;let t=this.getCellData(),r=this._workbook.getStyles();return t&&r&&null!=(e=r.getStyleByCell(t))?e:null}getValue(){var e,t;return null!=(t=null==(e=this._worksheet.getCell(this._range.startRow,this._range.startColumn))?void 0:e.v)?t:null}getValues(){var e,t;let{startRow:r,endRow:n,startColumn:i,endColumn:a}=this._range,o=[];for(let s=r;s<=n;s++){let r=[];for(let n=i;n<=a;n++)r.push(null!=(t=null==(e=this._worksheet.getCell(s,n))?void 0:e.v)?t:null);o.push(r)}return o}getFormulas(){let e=[],{startRow:t,endRow:r,startColumn:n,endColumn:i}=this._range,a=this._worksheet.getSheetId(),o=this._workbook.getUnitId();for(let s=t;s<=r;s++){let t=[];for(let e=n;e<=i;e++){let r=this._formulaDataModel.getFormulaStringByCell(s,e,a,o);t.push(r||"")}e.push(t)}return e}getWrap(){return this._worksheet.getRange(this._range).getWrap()===i.BooleanNumber.TRUE}getWrapStrategy(){return this._worksheet.getRange(this._range).getWrapStrategy()}getHorizontalAlignment(){return er(this._worksheet.getRange(this._range).getHorizontalAlignment())}getVerticalAlignment(){return ei(this._worksheet.getRange(this._range).getVerticalAlignment())}setBackgroundColor(e){return this._commandService.executeCommand(f.SetStyleCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"bg",value:{rgb:e}}})}setValue(e){let t=ea(e);if(!t)throw Error("Invalid value");return this._commandService.executeCommand(f.SetRangeValuesCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:t})}setWrap(e){return this._commandService.executeCommand(f.SetTextWrapCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:e?i.WrapStrategy.WRAP:i.WrapStrategy.UNSPECIFIED})}setWrapStrategy(e){return this._commandService.executeCommand(f.SetTextWrapCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:e})}setVerticalAlignment(e){return this._commandService.executeCommand(f.SetVerticalTextAlignCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:en(e)})}setHorizontalAlignment(e){return this._commandService.executeCommand(f.SetHorizontalTextAlignCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:et(e)})}setNumberFormat(e){let t=[];return this.forEach((r,n)=>t.push({row:r,col:n,pattern:e})),this._commandService.executeCommand(S.SetNumfmtCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId()})}setValues(e){let t=eo(e,this._range);return this._commandService.executeCommand(f.SetRangeValuesCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:t})}setFontWeight(e){let t;if("bold"===e)t=i.BooleanNumber.TRUE;else if("normal"===e)t=i.BooleanNumber.FALSE;else if(null===e)t=null;else throw Error("Invalid fontWeight");let r={type:"bl",value:t},n={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:r};return this._commandService.executeCommand(f.SetStyleCommand.id,n),this}setFontStyle(e){let t;if("italic"===e)t=i.BooleanNumber.TRUE;else if("normal"===e)t=i.BooleanNumber.FALSE;else if(null===e)t=null;else throw Error("Invalid fontStyle");let r={type:"it",value:t},n={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:r};return this._commandService.executeCommand(f.SetStyleCommand.id,n),this}setFontLine(e){if("underline"===e)this._setFontUnderline({s:i.BooleanNumber.TRUE});else if("line-through"===e)this._setFontStrikethrough({s:i.BooleanNumber.TRUE});else if("none"===e)this._setFontUnderline({s:i.BooleanNumber.FALSE}),this._setFontStrikethrough({s:i.BooleanNumber.FALSE});else if(null===e)this._setFontUnderline(null),this._setFontStrikethrough(null);else throw Error("Invalid fontLine");return this}_setFontUnderline(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"ul",value:e}};this._commandService.executeCommand(f.SetStyleCommand.id,t)}_setFontStrikethrough(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"st",value:e}};this._commandService.executeCommand(f.SetStyleCommand.id,t)}setFontFamily(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"ff",value:e}};return this._commandService.executeCommand(f.SetStyleCommand.id,t),this}setFontSize(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"fs",value:e}};return this._commandService.executeCommand(f.SetStyleCommand.id,t),this}setFontColor(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"cl",value:null===e?null:{rgb:e}}};return this._commandService.executeCommand(f.SetStyleCommand.id,t),this}forEach(e){let{startColumn:t,startRow:r,endColumn:n,endRow:i}=this._range;this._worksheet.getMatrixWithMergedCells(r,t,i,n).forValue((t,r,n)=>{e(t,r,n)})}generateHTML(){var e;let t=this._injector.get(u.ISheetClipboardService).generateCopyContent(this._workbook.getUnitId(),this._worksheet.getSheetId(),this._range);return null!=(e=null==t?void 0:t.html)?e:""}async setDataValidation(e){if(!e)return this._commandService.executeCommand(g.ClearRangeDataValidationCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),ranges:[this._range]}),this;let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),rule:{...e.rule,ranges:[this._range]}};return await this._commandService.executeCommand(g.AddSheetDataValidationCommand.id,t),this}getDataValidation(){let e=this._injector.get(g.SheetsDataValidationValidatorService).getDataValidation(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]);return e&&new eI(e)}getDataValidations(){return this._injector.get(g.SheetsDataValidationValidatorService).getDataValidations(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]).map(e=>new eI(e))}async getValidatorStatus(){return this._injector.get(g.SheetsDataValidationValidatorService).validatorRanges(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range])}async createFilter(){return this._getFilterModel()||!await this._commandService.executeCommand(_.SetSheetFilterRangeCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range})?null:this.getFilter()}getFilter(){let e=this._getFilterModel();return e?this._injector.createInstance(K,this._workbook,this._worksheet,e):null}_getFilterModel(){return this._injector.get(v.SheetsFilterService).getFilterModel(this._workbook.getUnitId(),this._worksheet.getSheetId())}attachPopup(e){let{key:t,disposableCollection:r}=ed(e,this._injector.get(c.ComponentManager)),n=this._injector.get(u.SheetCanvasPopManagerService).attachPopupToCell(this._range.startRow,this._range.startColumn,{...e,componentKey:t},this.getUnitId(),this._worksheet.getSheetId());return n?(r.add(n),r):(r.dispose(),null)}attachAlertPopup(e){let t=this._injector.get(u.CellAlertManagerService),r={workbook:this._workbook,worksheet:this._worksheet,row:this._range.startRow,col:this._range.startColumn,unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId()};return t.showAlert({...e,location:r}),{dispose:/* @__PURE__ */M(()=>{t.removeAlert(e.key)},"dispose")}}getComment(){let e=this._injector.get(b.SheetsThreadCommentModel),t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=e.getByLocation(t,r,this._range.startRow,this._range.startColumn);if(!n)return null;let i=e.getComment(t,r,n);return i?this._injector.createInstance(ee,i):null}addComment(e){var t;let r=this._injector,n=null==(t=this.getComment())?void 0:t.getCommentData(),a=r.get(i.ICommandService),o=r.get(i.UserManagerService),s=this._workbook.getUnitId(),l=this._worksheet.getSheetId(),d=`${(0,i.Tools).chatAtABC(this._range.startColumn)}${this._range.startRow+1}`,u=o.getCurrentUser();return a.executeCommand(y.AddCommentCommand.id,{unitId:s,subUnitId:l,comment:{text:e,attachments:[],dT:(0,w.getDT)(),id:(0,i.Tools).generateRandomId(),ref:d,personId:u.userID,parentId:null==n?void 0:n.id,unitId:s,subUnitId:l,threadId:null==n?void 0:n.threadId}})}clearComment(){var e;let t=this._injector,r=null==(e=this.getComment())?void 0:e.getCommentData(),n=t.get(i.ICommandService),a=this._workbook.getUnitId(),o=this._worksheet.getSheetId();return r?n.executeCommand(y.DeleteCommentTreeCommand.id,{unitId:a,subUnitId:o,threadId:r.threadId,commentId:r.id}):Promise.resolve(!0)}async merge(){let e=this._workbook.getUnitId(),t=this._worksheet.getSheetId();return await (0,f.addMergeCellsUtil)(this._injector,e,t,[this._range]),this}async mergeAcross(){let e=(0,f.getAddMergeMutationRangeByType)([this._range],i.Dimension.ROWS),t=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return await (0,f.addMergeCellsUtil)(this._injector,t,r,e),this}async mergeVertically(){let e=(0,f.getAddMergeMutationRangeByType)([this._range],i.Dimension.COLUMNS),t=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return await (0,f.addMergeCellsUtil)(this._injector,t,r,e),this}isPartOfMerge(){let{startRow:e,startColumn:t,endRow:r,endColumn:n}=this._range;return this._worksheet.getMergedCellRange(e,t,r,n).length>0}breakApart(){return this._commandService.executeCommand(f.RemoveWorksheetMergeCommand.id,{ranges:[this._range]}),this}setHyperLink(e,t){let r={unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId(),link:{row:this._range.startRow,column:this._range.startColumn,payload:e,display:t,id:(0,i.generateRandomId)()}};return this._commandService.executeCommand(I.AddHyperLinkCommand.id,r)}getHyperLinks(){var e,t,r;let n=this._worksheet.getCellRaw(this._range.startRow,this._range.startColumn);return null!=n&&n.p&&null!=(r=null==(t=null==(e=n.p.body)?void 0:e.customRanges)?void 0:t.filter(e=>e.rangeType===i.CustomRangeType.HYPERLINK).map(e=>{var t,r,i,a,o;return{id:e.rangeId,startIndex:e.startIndex,endIndex:e.endIndex,url:null!=(r=null==(t=e.properties)?void 0:t.url)?r:"",label:null!=(o=null==(a=null==(i=n.p)?void 0:i.body)?void 0:a.dataStream.slice(e.startIndex+1,e.endIndex))?o:""}}))?r:[]}updateHyperLink(e,t,r){let n={unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this._range.startRow,column:this._range.startColumn,id:e,payload:{payload:t,display:r}};return this._commandService.executeCommand(I.UpdateHyperLinkCommand.id,n)}cancelHyperLink(e){let t={unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this._range.startRow,column:this._range.startColumn,id:e};return this._commandService.executeCommand(I.CancelHyperLinkCommand.id,t)}},M(eh,"FRange"),eh);ev=eg([ef(3,(0,i.Inject)(i.Injector)),ef(4,i.ICommandService),ef(5,o.IRenderManagerService),ef(6,(0,i.Inject)(a.FormulaDataModel))],ev);let e_=class{constructor(e,t){O(this,"rule"),O(this,"_worksheet"),this.rule=e,this._worksheet=t}getAllowInvalid(){return this.rule.errorStyle!==i.DataValidationErrorStyle.STOP}getCriteriaType(){return this.rule.type}getCriteriaValues(){return[this.rule.operator,this.rule.formula1,this.rule.formula2]}getHelpText(){return this.rule.error}copy(){return new eC(this.rule)}getApplied(){if(!this._worksheet)return!1;let e=this._worksheet.getInject().get(p.DataValidationModel).getRuleById(this._worksheet.getWorkbook().getUnitId(),this._worksheet.getSheetId(),this.rule.uid);return!!(e&&e.ranges.length)}getRanges(){var e;if(!this.getAllowInvalid())return[];let t=null==(e=this._worksheet)?void 0:e.getWorkbook(),r=this.getSheetId();if(!r)return[];let n=null==t?void 0:t.getSheetBySheetId(r);return t&&n?this.rule.ranges.map(e=>{var r;return null==(r=this._worksheet)?void 0:r.getInject().createInstance(ev,t,n,e)}):[]}getUnitId(){var e;return null==(e=this._worksheet)?void 0:e.getWorkbook().getUnitId()}getSheetId(){var e;return null==(e=this._worksheet)?void 0:e.getSheetId()}setCriteria(e,t){return(!this.getApplied()||!!this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(g.UpdateSheetDataValidationSettingCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,setting:{operator:t[0],formula1:t[1],formula2:t[2],type:this.rule.type}}))&&(this.rule.operator=t[0],this.rule.formula1=t[1],this.rule.formula2=t[2],this.rule.type=e,!0)}setOptions(e){return(!this.getApplied()||!!this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(g.UpdateSheetDataValidationOptionsCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,options:{...(0,p.getRuleOptions)(this.rule),...e}}))&&(Object.assign(this.rule,e),!0)}setRanges(e){return(!this.getApplied()||!!this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(g.UpdateSheetDataValidationRangeCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,ranges:e.map(e=>e.getRange())}))&&(this.rule.ranges=e,!0)}delete(){return!!this.getApplied()&&this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(g.RemoveSheetDataValidationCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid})}};M(e_,"FDataValidation");let eI=e_,eS=class e{constructor(e){O(this,"_rule"),this._rule=null!=e?e:{uid:(0,i.generateRandomId)(),ranges:void 0,type:i.DataValidationType.CUSTOM}}build(){return new eI(this._rule)}copy(){return new e({...this._rule,uid:(0,i.generateRandomId)()})}getAllowInvalid(){return this._rule.errorStyle!==i.DataValidationErrorStyle.STOP}getCriteriaType(){return this._rule.type}getCriteriaValues(){return[this._rule.operator,this._rule.formula1,this._rule.formula2]}getHelpText(){return this._rule.error}requireCheckbox(e,t){return this._rule.type=i.DataValidationType.CHECKBOX,this._rule.formula1=e,this._rule.formula2=t,this}requireDateAfter(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.operator=i.DataValidationOperator.GREATER_THAN,this}requireDateBefore(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN,this}requireDateBetween(e,t){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=t.toLocaleDateString(),this._rule.operator=i.DataValidationOperator.BETWEEN,this}requireDateEqualTo(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.EQUAL,this}requireDateNotBetween(e,t){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=t.toLocaleDateString(),this._rule.operator=i.DataValidationOperator.NOT_BETWEEN,this}requireDateOnOrAfter(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.GREATER_THAN_OR_EQUAL,this}requireDateOnOrBefore(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN_OR_EQUAL,this}requireFormulaSatisfied(e){return this._rule.type=i.DataValidationType.CUSTOM,this._rule.formula1=e,this._rule.formula2=void 0,this}requireNumberBetween(e,t,r){return this._rule.formula1=`${e}`,this._rule.formula2=`${t}`,this._rule.operator=i.DataValidationOperator.BETWEEN,this._rule.type=r?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberGreaterThan(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.GREATER_THAN,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberGreaterThanOrEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.GREATER_THAN_OR_EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberLessThan(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberLessThanOrEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN_OR_EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberNotBetween(e,t,r){return this._rule.formula1=`${e}`,this._rule.formula2=`${t}`,this._rule.operator=i.DataValidationOperator.NOT_BETWEEN,this._rule.type=r?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberNotEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.NOT_EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireValueInList(e,t,r){return this._rule.type=t?i.DataValidationType.LIST_MULTIPLE:i.DataValidationType.LIST,this._rule.formula1=e.join(","),this._rule.formula2=void 0,this._rule.showDropDown=null==r||r,this}requireValueInRange(e,t,r){return this._rule.type=t?i.DataValidationType.LIST_MULTIPLE:i.DataValidationType.LIST,this._rule.formula1=`=${(0,a.serializeRangeToRefString)({unitId:e.getUnitId(),sheetName:e.getSheetName(),range:e.getRange()})}`,this._rule.formula2=void 0,this._rule.showDropDown=null==r||r,this}setAllowInvalid(e){return this._rule.errorStyle=e?i.DataValidationErrorStyle.WARNING:i.DataValidationErrorStyle.STOP,this}setHelpText(e){return this._rule.error=e,this._rule.showErrorMessage=!0,this}withCriteriaValues(e,t){return this._rule.type=e,this._rule.operator=t[0],this._rule.formula1=t[1],this._rule.formula2=t[2],this}};M(eS,"FDataValidationBuilder");let eC=eS;var ey,eb=Object.defineProperty,ew=Object.getOwnPropertyDescriptor,eR=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ew(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eb(t,r,a),a},"__decorateClass$6"),eE=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let eT=(M(ey=class{constructor(e){this._commandService=e}executeCalculation(){this._commandService.executeCommand(a.SetFormulaCalculationStartMutation.id,{commands:[],forceCalculation:!0},{onlyLocal:!0})}stopCalculation(){this._commandService.executeCommand(a.SetFormulaCalculationStopMutation.id,{})}calculationStart(e){return this._commandService.onCommandExecuted(t=>{t.id===a.SetFormulaCalculationStartMutation.id&&e(t.params.forceCalculation)})}calculationEnd(e){return this._commandService.onCommandExecuted(t=>{if(t.id!==a.SetFormulaCalculationNotificationMutation.id)return;let r=t.params;void 0!==r.functionsExecutedState&&e(r.functionsExecutedState)})}calculationProcessing(e){return this._commandService.onCommandExecuted(t=>{if(t.id!==a.SetFormulaCalculationNotificationMutation.id)return;let r=t.params;void 0!==r.stageInfo&&e(r.stageInfo)})}},"FFormula"),ey);eT=eR([eE(0,i.ICommandService)],eT);var eM,eO=Object.defineProperty,eD=Object.getOwnPropertyDescriptor,eU=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eD(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eO(t,r,a),a},"__decorateClass$5"),eP=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let ek=(M(eM=class{constructor(e,t,r,n,i,a,o){this._injector=e,this._commandService=t,this._permissionService=r,this._worksheetProtectionRuleModel=n,this._rangeProtectionRuleModel=i,this._worksheetProtectionPointRuleModel=a,this._authzIoService=o}setWorkbookPermissionPoint(e,t,r){let n=new t(e);this._permissionService.getPermissionPoint(n.id)||this._permissionService.addPermissionPoint(n),this._permissionService.updatePermissionPoint(n.id,r)}setWorkbookEditPermission(e,t){this.setWorkbookPermissionPoint(e,f.WorkbookEditablePermission,t)}async addWorksheetBasePermission(e,t){if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).length>0)throw Error("sheet protection cannot intersect with range protection");let r=await this._authzIoService.create({objectType:f.UnitObject.Worksheet});if(this._commandService.syncExecuteCommand(f.AddWorksheetProtectionMutation.id,{unitId:e,subUnitId:t,rule:{permissionId:r,unitType:f.UnitObject.Worksheet,unitId:e,subUnitId:t}}))return r}removeWorksheetPermission(e,t){this._commandService.syncExecuteCommand(f.DeleteWorksheetProtectionMutation.id,{unitId:e,subUnitId:t}),[...(0,f.getAllWorksheetPermissionPoint)(),...(0,f.getAllWorksheetPermissionPointByPointPanel)()].forEach(r=>{let n=new r(e,t);this._permissionService.updatePermissionPoint(n.id,!0)}),this._worksheetProtectionPointRuleModel.deleteRule(e,t)}async setWorksheetPermissionPoint(e,t,r,n){let i;let a=this._worksheetProtectionRuleModel.getRule(e,t);if(r===f.WorksheetEditPermission||r===f.WorksheetViewPermission){if(a)i=a.permissionId;else{if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).length>0)throw Error("sheet protection cannot intersect with range protection");i=await this.addWorksheetBasePermission(e,t)}}else{let r=this._worksheetProtectionPointRuleModel.getRule(e,t);r?i=r.permissionId:(i=await this._authzIoService.create({objectType:f.UnitObject.Worksheet}),this._commandService.executeCommand(f.SetWorksheetPermissionPointsMutation.id,{unitId:e,subUnitId:t,permissionId:i}))}let o=new r(e,t);return this._permissionService.getPermissionPoint(o.id)||this._permissionService.addPermissionPoint(o),this._permissionService.updatePermissionPoint(o.id,n),i}async addRangeBaseProtection(e,t,r){let n=await this._authzIoService.create({objectType:f.UnitObject.SelectRange}),a=`ruleId_${(0,i.generateRandomId)(6)}`;if(this._worksheetProtectionRuleModel.getRule(e,t))throw Error("sheet protection cannot intersect with range protection");if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).some(e=>e.ranges.some(e=>r.some(t=>(0,i.Rectangle).intersects(t,e)))))throw Error("range protection cannot intersect");if(this._commandService.syncExecuteCommand(f.AddRangeProtectionMutation.id,{unitId:e,subUnitId:t,rules:[{permissionId:n,unitType:f.UnitObject.SelectRange,unitId:e,subUnitId:t,ranges:r,id:a}]}))return{permissionId:n,ruleId:a}}removeRangeProtection(e,t,r){this._commandService.syncExecuteCommand(f.DeleteRangeProtectionMutation.id,{unitId:e,subUnitId:t,ruleIds:r})&&0===this._rangeProtectionRuleModel.getSubunitRuleList(e,t).length&&(this._worksheetProtectionPointRuleModel.deleteRule(e,t),[...(0,f.getAllWorksheetPermissionPointByPointPanel)()].forEach(r=>{let n=new r(e,t);this._permissionService.updatePermissionPoint(n.id,n.value)}))}setRangeProtectionPermissionPoint(e,t,r,n,i){let a=new n(e,t,r);this._permissionService.getPermissionPoint(a.id)||this._permissionService.addPermissionPoint(a),this._permissionService.updatePermissionPoint(a.id,i)}setRangeProtectionRanges(e,t,r,n){let a=this._rangeProtectionRuleModel.getRule(e,t,r);if(a){if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).filter(e=>e.id!==r).some(e=>e.ranges.some(e=>n.some(t=>(0,i.Rectangle).intersects(t,e)))))throw Error("range protection cannot intersect");this._commandService.syncExecuteCommand(f.SetRangeProtectionMutation.id,{unitId:e,subUnitId:t,ruleId:r,rule:{...a,ranges:n}})}}setPermissionDialogVisible(e){this._injector.get(u.SheetPermissionInterceptorBaseController).setShowPermissionDialog(e)}},"FPermission"),eM);ek=eU([eP(0,(0,i.Inject)(i.Injector)),eP(1,i.ICommandService),eP(2,i.IPermissionService),eP(3,(0,i.Inject)(f.WorksheetProtectionRuleModel)),eP(4,(0,i.Inject)(f.RangeProtectionRuleModel)),eP(5,(0,i.Inject)(f.WorksheetProtectionPointModel)),eP(6,(0,i.Inject)(i.IAuthzIoService))],ek);var eN,eA=Object.defineProperty,ex=Object.getOwnPropertyDescriptor,eL=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ex(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eA(t,r,a),a},"__decorateClass$4"),eV=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let eF=(M(eN=class{constructor(e,t,r,n){this._hoverManagerService=e,this._dragManagerService=t,this._commandService=r,this._injector=n}onCellPointerMove(e){return(0,i.toDisposable)(this._hoverManagerService.currentPosition$.subscribe(e))}onCellPointerOver(e){return(0,i.toDisposable)(this._hoverManagerService.currentCell$.subscribe(e))}onCellDragOver(e){return(0,i.toDisposable)(this._dragManagerService.currentCell$.subscribe(e))}onCellDrop(e){return(0,i.toDisposable)(this._dragManagerService.endCell$.subscribe(e))}},"FSheetHooks"),eN);eF=eL([eV(0,(0,i.Inject)(u.HoverManagerService)),eV(1,(0,i.Inject)(u.DragManagerService)),eV(2,(0,i.Inject)(i.ICommandService)),eV(3,(0,i.Inject)(i.Injector))],eF);var ej,eH=Object.defineProperty,e$=Object.getOwnPropertyDescriptor,eB=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e$(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eH(t,r,a),a},"__decorateClass$3"),eW=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let eG=(M(ej=class{constructor(e,t,r,n){this._workbook=e,this._worksheet=t,this._selections=r,this._injector=n}getActiveRange(){let e=this._selections.find(e=>!!e.primary);return e?this._injector.createInstance(ev,this._workbook,this._worksheet,e.range):null}},"FSelection"),ej);eG=eB([eW(3,(0,i.Inject)(i.Injector))],eG);var eY,ez=Object.defineProperty,eK=Object.getOwnPropertyDescriptor,eq=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eK(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ez(t,r,a),a},"__decorateClass$2"),eX=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let eZ=(eY=class{constructor(e,t,r,n,i,a){O(this,"setActiveSelection",this.setActiveRange),this._fWorkbook=e,this._workbook=t,this._worksheet=r,this._injector=n,this._selectionManagerService=i,this._commandService=a}getInject(){return this._injector}getWorkbook(){return this._workbook}getSheetId(){return this._worksheet.getSheetId()}getSheetName(){return this._worksheet.getName()}getSelection(){let e=this._selectionManagerService.getCurrentSelections();return e?this._injector.createInstance(eG,this._workbook,this._worksheet,e):null}getRange(e,t,r,n){let o,s;if("string"==typeof e){let{range:t,sheetName:r}=(0,a.deserializeRangeWithSheet)(e),n=r?this._workbook.getSheetBySheetName(r):this._worksheet;if(!n)throw Error("Range not found");s=n,o={...t,unitId:this._workbook.getUnitId(),sheetId:s.getSheetId(),rangeType:i.RANGE_TYPE.NORMAL,startRow:t.rangeType===i.RANGE_TYPE.COLUMN?0:t.startRow,endRow:t.rangeType===i.RANGE_TYPE.COLUMN?s.getMaxRows()-1:t.endRow,startColumn:t.rangeType===i.RANGE_TYPE.ROW?0:t.startColumn,endColumn:t.rangeType===i.RANGE_TYPE.ROW?s.getMaxColumns()-1:t.endColumn}}else if("number"==typeof e&&void 0!==t)s=this._worksheet,o={startRow:e,endRow:e+(null!=r?r:1)-1,startColumn:t,endColumn:t+(null!=n?n:1)-1,unitId:this._workbook.getUnitId(),sheetId:this._worksheet.getSheetId()};else throw Error("Invalid range specification");return this._injector.createInstance(ev,this._workbook,s,o)}getMaxColumns(){return this._worksheet.getMaxColumns()}getMaxRows(){return this._worksheet.getMaxRows()}getDataValidations(){return this._injector.get(p.DataValidationModel).getRules(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>new eI(e))}getValidatorStatus(){return this._injector.get(g.SheetsDataValidationValidatorService).validatorWorksheet(this._workbook.getUnitId(),this._worksheet.getSheetId())}getFilter(){let e=this._getFilterModel();return e?this._injector.createInstance(K,this._workbook,this._worksheet,e):null}_getFilterModel(){return this._injector.get(v.SheetsFilterService).getFilterModel(this._workbook.getUnitId(),this._worksheet.getSheetId())}getComments(){return this._injector.get(b.SheetsThreadCommentModel).getSubUnitAll(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>this._injector.createInstance(ee,e))}addFloatDomToPosition(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),{key:i,disposableCollection:a}=ed(e,this._injector.get(c.ComponentManager)),o=this._injector.get(R.SheetCanvasFloatDomManagerService).addFloatDomToPosition({...e,componentKey:i,unitId:r,subUnitId:n},t);return o?(a.add(o.dispose),{id:o.id,dispose:/* @__PURE__ */M(()=>{a.dispose(),o.dispose()},"dispose")}):(a.dispose(),null)}async insertRowAfter(e){return this.insertRowsAfter(e,1)}async insertRowBefore(e){return this.insertRowsBefore(e,1)}async insertRows(e,t=1){return this.insertRowsBefore(e,t)}async insertRowsAfter(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.DOWN,o=e+1,s=e+t,l=this._worksheet.getColumnCount()-1,d=(0,f.copyRangeStyles)(this._worksheet,o,s,0,l,!0,e);return await this._commandService.executeCommand(f.InsertRowCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:o,endRow:s,startColumn:0,endColumn:l},cellValue:d}),this}async insertRowsBefore(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.UP,o=e+t-1,s=this._worksheet.getColumnCount()-1,l=(0,f.copyRangeStyles)(this._worksheet,e,o,0,s,!0,e-1);return await this._commandService.executeCommand(f.InsertRowCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:e,endRow:o,startColumn:0,endColumn:s},cellValue:l}),this}async deleteRow(e){return this.deleteRows(e,1)}async deleteRows(e,t){let r={startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1};return await this._commandService.executeCommand(f.RemoveRowCommand.id,{range:r}),this}async moveRows(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),i=eu(e.getRange(),this._worksheet),a={startRow:t,endRow:t,startColumn:i.startColumn,endColumn:i.endColumn};return await this._commandService.executeCommand(f.MoveRowsCommand.id,{unitId:r,subUnitId:n,range:i,fromRange:i,toRange:a}),this}async hideRow(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=eu(e.getRange(),this._worksheet);return await this._commandService.executeCommand(f.SetRowHiddenCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async hideRows(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return await this._commandService.executeCommand(f.SetRowHiddenCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async unhideRow(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=eu(e.getRange(),this._worksheet);return await this._commandService.executeCommand(f.SetSpecificRowsVisibleCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async showRows(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return await this._commandService.executeCommand(f.SetSpecificRowsVisibleCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async setRowHeight(e,t){return this.setRowHeights(e,1,t)}async setRowHeights(e,t,r){var n;let i=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),o=this._worksheet.getRowManager(),s=[],l=[];for(let i=e;i<e+t;i++){let e=(null==(n=o.getRow(i))?void 0:n.ah)||this._worksheet.getConfig().defaultRowHeight,t={startRow:i,endRow:i,startColumn:0,endColumn:this._worksheet.getColumnCount()-1};r<=e?s.push(t):l.push(t)}return l.length>0&&await this._commandService.executeCommand(f.SetRowHeightCommand.id,{unitId:i,subUnitId:a,ranges:l,value:r}),s.length>0&&await this._commandService.executeCommand(f.SetWorksheetRowIsAutoHeightCommand.id,{unitId:i,subUnitId:a,ranges:s}),this}async setRowHeightsForced(e,t,r){let n=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),a=[{startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1}];return await this._commandService.executeCommand(f.SetRowHeightCommand.id,{unitId:n,subUnitId:i,ranges:a,value:r}),this}async insertColumnAfter(e){return this.insertColumnsAfter(e,1)}async insertColumnBefore(e){return this.insertColumnsBefore(e,1)}async insertColumns(e,t=1){return this.insertColumnsBefore(e,t)}async insertColumnsAfter(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.RIGHT,o=this._worksheet.getRowCount()-1,s=e+1,l=e+t,d=(0,f.copyRangeStyles)(this._worksheet,0,o,s,l,!1,e);return await this._commandService.executeCommand(f.InsertColCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:0,endRow:o,startColumn:s,endColumn:l},cellValue:d}),this}async insertColumnsBefore(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.LEFT,o=this._worksheet.getRowCount()-1,s=e+t-1,l=(0,f.copyRangeStyles)(this._worksheet,0,o,e,s,!1,e-1);return await this._commandService.executeCommand(f.InsertColCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:0,endRow:o,startColumn:e,endColumn:s},cellValue:l}),this}async deleteColumn(e){return this.deleteColumns(e,1)}async deleteColumns(e,t){let r={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:e,endColumn:e+t-1};return await this._commandService.executeCommand(f.RemoveColCommand.id,{range:r}),this}async moveColumns(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),i=ec(e.getRange(),this._worksheet),a={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:t,endColumn:t};return await this._commandService.executeCommand(f.MoveColsCommand.id,{unitId:r,subUnitId:n,range:i,fromRange:i,toRange:a}),this}async hideColumn(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=ec(e.getRange(),this._worksheet);return await this._commandService.executeCommand(f.SetColHiddenCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async hideColumns(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:e,endColumn:e+t-1,rangeType:i.RANGE_TYPE.COLUMN};return await this._commandService.executeCommand(f.SetColHiddenCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async unhideColumn(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=ec(e.getRange(),this._worksheet);return await this._commandService.executeCommand(f.SetSpecificColsVisibleCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async showColumns(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:e,endColumn:e+t-1,rangeType:i.RANGE_TYPE.COLUMN};return await this._commandService.executeCommand(f.SetSpecificColsVisibleCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async setColumnWidth(e,t){return this.setColumnWidths(e,1,t)}async setColumnWidths(e,t,r){let n=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),a=[{startColumn:e,endColumn:e+t-1,startRow:0,endRow:this._worksheet.getRowCount()-1}];return await this._commandService.executeCommand(f.SetColWidthCommand.id,{unitId:n,subUnitId:i,ranges:a,value:r}),this}getMergedRanges(){return this._worksheet.getSnapshot().mergeData.map(e=>this._injector.createInstance(ev,this._workbook,this._worksheet,e))}getCellMergeData(e,t){let r=this._worksheet.getMergedCell(e,t);if(r)return this._injector.createInstance(ev,this._workbook,this._worksheet,r)}getActiveRange(){return this._fWorkbook.getActiveRange()}setActiveRange(e){let{unitId:t,sheetId:r}=e.getRange();if(t!==this._workbook.getUnitId()||r!==this._worksheet.getSheetId())throw Error("Specified range must be part of the sheet.");this._fWorkbook.setActiveRange(e)}},M(eY,"FWorksheet"),eY);eZ=eq([eX(3,(0,i.Inject)(i.Injector)),eX(4,(0,i.Inject)(f.SheetsSelectionsService)),eX(5,i.ICommandService)],eZ);var eQ,eJ=Object.defineProperty,e0=Object.getOwnPropertyDescriptor,e1=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e0(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eJ(t,r,a),a},"__decorateClass$1"),e3=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let e2=(M(eQ=class{constructor(e,t,r,n,i,a,o,s){O(this,"id"),this._workbook=e,this._injector=t,this._resourceLoaderService=r,this._selectionManagerService=n,this._univerInstanceService=i,this._commandService=a,this._permissionService=o,this._logService=s,this.id=this._workbook.getUnitId()}get _dataValidationModel(){return this._injector.get(g.SheetDataValidationModel)}get _threadCommentModel(){return this._injector.get(y.ThreadCommentModel)}getId(){return this.id}getName(){return this._workbook.getName()}save(){return this._resourceLoaderService.saveUnit(this._workbook.getUnitId())}getSnapshot(){return this._logService.warn("use 'save' instead of 'getSnapshot'"),this.save()}getActiveSheet(){let e=this._workbook.getActiveSheet();return this._injector.createInstance(eZ,this,this._workbook,e)}getSheets(){return this._workbook.getSheets().map(e=>this._injector.createInstance(eZ,this,this._workbook,e))}create(e,t,r){let n=(0,i.mergeWorksheetSnapshotWithDefault)({});n.rowCount=t,n.columnCount=r,n.name=e,n.id=e.toLowerCase().replace(/ /g,"-"),this._commandService.syncExecuteCommand(f.InsertSheetCommand.id,{unitId:this.id,index:this._workbook.getSheets().length,sheet:n}),this._commandService.syncExecuteCommand(f.SetWorksheetActiveOperation.id,{unitId:this.id,subUnitId:this._workbook.getSheets()[this._workbook.getSheets().length-1].getSheetId()});let a=this._workbook.getActiveSheet();if(!a)throw Error("No active sheet found");return this._injector.createInstance(eZ,this,this._workbook,a)}getSheetBySheetId(e){let t=this._workbook.getSheetBySheetId(e);return t?this._injector.createInstance(eZ,this,this._workbook,t):null}getSheetByName(e){let t=this._workbook.getSheetBySheetName(e);return t?this._injector.createInstance(eZ,this,this._workbook,t):null}setActiveSheet(e){return this._commandService.syncExecuteCommand(f.SetWorksheetActiveOperation.id,{unitId:this.id,subUnitId:e.getSheetId()}),e}insertSheet(){this._commandService.syncExecuteCommand(f.InsertSheetCommand.id);let e=this.id,t=this._workbook.getSheets()[this._workbook.getSheets().length-1].getSheetId();this._commandService.syncExecuteCommand(f.SetWorksheetActiveOperation.id,{unitId:e,subUnitId:t});let r=this._workbook.getActiveSheet();if(!r)throw Error("No active sheet found");return this._injector.createInstance(eZ,this,this._workbook,r)}deleteSheet(e){let t=this.id,r=e.getSheetId();this._commandService.executeCommand(f.RemoveSheetCommand.id,{unitId:t,subUnitId:r})}undo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.UndoCommand.id)}redo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.RedoCommand.id)}openSiderbar(e){return this._injector.get(c.ISidebarService).open(e)}openDialog(e){return this._injector.get(c.IDialogService).open(e)}onBeforeCommandExecute(e){return this._commandService.beforeCommandExecuted(t=>{var r;(null==(r=t.params)?void 0:r.unitId)===this.id&&e(t)})}onCommandExecuted(e){return this._commandService.onCommandExecuted(t=>{var r;(null==(r=t.params)?void 0:r.unitId)===this.id&&e(t)})}onSelectionChange(e){return(0,i.toDisposable)(this._selectionManagerService.selectionMoveEnd$.subscribe(t=>{this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId()===this.id&&(null!=t&&t.length?e(t.map(e=>e.range)):e([]))}))}setEditable(e){let t=new f.WorkbookEditablePermission(this._workbook.getUnitId());this._permissionService.getPermissionPoint(t.id)||this._permissionService.addPermissionPoint(t),this._permissionService.updatePermissionPoint(t.id,e)}getValidatorStatus(){return this._injector.get(g.SheetsDataValidationValidatorService).validatorWorkbook(this._workbook.getUnitId())}setActiveRange(e){let t=this.getActiveSheet(),r=e.getRange().sheetId||t.getSheetId(),n=r?this._workbook.getSheetBySheetId(r):this._workbook.getActiveSheet(!0);if(!n)throw Error("No active sheet found");n.getSheetId()!==t.getSheetId()&&this.setActiveSheet(this._injector.createInstance(eZ,this,this._workbook,n));let i={unitId:this.getId(),subUnitId:r,selections:[e].map(e=>({range:e.getRange(),primary:(0,f.getPrimaryForRange)(e.getRange(),n),style:null}))};this._commandService.syncExecuteCommand(f.SetSelectionsOperation.id,i)}getActiveRange(){let e=this._workbook.getActiveSheet(),t=this._selectionManagerService.getCurrentSelections().find(e=>!!e.primary);return t?this._injector.createInstance(ev,this._workbook,e,t.range):null}onDataValidationChange(e){return(0,i.toDisposable)(this._dataValidationModel.ruleChange$.pipe((0,m.filter)(e=>e.unitId===this._workbook.getUnitId())).subscribe(e))}onDataValidationStatusChange(e){return(0,i.toDisposable)(this._dataValidationModel.validStatusChange$.pipe((0,m.filter)(e=>e.unitId===this._workbook.getUnitId())).subscribe(e))}onBeforeAddDataValidation(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===g.AddSheetDataValidationCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeAddDataValidation")}}))}onBeforeUpdateDataValidationCriteria(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===g.UpdateSheetDataValidationSettingCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateDataValidationCriteria")}}))}onBeforeUpdateDataValidationRange(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===g.UpdateSheetDataValidationRangeCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateDataValidationRange")}}))}onBeforeUpdateDataValidationOptions(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===g.UpdateSheetDataValidationOptionsCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateDataValidationOptions")}}))}onBeforeDeleteDataValidation(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===g.RemoveSheetDataValidationCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeDeleteDataValidation")}}))}onBeforeDeleteAllDataValidation(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===g.RemoveSheetAllDataValidationCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeDeleteAllDataValidation")}}))}onThreadCommentChange(e){return(0,i.toDisposable)(this._threadCommentModel.commentUpdate$.pipe((0,m.filter)(e=>e.unitId===this._workbook.getUnitId())).subscribe(e))}onBeforeAddThreadComment(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===y.AddCommentCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeAddThreadComment")}}))}onBeforeUpdateThreadComment(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===y.UpdateCommentCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateThreadComment")}}))}onBeforeDeleteThreadComment(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===y.DeleteCommentCommand.id||t.id===y.DeleteCommentTreeCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeDeleteThreadComment")}}))}createSheetHyperlink(e,t){return this._injector.get(I.SheetsHyperLinkResolverService).buildHyperLink(this.getId(),e,t)}parseSheetHyperlink(e){return this._injector.get(I.SheetsHyperLinkResolverService).parseHyperLink(e)}navigateToSheetHyperlink(e){this._injector.get(I.SheetsHyperLinkResolverService).parseHyperLink(e).handler()}},"FWorkbook"),eQ);e2=e1([e3(1,(0,i.Inject)(i.Injector)),e3(2,(0,i.Inject)(i.IResourceLoaderService)),e3(3,(0,i.Inject)(f.SheetsSelectionsService)),e3(4,i.IUniverInstanceService),e3(5,i.ICommandService),e3(6,i.IPermissionService),e3(7,i.ILogService)],e2);var e4,e9=Object.defineProperty,e5=Object.getOwnPropertyDescriptor,e6=/* @__PURE__ */M((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e5(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e9(t,r,a),a},"__decorateClass"),e8=/* @__PURE__ */M((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let e7=(M(e4=class{constructor(e,t,r){O(this,"_debouncedFormulaCalculation"),this._injector=e,this._univerInstanceService=t,this._commandService=r,this._initialize()}_initialize(){this._debouncedFormulaCalculation=(0,i.debounce)(()=>{this._commandService.executeCommand(a.SetFormulaCalculationStartMutation.id,{commands:[],forceCalculation:!0},{onlyLocal:!0})},10)}static getDependencies(e,t){let r=t||[];return e.get(s.ISocketService,i.Quantity.OPTIONAL)||r.push([s.ISocketService,{useClass:s.WebSocketService}]),r}static newAPI(e){let t=e instanceof i.Univer?e.__getInjector():e;return e7.getDependencies(t).forEach(e=>t.add(e)),t.createInstance(e7)}static newDataValidation(){return new eC}createUniverSheet(e){let t=this._univerInstanceService.createUnit(i.UniverInstanceType.UNIVER_SHEET,e);return this._injector.createInstance(e2,t)}createUniverDoc(e){let t=this._univerInstanceService.createUnit(i.UniverInstanceType.UNIVER_DOC,e);return this._injector.createInstance(N,t)}disposeUnit(e){return this._univerInstanceService.disposeUnit(e)}getUniverSheet(e){let t=this._univerInstanceService.getUniverSheetInstance(e);return t?this._injector.createInstance(e2,t):null}getUniverDoc(e){let t=this._univerInstanceService.getUniverDocInstance(e);return t?this._injector.createInstance(N,t):null}getActiveWorkbook(){let e=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);return e?this._injector.createInstance(e2,e):null}getActiveDocument(){let e=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_DOC);return e?this._injector.createInstance(N,e):null}registerFunction(e){let t=this._injector.get(d.IRegisterFunctionService);t||(this._injector.add([d.IRegisterFunctionService,{useClass:d.RegisterFunctionService}]),t=this._injector.get(d.IRegisterFunctionService));let r=t.registerFunctions(e);return this._debouncedFormulaCalculation(),(0,i.toDisposable)(()=>{r.dispose()})}registerSheetRowHeaderExtension(e,...t){let r=this._getSheetRenderComponent(e,u.SHEET_VIEW_KEY.ROW),n=r.register(...t);return(0,i.toDisposable)(()=>{n.dispose(),r.makeDirty(!0)})}registerSheetColumnHeaderExtension(e,...t){let r=this._getSheetRenderComponent(e,u.SHEET_VIEW_KEY.COLUMN),n=r.register(...t);return(0,i.toDisposable)(()=>{n.dispose(),r.makeDirty(!0)})}registerSheetMainExtension(e,...t){let r=this._getSheetRenderComponent(e,u.SHEET_VIEW_KEY.MAIN),n=r.register(...t);return(0,i.toDisposable)(()=>{n.dispose(),r.makeDirty(!0)})}getFormula(){return this._injector.createInstance(eT)}undo(){return this._commandService.executeCommand(i.UndoCommand.id)}redo(){return this._commandService.executeCommand(i.RedoCommand.id)}copy(){return this._commandService.executeCommand(c.CopyCommand.id)}paste(){return this._commandService.executeCommand(c.PasteCommand.id)}onBeforeCommandExecute(e){return this._commandService.beforeCommandExecuted((t,r)=>{e(t,r)})}onCommandExecuted(e){return this._commandService.onCommandExecuted((t,r)=>{e(t,r)})}executeCommand(e,t,r){return this._commandService.executeCommand(e,t,r)}createSocket(e){let t=this._injector.get(s.ISocketService).createSocket(e);if(!t)throw Error("[WebSocketService]: failed to create socket!");return t}getSheetHooks(){return this._injector.createInstance(eF)}getHooks(){return this._injector.createInstance($)}_getSheetRenderComponent(e,t){let r=this._injector.get(o.IRenderManagerService).getRenderById(e);if(!r)throw Error("Render not found");let{components:n}=r,i=n.get(t);if(!i)throw Error("Render component not found");return i}customizeColumnHeader(e){let t=this.getActiveWorkbook();if(!t){console.error("WorkBook not exist");return}let r=null==t?void 0:t.getId();this._getSheetRenderComponent(r,u.SHEET_VIEW_KEY.COLUMN).setCustomHeader(e)}customizeRowHeader(e){let t=this.getActiveWorkbook();if(!t){console.error("WorkBook not exist");return}let r=null==t?void 0:t.getId();this._getSheetRenderComponent(r,u.SHEET_VIEW_KEY.ROW).setCustomHeader(e)}setCrosshairHighlightEnabled(e){e?this._commandService.executeCommand(l.EnableCrosshairHighlightOperation.id):this._commandService.executeCommand(l.DisableCrosshairHighlightOperation.id)}setCrosshairHighlightColor(e){this._commandService.executeCommand(l.SetCrosshairHighlightColorOperation.id,{value:e})}getPermission(){return this._injector.createInstance(ek)}},"FUniver"),O(e4,"BorderStyle",i.BorderStyleTypes),O(e4,"WrapStrategy",i.WrapStrategy),e4);e7=e6([e8(0,(0,i.Inject)(i.Injector)),e8(1,i.IUniverInstanceService),e8(2,i.ICommandService)],e7)}),i("hJKDz",function(t,r){let i,a;e(t.exports,"ISocketService",function(){return F}),e(t.exports,"WebSocketService",function(){return H});var o=n("83KcA"),s=(n("fsrAq"),n("ckDhp")),l=n("3KKCW"),d=n("bA4Xh"),u=(n("3W2QR"),n("1fKgN")),c=(n("dORxZ"),n("cEuBH")),h=Object.defineProperty,m=(e,t,r)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,p=(e,t)=>h(e,"name",{value:t,configurable:!0}),g=(e,t,r)=>m(e,"symbol"!=typeof t?t+"":t,r);let f="application/json",v=class{constructor(e){g(this,"_headers",/* @__PURE__ */new Map),"string"==typeof e?this._handleHeadersString(e):e instanceof Headers?this._handleHeaders(e):e&&this._handleHeadersConstructorProps(e)}forEach(e){this._headers.forEach((t,r)=>e(r,t))}has(e){return!!this._headers.has(e.toLowerCase())}get(e){let t=e.toLowerCase();return this._headers.has(t)?this._headers.get(t):null}toHeadersInit(){let e={};return this._headers.forEach((t,r)=>{e[r]=t.join(",")}),null!=e.accept||(e.accept="application/json, text/plain, */*"),null!=e["content-type"]||(e["content-type"]="application/json;charset=UTF-8"),e}_setHeader(e,t){let r=e.toLowerCase();this._headers.has(r)?this._headers.get(r).push(t.toString()):this._headers.set(r,[t.toString()])}_handleHeadersString(e){e.split(`
`).forEach(e=>{let[t,r]=e.split(":");t&&r&&this._setHeader(t,r)})}_handleHeadersConstructorProps(e){Object.entries(e).forEach(([e,t])=>this._setHeader(e,t))}_handleHeaders(e){e.forEach((e,t)=>this._setHeader(t,e))}};p(v,"HTTPHeaders");let _=(0,o.createIdentifier)("network.http-implementation"),I=class{constructor(e){this.params=e}toString(){return this.params?Object.keys(this.params).map(e=>`${e}=${this.params[e]}`).join("&"):""}};p(I,"HTTPParams");let S=0,C=class{constructor(e,t,r){g(this,"uid",S++),this.method=e,this.url=t,this.requestParams=r}get headers(){return this.requestParams.headers}get withCredentials(){return this.requestParams.withCredentials}get responseType(){return this.requestParams.responseType}getUrlWithParams(){var e,t;let r=null==(t=null==(e=this.requestParams)?void 0:e.params)?void 0:t.toString();return r?`${this.url}${this.url.includes("?")?"&":"?"}${r}`:this.url}getBody(){var e,t;let r=null!=(e=this.headers.get("Content-Type"))?e:f,n=null==(t=this.requestParams)?void 0:t.body;return r===f&&n&&"object"==typeof n?JSON.stringify(n):n?`${n}`:null}getHeadersInit(){return this.headers.toHeadersInit()}};p(C,"HTTPRequest");var y,b=Object.defineProperty,w=Object.getOwnPropertyDescriptor,R=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?w(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&b(t,r,a),a},"__decorateClass"),E=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let T=(p(y=class extends o.Disposable{constructor(e){super(),g(this,"_interceptors",[]),g(this,"_pipe"),this._http=e}registerHTTPInterceptor(e){if(-1!==this._interceptors.indexOf(e))throw Error("[HTTPService]: The interceptor has already been registered!");return this._interceptors.push(e),this._interceptors=this._interceptors.sort((e,t)=>{var r,n;return(null!=(r=e.priority)?r:0)-(null!=(n=t.priority)?n:0)}),this._pipe=null,(0,o.toDisposable)(()=>(0,o.remove)(this._interceptors,e))}get(e,t){return this._request("GET",e,t)}post(e,t){return this._request("POST",e,t)}put(e,t){return this._request("PUT",e,t)}delete(e,t){return this._request("DELETE",e,t)}patch(e,t){return this._request("PATCH",e,t)}getSSE(e,t,r){var n,i;let a=new C(e,t,{headers:new v(null==r?void 0:r.headers),params:new I(null==r?void 0:r.params),withCredentials:null!=(n=null==r?void 0:r.withCredentials)&&n,reportProgress:!0,responseType:null!=(i=null==r?void 0:r.responseType)?i:"json",body:["GET","DELETE"].includes(e)||null==r?void 0:r.body});return(0,d.of)(a).pipe((0,u.concatMap)(e=>this._runInterceptorsAndImplementation(e)))}async _request(e,t,r){var n,i;let a=new C(e,t,{headers:new v(null==r?void 0:r.headers),params:new I(null==r?void 0:r.params),withCredentials:null!=(n=null==r?void 0:r.withCredentials)&&n,responseType:null!=(i=null==r?void 0:r.responseType)?i:"json",body:["GET","DELETE"].includes(e)||null==r?void 0:r.body}),o=(0,d.of)(a).pipe((0,u.concatMap)(e=>this._runInterceptorsAndImplementation(e)));return await (0,s.firstValueFrom)(o)}_runInterceptorsAndImplementation(e){return this._pipe||(this._pipe=this._interceptors.map(e=>e.interceptor).reduceRight((e,t)=>M(e,t),(e,t)=>t(e))),this._pipe(e,e=>this._http.send(e))}},"HTTPService"),y);function M(e,t){return(r,n)=>t(r,t=>e(t,n))}T=R([E(0,_)],T),p(M,"chainInterceptorFn");var O=((i=O||{})[i.DownloadProgress=0]="DownloadProgress",i[i.Response=1]="Response",i);let D=class{constructor({body:e,headers:t,status:r,statusText:n}){g(this,"type",1),g(this,"body"),g(this,"headers"),g(this,"status"),g(this,"statusText"),this.body=e,this.headers=t,this.status=r,this.statusText=n}};p(D,"HTTPResponse");let U=class{constructor(e,t,r){g(this,"type",0),this.total=e,this.loaded=t,this.partialText=r}};p(U,"HTTPProgress");let P=class{constructor(e,t,r){this.headers=e,this.status=t,this.statusText=r}};p(P,"ResponseHeader");let k=class{constructor({headers:e,status:t,statusText:r,error:n}){g(this,"headers"),g(this,"status"),g(this,"statusText"),g(this,"error"),this.headers=e,this.status=t,this.statusText=r,this.error=n}};p(k,"HTTPResponseError");var N=((a=N||{})[a.Continue=100]="Continue",a[a.SwitchingProtocols=101]="SwitchingProtocols",a[a.Processing=102]="Processing",a[a.EarlyHints=103]="EarlyHints",a[a.Ok=200]="Ok",a[a.Created=201]="Created",a[a.Accepted=202]="Accepted",a[a.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",a[a.NoContent=204]="NoContent",a[a.ResetContent=205]="ResetContent",a[a.PartialContent=206]="PartialContent",a[a.MultiStatus=207]="MultiStatus",a[a.AlreadyReported=208]="AlreadyReported",a[a.ImUsed=226]="ImUsed",a[a.MultipleChoices=300]="MultipleChoices",a[a.MovedPermanently=301]="MovedPermanently",a[a.Found=302]="Found",a[a.SeeOther=303]="SeeOther",a[a.NotModified=304]="NotModified",a[a.UseProxy=305]="UseProxy",a[a.Unused=306]="Unused",a[a.TemporaryRedirect=307]="TemporaryRedirect",a[a.PermanentRedirect=308]="PermanentRedirect",a[a.BadRequest=400]="BadRequest",a[a.Unauthorized=401]="Unauthorized",a[a.PaymentRequired=402]="PaymentRequired",a[a.Forbidden=403]="Forbidden",a[a.NotFound=404]="NotFound",a[a.MethodNotAllowed=405]="MethodNotAllowed",a[a.NotAcceptable=406]="NotAcceptable",a[a.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",a[a.RequestTimeout=408]="RequestTimeout",a[a.Conflict=409]="Conflict",a[a.Gone=410]="Gone",a[a.LengthRequired=411]="LengthRequired",a[a.PreconditionFailed=412]="PreconditionFailed",a[a.PayloadTooLarge=413]="PayloadTooLarge",a[a.UriTooLong=414]="UriTooLong",a[a.UnsupportedMediaType=415]="UnsupportedMediaType",a[a.RangeNotSatisfiable=416]="RangeNotSatisfiable",a[a.ExpectationFailed=417]="ExpectationFailed",a[a.ImATeapot=418]="ImATeapot",a[a.MisdirectedRequest=421]="MisdirectedRequest",a[a.UnprocessableEntity=422]="UnprocessableEntity",a[a.Locked=423]="Locked",a[a.FailedDependency=424]="FailedDependency",a[a.TooEarly=425]="TooEarly",a[a.UpgradeRequired=426]="UpgradeRequired",a[a.PreconditionRequired=428]="PreconditionRequired",a[a.TooManyRequests=429]="TooManyRequests",a[a.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",a[a.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",a[a.InternalServerError=500]="InternalServerError",a[a.NotImplemented=501]="NotImplemented",a[a.BadGateway=502]="BadGateway",a[a.ServiceUnavailable=503]="ServiceUnavailable",a[a.GatewayTimeout=504]="GatewayTimeout",a[a.HttpVersionNotSupported=505]="HttpVersionNotSupported",a[a.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",a[a.InsufficientStorage=507]="InsufficientStorage",a[a.LoopDetected=508]="LoopDetected",a[a.NotExtended=510]="NotExtended",a[a.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired",a);function A(e,t){let r=new Uint8Array(t),n=0;for(let t of e)r.set(t,n),n+=t.length;return r}p(class{send(e){return new l.Observable(t=>{let r=new AbortController;return this._send(e,t,r).then(()=>{},e=>{t.error(new k({error:e}))}),()=>r.abort()})}async _send(e,t,r){var n,i;let a;try{let t=this._parseFetchParamsFromRequest(e);a=await fetch(e.getUrlWithParams(),{signal:r.signal,...t})}catch(e){t.error(new k({error:e,status:null!=(n=e.status)?n:0,statusText:null!=(i=e.statusText)?i:"Unknown Error",headers:e.headers}));return}let o=new v(a.headers),s=a.status,l=a.statusText,d=null;a.body&&(d=await this._readBody(e,a,t)),s>=N.Ok&&s<N.MultipleChoices?t.next(new D({body:d,headers:o,status:s,statusText:l})):t.error(new k({error:d,status:s,statusText:l,headers:o})),t.complete()}async _readBody(e,t,r){var n,i;let a,o;let s=[],l=t.body.getReader(),d=t.headers.get("content-length"),u=0,c=null==(n=e.requestParams)?void 0:n.reportProgress,h=e.responseType;for(;;){let{done:e,value:t}=await l.read();if(e)break;s.push(t),u+=t.length,c&&"text"===h&&(a=(null!=a?a:"")+(null!=o?o:o=new TextDecoder).decode(t,{stream:!0}),r.next(new U(d?Number.parseInt(d,10):void 0,u,a)))}let m=A(s,u);try{let r=null!=(i=t.headers.get("content-type"))?i:"";return L(e,m,r)}catch(e){return r.error(new k({error:e,status:t.status,statusText:t.statusText,headers:new v(t.headers)})),null}}_parseFetchParamsFromRequest(e){return{method:e.method,headers:e.getHeadersInit(),body:e.getBody(),credentials:e.withCredentials?"include":void 0}}},"FetchHTTPImplementation"),p(A,"mergeChunks");let x=/^\)\]\}',?\n/;function L(e,t,r){switch(e.responseType){case"json":let n=new TextDecoder().decode(t).replace(x,"");return""===n?null:JSON.parse(n);case"text":return new TextDecoder().decode(t);case"blob":return new Blob([t],{type:r});case"arraybuffer":return t.buffer;default:throw Error(`[FetchHTTPImplementation]: unknown response type: ${e.responseType}.`)}}p(L,"deserialize");let V=class{send(e){return new l.Observable(t=>{let r=new XMLHttpRequest;r.open(e.method,e.getUrlWithParams()),e.withCredentials&&(r.withCredentials=!0),e.headers.forEach((e,t)=>r.setRequestHeader(e,t.join(","))),e.headers.has("Accept")||r.setRequestHeader("Accept","application/json, text/plain, */*"),e.headers.has("Content-Type")||r.setRequestHeader("Content-Type","application/json;charset=UTF-8");let n=/* @__PURE__ */p(()=>{let e=r.statusText||"OK";return new P(new v(r.getAllResponseHeaders()),r.status,e)},"buildResponseHeader"),i=/* @__PURE__ */p(()=>{let{headers:i,statusText:a,status:o}=n(),{responseType:s}=e,l=null,d=null;o!==N.NoContent&&(l=typeof r.response>"u"?r.responseText:r.response);let u=o>=200&&o<300;if("json"===s&&"string"==typeof l){let e=l;try{l=l?JSON.parse(l):null}catch(t){u=!1,l=e,d=t}}u?t.next(new D({body:l,headers:i,status:o,statusText:a})):t.error(new k({error:d,headers:i,status:o,statusText:a}))},"onLoadHandler"),a=/* @__PURE__ */p(e=>{let i=new k({error:e,status:r.status||0,statusText:r.statusText||"Unknown Error",headers:n().headers});t.error(i)},"onErrorHandler");r.addEventListener("load",i),r.addEventListener("error",a),r.addEventListener("abort",a),r.addEventListener("timeout",a);let o=e.getBody();return r.send(o),()=>{r.readyState!==r.DONE&&r.abort(),r.removeEventListener("load",i),r.removeEventListener("error",a),r.removeEventListener("abort",a),r.removeEventListener("timeout",a)}})}};p(V,"XHRHTTPImplementation");let F=(0,o.createIdentifier)("univer.socket"),j=class extends o.Disposable{createSocket(e){try{let t=new WebSocket(e),r=new o.DisposableCollection;return{URL:e,close:/* @__PURE__ */p((e,n)=>{t.close(e,n),r.dispose()},"close"),send:/* @__PURE__ */p(e=>{t.send(e)},"send"),open$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("open",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("open",n)))}).pipe((0,c.share)()),close$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("close",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("close",n)))}).pipe((0,c.share)()),error$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("error",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("error",n)))}).pipe((0,c.share)()),message$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("message",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("message",n)))}).pipe((0,c.share)())}}catch(e){return console.error(e),null}}};p(j,"WebSocketService");let H=j;/* @__PURE__ */(e=300)=>{let t=/* @__PURE__ */p(()=>{},"noop");return r=>new Promise(r=>{t();let n=setTimeout(()=>{r(!0)},e);t=/* @__PURE__ */p(()=>{clearTimeout(n),r(!1)},"cancel")})},/* @__PURE__ */()=>(e,t)=>t.map(t=>({config:t,result:e}))}),i("fsrAq",function(t,r){e(t.exports,"catchError",function(){return function e(t){return(0,o.operate)(function(r,n){var o,s=null,l=!1;s=r.subscribe((0,a.createOperatorSubscriber)(n,void 0,void 0,function(a){o=(0,i.innerFrom)(t(a,e(t)(r))),s?(s.unsubscribe(),s=null,o.subscribe(n)):l=!0})),l&&(s.unsubscribe(),s=null,o.subscribe(n))})}});var i=n("jzqEI"),a=n("hMcgT"),o=n("jaOYC")}),i("3W2QR",function(t,r){e(t.exports,"throwError",function(){return o});var i=n("3KKCW"),a=n("im29J");function o(e,t){var r=(0,a.isFunction)(e)?e:function(){return e},n=function(e){return e.error(r())};return new i.Observable(t?function(e){return t.schedule(n,0,e)}:n)}}),i("1fKgN",function(t,r){e(t.exports,"concatMap",function(){return o});var i=n("9e68V"),a=n("im29J");function o(e,t){return(0,a.isFunction)(t)?(0,i.mergeMap)(e,t,1):(0,i.mergeMap)(e,1)}}),i("dORxZ",function(t,r){e(t.exports,"retry",function(){return d});var i=n("jaOYC"),a=n("hMcgT"),o=n("agvo5"),s=n("bspY6"),l=n("jzqEI");function d(e){void 0===e&&(e=1/0);var t,r=(t=e&&"object"==typeof e?e:{count:e}).count,n=void 0===r?1/0:r,d=t.delay,u=t.resetOnSuccess,c=void 0!==u&&u;return n<=0?o.identity:(0,i.operate)(function(e,t){var r,i=0,o=function(){var u=!1;r=e.subscribe((0,a.createOperatorSubscriber)(t,function(e){c&&(i=0),t.next(e)},void 0,function(e){if(i++<n){var c=function(){r?(r.unsubscribe(),r=null,o()):u=!0};if(null!=d){var h="number"==typeof d?(0,s.timer)(d):(0,l.innerFrom)(d(e,i)),m=(0,a.createOperatorSubscriber)(t,function(){m.unsubscribe(),c()},function(){t.complete()});h.subscribe(m)}else c()}else t.error(e)})),u&&(r.unsubscribe(),r=null,o())};o()})}}),i("iCLKQ",function(r,i){e(r.exports,"SetCrosshairHighlightColorOperation",function(){return N}),e(r.exports,"EnableCrosshairHighlightOperation",function(){return A}),e(r.exports,"DisableCrosshairHighlightOperation",function(){return x});var a=n("83KcA"),o=n("D79YY"),s=n("cahIb"),l=n("jv4BO"),d=n("5WWyv"),u=n("fElJC"),c=n("d0sRG"),h=n("01IGc"),m=n("6cCiq"),p=n("gQuIR"),g=n("1dwVM"),f=n("11kpD"),v=n("ls2nu"),_=Object.defineProperty,I=(e,t,r)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,S=(e,t)=>_(e,"name",{value:t,configurable:!0}),C=(e,t,r)=>I(e,"symbol"!=typeof t?t+"":t,r),y=function(){return(y=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},b=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},w=(0,p.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=b(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,p.useRef)("_".concat(M()));return R(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},y({ref:t,className:s},o),a)});function R(e,t,r,n,i){return(0,p.createElement)(e.tag,y(y({key:t},E(e,r,i)),n),(T(e,r).children||[]).map(function(n,a){return R(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function E(e,t,r){var n=y({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function T(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?y(y({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?y(y({},e),{attrs:y(y({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function M(){return Math.random().toString(36).substring(2,8)}S(R,"render"),S(E,"replaceRuntimeIdsAndExtInAttrs"),S(T,"replaceRuntimeIdsInDefs"),S(M,"generateShortUuid"),w.displayName="UniverIcon";var O={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"#E5E5E5",d:"M1.6499 3.65002C1.6499 2.54545 2.54533 1.65002 3.6499 1.65002H12.3499C13.4545 1.65002 14.3499 2.54545 14.3499 3.65002V12.35C14.3499 13.4546 13.4545 14.35 12.3499 14.35H3.6499C2.54533 14.35 1.6499 13.4546 1.6499 12.35V3.65002Z"}},{tag:"path",attrs:{fill:"#fff",d:"M9.9998 1.65002H5.9998V6H1.6499V10H5.9998V14.35H9.9998V10H14.3499V6H9.9998V1.65002Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.6498 1.05005C2.21386 1.05005 1.0498 2.21411 1.0498 3.65005V12.35C1.0498 13.786 2.21386 14.95 3.6498 14.95H12.3498C13.7857 14.95 14.9498 13.786 14.9498 12.3501V3.65005C14.9498 2.21411 13.7857 1.05005 12.3498 1.05005H3.6498ZM5.4002 2.25005H3.6498C2.87661 2.25005 2.2498 2.87685 2.2498 3.65005V5.40002H5.4002V2.25005ZM2.2498 10.6V12.35C2.2498 13.1232 2.87661 13.75 3.6498 13.75H5.4002V10.6H2.2498ZM6.60019 13.75H9.4002V9.40002H13.7498V6.60002H9.4002V2.25005H6.60019V6.60002H2.25029V9.40002H6.60019V13.75ZM10.6002 2.25005V5.40002H13.7498V3.65005C13.7498 2.87685 13.123 2.25005 12.3498 2.25005H10.6002ZM13.7498 10.6H10.6002V13.75H12.3498C13.123 13.75 13.7498 13.1232 13.7498 12.3501V10.6Z",fillRule:"evenodd",clipRule:"evenodd"}}]},D=(0,p.forwardRef)(function(e,t){return(0,p.createElement)(w,Object.assign({},e,{id:"cross-highlighting-single",ref:t,icon:O}))});D.displayName="CrossHighlightingSingle";let U=["rgba(158, 109, 227, 0.3)","rgba(254, 75, 75, 0.3)","rgba(255, 140, 81, 0.3)","rgba(164, 220, 22, 0.3)","rgba(45, 174, 255, 0.3)","rgba(58, 96, 247, 0.3)","rgba(242, 72, 166, 0.3)","rgba(153, 153, 153, 0.3)","rgba(158, 109, 227, 0.15)","rgba(254, 75, 75, 0.15)","rgba(255, 140, 81, 0.15)","rgba(164, 220, 22, 0.15)","rgba(45, 174, 255, 0.15)","rgba(58, 96, 247, 0.15)","rgba(242, 72, 166, 0.15)","rgba(153, 153, 153, 0.15)"],P=class extends a.Disposable{constructor(){super(...arguments),C(this,"_enabled$",new l.BehaviorSubject(!1)),C(this,"enabled$",this._enabled$.asObservable()),C(this,"_color$",new l.BehaviorSubject(U[0])),C(this,"color$",this._color$.asObservable())}get enabled(){return this._enabled$.getValue()}get color(){return this._color$.getValue()}dispose(){this._enabled$.complete()}setEnabled(e){this._enabled$.next(e)}setColor(e){this._color$.next(e)}};S(P,"SheetsCrosshairHighlightService");let k={id:"sheet.operation.toggle-crosshair-highlight",type:a.CommandType.OPERATION,handler(e){let t=e.get(P),r=t.enabled;return t.setEnabled(!r),!0}},N={id:"sheet.operation.set-crosshair-highlight-color",type:a.CommandType.OPERATION,handler(e,{value:t}){let r=e.get(P);return r.enabled||r.setEnabled(!0),r.setColor(t),!0}},A={id:"sheet.operation.enable-crosshair-highlight",type:a.CommandType.OPERATION,handler(e){let t=e.get(P);return!t.enabled&&(t.setEnabled(!0),!0)}},x={id:"sheet.operation.disable-crosshair-highlight",type:a.CommandType.OPERATION,handler(e){let t=e.get(P);return!!t.enabled&&(t.setEnabled(!1),!0)}};function L(e){let{onChange:r}=e,n=(0,a.useDependency)(P),i=(0,a.useObservable)(n.color$),o=(0,p.useCallback)(e=>{null==r||r(e)},[r]);return /* @__PURE__ *//*@__PURE__*/t(p).createElement("div",{className:"univer-crosshair-highlight-overlay"},U.map(e=>/* @__PURE__ *//*@__PURE__*/t(p).createElement("div",{key:e,className:(0,g.default)("univer-crosshair-highlight-item",{"univer-crosshair-highlight-item-selected":e===i}),style:{backgroundColor:e},onClick:/* @__PURE__ */S(()=>o(e),"onClick")})))}S(L,"CrosshairOverlay");let V="CROSSHAIR_HIGHLIGHT_OVERLAY_COMPONENT";function F(e){let t=e.get(P);return{id:k.id,tooltip:"crosshair.button.tooltip",type:s.MenuItemType.BUTTON_SELECTOR,icon:"CrossHighlightingSingle",selections:[{label:{name:V,hoverable:!1}}],selectionsCommandId:N.id,activated$:t.enabled$,hidden$:(0,s.getMenuHiddenObservable)(e,a.UniverInstanceType.UNIVER_SHEET)}}S(F,"CrosshairHighlightMenuItemFactory");let j={[s.ContextMenuPosition.FOOTER_MENU]:{[s.ContextMenuGroup.OTHERS]:{[k.id]:{order:0,menuItemFactory:F}}}};var H,$=Object.defineProperty,B=Object.getOwnPropertyDescriptor,W=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?B(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&$(t,r,a),a},"__decorateClass$2"),G=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let Y=(S(H=class extends a.Disposable{constructor(e,t,r){super(),this._componentMgr=e,this._menuManagerService=t,this._cmdSrv=r,this._initCommands(),this._initMenus(),this._initComponents()}_initCommands(){[k,N,A,x].forEach(e=>this._cmdSrv.registerCommand(e))}_initMenus(){this._menuManagerService.mergeMenu(j)}_initComponents(){this._componentMgr.register(V,L),this._componentMgr.register("CrossHighlightingSingle",D)}},"SheetsCrosshairHighlightController"),H);Y=W([G(0,(0,a.Inject)(s.ComponentManager)),G(1,s.IMenuManagerService),G(2,a.ICommandService)],Y);let z=class{constructor(){C(this,"_selectedRanges",[]),C(this,"_ranges",[])}addRange(e){if(e.rangeType===a.RANGE_TYPE.COLUMN||e.rangeType===a.RANGE_TYPE.ROW||e.rangeType===a.RANGE_TYPE.ALL)return;let t=this._getIntersects(e),r=this._getSplitRanges(e,t);r.length>0&&this._ranges.push(...r)}setSelectedRanges(e){this._selectedRanges=e}_getSplitRanges(e,t){let r=[e];for(let e of t.concat(this._selectedRanges)){let t=[];for(let n of r){let r=(0,a.Rectangle).subtract(n,e);r&&r.length>0&&t.push(...r)}r=t}return r.filter(e=>e.startRow<=e.endRow&&e.startColumn<=e.endColumn)}_getIntersects(e){let t=[];for(let r of this._ranges){let n=(0,a.Rectangle).getIntersects(r,e);n&&t.push(n)}return t}getRanges(){return this._ranges}reset(){this._ranges=[],this._selectedRanges=[]}};S(z,"CrossHairRangeCollection");let K=class extends o.Shape{constructor(e,t){super(e,t),C(this,"_color"),t&&this.setShapeProps(t)}setShapeProps(e){"u">typeof e.color&&(this._color=e.color),this.transformByState({width:e.width,height:e.height})}_draw(e){let t=`rgba(${this._color.r}, ${this._color.g}, ${this._color.b}, ${this._color.a})`;(0,o.Rect).drawWith(e,{width:this.width,height:this.height,fill:t,stroke:void 0,strokeWidth:0,evented:!1})}};S(K,"SheetCrossHairHighlightShape");var q,X=Object.defineProperty,Z=Object.getOwnPropertyDescriptor,Q=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&X(t,r,a),a},"__decorateClass$1"),J=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let ee=(S(q=class extends a.Disposable{constructor(e,t,r,n,i,a){super(),C(this,"_shapes",[]),C(this,"_rangeCollection",new z),C(this,"_color","rgba(255,0,0,0.5)"),this._context=e,this._sheetSkeletonManagerService=t,this._sheetsSelectionsService=r,this._sheetsCrosshairHighlightService=n,this._contextService=i,this._refSelectionsService=a,this._initRenderListener()}_transformSelection(e,t){if(!e)return;let r=t.getRowCount(),n=t.getColumnCount(),i=[];for(let t of e){let{startRow:e,endRow:a,startColumn:o,endColumn:s}=t.range;a-e+1===r||s-o+1===n||i.push(t.range)}for(let e of(this._rangeCollection.setSelectedRanges(i),i))this.addSelection(e,t)}_initRenderListener(){let e=this._context.unit;this.disposeWithMe((0,d.combineLatest)([this._contextService.subscribeContextValue$(v.DISABLE_NORMAL_SELECTIONS).pipe((0,h.startWith)(!1)),this._sheetSkeletonManagerService.currentSkeleton$,this._sheetsCrosshairHighlightService.enabled$,this._sheetsCrosshairHighlightService.color$.pipe((0,m.tap)(e=>this._color=e)),(0,c.merge)(this._sheetsSelectionsService.selectionMoveStart$,this._sheetsSelectionsService.selectionMoving$,this._sheetsSelectionsService.selectionMoveEnd$,e.activeSheet$.pipe((0,u.map)(()=>this._sheetsSelectionsService.getCurrentSelections()))),(0,c.merge)(this._refSelectionsService.selectionMoveStart$,this._refSelectionsService.selectionMoving$,this._refSelectionsService.selectionMoveEnd$,e.activeSheet$.pipe((0,u.map)(()=>this._refSelectionsService.getCurrentSelections())))]).subscribe(([t,r,n,i,a,o])=>{this._clear(),n&&(this._rangeCollection.reset(),this._transformSelection(t?o:a,e.getActiveSheet()),this.render(this._rangeCollection.getRanges()))}))}addSelection(e,t){if(e.rangeType===a.RANGE_TYPE.COLUMN||e.rangeType===a.RANGE_TYPE.ROW||e.rangeType===a.RANGE_TYPE.ALL)return;let r=t.getRowCount(),n=t.getColumnCount(),{startRow:i,endRow:o,startColumn:s,endColumn:l}=e;for(let e of[{startRow:i,endRow:o,startColumn:0,endColumn:s-1},{startRow:i,endRow:o,startColumn:l+1,endColumn:n},{startRow:0,endRow:i-1,startColumn:s,endColumn:l},{startRow:o+1,endRow:r,startColumn:s,endColumn:l}])e.startRow<=e.endRow&&e.startColumn<=e.endColumn&&this._rangeCollection.addRange(e)}_clear(){this._shapes.forEach(e=>{e.dispose()}),this._shapes=[]}_addShapes(e,t,r,n){let{startRow:i,endRow:o,startColumn:s,endColumn:l}=e,d=(0,f.getCoordByCell)(i,s,r,n),u=(0,f.getCoordByCell)(o,l,r,n),{startX:c,startY:h}=d,{endX:m,endY:p}=u,g=new K(`crosshair-${t}`,{left:c,top:h,color:new(0,a.ColorKit)(this._color).toRgb(),width:m-c,height:p-h,zIndex:1,evented:!1});this._shapes.push(g),r.addObject(g)}render(e){let t=this._sheetSkeletonManagerService.getCurrentSkeleton();if(!t)return;let{scene:r}=this._context;this._clear();for(let n=0;n<e.length;n++){let i=e[n];this._addShapes(i,n,r,t)}r.makeDirty(!0)}async dispose(){super.dispose()}},"SheetCrosshairHighlightRenderController"),q);ee=Q([J(1,(0,a.Inject)(f.SheetSkeletonManagerService)),J(2,(0,a.Inject)(v.SheetsSelectionsService)),J(3,(0,a.Inject)(P)),J(4,(0,a.Inject)(a.IContextService)),J(5,v.IRefSelectionsService)],ee);let et={};var er,en=Object.defineProperty,ei=Object.getOwnPropertyDescriptor,ea=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ei(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&en(t,r,a),a},"__decorateClass"),eo=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let es=(S(er=class extends a.Plugin{constructor(e=et,t,r,n){super(),this._config=e,this._injector=t,this._renderManagerService=r,this._configService=n;let{...i}=this._config;this._configService.setConfig("sheets-crosshair-highlight.config",i)}onStarting(){[[P],[Y]].forEach(e=>this._injector.add(e))}onReady(){[[ee]].forEach(e=>this._injector.add(e)),this._injector.get(Y),this._renderManagerService.registerRenderModule(a.UniverInstanceType.UNIVER_SHEET,[ee])}},"UniverSheetsCrosshairHighlightPlugin"),C(er,"pluginName","SHEET_CROSSHAIR_HIGHLIGHT_PLUGIN"),C(er,"type",a.UniverInstanceType.UNIVER_SHEET),er);ea([eo(1,(0,a.Inject)(a.Injector)),eo(2,o.IRenderManagerService),eo(3,a.IConfigService)],es)}),i("bnDm9",function(t,r){let i,a;e(t.exports,"getRuleSetting",function(){return v}),e(t.exports,"getRuleOptions",function(){return _}),e(t.exports,"UpdateRuleType",function(){return S}),e(t.exports,"DataValidationModel",function(){return R}),e(t.exports,"AddDataValidationMutation",function(){return E}),e(t.exports,"RemoveDataValidationMutation",function(){return T}),e(t.exports,"UpdateDataValidationMutation",function(){return M}),e(t.exports,"DataValidatorRegistryScope",function(){return N}),e(t.exports,"DataValidatorRegistryService",function(){return x}),e(t.exports,"UniverDataValidationPlugin",function(){return z}),e(t.exports,"TextLengthErrorTitleMap",function(){return X}),e(t.exports,"TWO_FORMULA_OPERATOR_COUNT",function(){return Z}),e(t.exports,"BaseDataValidator",function(){return ea});var o,s,l,d=n("83KcA"),u=n("jv4BO"),c=n("bVip2"),h=n("2Ha4T"),m=Object.defineProperty,p=(e,t,r)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,g=(e,t)=>m(e,"name",{value:t,configurable:!0}),f=(e,t,r)=>p(e,"symbol"!=typeof t?t+"":t,r);function v(e){return{type:e.type,operator:e.operator,formula1:e.formula1,formula2:e.formula2,allowBlank:e.allowBlank}}function _(e){return{error:e.error,errorStyle:e.errorStyle,errorTitle:e.errorTitle,imeMode:e.imeMode,prompt:e.prompt,promptTitle:e.promptTitle,showDropDown:e.showDropDown,showErrorMessage:e.showErrorMessage,showInputMessage:e.showInputMessage,renderMode:e.renderMode,bizInfo:e.bizInfo}}g(v,"getRuleSetting"),g(_,"getRuleOptions");var I,S=((i=S||{})[i.SETTING=0]="SETTING",i[i.RANGE=1]="RANGE",i[i.OPTIONS=2]="OPTIONS",i),C=Object.defineProperty,y=Object.getOwnPropertyDescriptor,b=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?y(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&C(t,r,a),a},"__decorateClass$3"),w=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let R=(I=class extends d.Disposable{constructor(e){super(),f(this,"_model",/* @__PURE__ */new Map),f(this,"_ruleChange$",new h.Subject),f(this,"ruleChange$",this._ruleChange$.asObservable()),f(this,"ruleChangeDebounce$",this.ruleChange$.pipe((0,c.debounceTime)(20))),this._logService=e,this.disposeWithMe({dispose:/* @__PURE__ */g(()=>{this._ruleChange$.complete()},"dispose")})}_ensureMap(e,t){this._model.has(e)||this._model.set(e,/* @__PURE__ */new Map);let r=this._model.get(e);if(r.has(t))return r.get(t);let n={map:/* @__PURE__ */new Map,list:[]};return r.set(t,n),n}_addSubUnitRule(e,t,r){let{map:n,list:i}=e,a=(Array.isArray(t)?t:[t]).filter(e=>!n.has(e.uid));"number"==typeof r&&r<i.length?i.splice(r,0,...a):i.push(...a),a.forEach(e=>{n.set(e.uid,e)})}_removeSubUnitRule(e,t){let{map:r,list:n}=e,i=n.findIndex(e=>e.uid===t);i>-1&&(n.splice(i,1),r.delete(t))}_updateSubUnitRule(e,t,r){let{map:n,list:i}=e,a=n.get(t),o=i.findIndex(e=>t===e.uid);if(!a)throw Error(`Data validation rule is not found, ruleId: ${t}.`);let s={...a};switch(r.type){case S.RANGE:s.ranges=r.payload;break;case S.SETTING:Object.assign(s,v(r.payload));break;case S.OPTIONS:Object.assign(s,_(r.payload))}return i[o]=s,n.set(t,s),s}_addRuleSideEffect(e,t,r,n){if(!this._ensureMap(e,t).map.get(r.uid))return{rule:r,type:"add",unitId:e,subUnitId:t,source:n}}addRule(e,t,r,n,i){try{let a=this._ensureMap(e,t),o=(Array.isArray(r)?r:[r]).map(r=>this._addRuleSideEffect(e,t,r,n));this._addSubUnitRule(a,r,i),o.forEach(e=>{e&&this._ruleChange$.next(e)})}catch(e){this._logService.error(e)}}updateRule(e,t,r,n,i){try{let a=this._ensureMap(e,t),o=(0,d.Tools).deepClone(a.map.get(r));if(!o)throw Error(`Data validation rule is not found, ruleId: ${r}.`);let s=this._updateSubUnitRule(a,r,n);this._ruleChange$.next({rule:s,type:"update",unitId:e,subUnitId:t,source:i,updatePayload:n,oldRule:o})}catch(e){this._logService.error(e)}}removeRule(e,t,r,n){try{let i=this._ensureMap(e,t),a=i.map.get(r);a&&(this._removeSubUnitRule(i,r),this._ruleChange$.next({rule:a,type:"remove",unitId:e,subUnitId:t,source:n}))}catch(e){this._logService.error(e)}}getRuleById(e,t,r){return this._ensureMap(e,t).map.get(r)}getRuleIndex(e,t,r){return this._ensureMap(e,t).list.findIndex(e=>e.uid===r)}getRules(e,t){return[...this._ensureMap(e,t).list]}getUnitRules(e){let t=this._model.get(e);if(!t)return[];let r=[];return t.forEach((e,t)=>{r.push([t,e.list])}),r}deleteUnitRules(e){this._model.delete(e)}getSubUnitIds(e){var t,r;return Array.from(null!=(r=null==(t=this._model.get(e))?void 0:t.keys())?r:[])}getAll(){return Array.from(this._model.keys()).map(e=>[e,this.getUnitRules(e)])}},g(I,"DataValidationModel"),I);R=b([w(0,d.ILogService)],R);let E={type:d.CommandType.MUTATION,id:"data-validation.mutation.addRule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,rule:i,index:a,source:o="command"}=t;return e.get(R).addRule(r,n,i,o,a),!0}},T={type:d.CommandType.MUTATION,id:"data-validation.mutation.removeRule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ruleId:i,source:a="command"}=t,o=e.get(R);return Array.isArray(i)?i.forEach(e=>{o.removeRule(r,n,e,a)}):o.removeRule(r,n,i,a),!0}},M={type:d.CommandType.MUTATION,id:"data-validation.mutation.updateRule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ruleId:i,payload:a,source:o="command"}=t;return e.get(R).updateRule(r,n,i,a,o),!0}};var O=Object.defineProperty,D=Object.getOwnPropertyDescriptor,U=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?D(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&O(t,r,a),a},"__decorateClass$2"),P=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let k=(o=class extends d.Disposable{constructor(e,t,r){super(),this._resourceManagerService=e,this._univerInstanceService=t,this._dataValidationModel=r,this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */g(e=>{let t=this._dataValidationModel.getUnitRules(e),r={};return t?(t.forEach(([e,t])=>{r[e]=t}),JSON.stringify(r)):""},"toJson"),t=/* @__PURE__ */g(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:"SHEET_DATA_VALIDATION_PLUGIN",businesses:[d.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */g(t=>e(t),"toJson"),parseJson:/* @__PURE__ */g(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */g(e=>{this._dataValidationModel.deleteUnitRules(e)},"onUnLoad"),onLoad:/* @__PURE__ */g((e,t)=>{Object.keys(t).forEach(r=>{t[r].forEach(t=>{this._dataValidationModel.addRule(e,r,t,"patched")})})},"onLoad")}))}},g(o,"DataValidationResourceController"),o);k=U([(0,d.OnLifecycle)(d.LifecycleStages.Ready,k),P(0,d.IResourceManagerService),P(1,d.IUniverInstanceService),P(2,(0,d.Inject)(R))],k);var N=((a=N||{}).SHEET="sheet",a);let A=class{constructor(){f(this,"_validatorByScopes",/* @__PURE__ */new Map),f(this,"_validatorMap",/* @__PURE__ */new Map),f(this,"_validatorsChange$",new u.BehaviorSubject(void 0)),f(this,"validatorsChange$",this._validatorsChange$.asObservable())}_addValidatorToScope(e,t){this._validatorByScopes.has(t)||this._validatorByScopes.set(t,[]);let r=this._validatorByScopes.get(t);if(r.findIndex(t=>t.id===e.id)>-1)throw Error(`Validator item with the same id ${e.id} has already been added!`);r.push(e)}_removeValidatorFromScope(e,t){let r=this._validatorByScopes.get(t);if(!r)return;let n=r.findIndex(t=>t.id===e.id);n>-1&&r.splice(n,1)}register(e){return this._validatorMap.set(e.id,e),Array.isArray(e.scopes)?e.scopes.forEach(t=>{this._addValidatorToScope(e,t)}):this._addValidatorToScope(e,e.scopes),this._validatorsChange$.next(),(0,d.toDisposable)(()=>{this._validatorMap.delete(e.id),Array.isArray(e.scopes)?e.scopes.forEach(t=>{this._removeValidatorFromScope(e,t)}):this._removeValidatorFromScope(e,e.scopes),this._validatorsChange$.next()})}getValidatorItem(e){return this._validatorMap.get(e)}getValidatorsByScope(e){return this._validatorByScopes.get(e)}};g(A,"DataValidatorRegistryService");let x=A,L={type:d.CommandType.COMMAND,id:"data-validation.command.addRule",async handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `AddDataValidationCommand` is deprecated, please use `AddSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let{rule:r,unitId:n,subUnitId:i}=t,a=e.get(d.ICommandService),o=e.get(d.IUndoRedoService),s={...t,rule:{...t.rule,ranges:[t.rule.range]}},l=[{id:E.id,params:s}],u=[{id:T.id,params:{unitId:n,subUnitId:i,ruleId:r.uid}}];return o.pushUndoRedo({unitID:n,redoMutations:l,undoMutations:u}),await a.executeCommand(E.id,s),!0}},V={type:d.CommandType.COMMAND,id:"data-validation.command.removeRule",handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `RemoveDataValidationCommand` is deprecated, please use `RemoveSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let{unitId:r,subUnitId:n,ruleId:i}=t,a=e.get(d.ICommandService),o=e.get(d.IUndoRedoService),s=e.get(R),l=[{id:T.id,params:t}],u=[{id:E.id,params:{unitId:r,subUnitId:n,rule:{...s.getRuleById(r,n,i)},index:s.getRuleIndex(r,n,i)}}];return o.pushUndoRedo({undoMutations:u,redoMutations:l,unitID:t.unitId}),a.executeCommand(T.id,t),!0}},F={type:d.CommandType.COMMAND,id:"data-validation.command.updateDataValidationSetting",handler(e,t){if(e.get(d.ILogService).warn("[Deprecated]: `UpdateDataValidationOptionsCommand` is deprecated, please use `UpdateSheetDataValidationOptionsCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let r=e.get(d.ICommandService),n=e.get(d.IUndoRedoService),i=e.get(R),{unitId:a,subUnitId:o,ruleId:s,options:l}=t,u=i.getRuleById(a,o,s);if(!u)return!1;let c={unitId:a,subUnitId:o,ruleId:s,payload:{type:S.OPTIONS,payload:l}},h=[{id:M.id,params:c}],m={unitId:a,subUnitId:o,ruleId:s,payload:{type:S.OPTIONS,payload:_(u)}},p=[{id:M.id,params:m}];return n.pushUndoRedo({unitID:a,redoMutations:h,undoMutations:p}),r.executeCommand(M.id,c),!0}},j={type:d.CommandType.COMMAND,id:"data-validation.command.updateDataValidationOptions",handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `UpdateDataValidationSettingCommand` is deprecated, please use `UpdateSheetDataValidationSettingCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let r=e.get(d.ICommandService),n=e.get(d.IUndoRedoService),i=e.get(R),a=e.get(x),{unitId:o,subUnitId:s,ruleId:l,setting:u}=t,c=a.getValidatorItem(u.type);if(!c)return!1;let h=i.getRuleById(o,s,l);if(!h)return!1;let m={...h,...u};if(!c.validatorFormula(m,o,s).success)return!1;let p={unitId:o,subUnitId:s,ruleId:l,payload:{type:S.SETTING,payload:{...u,...c.normalizeFormula(m,o,s)}}},g=[{id:M.id,params:p}],f={unitId:o,subUnitId:s,ruleId:l,payload:{type:S.SETTING,payload:v(h)}},_=[{id:M.id,params:f}];return n.pushUndoRedo({unitID:o,redoMutations:g,undoMutations:_}),r.executeCommand(M.id,p),!0}},H={type:d.CommandType.COMMAND,id:"data-validation.command.removeAll",handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `RemoveAllDataValidationCommand` is deprecated, please use `RemoveSheetAllDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let{unitId:r,subUnitId:n}=t,i=e.get(d.ICommandService),a=e.get(R),o=e.get(d.IUndoRedoService),s=[...a.getRules(r,n)],l={unitId:r,subUnitId:n,ruleId:s.map(e=>e.uid)},u=[{id:T.id,params:l}],c=[{id:E.id,params:{unitId:r,subUnitId:n,rule:s}}];return o.pushUndoRedo({redoMutations:u,undoMutations:c,unitID:r}),i.executeCommand(T.id,l),!0}},$={};var B=Object.defineProperty,W=Object.getOwnPropertyDescriptor,G=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?W(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&B(t,r,a),a},"__decorateClass$1"),Y=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let z=(g(s=class extends d.Plugin{constructor(e=$,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{...i}=this._config;this._configService.setConfig("data-validation.config",i)}onStarting(){[[R],[x],[k]].forEach(e=>this._injector.add(e)),[L,H,F,j,V,E,M,T].forEach(e=>{this._commandService.registerCommand(e)})}},"UniverDataValidationPlugin"),f(s,"pluginName","UNIVER_DATA_VALIDATION_PLUGIN"),f(s,"type",d.UniverInstanceType.UNIVER_SHEET),s);z=G([Y(1,(0,d.Inject)(d.Injector)),Y(2,d.ICommandService),Y(3,d.IConfigService)],z),d.DataValidationOperator.BETWEEN,d.DataValidationOperator.EQUAL,d.DataValidationOperator.GREATER_THAN,d.DataValidationOperator.GREATER_THAN_OR_EQUAL,d.DataValidationOperator.LESS_THAN,d.DataValidationOperator.LESS_THAN_OR_EQUAL,d.DataValidationOperator.NOT_BETWEEN,d.DataValidationOperator.NOT_EQUAL;let K={[d.DataValidationOperator.BETWEEN]:"dataValidation.ruleName.between",[d.DataValidationOperator.EQUAL]:"dataValidation.ruleName.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.ruleName.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.ruleName.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.ruleName.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.ruleName.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.ruleName.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.ruleName.notEqual"},q={[d.DataValidationOperator.BETWEEN]:"dataValidation.errorMsg.between",[d.DataValidationOperator.EQUAL]:"dataValidation.errorMsg.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.errorMsg.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.errorMsg.notEqual"},X={[d.DataValidationOperator.BETWEEN]:"dataValidation.textLength.errorMsg.between",[d.DataValidationOperator.EQUAL]:"dataValidation.textLength.errorMsg.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.textLength.errorMsg.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.textLength.errorMsg.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.textLength.errorMsg.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.textLength.errorMsg.notEqual"},Z=[d.DataValidationOperator.BETWEEN,d.DataValidationOperator.NOT_BETWEEN];var Q=Object.defineProperty,J=Object.getOwnPropertyDescriptor,ee=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?J(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&Q(t,r,a),a},"__decorateClass"),et=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let er="{FORMULA1}",en="{FORMULA2}",ei={[d.DataValidationOperator.BETWEEN]:"dataValidation.operators.between",[d.DataValidationOperator.EQUAL]:"dataValidation.operators.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.operators.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.operators.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.operators.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.operators.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.operators.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.operators.notEqual"},ea=(g(l=class{constructor(e,t){f(this,"canvasRender",null),f(this,"dropdown"),f(this,"optionsInput"),this.localeService=e,this.injector=t}get operatorNames(){return this.operators.map(e=>this.localeService.t(ei[e]))}get titleStr(){return this.localeService.t(this.title)}skipDefaultFontRender(e,t,r){return!1}generateRuleName(e){var t,r;if(!e.operator)return this.titleStr;let n=this.localeService.t(K[e.operator]).replace(er,null!=(t=e.formula1)?t:"").replace(en,null!=(r=e.formula2)?r:"");return`${this.titleStr} ${n}`}generateRuleErrorMessage(e){var t,r;return e.operator?`${this.localeService.t(q[e.operator]).replace(er,null!=(t=e.formula1)?t:"").replace(en,null!=(r=e.formula2)?r:"")}`:this.titleStr}getExtraStyle(e,t,r){}getRuleFinalError(e){return e.showErrorMessage&&e.error?e.error:this.generateRuleErrorMessage(e)}isEmptyCellValue(e){return""===e||null==e}normalizeFormula(e,t,r){return{formula1:e.formula1,formula2:e.formula2}}async isValidType(e,t,r){return!0}transform(e,t,r){return e}async validatorIsEqual(e,t,r){return!0}async validatorIsNotEqual(e,t,r){return!0}async validatorIsBetween(e,t,r){return!0}async validatorIsNotBetween(e,t,r){return!0}async validatorIsGreaterThan(e,t,r){return!0}async validatorIsGreaterThanOrEqual(e,t,r){return!0}async validatorIsLessThan(e,t,r){return!0}async validatorIsLessThanOrEqual(e,t,r){return!0}async validator(e,t){let{value:r,unitId:n,subUnitId:i}=e,a=this.isEmptyCellValue(r),{allowBlank:o=!0,operator:s}=t;if(a)return o;let l=await this.parseFormula(t,n,i);if(!await this.isValidType(e,l,t))return!1;if(!(0,d.Tools).isDefine(s))return!0;let u=this.transform(e,l,t);switch(s){case d.DataValidationOperator.BETWEEN:return this.validatorIsBetween(u,l,t);case d.DataValidationOperator.EQUAL:return this.validatorIsEqual(u,l,t);case d.DataValidationOperator.GREATER_THAN:return this.validatorIsGreaterThan(u,l,t);case d.DataValidationOperator.GREATER_THAN_OR_EQUAL:return this.validatorIsGreaterThanOrEqual(u,l,t);case d.DataValidationOperator.LESS_THAN:return this.validatorIsLessThan(u,l,t);case d.DataValidationOperator.LESS_THAN_OR_EQUAL:return this.validatorIsLessThanOrEqual(u,l,t);case d.DataValidationOperator.NOT_BETWEEN:return this.validatorIsNotBetween(u,l,t);case d.DataValidationOperator.NOT_EQUAL:return this.validatorIsNotEqual(u,l,t);default:throw Error("Unknown operator.")}}},"BaseDataValidator"),l);ea=ee([et(0,(0,d.Inject)(d.LocaleService)),et(1,(0,d.Inject)(d.Injector))],ea)}),i("GkhY6",function(i,a){let o;e(i.exports,"SheetDataValidationModel",function(){return J}),e(i.exports,"UpdateSheetDataValidationRangeCommand",function(){return rC}),e(i.exports,"UpdateSheetDataValidationSettingCommand",function(){return rw}),e(i.exports,"RemoveSheetDataValidationCommand",function(){return rO}),e(i.exports,"UpdateSheetDataValidationOptionsCommand",function(){return rR}),e(i.exports,"AddSheetDataValidationCommand",function(){return ry}),e(i.exports,"RemoveSheetAllDataValidationCommand",function(){return rT}),e(i.exports,"ClearRangeDataValidationCommand",function(){return rE}),e(i.exports,"SheetsDataValidationValidatorService",function(){return nN}),e(i.exports,"DataValidationModel",function(){return n("bnDm9").DataValidationModel});var s=n("83KcA"),l=n("bnDm9"),d=n("ls2nu"),u=n("kkAWv"),c=n("jv4BO"),h=n("bbuk8"),m=n("bVip2"),p=n("eSxk0"),g=n("a9FIH"),f=n("2Ha4T"),v=n("kqxPe"),_=n("gQuIR"),I=n("bLx5G"),S=n("cahIb"),C=n("1dwVM"),y=n("D79YY"),b=n("1RqlY"),w=n("11kpD"),R=n("kB4bq"),E=n("61xGp"),T=Object.defineProperty,M=(e,t,r)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,O=(e,t)=>T(e,"name",{value:t,configurable:!0}),D=(e,t,r)=>M(e,"symbol"!=typeof t?t+"":t,r);let U=class{constructor(){D(this,"_cacheMatrix",/* @__PURE__ */new Map)}_ensureCache(e,t){let r=this._cacheMatrix.get(e);r||(r=/* @__PURE__ */new Map,this._cacheMatrix.set(e,r));let n=r.get(t);return n||(n=new s.ObjectMatrix,r.set(t,n)),n}ensureCache(e,t){return this._ensureCache(e,t)}addRule(e,t,r){this.markRangeDirty(e,t,r.ranges)}removeRule(e,t,r){this._deleteRange(e,t,r.ranges)}updateRuleRanges(e,t,r,n,i){let a=this._ensureCache(e,t);i.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let r=a.getValue(e,t);r&&(r.temp=!0)})}),n.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=a.getValue(e,t);n&&n.ruleId===r?n.temp=!1:a.setValue(e,t,void 0)})}),i.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let r=a.getValue(e,t);r&&!0===r.temp&&a.realDeleteValue(e,t)})})}markRangeDirty(e,t,r){let n=this._ensureCache(e,t);r.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{n.setValue(e,t,void 0)})})}markCellDirty(e,t,r,n){this._ensureCache(e,t).setValue(r,n,void 0)}_deleteRange(e,t,r){let n=this._ensureCache(e,t);r.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{n.realDeleteValue(e,t)})})}getValue(e,t,r,n){return this._ensureCache(e,t).getValue(r,n)}setValue(e,t,r,n,i){return this._ensureCache(e,t).setValue(r,n,i)}};O(U,"DataValidationCacheService");var P=Object.defineProperty,k=Object.getOwnPropertyDescriptor,N=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?k(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&P(t,r,a),a},"__decorateClass$k"),A=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$k");function x(e,t,r,n,i,a){return e.moveFormulaRefOffset(t,a-n,i-r)}O(x,"transformFormula");let L=(O(V=class extends s.Disposable{constructor(e,t,r,n,i,a){super(),D(this,"_formulaMap",/* @__PURE__ */new Map),D(this,"_ruleFormulaMap",/* @__PURE__ */new Map),D(this,"_formulaCellMap",/* @__PURE__ */new Map),this._instanceSrv=e,this._registerOtherFormulaService=t,this._lexerTreeBuilder=r,this._dataValidationModel=n,this._dataValidationCacheService=i,this._logService=a,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(let t in e){let r=e[t];if(this._instanceSrv.getUnitType(t)===s.UniverInstanceType.UNIVER_SHEET)for(let e in r){let n=r[e],{formulaCellMap:i,ruleFormulaMap:a}=this._ensureMaps(t,e);n.forEach(r=>{var n,o;let s=a.get(null==(n=r.extra)?void 0:n.ruleId),l=i.get(r.formulaId),d=this._dataValidationModel.getRuleById(t,e,null==(o=r.extra)?void 0:o.ruleId);d&&s&&!s.isTransformable&&this._dataValidationCacheService.markRangeDirty(t,e,d.ranges),l&&this._dataValidationCacheService.markCellDirty(t,e,l.row,l.column)})}}}))}_ensureMaps(e,t){let r=this._formulaMap.get(e),n=this._ruleFormulaMap.get(e),i=this._formulaCellMap.get(e);r&&n&&i||(r=/* @__PURE__ */new Map,n=/* @__PURE__ */new Map,i=/* @__PURE__ */new Map,this._formulaMap.set(e,r),this._ruleFormulaMap.set(e,n),this._formulaCellMap.set(e,i));let a=r.get(t),o=n.get(t),l=i.get(t);return a&&o&&l||(a=new s.ObjectMatrix,r.set(t,a),o=/* @__PURE__ */new Map,n.set(t,o),l=/* @__PURE__ */new Map,i.set(t,l)),{formulaMap:a,ruleFormulaMap:o,formulaCellMap:l}}_registerFormula(e,t,r,n){return this._registerOtherFormulaService.registerFormula(e,t,n,{ruleId:r})}deleteByRuleId(e,t,r){let{formulaMap:n,formulaCellMap:i,ruleFormulaMap:a}=this._ensureMaps(e,t),o=this._dataValidationModel.getRuleById(e,t,r),l=/* @__PURE__ */new Set,d=a.get(r);o&&d&&(a.delete(r),o.ranges.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let a=n.getValue(e,t);if(a&&a.ruleId===r){let{formulaId:r}=a;n.realDeleteValue(e,t),l.add(r),i.delete(r)}})}),this._registerOtherFormulaService.deleteFormula(e,t,Array.from(l.values())))}_addFormulaByRange(e,t,r,n,i){let a;let{formulaMap:o,ruleFormulaMap:l,formulaCellMap:d}=this._ensureMaps(e,t);if(!n)return;let u=i[0].startRow,c=i[0].startColumn;i.forEach(i=>{(0,s.Range).foreach(i,(i,a)=>{let s=x(this._lexerTreeBuilder,n,u,c,i,a),l=this._registerFormula(e,t,r,s);o.setValue(i,a,{formulaId:l,ruleId:r}),d.set(l,{row:i,column:a})})}),l.set(r,{formula:n,originCol:c,originRow:u,formulaId:a,isTransformable:!0})}addRule(e,t,r){let{ranges:n,formula1:i,uid:a,type:o}=r;o===s.DataValidationType.CUSTOM&&i&&(0,s.isFormulaString)(i)&&this._addFormulaByRange(e,t,a,i,n)}updateRuleRanges(e,t,r,n,i){let{formulaMap:a,ruleFormulaMap:o,formulaCellMap:l}=this._ensureMaps(e,t),d=o.get(r);if(!d)return;let{formula:u,originCol:c,originRow:h,isTransformable:m,formulaId:p}=d,g=/* @__PURE__ */new Set;n.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=a.getValue(e,t);n&&n.ruleId===r&&(n.temp=!0)})}),i.forEach(n=>{(0,s.Range).foreach(n,(n,i)=>{var s;let d=null!=(s=a.getValue(n,i))?s:{};if(d.ruleId!==r){let s=o.get(d.ruleId);if(null!=s&&s.isTransformable&&g.add(d.formulaId),m){let o=x(this._lexerTreeBuilder,u,h,c,n,i),s=this._registerFormula(e,t,r,o);a.setValue(n,i,{ruleId:r,formulaId:s}),l.set(s,{row:n,column:i})}else a.setValue(n,i,{ruleId:r,formulaId:p})}else d.temp=!1})}),n.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=a.getValue(e,t);n&&n.ruleId===r&&!0===n.temp&&(a.realDeleteValue(e,t),m&&g.add(n.formulaId))})}),g.forEach(e=>{l.delete(e)}),this._registerOtherFormulaService.deleteFormula(e,t,Array.from(g.values()))}updateRuleFormula(e,t,r,n,i){let{ruleFormulaMap:a}=this._ensureMaps(e,t),o=a.get(r);o&&o.formula===i||this._addFormulaByRange(e,t,r,i,n)}getCellFormulaValue(e,t,r,n){let{formulaMap:i}=this._ensureMaps(e,t),a=i.getValue(r,n);return a?this._registerOtherFormulaService.getFormulaValue(e,t,a.formulaId):Promise.resolve(void 0)}getRuleFormulaInfo(e,t,r){let{ruleFormulaMap:n}=this._ensureMaps(e,t);return n.get(r)}},"DataValidationCustomFormulaService"),V);L=N([A(0,s.IUniverInstanceService),A(1,(0,s.Inject)(v.RegisterOtherFormulaService)),A(2,(0,s.Inject)(u.LexerTreeBuilder)),A(3,(0,s.Inject)(l.DataValidationModel)),A(4,(0,s.Inject)(U)),A(5,s.ILogService)],L);var V,F,j=Object.defineProperty,H=Object.getOwnPropertyDescriptor,$=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?H(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&j(t,r,a),a},"__decorateClass$j"),B=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$j");let W=(F=class extends s.Disposable{constructor(e,t,r,n){super(),D(this,"_formulaRuleMap",/* @__PURE__ */new Map),this._instanceService=e,this._registerOtherFormulaService=t,this._dataValidationCacheService=r,this._dataValidationModel=n,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(let t in e){let r=e[t];if(this._instanceService.getUnitType(t)===s.UniverInstanceType.UNIVER_SHEET)for(let e in r){let n=r[e],i=this._ensureRuleFormulaMap(t,e);n.forEach(r=>{var n,a;if(i.get(null==(n=r.extra)?void 0:n.ruleId)){let n=this._dataValidationModel.getRuleById(t,e,null==(a=r.extra)?void 0:a.ruleId);n&&this._dataValidationCacheService.markRangeDirty(t,e,n.ranges)}})}}}))}_ensureRuleFormulaMap(e,t){let r=this._formulaRuleMap.get(e);r||(r=/* @__PURE__ */new Map,this._formulaRuleMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}addRule(e,t,r,n,i){let a=(0,s.isFormulaString)(n),o=(0,s.isFormulaString)(i);if(!a&&!o)return;let l=this._ensureRuleFormulaMap(e,t),d=[void 0,void 0];if(a){let i=this._registerOtherFormulaService.registerFormula(e,t,n,{ruleId:r});d[0]={id:i,text:n}}if(o){let n=this._registerOtherFormulaService.registerFormula(e,t,i,{ruleId:r});d[1]={id:n,text:i}}l.set(r,d)}removeRule(e,t,r){let n=this._ensureRuleFormulaMap(e,t).get(r);if(!n)return;let[i,a]=n,o=[null==i?void 0:i.id,null==a?void 0:a.id].filter(Boolean);o.length&&this._registerOtherFormulaService.deleteFormula(e,t,o)}updateRuleFormulaText(e,t,r,n,i){let a=this._ensureRuleFormulaMap(e,t).get(r);if(!a){this.addRule(e,t,r,n,i);return}let[o,l]=a;if((null==o?void 0:o.text)!==n){if(o&&this._registerOtherFormulaService.deleteFormula(e,t,[o.id]),(0,s.isFormulaString)(n)){let i=this._registerOtherFormulaService.registerFormula(e,t,n,{ruleId:r});a[0]={text:n,id:i}}else a[0]=void 0}if((null==l?void 0:l.text)!==i){if(l&&this._registerOtherFormulaService.deleteFormula(e,t,[l.id]),(0,s.isFormulaString)(i)){let n=this._registerOtherFormulaService.registerFormula(e,t,i,{ruleId:r});a[1]={text:i,id:n}}else a[1]=void 0}}getRuleFormulaResult(e,t,r){let n=this._ensureRuleFormulaMap(e,t).get(r);if(!n)return Promise.resolve(null);let i=/* @__PURE__ */O(async r=>r&&this._registerOtherFormulaService.getFormulaValue(e,t,r.id),"getResult");return Promise.all([i(n[0]),i(n[1])])}getRuleFormulaResultSync(e,t,r){let n=this._ensureRuleFormulaMap(e,t).get(r);if(n)return n.map(r=>{if(r)return this._registerOtherFormulaService.getFormulaValueSync(e,t,r.id)})}getRuleFormulaInfo(e,t,r){return this._ensureRuleFormulaMap(e,t).get(r)}},O(F,"DataValidationFormulaService"),F);function G(e){return(0,s.getOriginCellValue)(e)}function Y(e){var t;return String(null!=(t=G(e))?t:"")}W=$([B(0,s.IUniverInstanceService),B(1,(0,s.Inject)(v.RegisterOtherFormulaService)),B(2,(0,s.Inject)(U)),B(3,(0,s.Inject)(l.DataValidationModel))],W),O(G,"getCellValueOrigin"),O(Y,"getStringCellValue");let z=class e{constructor(e,t){D(this,"_map",/* @__PURE__ */new Map),this._worksheet=t,this._map=e}addRule(e){let t=e.uid,r=e.ranges.map(e=>(0,s.Range).transformRange(e,this._worksheet));this._map.forEach((e,t)=>{let n=(0,s.Rectangle).subtractMulti(e,r);0===n.length?this._map.delete(t):this._map.set(t,n)}),this._map.set(t,r)}removeRange(e){let t=e.map(e=>(0,s.Range).transformRange(e,this._worksheet));this._map.forEach((e,r)=>{let n=(0,s.Rectangle).subtractMulti(e,t);0===n.length?this._map.delete(r):this._map.set(r,n)})}removeRule(e){this._map.delete(e.uid)}updateRange(e,t){this._map.delete(e);let r=t.map(e=>(0,s.Range).transformRange(e,this._worksheet));this._map.forEach((e,t)=>{let n=(0,s.Rectangle).subtractMulti(e,r);0===n.length?this._map.delete(t):this._map.set(t,n)}),this._map.set(e,r)}diff(e){let t=[],r=0;return e.forEach((e,n)=>{var i;let a=null!=(i=this._map.get(e.uid))?i:[],o=e.ranges;(a.length!==o.length||a.some((e,t)=>!(0,s.Rectangle).equals(e,o[t])))&&t.push({type:"update",ruleId:e.uid,oldRanges:o,newRanges:a}),0===a.length&&(t.push({type:"delete",rule:e,index:n-r}),r++)}),t}diffWithAddition(e,t){let r=[],n=0;return e.forEach((e,t)=>{var i;let a=null!=(i=this._map.get(e.uid))?i:[],o=e.ranges;(a.length!==o.length||a.some((e,t)=>!(0,s.Rectangle).equals(e,o[t])))&&r.push({type:"update",ruleId:e.uid,oldRanges:o,newRanges:a}),0===a.length&&(r.push({type:"delete",rule:e,index:t-n}),n++)}),Array.from(t).forEach(e=>{var t;let n=null!=(t=this._map.get(e.uid))?t:[];r.push({type:"add",rule:{...e,ranges:n}})}),r}clone(){return new e(new Map((0,s.Tools).deepClone(Array.from(this._map.entries()))),this._worksheet)}getValue(e,t){var r;for(let n of Array.from(this._map.keys()))if((null!=(r=this._map.get(n))?r:[]).find(r=>r.startRow<=e&&r.endRow>=e&&r.startColumn<=t&&r.endColumn>=t))return n}addRangeRules(e){e.forEach(({id:e,ranges:t})=>{if(!t.length)return;let r=this._map.get(e);r?(this._map.set(e,(0,s.Rectangle).mergeRanges([...r,...t])),r=this._map.get(e)):(r=t,this._map.set(e,r)),this._map.forEach((r,n)=>{if(n===e)return;let i=(0,s.Rectangle).subtractMulti(r,t);0===i.length?this._map.delete(n):this._map.set(n,i)})})}};O(z,"RuleMatrix");var K,q=Object.defineProperty,X=Object.getOwnPropertyDescriptor,Z=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?X(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&q(t,r,a),a},"__decorateClass$i"),Q=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$i");let J=(K=class extends s.Disposable{constructor(e,t,r,n,i,a){super(),D(this,"_ruleMatrixMap",/* @__PURE__ */new Map),D(this,"_validStatusChange$",new f.Subject),D(this,"_ruleChange$",new f.Subject),D(this,"ruleChange$",this._ruleChange$.asObservable()),D(this,"validStatusChange$",this._validStatusChange$.asObservable()),this._dataValidationModel=e,this._univerInstanceService=t,this._dataValidatorRegistryService=r,this._dataValidationCacheService=n,this._dataValidationFormulaService=i,this._dataValidationCustomFormulaService=a,this._initRuleUpdateListener(),this.disposeWithMe(()=>{this._ruleChange$.complete(),this._validStatusChange$.complete()})}_initRuleUpdateListener(){for(let[e,t]of this._dataValidationModel.getAll())for(let[r,n]of t)for(let t of n)this._ruleChange$.next({type:"add",unitId:e,subUnitId:r,rule:t,source:"patched"}),this._addRule(e,r,t);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{switch(this._ruleChange$.next(e),e.type){case"add":this._addRule(e.unitId,e.subUnitId,e.rule);break;case"update":this._updateRule(e.unitId,e.subUnitId,e.rule.uid,e.oldRule,e.updatePayload);break;case"remove":this._removeRule(e.unitId,e.subUnitId,e.rule)}}))}_ensureRuleMatrix(e,t){let r=this._ruleMatrixMap.get(e),n=this._univerInstanceService.getUnit(e,s.UniverInstanceType.UNIVER_SHEET);if(!n)throw Error(`workbook not found, unitId: ${e}`);r||(r=/* @__PURE__ */new Map,this._ruleMatrixMap.set(e,r));let i=r.get(t);if(!i){let a=n.getSheetBySheetId(t);if(!a)throw Error(`worksheet not found, unitId: ${e}, subUnitId: ${t}`);i=new z(/* @__PURE__ */new Map,a),r.set(t,i)}return i}_addRuleSideEffect(e,t,r){var n;(r.type===s.DataValidationType.LIST||r.type===s.DataValidationType.LIST_MULTIPLE)&&(0,u.isReferenceString)(null!=(n=r.formula1)?n:"")&&(r.formula1=`=${r.formula1}`),this._ensureRuleMatrix(e,t).addRule(r),this._dataValidationCacheService.addRule(e,t,r),this._dataValidationFormulaService.addRule(e,t,r.uid,r.formula1,r.formula2),this._dataValidationCustomFormulaService.addRule(e,t,r)}_addRule(e,t,r){(Array.isArray(r)?r:[r]).forEach(r=>{this._addRuleSideEffect(e,t,r)})}_updateRule(e,t,r,n,i){let a=this._ensureRuleMatrix(e,t);i.type===l.UpdateRuleType.RANGE?(a.updateRange(r,i.payload),this._dataValidationCacheService.updateRuleRanges(e,t,r,i.payload,n.ranges),this._dataValidationCustomFormulaService.updateRuleRanges(e,t,r,n.ranges,i.payload)):i.type===l.UpdateRuleType.SETTING&&(this._dataValidationCacheService.markRangeDirty(e,t,n.ranges),this._dataValidationFormulaService.updateRuleFormulaText(e,t,r,i.payload.formula1,i.payload.formula2),this._dataValidationCustomFormulaService.updateRuleFormula(e,t,r,n.ranges,i.payload.formula1))}_removeRule(e,t,r){this._ensureRuleMatrix(e,t).removeRule(r),this._dataValidationCacheService.removeRule(e,t,r)}getValidator(e){return this._dataValidatorRegistryService.getValidatorItem(e)}getRuleIdByLocation(e,t,r,n){return this._ensureRuleMatrix(e,t).getValue(r,n)}getRuleByLocation(e,t,r,n){let i=this.getRuleIdByLocation(e,t,r,n);if(i)return this._dataValidationModel.getRuleById(e,t,i)}validator(e,t,r,n){let{col:i,row:a,unitId:o,subUnitId:l,worksheet:d}=r,u=t.uid,c=/* @__PURE__ */O((e,r)=>{n&&n(e,r),r&&this._validStatusChange$.next({unitId:o,subUnitId:l,ruleId:t.uid,status:e})},"onCompete"),h=this.getValidator(t.type),m=d.getCellRaw(a,i),p=G(m),g=G(e);if(!h)return c(s.DataValidationStatus.VALID,!1),s.DataValidationStatus.VALID;{let n=this._dataValidationCacheService.ensureCache(o,l),d=n.getValue(a,i);return d&&d.value===p&&d.interceptValue===g&&d.ruleId===u?(c(d.status,!1),d.status):(n.setValue(a,i,{value:p,interceptValue:g,status:s.DataValidationStatus.VALIDATING,ruleId:u}),h.validator({value:p,unitId:o,subUnitId:l,row:a,column:i,worksheet:r.worksheet,workbook:r.workbook,interceptValue:G(e),t:null==m?void 0:m.t},t).then(e=>{let t=e?s.DataValidationStatus.VALID:s.DataValidationStatus.INVALID;n.setValue(a,i,{value:p,status:t,ruleId:u,interceptValue:g}),c(t,!0)}),s.DataValidationStatus.VALIDATING)}}getRuleErrorMsg(e,t,r){let n=this._dataValidationModel.getRuleById(e,t,r);if(!n)return"";let i=this._dataValidatorRegistryService.getValidatorItem(n.type);return n.error?n.error:i?i.getRuleFinalError(n):""}getRuleObjectMatrix(e,t){return this._ensureRuleMatrix(e,t)}getRuleById(e,t,r){return this._dataValidationModel.getRuleById(e,t,r)}getRuleIndex(e,t,r){return this._dataValidationModel.getRuleIndex(e,t,r)}getRules(e,t){return[...this._dataValidationModel.getRules(e,t)]}getUnitRules(e){return this._dataValidationModel.getUnitRules(e)}deleteUnitRules(e){return this._dataValidationModel.deleteUnitRules(e)}getSubUnitIds(e){return this._dataValidationModel.getSubUnitIds(e)}getAll(){return this._dataValidationModel.getAll()}},O(K,"SheetDataValidationModel"),K);function ee(e){let t=e.get(d.SheetsSelectionsService).getCurrentSelections().map(e=>e.range);return{uid:(0,s.Tools).generateRandomId(6),type:s.DataValidationType.DECIMAL,operator:s.DataValidationOperator.EQUAL,formula1:"100",ranges:null!=t?t:[{startColumn:0,endColumn:0,startRow:0,endRow:0}]}}function et(e){var t,r;return null==(r=null==(t=null==e?void 0:e[0])?void 0:t[0])?void 0:r.v}function er(e){var t;return null==(t=null==e?void 0:e[0])?void 0:t[0]}function en(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}J=Z([(0,s.OnLifecycle)(s.LifecycleStages.Starting,J),Q(0,(0,s.Inject)(l.DataValidationModel)),Q(1,s.IUniverInstanceService),Q(2,(0,s.Inject)(l.DataValidatorRegistryService)),Q(3,(0,s.Inject)(U)),Q(4,(0,s.Inject)(W)),Q(5,(0,s.Inject)(L))],J),O(ee,"createDefaultNewRule"),O(et,"getFormulaResult"),O(er,"getFormulaCellData"),"u">typeof globalThis?globalThis:"u">typeof window?window:"u">typeof r||"u">typeof self&&self,O(en,"getDefaultExportFromCjs");var ei={exports:{}},ea={},eo=/*@__PURE__*/t(_),es=Symbol.for("react.element"),el=Symbol.for("react.fragment"),ed=Object.prototype.hasOwnProperty,eu=eo.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ec={key:!0,ref:!0,__self:!0,__source:!0};function eh(e,t,r){var n,i={},a=null,o=null;for(n in void 0!==r&&(a=""+r),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(o=t.ref),t)ed.call(t,n)&&!ec.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:es,type:e,key:a,ref:o,props:i,_owner:eu.current}}O(eh,"q"),ea.Fragment=el,ea.jsx=eh,ea.jsxs=eh,ei.exports=ea;var em=ei.exports;function ep(e){var t;let{unitId:r,subUnitId:n,value:i,onChange:a,showError:o,validResult:l}=e,d=o?null==l?void 0:l.formula1:"";return /* @__PURE__ */em.jsx(I.FormLayout,{error:d,children:/* @__PURE__ */em.jsx(S.TextEditor,{value:null!=(t=null==i?void 0:i.formula1)?t:"",id:(0,s.createInternalEditorID)(`dataValidation-custom-formula-${r}-${n}`),onChange:/* @__PURE__ */O(e=>{null==a||a({...i,formula1:(null!=e?e:"").trim()})},"onChange"),onlyInputFormula:!0,openForSheetUnitId:r,openForSheetSubUnitId:n})})}O(ep,"CustomFormulaInput");let eg={dataValidationFormula:"univer-data-validation-formula",dataValidationFormulaAnd:"univer-data-validation-formula-and",dataValidationFormulaListItem:"univer-data-validation-formula-list-item",dataValidationFormulaListItemIcon:"univer-data-validation-formula-list-item-icon",dataValidationFormulaListItemDrag:"univer-data-validation-formula-list-item-drag",dataValidationFormulaListAdd:"univer-data-validation-formula-list-add",dataValidationFormulaColorSelect:"univer-data-validation-formula-color-select",dataValidationFormulaColorSelectPanel:"univer-data-validation-formula-color-select-panel",dataValidationFormulaColorItem:"univer-data-validation-formula-color-item"},ef=/* @__PURE__ */O(e=>{let{isTwoFormula:t=!1,value:r,onChange:n,showError:i,validResult:a}=e,o=(0,s.useDependency)(s.LocaleService),l=i?null==a?void 0:a.formula1:"",d=i?null==a?void 0:a.formula2:"";return t?/* @__PURE__ */em.jsxs(em.Fragment,{children:[/* @__PURE__ */em.jsx(I.FormLayout,{error:l,children:/* @__PURE__ */em.jsx(I.Input,{className:eg.dataValidationFormula,placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:null==r?void 0:r.formula1,onChange:/* @__PURE__ */O(e=>{null==n||n({...r,formula1:e})},"onChange")})}),/* @__PURE__ */em.jsx("div",{className:eg.dataValidationFormulaAnd,children:o.t("dataValidation.panel.formulaAnd")}),/* @__PURE__ */em.jsx(I.FormLayout,{error:d,children:/* @__PURE__ */em.jsx(I.Input,{className:eg.dataValidationFormula,placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:null==r?void 0:r.formula2,onChange:/* @__PURE__ */O(e=>{null==n||n({...r,formula2:e})},"onChange")})})]}):/* @__PURE__ */em.jsx(I.FormLayout,{error:l,children:/* @__PURE__ */em.jsx(I.Input,{className:eg.dataValidationFormula,placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:null==r?void 0:r.formula1,onChange:/* @__PURE__ */O(e=>{null==n||n({formula1:e})},"onChange")})})},"BaseFormulaInput");var ev=function(){return(ev=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},e_=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},eI=(0,_.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=e_(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,_.useRef)("_".concat(eb()));return eS(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},ev({ref:t,className:s},o),a)});function eS(e,t,r,n,i){return(0,_.createElement)(e.tag,ev(ev({key:t},eC(e,r,i)),n),(ey(e,r).children||[]).map(function(n,a){return eS(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function eC(e,t,r){var n=ev({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function ey(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?ev(ev({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?ev(ev({},e),{attrs:ev(ev({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function eb(){return Math.random().toString(36).substring(2,8)}O(eS,"render"),O(eC,"replaceRuntimeIdsAndExtInAttrs"),O(ey,"replaceRuntimeIdsInDefs"),O(eb,"generateShortUuid"),eI.displayName="UniverIcon";var ew={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.1544 3.75557C14.3887 3.98988 14.3887 4.36978 14.1544 4.6041L6.51409 12.2444C6.40157 12.3569 6.24896 12.4201 6.08983 12.4201C5.9307 12.4201 5.77808 12.3569 5.66556 12.2444L1.84541 8.42425C1.6111 8.18993 1.6111 7.81003 1.84541 7.57572C2.07973 7.34141 2.45963 7.34141 2.69394 7.57572L6.08983 10.9716L13.3059 3.75557C13.5402 3.52126 13.9201 3.52126 14.1544 3.75557Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eR=(0,_.forwardRef)(function(e,t){return(0,_.createElement)(eI,Object.assign({},e,{id:"check-mark-single",ref:t,icon:ew}))});eR.displayName="CheckMarkSingle";var eE={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.4917 3.07803C1.4917 2.19437 2.20804 1.47803 3.0917 1.47803H5.6917C6.57536 1.47803 7.2917 2.19437 7.2917 3.07803V5.67803C7.2917 6.56168 6.57535 7.27803 5.6917 7.27803H3.0917C2.20804 7.27803 1.4917 6.56168 1.4917 5.67803V3.07803ZM3.0917 2.67803C2.87078 2.67803 2.6917 2.85711 2.6917 3.07803V5.67803C2.6917 5.89894 2.87079 6.07803 3.0917 6.07803H5.6917C5.91261 6.07803 6.0917 5.89894 6.0917 5.67803V3.07803C6.0917 2.85711 5.91261 2.67803 5.6917 2.67803H3.0917Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.6175 2.45279C14.8518 2.68711 14.8518 3.06701 14.6175 3.30132L11.6151 6.30365C11.3957 6.52307 11.0451 6.53897 10.8067 6.34031L8.80915 4.67566C8.55458 4.46352 8.52019 4.08518 8.73233 3.83062 8.94447 3.57605 9.32281 3.54166 9.57737 3.7538L11.154 5.06767 13.769 2.45278C14.0033 2.21847 14.3832 2.21848 14.6175 2.45279zM14.1175 9.19746C14.3518 9.43178 14.3518 9.81168 14.1175 10.046L12.5418 11.6217 14.1175 13.1975C14.3518 13.4318 14.3518 13.8117 14.1175 14.046 13.8832 14.2803 13.5033 14.2803 13.269 14.046L11.6933 12.4703 10.1175 14.046C9.88321 14.2803 9.50331 14.2803 9.269 14.046 9.03468 13.8117 9.03468 13.4318 9.269 13.1975L10.8447 11.6217 9.269 10.046C9.03468 9.81168 9.03468 9.43178 9.269 9.19746 9.50331 8.96315 9.88321 8.96315 10.1175 9.19746L11.6933 10.7732 13.269 9.19746C13.5033 8.96315 13.8832 8.96315 14.1175 9.19746z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.0917 8.72168C2.20804 8.72168 1.4917 9.43802 1.4917 10.3217V12.9217C1.4917 13.8053 2.20804 14.5217 3.0917 14.5217H5.6917C6.57535 14.5217 7.2917 13.8053 7.2917 12.9217V10.3217C7.2917 9.43802 6.57536 8.72168 5.6917 8.72168H3.0917ZM2.6917 10.3217C2.6917 10.1008 2.87078 9.92168 3.0917 9.92168H5.6917C5.91261 9.92168 6.0917 10.1008 6.0917 10.3217V12.9217C6.0917 13.1426 5.91261 13.3217 5.6917 13.3217H3.0917C2.87079 13.3217 2.6917 13.1426 2.6917 12.9217V10.3217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eT=(0,_.forwardRef)(function(e,t){return(0,_.createElement)(eI,Object.assign({},e,{id:"data-validation-single",ref:t,icon:eE}))});eT.displayName="DataValidationSingle";var eM={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993.866699 5.9313.866699H10.069C10.4004.866699 10.669 1.13533 10.669 1.4667 10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667zM1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443 14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443zM6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928 9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171 10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778 9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539 9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263 6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539 5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778 6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eO=(0,_.forwardRef)(function(e,t){return(0,_.createElement)(eI,Object.assign({},e,{id:"delete-single",ref:t,icon:eM}))});eO.displayName="DeleteSingle";var eD={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},eU=(0,_.forwardRef)(function(e,t){return(0,_.createElement)(eI,Object.assign({},e,{id:"increase-single",ref:t,icon:eD}))});eU.displayName="IncreaseSingle";var eP={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ek=(0,_.forwardRef)(function(e,t){return(0,_.createElement)(eI,Object.assign({},e,{id:"more-down-single",ref:t,icon:eP}))});ek.displayName="MoreDownSingle";var eN={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.64645 9.85355C4.45118 9.65829 4.45118 9.34171 4.64645 9.14645L7.64645 6.14645C7.84171 5.95118 8.15829 5.95118 8.35355 6.14645L11.3536 9.14645C11.5488 9.34171 11.5488 9.65829 11.3536 9.85355C11.1583 10.0488 10.8417 10.0488 10.6464 9.85355L8 7.20711L5.35355 9.85355C5.15829 10.0488 4.84171 10.0488 4.64645 9.85355Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eA=(0,_.forwardRef)(function(e,t){return(0,_.createElement)(eI,Object.assign({},e,{id:"more-up-single",ref:t,icon:eN}))});eA.displayName="MoreUpSingle";var ex={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"mask",attrs:{id:"mask0_622_8",style:{maskType:"alpha"},width:16,height:16,x:0,y:0,maskUnits:"userSpaceOnUse"},children:[{tag:"path",attrs:{fill:"#D9D9D9",d:"M0 0H16V16H0z"}}]},{tag:"g",attrs:{fill:"currentColor",mask:"url(#mask0_622_8)"},children:[{tag:"path",attrs:{d:"M6 5C6.55228 5 7 4.55228 7 4 7 3.44772 6.55228 3 6 3 5.44772 3 5 3.44772 5 4 5 4.55228 5.44772 5 6 5zM6 9C6.55228 9 7 8.55229 7 8 7 7.44772 6.55228 7 6 7 5.44772 7 5 7.44772 5 8 5 8.55229 5.44772 9 6 9zM7 12C7 12.5523 6.55228 13 6 13 5.44772 13 5 12.5523 5 12 5 11.4477 5.44772 11 6 11 6.55228 11 7 11.4477 7 12zM10 5C10.5523 5 11 4.55228 11 4 11 3.44772 10.5523 3 10 3 9.44771 3 9 3.44772 9 4 9 4.55228 9.44771 5 10 5zM11 8C11 8.55229 10.5523 9 10 9 9.44771 9 9 8.55229 9 8 9 7.44772 9.44771 7 10 7 10.5523 7 11 7.44772 11 8zM10 13C10.5523 13 11 12.5523 11 12 11 11.4477 10.5523 11 10 11 9.44771 11 9 11.4477 9 12 9 12.5523 9.44771 13 10 13z"}}]}]},eL=(0,_.forwardRef)(function(e,t){return(0,_.createElement)(eI,Object.assign({},e,{id:"sequence-single",ref:t,icon:ex}))});function eV(e){return e.filter(Boolean).join(",")}function eF(e){return e.split(",").filter(Boolean)}function ej(e){let t=G(e);return null==t?"":t.toString()}eL.displayName="SequenceSingle",O(eV,"serializeListOptions"),O(eF,"deserializeListOptions"),O(ej,"getDataValidationCellValue");let eH="SHEET_DATA_VALIDATION_PLUGIN",e$="#ECECEC";var eB,eW=((o=eW||{})[o.View=0]="View",o[o.Edit=1]="Edit",o[o.ManageCollaborator=2]="ManageCollaborator",o[o.Print=3]="Print",o[o.Duplicate=4]="Duplicate",o[o.Comment=5]="Comment",o[o.Copy=6]="Copy",o[o.Share=7]="Share",o[o.Export=8]="Export",o[o.MoveWorksheet=9]="MoveWorksheet",o[o.DeleteWorksheet=10]="DeleteWorksheet",o[o.HideWorksheet=11]="HideWorksheet",o[o.RenameWorksheet=12]="RenameWorksheet",o[o.CreateWorksheet=13]="CreateWorksheet",o[o.SetWorksheetStyle=14]="SetWorksheetStyle",o[o.EditWorksheetCell=15]="EditWorksheetCell",o[o.InsertHyperlink=16]="InsertHyperlink",o[o.Sort=17]="Sort",o[o.Filter=18]="Filter",o[o.PivotTable=19]="PivotTable",o[o.FloatImg=20]="FloatImg",o[o.History=21]="History",o[o.RwHgtClWdt=22]="RwHgtClWdt",o[o.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",o[o.ViewFilter=24]="ViewFilter",o[o.MoveSheet=25]="MoveSheet",o[o.DeleteSheet=26]="DeleteSheet",o[o.HideSheet=27]="HideSheet",o[o.CopySheet=28]="CopySheet",o[o.RenameSheet=29]="RenameSheet",o[o.CreateSheet=30]="CreateSheet",o[o.SelectProtectedCells=31]="SelectProtectedCells",o[o.SelectUnProtectedCells=32]="SelectUnProtectedCells",o[o.SetCellStyle=33]="SetCellStyle",o[o.SetCellValue=34]="SetCellValue",o[o.SetRowStyle=35]="SetRowStyle",o[o.SetColumnStyle=36]="SetColumnStyle",o[o.InsertRow=37]="InsertRow",o[o.InsertColumn=38]="InsertColumn",o[o.DeleteRow=39]="DeleteRow",o[o.DeleteColumn=40]="DeleteColumn",o[o.EditExtraObject=41]="EditExtraObject",o[o.Delete=42]="Delete",o[o.RecoverHistory=43]="RecoverHistory",o[o.ViewHistory=44]="ViewHistory",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o),eG=Object.defineProperty,eY=Object.getOwnPropertyDescriptor,ez=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eY(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eG(t,r,a),a},"__decorateClass$h"),eK=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$h");let eq=(O(eB=class extends s.Disposable{constructor(e,t,r){super(),this._univerInstanceService=e,this._permissionService=t,this._lexerTreeBuilder=r}getFormulaRefCheck(e){var t,r;let n=this._lexerTreeBuilder.sequenceNodesBuilder(e);if(!n)return!0;for(let e=0;e<n.length;e++){let i=n[e];if("string"==typeof i)continue;let{token:a}=i,o=(0,u.deserializeRangeWithSheet)(a),l=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),c=l.getActiveSheet(),h=l.getUnitId();if(o.sheetName){if(!(c=l.getSheetBySheetName(o.sheetName)))return!1;let e=null==c?void 0:c.getSheetId();if(!this._permissionService.getPermissionPoint(new d.WorksheetViewPermission(h,e).id))return!1}if(!c)return!1;let{startRow:m,endRow:p,startColumn:g,endColumn:f}=o.range;for(let e=m;e<=p;e++)for(let n=g;n<=f;n++){let i=null==(r=null==(t=c.getCell(e,n))?void 0:t.selectionProtection)?void 0:r[0];if((null==i?void 0:i[eW.View])===!1)return!1}}return!0}},"DataValidationFormulaController"),eB);eq=ez([(0,s.OnLifecycle)(s.LifecycleStages.Rendered,eq),eK(0,s.IUniverInstanceService),eK(1,s.IPermissionService),eK(2,(0,s.Inject)(u.LexerTreeBuilder))],eq);let eX=["#FFFFFF","#FEE7E7","#FEF0E6","#EFFBD0","#E4F4FE","#E8ECFD","#F1EAFA","#FDE8F3","#E5E5E5","#FDCECE","#FDC49B","#DEF6A2","#9FDAFF","#D0D9FB","#E3D5F6","#FBD0E8","#656565","#FE4B4B","#FF8C51","#8BBB11","#0B9EFB","#3A60F7","#9E6DE3","#F248A6"],eZ=/* @__PURE__ */O(e=>{let{value:t,onChange:r,disabled:n}=e,[i,a]=(0,_.useState)(!1);return /* @__PURE__ */em.jsx(I.Select,{disabled:n,open:i,onDropdownVisibleChange:a,dropdownStyle:{width:112},className:eg.dataValidationFormulaColorSelect,value:t,onChange:r,labelRender:/* @__PURE__ */O(e=>/* @__PURE__ */em.jsx("div",{className:eg.dataValidationFormulaColorItem,style:{background:e.value,marginTop:5}}),"labelRender"),dropdownRender:/* @__PURE__ */O(()=>/* @__PURE__ */em.jsx("div",{className:eg.dataValidationFormulaColorSelectPanel,children:eX.map(e=>/* @__PURE__ */em.jsx("div",{onClick:/* @__PURE__ */O(()=>{r(e),a(!1)},"onClick"),className:eg.dataValidationFormulaColorItem,style:{background:e}},e))}),"dropdownRender")})},"ColorSelect"),eQ=/* @__PURE__ */O(e=>{let{item:t,commonProps:r,style:n}=e,{onItemChange:i,onItemDelete:a}=r;return /* @__PURE__ */em.jsxs("div",{className:eg.dataValidationFormulaListItem,style:n,children:[t.isRef?null:/* @__PURE__ */em.jsx("div",{className:(0,C.default)(eg.dataValidationFormulaListItemDrag,"draggableHandle"),children:/* @__PURE__ */em.jsx(eL,{})}),/* @__PURE__ */em.jsx(eZ,{value:t.color,onChange:/* @__PURE__ */O(e=>{i(t.id,t.label,e)},"onChange")}),/* @__PURE__ */em.jsx(I.Input,{disabled:t.isRef,value:t.label,onChange:/* @__PURE__ */O(e=>{i(t.id,e,t.color)},"onChange")}),t.isRef?null:/* @__PURE__ */em.jsx("div",{className:eg.dataValidationFormulaListItemIcon,children:/* @__PURE__ */em.jsx(eO,{onClick:/* @__PURE__ */O(()=>a(t.id),"onClick")})})]})},"Template");function eJ(e){let{value:t,onChange:r=/* @__PURE__ */O(()=>{},"_onChange"),unitId:n,subUnitId:i,validResult:a,showError:o,ruleId:d}=e,{formula1:u="",formula2:c=""}=t||{},h=(0,_.useRef)(null),[p,g]=(0,_.useState)(()=>(0,s.isFormulaString)(u)?"1":"0"),[f,v]=(0,_.useState)("1"===p?u:"="),[C,y]=(0,_.useState)("1"===p?u:"="),b=(0,s.useDependency)(s.LocaleService),w=(0,s.useDependency)(l.DataValidatorRegistryService),R=(0,s.useDependency)(l.DataValidationModel),E=(0,s.useDependency)(eq),[T,M]=(0,_.useState)(()=>c.split(",")),D=w.getValidatorItem(s.DataValidationType.LIST),[U,P]=(0,_.useState)([]),[k,N]=(0,_.useState)(""),A=o?null==a?void 0:a.formula1:"",x=(0,_.useMemo)(()=>R.ruleChange$.pipe((0,m.debounceTime)(16)),[]),L=(0,S.useObservable)(x),V=(0,S.useEvent)(r);(0,_.useEffect)(()=>{(async()=>{await new Promise(e=>{setTimeout(()=>e(!0),100)});let e=R.getRuleById(n,i,d),t=null==e?void 0:e.formula1;(0,s.isFormulaString)(t)&&D&&e&&P(await D.getListAsync(e,n,i))})()},[R,L,D,d,i,n]),(0,_.useEffect)(()=>{(0,s.isFormulaString)(u)&&u!==C&&(v(u),y(C))},[C,u]);let[F,j]=(0,_.useState)(()=>{let e="1"!==p?eF(u):[],t=c.split(",");return e.map((e,r)=>({label:e,color:t[r]||e$,isRef:!1,id:(0,s.Tools).generateRandomId(4)}))}),H=/* @__PURE__ */O((e,t,r)=>{let n=F.find(t=>t.id===e);n&&(n.label=t,n.color=r,j([...F]))},"handleStrItemChange"),$=/* @__PURE__ */O(e=>{let t=F.findIndex(t=>t.id===e);-1!==t&&(F.splice(t,1),j([...F]))},"handleStrItemDelete"),B=c.split(","),W=(0,_.useMemo)(()=>U.map((e,t)=>({label:e,color:B[t]||e$,id:`${t}`,isRef:!0})),[B,U]),G=/* @__PURE__ */O((e,t,r)=>{let n=[...T];n[+e]=r,M(n),V({formula1:u,formula2:n.join(",")})},"handleRefItemChange"),Y=/* @__PURE__ */O(()=>{j([...F,{label:"",color:e$,isRef:!1,id:(0,s.Tools).generateRandomId(4)}])},"handleAdd");(0,_.useEffect)(()=>{if("1"===p)return;let e=/* @__PURE__ */new Set,t=[];F.map(e=>({labelList:e.label.split(","),item:e})).forEach(({item:r,labelList:n})=>{n.forEach(n=>{e.has(n)||(e.add(n),t.push({label:n,color:r.color}))})}),V({formula1:eV(t.map(e=>e.label)),formula2:t.map(e=>e.color===e$?"":e.color).join(",")})},[F,V,p,C,T]);let z=(0,_.useMemo)(()=>async e=>{if(!(0,s.isFormulaString)(e)){null==V||V({formula1:"",formula2:c});return}E.getFormulaRefCheck(e)?(null==V||V({formula1:(0,s.isFormulaString)(e)?e:"",formula2:c}),N("")):(null==V||V({formula1:"",formula2:c}),v("="),N(b.t("dataValidation.validFail.formulaError")))},[c,V]);return /* @__PURE__ */em.jsxs(em.Fragment,{children:[/* @__PURE__ */em.jsx(I.FormLayout,{label:b.t("dataValidation.list.options"),children:/* @__PURE__ */em.jsxs(I.RadioGroup,{value:p,onChange:/* @__PURE__ */O(e=>{g(e),v(C),"1"===e&&V({formula1:"="===C?"":C,formula2:T.join(",")})},"onChange"),children:[/* @__PURE__ */em.jsx(I.Radio,{value:"0",children:b.t("dataValidation.list.customOptions")}),/* @__PURE__ */em.jsx(I.Radio,{value:"1",children:b.t("dataValidation.list.refOptions")})]})}),"1"===p?/* @__PURE__ */em.jsxs(em.Fragment,{children:[/* @__PURE__ */em.jsx(I.FormLayout,{error:A||k,children:/* @__PURE__ */em.jsx(S.TextEditor,{id:(0,s.createInternalEditorID)(`list-ref-range-${n}-${i}`),value:f,openForSheetUnitId:n,openForSheetSubUnitId:i,onlyInputFormula:!0,onChange:/* @__PURE__ */O(async e=>{let t=(null!=e?e:"").trim();y(t),z(t)},"onChange")})}),/* @__PURE__ */em.jsx(I.FormLayout,{children:/* @__PURE__ */em.jsx("div",{ref:h,children:W.map(e=>/* @__PURE__ */em.jsx(eQ,{item:e,commonProps:{onItemChange:G},style:{marginBottom:12}},e.id))})})]}):/* @__PURE__ */em.jsx(I.FormLayout,{error:A,children:/* @__PURE__ */em.jsxs("div",{ref:h,style:{marginTop:"-12px"},children:[/* @__PURE__ */em.jsx(I.DraggableList,{list:F,onListChange:j,rowHeight:32,margin:[0,12],draggableHandle:".draggableHandle",itemRender:/* @__PURE__ */O(e=>/* @__PURE__ */em.jsx(eQ,{item:e,commonProps:{onItemChange:H,onItemDelete:$}},e.id),"itemRender"),idKey:"id"}),/* @__PURE__ */em.jsxs("a",{className:eg.dataValidationFormulaListAdd,onClick:Y,children:[/* @__PURE__ */em.jsx(eU,{}),b.t("dataValidation.list.add")]})]})})]})}function e0(e){let{value:t,onChange:r,showError:n,validResult:i}=e,a=(0,s.useDependency)(s.LocaleService),o=n?null==i?void 0:i.formula1:"",l=n?null==i?void 0:i.formula2:"",[d,u]=(0,_.useState)(!((null==t?void 0:t.formula1)===void 0&&(null==t?void 0:t.formula2)===void 0));return /* @__PURE__ */em.jsxs(em.Fragment,{children:[/* @__PURE__ */em.jsx(I.FormLayout,{children:/* @__PURE__ */em.jsx(I.Checkbox,{checked:d,onChange:/* @__PURE__ */O(e=>{e?u(!0):(u(!1),null==r||r({...t,formula1:void 0,formula2:void 0}))},"onChange"),children:a.t("dataValidation.checkbox.tips")})}),d?/* @__PURE__ */em.jsx(I.FormLayout,{label:a.t("dataValidation.checkbox.checked"),error:o,children:/* @__PURE__ */em.jsx(I.Input,{className:eg.dataValidationFormula,placeholder:a.t("dataValidation.panel.valuePlaceholder"),value:null==t?void 0:t.formula1,onChange:/* @__PURE__ */O(e=>{null==r||r({...t,formula1:e||void 0})},"onChange")})}):null,d?/* @__PURE__ */em.jsx(I.FormLayout,{label:a.t("dataValidation.checkbox.unchecked"),error:l,children:/* @__PURE__ */em.jsx(I.Input,{className:eg.dataValidationFormula,placeholder:a.t("dataValidation.panel.valuePlaceholder"),value:null==t?void 0:t.formula2,onChange:/* @__PURE__ */O(e=>{null==r||r({...t,formula2:e||void 0})},"onChange")})}):null]})}O(eJ,"ListFormulaInput"),O(e0,"CheckboxFormulaInput");let e1="data-validation.custom-formula-input",e3="data-validation.formula-input",e2="data-validation.list-formula-input",e4="data-validation.checkbox-formula-input",e9=[[e1,ep],[e3,ef],[e2,eJ],[e4,e0]];var e5=Object.defineProperty,e6=Object.getOwnPropertyDescriptor,e8=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e6(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e5(t,r,a),a},"__decorateClass$g"),e7=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$g");let te=(O(tu=class{constructor(e,t,r){this._commandService=e,this._formulaService=t,this._themeService=r}_calc(e,t){var r,n,i;let{vt:a,ht:o}=t||{},l=e.endX-e.startX-12,d=e.endY-e.startY,u=(null!=(r=null==t?void 0:t.fs)?r:10)*1.6,c=0,h=0;switch(a){case s.VerticalAlign.TOP:h=0;break;case s.VerticalAlign.BOTTOM:h=0+(d-u);break;default:h=0+(d-u)/2}switch(o){case s.HorizontalAlign.LEFT:c=6;break;case s.HorizontalAlign.RIGHT:c=6+(l-u);break;default:c=6+(l-u)/2}return{left:e.startX+c,top:e.startY+h,width:(null!=(n=null==t?void 0:t.fs)?n:10)*1.6,height:(null!=(i=null==t?void 0:t.fs)?i:10)*1.6}}calcCellAutoHeight(e){var t;let{style:r}=e;return(null!=(t=null==r?void 0:r.fs)?t:10)*1.6}async _parseFormula(e,t,r){var n,i;let{formula1:a=tt,formula2:o=tr}=e,l=await this._formulaService.getRuleFormulaResult(t,r,e.uid);return{formula1:(0,s.isFormulaString)(a)?et(null==(n=null==l?void 0:l[0])?void 0:n.result):a,formula2:(0,s.isFormulaString)(o)?et(null==(i=null==l?void 0:l[1])?void 0:i.result):o}}drawWith(e,t){var r,n,i,a,o;let{style:s,data:l,primaryWithCoord:d,unitId:u,subUnitId:c,worksheet:h,row:m,col:p}=t,g=d.isMergedMainCell?d.mergeInfo:d,f=G(h.getCellRaw(m,p)),v=null==(r=l.dataValidation)?void 0:r.rule,_=null==(n=l.dataValidation)?void 0:n.validator;if(!v||!_)return;let I=this._themeService.getCurrentTheme();if(!_.skipDefaultFontRender(v,f,{unitId:u,subUnitId:c}))return;let{formula1:S}=_.parseFormulaSync(v,u,c),C=this._calc(g,s),{a:b,d:w}=e.getTransform(),R=(0,y.fixLineWidthByScale)(C.left,b),E=(0,y.fixLineWidthByScale)(C.top,w),T=(0,y.Transform).create().composeMatrix({left:R,top:E,scaleX:1,scaleY:1,angle:0,skewX:0,skewY:0,flipX:!1,flipY:!1}),M=g.endX-g.startX,O=g.endY-g.startY;e.save(),e.beginPath(),e.rect(g.startX,g.startY,M,O),e.clip();let D=T.getMatrix();e.transform(D[0],D[1],D[2],D[3],D[4],D[5]);let U=(null!=(i=null==s?void 0:s.fs)?i:10)*1.6,P=String(f)===String(S),k=I.hyacinth500;(0,y.Checkbox).drawWith(e,{checked:P,width:U,height:U,fill:null!=(o=null==(a=null==s?void 0:s.cl)?void 0:a.rgb)?o:k}),e.restore()}isHit(e,t){let r=t.primaryWithCoord.isMergedMainCell?t.primaryWithCoord.mergeInfo:t.primaryWithCoord,n=this._calc(r,t.style),i=n.top,a=n.top+n.height,o=n.left,s=n.left+n.width,{x:l,y:d}=e;return l<=s&&l>=o&&d<=a&&d>=i}async onPointerDown(e,t){var r,n;if(2===t.button)return;let{primaryWithCoord:i,unitId:a,subUnitId:o,data:s,worksheet:l,row:u,col:c}=e,h=G(l.getCellRaw(u,c)),m=null==(r=s.dataValidation)?void 0:r.rule,p=null==(n=s.dataValidation)?void 0:n.validator;if(!m||!p||!p.skipDefaultFontRender(m,h,{unitId:a,subUnitId:o}))return;let{formula1:g,formula2:f}=await this._parseFormula(m,a,o),v={range:{startColumn:i.actualColumn,endColumn:i.actualColumn,startRow:i.actualRow,endRow:i.actualRow},value:{v:String(h)===ti(String(g))?f:g,p:null}};this._commandService.executeCommand(d.SetRangeValuesCommand.id,v)}},"CheckboxRender"),tu);te=e8([e7(0,s.ICommandService),e7(1,(0,s.Inject)(W)),e7(2,(0,s.Inject)(s.ThemeService))],te);let tt=1,tr=0;function tn(e,t){return(0,s.Tools).isBlank(e)?t.t("dataValidation.validFail.value"):(0,s.isFormulaString)(e)?t.t("dataValidation.validFail.primitive"):""}O(tn,"getFailMessage");let ti=/* @__PURE__ */O(e=>(0,s.Tools).isDefine(e)&&"true"===String(e).toLowerCase()?"1":"false"===String(e).toLowerCase()?"0":e,"transformCheckboxValue"),ta=class extends l.BaseDataValidator{constructor(){super(...arguments),D(this,"id",s.DataValidationType.CHECKBOX),D(this,"title","dataValidation.checkbox.title"),D(this,"operators",[]),D(this,"scopes",["sheet"]),D(this,"formulaInput",e4),D(this,"canvasRender",this.injector.createInstance(te)),D(this,"_formulaService",this.injector.get(W))}skipDefaultFontRender(e,t,r){let{formula1:n,formula2:i}=this.parseFormulaSync(e,r.unitId,r.subUnitId),a=`${null!=t?t:""}`;return!a||a===`${n}`||a===`${i}`}validatorFormula(e,t,r){let{formula1:n,formula2:i}=e,a=n===i;if((0,s.Tools).isBlank(n)&&(0,s.Tools).isBlank(i))return{success:!0};if(a)return{success:!1,formula1:this.localeService.t("dataValidation.validFail.checkboxEqual"),formula2:this.localeService.t("dataValidation.validFail.checkboxEqual")};let o=tn(n,this.localeService),l=tn(i,this.localeService);return{success:!o&&!l,formula1:o,formula2:l}}async parseFormula(e,t,r){var n,i;let{formula1:a=tt,formula2:o=tr}=e,l=await this._formulaService.getRuleFormulaResult(t,r,e.uid),d=(0,s.isFormulaString)(a)?et(null==(n=null==l?void 0:l[0])?void 0:n.result):a,u=(0,s.isFormulaString)(o)?et(null==(i=null==l?void 0:l[1])?void 0:i.result):o;return{formula1:ti(d),formula2:ti(u),originFormula1:d,originFormula2:u}}getExtraStyle(e,t){return{tb:s.WrapStrategy.CLIP}}parseFormulaSync(e,t,r){var n,i;let{formula1:a=tt,formula2:o=tr}=e,l=this._formulaService.getRuleFormulaResultSync(t,r,e.uid),d=(0,s.isFormulaString)(a)?et(null==(n=null==l?void 0:l[0])?void 0:n.result):a,u=(0,s.isFormulaString)(o)?et(null==(i=null==l?void 0:l[1])?void 0:i.result):o;return{formula1:ti(d),formula2:ti(u),originFormula1:d,originFormula2:u}}async isValidType(e,t,r){let{value:n,unitId:i,subUnitId:a}=e,{formula1:o,formula2:l,originFormula1:d,originFormula2:u}=await this.parseFormula(r,i,a);return!((0,s.Tools).isDefine(o)&&(0,s.Tools).isDefine(l))||(0,s.Tools).isDefine(n)&&(String(n)===String(o)||String(n)===String(l)||String(n)===String(null!=d?d:"")||String(n)===String(null!=u?u:""))}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.checkbox.error")}};O(ta,"CheckboxValidator");let to={[s.DataValidationOperator.BETWEEN]:"dataValidation.date.operators.between",[s.DataValidationOperator.EQUAL]:"dataValidation.date.operators.equal",[s.DataValidationOperator.GREATER_THAN]:"dataValidation.date.operators.greaterThan",[s.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.operators.greaterThanOrEqual",[s.DataValidationOperator.LESS_THAN]:"dataValidation.date.operators.lessThan",[s.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.operators.lessThanOrEqual",[s.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.operators.notBetween",[s.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.operators.notEqual"};s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL;let ts={[s.DataValidationOperator.BETWEEN]:"dataValidation.date.ruleName.between",[s.DataValidationOperator.EQUAL]:"dataValidation.date.ruleName.equal",[s.DataValidationOperator.GREATER_THAN]:"dataValidation.date.ruleName.greaterThan",[s.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.ruleName.greaterThanOrEqual",[s.DataValidationOperator.LESS_THAN]:"dataValidation.date.ruleName.lessThan",[s.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.ruleName.lessThanOrEqual",[s.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.ruleName.notBetween",[s.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.ruleName.notEqual"},tl={[s.DataValidationOperator.BETWEEN]:"dataValidation.date.errorMsg.between",[s.DataValidationOperator.EQUAL]:"dataValidation.date.errorMsg.equal",[s.DataValidationOperator.GREATER_THAN]:"dataValidation.date.errorMsg.greaterThan",[s.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.greaterThanOrEqual",[s.DataValidationOperator.LESS_THAN]:"dataValidation.date.errorMsg.lessThan",[s.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.lessThanOrEqual",[s.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.errorMsg.notBetween",[s.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.errorMsg.notEqual"},td=[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.NOT_BETWEEN];var tu,tc,th=Object.defineProperty,tm=Object.getOwnPropertyDescriptor,tp=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tm(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&th(t,r,a),a},"__decorateClass$f"),tg=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$f");let tf=(O(tc=class extends s.Disposable{constructor(e,t){super(),D(this,"_open$",new c.BehaviorSubject(!1)),D(this,"open$",this._open$.pipe((0,p.distinctUntilChanged)())),D(this,"_activeRule"),D(this,"_activeRule$",new c.BehaviorSubject(void 0)),D(this,"activeRule$",this._activeRule$.asObservable()),D(this,"_closeDisposable",null),this._univerInstanceService=e,this._sidebarService=t,this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(s.UniverInstanceType.UNIVER_SHEET).pipe((0,g.filter)(e=>!e)).subscribe(()=>{this.close()}))}get activeRule(){return this._activeRule}get isOpen(){return this._open$.getValue()}dispose(){var e;super.dispose(),this._open$.next(!1),this._open$.complete(),this._activeRule$.complete(),null==(e=this._closeDisposable)||e.dispose()}open(){this._open$.next(!0)}close(){var e;this._open$.next(!1),null==(e=this._closeDisposable)||e.dispose()}setCloseDisposable(e){this._closeDisposable=(0,s.toDisposable)(()=>{e.dispose(),this._closeDisposable=null})}setActiveRule(e){this._activeRule=e,this._activeRule$.next(e)}},"DataValidationPanelService"),tc);tf=tp([tg(0,s.IUniverInstanceService),tg(1,S.ISidebarService)],tf);let tv={dataValidationOptionsButton:"univer-data-validation-options-button",dataValidationOptionsButtonIcon:"univer-data-validation-options-button-icon"};function t_(e){var t;let r=(0,s.useDependency)(s.LocaleService),n=(0,s.useDependency)(S.ComponentManager),{value:i,onChange:a,extraComponent:o}=e,[l,d]=(0,_.useState)(!1),u=o?n.get(o):null;return /* @__PURE__ */em.jsxs(em.Fragment,{children:[/* @__PURE__ */em.jsxs("div",{className:tv.dataValidationOptionsButton,onClick:/* @__PURE__ */O(()=>d(!l),"onClick"),children:[r.t("dataValidation.panel.options"),l?/* @__PURE__ */em.jsx(eA,{className:tv.dataValidationOptionsButtonIcon}):/* @__PURE__ */em.jsx(ek,{className:tv.dataValidationOptionsButtonIcon})]}),l&&/* @__PURE__ */em.jsxs(em.Fragment,{children:[u?/* @__PURE__ */em.jsx(u,{value:i,onChange:a}):null,/* @__PURE__ */em.jsx(I.FormLayout,{label:r.t("dataValidation.panel.invalid"),children:/* @__PURE__ */em.jsxs(I.RadioGroup,{value:`${null!=(t=i.errorStyle)?t:s.DataValidationErrorStyle.WARNING}`,onChange:/* @__PURE__ */O(e=>a({...i,errorStyle:+e}),"onChange"),children:[/* @__PURE__ */em.jsx(I.Radio,{value:`${s.DataValidationErrorStyle.WARNING}`,children:r.t("dataValidation.panel.showWarning")}),/* @__PURE__ */em.jsx(I.Radio,{value:`${s.DataValidationErrorStyle.STOP}`,children:r.t("dataValidation.panel.rejectInput")})]})}),/* @__PURE__ */em.jsx(I.FormLayout,{label:r.t("dataValidation.panel.messageInfo"),children:/* @__PURE__ */em.jsx(I.Checkbox,{checked:i.showErrorMessage,onChange:/* @__PURE__ */O(()=>a({...i,showErrorMessage:!i.showErrorMessage}),"onChange"),children:r.t("dataValidation.panel.showInfo")})}),i.showErrorMessage?/* @__PURE__ */em.jsx(I.FormLayout,{children:/* @__PURE__ */em.jsx(I.Input,{value:i.error,onChange:/* @__PURE__ */O(e=>a({...i,error:e}),"onChange")})}):null]})]})}O(t_,"DataValidationOptions");let tI={dataValidationDetailFormItem:"univer-data-validation-detail-form-item",dataValidationDetailButtons:"univer-data-validation-detail-buttons",dataValidationDetailButton:"univer-data-validation-detail-button"},tS=/* @__PURE__ */O(e=>(0,s.debounce)(async(t,r,n,i)=>{let a=await e.executeCommand(t,r,n);null==i||i(a)},1e3),"debounceExecuteFactory");function tC(){let[e,t]=(0,_.useState)(0),r=(0,s.useDependency)(tf),{unitId:n,subUnitId:i,rule:a}=(0,S.useObservable)(r.activeRule$,r.activeRule)||{},o=a.uid,d=(0,s.useDependency)(l.DataValidatorRegistryService),c=(0,s.useDependency)(S.ComponentManager),h=(0,s.useDependency)(s.ICommandService),m=(0,s.useDependency)(l.DataValidationModel),p=(0,s.useDependency)(s.LocaleService),[g,f]=(0,_.useState)(a),v=d.getValidatorItem(g.type),[C,y]=(0,_.useState)(!1),b=d.getValidatorsByScope(l.DataValidatorRegistryScope.SHEET),[w,R]=(0,_.useState)(()=>g.ranges.map(e=>({unitId:"",sheetId:"",range:e}))),E=(0,_.useMemo)(()=>tS(h),[h]);if((0,_.useEffect)(()=>{h.onCommandExecuted(e=>{(e.id===s.UndoCommand.id||e.id===s.RedoCommand.id)&&setTimeout(()=>{let e=m.getRuleById(n,i,o);t(e=>e+1),e&&(f(e),R(e.ranges.map(e=>({unitId:"",sheetId:"",range:e}))))},20)})},[h,m,o,i,n]),!v)return null;let T=v.operators,M=v.operatorNames,D=!!g.operator&&(0,l.TWO_FORMULA_OPERATOR_COUNT).includes(g.operator),U=/* @__PURE__ */O(()=>{g.ranges.length&&(v.validatorFormula(g,n,i).success?r.setActiveRule(null):y(!0))},"handleOk"),P=(0,S.useEvent)(e=>{if((0,s.isUnitRangesEqual)(e,w))return;R(e);let t=e.filter(e=>(!e.unitId||e.unitId===n)&&(!e.sheetId||e.sheetId===i)).map(e=>e.range);f({...g,ranges:t}),0!==t.length&&E(rC.id,{unitId:n,subUnitId:i,ruleId:o,ranges:t})}),k=/* @__PURE__ */O(e=>{(0,s.shallowEqual)(e,(0,l.getRuleSetting)(g))||(f({...g,...e}),E(rw.id,{unitId:n,subUnitId:i,ruleId:o,setting:e},void 0))},"handleUpdateRuleSetting"),N=/* @__PURE__ */O(async()=>{await h.executeCommand(rO.id,{ruleId:o,unitId:n,subUnitId:i}),r.setActiveRule(null)},"handleDelete"),A={type:g.type,operator:g.operator,formula1:g.formula1,formula2:g.formula2,allowBlank:g.allowBlank},x=/* @__PURE__ */O(e=>{let t=d.getValidatorItem(e);if(!t)return;let r=t.operators,a=m.getRuleById(n,i,o),s=e===(null==a?void 0:a.type)||e.includes("list")&&null!=a&&a.type.includes("list")?{...a,type:e}:{...g,type:e,operator:r[0],formula1:void 0,formula2:void 0};f(s),h.executeCommand(rw.id,{unitId:n,subUnitId:i,ruleId:g.uid,setting:(0,l.getRuleSetting)(s)})},"handleChangeType"),L=c.get(v.formulaInput),V=(0,_.useMemo)(()=>w.map(e=>(0,u.serializeRange)(e.range)).join(","),[]),F=(0,l.getRuleOptions)(g),j=/* @__PURE__ */O(e=>{(0,s.shallowEqual)(e,(0,l.getRuleOptions)(g))||(f({...g,...e}),E(rR.id,{unitId:n,subUnitId:i,ruleId:o,options:e}))},"handleUpdateRuleOptions");return /* @__PURE__ */em.jsxs("div",{children:[/* @__PURE__ */em.jsx(I.FormLayout,{label:p.t("dataValidation.panel.range"),error:g.ranges.length?"":p.t("dataValidation.panel.rangeError"),children:/* @__PURE__ */em.jsx(S.RangeSelector,{className:tI.dataValidationDetailFormItem,value:V,id:(0,s.createInternalEditorID)("data-validation-detail"),openForSheetUnitId:n,openForSheetSubUnitId:i,onChange:/* @__PURE__ */O(e=>{e.some(e=>!(0,s.isValidRange)(e.range)||e.range.endColumn<e.range.startColumn||e.range.endRow<e.range.startRow)||P(e)},"onChange")},e)}),/* @__PURE__ */em.jsx(I.FormLayout,{label:p.t("dataValidation.panel.type"),children:/* @__PURE__ */em.jsx(I.Select,{options:null==b?void 0:b.map(e=>({label:p.t(e.title),value:e.id})),value:g.type,onChange:x,className:tI.dataValidationDetailFormItem})}),null!=T&&T.length?/* @__PURE__ */em.jsx(I.FormLayout,{label:p.t("dataValidation.panel.operator"),children:/* @__PURE__ */em.jsx(I.Select,{options:T.map((e,t)=>({value:`${e}`,label:M[t]})),value:`${g.operator}`,onChange:/* @__PURE__ */O(e=>{k({...A,operator:e})},"onChange"),className:tI.dataValidationDetailFormItem})}):null,L?/* @__PURE__ */em.jsx(L,{isTwoFormula:D,value:{formula1:g.formula1,formula2:g.formula2},onChange:/* @__PURE__ */O(e=>{k({...A,...e})},"onChange"),showError:C,validResult:v.validatorFormula(g,n,i),unitId:n,subUnitId:i,ruleId:o},e+g.type):null,/* @__PURE__ */em.jsx(t_,{value:F,onChange:j,extraComponent:v.optionsInput}),/* @__PURE__ */em.jsxs("div",{className:tI.dataValidationDetailButtons,children:[/* @__PURE__ */em.jsx(I.Button,{className:tI.dataValidationDetailButton,onClick:N,children:p.t("dataValidation.panel.removeRule")}),/* @__PURE__ */em.jsx(I.Button,{className:tI.dataValidationDetailButton,type:"primary",onClick:U,children:p.t("dataValidation.panel.done")})]})]})}O(tC,"DataValidationDetail");let ty={dataValidationItemContainer:"univer-data-validation-item-container",dataValidationItemTitle:"univer-data-validation-item-title",dataValidationItemContent:"univer-data-validation-item-content",dataValidationItemIcon:"univer-data-validation-item-icon"},tb=/* @__PURE__ */O(e=>{let{rule:t,onClick:r,unitId:n,subUnitId:i,disable:a}=e,o=(0,s.useDependency)(l.DataValidatorRegistryService),d=(0,s.useDependency)(s.ICommandService),c=(0,s.useDependency)(w.IMarkSelectionService),h=o.getValidatorItem(t.type),m=(0,_.useRef)(),[p,g]=(0,_.useState)(!1),f=/* @__PURE__ */O(e=>{d.executeCommand(rO.id,{ruleId:t.uid,unitId:n,subUnitId:i}),e.stopPropagation()},"handleDelete");return(0,_.useEffect)(()=>()=>{var e;m.current&&(null==(e=m.current)||e.forEach(e=>{e&&c.removeShape(e)}))},[c]),/* @__PURE__ */em.jsxs("div",{className:ty.dataValidationItemContainer,onClick:r,onMouseEnter:/* @__PURE__ */O(()=>{a||(g(!0),m.current=t.ranges.map(e=>c.addShape({range:e,style:{hasAutoFill:!1,fill:"rgba(73, 184, 17, 0.05)",strokeWidth:1,stroke:"#49B811",widgets:{}},primary:{startColumn:e.startColumn,endColumn:e.endColumn,startRow:e.startRow,endRow:e.endRow,actualRow:e.startRow,actualColumn:e.startColumn,isMerged:!1,isMergedMainCell:!1}})))},"onMouseEnter"),onMouseLeave:/* @__PURE__ */O(()=>{var e;g(!1),null==(e=m.current)||e.forEach(e=>{e&&c.removeShape(e)}),m.current=void 0},"onMouseLeave"),children:[/* @__PURE__ */em.jsx("div",{className:ty.dataValidationItemTitle,children:null==h?void 0:h.generateRuleName(t)}),/* @__PURE__ */em.jsx("div",{className:ty.dataValidationItemContent,children:t.ranges.map(e=>(0,u.serializeRange)(e)).join(",")}),p?/* @__PURE__ */em.jsx("div",{className:ty.dataValidationItemIcon,onClick:f,children:/* @__PURE__ */em.jsx(eO,{})}):null]})},"DataValidationItem"),tw={dataValidationListButtons:"univer-data-validation-list-buttons",dataValidationListButton:"univer-data-validation-list-button"};function tR(){let e=(0,s.useDependency)(s.IUniverInstanceService),t=(0,S.useObservable)(()=>e.getCurrentTypeOfUnit$(s.UniverInstanceType.UNIVER_SHEET),void 0,void 0,[]);return t?/* @__PURE__ */em.jsx(tE,{workbook:t}):null}function tE(e){let t=(0,s.useDependency)(J),r=(0,s.useDependency)(s.IUniverInstanceService),n=(0,s.useDependency)(s.ICommandService),i=(0,s.useDependency)(s.Injector),a=(0,s.useDependency)(tf),o=(0,s.useDependency)(s.LocaleService),[l,u]=(0,_.useState)([]),{workbook:c}=e,h=(0,S.useObservable)(c.activeSheet$,void 0,!0),m=c.getUnitId(),p=null==h?void 0:h.getSheetId();(0,_.useEffect)(()=>{u(t.getRules(m,p));let e=t.ruleChange$.subscribe(e=>{e.unitId===m&&e.subUnitId===p&&u(t.getRules(m,p))});return()=>{e.unsubscribe()}},[m,p,t]);let g=/* @__PURE__ */O(async()=>{let e=ee(i);await n.executeCommand(ry.id,{unitId:m,subUnitId:p,rule:e}),a.setActiveRule({unitId:m,subUnitId:p,rule:e})},"handleAddRule"),f=/* @__PURE__ */O(()=>{n.executeCommand(rT.id,{unitId:m,subUnitId:p})},"handleRemoveAll"),v=/* @__PURE__ */O(e=>{let t=r.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),n=t.getActiveSheet(),a=t.getUnitId(),o=n.getSheetId();return e.map(e=>(0,d.checkRangesEditablePermission)(i,a,o,e.ranges)?{...e}:{...e,disable:!0})},"getDvRulesByPermissionCorrect")(l),C=null==v?void 0:v.some(e=>e.disable);return /* @__PURE__ */em.jsxs("div",{children:[null==v?void 0:v.map(e=>{var t;return /* @__PURE__ */em.jsx(tb,{unitId:m,subUnitId:p,onClick:/* @__PURE__ */O(()=>{e.disable||a.setActiveRule({unitId:m,subUnitId:p,rule:e})},"onClick"),rule:e,disable:null!=(t=e.disable)&&t},e.uid)}),/* @__PURE__ */em.jsxs("div",{className:tw.dataValidationListButtons,children:[l.length&&!C?/* @__PURE__ */em.jsx(I.Button,{className:tw.dataValidationListButton,onClick:f,children:o.t("dataValidation.panel.removeAll")}):null,/* @__PURE__ */em.jsx(I.Button,{className:tw.dataValidationListButton,type:"primary",onClick:g,children:o.t("dataValidation.panel.add")})]})]})}O(tR,"DataValidationList"),O(tE,"DataValidationListWithWorkbook");let tT=/* @__PURE__ */O(()=>{let e=(0,s.useDependency)(tf),t=(0,S.useObservable)(e.activeRule$,e.activeRule);return t?/* @__PURE__ */em.jsx(tC,{},t.rule.uid):/* @__PURE__ */em.jsx(tR,{})},"DataValidationPanel");function tM(){let e=(0,s.useDependency)(tA),t=(0,S.useObservable)(e.activeDropdown$,e.activeDropdown),r=(0,s.useDependency)(S.ComponentManager);if(!t)return null;let{location:n,componentKey:i}=t,a=r.get(i),o=`${n.unitId}-${n.subUnitId}-${n.row}-${n.col}`;if(!a)return null;let l=/* @__PURE__ */O(()=>{e.hideDropdown()},"hideFn");return /* @__PURE__ */em.jsx(a,{location:n,hideFn:l},o)}O(tM,"CellDropdown");let tO="sheet.ui.dropdown";var tD,tU=Object.defineProperty,tP=Object.getOwnPropertyDescriptor,tk=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tP(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tU(t,r,a),a},"__decorateClass$e"),tN=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$e");let tA=(tD=class extends s.Disposable{constructor(e,t,r,n,i,a,o){super(),D(this,"_activeDropdown"),D(this,"_activeDropdown$",new f.Subject),D(this,"_currentPopup",null),D(this,"activeDropdown$",this._activeDropdown$.asObservable()),D(this,"_zenVisible",!1),this._canvasPopupManagerService=e,this._univerInstanceService=t,this._dataValidatorRegistryService=r,this._zenZoneService=n,this._renderManagerService=i,this._dataValidationModel=a,this._sheetsSelectionsService=o,this._init(),this._initSelectionChange(),this.disposeWithMe(()=>{this._activeDropdown$.complete()})}get activeDropdown(){return this._activeDropdown}_init(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{this._zenVisible=e,e&&this.hideDropdown()}))}_getDropdownByCell(e,t,r,n){let i=e?this._univerInstanceService.getUnit(e,s.UniverInstanceType.UNIVER_SHEET):this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);if(!i)return;let a=t?i.getSheetBySheetId(t):i.getActiveSheet();if(!a)return;let o=this._dataValidationModel.getRuleByLocation(i.getUnitId(),a.getSheetId(),r,n);if(!o)return;let l=this._dataValidatorRegistryService.getValidatorItem(o.type);return null==l?void 0:l.dropdown}_initSelectionChange(){this.disposeWithMe(this._sheetsSelectionsService.selectionMoveEnd$.subscribe(e=>{e&&e.every(e=>!(e.primary&&this._getDropdownByCell(e.primary.unitId,e.primary.sheetId,e.primary.actualRow,e.primary.actualColumn)))&&this.hideDropdown()}))}showDropdown(e,t=!0){let{location:r}=e,{row:n,col:i,unitId:a,subUnitId:o}=r;if(this._currentPopup&&this._currentPopup.dispose(),this._zenVisible)return;this._activeDropdown=e,this._activeDropdown$.next(this._activeDropdown);let l=this._renderManagerService.getRenderById(s.DOCS_FORMULA_BAR_EDITOR_UNIT_ID_KEY),d=this._canvasPopupManagerService.attachPopupToCell(n,i,{componentKey:tO,onClickOutside:/* @__PURE__ */O(()=>{t&&this.hideDropdown()},"onClickOutside"),offset:[0,3],excludeOutside:[null==l?void 0:l.engine.getCanvasElement()].filter(Boolean)},a,o);if(!d)throw Error("[DataValidationDropdownManagerService]: cannot show dropdown!");let u=new s.DisposableCollection;u.add(d),u.add({dispose:/* @__PURE__ */O(()=>{var e,t;null==(t=null==(e=this._activeDropdown)?void 0:e.onHide)||t.call(e)},"dispose")}),this._currentPopup=u}hideDropdown(){this._activeDropdown&&(this._currentPopup&&this._currentPopup.dispose(),this._currentPopup=null,this._activeDropdown=null,this._activeDropdown$.next(null))}showDataValidationDropdown(e,t,r,n,i){let a=this._univerInstanceService.getUnit(e,s.UniverInstanceType.UNIVER_SHEET);if(!a)return;let o=a.getSheetBySheetId(t);if(!o)return;let l=this._dataValidationModel.getRuleByLocation(a.getUnitId(),o.getSheetId(),r,n);if(!l)return;let d=this._dataValidatorRegistryService.getValidatorItem(l.type);if(!d||!d.dropdown){this.hideDropdown();return}this.showDropdown({location:{workbook:a,worksheet:o,row:r,col:n,unitId:e,subUnitId:t},componentKey:d.dropdown,onHide:i})}},O(tD,"DataValidationDropdownManagerService"),tD);tA=tk([tN(0,(0,s.Inject)(w.SheetCanvasPopManagerService)),tN(1,s.IUniverInstanceService),tN(2,(0,s.Inject)(l.DataValidatorRegistryService)),tN(3,S.IZenZoneService),tN(4,y.IRenderManagerService),tN(5,(0,s.Inject)(J)),tN(6,(0,s.Inject)(d.SheetsSelectionsService))],tA);let tx="DataValidationPanel",tL={id:"data-validation.operation.open-validation-panel",type:s.CommandType.OPERATION,handler(e,t){if(!t)return!1;let{ruleId:r,isAdd:n}=t,i=e.get(tf),a=e.get(l.DataValidationModel),o=e.get(s.IUniverInstanceService),u=e.get(S.ISidebarService),c=(0,d.getSheetCommandTarget)(o);if(!c)return!1;let{unitId:h,subUnitId:m}=c,p=r?a.getRuleById(h,m,r):void 0;i.open(),i.setActiveRule(p&&{unitId:h,subUnitId:m,rule:p});let g=u.open({header:{title:n?"dataValidation.panel.addTitle":"dataValidation.panel.title"},children:{label:tx},width:312,onClose:/* @__PURE__ */O(()=>i.close(),"onClose")});return i.setCloseDisposable(g),!0}},tV={id:"data-validation.operation.close-validation-panel",type:s.CommandType.OPERATION,handler:e=>(e.get(tf).close(),!0)},tF={id:"data-validation.operation.toggle-validation-panel",type:s.CommandType.OPERATION,handler(e){let t=e.get(s.ICommandService),r=e.get(tf);return r.open(),r.isOpen?t.executeCommand(tV.id):t.executeCommand(tL.id),!0}},tj={type:s.CommandType.OPERATION,id:"sheet.operation.show-data-validation-dropdown",handler(e,t){if(!t)return!1;let r=e.get(tA),{unitId:n,subUnitId:i,row:a,column:o}=t,s=r.activeDropdown,l=null==s?void 0:s.location;return l&&l.unitId===n&&l.subUnitId===i&&l.row===a&&l.col===o||r.showDataValidationDropdown(n,i,a,o),!0}},tH={type:s.CommandType.OPERATION,id:"sheet.operation.hide-data-validation-dropdown",handler:(e,t)=>!!t&&(e.get(tA).hideDropdown(),!0)},t$=/* @__PURE__ */O(e=>{let{value:t,onChange:r,multiple:n,options:i,title:a,onEdit:o,style:l,filter:d}=e,u=(0,s.useDependency)(s.LocaleService),c=null==d?void 0:d.toLowerCase(),h=i.filter(e=>!c||e.label.toLowerCase().includes(c));return /* @__PURE__ */em.jsxs("div",{className:"univer-dv-list-dropdown",style:l,children:[/* @__PURE__ */em.jsx("div",{className:"univer-dv-list-dropdown-title",children:a}),/* @__PURE__ */em.jsx("div",{className:"univer-dv-list-dropdown-list",children:/* @__PURE__ */em.jsx(I.Scrollbar,{children:/* @__PURE__ */em.jsx("div",{className:"univer-dv-list-dropdown-list-container",children:h.map((e,a)=>{let o=t.indexOf(e.value)>-1,s=/* @__PURE__ */O(()=>{let a;a=new Set(o?t.filter(t=>t!==e.value):n?[...t,e.value]:[e.value]);let s=[];i.forEach(e=>{a.has(e.value)&&s.push(e.value)}),r(s)},"handleClick"),l=e.label.toLocaleLowerCase().indexOf(c);return /* @__PURE__ */em.jsxs("div",{className:"univer-dv-list-dropdown-item-container",onClick:s,children:[/* @__PURE__ */em.jsx("div",{className:"univer-dv-list-dropdown-item",style:{background:e.color||e$},children:c&&e.label.toLowerCase().includes(c)?/* @__PURE__ */em.jsxs(em.Fragment,{children:[/* @__PURE__ */em.jsx("span",{children:e.label.substring(0,l)}),/* @__PURE__ */em.jsx("span",{style:{fontWeight:"bold"},children:e.label.substring(l,l+c.length)}),/* @__PURE__ */em.jsx("span",{children:e.label.substring(l+c.length)})]}):e.label}),/* @__PURE__ */em.jsx("div",{className:"univer-dv-list-dropdown-selected-icon",children:o?/* @__PURE__ */em.jsx(eR,{}):null})]},a)})})},d)}),/* @__PURE__ */em.jsx("div",{className:"univer-dv-list-dropdown-split"}),/* @__PURE__ */em.jsx("div",{className:"univer-dv-list-dropdown-edit",children:/* @__PURE__ */em.jsx("a",{onClick:o,children:u.t("dataValidation.list.edit")})})]})},"SelectList");function tB(e){var t,r;let{location:n,hideFn:i}=e,{worksheet:a,row:o,col:u,unitId:c,subUnitId:h}=n,p=(0,s.useDependency)(l.DataValidationModel),[g,f]=(0,_.useState)(""),v=(0,s.useDependency)(s.ICommandService),C=(0,s.useDependency)(s.LocaleService),[b,E]=(0,_.useState)(""),T=(0,s.useDependency)(w.IEditorBridgeService),M=(0,s.useDependency)(s.IUniverInstanceService),D=(0,_.useMemo)(()=>p.ruleChange$.pipe((0,m.debounceTime)(16)),[]);(0,S.useObservable)(D);let U=(0,I.RectPopup).useContext(),P=U.right-U.left;if((0,_.useEffect)(()=>{let e=v.onCommandExecuted(e=>{var t,r;if(e.id===R.RichTextEditingMutation.id){let{unitId:n}=e.params,i=M.getUnit(n,s.UniverInstanceType.UNIVER_DOC);if(!i)return;f((0,s.BuildTextUtils).transform.getPlainText(null!=(r=null==(t=i.getSnapshot().body)?void 0:t.dataStream)?r:""))}});return()=>{e.dispose()}},[v,M]),!a)return null;let k=a.getCell(o,u),N=null==(t=null==k?void 0:k.dataValidation)?void 0:t.rule,A=null==(r=null==k?void 0:k.dataValidation)?void 0:r.validator,x=(null==N?void 0:N.renderMode)===s.DataValidationRenderMode.CUSTOM||(null==N?void 0:N.renderMode)===void 0;if(!k||!N||!A||0!==A.id.indexOf(s.DataValidationType.LIST))return;let L=N.type===s.DataValidationType.LIST_MULTIPLE,V=A.getListWithColor(N,c,h),F=eF(b||ej(a.getCellRaw(o,u))),j=/* @__PURE__ */O(()=>{v.executeCommand(tL.id,{ruleId:N.uid}),i()},"handleEdit"),H=V.map(e=>({label:e.label,value:e.label,color:x?e.color:"transparent"}));return /* @__PURE__ */em.jsx(t$,{style:{minWidth:P,maxWidth:Math.max(P,200)},title:L?C.t("dataValidation.listMultiple.dropdown"):C.t("dataValidation.list.dropdown"),value:F,multiple:L,onChange:/* @__PURE__ */O(e=>{let t=eV(e);T.isVisible()&&T.changeVisible({visible:!1,keycode:S.KeyCode.ESC,eventType:y.DeviceInputEventType.Keyboard,unitId:c}),v.executeCommand(d.SetRangeValuesCommand.id,{unitId:c,subUnitId:h,range:{startColumn:u,endColumn:u,startRow:o,endRow:o},value:{v:t,p:null,f:null,si:null}}),E(t),L||i()},"onChange"),options:H,onEdit:j,filter:g})}O(tB,"ListDropDown");var tW={exports:{}};tY=function(){var e="minute",t=/[+-]\d\d(?::?\d\d)?/g,r=/([+-]|\d\d)/g;return function(n,i,a){var o=i.prototype;a.utc=function(e){var t={date:e,utc:!0,args:arguments};return new i(t)},o.utc=function(t){var r=a(this.toDate(),{locale:this.$L,utc:!0});return t?r.add(this.utcOffset(),e):r},o.local=function(){return a(this.toDate(),{locale:this.$L,utc:!1})};var s=o.parse;o.parse=function(e){e.utc&&(this.$u=!0),this.$utils().u(e.$offset)||(this.$offset=e.$offset),s.call(this,e)};var l=o.init;o.init=function(){if(this.$u){var e=this.$d;this.$y=e.getUTCFullYear(),this.$M=e.getUTCMonth(),this.$D=e.getUTCDate(),this.$W=e.getUTCDay(),this.$H=e.getUTCHours(),this.$m=e.getUTCMinutes(),this.$s=e.getUTCSeconds(),this.$ms=e.getUTCMilliseconds()}else l.call(this)};var d=o.utcOffset;o.utcOffset=function(n,i){var a=this.$utils().u;if(a(n))return this.$u?0:a(this.$offset)?d.call(this):this.$offset;if("string"==typeof n&&null===(n=function(e){void 0===e&&(e="");var n=e.match(t);if(!n)return null;var i=(""+n[0]).match(r)||["-",0,0],a=i[0],o=60*+i[1]+ +i[2];return 0===o?0:"+"===a?o:-o}(n)))return this;var o=16>=Math.abs(n)?60*n:n,s=this;if(i)return s.$offset=o,s.$u=0===n,s;if(0!==n){var l=this.$u?this.toDate().getTimezoneOffset():-1*this.utcOffset();(s=this.local().add(o+l,e)).$offset=o,s.$x.$localOffset=l}else s=this.utc();return s};var u=o.format;o.format=function(e){var t=e||(this.$u?"YYYY-MM-DDTHH:mm:ss[Z]":"");return u.call(this,t)},o.valueOf=function(){var e=this.$utils().u(this.$offset)?0:this.$offset+(this.$x.$localOffset||this.$d.getTimezoneOffset());return this.$d.valueOf()-6e4*e},o.isUTC=function(){return!!this.$u},o.toISOString=function(){return this.toDate().toISOString()},o.toString=function(){return this.toDate().toUTCString()};var c=o.toDate;o.toDate=function(e){return"s"===e&&this.$offset?a(this.format("YYYY-MM-DD HH:mm:ss:SSS")).toDate():c.call(this)};var h=o.diff;o.diff=function(e,t,r){if(e&&this.$u===e.$u)return h.call(this,e,t,r);var n=this.local(),i=a(e).local();return h.call(n,i,t,r)}}},tW.exports=tY();let tG=/* @__PURE__ */en(tW.exports);var tY,tz,tK=Object.defineProperty,tq=Object.getOwnPropertyDescriptor,tX=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tq(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tK(t,r,a),a},"__decorateClass$d"),tZ=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$d");let tQ=(tz=class extends s.Disposable{constructor(e,t,r,n,i){super(),this._editorBridgeService=e,this._dataValidationModel=t,this._dataValidatorRegistryService=r,this._dialogService=n,this._localeService=i,this._initEditorBridgeInterceptor()}_initEditorBridgeInterceptor(){this._editorBridgeService.interceptor.intercept(this._editorBridgeService.interceptor.getInterceptPoints().AFTER_CELL_EDIT_ASYNC,{handler:/* @__PURE__ */O(async(e,r,n)=>{var i;let a=await e,{worksheet:o,row:l,col:d,unitId:u,subUnitId:c,workbook:h}=r,m=this._dataValidationModel.getRuleIdByLocation(u,c,l,d),p=m?this._dataValidationModel.getRuleById(u,c,m):void 0;if(!p||p.errorStyle!==s.DataValidationErrorStyle.STOP)return n(Promise.resolve(a));let g=await this._dataValidatorRegistryService.getValidatorItem(p.type);if(!g||await g.validator({value:G(a),interceptValue:G(null!=(i=null==r?void 0:r.origin)?i:a),row:l,column:d,unitId:u,subUnitId:c,worksheet:o,workbook:h,t:null==a?void 0:a.t},p))return n(Promise.resolve(a));let f=o.getCellRaw(l,d);return this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:g.getRuleFinalError(p)},footer:{title:/*@__PURE__*/t(_).createElement(I.Button,{type:"primary",onClick:/* @__PURE__ */O(()=>this._dialogService.close("reject-input-dialog"),"onClick")},this._localeService.t("dataValidation.alert.ok"))},onClose:/* @__PURE__ */O(()=>{this._dialogService.close("reject-input-dialog")},"onClose")}),n(Promise.resolve(f))},"handler")})}showReject(e){this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:e},footer:{title:/*@__PURE__*/t(_).createElement(I.Button,{type:"primary",onClick:/* @__PURE__ */O(()=>this._dialogService.close("reject-input-dialog"),"onClick")},this._localeService.t("dataValidation.alert.ok"))},onClose:/* @__PURE__ */O(()=>{this._dialogService.close("reject-input-dialog")},"onClose")})}},O(tz,"DataValidationRejectInputController"),tz);tQ=tX([(0,s.OnLifecycle)(s.LifecycleStages.Ready,tQ),tZ(0,w.IEditorBridgeService),tZ(1,(0,s.Inject)(J)),tZ(2,(0,s.Inject)(l.DataValidatorRegistryService)),tZ(3,S.IDialogService),tZ(4,(0,s.Inject)(s.LocaleService))],tQ);let tJ={dvDateDropdown:"univer-dv-date-dropdown",dvDateDropdownBtns:"univer-dv-date-dropdown-btns"};/*@__PURE__*/t(b).extend(tG);let t0=/* @__PURE__ */O(e=>{if(null==e||"boolean"==typeof e)return;if("number"==typeof e||!Number.isNaN(+e))return /*@__PURE__*/t(b)((0,s.numfmt).format("yyyy-MM-dd HH:mm:ss",Number(e)));let r=/*@__PURE__*/t(b)(e);if(r.isValid())return r},"transformDate");function t1(e){var r,n,i;let{location:a,hideFn:o}=e,{worksheet:l,row:u,col:c,unitId:h,subUnitId:m,workbook:p}=a,g=(0,s.useDependency)(s.ICommandService),f=(0,s.useDependency)(tQ),v=l.getCell(u,c),S=null==(r=null==v?void 0:v.dataValidation)?void 0:r.rule,C=null==(n=null==v?void 0:v.dataValidation)?void 0:n.validator,y=t0(G(l.getCellRaw(u,c))),[w,R]=(0,_.useState)(y),T=!!(null!=(i=null==S?void 0:S.bizInfo)&&i.showTime),M=w&&w.isValid()?w:/*@__PURE__*/t(b)(),D=(0,s.useDependency)(s.LocaleService);if(!v||!S||!C)return;let U=/* @__PURE__ */O(async()=>{var e,t,r;if(!M)return;let n=M.format(T?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD 00:00:00"),i=null==(e=(0,s.numfmt).parseDate(n))?void 0:e.v,a=p.getStyles().getStyleByCell(v),_=null!=(r=null==(t=null==a?void 0:a.n)?void 0:t.pattern)?r:"",I=(0,E.getPatternType)(_);S.errorStyle!==s.DataValidationErrorStyle.STOP||await C.validator({value:i,unitId:h,subUnitId:m,row:u,column:c,worksheet:l,workbook:p,interceptValue:n.replace("Z","").replace("T"," "),t:s.CellValueType.NUMBER},S)?(g.executeCommand(d.SetRangeValuesCommand.id,{unitId:h,subUnitId:m,range:{startColumn:c,endColumn:c,startRow:u,endRow:u},value:{v:i,t:2,p:null,f:null,si:null,s:{n:{pattern:T?"datetime"===I?_:"yyyy-MM-dd hh:mm:ss":"date"===I?_:"yyyy-MM-dd"}}}}),o()):f.showReject(C.getRuleFinalError(S))},"handleSave");return /* @__PURE__ */em.jsxs("div",{className:tJ.dvDateDropdown,children:[/* @__PURE__ */em.jsx(I.DatePanel,{defaultValue:M,pickerValue:M,showTime:T||void 0,onSelect:/* @__PURE__ */O(async e=>{R(e)},"onSelect"),onPanelChange:/* @__PURE__ */O(e=>{R(e)},"onPanelChange"),disabledDate:/* @__PURE__ */O(e=>!(0,s.numfmt).parseDate(e.format("YYYY-MM-DD")),"disabledDate")}),/* @__PURE__ */em.jsx("div",{className:tJ.dvDateDropdownBtns,children:/* @__PURE__ */em.jsx(I.Button,{size:"small",type:"primary",onClick:U,disabled:!M.isValid(),children:D.t("dataValidation.alert.ok")})})]})}O(t1,"DateDropdown");let t3="data-validation.list.dropdown",t2="data-validation.date.dropdown";function t4(e){var t;let{value:r,onChange:n}=e,i=(0,s.useDependency)(s.LocaleService);return /* @__PURE__ */em.jsx(I.FormLayout,{children:/* @__PURE__ */em.jsx(I.Checkbox,{checked:null==(t=r.bizInfo)?void 0:t.showTime,onChange:/* @__PURE__ */O(e=>{n({...r,bizInfo:{...r.bizInfo,showTime:e}})},"onChange"),children:i.t("dataValidation.showTime.label")})})}O(t4,"DateShowTimeOption"),t4.componentKey="DATE_SHOW_TIME_OPTION";let t9="{FORMULA1}",t5="{FORMULA2}",t6=/* @__PURE__ */O(e=>{var r,n;if(null==e||"boolean"==typeof e)return;if("number"==typeof e||!Number.isNaN(+e))return+e;let i=null==(r=(0,s.numfmt).parseDate(e))?void 0:r.v;return(0,s.Tools).isDefine(i)?i:null==(n=(0,s.numfmt).parseDate(/*@__PURE__*/t(b)(e).format("YYYY-MM-DD HH:mm:ss")))?void 0:n.v},"transformDate2SerialNumber"),t8=class extends l.BaseDataValidator{constructor(){super(...arguments),D(this,"id",s.DataValidationType.DATE),D(this,"title","dataValidation.date.title"),D(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),D(this,"scopes",["sheet"]),D(this,"formulaInput",e3),D(this,"optionsInput",t4.componentKey),D(this,"dropdown",t2),D(this,"_formulaService",this.injector.get(W))}async parseFormula(e,t,r){var n,i;let a=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:o,formula2:l}=e;return{formula1:t6((0,s.isFormulaString)(o)?et(null==(n=null==a?void 0:a[0])?void 0:n.result):o),formula2:t6((0,s.isFormulaString)(l)?et(null==(i=null==a?void 0:a[1])?void 0:i.result):l)}}parseFormulaSync(e,t,r){var n,i;let a=this._formulaService.getRuleFormulaResultSync(t,r,e.uid),{formula1:o,formula2:l}=e;return{formula1:t6((0,s.isFormulaString)(o)?et(null==(n=null==a?void 0:a[0])?void 0:n.result):o),formula2:t6((0,s.isFormulaString)(l)?et(null==(i=null==a?void 0:a[1])?void 0:i.result):l)}}async isValidType(e){let{interceptValue:t,value:r}=e;return"number"==typeof r&&"string"==typeof t||"string"==typeof t&&!!(0,s.numfmt).parseDate(t)}_validatorSingleFormula(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e)||!!(e&&(0,s.numfmt).parseDate(e)))}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=this._validatorSingleFormula(e.formula1),a=this.localeService.t("dataValidation.validFail.date");if(td.includes(n)){let t=this._validatorSingleFormula(e.formula2);return{success:i&&t,formula1:i?void 0:a,formula2:t?void 0:a}}return{success:i,formula1:i?void 0:a}}normalizeFormula(e,r,n){let{formula1:i,formula2:a,bizInfo:o}=e,l=/* @__PURE__ */O(e=>{var r;let n;if(!e)return e;if(Number.isNaN(+e)){let t=null==(r=(0,s.numfmt).parseDate(e))?void 0:r.v;if(null==t)return"";n=(0,s.numfmt).dateFromSerial(t)}else n=(0,s.numfmt).dateFromSerial(+e);return /*@__PURE__*/t(b)(`${n[0]}/${n[1]}/${n[2]} ${n[3]}:${n[4]}:${n[5]}`).format(null!=o&&o.showTime?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD")},"normlizeSingleFormula");return{formula1:(0,s.isFormulaString)(i)?i:l(`${i}`),formula2:(0,s.isFormulaString)(a)?a:l(`${a}`)}}transform(e,t,r){let{value:n}=e;return{...e,value:t6(n)}}async validatorIsEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!Number.isNaN(n)||i===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value>=a&&e.value<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value<a||e.value>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<=n}get operatorNames(){return this.operators.map(e=>this.localeService.t(to[e]))}generateRuleName(e){var t,r;if(!e.operator)return this.titleStr;let n=this.localeService.t(ts[e.operator]).replace(t9,null!=(t=e.formula1)?t:"").replace(t5,null!=(r=e.formula2)?r:"");return`${this.titleStr} ${n}`}generateRuleErrorMessage(e){var t,r;return e.operator?`${this.localeService.t(tl[e.operator]).replace(t9,null!=(t=e.formula1)?t:"").replace(t5,null!=(r=e.formula2)?r:"")}`:this.titleStr}};function t7(e){var t;let{value:r,onChange:n}=e,i=(0,s.useDependency)(s.LocaleService);return /* @__PURE__ */em.jsx(I.FormLayout,{label:i.t("dataValidation.renderMode.label"),children:/* @__PURE__ */em.jsxs(I.RadioGroup,{value:`${null!=(t=r.renderMode)?t:s.DataValidationRenderMode.CUSTOM}`,onChange:/* @__PURE__ */O(e=>n({...r,renderMode:+e}),"onChange"),children:[/* @__PURE__ */em.jsx(I.Radio,{value:`${s.DataValidationRenderMode.CUSTOM}`,children:i.t("dataValidation.renderMode.chip")}),/* @__PURE__ */em.jsx(I.Radio,{value:`${s.DataValidationRenderMode.ARROW}`,children:i.t("dataValidation.renderMode.arrow")}),/* @__PURE__ */em.jsx(I.Radio,{value:`${s.DataValidationRenderMode.TEXT}`,children:i.t("dataValidation.renderMode.text")})]})})}O(t8,"DateValidator"),O(t7,"ListRenderModeInput"),t7.componentKey="LIST_RENDER_MODE_OPTION_INPUT";var re=Object.defineProperty,rt=Object.getOwnPropertyDescriptor,rr=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?rt(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&re(t,r,a),a},"__decorateClass$c"),rn=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$c");let ri=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z");function ra(e,t){let r=e.length;return{id:"d",body:{dataStream:`${e}${s.DEFAULT_EMPTY_DOCUMENT_VALUE}`,textRuns:[{ts:{fs:11,ff:void 0,it:s.BooleanNumber.FALSE,bl:s.BooleanNumber.FALSE,ul:{s:s.BooleanNumber.FALSE},st:{s:s.BooleanNumber.FALSE},ol:{s:s.BooleanNumber.FALSE},cl:void 0,...t,bg:void 0,bd:void 0},st:0,ed:r}]},documentStyle:{pageSize:{width:Number.POSITIVE_INFINITY,height:Number.POSITIVE_INFINITY}}}}function ro(e,t,r){let n=ra(e,r),i=new s.DocumentDataModel(n),a=new y.DocumentViewModel(i);return{documentSkeleton:(0,y.DocumentSkeleton).create(a,t),docModel:i,docViewModel:a}}function rs(e,t,r){let{documentSkeleton:n,docModel:i,docViewModel:a}=ro(e,t,r);return{documents:new y.Documents(`DOCUMENTS_${(0,s.Tools).generateRandomId()}`,n,{pageMarginLeft:0,pageMarginTop:0}),documentSkeleton:n,docModel:i,docViewModel:a}}function rl(e,t,r,n,i,a,o=!0){let l=0,d=o?4:0;switch(i){case s.VerticalAlign.BOTTOM:l=t-2*d-n+d;break;case s.VerticalAlign.MIDDLE:l=(t-2*d-n)/2+d;break;default:l=d}l=Math.max(4,l);let u=0;switch(a){case s.HorizontalAlign.CENTER:u=(e-r)/2;break;case s.HorizontalAlign.RIGHT:u=e-r}return{paddingLeft:u=Math.max(6,u),paddingTop:l}}O(ra,"convertToDocumentData"),O(ro,"createDocSkeleton"),O(rs,"createDocuments"),O(rl,"calcPadding");let rd=(O(rX=class{constructor(e,t){D(this,"_dropdownInfoMap",/* @__PURE__ */new Map),D(this,"zIndex"),D(this,"onPointerEnter"),D(this,"onPointerLeave"),this._localeService=e,this._commandService=t}_ensureMap(e){let t=this._dropdownInfoMap.get(e);return t||(t=/* @__PURE__ */new Map,this._dropdownInfoMap.set(e,t)),t}_generateKey(e,t){return`${e}.${t}`}_drawDownIcon(e,t,r,n,i,a,o){let l;let{t:d=s.DEFAULT_STYLES.pd.t,b:u=s.DEFAULT_STYLES.pd.b}=o;switch(a){case s.VerticalAlign.MIDDLE:l=(n-4)/2;break;case s.VerticalAlign.BOTTOM:l=n-2-u-i/2;break;default:l=d+i/2-2}e.save(),e.translateWithPrecision(t.startX+(r-14),t.startY+l),e.fillStyle="#565656",e.fill(ri),e.restore()}drawWith(e,t,r){var n,i;let{primaryWithCoord:a,row:o,col:l,style:d,data:u,subUnitId:c}=t,h=a.isMergedMainCell?a.mergeInfo:a,m=null==(n=u.dataValidation)?void 0:n.rule,p=null==(i=u.dataValidation)?void 0:i.validator,{leftOffset:g=0,rightOffset:f=0,topOffset:v=0,downOffset:_=0}=u.fontRenderExtension||{};if(!m||!p||!p||0!==p.id.indexOf(s.DataValidationType.LIST)||!p.skipDefaultFontRender(m))return;let I={startX:h.startX+g,endX:h.endX-f,startY:h.startY+v,endY:h.endY-_},S=I.endX-I.startX,C=I.endY-I.startY,b=this._ensureMap(c),w=this._generateKey(o,l),R=p.getListWithColor(m),E=G(u),T=`${null!=E?E:""}`,M=R.find(e=>e.label===T),{tb:O,vt:D,ht:U,pd:P}=d||{};if(O=null!=O?O:s.WrapStrategy.WRAP,D=null!=D?D:s.VerticalAlign.BOTTOM,U=null!=U?U:s.DEFAULT_STYLES.ht,P=null!=P?P:s.DEFAULT_STYLES.pd,m.renderMode===s.DataValidationRenderMode.ARROW){let{l:t=s.DEFAULT_STYLES.pd.l,t:n=s.DEFAULT_STYLES.pd.t,r:i=s.DEFAULT_STYLES.pd.r,b:a=s.DEFAULT_STYLES.pd.b}=P,o=S-t-i-14,{documentSkeleton:l,documents:u,docModel:c}=rs(T,this._localeService,d);O===s.WrapStrategy.WRAP&&c.updateDocumentDataPageSize(Math.max(o,1)),l.calculate(),l.getActualSize();let{height:h,width:m}=(0,y.getDocsSkeletonPageSize)(l),{paddingTop:p,paddingLeft:g}=rl(o,C-n-a,m,h,D,U,!1);this._drawDownIcon(e,I,S,C,h,D,P),e.save(),e.translateWithPrecision(I.startX+t,I.startY+n),e.beginPath(),e.rect(0,0,S-t-i,C-n-a),e.clip(),e.translateWithPrecision(0,p),e.save(),e.translateWithPrecision(4,0),e.beginPath(),e.rect(0,0,o,h),e.clip(),u.render(e),e.translateWithPrecision(g,0),e.restore(),e.restore(),b.set(w,{left:I.endX+t+r.rowHeaderWidth-14,top:I.startY+n+r.columnHeaderHeight,width:14,height:C-n-a})}else{e.save(),e.translateWithPrecision(I.startX,I.startY),e.beginPath(),e.rect(0,0,S,C),e.clip();let t=S-12-4-14,{documentSkeleton:n,documents:i,docModel:a}=rs(T,this._localeService,d);O===s.WrapStrategy.WRAP&&a.updateDocumentDataPageSize(Math.max(t,1)),n.calculate();let{height:o,width:l}=(0,y.getDocsSkeletonPageSize)(n),{paddingTop:u,paddingLeft:c}=rl(t,C,l,o,D,U);e.translateWithPrecision(6,u);let h=Math.max(S-12,1);(0,y.Rect).drawWith(e,{width:h,height:o,fill:(null==M?void 0:M.color)||e$,radius:8}),e.save(),e.translateWithPrecision(4,0),e.beginPath(),e.rect(0,0,t,o),e.clip(),e.translateWithPrecision(c,0),i.render(e),e.restore(),e.translateWithPrecision(t+4+4,(o-4)/2),e.fillStyle="#565656",e.fill(ri),e.restore(),b.set(w,{left:I.startX+6+r.rowHeaderWidth,top:I.startY+u+r.columnHeaderHeight,width:h,height:o})}}calcCellAutoHeight(e){var t;let{primaryWithCoord:r,style:n,data:i}=e,a=r.isMergedMainCell?r.mergeInfo:r,{leftOffset:o=0,rightOffset:l=0,topOffset:d=0,downOffset:u=0}=i.fontRenderExtension||{},c=null==(t=i.dataValidation)?void 0:t.rule;if(!c||c.renderMode===s.DataValidationRenderMode.TEXT)return;let h={startX:a.startX+o,endX:a.endX-l,startY:a.startY+d,endY:a.endY-u},m=h.endX-h.startX,p=G(i),g=`${null!=p?p:""}`,{tb:f,pd:v}=n||{},{t:_=s.DEFAULT_STYLES.pd.t,b:I=s.DEFAULT_STYLES.pd.b}=null!=v?v:{};if(f=null!=f?f:s.WrapStrategy.WRAP,c.renderMode===s.DataValidationRenderMode.ARROW){let{documentSkeleton:e,docModel:t}=rs(g,this._localeService,n);f===s.WrapStrategy.WRAP&&t.updateDocumentDataPageSize(Math.max(m-14,1)),e.calculate(),e.getActualSize();let{height:r}=(0,y.getDocsSkeletonPageSize)(e);return r+_+I}{let{documentSkeleton:e,docModel:t}=ro(g,this._localeService,n);f===s.WrapStrategy.WRAP&&t.updateDocumentDataPageSize(Math.max(m-12-4-14,1)),e.calculate();let{height:r}=(0,y.getDocsSkeletonPageSize)(e);return r+8}}isHit(e,t){let{data:r,subUnitId:n,row:i,col:a}=t,o=this._ensureMap(n).get(this._generateKey(i,a)),l=r.dataValidation;if(!l||!o||l.rule.renderMode===s.DataValidationRenderMode.TEXT)return!1;let{top:d,left:u,width:c,height:h}=o,{x:m,y:p}=e;return m>=u&&m<=u+c&&p>=d&&p<=d+h}onPointerDown(e,t){if(2===t.button)return;let{unitId:r,subUnitId:n,row:i,col:a}=e;this._commandService.executeCommand(tj.id,{unitId:r,subUnitId:n,row:i,column:a})}},"DropdownWidget"),rX);function ru(e){if(!e)return[];let t=/* @__PURE__ */new Set;return e.forEach(e=>{e.forEach(e=>{var r,n;let i=G(e);if(null!=i){if("string"!=typeof i&&"object"==typeof(null==e?void 0:e.s)&&null!=(n=null==(r=e.s)?void 0:r.n)&&n.pattern){t.add((0,s.numfmt).format(e.s.n.pattern,i,{throws:!1}));return}t.add(i.toString())}})}),[...t]}rd=rr([rn(0,(0,s.Inject)(s.LocaleService)),rn(1,s.ICommandService)],rd),O(ru,"getRuleFormulaResultSet");let rc=["if","indirect","choose","offset"];function rh(e,t){if(!(0,s.isFormulaString)(e)||(0,u.isReferenceString)(e.slice(1)))return!0;let r=t.sequenceNodesBuilder(e);return r&&r.some(e=>"object"==typeof e&&e.nodeType===u.sequenceNodeType.FUNCTION&&rc.indexOf(e.token.toLowerCase())>-1)}function rm(e,t){let{formula1:r="",ranges:n}=e;if((0,u.isReferenceString)(r.slice(1))){let e=(0,u.deserializeRangeWithSheet)(r.slice(1));if((!e.sheetName||e.sheetName===t)&&n.some(t=>(0,s.Rectangle).intersects(t,e.range)))return!0}return!1}O(rh,"isValidListFormula"),O(rm,"isRuleIntersects");let rp=class extends l.BaseDataValidator{constructor(){super(...arguments),D(this,"formulaService",this.injector.get(W)),D(this,"_lexer",this.injector.get(u.LexerTreeBuilder)),D(this,"_univerInstanceService",this.injector.get(s.IUniverInstanceService)),D(this,"id",s.DataValidationType.LIST),D(this,"title","dataValidation.list.title"),D(this,"operators",[]),D(this,"scopes",["sheet"]),D(this,"formulaInput",e2),D(this,"canvasRender",this.injector.createInstance(rd)),D(this,"dropdown",t3),D(this,"optionsInput",t7.componentKey)}skipDefaultFontRender(e){return e.renderMode!==s.DataValidationRenderMode.TEXT}validatorFormula(e,t,r){var n,i,a;let o=!(0,s.Tools).isBlank(e.formula1),l=rh(null!=(n=e.formula1)?n:"",this._lexer),d=null==(a=null==(i=this._univerInstanceService.getUnit(t,s.UniverInstanceType.UNIVER_SHEET))?void 0:i.getSheetBySheetId(r))?void 0:a.getName(),u=rm(e,null!=d?d:"");return{success:!!(o&&l&&!u),formula1:o?l?u?this.localeService.t("dataValidation.validFail.listIntersects"):void 0:this.localeService.t("dataValidation.validFail.listInvalid"):this.localeService.t("dataValidation.validFail.list")}}getExtraStyle(e,t,{style:r}){var n;let i=null!=(n=r.tb!==s.WrapStrategy.OVERFLOW?r.tb:s.WrapStrategy.CLIP)?n:s.WrapStrategy.WRAP;if(e.type===s.DataValidationType.LIST&&(e.renderMode===s.DataValidationRenderMode.ARROW||e.renderMode===s.DataValidationRenderMode.TEXT)){let r=this.getListWithColorMap(e)[`${null!=t?t:""}`];if(r)return{bg:{rgb:r},tb:i}}return{tb:i}}parseCellValue(e){return eF(e.toString())}async parseFormula(e,t,r){var n;let{formula1:i=""}=e,a=await this.formulaService.getRuleFormulaResult(t,r,e.uid);return{formula1:(0,s.isFormulaString)(i)?ru(null==(n=null==a?void 0:a[0])?void 0:n.result):eF(i),formula2:void 0}}async isValidType(e,t,r){let{value:n}=e,{formula1:i=[]}=t;return this.parseCellValue(n).every(e=>i.includes(e))}generateRuleName(){return this.localeService.t("dataValidation.list.name")}generateRuleErrorMessage(){return this.localeService.t("dataValidation.list.error")}getList(e,t,r){var n,i,a;let{formula1:o=""}=e,l=this.injector.get(s.IUniverInstanceService),d=null!=(n=t?l.getUniverSheetInstance(t):void 0)?n:l.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);if(!d)return[];let u=null!=(i=r?d.getSheetBySheetId(r):void 0)?i:d.getActiveSheet();if(!u)return[];let c=d.getUnitId(),h=u.getSheetId(),m=this.formulaService.getRuleFormulaResultSync(c,h,e.uid);return(0,s.isFormulaString)(o)?ru(null==(a=null==m?void 0:m[0])?void 0:a.result):eF(o)}async getListAsync(e,t,r){var n,i,a;let{formula1:o=""}=e,l=this.injector.get(s.IUniverInstanceService),d=null!=(n=t?l.getUniverSheetInstance(t):void 0)?n:l.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);if(!d)return[];let u=null!=(i=r?d.getSheetBySheetId(r):void 0)?i:d.getActiveSheet();if(!u)return[];let c=d.getUnitId(),h=u.getSheetId(),m=await this.formulaService.getRuleFormulaResult(c,h,e.uid);return(0,s.isFormulaString)(o)?ru(null==(a=null==m?void 0:m[0])?void 0:a.result):eF(o)}getListWithColor(e,t,r){let n=this.getList(e,t,r),i=(e.formula2||"").split(",");return n.map((e,t)=>({label:e,color:i[t]}))}getListWithColorMap(e,t,r){let n=this.getListWithColor(e,t,r),i={};return n.forEach(e=>{e.color&&(i[e.label]=e.color)}),i}};O(rp,"ListValidator");let rg=rp;function rf(e){let t=e;return"string"==typeof e?((e.startsWith("")||e.startsWith("$"))&&(t=e.slice(1)),+t):+e}O(rf,"getCellValueNumber");let rv=class extends l.BaseDataValidator{constructor(){super(...arguments),D(this,"_formulaService",this.injector.get(W)),D(this,"id",s.DataValidationType.DECIMAL),D(this,"title","dataValidation.decimal.title"),D(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),D(this,"scopes",["sheet"]),D(this,"formulaInput",e3),D(this,"dropDownInput")}_isFormulaOrNumber(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e))}async isValidType(e,t,r){let{value:n}=e;return!Number.isNaN(rf(n))}transform(e,t,r){let{value:n}=e;return{...e,value:rf(n)}}_parseNumber(e){return null==e?Number.NaN:+e}async parseFormula(e,t,r){var n,i,a,o,l,d,u,c;let h=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:m,formula2:p}=e;return{formula1:this._parseNumber((0,s.isFormulaString)(m)?null==(o=null==(a=null==(i=null==(n=null==h?void 0:h[0])?void 0:n.result)?void 0:i[0])?void 0:a[0])?void 0:o.v:m),formula2:this._parseNumber((0,s.isFormulaString)(p)?null==(c=null==(u=null==(d=null==(l=null==h?void 0:h[1])?void 0:l.result)?void 0:d[0])?void 0:u[0])?void 0:c.v:p)}}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=(0,s.Tools).isDefine(e.formula1)&&this._isFormulaOrNumber(e.formula1),a=(0,s.Tools).isDefine(e.formula2)&&this._isFormulaOrNumber(e.formula2),o=td.includes(n),l=this.localeService.t("dataValidation.validFail.number");return o?{success:i&&a,formula1:i?void 0:l,formula2:a?void 0:l}:{success:i,formula1:i?"":l}}async validatorIsEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!Number.isNaN(n)||i===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value>=a&&e.value<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value<a||e.value>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<=n}};O(rv,"DecimalValidator");let r_=class extends l.BaseDataValidator{constructor(){super(...arguments),D(this,"id",s.DataValidationType.TEXT_LENGTH),D(this,"title","dataValidation.textLength.title"),D(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),D(this,"scopes",["sheet"]),D(this,"formulaInput",e3),D(this,"_formulaService",this.injector.get(W))}_isFormulaOrInt(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=(0,s.Tools).isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),a=(0,s.Tools).isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),o=td.includes(n),l=this.localeService.t("dataValidation.validFail.number");return o?{success:i&&a,formula1:i?void 0:l,formula2:a?void 0:l}:{success:i,formula1:l}}_parseNumber(e){return null==e?Number.NaN:+e}_isValidFormula(e){return!Number.isNaN(e)}async parseFormula(e,t,r){var n,i,a,o,l,d,u,c;let h=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:m,formula2:p}=e;return{formula1:this._parseNumber((0,s.isFormulaString)(m)?null==(o=null==(a=null==(i=null==(n=null==h?void 0:h[0])?void 0:n.result)?void 0:i[0])?void 0:a[0])?void 0:o.v:m),formula2:this._parseNumber((0,s.isFormulaString)(p)?null==(c=null==(u=null==(d=null==(l=null==h?void 0:h[1])?void 0:l.result)?void 0:d[0])?void 0:u[0])?void 0:c.v:p)}}transform(e,t,r){return{...e,value:e.value.toString().length}}async isValidType(e,t,r){let{value:n}=e;return"string"==typeof n||"number"==typeof n}async validatorIsEqual(e,t,r){let{formula1:n}=t;return!!(0,s.Tools).isDefine(n)&&e.value===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!(0,s.Tools).isDefine(n)&&e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t,{value:a}=e;if(!this._isValidFormula(n)||!this._isValidFormula(i))return!1;let o=Math.max(n,i);return a>=Math.min(n,i)&&a<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t,{value:a}=e;if(!this._isValidFormula(n)||!this._isValidFormula(i))return!1;let o=Math.max(n,i);return a<Math.min(n,i)||a>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i<=n}generateRuleErrorMessage(e){var t,r;return e.operator?`${this.localeService.t(l.TextLengthErrorTitleMap[e.operator]).replace("{FORMULA1}",null!=(t=e.formula1)?t:"").replace("{FORMULA2}",null!=(r=e.formula2)?r:"")}`:this.titleStr}};function rI(e){var t,r;return!e||(e.p?!(null!=(r=null==(t=e.p.body)?void 0:t.dataStream)?r:"").slice(0,-2).trim():(0,s.Tools).isBlank(e.v))}function rS(e,t,r,n,i="command",a=!0){let o=[],u=[],c=n.get(J),h=n.get(s.IUniverInstanceService),m=(0,d.getSheetCommandTarget)(h,{unitId:e,subUnitId:t});if(!m)return{redoMutations:o,undoMutations:u};let{worksheet:p}=m,g=new s.ObjectMatrix;function f(e,t){a&&e.forEach(e=>{(0,s.Range).foreach(e,(e,r)=>{let n=p.getCellRaw(e,r),i=Y(n);(rI(n)||i===t)&&g.setValue(e,r,{v:t,p:null})})})}O(f,"setRangesDefaultValue"),r.forEach(r=>{switch(r.type){case"delete":o.push({id:l.RemoveDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.rule.uid,source:i}}),u.unshift({id:l.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:r.rule,index:r.index,source:i}});break;case"update":{o.push({id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.ruleId,payload:{type:l.UpdateRuleType.RANGE,payload:r.newRanges},source:i}}),u.unshift({id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.ruleId,payload:{type:l.UpdateRuleType.RANGE,payload:r.oldRanges},source:i}});let n=c.getRuleById(e,t,r.ruleId);if(n&&n.type===s.DataValidationType.CHECKBOX){let i=c.getValidator(s.DataValidationType.CHECKBOX).parseFormulaSync(n,e,t);f(r.newRanges,i.formula2)}break}case"add":if(o.push({id:l.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:r.rule,source:i}}),u.unshift({id:l.RemoveDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.rule.uid,source:i}}),r.rule.type===s.DataValidationType.CHECKBOX){let n=c.getValidator(s.DataValidationType.CHECKBOX).parseFormulaSync(r.rule,e,t);f(r.rule.ranges,n.originFormula2)}}});let v={id:d.SetRangeValuesMutation.id,params:{unitId:e,subUnitId:t,cellValue:g.getData()}},_={id:d.SetRangeValuesMutation.id,params:(0,d.SetRangeValuesUndoMutationFactory)(n,v.params)};return o.push(v),u.push(_),{redoMutations:o,undoMutations:u}}O(r_,"TextLengthValidator"),O(rI,"isBlankCell"),O(rS,"getDataValidationDiffMutations");let rC={type:s.CommandType.COMMAND,id:"sheet.command.updateDataValidationRuleRange",async handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ranges:i,ruleId:a}=t,o=e.get(J),l=e.get(s.ICommandService),d=e.get(s.IUndoRedoService);if(!o.getRuleById(r,n,a))return!1;let u=o.getRuleObjectMatrix(r,n).clone();u.updateRange(a,i);let c=u.diff(o.getRules(r,n)),{redoMutations:h,undoMutations:m}=rS(r,n,c,e);return d.pushUndoRedo({undoMutations:m,redoMutations:h,unitID:r}),await (0,s.sequenceExecuteAsync)(h,l),!0}},ry={type:s.CommandType.COMMAND,id:"sheet.command.addDataValidation",async handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,rule:i}=t,a=e.get(J),o=e.get(s.ICommandService),d=e.get(s.IUndoRedoService),u=a.getRuleObjectMatrix(r,n).clone();u.addRule(i);let c=u.diff(a.getRules(r,n)),{redoMutations:h,undoMutations:m}=rS(r,n,c,e);return h.push({id:l.AddDataValidationMutation.id,params:{unitId:r,subUnitId:n,rule:i}}),m.unshift({id:l.RemoveDataValidationMutation.id,params:{unitId:r,subUnitId:n,ruleId:i.uid}}),d.pushUndoRedo({unitID:r,redoMutations:h,undoMutations:m}),await (0,s.sequenceExecuteAsync)(h,o),!0}},rb={type:s.CommandType.COMMAND,id:"data-validation.command.addRuleAndOpen",async handler(e){let t=e.get(s.IUniverInstanceService),r=(0,d.getSheetCommandTarget)(t);if(!r)return!1;let{workbook:n,worksheet:i}=r,a=ee(e),o=e.get(s.ICommandService),l=n.getUnitId(),u=i.getSheetId();return!!await o.executeCommand(ry.id,{rule:a,unitId:l,subUnitId:u})&&(o.executeCommand(tL.id,{ruleId:a.uid,isAdd:!0}),!0)}},rw={type:s.CommandType.COMMAND,id:"sheets.command.update-data-validation-setting",handler(e,t){if(!t)return!1;let r=e.get(s.ICommandService),n=e.get(s.IUndoRedoService),i=e.get(J),a=e.get(l.DataValidatorRegistryService),{unitId:o,subUnitId:u,ruleId:c,setting:h}=t,m=a.getValidatorItem(h.type);if(!m)return!1;let p=i.getRuleById(o,u,c);if(!p)return!1;let g={...p,...h};if(!m.validatorFormula(g,o,u).success)return!1;let f={unitId:o,subUnitId:u,ruleId:c,payload:{type:l.UpdateRuleType.SETTING,payload:{...h,...m.normalizeFormula(g,o,u)}}},v=[{id:l.UpdateDataValidationMutation.id,params:f}],_={unitId:o,subUnitId:u,ruleId:c,payload:{type:l.UpdateRuleType.SETTING,payload:(0,l.getRuleSetting)(p)}},I=[{id:l.UpdateDataValidationMutation.id,params:_}];if(h.type===s.DataValidationType.CHECKBOX){let t=p.ranges,r=e.get(s.IUniverInstanceService),n=(0,d.getSheetCommandTarget)(r,{unitId:o,subUnitId:u});if(n){let r=new s.ObjectMatrix,{worksheet:i}=n,{formula2:a=tr,formula1:l=tt}=p,{formula2:c=tr,formula1:m=tt}=h;t.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=i.getCellRaw(e,t),o=Y(n);rI(n)||o===String(a)?r.setValue(e,t,{v:c,p:null}):o===String(l)&&r.setValue(e,t,{v:m,p:null})})});let g={id:d.SetRangeValuesMutation.id,params:{unitId:o,subUnitId:u,cellValue:r.getData()}},f={id:d.SetRangeValuesMutation.id,params:(0,d.SetRangeValuesUndoMutationFactory)(e,g.params)};v.push(g),I.push(f)}}return!!(0,s.sequenceExecute)(v,r).result&&(n.pushUndoRedo({unitID:o,redoMutations:v,undoMutations:I}),!0)}},rR={type:s.CommandType.COMMAND,id:"sheets.command.update-data-validation-options",handler(e,t){if(!t)return!1;let r=e.get(s.ICommandService),n=e.get(s.IUndoRedoService),i=e.get(J),{unitId:a,subUnitId:o,ruleId:d,options:u}=t,c=i.getRuleById(a,o,d);if(!c)return!1;let h={unitId:a,subUnitId:o,ruleId:d,payload:{type:l.UpdateRuleType.OPTIONS,payload:u}},m=[{id:l.UpdateDataValidationMutation.id,params:h}],p={unitId:a,subUnitId:o,ruleId:d,payload:{type:l.UpdateRuleType.OPTIONS,payload:(0,l.getRuleOptions)(c)}},g=[{id:l.UpdateDataValidationMutation.id,params:p}];return n.pushUndoRedo({unitID:a,redoMutations:m,undoMutations:g}),r.executeCommand(l.UpdateDataValidationMutation.id,h),!0}},rE={type:s.CommandType.COMMAND,id:"sheets.command.clear-range-data-validation",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ranges:i}=t,a=e.get(s.ICommandService),o=e.get(s.IUniverInstanceService),l=(0,d.getSheetCommandTarget)(o,{unitId:r,subUnitId:n}),u=e.get(J);if(!l)return!1;let c=e.get(s.IUndoRedoService),h=u.getRuleObjectMatrix(r,n).clone();h.removeRange(i);let m=h.diff(u.getRules(r,n)),{redoMutations:p,undoMutations:g}=rS(r,n,m,e);return c.pushUndoRedo({unitID:r,redoMutations:p,undoMutations:g}),(0,s.sequenceExecute)(p,a).result}},rT={type:s.CommandType.COMMAND,id:"sheet.command.remove-all-data-validation",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n}=t,i=e.get(s.ICommandService),a=e.get(J),o=e.get(s.IUndoRedoService),d=[...a.getRules(r,n)],u={unitId:r,subUnitId:n,ruleId:d.map(e=>e.uid)},c=[{id:l.RemoveDataValidationMutation.id,params:u}],h=[{id:l.AddDataValidationMutation.id,params:{unitId:r,subUnitId:n,rule:d}}];return o.pushUndoRedo({redoMutations:c,undoMutations:h,unitID:r}),i.executeCommand(l.RemoveDataValidationMutation.id,u),!0}},rM=/* @__PURE__ */O((e,t)=>{let r=e.get(J),{unitId:n,subUnitId:i,ruleId:a,source:o}=t;if(Array.isArray(a)){let e=a.map(e=>r.getRuleById(n,i,e)).filter(Boolean);return[{id:l.AddDataValidationMutation.id,params:{unitId:n,subUnitId:i,rule:e,source:o}}]}return[{id:l.AddDataValidationMutation.id,params:{unitId:n,subUnitId:i,rule:{...r.getRuleById(n,i,a)},index:r.getRuleIndex(n,i,a)}}]},"removeDataValidationUndoFactory"),rO={type:s.CommandType.COMMAND,id:"sheet.command.remove-data-validation-rule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ruleId:i}=t,a=e.get(s.ICommandService),o=e.get(s.IUndoRedoService),d=e.get(J),u=[{id:l.RemoveDataValidationMutation.id,params:t}],c=[{id:l.AddDataValidationMutation.id,params:{unitId:r,subUnitId:n,rule:{...d.getRuleById(r,n,i)},index:d.getRuleIndex(r,n,i)}}];return o.pushUndoRedo({undoMutations:c,redoMutations:u,unitID:t.unitId}),a.executeCommand(l.RemoveDataValidationMutation.id,t),!0}},rD="sheets-data-validation.config",rU={};function rP(e){return!(0,u.ERROR_TYPE_SET).has(e)}O(rP,"isLegalFormulaResult");let rk=class extends l.BaseDataValidator{constructor(){super(...arguments),D(this,"id",s.DataValidationType.CUSTOM),D(this,"title","dataValidation.custom.title"),D(this,"operators",[]),D(this,"scopes",["sheet"]),D(this,"formulaInput",e1),D(this,"_customFormulaService",this.injector.get(L))}validatorFormula(e,t,r){let n=(0,s.isFormulaString)(e.formula1);return{success:n,formula1:n?"":this.localeService.t("dataValidation.validFail.formula")}}async parseFormula(e,t,r){return{formula1:void 0,formula2:void 0}}async isValidType(e,t,r){let{column:n,row:i,unitId:a,subUnitId:o}=e,l=await this._customFormulaService.getCellFormulaValue(a,o,i,n),d=er(null==l?void 0:l.result),u=null==d?void 0:d.v;return!!(0,s.Tools).isDefine(u)&&""!==u&&(d.t===s.CellValueType.BOOLEAN?!!u:"boolean"==typeof u?u:"number"==typeof u?!!u:"string"==typeof u?rP(u):!!u)}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.custom.error")}};function rN(e,t){let r=(0,y.FontCache).getTextSize(e,t),n=r.width+8,{ba:i,bd:a}=r;return{width:n,height:i+a+0,ba:i}}function rA(e,t,r,n){let i;let a=r-14-6,o=e.map(e=>({layout:rN(e,t),text:e})),s=[];o.forEach(e=>{let{layout:t}=e,{width:r,height:n}=t;!i||i.width+r+4>a?(i={width:r,height:n,items:[{...e,left:0}]},s.push(i)):(i.items.push({...e,left:i.width+4}),i.width=i.width+r+4)});let l=0;return s.forEach((e,t)=>{t===s.length-1?l+=e.height:l+=e.height+4}),{lines:s,totalHeight:l,contentWidth:a,contentHeight:n-12,cellAutoHeight:l+12}}O(rk,"CustomFormulaValidator"),O(rN,"getDropdownItemSize"),O(rA,"layoutDropdowns");let rx=class extends y.Shape{static drawWith(e,t){let{fontFamily:r,fontString:n,fontSize:i,info:a,fill:o,color:s}=t,{layout:l,text:d}=a;e.save(),(0,y.Rect).drawWith(e,{width:l.width,height:l.height,radius:8,fill:o||e$}),e.translateWithPrecision(4,l.ba),e.font=n,e.fillStyle=s,e.fillText(d,0,0),e.restore()}};O(rx,"Dropdown");var rL=Object.defineProperty,rV=Object.getOwnPropertyDescriptor,rF=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?rV(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&rL(t,r,a),a},"__decorateClass$b"),rj=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$b");let rH=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z"),r$=(O(rZ=class{constructor(e){D(this,"zIndex"),D(this,"_dropdownInfoMap",/* @__PURE__ */new Map),this._commandService=e}_ensureMap(e){let t=this._dropdownInfoMap.get(e);return t||(t=/* @__PURE__ */new Map,this._dropdownInfoMap.set(e,t)),t}_generateKey(e,t){return`${e}.${t}`}_drawDownIcon(e,t,r,n,i){let a=4;switch(i){case s.VerticalAlign.MIDDLE:a=(n-14)/2+4;break;case s.VerticalAlign.BOTTOM:a=n-14+4}e.save(),e.translateWithPrecision(t.startX+(r-14+4),t.startY+a),e.fillStyle="#565656",e.fill(rH),e.restore()}drawWith(e,t,r,n){var i,a;let{primaryWithCoord:o,row:l,col:d,style:u,data:c,subUnitId:h}=t,m=o.isMergedMainCell?o.mergeInfo:o,{leftOffset:p=0,rightOffset:g=0,topOffset:f=0,downOffset:v=0}=c.fontRenderExtension||{},_=c.dataValidation,I=this._ensureMap(h),S=this._generateKey(l,d);if(!_)return;let C={startX:m.startX+p,endX:m.endX-g,startY:m.startY+f,endY:m.endY-v},b=C.endX-C.startX,w=C.endY-C.startY,{cl:R}=u||{},E=null!=(i="object"==typeof R?null==R?void 0:R.rgb:R)?i:"#000",T=(0,y.getFontStyleString)(null!=u?u:void 0),{rule:M,validator:O}=_,{vt:D,ht:U}=u||{},P=null!=D?D:s.VerticalAlign.MIDDLE,k=null!=(a=G(c))?a:"",N=O.parseCellValue(k),A=O.getListWithColorMap(M),x=rA(N,T,b,w);this._drawDownIcon(e,C,b,w,P),e.save(),e.translateWithPrecision(C.startX,C.startY),e.beginPath(),e.rect(0,0,b-14,w),e.clip(),e.translateWithPrecision(6,6);let L=0;switch(P){case s.VerticalAlign.MIDDLE:L=(x.contentHeight-x.totalHeight)/2;break;case s.VerticalAlign.BOTTOM:L=x.contentHeight-x.totalHeight}e.translateWithPrecision(0,L),x.lines.forEach((t,r)=>{e.save();let{width:n,height:i,items:a}=t,o=0;switch(U){case s.HorizontalAlign.RIGHT:o=x.contentWidth-n;break;case s.HorizontalAlign.CENTER:o=(x.contentWidth-n)/2}e.translate(o,r*(i+4)),a.forEach(t=>{e.save(),e.translateWithPrecision(t.left,0),rx.drawWith(e,{...T,info:t,color:E,fill:A[t.text]}),e.restore()}),e.restore()}),e.restore(),I.set(S,{left:C.startX,top:C.startY,width:x.contentWidth+6+14,height:x.contentHeight+12})}calcCellAutoHeight(e){var t;let{primaryWithCoord:r,style:n,data:i}=e,{leftOffset:a=0,rightOffset:o=0,topOffset:s=0,downOffset:l=0}=i.fontRenderExtension||{},d=r.isMergedMainCell?r.mergeInfo:r,u={startX:d.startX+a,endX:d.endX-o,startY:d.startY+s,endY:d.endY-l},c=i.dataValidation;if(!c)return;let h=u.endX-u.startX,m=u.endY-u.startY,p=null!=(t=G(i))?t:"",{validator:g}=c;return rA(g.parseCellValue(p),(0,y.getFontStyleString)(null!=n?n:void 0),h,m).cellAutoHeight}isHit(e,t){let{primaryWithCoord:r}=t,{endX:n}=r.isMergedMainCell?r.mergeInfo:r,{x:i}=e;return i>=n-14&&i<=n}onPointerDown(e,t){if(2===t.button)return;let{unitId:r,subUnitId:n,row:i,col:a}=e;this._commandService.executeCommand(tj.id,{unitId:r,subUnitId:n,row:i,column:a})}},"DropdownMultipleWidget"),rZ);r$=rF([rj(0,s.ICommandService)],r$);let rB=class extends rg{constructor(){super(...arguments),D(this,"id",s.DataValidationType.LIST_MULTIPLE),D(this,"title","dataValidation.listMultiple.title"),D(this,"canvasRender",this.injector.createInstance(r$))}skipDefaultFontRender(){return!0}};O(rB,"ListMultipleValidator");let rW=class extends l.BaseDataValidator{constructor(){super(...arguments),D(this,"_formulaService",this.injector.get(W)),D(this,"id",s.DataValidationType.WHOLE),D(this,"title","dataValidation.whole.title"),D(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),D(this,"scopes",["sheet"]),D(this,"formulaInput",e3),D(this,"dropDownInput")}_isFormulaOrInt(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}async isValidType(e,t,r){let{value:n}=e,i=rf(n);return!Number.isNaN(i)&&Number.isInteger(i)}transform(e,t,r){let{value:n}=e;return{...e,value:rf(n)}}_parseNumber(e){return null==e?Number.NaN:+e}async parseFormula(e,t,r){var n,i,a,o,l,d,u,c;let h=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:m,formula2:p}=e;return{formula1:this._parseNumber((0,s.isFormulaString)(m)?null==(o=null==(a=null==(i=null==(n=null==h?void 0:h[0])?void 0:n.result)?void 0:i[0])?void 0:a[0])?void 0:o.v:m),formula2:this._parseNumber((0,s.isFormulaString)(p)?null==(c=null==(u=null==(d=null==(l=null==h?void 0:h[1])?void 0:l.result)?void 0:d[0])?void 0:u[0])?void 0:c.v:p)}}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=(0,s.Tools).isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),a=(0,s.Tools).isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),o=td.includes(n),l=this.localeService.t("dataValidation.validFail.number");return o?{success:i&&a,formula1:i?void 0:l,formula2:a?void 0:l}:{success:i,formula1:l}}async validatorIsEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!Number.isNaN(n)||i===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value>=a&&e.value<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value<a||e.value>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<=n}};O(rW,"WholeValidator");let rG="data-validation-single",rY="sheet.menu.data-validation";function rz(e){return{id:rY,type:S.MenuItemType.SUBITEMS,icon:rG,tooltip:"dataValidation.title",hidden$:(0,S.getMenuHiddenObservable)(e,s.UniverInstanceType.UNIVER_SHEET),disabled$:(0,w.getCurrentRangeDisable$)(e,{workbookTypes:[d.WorkbookEditablePermission],worksheetTypes:[d.WorksheetSetCellStylePermission,d.WorksheetEditPermission],rangeTypes:[d.RangeProtectionPermissionEditPoint]})}}function rK(e){return{id:tL.id,title:"dataValidation.panel.title",type:S.MenuItemType.BUTTON}}function rq(e){return{id:rb.id,title:"dataValidation.panel.add",type:S.MenuItemType.BUTTON}}O(rz,"dataValidationMenuFactory"),O(rK,"openDataValidationMenuFactory"),O(rq,"addDataValidationMenuFactory");var rX,rZ,rQ,rJ=Object.defineProperty,r0=Object.getOwnPropertyDescriptor,r1=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?r0(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&rJ(t,r,a),a},"__decorateClass$a"),r3=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$a");let r2=(rQ=class extends s.RxDisposable{constructor(e,t,r,n,i,a,o){super(),this._univerInstanceService=e,this._dataValidatorRegistryService=t,this._injector=r,this._componentManger=n,this._selectionManagerService=i,this._sheetInterceptorService=a,this._sheetDataValidationModel=o,this._init()}_init(){this._registerValidators(),this._initCommandInterceptor(),this._initComponents()}_registerValidators(){[rv,rW,r_,t8,ta,rg,rB,rk].forEach(e=>{let t=this._injector.createInstance(e);this.disposeWithMe(this._dataValidatorRegistryService.register(t)),this.disposeWithMe({dispose:/* @__PURE__ */O(()=>{this._injector.delete(e)},"dispose")})})}_initCommandInterceptor(){this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */O(e=>{var t;if(e.id===d.ClearSelectionAllCommand.id){let e=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),r=e.getUnitId(),n=e.getActiveSheet();if(!n)throw Error("No active sheet found");let i=n.getSheetId(),a=null==(t=this._selectionManagerService.getCurrentSelections())?void 0:t.map(e=>e.range),o=this._sheetDataValidationModel.getRuleObjectMatrix(r,i).clone();a&&o.removeRange(a);let l=o.diff(this._sheetDataValidationModel.getRules(r,i)),{redoMutations:d,undoMutations:u}=rS(r,i,l,this._injector,"patched");return{undos:u,redos:d}}return{undos:[],redos:[]}},"getMutations")})}_initComponents(){[[rG,eT],[tx,tT],[tO,tM],[t3,tB],[t2,t1],[t7.componentKey,t7],[t4.componentKey,t4],...e9].forEach(([e,t])=>{this.disposeWithMe(this._componentManger.register(e,t))})}},O(rQ,"DataValidationController"),rQ);r2=r1([(0,s.OnLifecycle)(s.LifecycleStages.Rendered,r2),r3(0,s.IUniverInstanceService),r3(1,(0,s.Inject)(l.DataValidatorRegistryService)),r3(2,(0,s.Inject)(s.Injector)),r3(3,(0,s.Inject)(S.ComponentManager)),r3(4,(0,s.Inject)(d.SheetsSelectionsService)),r3(5,(0,s.Inject)(d.SheetInterceptorService)),r3(6,(0,s.Inject)(J))],r2);var r4=Object.defineProperty,r9=Object.getOwnPropertyDescriptor,r5=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?r9(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&r4(t,r,a),a},"__decorateClass$9"),r6=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let r8="SHEET_DATA_VALIDATION_ALERT",r7=(O(ne=class extends s.Disposable{constructor(e,t,r,n,i){super(),this._hoverManagerService=e,this._cellAlertManagerService=t,this._univerInstanceService=r,this._localeService=n,this._zenZoneService=i,this._init()}_init(){this._initCellAlertPopup(),this._initZenService()}_initCellAlertPopup(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe((0,m.debounceTime)(100)).subscribe(e=>{var t,r;if(e){let n=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET).getActiveSheet();if(!n)return;let i=n.getCell(e.location.row,e.location.col);if((null==(t=null==i?void 0:i.dataValidation)?void 0:t.validStatus)===s.DataValidationStatus.INVALID){let t=this._cellAlertManagerService.currentAlert.get(r8),n=null==(r=null==t?void 0:t.alert)?void 0:r.location;if(n&&n.row===e.location.row&&n.col===e.location.col&&n.subUnitId===e.location.subUnitId&&n.unitId===e.location.unitId)return;let a=i.dataValidation.validator,o=i.dataValidation.rule;if(!a)return;this._cellAlertManagerService.showAlert({type:w.CellAlertType.ERROR,title:this._localeService.t("dataValidation.error.title"),message:null==a?void 0:a.getRuleFinalError(o),location:e.location,width:200,height:74,key:r8});return}}this._cellAlertManagerService.removeAlert(r8)}))}_initZenService(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&this._cellAlertManagerService.removeAlert(r8)}))}},"DataValidationAlertController"),ne);r7=r5([(0,s.OnLifecycle)(s.LifecycleStages.Rendered,r7),r6(0,(0,s.Inject)(w.HoverManagerService)),r6(1,(0,s.Inject)(w.CellAlertManagerService)),r6(2,s.IUniverInstanceService),r6(3,(0,s.Inject)(s.LocaleService)),r6(4,S.IZenZoneService)],r7);var ne,nt,nr=Object.defineProperty,nn=Object.getOwnPropertyDescriptor,ni=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nn(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nr(t,r,a),a},"__decorateClass$8"),na=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");let no=(nt=class extends s.Disposable{constructor(e,t,r){super(),D(this,"_copyInfo"),this._sheetClipboardService=e,this._sheetDataValidationModel=t,this._injector=r,this._initCopyPaste()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:eH,onBeforeCopy:/* @__PURE__ */O((e,t,r)=>this._collect(e,t,r),"onBeforeCopy"),onPasteCells:/* @__PURE__ */O((e,t,r,n)=>{let{copyType:i=w.COPY_TYPE.COPY,pasteType:a}=n,{range:o}=e||{},{range:s,unitId:l,subUnitId:d}=t;return this._generateMutations(s,{copyType:i,pasteType:a,copyRange:o,unitId:l,subUnitId:d})},"onPasteCells")})}_collect(e,t,r){let n=new s.ObjectMatrix;this._copyInfo={unitId:e,subUnitId:t,matrix:n};let i=this._injector.invoke(n=>(0,w.rangeToDiscreteRange)(r,n,e,t));if(!i)return;let{rows:a,cols:o}=i;a.forEach((r,i)=>{o.forEach((a,o)=>{let s=this._sheetDataValidationModel.getRuleIdByLocation(e,t,r,a);n.setValue(i,o,null!=s?s:"")})})}_generateMutations(e,t){if(!this._copyInfo)return{redos:[],undos:[]};if(t.copyType===w.COPY_TYPE.CUT)return this._copyInfo=null,{redos:[],undos:[]};if(!this._copyInfo||!this._copyInfo.matrix.getSizeOf()||!t.copyRange||[(0,w.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_COL_WIDTH,(0,w.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_VALUE,(0,w.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMAT,(0,w.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMULA].includes(t.pasteType))return{redos:[],undos:[]};let{unitId:r,subUnitId:n}=this._copyInfo;if(t.unitId!==r||n!==t.subUnitId){let i=this._sheetDataValidationModel.getRuleObjectMatrix(t.unitId,t.subUnitId).clone(),a=new s.ObjectMatrix,o=/* @__PURE__ */new Set,{ranges:[l,d],mapFunc:u}=(0,w.virtualizeDiscreteRanges)([t.copyRange,e]),c=(0,w.getRepeatRange)(l,d,!0),h=/* @__PURE__ */new Map;c.forEach(({startRange:e})=>{var i;null==(i=this._copyInfo)||i.matrix.forValue((i,l,d)=>{let c=(0,s.Rectangle).getPositionRange({startRow:i,endRow:i,startColumn:l,endColumn:l},e),m=`${n}-${d}`,p=this._sheetDataValidationModel.getRuleById(r,n,d);!this._sheetDataValidationModel.getRuleById(t.unitId,t.subUnitId,m)&&p&&h.set(m,{...p,uid:m});let{row:g,col:f}=u(c.startRow,c.startColumn);o.add(m),a.setValue(g,f,m)})});let m=Array.from(o).map(e=>({id:e,ranges:(0,s.queryObjectMatrix)(a,t=>t===e)}));i.addRangeRules(m);let{redoMutations:p,undoMutations:g}=rS(t.unitId,t.subUnitId,i.diffWithAddition(this._sheetDataValidationModel.getRules(t.unitId,t.subUnitId),h.values()),this._injector,"patched");return{redos:p,undos:g}}{let i=this._sheetDataValidationModel.getRuleObjectMatrix(r,n).clone(),a=new s.ObjectMatrix,o=/* @__PURE__ */new Set,{ranges:[l,d],mapFunc:u}=(0,w.virtualizeDiscreteRanges)([t.copyRange,e]);(0,w.getRepeatRange)(l,d,!0).forEach(({startRange:e})=>{var t;null==(t=this._copyInfo)||t.matrix.forValue((t,r,n)=>{let i=(0,s.Rectangle).getPositionRange({startRow:t,endRow:t,startColumn:r,endColumn:r},e),{row:l,col:d}=u(i.startRow,i.startColumn);a.setValue(l,d,n),o.add(n)})});let c=Array.from(o).map(e=>({id:e,ranges:(0,s.queryObjectMatrix)(a,t=>t===e)}));i.addRangeRules(c);let{redoMutations:h,undoMutations:m}=rS(r,n,i.diff(this._sheetDataValidationModel.getRules(r,n)),this._injector,"patched");return{redos:h,undos:m}}}},O(nt,"DataValidationCopyPasteController"),nt);no=ni([(0,s.OnLifecycle)(s.LifecycleStages.Ready,no),na(0,w.ISheetClipboardService),na(1,(0,s.Inject)(J)),na(2,(0,s.Inject)(s.Injector))],no);var ns,nl=Object.defineProperty,nd=Object.getOwnPropertyDescriptor,nu=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nd(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nl(t,r,a),a},"__decorateClass$7"),nc=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let nh=(O(ns=class extends s.Disposable{constructor(e,t,r){super(),this._localeService=e,this._commandService=t,this._sheetPermissionInterceptorBaseController=r,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{e.id===ry.id&&(this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[d.WorkbookEditablePermission],rangeTypes:[d.RangeProtectionPermissionEditPoint],worksheetTypes:[d.WorksheetEditPermission,d.WorksheetSetCellStylePermission]})||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.setStyleErr"))),e.id===rC.id&&(this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[d.WorkbookEditablePermission],rangeTypes:[d.RangeProtectionPermissionEditPoint],worksheetTypes:[d.WorksheetEditPermission,d.WorksheetSetCellStylePermission]},e.params.ranges)||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.setStyleErr")))}))}},"DataValidationPermissionController"),ns);nh=nu([(0,s.OnLifecycle)(s.LifecycleStages.Ready,nh),nc(0,(0,s.Inject)(s.LocaleService)),nc(1,s.ICommandService),nc(2,(0,s.Inject)(w.SheetPermissionInterceptorBaseController))],nh);var nm,np=Object.defineProperty,ng=Object.getOwnPropertyDescriptor,nf=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ng(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&np(t,r,a),a},"__decorateClass$6"),nv=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let n_=(nm=class extends s.Disposable{constructor(e,t,r,n,i,a){super(),D(this,"_disposableMap",/* @__PURE__ */new Map),D(this,"registerRule",/* @__PURE__ */O((e,t,r)=>{this.register(e,t,r),this.registerFormula(e,t,r)},"registerRule")),this._dataValidationModel=e,this._injector=t,this._refRangeService=r,this._dataValidationCustomFormulaService=n,this._dataValidationFormulaService=i,this._formulaRefRangeService=a,this._initRefRange()}_getIdWithUnitId(e,t,r){return`${e}_${t}_${r}`}registerFormula(e,t,r){var n;let i=r.uid,a=this._getIdWithUnitId(e,t,i),o=null!=(n=this._disposableMap.get(a))?n:/* @__PURE__ */new Set,d=/* @__PURE__ */O((n,a)=>{let o=this._dataValidationModel.getRuleById(e,t,i);if(!o)return{redos:[],undos:[]};let s=o[n];if(!s||s===a)return{redos:[],undos:[]};let d={unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.SETTING,payload:{type:o.type,formula1:o.formula1,formula2:o.formula2,[n]:a}}},u={unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.SETTING,payload:{type:o.type,formula1:o.formula1,formula2:o.formula2}}};return{redos:[{id:l.UpdateDataValidationMutation.id,params:d}],undos:[{id:l.UpdateDataValidationMutation.id,params:u}]}},"handleFormulaChange");if(r.type===s.DataValidationType.CUSTOM){let r=this._dataValidationCustomFormulaService.getRuleFormulaInfo(e,t,i);if(r){let e=this._formulaRefRangeService.registerFormula(r.formula,e=>d("formula1",e));o.add(()=>e.dispose())}}if(r.type!==s.DataValidationType.CUSTOM){let r=this._dataValidationFormulaService.getRuleFormulaInfo(e,t,i);if(r){let[e,t]=r;if(e){let t=this._formulaRefRangeService.registerFormula(e.text,e=>d("formula1",e));o.add(()=>t.dispose())}if(t){let e=this._formulaRefRangeService.registerFormula(t.text,e=>d("formula2",e));o.add(()=>e.dispose())}}}}register(e,t,r){var n;let i=/* @__PURE__ */O(n=>{let i=[...r.ranges],a=i.map(e=>(0,d.handleCommonDefaultRangeChangeWithEffectRefCommands)(e,n)).filter(e=>!!e).flat();if((0,s.isRangesEqual)(a,i))return{redos:[],undos:[]};if(a.length){let n={unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.RANGE,payload:a},source:"patched"};return{redos:[{id:l.UpdateDataValidationMutation.id,params:n}],undos:[{id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.RANGE,payload:i},source:"patched"}}]}}{let n={unitId:e,subUnitId:t,ruleId:r.uid};return{redos:[{id:l.RemoveDataValidationMutation.id,params:n}],undos:rM(this._injector,n)}}},"handleRangeChange"),a=[];r.ranges.forEach(r=>{let n=this._refRangeService.registerRefRange(r,i,e,t);a.push(()=>n.dispose())});let o=this._getIdWithUnitId(e,t,r.uid),u=null!=(n=this._disposableMap.get(o))?n:/* @__PURE__ */new Set;u.add(()=>a.forEach(e=>e())),this._disposableMap.set(o,u)}_initRefRange(){this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{let{unitId:t,subUnitId:r,rule:n}=e;switch(e.type){case"add":{let t=e.rule;this.registerRule(e.unitId,e.subUnitId,t);break}case"remove":{let e=this._disposableMap.get(this._getIdWithUnitId(t,r,n.uid));e&&e.forEach(e=>e());break}case"update":{let n=e.rule,i=this._disposableMap.get(this._getIdWithUnitId(t,r,n.uid));i&&i.forEach(e=>e()),this.registerRule(e.unitId,e.subUnitId,n)}}})),this.disposeWithMe((0,s.toDisposable)(()=>{this._disposableMap.forEach(e=>{e.forEach(e=>e())}),this._disposableMap.clear()}))}},O(nm,"DataValidationRefRangeController"),nm);n_=nf([(0,s.OnLifecycle)(s.LifecycleStages.Starting,n_),nv(0,(0,s.Inject)(J)),nv(1,(0,s.Inject)(s.Injector)),nv(2,(0,s.Inject)(d.RefRangeService)),nv(3,(0,s.Inject)(L)),nv(4,(0,s.Inject)(W)),nv(5,(0,s.Inject)(v.FormulaRefRangeService))],n_);let nI={[S.RibbonStartGroup.FORMULAS_INSERT]:{[rY]:{order:9,menuItemFactory:rz,[tL.id]:{order:0,menuItemFactory:rK},[rb.id]:{order:1,menuItemFactory:rq}}}};var nS=Object.defineProperty,nC=Object.getOwnPropertyDescriptor,ny=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nC(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nS(t,r,a),a},"__decorateClass$5"),nb=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let nw={tr:{size:6,color:"#fe4b4b"}},nR=(nT=class extends s.RxDisposable{constructor(e,t,r,n,i,a,o,s,l,d){super(),this._commandService=e,this._menuManagerService=t,this._renderManagerService=r,this._univerInstanceService=n,this._autoHeightController=i,this._dropdownManagerService=a,this._sheetDataValidationModel=o,this._dataValidatorRegistryService=s,this._sheetInterceptorService=l,this._editorBridgeService=d,this._initMenu(),this._initSkeletonChange(),this._initDropdown(),this._initViewModelIntercept(),this._initAutoHeight()}_initMenu(){this._menuManagerService.mergeMenu(nI)}_initDropdown(){this._editorBridgeService&&this.disposeWithMe(this._editorBridgeService.visible$.subscribe(e=>{var t;if(!e.visible){(null==(t=this._dropdownManagerService.activeDropdown)?void 0:t.trigger)==="editor-bridge"&&this._dropdownManagerService.hideDropdown();return}let r=this._editorBridgeService.getEditCellState();if(r){let{unitId:e,sheetId:t,row:n,column:i}=r,a=this._univerInstanceService.getUniverSheetInstance(e);if(!a)return;let o=this._sheetDataValidationModel.getRuleByLocation(e,t,n,i);if(!o)return;let s=this._dataValidatorRegistryService.getValidatorItem(o.type);if(!(null!=s&&s.dropdown))return;let l=a.getActiveSheet();if(!l)return;let d=this._dropdownManagerService.activeDropdown,u=null==d?void 0:d.location;if(u&&u.unitId===e&&u.subUnitId===t&&u.row===n&&u.col===i)return;this._dropdownManagerService.showDropdown({location:{unitId:e,subUnitId:t,row:n,col:i,workbook:a,worksheet:l},componentKey:s.dropdown,onHide:/* @__PURE__ */O(()=>{},"onHide"),trigger:"editor-bridge"},!1)}}))}_initSkeletonChange(){let e=/* @__PURE__ */O(()=>{var e,t,r;let n=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);if(!n)return;let i=n.getUnitId(),a=null==(e=n.getActiveSheet())?void 0:e.getSheetId();if(!a)return;let o=null==(r=null==(t=this._renderManagerService.getRenderById(i))?void 0:t.with(w.SheetSkeletonManagerService).getWorksheetSkeleton(a))?void 0:r.skeleton,l=this._renderManagerService.getRenderById(i);null==o||o.makeDirty(!0),null==o||o.calculate(),l&&l.mainComponent.makeForceDirty()},"markSkeletonDirty");this.disposeWithMe(this._sheetDataValidationModel.ruleChange$.pipe((0,m.debounceTime)(16)).subscribe(()=>e())),this.disposeWithMe(this._sheetDataValidationModel.validStatusChange$.pipe((0,m.debounceTime)(16)).subscribe(()=>e()))}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(d.INTERCEPTOR_POINT.CELL_CONTENT,{priority:d.InterceptCellContentPriority.DATA_VALIDATION,handler:/* @__PURE__ */O((e,t,r)=>{var n,i,a,o;let{row:l,col:d,unitId:u,subUnitId:c,workbook:h,worksheet:m}=t,p=h.getStyles(),g=("string"==typeof(null==e?void 0:e.s)?p.get(null==e?void 0:e.s):null==e?void 0:e.s)||{},f=this._sheetDataValidationModel.getRuleIdByLocation(u,c,l,d);if(!f)return r(e);let v=this._sheetDataValidationModel.getRuleById(u,c,f);if(!v)return r(e);let _=this._sheetDataValidationModel.validator(e,v,t),I=this._dataValidatorRegistryService.getValidatorItem(v.type),S=m.getCellRaw(l,d),C=G(S),y=`${null!=(n=G(S))?n:""}`;return r({...e,dataValidation:{ruleId:f,validStatus:_,rule:v,validator:I},markers:{...null==e?void 0:e.markers,..._===s.DataValidationStatus.INVALID?nw:null},customRender:[...null!=(i=null==e?void 0:e.customRender)?i:[],...null!=I&&I.canvasRender?[I.canvasRender]:[]],fontRenderExtension:{...null==e?void 0:e.fontRenderExtension,isSkip:(null==(a=null==e?void 0:e.fontRenderExtension)?void 0:a.isSkip)||(null==I?void 0:I.skipDefaultFontRender(v,C,t))},interceptorStyle:{...null==e?void 0:e.interceptorStyle,...null==I?void 0:I.getExtraStyle(v,y,{style:g})},interceptorAutoHeight:/* @__PURE__ */O(()=>{var t,r,n,i,a,o;let s=null==(r=null==(t=this._renderManagerService.getRenderById(u))?void 0:t.with(w.SheetSkeletonManagerService).getWorksheetSkeleton(c))?void 0:r.skeleton;if(!s)return;let p=s.worksheet.getMergedCell(l,d),g={data:{...e,dataValidation:{ruleId:f,validStatus:_,rule:v,validator:I}},style:s.getsStyles().getStyleByCell(e),primaryWithCoord:s.getCellByIndex(null!=(n=null==p?void 0:p.startRow)?n:l,null!=(i=null==p?void 0:p.startColumn)?i:d),unitId:u,subUnitId:c,row:l,col:d,workbook:h,worksheet:m};return null==(o=null==(a=null==I?void 0:I.canvasRender)?void 0:a.calcCellAutoHeight)?void 0:o.call(a,g)},"interceptorAutoHeight"),coverable:(null==(o=null==e?void 0:e.coverable)||o)&&!(v.type===s.DataValidationType.LIST||v.type===s.DataValidationType.LIST_MULTIPLE)})},"handler")}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe((0,g.filter)(e=>"command"===e.source),(0,h.bufferTime)(16)).subscribe(e=>{let t=[];if(e.forEach(e=>{var r;null!=(r=e.rule)&&r.ranges&&t.push(...e.rule.ranges)}),t.length){let e=this._autoHeightController.getUndoRedoParamsOfAutoHeight(t);(0,s.sequenceExecute)(e.redos,this._commandService)}})}},O(nT,"SheetsDataValidationRenderController"),nT);nR=ny([(0,s.OnLifecycle)(s.LifecycleStages.Rendered,nR),nb(0,s.ICommandService),nb(1,S.IMenuManagerService),nb(2,y.IRenderManagerService),nb(3,s.IUniverInstanceService),nb(4,(0,s.Inject)(w.AutoHeightController)),nb(5,(0,s.Inject)(tA)),nb(6,(0,s.Inject)(J)),nb(7,(0,s.Inject)(l.DataValidatorRegistryService)),nb(8,(0,s.Inject)(d.SheetInterceptorService)),nb(9,(0,s.Optional)(w.IEditorBridgeService))],nR);let nE=(nM=class extends s.RxDisposable{constructor(e,t,r,n,i,a,o){super(),this._commandService=e,this._renderManagerService=t,this._univerInstanceService=r,this._autoHeightController=n,this._dataValidatorRegistryService=i,this._sheetInterceptorService=a,this._sheetDataValidationModel=o,this._initSkeletonChange(),this._initViewModelIntercept(),this._initAutoHeight()}_initSkeletonChange(){let e=/* @__PURE__ */O(()=>{var e,t,r;let n=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);if(!n)return;let i=n.getUnitId(),a=null==(e=n.getActiveSheet())?void 0:e.getSheetId();if(!a)return;let o=null==(r=null==(t=this._renderManagerService.getRenderById(i))?void 0:t.with(w.SheetSkeletonManagerService).getWorksheetSkeleton(a))?void 0:r.skeleton,l=this._renderManagerService.getRenderById(i);null==o||o.makeDirty(!0),null==o||o.calculate(),l&&l.mainComponent.makeForceDirty()},"markSkeletonDirty");this.disposeWithMe(this._sheetDataValidationModel.ruleChange$.pipe((0,m.debounceTime)(16)).subscribe(()=>e())),this.disposeWithMe(this._sheetDataValidationModel.validStatusChange$.pipe((0,m.debounceTime)(16)).subscribe(()=>e()))}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(d.INTERCEPTOR_POINT.CELL_CONTENT,{priority:d.InterceptCellContentPriority.DATA_VALIDATION,handler:/* @__PURE__ */O((e,t,r)=>{var n,i,a,o,l;let{row:d,col:u,unitId:c,subUnitId:h,workbook:m,worksheet:p}=t,g=null==(i=null==(n=this._renderManagerService.getRenderById(c))?void 0:n.with(w.SheetSkeletonManagerService).getWorksheetSkeleton(h))?void 0:i.skeleton;if(!g)return r(e);let f=t.workbook.getStyles(),v=("string"==typeof(null==e?void 0:e.s)?f.get(null==e?void 0:e.s):null==e?void 0:e.s)||{},_=this._sheetDataValidationModel.getRuleIdByLocation(c,h,d,u);if(!_)return r(e);let I=this._sheetDataValidationModel.getRuleById(c,h,_);if(!I)return r(e);let S=this._sheetDataValidationModel.validator(e,I,t),C=this._dataValidatorRegistryService.getValidatorItem(I.type),y=p.getCellRaw(d,u),b=G(y),R={};if((I.type===s.DataValidationType.LIST||I.type===s.DataValidationType.LIST_MULTIPLE)&&(R={interceptorStyle:{...null==e?void 0:e.interceptorStyle,tb:null!=(a=v.tb!==s.WrapStrategy.OVERFLOW?v.tb:s.WrapStrategy.CLIP)?a:s.WrapStrategy.WRAP}}),I.type===s.DataValidationType.CHECKBOX&&(R={interceptorStyle:{...null==e?void 0:e.interceptorStyle,tb:s.WrapStrategy.CLIP}}),I.type===s.DataValidationType.LIST&&(I.renderMode===s.DataValidationRenderMode.ARROW||I.renderMode===s.DataValidationRenderMode.TEXT)){let e=C.getListWithColorMap(I)[`${null!=(o=G(y))?o:""}`];e&&(R={...R,interceptorStyle:{...R.interceptorStyle,bg:{rgb:e}}})}return r({...e,...R,dataValidation:{ruleId:_,validStatus:S,rule:I,validator:C},markers:{...null==e?void 0:e.markers,...S===s.DataValidationStatus.INVALID?nw:null},customRender:[...null!=(l=null==e?void 0:e.customRender)?l:[],...null!=C&&C.canvasRender?[C.canvasRender]:[]],fontRenderExtension:{...null==e?void 0:e.fontRenderExtension,isSkip:null==C?void 0:C.skipDefaultFontRender(I,b,t)},interceptorStyle:{...null==e?void 0:e.interceptorStyle,...R.interceptorStyle},interceptorAutoHeight:/* @__PURE__ */O(()=>{var t,r,n,i;let a=g.worksheet.getMergedCell(d,u),o={data:{...e,dataValidation:{ruleId:_,validStatus:S,rule:I,validator:C}},style:g.getsStyles().getStyleByCell(e),primaryWithCoord:g.getCellByIndex(null!=(t=null==a?void 0:a.startRow)?t:d,null!=(r=null==a?void 0:a.startColumn)?r:u),unitId:c,subUnitId:h,row:d,col:u,worksheet:p,workbook:m};return null==(i=null==(n=null==C?void 0:C.canvasRender)?void 0:n.calcCellAutoHeight)?void 0:i.call(n,o)},"interceptorAutoHeight")})},"handler")}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe((0,g.filter)(e=>"command"===e.source),(0,h.bufferTime)(16)).subscribe(e=>{let t=[];if(e.forEach(e=>{var r;null!=(r=e.rule)&&r.ranges&&t.push(...e.rule.ranges)}),t.length){let e=this._autoHeightController.getUndoRedoParamsOfAutoHeight(t);(0,s.sequenceExecute)(e.redos,this._commandService)}})}},O(nM,"SheetsDataValidationMobileRenderController"),nM);nE=ny([(0,s.OnLifecycle)(s.LifecycleStages.Rendered,nE),nb(0,s.ICommandService),nb(1,y.IRenderManagerService),nb(2,s.IUniverInstanceService),nb(3,(0,s.Inject)(w.AutoHeightController)),nb(4,(0,s.Inject)(l.DataValidatorRegistryService)),nb(5,(0,s.Inject)(d.SheetInterceptorService)),nb(6,(0,s.Inject)(J))],nE);var nT,nM,nO,nD=Object.defineProperty,nU=Object.getOwnPropertyDescriptor,nP=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nU(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nD(t,r,a),a},"__decorateClass$4"),nk=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let nN=(O(nO=class{constructor(e,t,r){this._univerInstanceService=e,this._sheetDataValidationModel=t,this._dataValidationCacheService=r}async validatorCell(e,t,r,n){let i=this._univerInstanceService.getUnit(e,s.UniverInstanceType.UNIVER_SHEET);if(!i)throw Error(`cannot find current workbook, unitId: ${e}`);let a=i.getSheetBySheetId(t);if(!a)throw Error(`cannot find current worksheet, sheetId: ${t}`);if(!(0,s.Tools).isDefine(r)||!(0,s.Tools).isDefine(n))throw Error(`row or col is not defined, row: ${r}, col: ${n}`);let o=a.getCell(r,n),l=this._sheetDataValidationModel.getRuleByLocation(e,t,r,n);return l?new Promise(s=>{this._sheetDataValidationModel.validator(o,l,{unitId:e,subUnitId:t,row:r,col:n,worksheet:a,workbook:i},s)}):s.DataValidationStatus.VALID}validatorRanges(e,t,r){return Promise.all(r.map(r=>{let n=[];return(0,s.Range).foreach(r,(r,i)=>{n.push(this.validatorCell(e,t,r,i))}),n}))}async validatorWorksheet(e,t){let r=this._sheetDataValidationModel.getRules(e,t);return await Promise.all(r.map(r=>Promise.all(r.ranges.map(r=>{let n=[];return(0,s.Range).foreach(r,(r,i)=>{n.push(this.validatorCell(e,t,r,i))}),n})))),this._dataValidationCacheService.ensureCache(e,t)}async validatorWorkbook(e){let t=this._sheetDataValidationModel.getSubUnitIds(e),r=await Promise.all(t.map(t=>this.validatorWorksheet(e,t))),n={};return r.forEach((e,r)=>{n[t[r]]=e}),n}getDataValidations(e,t,r){let n=this._sheetDataValidationModel.getRuleObjectMatrix(e,t),i=/* @__PURE__ */new Set;return r.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let r=n.getValue(e,t);r&&i.add(r)})}),Array.from(i).map(r=>this._sheetDataValidationModel.getRuleById(e,t,r)).filter(Boolean)}getDataValidation(e,t,r){return this.getDataValidations(e,t,r)[0]}},"SheetsDataValidationValidatorService"),nO);nN=nP([nk(0,s.IUniverInstanceService),nk(1,(0,s.Inject)(J)),nk(2,(0,s.Inject)(U))],nN);var nA,nx=Object.defineProperty,nL=Object.getOwnPropertyDescriptor,nV=/* @__PURE__ */O((e,t,r)=>t in e?nx(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp$1"),nF=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nL(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nx(t,r,a),a},"__decorateClass$3"),nj=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3"),nH=/* @__PURE__ */O((e,t,r)=>nV(e,"symbol"!=typeof t?t+"":t,r),"__publicField$1");let n$=(O(nA=class extends s.Plugin{constructor(e=rU,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(rD,a)}onStarting(){[[tf],[U],[W],[L],[tA],[nN],[J],[r2],[nE],[r7],[n_],[nh],[no],[eq]].forEach(e=>{this._injector.add(e)}),[ry,rb,rC,rw,rR,rO,rT,rE,tj,tH,tV,tL,tF].forEach(e=>{this._commandService.registerCommand(e)})}},"UniverSheetsDataValidationMobilePlugin"),nA);nH(n$,"pluginName",eH),nH(n$,"type",s.UniverInstanceType.UNIVER_SHEET),n$=nF([(0,s.DependentOn)(l.UniverDataValidationPlugin,d.UniverSheetsPlugin,w.UniverSheetsUIPlugin),nj(1,(0,s.Inject)(s.Injector)),nj(2,s.ICommandService),nj(3,s.IConfigService)],n$);var nB,nW=Object.defineProperty,nG=Object.getOwnPropertyDescriptor,nY=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nG(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nW(t,r,a),a},"__decorateClass$2"),nz=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let nK=(nB=class extends s.Disposable{constructor(e,t,r){super(),this._autoFillService=e,this._dataValidationModel=t,this._injector=r,this._initAutoFill()}_initAutoFill(){let e=/* @__PURE__ */O(()=>({redos:[],undos:[]}),"noopReturnFunc"),t=/* @__PURE__ */O((e,t)=>{let{source:r,target:n,unitId:i,subUnitId:a}=e,o=this._dataValidationModel.getRuleObjectMatrix(i,a).clone(),l=(0,w.virtualizeDiscreteRanges)([r,n]),[d,u]=l.ranges,{mapFunc:c}=l,h={row:d.startRow,col:d.startColumn},m=(0,w.getAutoFillRepeatRange)(d,u),p=new s.ObjectMatrix,g=/* @__PURE__ */new Set;m.forEach(e=>{let t=e.repeatStartCell,r=e.relativeRange,n={startRow:h.row,startColumn:h.col,endColumn:h.col,endRow:h.row},o={startRow:t.row,startColumn:t.col,endColumn:t.col,endRow:t.row};(0,s.Range).foreach(r,(e,t)=>{let r=(0,s.Rectangle).getPositionRange({startRow:e,startColumn:t,endColumn:t,endRow:e},n),{row:l,col:d}=c(r.startRow,r.startColumn),u=this._dataValidationModel.getRuleIdByLocation(i,a,l,d);if(u){let r=(0,s.Rectangle).getPositionRange({startRow:e,startColumn:t,endColumn:t,endRow:e},o),{row:n,col:i}=c(r.startRow,r.startColumn);p.setValue(n,i,u),g.add(u)}})});let f=Array.from(g).map(e=>({id:e,ranges:(0,s.queryObjectMatrix)(p,t=>t===e)}));o.addRangeRules(f);let v=o.diff(this._dataValidationModel.getRules(i,a)),{redoMutations:_,undoMutations:I}=rS(i,a,v,this._injector,"patched",t===w.APPLY_TYPE.ONLY_FORMAT);return{undos:I,redos:_}},"generalApplyFunc"),r=[s.DataValidationType.CHECKBOX],n={id:eH,onBeforeFillData:/* @__PURE__ */O(e=>{let{source:t,unitId:n,subUnitId:i}=e;for(let e of t.rows)for(let a of t.cols){let t=this._dataValidationModel.getRuleByLocation(n,i,e,a);if(t&&r.indexOf(t.type)>-1){this._autoFillService.setDisableApplyType(w.APPLY_TYPE.SERIES,!0);return}}},"onBeforeFillData"),onFillData:/* @__PURE__ */O((r,n,i)=>i===w.APPLY_TYPE.COPY||i===w.APPLY_TYPE.ONLY_FORMAT||i===w.APPLY_TYPE.SERIES?t(r,i):e(),"onFillData"),onAfterFillData:/* @__PURE__ */O(()=>{},"onAfterFillData")};this.disposeWithMe(this._autoFillService.addHook(n))}},O(nB,"DataValidationAutoFillController"),nB);nK=nY([(0,s.OnLifecycle)(s.LifecycleStages.Ready,nK),nz(0,w.IAutoFillService),nz(1,(0,s.Inject)(J)),nz(2,(0,s.Inject)(s.Injector))],nK);var nq,nX=Object.defineProperty,nZ=Object.getOwnPropertyDescriptor,nQ=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nZ(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nX(t,r,a),a},"__decorateClass$1"),nJ=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let n0=(nq=class extends s.Disposable{constructor(e,t,r){super(),this._sheetInterceptorService=e,this._univerInstanceService=t,this._sheetDataValidationModel=r,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */O(e=>{var t;if(e.id===d.RemoveSheetCommand.id){let r=e.params,n=r.unitId||this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET).getUnitId(),i=this._univerInstanceService.getUniverSheetInstance(n);if(!i)return{redos:[],undos:[]};let a=r.subUnitId||(null==(t=i.getActiveSheet())?void 0:t.getSheetId());if(!a)return{redos:[],undos:[]};let o=this._sheetDataValidationModel.getRules(n,a),d=o.map(e=>e.uid),u={unitId:n,subUnitId:a,rule:[...o],source:"patched"};return{redos:[{id:l.RemoveDataValidationMutation.id,params:{unitId:n,subUnitId:a,ruleId:d,source:"patched"}}],undos:[{id:l.AddDataValidationMutation.id,params:u}]}}return{redos:[],undos:[]}},"getMutations")}))}},O(nq,"SheetDataValidationSheetController"),nq);n0=nQ([(0,s.OnLifecycle)(s.LifecycleStages.Ready,n0),nJ(0,(0,s.Inject)(d.SheetInterceptorService)),nJ(1,(0,s.Inject)(s.IUniverInstanceService)),nJ(2,(0,s.Inject)(J))],n0);var n1,n3=Object.defineProperty,n2=Object.getOwnPropertyDescriptor,n4=/* @__PURE__ */O((e,t,r)=>t in e?n3(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),n9=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?n2(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&n3(t,r,a),a},"__decorateClass"),n5=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),n6=/* @__PURE__ */O((e,t,r)=>n4(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let n8=(O(n1=class extends s.Plugin{constructor(e=rU,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(rD,a)}onStarting(){[[tf],[U],[W],[L],[tA],[nN],[J],[r2],[nR],[r7],[n_],[nh],[nK],[no],[eq],[tQ],[n0]].forEach(e=>{this._injector.add(e)}),[ry,rb,rC,rw,rR,rO,rT,rE,tj,tH,tV,tL,tF].forEach(e=>{this._commandService.registerCommand(e)})}},"UniverSheetsDataValidationPlugin"),n1);n6(n8,"pluginName",eH),n6(n8,"type",s.UniverInstanceType.UNIVER_SHEET),n9([(0,s.DependentOn)(E.UniverSheetsNumfmtPlugin,l.UniverDataValidationPlugin,w.UniverSheetsUIPlugin),n5(1,(0,s.Inject)(s.Injector)),n5(2,s.ICommandService),n5(3,s.IConfigService)],n8)}),i("vzesf",function(t,r){let i;e(t.exports,"SetSheetsFilterRangeMutation",function(){return f}),e(t.exports,"SheetsFilterService",function(){return et}),e(t.exports,"SetSheetsFilterCriteriaMutation",function(){return v}),e(t.exports,"RemoveSheetsFilterMutation",function(){return _}),e(t.exports,"ReCalcSheetsFilterMutation",function(){return I}),e(t.exports,"CustomFilterOperator",function(){return S}),e(t.exports,"FILTER_MUTATIONS",function(){return J}),e(t.exports,"UniverSheetsFilterPlugin",function(){return ev});var a=n("83KcA"),o=n("jv4BO"),s=n("a9FIH"),l=n("d0sRG"),d=n("bA4Xh"),u=n("bTGUS"),c=n("ls2nu"),h=Object.defineProperty,m=(e,t,r)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,p=(e,t)=>h(e,"name",{value:t,configurable:!0}),g=(e,t,r)=>m(e,"symbol"!=typeof t?t+"":t,r);let f={id:"sheet.mutation.set-filter-range",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{subUnitId:r,unitId:n,range:i}=t;return e.get(et).ensureFilterModel(n,r).setRange(i),!0},"handler")},v={id:"sheet.mutation.set-filter-criteria",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{subUnitId:r,unitId:n,criteria:i,col:a,reCalc:o=!0}=t,s=e.get(et).getFilterModel(n,r);return!!s&&(s.setCriteria(a,i,o),!0)},"handler")},_={id:"sheet.mutation.remove-filter",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{unitId:r,subUnitId:n}=t;return e.get(et).removeFilterModel(r,n)},"handler")},I={id:"sheet.mutation.re-calc-filter",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{unitId:r,subUnitId:n}=t,i=e.get(et).getFilterModel(r,n);return!!i&&(i.reCalc(),!0)},"handler")};var S=((i=S||{}).EQUAL="equal",i.GREATER_THAN="greaterThan",i.GREATER_THAN_OR_EQUAL="greaterThanOrEqual",i.LESS_THAN="lessThan",i.LESS_THAN_OR_EQUAL="lessThanOrEqual",i.NOT_EQUALS="notEqual",i);let C={operator:S.GREATER_THAN,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e>t,"fn")},y={operator:S.GREATER_THAN_OR_EQUAL,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e>=t,"fn")},b={operator:S.LESS_THAN,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e<t,"fn")},w={operator:S.LESS_THAN_OR_EQUAL,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e<=t,"fn")},R={operator:S.EQUAL,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e===t,"fn")},E={operator:S.NOT_EQUALS,fn:/* @__PURE__ */p((e,t)=>{if("string"==typeof t){if(" "===t)return null!=e;let r=k(e);return r&&N(t)?!A(t).test(r):r!==t}return!U(e)||e!==t},"fn")},T=/* @__PURE__ */new Map([]);function M(e){return!!e}[C,y,b,w,R,E].forEach(e=>{T.set(e.operator,e)}),p(M,"isNumericFilterFn");let O={fn:/* @__PURE__ */p((e,t)=>{let r=k(e);return null===r?""===t:A(t).test(r)},"fn")};function D(e){return e?T.get(e):O}function U(e){return"number"==typeof e}function P(e){return!!("number"==typeof e||"string"==typeof e&&(0,a.isNumeric)(e))}function k(e){return"boolean"==typeof e||null==e?null:"string"==typeof e?e:e.toString()}function N(e){return"number"!=typeof e&&(-1!==e.indexOf("*")||-1!==e.indexOf("?"))}function A(e){let t=e.replace(/[.+^${}()|[\]\\]/g,"\\$&").replaceAll("?",".").replace(/[*]/g,".$&");return RegExp(`^${t}$`)}p(D,"getCustomFilterFn"),p(U,"ensureNumber"),p(P,"ensureNumeric"),p(k,"ensureString"),p(N,"isWildCardString"),p(A,"createREGEXFromWildChar");let x=/* @__PURE__ */p(()=>/* @__PURE__ */new Set,"EMPTY"),L=class e extends a.Disposable{constructor(e,t,r){super(),g(this,"_filteredOutRows$",new o.BehaviorSubject(x())),g(this,"filteredOutRows$",this._filteredOutRows$.asObservable()),g(this,"_hasCriteria$",new o.BehaviorSubject(!1)),g(this,"hasCriteria$",this._hasCriteria$.asObservable()),g(this,"_filterColumnByIndex",/* @__PURE__ */new Map),g(this,"_alreadyFilteredOutRows",x()),g(this,"_range"),this.unitId=e,this.subUnitId=t,this._worksheet=r}get filteredOutRows(){return this._filteredOutRows$.getValue()}set filteredOutRows(e){this._alreadyFilteredOutRows=e,this._filteredOutRows$.next(e)}dispose(){super.dispose(),this._filteredOutRows$.complete(),this._hasCriteria$.complete()}serialize(){let e={ref:(0,a.Rectangle).clone(this._range),filterColumns:this._getAllFilterColumns(!0).sort(([e],[t])=>e-t).map(([e,t])=>t.serialize())};return this._alreadyFilteredOutRows&&(e.cachedFilteredOut=Array.from(this._alreadyFilteredOutRows).sort()),e}static deserialize(t,r,n,i){let a=new e(t,r,n);return a._dump(i),a}_dump(e){var t;this.setRange(e.ref),null==(t=e.filterColumns)||t.forEach(e=>this._setCriteriaWithoutReCalc(e.colId,e)),e.cachedFilteredOut&&(this._alreadyFilteredOutRows=new Set(e.cachedFilteredOut),this._emit()),this._emitHasCriteria()}isRowFiltered(e){return this._alreadyFilteredOutRows.has(e)}getRange(){if(!this._range)throw Error("[FilterModel] could not get range before a range is set!");return this._range}getFilteredOutRowsExceptCol(e){return this._getAllFilterColumns(!0).filter(([t])=>t!==e).reduce((e,[,t])=>{let r=t.calc({getAlreadyFilteredOutRows:/* @__PURE__ */p(()=>e,"getAlreadyFilteredOutRows")});return r?(0,a.mergeSets)(e,r):e},/* @__PURE__ */new Set)}setRange(e){this._range=e,this._getAllFilterColumns(!0).forEach(([t,r])=>{r.setRangeAndColumn({startRow:e.startRow,endRow:e.endRow,startColumn:t,endColumn:t},t)})}setCriteria(e,t,r=!1){if(!this._range)throw Error("[FilterModel] could not set criteria before a range is set!");if(!t){this._removeCriteria(e),this._rebuildAlreadyFilteredOutRowsWithCache(),r&&this._reCalcAllColumns(),this._emit(),this._emitHasCriteria();return}this._setCriteriaWithoutReCalc(e,t),r&&(this._rebuildAlreadyFilteredOutRowsWithCache(),this._reCalcWithNoCacheColumns(),this._emit(),this._emitHasCriteria())}getAllFilterColumns(){return this._getAllFilterColumns(!0)}getFilterColumn(e){var t;return null!=(t=this._filterColumnByIndex.get(e))?t:null}reCalc(){this._reCalcAllColumns(),this._emit()}_getAllFilterColumns(e=!1){let t=Array.from(this._filterColumnByIndex.entries());return e?t:t.map(([e,t])=>t)}_reCalcAllColumns(){this._alreadyFilteredOutRows=x(),this._getAllFilterColumns().forEach(e=>e.__clearCache()),this._reCalcWithNoCacheColumns()}_setCriteriaWithoutReCalc(e,t){let r;let n=this._range;if(!n)throw Error("[FilterModel] could not set criteria before a range is set!");let{startColumn:i,endColumn:a}=n;if(e>a||e<i)throw Error(`[FilterModel] could not set criteria on column ${e} which is out of range!`);this._filterColumnByIndex.has(e)?r=this._filterColumnByIndex.get(e):((r=new F(this.unitId,this.subUnitId,this._worksheet,t,{getAlreadyFilteredOutRows:/* @__PURE__ */p(()=>this._alreadyFilteredOutRows,"getAlreadyFilteredOutRows")})).setRangeAndColumn(n,e),this._filterColumnByIndex.set(e,r)),r.setCriteria(t)}_removeCriteria(e){let t=this._filterColumnByIndex.get(e);t&&(t.dispose(),this._filterColumnByIndex.delete(e))}_emit(){this._filteredOutRows$.next(this._alreadyFilteredOutRows)}_emitHasCriteria(){this._hasCriteria$.next(this._filterColumnByIndex.size>0)}_rebuildAlreadyFilteredOutRowsWithCache(){let e=this._getAllFilterColumns().filter(e=>e.hasCache()).reduce((e,t)=>(0,a.mergeSets)(e,t.filteredOutRows),/* @__PURE__ */new Set);this._alreadyFilteredOutRows=e}_reCalcWithNoCacheColumns(){for(let e of this._getAllFilterColumns().filter(e=>!e.hasCache())){let t=e.reCalc();t&&(this._alreadyFilteredOutRows=(0,a.mergeSets)(this._alreadyFilteredOutRows,t))}}};p(L,"FilterModel");let V=class extends a.Disposable{constructor(e,t,r,n,i){super(),g(this,"_filteredOutRows",null),g(this,"_filterFn",null),g(this,"_range",null),g(this,"_column",0),g(this,"_filterByValues",!1),this.unitId=e,this.subUnitId=t,this._worksheet=r,this._criteria=n,this._filterColumnContext=i}get filteredOutRows(){return this._filteredOutRows}dispose(){super.dispose(),this._filteredOutRows=null}__clearCache(){this._filteredOutRows=null}serialize(){if(!this._criteria)throw Error("[FilterColumn]: could not serialize without a filter column!");return(0,a.Tools).deepClone({...this._criteria,colId:this._column})}hasCache(){return null!==this._filteredOutRows}setRangeAndColumn(e,t){this._range=e,this._column=t}setCriteria(e){this._criteria=e,this._generateFilterFn(),this._filteredOutRows=null}getColumnData(){return(0,a.Tools).deepClone(this._criteria)}reCalc(){return this._filteredOutRows=this.calc(this._filterColumnContext),this._filteredOutRows}calc(e){if(!this._filterFn)throw Error("[FilterColumn] cannot calculate without a filter fn!");if(!this._range)throw Error("[FilterColumn] cannot calculate without a range!");if("number"!=typeof this._column)throw TypeError("[FilterColumn] cannot calculate without a column offset!");let t=this._column,r={startColumn:t,endColumn:t,startRow:this._range.startRow+1,endRow:this._range.endRow},n=/* @__PURE__ */new Set,i=e.getAlreadyFilteredOutRows();for(let e of this._worksheet.iterateByColumn(r,!1,!1)){let{row:t,rowSpan:r,col:o}=e;if(i.has(t)&&(!r||1===r))continue;let s=this._filterByValues?(0,a.extractPureTextFromCell)(this._worksheet.getCell(t,o)):z(this._worksheet,t,o);if(!this._filterFn(s)&&(n.add(t),r))for(let e=1;e<r;e++)n.add(t+e)}return n}_generateFilterFn(){this._criteria&&(this._filterFn=j(this._criteria),this._filterByValues=!!this._criteria.filters)}};p(V,"FilterColumn");let F=V;function j(e){if(e.filters)return H(e.filters);if(e.customFilters)return $(e.customFilters);throw Error("[FilterModel]: other types of filters are not supported yet.")}function H(e){let t=!!e.blank,r=new Set(e.filters);return e=>void 0===e||""===e?t:r.has("string"==typeof e?e:`${e}`)}function $(e){let t=e.customFilters.map(e=>Y(e));return G(t)?e.and?B(t):W(t):t[0]}function B(e){let[t,r]=e;return e=>t(e)&&r(e)}function W(e){let[t,r]=e;return e=>t(e)||r(e)}function G(e){return 2===e.length}function Y(e){let t=e.val;if(e.operator===S.NOT_EQUALS&&!P(t))return e=>E.fn(e,t);if(M(e.operator)){if(!P(t))return()=>!1;let r=D(e.operator),n=Number(t);return e=>r.fn(e,n)}let r=D(e.operator);return e=>r.fn(e,t)}function z(e,t,r){let n=e.getCell(t,r);if(!n)return null;let i=e.getCellRaw(t,r);return n&&!i?K(n):i?n.t===a.CellValueType.NUMBER&&"string"==typeof n.v?i.v:K(i):null}function K(e){var t,r;let n=null==(r=null==(t=e.p)?void 0:t.body)?void 0:r.dataStream;if(n)return n.trimEnd();let i=e.v;return"string"==typeof i?e.t===a.CellValueType.BOOLEAN?i.toUpperCase():i:"number"==typeof i?e.t===a.CellValueType.BOOLEAN?i?"TRUE":"FALSE":i:"boolean"==typeof i?i?"TRUE":"FALSE":""}p(j,"generateFilterFn"),p(H,"filterByValuesFnFactory"),p($,"customFilterFnFactory"),p(B,"AND"),p(W,"OR"),p(G,"isCompoundCustomFilter"),p(Y,"generateCustomFilterFn"),p(z,"getFilterValueForConditionalFiltering"),p(K,"extractFilterValueFromCell");var q=Object.defineProperty,X=Object.getOwnPropertyDescriptor,Z=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?X(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&q(t,r,a),a},"__decorateClass$2"),Q=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let J=/* @__PURE__ */new Set([f.id,v.id,_.id,I.id]),ee="SHEET_FILTER_PLUGIN",et=(ei=class extends a.Disposable{constructor(e,t,r){super(),g(this,"_filterModels",/* @__PURE__ */new Map),g(this,"_loadedUnitId$",new o.BehaviorSubject(null)),g(this,"loadedUnitId$",this._loadedUnitId$.asObservable()),g(this,"_errorMsg$",new o.BehaviorSubject(null)),g(this,"errorMsg$",this._errorMsg$.asObservable()),g(this,"_activeFilterModel$",new o.BehaviorSubject(null)),g(this,"activeFilterModel$",this._activeFilterModel$.asObservable()),this._resourcesManagerService=e,this._univerInstanceService=t,this._commandService=r,this._initModel(),this._initActiveFilterModel()}get activeFilterModel(){return this._activeFilterModel$.getValue()}ensureFilterModel(e,t){let r=this.getFilterModel(e,t);if(r)return r;let n=this._univerInstanceService.getUniverSheetInstance(e);if(!n)throw Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing workbook ${e}!`);let i=n.getSheetBySheetId(t);if(!i)throw Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing worksheet ${t}!`);let a=new L(e,t,i);return this._cacheFilterModel(e,t,a),a}getFilterModel(e,t){var r,n;return null!=(n=null==(r=this._filterModels.get(e))?void 0:r.get(t))?n:null}removeFilterModel(e,t){let r=this.getFilterModel(e,t);return!!r&&(r.dispose(),this._filterModels.get(e).delete(t),!0)}setFilterErrorMsg(e){this._errorMsg$.next(e)}_updateActiveFilterModel(){let e;try{if(!(e=this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET))){this._activeFilterModel$.next(null);return}}catch(e){console.error("[SheetsFilterService]: could not get active workbook!",e);return}let t=e.getActiveSheet(!0);if(!t){this._activeFilterModel$.next(null);return}let r=t.getUnitId(),n=t.getSheetId(),i=this.getFilterModel(r,n);this._activeFilterModel$.next(i)}_initActiveFilterModel(){this.disposeWithMe((0,l.merge)((0,a.fromCallback)(this._commandService.onCommandExecuted.bind(this._commandService)).pipe((0,s.filter)(([e])=>e.type===a.CommandType.MUTATION&&J.has(e.id))),this._univerInstanceService.getCurrentTypeOfUnit$(a.UniverInstanceType.UNIVER_SHEET).pipe((0,u.switchMap)(e=>{var t;return null!=(t=null==e?void 0:e.activeSheet$)?t:(0,d.of)(null)}))).subscribe(()=>this._updateActiveFilterModel()))}_serializeAutoFiltersForUnit(e){let t=this._filterModels.get(e);if(!t)return"{}";let r={};return t.forEach((e,t)=>{r[t]=e.serialize()}),JSON.stringify(r)}_deserializeAutoFiltersForUnit(e,t){let r=this._univerInstanceService.getUniverSheetInstance(e);Object.keys(t).forEach(n=>{let i=t[n],a=L.deserialize(e,n,r.getSheetBySheetId(n),i);this._cacheFilterModel(e,n,a)})}_initModel(){this._resourcesManagerService.registerPluginResource({pluginName:ee,businesses:[a.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */p(e=>this._serializeAutoFiltersForUnit(e),"toJson"),parseJson:/* @__PURE__ */p(e=>JSON.parse(e),"parseJson"),onLoad:/* @__PURE__ */p((e,t)=>{this._deserializeAutoFiltersForUnit(e,t),this._loadedUnitId$.next(e),this._updateActiveFilterModel()},"onLoad"),onUnLoad:/* @__PURE__ */p(e=>{let t=this._filterModels.get(e);t&&(t.forEach(e=>e.dispose()),this._filterModels.delete(e))},"onUnLoad")})}_cacheFilterModel(e,t,r){this._filterModels.has(e)||this._filterModels.set(e,/* @__PURE__ */new Map),this._filterModels.get(e).set(t,r)}},p(ei,"SheetsFilterService"),ei);function er(e,t){for(let r=0;r<e.length;r++){let n=r;if(e[r])for(let i=r+1;i<e.length;i++)e[n]&&e[i]&&t(e[n],e[i])&&(e[n]=null,n=i)}return e.filter(e=>null!==e)}function en(e){return er(e,(e,t)=>e.id===v.id&&t.id===v.id&&e.params.unitId===t.params.unitId&&e.params.subUnitId===t.params.subUnitId&&e.params.col===t.params.col)}et=Z([Q(0,a.IResourceManagerService),Q(1,a.IUniverInstanceService),Q(2,a.ICommandService)],et),p(er,"objectsShaker"),p(en,"mergeSetFilterCriteria");var ei,ea,eo=Object.defineProperty,es=Object.getOwnPropertyDescriptor,el=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?es(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eo(t,r,a),a},"__decorateClass$1"),ed=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let eu=(ea=class extends a.Disposable{constructor(e,t,r,n,i){super(),g(this,"_disposableCollection",new a.DisposableCollection),this._commandService=e,this._sheetInterceptorService=t,this._sheetsFilterService=r,this._univerInstanceService=n,this._refRangeService=i,this._initCommands(),this._initRowFilteredInterceptor(),this._initInterceptors(),this._commandExecutedListener(),this._initErrorHandling()}_initCommands(){[v,f,I,_].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_initInterceptors(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */p(e=>this._getUpdateFilter(e),"getMutations")})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===c.SetWorksheetActivateCommand.id){let t=e.params,r=t.subUnitId,n=t.unitId;if(!r||!n)return;this._registerRefRange(n,r)}if(e.id===f.id){let t=e.params,r=t.subUnitId,n=t.unitId;if(!r||!n)return;this._registerRefRange(t.unitId,t.subUnitId)}})),this.disposeWithMe(this._sheetsFilterService.loadedUnitId$.subscribe(e=>{if(e){let t=this._univerInstanceService.getUniverSheetInstance(e),r=null==t?void 0:t.getActiveSheet();r&&this._registerRefRange(e,r.getSheetId())}}))}_registerRefRange(e,t){var r;this._disposableCollection.dispose();let n=this._univerInstanceService.getUniverSheetInstance(e),i=null==n?void 0:n.getSheetBySheetId(t);if(!n||!i)return;let a=null==(r=this._sheetsFilterService.getFilterModel(e,t))?void 0:r.getRange(),o=/* @__PURE__ */p(r=>{switch(r.id){case c.InsertRowCommand.id:{let n=r.params,i=n.unitId||e,a=n.subUnitId||t;return this._handleInsertRowCommand(n,i,a)}case c.InsertColCommand.id:{let n=r.params,i=n.unitId||e,a=n.subUnitId||t;return this._handleInsertColCommand(n,i,a)}case c.RemoveColCommand.id:{let n=r.params;return this._handleRemoveColCommand(n,e,t)}case c.RemoveRowCommand.id:{let n=r.params;return this._handleRemoveRowCommand(n,e,t)}case c.EffectRefRangId.MoveColsCommandId:{let n=r.params;return this._handleMoveColsCommand(n,e,t)}case c.EffectRefRangId.MoveRowsCommandId:{let n=r.params;return this._handleMoveRowsCommand(n,e,t)}case c.MoveRangeCommand.id:{let n=r.params;return this._handleMoveRangeCommand(n,e,t)}}return{redos:[],undos:[]}},"handler");a&&this._disposableCollection.add(this._refRangeService.registerRefRange(a,o,e,t))}_getUpdateFilter(e){let{id:t}=e;if(t===c.RemoveSheetCommand.id){let t=e.params;return this._handleRemoveSheetCommand(t,t.unitId,t.subUnitId)}return{redos:[],undos:[]}}_handleInsertColCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),a=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!a)return this._handleNull();let{startColumn:o,endColumn:s}=a,{startColumn:l,endColumn:d}=e.range,u=d-l+1;if(d>s)return this._handleNull();let c=[],h=[],m={unitId:t,subUnitId:r,range:{...a,startColumn:l<=o?o+u:o,endColumn:s+u}};c.push({id:f.id,params:m}),h.push({id:f.id,params:{unitId:t,subUnitId:r,range:a}});let p=i.getAllFilterColumns().filter(e=>e[0]>=l);if(0!==p.length){let{newRange:e,oldRange:n}=this.moveCriteria(t,r,p,u);c.push(...e.redos,...n.redos),h.push(...e.undos,...n.undos)}return{redos:en(c),undos:en(h)}}_handleInsertRowCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),a=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!a)return this._handleNull();let{startRow:o,endRow:s}=a,{startRow:l,endRow:d}=e.range,u=d-l+1;if(d>s)return this._handleNull();let c=[],h=[],m={unitId:t,subUnitId:r,range:{...a,startRow:l<=o?o+u:o,endRow:s+u}};return c.push({id:f.id,params:m}),h.push({id:f.id,params:{unitId:t,subUnitId:r,range:a}}),{redos:en(c),undos:en(h)}}_handleRemoveColCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),a=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!a)return this._handleNull();let{startColumn:o,endColumn:s}=a,{startColumn:l,endColumn:d}=e.range;if(l>s)return this._handleNull();let u=[],c=[],h=d<o?0:Math.min(d,s)-Math.max(l,o)+1,m=d-l+1,p=i.getAllFilterColumns();p.forEach(e=>{let[n,i]=e;n<=d&&n>=l&&(u.push({id:v.id,params:{unitId:t,subUnitId:r,col:n,criteria:null}}),c.push({id:v.id,params:{unitId:t,subUnitId:r,col:n,criteria:{...i.serialize(),colId:n}}}))});let g=p.filter(e=>{let[t,r]=e;return t>d}),I={undos:[],redos:[]};if(g.length>0){let{oldRange:e,newRange:n}=this.moveCriteria(t,r,g,-m);I=n,u.push(...e.redos),c.unshift(...e.undos)}if(h===s-o+1)u.push({id:_.id,params:{unitId:t,subUnitId:r}}),c.push({id:f.id,params:{range:a,unitId:t,subUnitId:r}});else{let e={unitId:t,subUnitId:r,range:{...a,startColumn:o<=l?o:0===h?o-m:l,endColumn:o<=l?s-h:s-m}};u.push({id:f.id,params:e}),c.unshift({id:f.id,params:{range:a,unitId:t,subUnitId:r}}),u.push(...I.redos),c.unshift(...I.undos)}return{undos:c,redos:u}}_handleRemoveRowCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r);if(!i)return this._handleNull();let a=i.getRange(),{startRow:o,endRow:s}=a,{startRow:l,endRow:d}=e.range;if(l>s)return this._handleNull();if(d<o)return{undos:[{id:f.id,params:{range:a,unitId:t,subUnitId:r}}],redos:[{id:f.id,params:{range:{...a,startRow:o-(d-l+1),endRow:s-(d-l+1)},unitId:t,subUnitId:r}}]};let u=[],c=[],h=i.getAllFilterColumns(),m=o<=d&&o>=l;c.push({id:f.id,params:{range:a,unitId:t,subUnitId:r}});let p=Math.min(d,s)-Math.max(l,o)+1;if(p===s-o+1||m)u.push({id:_.id,params:{unitId:t,subUnitId:r}}),h.forEach(e=>{let[n,i]=e,a={unitId:t,subUnitId:r,col:n,criteria:{...i.serialize(),colId:n}};c.push({id:v.id,params:a})});else{let e=null==(n=this._univerInstanceService.getUniverSheetInstance(t))?void 0:n.getSheetBySheetId(r);if(!e)return this._handleNull();let i=[];for(let t=l;t<=d;t++)e.getRowFiltered(t)&&i.push(t);let c=Math.min(o,l),h=c+(s-o)-p+i.length,m={unitId:t,subUnitId:r,range:{...a,startRow:c,endRow:h}};u.push({id:f.id,params:m})}return{undos:en(c),redos:en(u)}}_handleMoveColsCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),o=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!o)return this._handleNull();let{startColumn:s,endColumn:l}=o,{fromRange:d,toRange:u}=e;if(d.endColumn<s&&u.startColumn<=s||d.startColumn>l&&u.endColumn>l)return this._handleNull();let c=[],h=[],m={};for(let e=s;e<=l;e++)m[e]={colIndex:e,filter:i.getFilterColumn(e)};(0,a.moveMatrixArray)(d.startColumn,d.endColumn-d.startColumn+1,u.startColumn,m);let p=o.startColumn,g=o.endColumn;s>=d.startColumn&&s<=d.endColumn&&u.startColumn>d.startColumn&&d.endColumn<l&&(p=d.endColumn+1),l>=d.startColumn&&l<=d.endColumn&&u.startColumn<d.startColumn&&d.startColumn>s&&(g=d.startColumn-1);let _=Object.keys(m).map(e=>Number(e)),I=_.find(e=>m[e].colIndex===g),S=_.find(e=>m[e].colIndex===p);if(_.forEach(e=>{var n,a;let{colIndex:o,filter:s}=m[e];if(s){if(e>=S&&e<=I){let a={unitId:t,subUnitId:r,col:e,criteria:{...s.serialize(),colId:e}},o={unitId:t,subUnitId:r,col:e,criteria:i.getFilterColumn(e)?{...null==(n=i.getFilterColumn(e))?void 0:n.serialize(),colId:e}:null};c.push({id:v.id,params:a}),h.push({id:v.id,params:o})}null!=(a=m[o])&&a.filter||(c.push({id:v.id,params:{unitId:t,subUnitId:r,col:o,criteria:null}}),h.push({id:v.id,params:{unitId:t,subUnitId:r,col:o,criteria:{...s.serialize(),colId:o}}}))}}),s!==S||l!==I){let e={unitId:t,subUnitId:r,range:{...o,startColumn:S,endColumn:I}};c.unshift({id:f.id,params:e}),h.unshift({id:f.id,params:{range:o,unitId:t,subUnitId:r}})}return{undos:h,redos:c}}_handleMoveRowsCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),o=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!o)return this._handleNull();let{startRow:s,endRow:l}=o,{fromRange:d,toRange:u}=e;if(d.endRow<s&&u.startRow<=s||d.startRow>l&&u.endRow>l)return this._handleNull();let c=[],h=[],m={};for(let e=s;e<=l;e++)m[e]={oldIndex:e};let p=l;l>=d.startRow&&l<=d.endRow&&u.startRow<d.startRow&&d.startRow>s&&(p=d.startRow-1),(0,a.moveMatrixArray)(d.startRow,d.endRow-d.startRow+1,u.startRow,m);let g=Object.keys(m).map(e=>Number(e)),v=g.find(e=>m[e].oldIndex===p),_=g.find(e=>m[e].oldIndex===s);if(s!==_||l!==v){let e={unitId:t,subUnitId:r,range:{...o,startRow:_,endRow:v}};c.push({id:f.id,params:e},{id:I.id,params:{unitId:t,subUnitId:r}}),h.push({id:f.id,params:{range:o,unitId:t,subUnitId:r}},{id:I.id,params:{unitId:t,subUnitId:r}})}return{redos:c,undos:h}}_handleMoveRangeCommand(e,t,r){let{fromRange:n,toRange:i}=e,o=this._sheetsFilterService.getFilterModel(t,r);if(!o)return this._handleNull();let s=o.getRange();if(!s)return this._handleNull();let l=[],d=[];if((0,a.Rectangle).contains(n,s)){let e=s.startRow-n.startRow,a=s.startColumn-n.startColumn,u={startRow:i.startRow+e,startColumn:i.startColumn+a,endRow:i.startRow+e+(s.endRow-s.startRow),endColumn:i.startColumn+a+(s.endColumn-s.startColumn)},c={id:_.id,params:{unitId:t,subUnitId:r}},h={id:f.id,params:{unitId:t,subUnitId:r,range:u}},m={id:f.id,params:{unitId:t,subUnitId:r,range:s}};l.push(c,h),d.push(c,m);let p=o.getAllFilterColumns(),g=i.startColumn-n.startColumn;p.forEach(e=>{let[n,i]=e;i&&(l.push({id:v.id,params:{unitId:t,subUnitId:r,col:n+g,criteria:{...i.serialize(),colId:n+g}}}),d.push({id:v.id,params:{unitId:t,subUnitId:r,col:n,criteria:{...i.serialize(),colId:n}}}))})}return{redos:l,undos:d}}_handleRemoveSheetCommand(e,t,r){let n=this._sheetsFilterService.getFilterModel(t,r);if(!n)return this._handleNull();let i=n.getRange();if(!i)return this._handleNull();let a=[],o=[];return n.getAllFilterColumns().forEach(e=>{let[n,i]=e;o.push({id:v.id,params:{unitId:t,subUnitId:r,col:e,criteria:{...i.serialize(),colId:e}}})}),a.push({id:_.id,params:{unitId:t,subUnitId:r,range:i}}),o.unshift({id:f.id,params:{range:i,unitId:t,subUnitId:r}}),{undos:o,redos:a}}_handleNull(){return{redos:[],undos:[]}}_initRowFilteredInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(c.INTERCEPTOR_POINT.ROW_FILTERED,{handler:/* @__PURE__ */p((e,t)=>{var r,n;return!!e||null!=(n=null==(r=this._sheetsFilterService.getFilterModel(t.unitId,t.subUnitId))?void 0:r.isRowFiltered(t.row))&&n},"handler")}))}moveCriteria(e,t,r,n){let i={unitId:e,subUnitId:t,criteria:null,col:-1},a=[],o=[],s=[],l=[];return r.forEach(e=>{let[t,r]=e;o.push({id:v.id,params:{...i,col:t}}),a.push({id:v.id,params:{...i,col:t,criteria:{...r.serialize(),colId:t}}})}),r.forEach(e=>{let[t,r]=e;l.push({id:v.id,params:{...i,col:t+n,criteria:{...r.serialize(),colId:t+n}}}),s.push({id:v.id,params:{...i,col:t+n,criteria:null}})}),{newRange:{redos:l,undos:s},oldRange:{redos:o,undos:a}}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((e,t)=>{var r,n;let{unitId:i,subUnitId:a}=e.params||{},o=this._sheetsFilterService.getFilterModel(i,a);if(!o)return;let s=Array.from(o.filteredOutRows).sort((e,t)=>e-t),l=[],d=!1;if(e.id===c.RemoveRowMutation.id){let{startRow:t,endRow:r}=e.params.range,n=s.filter(e=>e>=t&&e<=r);s.forEach(e=>{if(e<t)l.push(e);else if(d=!0,e<=r){let e=Math.max(t,l.length?l[l.length-1]+1:t);l.push(e)}else l.push(e-(r-t+1-n.length))})}if(e.id===c.InsertRowMutation.id){let{startRow:t,endRow:r}=e.params.range;s.forEach(e=>{e>=t?(d=!0,l.push(e+(r-t+1))):l.push(e)})}if(d&&(o.filteredOutRows=new Set(l)),e.id===c.SetRangeValuesMutation.id&&!(null!=t&&t.fromCollab)&&!(null!=t&&t.onlyLocal)){let t=this._getExtendRegion(i,a);if(t){let o=e.params.cellValue;if(o)for(let e=t.startColumn;e<=t.endColumn;e++){let s=null==(r=null==o?void 0:o[t.startRow])?void 0:r[e];if(s&&this._cellHasValue(s)){let e=null==(n=this._univerInstanceService.getUnit(i))?void 0:n.getSheetBySheetId(a);if(e){let r=(0,c.expandToContinuousRange)(t,{down:!0},e),n=this._sheetsFilterService.getFilterModel(i,a),o=n.getRange();n.setRange({...o,endRow:r.endRow}),this._registerRefRange(i,a)}}}}}}))}_getExtendRegion(e,t){var r;let n=this._sheetsFilterService.getFilterModel(e,t);if(!n)return null;let i=null==(r=this._univerInstanceService.getUnit(e))?void 0:r.getSheetBySheetId(t);if(!i)return null;let a=n.getRange();if(!a)return null;let o=i.getRowCount()-1,s=i.getRowManager();for(let e=a.endRow+1;e<=o;e++)if(s.getRowRawVisible(e))return{startRow:e,endRow:e,startColumn:a.startColumn,endColumn:a.endColumn};return null}_initErrorHandling(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{let t=e.params,r=(0,c.getSheetCommandTarget)(this._univerInstanceService);if(!r)return;let{subUnitId:n,unitId:i}=r,a=this._sheetsFilterService.getFilterModel(i,n);if(!a)return;let o=a.getRange();if(e.id===c.MoveRowsCommand.id&&t.fromRange.startRow<=o.startRow&&t.fromRange.endRow<o.endRow&&t.fromRange.endRow>=o.startRow)throw this._sheetsFilterService.setFilterErrorMsg("sheets-filter.msg.filter-header-forbidden"),Error("[SheetsFilterController]: Cannot move header row of filter")}))}_cellHasValue(e){let t=Object.values(e);return!(0===t.length||t.every(e=>null==e))}},p(ea,"SheetsFilterController"),ea);eu=el([ed(0,a.ICommandService),ed(1,(0,a.Inject)(c.SheetInterceptorService)),ed(2,(0,a.Inject)(et)),ed(3,a.IUniverInstanceService),ed(4,(0,a.Inject)(c.RefRangeService))],eu);let ec={};var eh,em=Object.defineProperty,ep=Object.getOwnPropertyDescriptor,eg=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ep(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&em(t,r,a),a},"__decorateClass"),ef=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let ev=(p(eh=class extends a.Plugin{constructor(e=ec,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("sheets-filter.config",n)}onStarting(){[[et],[eu]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(eu)}},"UniverSheetsFilterPlugin"),g(eh,"type",a.UniverInstanceType.UNIVER_SHEET),g(eh,"pluginName",ee),eh);ev=eg([ef(1,(0,a.Inject)(a.Injector)),ef(2,a.IConfigService)],ev)}),i("cXi9L",function(i,a){let o,s,l;e(i.exports,"SetSheetFilterRangeCommand",function(){return Y}),e(i.exports,"RemoveSheetFilterCommand",function(){return z}),e(i.exports,"SetSheetsFilterCriteriaCommand",function(){return q}),e(i.exports,"ClearSheetsFilterCriteriaCommand",function(){return X});var d=n("83KcA"),u=n("vzesf"),c=n("1PPLO"),h=n("cahIb"),m=n("jv4BO"),p=n("5WWyv"),g=n("eSxk0"),f=n("a9FIH"),v=n("fElJC"),_=n("d0sRG"),I=n("bA4Xh"),S=n("clIO8"),C=n("lWHHt"),y=n("01IGc"),b=n("2Ha4T"),w=n("bTGUS"),R=n("cZW0b"),E=n("cmCKE"),T=n("11kpD"),M=n("D79YY"),O=n("bLx5G"),D=n("ls2nu"),U=n("gQuIR"),P=n("2XYu4"),k=Object.defineProperty,N=(e,t,r)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,A=(e,t)=>k(e,"name",{value:t,configurable:!0}),x=(e,t,r)=>N(e,"symbol"!=typeof t?t+"":t,r),L=function(){return(L=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},V=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},F=(0,U.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=V(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,U.useRef)("_".concat(B()));return j(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},L({ref:t,className:s},o),a)});function j(e,t,r,n,i){return(0,U.createElement)(e.tag,L(L({key:t},H(e,r,i)),n),($(e,r).children||[]).map(function(n,a){return j(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function H(e,t,r){var n=L({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function $(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?L(L({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?L(L({},e),{attrs:L(L({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function B(){return Math.random().toString(36).substring(2,8)}A(j,"render"),A(H,"replaceRuntimeIdsAndExtInAttrs"),A($,"replaceRuntimeIdsInDefs"),A(B,"generateShortUuid"),F.displayName="UniverIcon";var W={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.32182 2.60967C2.98161 2.60967 2.79671 3.0074 3.01601 3.2675L6.85819 7.8246C6.94943 7.93282 6.99947 8.06981 6.99947 8.21136V12.7338C6.99947 12.898 7.0998 13.0455 7.2525 13.1058L8.73833 13.6928C9.00085 13.7965 9.28531 13.6031 9.28531 13.3208V8.21136C9.28531 8.06981 9.33535 7.93282 9.42659 7.8246L13.2688 3.2675C13.4881 3.0074 13.3032 2.60967 12.963 2.60967H3.32182ZM2.09858 4.04101C1.22139 3.0006 1.96097 1.40967 3.32182 1.40967H12.963C14.3238 1.40967 15.0634 3.0006 14.1862 4.04101L10.4853 8.43054V13.3208C10.4853 14.4498 9.34747 15.2237 8.29742 14.8089L6.81158 14.2219C6.20078 13.9806 5.79947 13.3905 5.79947 12.7338V8.43054L2.09858 4.04101Z",fillRule:"evenodd",clipRule:"evenodd"}}]},G=(0,U.forwardRef)(function(e,t){return(0,U.createElement)(F,Object.assign({},e,{id:"filter-single",ref:t,icon:W}))});G.displayName="FilterSingle";let Y={id:"sheet.command.set-filter-range",type:d.CommandType.COMMAND,handler:/* @__PURE__ */A((e,t)=>{let r=e.get(u.SheetsFilterService),n=e.get(d.ICommandService),i=e.get(d.IUndoRedoService),a=e.get(d.IUniverInstanceService),{unitId:o,subUnitId:s,range:l}=t;if(!(0,D.getSheetCommandTarget)(a,t)||r.getFilterModel(o,s))return!1;if(l.endRow===l.startRow){let t=e.get(h.IMessageService,d.Quantity.OPTIONAL),r=e.get(d.LocaleService);return null==t||t.show({type:O.MessageType.Warning,content:r.t("sheets-filter.command.not-valid-filter-range")}),!1}let c={id:u.SetSheetsFilterRangeMutation.id,params:{unitId:o,subUnitId:s,range:l}},m=n.syncExecuteCommand(c.id,c.params);return m&&i.pushUndoRedo({unitID:o,undoMutations:[{id:u.RemoveSheetsFilterMutation.id,params:{unitId:o,subUnitId:s}}],redoMutations:[c]}),m},"handler")},z={id:"sheet.command.remove-sheet-filter",type:d.CommandType.COMMAND,handler:/* @__PURE__ */A((e,t)=>{let r=e.get(d.IUniverInstanceService),n=e.get(u.SheetsFilterService),i=e.get(d.ICommandService),a=e.get(d.IUndoRedoService),o=(0,D.getSheetCommandTarget)(r,t);if(!o)return!1;let{unitId:s,subUnitId:l}=o,c=n.getFilterModel(s,l);if(!c)return!1;let h=Q(s,l,null==c?void 0:c.serialize()),m=i.syncExecuteCommand(u.RemoveSheetsFilterMutation.id,{unitId:s,subUnitId:l});return m&&a.pushUndoRedo({unitID:s,undoMutations:h,redoMutations:[{id:u.RemoveSheetsFilterMutation.id,params:{unitId:s,subUnitId:l}}]}),m},"handler")},K={id:"sheet.command.smart-toggle-filter",type:d.CommandType.COMMAND,handler:/* @__PURE__ */A(async e=>{let t=e.get(d.IUniverInstanceService),r=e.get(u.SheetsFilterService),n=e.get(d.ICommandService),i=t.getCurrentUnitForType(d.UniverInstanceType.UNIVER_SHEET),a=null==i?void 0:i.getActiveSheet();if(!a||!i)return!1;let o=i.getUnitId(),s=a.getSheetId();if(r.getFilterModel(o,s))return n.executeCommand(z.id,{unitId:o,subUnitId:s});let l=e.get(D.SheetsSelectionsService).getCurrentLastSelection();if(!l)return!1;let c=l.range,h=(0,D.isSingleCellSelection)(l)?(0,D.expandToContinuousRange)(c,{left:!0,right:!0,up:!0,down:!0},a):c;return n.executeCommand(Y.id,{unitId:o,subUnitId:s,range:h})},"handler")},q={id:"sheet.command.set-filter-criteria",type:d.CommandType.COMMAND,handler:/* @__PURE__ */A(async(e,t)=>{let r=e.get(u.SheetsFilterService),n=e.get(d.ICommandService),i=e.get(d.IUndoRedoService),{unitId:a,subUnitId:o,col:s,criteria:l}=t,c=r.getFilterModel(a,o);if(!c)return!1;let h=c.getRange();if(!h||s<h.startColumn||s>h.endColumn)return!1;let m=c.getFilterColumn(s),p=et(a,o,s,m),g={id:u.SetSheetsFilterCriteriaMutation.id,params:{unitId:a,subUnitId:o,col:s,criteria:l}},f=n.syncExecuteCommand(g.id,g.params);return f&&i.pushUndoRedo({unitID:a,undoMutations:[p],redoMutations:[g]}),f},"handler")},X={id:"sheet.command.clear-filter-criteria",type:d.CommandType.COMMAND,handler:/* @__PURE__ */A((e,t)=>{let r=e.get(u.SheetsFilterService),n=e.get(d.IUndoRedoService),i=e.get(d.ICommandService),a=e.get(d.IUniverInstanceService),o=(0,D.getSheetCommandTarget)(a,t);if(!o)return!1;let{unitId:s,subUnitId:l}=o,c=r.getFilterModel(o.unitId,o.subUnitId);if(!c)return!1;let h=c.serialize(),m=J(s,l,h),p=ee(s,l,h);return!!(0,d.sequenceExecute)(p,i).result&&(n.pushUndoRedo({unitID:s,undoMutations:m,redoMutations:p}),!0)},"handler")},Z={id:"sheet.command.re-calc-filter",type:d.CommandType.COMMAND,handler:/* @__PURE__ */A((e,t)=>{let r=e.get(u.SheetsFilterService),n=e.get(d.ICommandService),i=e.get(d.IUniverInstanceService),a=(0,D.getSheetCommandTarget)(i,t);if(!a)return!1;let{unitId:o,subUnitId:s}=a;return!!r.getFilterModel(a.unitId,a.subUnitId)&&n.executeCommand(u.ReCalcSheetsFilterMutation.id,{unitId:o,subUnitId:s})},"handler")};function Q(e,t,r){let n=[],i={id:u.SetSheetsFilterRangeMutation.id,params:{unitId:e,subUnitId:t,range:r.ref}};return n.push(i),J(e,t,r).forEach(e=>n.push(e)),n}function J(e,t,r){var n;let i=[];return null==(n=r.filterColumns)||n.forEach(r=>{let n={id:u.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r.colId,criteria:r}};i.push(n)}),i}function ee(e,t,r){var n;let i=[];return null==(n=r.filterColumns)||n.forEach(r=>{let n={id:u.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r.colId,criteria:null}};i.push(n)}),i}function et(e,t,r,n){if(!n)return{id:u.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r,criteria:null}};let i=n.serialize();return{id:u.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r,criteria:i}}}A(Q,"destructFilterModel"),A(J,"destructFilterCriteria"),A(ee,"generateRemoveCriteriaMutations"),A(et,"destructFilterColumn");var er,en=((o=en||{})[o.FIRST=0]="FIRST",o[o.SECOND=1]="SECOND",o),ei=((s=ei||{}).NONE="none",s.STARTS_WITH="startsWith",s.DOES_NOT_START_WITH="doesNotStartWith",s.ENDS_WITH="endsWith",s.DOES_NOT_END_WITH="doesNotEndWith",s.CONTAINS="contains",s.DOES_NOT_CONTAIN="doesNotContain",s.EQUALS="equals",s.NOT_EQUALS="notEquals",s.EMPTY="empty",s.NOT_EMPTY="notEmpty",s.BETWEEN="between",s.NOT_BETWEEN="notBetween",s.CUSTOM="custom",s);function ea(e){let{operator1:t,operator2:r,val1:n,val2:i}=e;if(t&&r)throw Error("Both operator1 and operator2 are set!");if(!t&&!r)throw Error("Neither operator1 and operator2 and both not set!");return t?[t,n]:[r,i]}function eo(e){let t=[],r=[];for(let n of e)n.checked?t.push(n):r.push(n);return{checkedItems:t,uncheckedItems:r,checked:t.length,unchecked:r.length}}(e=>{function t(t){let r=e.ALL_CONDITIONS.find(e=>e.operator===t);if(!r)throw Error(`[SheetsFilter]: no condition item found for operator: ${t}`);return r}function r(t,r){for(let n of e.ALL_CONDITIONS.filter(e=>e.numOfParameters===r))if(0!==n.numOfParameters&&n.testMappingParams(t))return n;for(let r of e.ALL_CONDITIONS)if(r.testMappingParams(t))return r;throw Error("[SheetsFilter]: no condition item can be mapped from the filter map params!")}function n(t){let r=e.ALL_CONDITIONS.find(e=>e.operator===t);return(null==r?void 0:r.numOfParameters)===0?{operator1:r.operator}:r.getDefaultFormParams()}function i(e,t){return e.mapToFilterColumn(t)}function a(t){if(!t)return[e.NONE,{}];for(let r of e.ALL_CONDITIONS){let e=r.testMappingFilterColumn(t);if(e)return[r,e]}return[e.NONE,{}]}e.NONE={label:"sheets-filter.conditions.none",operator:ei.NONE,order:en.SECOND,numOfParameters:0,getDefaultFormParams:/* @__PURE__ */A(()=>{throw Error("[FilterConditionItems.NONE]: should not have initial form params!")},"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>e.operator1===ei.NONE,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(()=>null,"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>!e.customFilters&&!e.filters&&{},"testMappingFilterColumn")},e.EMPTY={label:"sheets-filter.conditions.empty",operator:ei.EMPTY,order:en.SECOND,numOfParameters:0,getDefaultFormParams:/* @__PURE__ */A(()=>{throw Error("[FilterConditionItems.EMPTY]: should not have initial form params!")},"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(({operator1:e})=>e===ei.EMPTY,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(()=>({customFilters:{customFilters:[{val:""}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return""===r.val&&void 0===r.operator&&{operator1:ei.EMPTY}},"testMappingFilterColumn")},e.NOT_EMPTY={label:"sheets-filter.conditions.not-empty",operator:ei.NOT_EMPTY,order:en.SECOND,numOfParameters:0,getDefaultFormParams:/* @__PURE__ */A(()=>{throw Error("[FilterConditionItems.NOT_EMPTY]: should not have initial form params!")},"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(({operator1:e})=>e===ei.NOT_EMPTY,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(()=>({customFilters:{customFilters:[{val:"",operator:u.CustomFilterOperator.NOT_EQUALS}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return" "===r.val&&r.operator===u.CustomFilterOperator.NOT_EQUALS&&{operator1:ei.NOT_EMPTY}},"testMappingFilterColumn")},e.TEXT_CONTAINS={label:"sheets-filter.conditions.text-contains",operator:ei.CONTAINS,order:en.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:ei.CONTAINS,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===ei.CONTAINS},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>{let{val1:t}=e;return""===t?null:{customFilters:{customFilters:[{val:`*${t}*`}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(!r.operator&&n.startsWith("*")&&n.endsWith("*"))&&{operator1:ei.CONTAINS,val1:n.slice(1,-1)}},"testMappingFilterColumn")},e.DOES_NOT_CONTAIN={label:"sheets-filter.conditions.does-not-contain",operator:ei.DOES_NOT_CONTAIN,order:en.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:ei.DOES_NOT_CONTAIN,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:`*${e.val1}*`,operator:u.CustomFilterOperator.NOT_EQUALS}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===ei.DOES_NOT_CONTAIN},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(r.operator===u.CustomFilterOperator.NOT_EQUALS&&n.startsWith("*")&&n.endsWith("*"))&&{operator1:ei.DOES_NOT_CONTAIN,val1:n.slice(1,-1)}},"testMappingFilterColumn")},e.STARTS_WITH={label:"sheets-filter.conditions.starts-with",operator:ei.STARTS_WITH,order:en.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:ei.STARTS_WITH,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:`${e.val1}*`}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===ei.STARTS_WITH},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(!r.operator&&n.endsWith("*"))&&!n.startsWith("*")&&{operator1:ei.STARTS_WITH,val1:n.slice(0,-1)}},"testMappingFilterColumn")},e.ENDS_WITH={label:"sheets-filter.conditions.ends-with",operator:ei.ENDS_WITH,order:en.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:ei.ENDS_WITH,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:`*${e.val1}`}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===ei.ENDS_WITH},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(!r.operator&&n.startsWith("*"))&&!n.endsWith("*")&&{operator1:ei.ENDS_WITH,val1:n.slice(1)}},"testMappingFilterColumn")},e.EQUALS={label:"sheets-filter.conditions.equals",operator:ei.EQUALS,order:en.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:ei.EQUALS,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===ei.EQUALS},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>{let{val1:t}=e;return""===t?null:{customFilters:{customFilters:[{val:t}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t,r,n;return(null==(r=null==(t=e.filters)?void 0:t.filters)?void 0:r.length)===1?{operator1:ei.EQUALS,val1:""}:(null==(n=e.customFilters)?void 0:n.customFilters.length)===1&&!e.customFilters.customFilters[0].operator&&{operator1:ei.EQUALS,val1:e.customFilters.customFilters[0].val.toString()}},"testMappingFilterColumn")},e.GREATER_THAN={label:"sheets-filter.conditions.greater-than",operator:u.CustomFilterOperator.GREATER_THAN,numOfParameters:1,order:en.FIRST,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:u.CustomFilterOperator.GREATER_THAN,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:e.val1,operator:u.CustomFilterOperator.GREATER_THAN}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===u.CustomFilterOperator.GREATER_THAN},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===u.CustomFilterOperator.GREATER_THAN&&{operator1:u.CustomFilterOperator.GREATER_THAN,val1:r.val.toString()}},"testMappingFilterColumn")},e.GREATER_THAN_OR_EQUAL={label:"sheets-filter.conditions.greater-than-or-equal",operator:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL,numOfParameters:1,order:en.FIRST,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===u.CustomFilterOperator.GREATER_THAN_OR_EQUAL},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:e.val1,operator:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===u.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&{operator1:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:r.val.toString()}},"testMappingFilterColumn")},e.LESS_THAN={label:"sheets-filter.conditions.less-than",operator:u.CustomFilterOperator.LESS_THAN,numOfParameters:1,order:en.FIRST,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:u.CustomFilterOperator.LESS_THAN,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===u.CustomFilterOperator.LESS_THAN},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:e.val1,operator:u.CustomFilterOperator.LESS_THAN}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===u.CustomFilterOperator.LESS_THAN&&{operator1:u.CustomFilterOperator.LESS_THAN,val1:r.val.toString()}},"testMappingFilterColumn")},e.LESS_THAN_OR_EQUAL={label:"sheets-filter.conditions.less-than-or-equal",operator:u.CustomFilterOperator.LESS_THAN_OR_EQUAL,numOfParameters:1,order:en.FIRST,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:u.CustomFilterOperator.LESS_THAN_OR_EQUAL,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===u.CustomFilterOperator.LESS_THAN_OR_EQUAL},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:e.val1,operator:u.CustomFilterOperator.LESS_THAN_OR_EQUAL}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===u.CustomFilterOperator.LESS_THAN_OR_EQUAL&&{operator1:u.CustomFilterOperator.LESS_THAN_OR_EQUAL,val1:r.val.toString()}},"testMappingFilterColumn")},e.EQUAL={label:"sheets-filter.conditions.equal",operator:u.CustomFilterOperator.EQUAL,numOfParameters:1,order:en.FIRST,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:u.CustomFilterOperator.EQUAL,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===u.CustomFilterOperator.EQUAL},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:e.val1,operator:u.CustomFilterOperator.EQUAL}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===u.CustomFilterOperator.EQUAL&&{operator1:u.CustomFilterOperator.EQUAL,val1:r.val.toString()}},"testMappingFilterColumn")},e.NOT_EQUAL={label:"sheets-filter.conditions.not-equal",operator:u.CustomFilterOperator.NOT_EQUALS,numOfParameters:1,order:en.FIRST,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:u.CustomFilterOperator.NOT_EQUALS,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let[t]=ea(e);return t===u.CustomFilterOperator.NOT_EQUALS},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>({customFilters:{customFilters:[{val:e.val1,operator:u.CustomFilterOperator.NOT_EQUALS}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===u.CustomFilterOperator.NOT_EQUALS&&{operator1:u.CustomFilterOperator.NOT_EQUALS,val1:r.val.toString()}},"testMappingFilterColumn")},e.BETWEEN={label:"sheets-filter.conditions.between",operator:ei.BETWEEN,order:en.SECOND,numOfParameters:2,getDefaultFormParams:/* @__PURE__ */A(()=>({and:!0,operator1:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:"",operator2:u.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let{and:t,operator1:r,operator2:n}=e;if(!t)return!1;let i=[r,n];return i.includes(u.CustomFilterOperator.GREATER_THAN_OR_EQUAL)&&i.includes(u.CustomFilterOperator.LESS_THAN_OR_EQUAL)},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>{let{val1:t,val2:r,operator1:n}=e,i=n===u.CustomFilterOperator.GREATER_THAN_OR_EQUAL;return{customFilters:{and:d.BooleanNumber.TRUE,customFilters:[{val:i?t:r,operator:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL},{val:i?r:t,operator:u.CustomFilterOperator.LESS_THAN_OR_EQUAL}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==2)return!1;let[r,n]=e.customFilters.customFilters;return r.operator===u.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&n.operator===u.CustomFilterOperator.LESS_THAN_OR_EQUAL&&e.customFilters.and?{and:!0,operator1:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:r.val.toString(),operator2:u.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:n.val.toString()}:n.operator===u.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&r.operator===u.CustomFilterOperator.LESS_THAN_OR_EQUAL&&!!e.customFilters.and&&{and:!0,operator1:u.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:n.val.toString(),operator2:u.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:r.val.toLocaleString()}},"testMappingFilterColumn")},e.NOT_BETWEEN={label:"sheets-filter.conditions.not-between",operator:ei.NOT_BETWEEN,order:en.SECOND,numOfParameters:2,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:u.CustomFilterOperator.LESS_THAN,val1:"",operator2:u.CustomFilterOperator.GREATER_THAN,val2:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(e=>{let{and:t,operator1:r,operator2:n}=e;if(t)return!1;let i=[r,n];return i.includes(u.CustomFilterOperator.GREATER_THAN)&&i.includes(u.CustomFilterOperator.LESS_THAN)},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(e=>{let{val1:t,val2:r,operator1:n}=e,i=n===u.CustomFilterOperator.GREATER_THAN;return{customFilters:{customFilters:[{val:i?t:r,operator:u.CustomFilterOperator.GREATER_THAN},{val:i?r:t,operator:u.CustomFilterOperator.LESS_THAN}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==2)return!1;let[r,n]=e.customFilters.customFilters;return r.operator!==u.CustomFilterOperator.LESS_THAN||n.operator!==u.CustomFilterOperator.GREATER_THAN||e.customFilters.and?n.operator===u.CustomFilterOperator.LESS_THAN&&r.operator===u.CustomFilterOperator.GREATER_THAN&&!e.customFilters.and&&{operator1:u.CustomFilterOperator.GREATER_THAN,val1:n.val.toString(),operator2:u.CustomFilterOperator.LESS_THAN,val2:r.val.toLocaleString()}:{operator1:u.CustomFilterOperator.LESS_THAN,val1:r.val.toString(),operator2:u.CustomFilterOperator.GREATER_THAN,val2:n.val.toString()}},"testMappingFilterColumn")},e.CUSTOM={label:"sheets-filter.conditions.custom",operator:ei.CUSTOM,order:en.SECOND,numOfParameters:2,getDefaultFormParams:/* @__PURE__ */A(()=>({operator1:ei.NONE,val1:"",operator2:ei.NONE,val2:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */A(()=>!0,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */A(t=>{let{and:r,val1:n,val2:i,operator1:a,operator2:o}=t;function s(t,r){for(let n of e.ALL_CONDITIONS)if(n.operator===t)return n.mapToFilterColumn({val1:r,operator1:t})}A(s,"mapOperator");let l=!a||a===e.NONE.operator,u=!o||o===e.NONE.operator;if(l&&u)return e.NONE.mapToFilterColumn({});if(l)return s(o,i);if(u)return s(a,n);let c=s(a,n),h=s(o,i),m={customFilters:[c.customFilters.customFilters[0],h.customFilters.customFilters[0]]};return r&&(m.and=d.BooleanNumber.TRUE),{customFilters:m}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */A(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==2)return!1;let r=e.customFilters.customFilters.map(e=>a({customFilters:{customFilters:[e]}})),n={operator1:r[0][0].operator,val1:r[0][1].val1,operator2:r[1][0].operator,val2:r[1][1].val1};return e.customFilters.and&&(n.and=!0),n},"testMappingFilterColumn")},e.ALL_CONDITIONS=[e.NONE,e.EMPTY,e.NOT_EMPTY,e.TEXT_CONTAINS,e.DOES_NOT_CONTAIN,e.STARTS_WITH,e.ENDS_WITH,e.EQUALS,e.GREATER_THAN,e.GREATER_THAN_OR_EQUAL,e.LESS_THAN,e.LESS_THAN_OR_EQUAL,e.EQUAL,e.NOT_EQUAL,e.BETWEEN,e.NOT_BETWEEN,e.CUSTOM],A(t,"getItemByOperator"),e.getItemByOperator=t,A(r,"testMappingParams"),e.testMappingParams=r,A(n,"getInitialFormParams"),e.getInitialFormParams=n,A(i,"mapToFilterColumn"),e.mapToFilterColumn=i,A(a,"testMappingFilterColumn"),e.testMappingFilterColumn=a})(er||(er={})),A(ea,"getOnlyOperatorAndVal"),A(eo,"statisticFilterByValueItems");var es=Object.defineProperty,el=Object.getOwnPropertyDescriptor,ed=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?el(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&es(t,r,a),a},"__decorateClass$9"),eu=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let ec="sheets-filter.generate-filter-values.service",eh=(0,d.createIdentifier)(ec),em=(A(eq=class extends d.Disposable{constructor(e,t,r){super(),this._localeService=e,this._univerInstanceService=t,this._logService=r}async getFilterValues(e){var t;let{unitId:r,subUnitId:n,filteredOutRowsByOtherColumns:i,filters:a,blankChecked:o,iterateRange:s,alreadyChecked:l}=e,d=null==(t=this._univerInstanceService.getUnit(r))?void 0:t.getSheetBySheetId(n);return d?(this._logService.debug("[SheetsGenerateFilterValuesService]","getFilterValues for",{unitId:r,subUnitId:n}),ep(a,o,this._localeService,s,d,new Set(l.map(String)),new Set(i))):[]}},"SheetsGenerateFilterValuesService"),eq);function ep(e,t,r,n,i,a,o){let s=[],l={},u=0,c=0;for(let e of i.iterateByColumn(n,!1,!1)){let{row:r,rowSpan:n=1}=e,i=0;for(;i<n;){let h=r+i;if(o.has(h)){i++;continue}let m=null!=e&&e.value?(0,d.extractPureTextFromCell)(e.value):"";if(!m){c+=1,i+=n;continue}if(l[m])l[m].count++;else{let e={value:m,checked:a.size?a.has(m):!t,count:1,index:u,isEmpty:!1};l[m]=e,s.push(e)}i++}u++}if(c>0){let n={value:r.t("sheets-filter.panel.empty"),checked:!e||t,count:c,index:u,isEmpty:!0};s.push(n)}return s}em=ed([eu(0,(0,d.Inject)(d.LocaleService)),eu(1,d.IUniverInstanceService),eu(2,d.ILogService)],em),A(ep,"getFilterByValueItems");var eg=Object.defineProperty,ef=Object.getOwnPropertyDescriptor,ev=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ef(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eg(t,r,a),a},"__decorateClass$8"),e_=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8"),eI=((l=eI||{})[l.VALUES=0]="VALUES",l[l.CONDITIONS=1]="CONDITIONS",l);(0,d.createIdentifier)("sheets-filter-ui.sheets-filter-panel.service");let eS=(A(eX=class extends d.Disposable{constructor(e,t){super(),x(this,"_filterBy$",new m.BehaviorSubject(0)),x(this,"filterBy$",this._filterBy$.asObservable()),x(this,"_filterByModel$",new S.ReplaySubject(1)),x(this,"filterByModel$",this._filterByModel$.asObservable()),x(this,"_filterByModel",null),x(this,"_hasCriteria$",new m.BehaviorSubject(!1)),x(this,"hasCriteria$",this._hasCriteria$.asObservable()),x(this,"_filterModel",null),x(this,"_col$",new m.BehaviorSubject(-1)),x(this,"col$",this._col$.asObservable()),x(this,"_filterHeaderListener",null),this._injector=e,this._refRangeService=t}get filterBy(){return this._filterBy$.getValue()}get filterByModel(){return this._filterByModel}set filterByModel(e){this._filterByModel=e,this._filterByModel$.next(e)}get filterModel(){return this._filterModel}get col(){return this._col$.getValue()}dispose(){this._filterBy$.complete(),this._filterByModel$.complete(),this._hasCriteria$.complete()}setupCol(e,t){this.terminate(),this._filterModel=e,this._col$.next(t);let r=e.getFilterColumn(t);if(r){let n=r.getColumnData();if(n.customFilters){this._hasCriteria$.next(!0),this._setupByConditions(e,t);return}if(n.filters){this._hasCriteria$.next(!0),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t)}changeFilterBy(e){return!!this._filterModel&&-1!==this.col&&(0===e?this._setupByValues(this._filterModel,this.col):this._setupByConditions(this._filterModel,this.col),!0)}terminate(){return this._filterModel=null,this._col$.next(-1),this._disposeFilterHeaderChangeListener(),!0}_disposeFilterHeaderChangeListener(){var e;null==(e=this._filterHeaderListener)||e.dispose(),this._filterHeaderListener=null}_listenToFilterHeaderChange(e,t){this._disposeFilterHeaderChangeListener();let r=e.unitId,n=e.subUnitId,i=e.getRange(),a={startColumn:t,startRow:i.startRow,endRow:i.startRow,endColumn:t};this._filterHeaderListener=this._refRangeService.watchRange(r,n,a,(e,t)=>{if(t){let r=t.startColumn-e.startColumn;0!==r&&this._filterByModel.deltaCol(r)}else this.terminate()})}async _setupByValues(e,t){this._disposePreviousModel();let r=e.getRange();if(r.startRow===r.endRow)return!1;let n=await ey.fromFilterColumn(this._injector,e,t);return this.filterByModel=n,this._filterBy$.next(0),this._listenToFilterHeaderChange(e,t),!0}_setupByConditions(e,t){this._disposePreviousModel();let r=e.getRange();if(r.startRow===r.endRow)return!1;let n=eC.fromFilterColumn(this._injector,e,t,e.getFilterColumn(t));return this.filterByModel=n,this._filterBy$.next(1),this._listenToFilterHeaderChange(e,t),!0}_disposePreviousModel(){var e;null==(e=this._filterByModel)||e.dispose(),this.filterByModel=null}},"SheetsFilterPanelService"),eX);eS=ev([e_(0,(0,d.Inject)(d.Injector)),e_(1,(0,d.Inject)(D.RefRangeService))],eS);let eC=(A(eZ=class extends d.Disposable{constructor(e,t,r,n,i){super(),x(this,"canApply$",(0,I.of)(!0)),x(this,"_conditionItem$"),x(this,"conditionItem$"),x(this,"_filterConditionFormParams$"),x(this,"filterConditionFormParams$"),this._filterModel=e,this.col=t,this._commandService=i,this._conditionItem$=new m.BehaviorSubject(r),this.conditionItem$=this._conditionItem$.asObservable(),this._filterConditionFormParams$=new m.BehaviorSubject(n),this.filterConditionFormParams$=this._filterConditionFormParams$.asObservable()}static fromFilterColumn(e,t,r,n){let[i,a]=er.testMappingFilterColumn(null==n?void 0:n.getColumnData());return e.createInstance(eC,t,r,i,a)}get conditionItem(){return this._conditionItem$.getValue()}get filterConditionFormParams(){return this._filterConditionFormParams$.getValue()}dispose(){super.dispose(),this._conditionItem$.complete(),this._filterConditionFormParams$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(q.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;let e=er.mapToFilterColumn(this.conditionItem,this.filterConditionFormParams);return this._commandService.executeCommand(q.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:e})}onPrimaryConditionChange(e){let t=er.ALL_CONDITIONS.find(t=>t.operator===e);if(!t)throw Error(`[ByConditionsModel]: condition item not found for operator: ${e}!`);this._conditionItem$.next(t),this._filterConditionFormParams$.next(er.getInitialFormParams(e))}onConditionFormChange(e){let t={...this.filterConditionFormParams,...e};if(!0!==t.and&&delete t.and,"u">typeof e.and||"u">typeof e.operator1||"u">typeof e.operator2){let e=er.testMappingParams(t,this.conditionItem.numOfParameters);this._conditionItem$.next(e)}this._filterConditionFormParams$.next(t)}},"ByConditionsModel"),eZ);eC=ev([e_(4,d.ICommandService)],eC);let ey=(A(eQ=class extends d.Disposable{constructor(e,t,r,n){super(),x(this,"_rawFilterItems$"),x(this,"rawFilterItems$"),x(this,"filterItems$"),x(this,"_filterItems",[]),x(this,"canApply$"),x(this,"_manuallyUpdateFilterItems$"),x(this,"_searchString$"),x(this,"searchString$"),this._filterModel=e,this.col=t,this._commandService=n,this._searchString$=new m.BehaviorSubject(""),this.searchString$=this._searchString$.asObservable(),this._rawFilterItems$=new m.BehaviorSubject(r),this.rawFilterItems$=this._rawFilterItems$.asObservable(),this._manuallyUpdateFilterItems$=new b.Subject,this.filterItems$=(0,_.merge)((0,p.combineLatest)([this._searchString$.pipe((0,E.throttleTime)(500,void 0,{leading:!0,trailing:!0}),(0,y.startWith)(void 0)),this._rawFilterItems$]).pipe((0,v.map)(([e,t])=>{if(!e)return t;let r=e.toLowerCase().split(/\s+/).filter(e=>!!e);return t.filter(e=>{let t=e.value.toLowerCase();return r.some(e=>t.includes(e))})})),this._manuallyUpdateFilterItems$).pipe((0,C.shareReplay)(1)),this.canApply$=this.filterItems$.pipe((0,v.map)(e=>eo(e).checked>0)),this.disposeWithMe(this.filterItems$.subscribe(e=>this._filterItems=e))}static async fromFilterColumn(e,t,r){var n;let i;let a=e.get(d.IUniverInstanceService),o=e.get(d.LocaleService),s=e.get(eh,d.Quantity.OPTIONAL),{unitId:l,subUnitId:u}=t,c=a.getUniverSheetInstance(l);if(!c)throw Error(`[ByValuesModel]: Workbook not found for filter model with unitId: ${l}!`);let h=null==c?void 0:c.getSheetBySheetId(u);if(!h)throw Error(`[ByValuesModel]: Worksheet not found for filter model with unitId: ${l} and subUnitId: ${u}!`);let m=t.getRange(),p=null==(n=t.getFilterColumn(r))?void 0:n.getColumnData().filters,g=new Set(null==p?void 0:p.filters),f=!!(p&&p.blank),v=t.getFilteredOutRowsExceptCol(r),_={...m,startRow:m.startRow+1,startColumn:r,endColumn:r};return i=s?await s.getFilterValues({unitId:l,subUnitId:u,filteredOutRowsByOtherColumns:Array.from(v),filters:!!p,blankChecked:f,iterateRange:_,alreadyChecked:Array.from(g)}):ep(!!p,f,o,_,h,g,v),e.createInstance(ey,t,r,i)}get rawFilterItems(){return this._rawFilterItems$.getValue()}get filterItems(){return this._filterItems}dispose(){this._rawFilterItems$.complete(),this._searchString$.complete()}deltaCol(e){this.col+=e}setSearchString(e){this._searchString$.next(e)}onFilterCheckToggled(e,t){let r=this._filterItems.slice();r.find(t=>t.index===e.index).checked=t,this._manuallyUpdateFilterItems(r)}onFilterOnly(e){let t=this._filterItems.slice();t.forEach(t=>t.checked=t.index===e.index),this._manuallyUpdateFilterItems(t)}onCheckAllToggled(e){let t=this._filterItems.slice();t.forEach(t=>t.checked=e),this._manuallyUpdateFilterItems(t)}_manuallyUpdateFilterItems(e){this._manuallyUpdateFilterItems$.next(e)}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(q.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;let e=eo(this._filterItems),{checked:t,checkedItems:r}=e,n=this.rawFilterItems,i=e.checked===n.length,a={colId:this.col};if(0===t)throw Error("[ByValuesModel]: no checked items!");if(i)return this._commandService.executeCommand(q.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});{a.filters={};let e=r.filter(e=>!e.isEmpty);e.length>0&&(a.filters={filters:e.map(e=>e.value)}),e.length!==r.length&&(a.filters.blank=!0)}return this._commandService.executeCommand(q.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:a})}},"ByValuesModel"),eQ);ey=ev([e_(3,d.ICommandService)],ey);let eb="FILTER_PANEL_OPENED",ew={id:"sheet.operation.open-filter-panel",type:d.CommandType.OPERATION,handler:/* @__PURE__ */A((e,t)=>{let r=e.get(d.IContextService),n=e.get(u.SheetsFilterService),i=e.get(eS);e.get(d.ICommandService).syncExecuteCommand(T.SetCellEditVisibleOperation.id,{visible:!1});let{unitId:a,subUnitId:o,col:s}=t,l=n.getFilterModel(a,o);return!!l&&(i.setupCol(l,s),r.getContextValue(eb)||r.setContextValue(eb,!0),!0)},"handler")},eR={id:"sheet.operation.close-filter-panel",type:d.CommandType.OPERATION,handler:/* @__PURE__ */A(e=>{let t=e.get(d.IContextService),r=e.get(eS),n=e.get(h.ILayoutService,d.Quantity.OPTIONAL);return!!t.getContextValue(eb)&&(t.setContextValue(eb,!1),null==n||n.focus(),r.terminate())},"handler")},eE={id:"sheet.operation.apply-filter",type:d.CommandType.OPERATION,handler:/* @__PURE__ */A((e,t)=>{let{filterBy:r}=t;return e.get(eS).changeFilterBy(r)},"handler")},eT={sheetsFilterPanel:"univer-sheets-filter-panel",sheetsFilterPanelHeader:"univer-sheets-filter-panel-header",sheetsFilterPanelContent:"univer-sheets-filter-panel-content",sheetsFilterPanelValuesContainer:"univer-sheets-filter-panel-values-container",sheetsFilterPanelValuesList:"univer-sheets-filter-panel-values-list",sheetsFilterPanelValuesVirtual:"univer-sheets-filter-panel-values-virtual",sheetsFilterPanelValuesItem:"univer-sheets-filter-panel-values-item",sheetsFilterPanelValuesItemInner:"univer-sheets-filter-panel-values-item-inner",sheetsFilterPanelValuesItemCount:"univer-sheets-filter-panel-values-item-count",sheetsFilterPanelValuesItemExcludeButton:"univer-sheets-filter-panel-values-item-exclude-button",sheetsFilterPanelValuesItemText:"univer-sheets-filter-panel-values-item-text",sheetsFilterPanelConditionsContainer:"univer-sheets-filter-panel-conditions-container",sheetsFilterPanelConditionsContainerInner:"univer-sheets-filter-panel-conditions-container-inner",sheetsFilterPanelConditionsDesc:"univer-sheets-filter-panel-conditions-desc",sheetsFilterPanelFooter:"univer-sheets-filter-panel-footer",sheetsFilterPanelFooterPrimaryButtons:"univer-sheets-filter-panel-footer-primary-buttons"};function eM(e){let{model:r}=e,n=(0,d.useDependency)(d.LocaleService),i=(0,h.useObservable)(r.conditionItem$,void 0,!0),a=(0,h.useObservable)(r.filterConditionFormParams$,void 0,!0),{operator:o,numOfParameters:s}=i,{operator1:l,operator2:u,val1:c,val2:m,and:p}=a,g=p?"AND":"OR",f=(0,U.useCallback)(e=>{r.onConditionFormChange({and:"AND"===e})},[r]),v=eO(n),_=(0,U.useCallback)(e=>{r.onPrimaryConditionChange(e)},[r]),I=eD(n),S=(0,U.useCallback)(e=>{r.onConditionFormChange(e)},[r]),C=n.t("sheets-filter.panel.input-values-placeholder");function y(e,r,i){let a=1===er.getItemByOperator(e).numOfParameters;return /* @__PURE__ *//*@__PURE__*/t(U).createElement(/*@__PURE__*/t(U).Fragment,null,"operator2"===i&&/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.RadioGroup,{value:g,onChange:f},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Radio,{value:"AND"},n.t("sheets-filter.panel.and")),/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Radio,{value:"OR"},n.t("sheets-filter.panel.or"))),/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Select,{value:e,options:I,onChange:/* @__PURE__ */A(e=>S({[i]:e}),"onChange")}),a&&/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Input,{value:r,placeholder:C,onChange:/* @__PURE__ */A(e=>S({["operator1"===i?"val1":"val2"]:e}),"onChange")}))}return A(y,"renderSecondaryCondition"),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelConditionsContainer},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Select,{value:o,options:v,onChange:_}),0!==er.getItemByOperator(o).numOfParameters?/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelConditionsContainerInner},s>=1&&y(l,null!=c?c:"","operator1"),s>=2&&y(u,null!=m?m:"","operator2"),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelConditionsDesc},n.t("sheets-filter.panel.?"),/* @__PURE__ *//*@__PURE__*/t(U).createElement("br",null),n.t("sheets-filter.panel.*"))):null)}function eO(e){let t=e.getCurrentLocale();return(0,U.useMemo)(()=>[{options:[{label:e.t(er.NONE.label),value:er.NONE.operator}]},{options:[{label:e.t(er.EMPTY.label),value:er.EMPTY.operator},{label:e.t(er.NOT_EMPTY.label),value:er.NOT_EMPTY.operator}]},{options:[{label:e.t(er.TEXT_CONTAINS.label),value:er.TEXT_CONTAINS.operator},{label:e.t(er.DOES_NOT_CONTAIN.label),value:er.DOES_NOT_CONTAIN.operator},{label:e.t(er.STARTS_WITH.label),value:er.STARTS_WITH.operator},{label:e.t(er.ENDS_WITH.label),value:er.ENDS_WITH.operator},{label:e.t(er.EQUALS.label),value:er.EQUALS.operator}]},{options:[{label:e.t(er.GREATER_THAN.label),value:er.GREATER_THAN.operator},{label:e.t(er.GREATER_THAN_OR_EQUAL.label),value:er.GREATER_THAN_OR_EQUAL.operator},{label:e.t(er.LESS_THAN.label),value:er.LESS_THAN.operator},{label:e.t(er.LESS_THAN_OR_EQUAL.label),value:er.LESS_THAN_OR_EQUAL.operator},{label:e.t(er.EQUAL.label),value:er.EQUAL.operator},{label:e.t(er.NOT_EQUAL.label),value:er.NOT_EQUAL.operator},{label:e.t(er.BETWEEN.label),value:er.BETWEEN.operator},{label:e.t(er.NOT_BETWEEN.label),value:er.NOT_BETWEEN.operator}]},{options:[{label:e.t(er.CUSTOM.label),value:er.CUSTOM.operator}]}],[t,e])}function eD(e){let t=e.getCurrentLocale();return(0,U.useMemo)(()=>er.ALL_CONDITIONS.filter(e=>2!==e.numOfParameters).map(t=>({label:e.t(t.label),value:t.operator})),[t,e])}function eU(){return(eU=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)({}).hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(null,arguments)}function eP(e){return(eP="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ek(e,t){if("object"!=eP(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=eP(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function eN(e){var t=ek(e,"string");return"symbol"==eP(t)?t:t+""}function eA(e,t,r){return(t=eN(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ex(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function eL(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ex(Object(r),!0).forEach(function(t){eA(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ex(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function eV(e){if(Array.isArray(e))return e}function eF(e,t){var r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,a,o,s=[],l=!0,d=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;l=!1}else for(;!(l=(n=a.call(r)).done)&&(s.push(n.value),s.length!==t);l=!0);}catch(e){d=!0,i=e}finally{try{if(!l&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(d)throw i}}return s}}function ej(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function eH(e,t){if(e){if("string"==typeof e)return ej(e,t);var r=({}).toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ej(e,t):void 0}}function e$(){throw TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function eB(e,t){return eV(e)||eF(e,t)||eH(e,t)||e$()}function eW(e,t){if(null==e)return{};var r={};for(var n in e)if(({}).hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;r[n]=e[n]}return r}function eG(e,t){if(null==e)return{};var r,n,i=eW(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||({}).propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function eY(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}A(eM,"FilterByCondition"),A(eO,"usePrimaryOptions"),A(eD,"useSecondaryOptions"),A(eU,"_extends"),A(eP,"_typeof"),A(ek,"toPrimitive"),A(eN,"toPropertyKey"),A(eA,"_defineProperty"),A(ex,"ownKeys"),A(eL,"_objectSpread2"),A(eV,"_arrayWithHoles"),A(eF,"_iterableToArrayLimit"),A(ej,"_arrayLikeToArray"),A(eH,"_unsupportedIterableToArray"),A(e$,"_nonIterableRest"),A(eB,"_slicedToArray"),A(eW,"_objectWithoutPropertiesLoose"),A(eG,"_objectWithoutProperties"),A(eY,"getDefaultExportFromCjs");var ez={exports:{}};(function(){var e={}.hasOwnProperty;function t(){for(var e="",t=0;t<arguments.length;t++){var i=arguments[t];i&&(e=n(e,r(i)))}return e}function r(r){if("string"==typeof r||"number"==typeof r)return r;if("object"!=typeof r)return"";if(Array.isArray(r))return t.apply(null,r);if(r.toString!==Object.prototype.toString&&!r.toString.toString().includes("[native code]"))return r.toString();var i="";for(var a in r)e.call(r,a)&&r[a]&&(i=n(i,a));return i}function n(e,t){return t?e?e+" "+t:e+t:e}A(t,"classNames"),A(r,"parseValue"),A(n,"appendClass"),ez.exports?(t.default=t,ez.exports=t):window.classNames=t})();let eK=/* @__PURE__ */eY(ez.exports);var eq,eX,eZ,eQ,eJ,e0={exports:{}},e1={},e3=Symbol.for("react.element"),e2=Symbol.for("react.portal"),e4=Symbol.for("react.fragment"),e9=Symbol.for("react.strict_mode"),e5=Symbol.for("react.profiler"),e6=Symbol.for("react.provider"),e8=Symbol.for("react.context"),e7=Symbol.for("react.server_context"),te=Symbol.for("react.forward_ref"),tt=Symbol.for("react.suspense"),tr=Symbol.for("react.suspense_list"),tn=Symbol.for("react.memo"),ti=Symbol.for("react.lazy"),ta=Symbol.for("react.offscreen");function to(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case e3:switch(e=e.type){case e4:case e5:case e9:case tt:case tr:return e;default:switch(e=e&&e.$$typeof){case e7:case e8:case te:case ti:case tn:case e6:return e;default:return t}}case e2:return t}}}eJ=Symbol.for("react.module.reference"),A(to,"v"),e1.ContextConsumer=e8,e1.ContextProvider=e6,e1.Element=e3,e1.ForwardRef=te,e1.Fragment=e4,e1.Lazy=ti,e1.Memo=tn,e1.Portal=e2,e1.Profiler=e5,e1.StrictMode=e9,e1.Suspense=tt,e1.SuspenseList=tr,e1.isAsyncMode=function(){return!1},e1.isConcurrentMode=function(){return!1},e1.isContextConsumer=function(e){return to(e)===e8},e1.isContextProvider=function(e){return to(e)===e6},e1.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===e3},e1.isForwardRef=function(e){return to(e)===te},e1.isFragment=function(e){return to(e)===e4},e1.isLazy=function(e){return to(e)===ti},e1.isMemo=function(e){return to(e)===tn},e1.isPortal=function(e){return to(e)===e2},e1.isProfiler=function(e){return to(e)===e5},e1.isStrictMode=function(e){return to(e)===e9},e1.isSuspense=function(e){return to(e)===tt},e1.isSuspenseList=function(e){return to(e)===tr},e1.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===e4||e===e5||e===e9||e===tt||e===tr||e===ta||"object"==typeof e&&null!==e&&(e.$$typeof===ti||e.$$typeof===tn||e.$$typeof===e6||e.$$typeof===e8||e.$$typeof===te||e.$$typeof===eJ||void 0!==e.getModuleId)},e1.typeOf=to,e0.exports=e1;var ts=e0.exports;function tl(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=[];return /*@__PURE__*/t(U).Children.forEach(e,function(e){(null!=e||r.keepEmpty)&&(Array.isArray(e)?n=n.concat(tl(e)):ts.isFragment(e)&&e.props?n=n.concat(tl(e.props.children,r)):n.push(e))}),n}function td(e){return e instanceof HTMLElement||e instanceof SVGElement}function tu(e){return e&&"object"===eP(e)&&td(e.nativeElement)?e.nativeElement:td(e)?e:null}function tc(e){var r;return tu(e)||(e instanceof /*@__PURE__*/t(U).Component?null===(r=/*@__PURE__*/t(P).findDOMNode)||void 0===r?void 0:r.call(/*@__PURE__*/t(P),e):null)}function th(e,t,r){var n=U.useRef({});return(!("value"in n.current)||r(n.current.condition,t))&&(n.current.value=e(),n.current.condition=t),n.current.value}A(tl,"toArray"),A(td,"isDOM"),A(tu,"getDOM"),A(tc,"findDOMNode"),A(th,"useMemo");var tm=/* @__PURE__ */A(function(e,t){"function"==typeof e?e(t):"object"===eP(e)&&e&&"current"in e&&(e.current=t)},"fillRef"),tp=/* @__PURE__ */A(function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=t.filter(Boolean);return n.length<=1?n[0]:function(e){t.forEach(function(t){tm(t,e)})}},"composeRef"),tg=/* @__PURE__ */A(function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return th(function(){return tp.apply(void 0,t)},t,function(e,t){return e.length!==t.length||e.every(function(e,r){return e!==t[r]})})},"useComposeRef"),tf=/* @__PURE__ */A(function(e){var t,r,n=ts.isMemo(e)?e.type.type:e.type;return!("function"==typeof n&&!(null!==(t=n.prototype)&&void 0!==t&&t.render)&&n.$$typeof!==ts.ForwardRef||"function"==typeof e&&!(null!==(r=e.prototype)&&void 0!==r&&r.render)&&e.$$typeof!==ts.ForwardRef)},"supportRef");A(function(e){return/* @__PURE__ */(0,U.isValidElement)(e)&&!ts.isFragment(e)},"isReactElement"),(0,U.version).split(".")[0];var tv=/* @__PURE__ */U.createContext(null);function t_(e){var t=e.children,r=e.onBatchResize,n=U.useRef(0),i=U.useRef([]),a=U.useContext(tv),o=U.useCallback(function(e,t,o){n.current+=1;var s=n.current;i.current.push({size:e,element:t,data:o}),Promise.resolve().then(function(){s===n.current&&(null==r||r(i.current),i.current=[])}),null==a||a(e,t,o)},[r,a]);return /* @__PURE__ */U.createElement(tv.Provider,{value:o},t)}A(t_,"Collection");var tI=function(){if("u">typeof Map)return Map;function e(e,t){var r=-1;return e.some(function(e,n){return e[0]===t&&(r=n,!0)}),r}return A(e,"getIndex"),function(){function t(){this.__entries__=[]}return A(t,"class_1"),Object.defineProperty(t.prototype,"size",{get:/* @__PURE__ */A(function(){return this.__entries__.length},"get"),enumerable:!0,configurable:!0}),t.prototype.get=function(t){var r=e(this.__entries__,t),n=this.__entries__[r];return n&&n[1]},t.prototype.set=function(t,r){var n=e(this.__entries__,t);~n?this.__entries__[n][1]=r:this.__entries__.push([t,r])},t.prototype.delete=function(t){var r=this.__entries__,n=e(r,t);~n&&r.splice(n,1)},t.prototype.has=function(t){return!!~e(this.__entries__,t)},t.prototype.clear=function(){this.__entries__.splice(0)},t.prototype.forEach=function(e,t){void 0===t&&(t=null);for(var r=0,n=this.__entries__;r<n.length;r++){var i=n[r];e.call(t,i[1],i[0])}},t}()}(),tS="u">typeof window&&"u">typeof document&&window.document===document,tC="u">typeof r&&r.Math===Math?r:"u">typeof self&&self.Math===Math?self:"u">typeof window&&window.Math===Math?window:Function("return this")(),ty="function"==typeof requestAnimationFrame?requestAnimationFrame.bind(tC):function(e){return setTimeout(function(){return e(Date.now())},1e3/60)};function tb(e,t){var r=!1,n=!1,i=0;function a(){r&&(r=!1,e()),n&&s()}function o(){ty(a)}function s(){var e=Date.now();if(r){if(e-i<2)return;n=!0}else r=!0,n=!1,setTimeout(o,t);i=e}return A(a,"resolvePending"),A(o,"timeoutCallback"),A(s,"proxy"),s}A(tb,"throttle");var tw=["top","right","bottom","left","width","height","size","weight"],tR="u">typeof MutationObserver,tE=function(){function e(){this.connected_=!1,this.mutationEventsAdded_=!1,this.mutationsObserver_=null,this.observers_=[],this.onTransitionEnd_=this.onTransitionEnd_.bind(this),this.refresh=tb(this.refresh.bind(this),20)}return A(e,"ResizeObserverController"),e.prototype.addObserver=function(e){~this.observers_.indexOf(e)||this.observers_.push(e),this.connected_||this.connect_()},e.prototype.removeObserver=function(e){var t=this.observers_,r=t.indexOf(e);~r&&t.splice(r,1),!t.length&&this.connected_&&this.disconnect_()},e.prototype.refresh=function(){this.updateObservers_()&&this.refresh()},e.prototype.updateObservers_=function(){var e=this.observers_.filter(function(e){return e.gatherActive(),e.hasActive()});return e.forEach(function(e){return e.broadcastActive()}),e.length>0},e.prototype.connect_=function(){!tS||this.connected_||(document.addEventListener("transitionend",this.onTransitionEnd_),window.addEventListener("resize",this.refresh),tR?(this.mutationsObserver_=new MutationObserver(this.refresh),this.mutationsObserver_.observe(document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})):(document.addEventListener("DOMSubtreeModified",this.refresh),this.mutationEventsAdded_=!0),this.connected_=!0)},e.prototype.disconnect_=function(){tS&&this.connected_&&(document.removeEventListener("transitionend",this.onTransitionEnd_),window.removeEventListener("resize",this.refresh),this.mutationsObserver_&&this.mutationsObserver_.disconnect(),this.mutationEventsAdded_&&document.removeEventListener("DOMSubtreeModified",this.refresh),this.mutationsObserver_=null,this.mutationEventsAdded_=!1,this.connected_=!1)},e.prototype.onTransitionEnd_=function(e){var t=e.propertyName,r=void 0===t?"":t;tw.some(function(e){return!!~r.indexOf(e)})&&this.refresh()},e.getInstance=function(){return this.instance_||(this.instance_=new e),this.instance_},e.instance_=null,e}(),tT=/* @__PURE__ */A(function(e,t){for(var r=0,n=Object.keys(t);r<n.length;r++){var i=n[r];Object.defineProperty(e,i,{value:t[i],enumerable:!1,writable:!1,configurable:!0})}return e},"defineConfigurable"),tM=/* @__PURE__ */A(function(e){return e&&e.ownerDocument&&e.ownerDocument.defaultView||tC},"getWindowOf"),tO=tF(0,0,0,0);function tD(e){return parseFloat(e)||0}function tU(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return t.reduce(function(t,r){return t+tD(e["border-"+r+"-width"])},0)}function tP(e){for(var t={},r=0,n=["top","right","bottom","left"];r<n.length;r++){var i=n[r],a=e["padding-"+i];t[i]=tD(a)}return t}function tk(e){var t=e.getBBox();return tF(0,0,t.width,t.height)}function tN(e){var t=e.clientWidth,r=e.clientHeight;if(!t&&!r)return tO;var n=tM(e).getComputedStyle(e),i=tP(n),a=i.left+i.right,o=i.top+i.bottom,s=tD(n.width),l=tD(n.height);if("border-box"===n.boxSizing&&(Math.round(s+a)!==t&&(s-=tU(n,"left","right")+a),Math.round(l+o)!==r&&(l-=tU(n,"top","bottom")+o)),!tx(e)){var d=Math.round(s+a)-t,u=Math.round(l+o)-r;1!==Math.abs(d)&&(s-=d),1!==Math.abs(u)&&(l-=u)}return tF(i.left,i.top,s,l)}A(tD,"toFloat"),A(tU,"getBordersSize"),A(tP,"getPaddings"),A(tk,"getSVGContentRect"),A(tN,"getHTMLElementContentRect");var tA="u">typeof SVGGraphicsElement?function(e){return e instanceof tM(e).SVGGraphicsElement}:function(e){return e instanceof tM(e).SVGElement&&"function"==typeof e.getBBox};function tx(e){return e===tM(e).document.documentElement}function tL(e){return tS?tA(e)?tk(e):tN(e):tO}function tV(e){var t=e.x,r=e.y,n=e.width,i=e.height,a=Object.create(("u">typeof DOMRectReadOnly?DOMRectReadOnly:Object).prototype);return tT(a,{x:t,y:r,width:n,height:i,top:r,right:t+n,bottom:i+r,left:t}),a}function tF(e,t,r,n){return{x:e,y:t,width:r,height:n}}A(tx,"isDocumentElement"),A(tL,"getContentRect"),A(tV,"createReadOnlyRect"),A(tF,"createRectInit");var tj=function(){function e(e){this.broadcastWidth=0,this.broadcastHeight=0,this.contentRect_=tF(0,0,0,0),this.target=e}return A(e,"ResizeObservation"),e.prototype.isActive=function(){var e=tL(this.target);return this.contentRect_=e,e.width!==this.broadcastWidth||e.height!==this.broadcastHeight},e.prototype.broadcastRect=function(){var e=this.contentRect_;return this.broadcastWidth=e.width,this.broadcastHeight=e.height,e},e}(),tH=function(){function e(e,t){tT(this,{target:e,contentRect:tV(t)})}return A(e,"ResizeObserverEntry"),e}(),t$=function(){function e(e,t,r){if(this.activeObservations_=[],this.observations_=new tI,"function"!=typeof e)throw TypeError("The callback provided as parameter 1 is not a function.");this.callback_=e,this.controller_=t,this.callbackCtx_=r}return A(e,"ResizeObserverSPI"),e.prototype.observe=function(e){if(!arguments.length)throw TypeError("1 argument required, but only 0 present.");if(!(typeof Element>"u"||!(Element instanceof Object))){if(!(e instanceof tM(e).Element))throw TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)||(t.set(e,new tj(e)),this.controller_.addObserver(this),this.controller_.refresh())}},e.prototype.unobserve=function(e){if(!arguments.length)throw TypeError("1 argument required, but only 0 present.");if(!(typeof Element>"u"||!(Element instanceof Object))){if(!(e instanceof tM(e).Element))throw TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)&&(t.delete(e),t.size||this.controller_.removeObserver(this))}},e.prototype.disconnect=function(){this.clearActive(),this.observations_.clear(),this.controller_.removeObserver(this)},e.prototype.gatherActive=function(){var e=this;this.clearActive(),this.observations_.forEach(function(t){t.isActive()&&e.activeObservations_.push(t)})},e.prototype.broadcastActive=function(){if(this.hasActive()){var e=this.callbackCtx_,t=this.activeObservations_.map(function(e){return new tH(e.target,e.broadcastRect())});this.callback_.call(e,t,e),this.clearActive()}},e.prototype.clearActive=function(){this.activeObservations_.splice(0)},e.prototype.hasActive=function(){return this.activeObservations_.length>0},e}(),tB="u">typeof WeakMap?/* @__PURE__ */new WeakMap:new tI,tW=function(){function e(t){if(!(this instanceof e))throw TypeError("Cannot call a class as a function.");if(!arguments.length)throw TypeError("1 argument required, but only 0 present.");var r=new t$(t,tE.getInstance(),this);tB.set(this,r)}return A(e,"ResizeObserver"),e}();["observe","unobserve","disconnect"].forEach(function(e){tW.prototype[e]=function(){var t;return(t=tB.get(this))[e].apply(t,arguments)}});var tG="u">typeof tC.ResizeObserver?tC.ResizeObserver:tW,tY=/* @__PURE__ */new Map;function tz(e){e.forEach(function(e){var t,r=e.target;null===(t=tY.get(r))||void 0===t||t.forEach(function(e){return e(r)})})}A(tz,"onResize");var tK=new tG(tz);function tq(e,t){tY.has(e)||(tY.set(e,/* @__PURE__ */new Set),tK.observe(e)),tY.get(e).add(t)}function tX(e,t){tY.has(e)&&(tY.get(e).delete(t),tY.get(e).size||(tK.unobserve(e),tY.delete(e)))}function tZ(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function tQ(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,eN(n.key),n)}}function tJ(e,t,r){return t&&tQ(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function t0(e,t){return(t0=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function t1(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&t0(e,t)}function t3(e){return(t3=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function t2(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(t2=/* @__PURE__ */A(function(){return!!e},"_isNativeReflectConstruct"))()}function t4(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function t9(e,t){if(t&&("object"==eP(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return t4(e)}function t5(e){var t=t2();return function(){var r,n=t3(e);return r=t?Reflect.construct(n,arguments,t3(this).constructor):n.apply(this,arguments),t9(this,r)}}A(tq,"observe"),A(tX,"unobserve"),A(tZ,"_classCallCheck"),A(tQ,"_defineProperties"),A(tJ,"_createClass"),A(t0,"_setPrototypeOf"),A(t1,"_inherits"),A(t3,"_getPrototypeOf"),A(t2,"_isNativeReflectConstruct"),A(t4,"_assertThisInitialized"),A(t9,"_possibleConstructorReturn"),A(t5,"_createSuper");var t6=/* @__PURE__ */function(e){t1(r,e);var t=t5(r);function r(){return tZ(this,r),t.apply(this,arguments)}return A(r,"DomWrapper"),tJ(r,[{key:"render",value:/* @__PURE__ */A(function(){return this.props.children},"render")}]),r}(U.Component);function t8(e,t){var r=e.children,n=e.disabled,i=U.useRef(null),a=U.useRef(null),o=U.useContext(tv),s="function"==typeof r,l=s?r(i):r,d=U.useRef({width:-1,height:-1,offsetWidth:-1,offsetHeight:-1}),u=!s&&/* @__PURE__ */U.isValidElement(l)&&tf(l),c=tg(u?l.ref:null,i),h=/* @__PURE__ */A(function(){var e;return tc(i.current)||(i.current&&"object"===eP(i.current)?tc(null===(e=i.current)||void 0===e?void 0:e.nativeElement):null)||tc(a.current)},"getDom2");U.useImperativeHandle(t,function(){return h()});var m=U.useRef(e);m.current=e;var p=U.useCallback(function(e){var t=m.current,r=t.onResize,n=t.data,i=e.getBoundingClientRect(),a=i.width,s=i.height,l=e.offsetWidth,u=e.offsetHeight,c=Math.floor(a),h=Math.floor(s);if(d.current.width!==c||d.current.height!==h||d.current.offsetWidth!==l||d.current.offsetHeight!==u){var p={width:c,height:h,offsetWidth:l,offsetHeight:u};d.current=p;var g=l===Math.round(a)?a:l,f=u===Math.round(s)?s:u,v=eL(eL({},p),{},{offsetWidth:g,offsetHeight:f});null==o||o(v,e,n),r&&Promise.resolve().then(function(){r(v,e)})}},[]);return U.useEffect(function(){var e=h();return e&&!n&&tq(e,p),function(){return tX(e,p)}},[i.current,n]),/* @__PURE__ */U.createElement(t6,{ref:a},u?/* @__PURE__ */U.cloneElement(l,{ref:c}):l)}A(t8,"SingleObserver");var t7=/* @__PURE__ */U.forwardRef(t8);function re(e,t){var r=e.children;return("function"==typeof r?[r]:tl(r)).map(function(r,n){var i=(null==r?void 0:r.key)||"".concat("rc-observer-key","-").concat(n);return /* @__PURE__ */U.createElement(t7,eU({},e,{key:i,ref:0===n?t:void 0}),r)})}A(re,"ResizeObserver");var rt=/* @__PURE__ */U.forwardRef(re);function rr(e){var t=U.useRef();return t.current=e,U.useCallback(function(){for(var e,r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];return null===(e=t.current)||void 0===e?void 0:e.call.apply(e,[t].concat(n))},[])}function rn(){return!!("u">typeof window&&window.document&&window.document.createElement)}rt.Collection=t_,A(rr,"useEvent"),A(rn,"canUseDom");var ri=rn()?U.useLayoutEffect:U.useEffect,ra=/* @__PURE__ */A(function(e,t){var r=U.useRef(!0);ri(function(){return e(r.current)},t),ri(function(){return r.current=!1,function(){r.current=!0}},[])},"useLayoutEffect2"),ro=/* @__PURE__ */U.forwardRef(function(e,t){var r=e.height,n=e.offsetY,i=e.offsetX,a=e.children,o=e.prefixCls,s=e.onInnerResize,l=e.innerProps,d=e.rtl,u=e.extra,c={},h={display:"flex",flexDirection:"column"};return void 0!==n&&(c={height:r,position:"relative",overflow:"hidden"},h=eL(eL({},h),{},eA(eA(eA(eA(eA({transform:"translateY(".concat(n,"px)")},d?"marginRight":"marginLeft",-i),"position","absolute"),"left",0),"right",0),"top",0))),/* @__PURE__ */U.createElement("div",{style:c},/* @__PURE__ */U.createElement(rt,{onResize:/* @__PURE__ */A(function(e){e.offsetHeight&&s&&s()},"onResize")},/* @__PURE__ */U.createElement("div",eU({style:h,className:eK(eA({},"".concat(o,"-holder-inner"),o)),ref:t},l),a,u)))});function rs(e){var t=e.children,r=e.setRef,n=U.useCallback(function(e){r(e)},[]);return /* @__PURE__ */U.cloneElement(t,{ref:n})}function rl(e,t,r,n,i,a,o,s){var l=s.getKey;return e.slice(t,r+1).map(function(e,r){var s=o(e,t+r,{style:{width:n},offsetX:i}),d=l(e);return /* @__PURE__ */U.createElement(rs,{key:d,setRef:/* @__PURE__ */A(function(t){return a(e,t)},"setRef")},s)})}function rd(e,t,r){var n,i,a=e.length,o=t.length;if(0===a&&0===o)return null;a<o?(n=e,i=t):(n=t,i=e);var s={__EMPTY_ITEM__:!0};function l(e){return void 0!==e?r(e):s}A(l,"getItemKey");for(var d=null,u=1!==Math.abs(a-o),c=0;c<i.length;c+=1){var h=l(n[c]);if(h!==l(i[c])){d=c,u=u||h!==l(i[c+1]);break}}return null===d?null:{index:d,multiple:u}}function ru(e,t,r){var n=eB(U.useState(e),2),i=n[0],a=n[1],o=eB(U.useState(null),2),s=o[0],l=o[1];return U.useEffect(function(){var r=rd(i||[],e||[],t);(null==r?void 0:r.index)!==void 0&&l(e[r.index]),a(e)},[e]),[s]}ro.displayName="Filler",A(rs,"Item"),A(rl,"useChildren"),A(rd,"findListDiffIndex"),A(ru,"useDiffItem");var rc=/* @__PURE__ */A(function(e){return+setTimeout(e,16)},"raf2"),rh=/* @__PURE__ */A(function(e){return clearTimeout(e)},"caf2");"u">typeof window&&"requestAnimationFrame"in window&&(rc=/* @__PURE__ */A(function(e){return window.requestAnimationFrame(e)},"raf3"),rh=/* @__PURE__ */A(function(e){return window.cancelAnimationFrame(e)},"caf3"));var rm=0,rp=/* @__PURE__ */new Map;function rg(e){rp.delete(e)}A(rg,"cleanup");var rf=/* @__PURE__ */A(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=rm+=1;function n(t){if(0===t)rg(r),e();else{var i=rc(function(){n(t-1)});rp.set(r,i)}}return A(n,"callRef"),n(t),r},"wrapperRaf2");rf.cancel=function(e){var t=rp.get(e);return rg(e),rh(t)};var rv=(typeof navigator>"u"?"undefined":eP(navigator))==="object"&&/Firefox/i.test(navigator.userAgent);let r_=/* @__PURE__ */A(function(e,t,r,n){var i=(0,U.useRef)(!1),a=(0,U.useRef)(null);function o(){clearTimeout(a.current),i.current=!0,a.current=setTimeout(function(){i.current=!1},50)}A(o,"lockScroll");var s=(0,U.useRef)({top:e,bottom:t,left:r,right:n});return s.current.top=e,s.current.bottom=t,s.current.left=r,s.current.right=n,function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=e?t<0&&s.current.left||t>0&&s.current.right:t<0&&s.current.top||t>0&&s.current.bottom;return r&&n?(clearTimeout(a.current),i.current=!1):(!n||i.current)&&o(),!i.current&&n}},"useOriginScroll");function rI(e,t,r,n,i,a,o){var s=(0,U.useRef)(0),l=(0,U.useRef)(null),d=(0,U.useRef)(null),u=(0,U.useRef)(!1),c=r_(t,r,n,i);function h(e,t){rf.cancel(l.current),s.current+=t,d.current=t,c(!1,t)||(rv||e.preventDefault(),l.current=rf(function(){var e=u.current?10:1;o(s.current*e),s.current=0}))}function m(e,t){o(t,!0),rv||e.preventDefault()}A(h,"onWheelY"),A(m,"onWheelX");var p=(0,U.useRef)(null),g=(0,U.useRef)(null);function f(t){if(e){rf.cancel(g.current),g.current=rf(function(){p.current=null},2);var r=t.deltaX,n=t.deltaY,i=t.shiftKey,o=r,s=n;("sx"===p.current||!p.current&&i&&n&&!r)&&(o=n,s=0,p.current="sx");var l=Math.abs(o),d=Math.abs(s);null===p.current&&(p.current=a&&l>d?"x":"y"),"y"===p.current?h(t,s):m(t,o)}}function v(t){e&&(u.current=t.detail===d.current)}return A(f,"onWheel"),A(v,"onFireFoxScroll"),[f,v]}function rS(e,t,r,n){var i=eB(U.useMemo(function(){return[/* @__PURE__ */new Map,[]]},[e,r.id,n]),2),a=i[0],o=i[1];return /* @__PURE__ */A(function(i){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i,l=a.get(i),d=a.get(s);if(void 0===l||void 0===d)for(var u=e.length,c=o.length;c<u;c+=1){var h,m=t(e[c]);a.set(m,c);var p=null!==(h=r.get(m))&&void 0!==h?h:n;if(o[c]=(o[c-1]||0)+p,m===i&&(l=c),m===s&&(d=c),void 0!==l&&void 0!==d)break}return{top:o[l-1]||0,bottom:o[d]}},"getSize")}A(rI,"useFrameWheel"),A(rS,"useGetSize");var rC=/* @__PURE__ */function(){function e(){tZ(this,e),eA(this,"maps",void 0),eA(this,"id",0),this.maps=/* @__PURE__ */Object.create(null)}return A(e,"CacheMap"),tJ(e,[{key:"set",value:/* @__PURE__ */A(function(e,t){this.maps[e]=t,this.id+=1},"set")},{key:"get",value:/* @__PURE__ */A(function(e){return this.maps[e]},"get")}]),e}();function ry(e,t,r){var n=eB(U.useState(0),2),i=n[0],a=n[1],o=(0,U.useRef)(/* @__PURE__ */new Map),s=(0,U.useRef)(new rC),l=(0,U.useRef)();function d(){rf.cancel(l.current)}function u(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];d();var t=/* @__PURE__ */A(function(){o.current.forEach(function(e,t){if(e&&e.offsetParent){var r=tc(e),n=r.offsetHeight;s.current.get(t)!==n&&s.current.set(t,r.offsetHeight)}}),a(function(e){return e+1})},"doCollect");e?t():l.current=rf(t)}function c(t,r){var n=e(t);o.current.get(n),r?(o.current.set(n,r),u()):o.current.delete(n)}return A(d,"cancelRaf"),A(u,"collectHeight"),A(c,"setInstanceRef"),(0,U.useEffect)(function(){return d},[]),[c,u,s.current,i]}A(ry,"useHeights");var rb=14/15;function rw(e,t,r){var n,i=(0,U.useRef)(!1),a=(0,U.useRef)(0),o=(0,U.useRef)(0),s=(0,U.useRef)(null),l=(0,U.useRef)(null),d=/* @__PURE__ */A(function(e){if(i.current){var t=Math.ceil(e.touches[0].pageX),n=Math.ceil(e.touches[0].pageY),s=a.current-t,d=o.current-n,u=Math.abs(s)>Math.abs(d);u?a.current=t:o.current=n,r(u,u?s:d)&&e.preventDefault(),clearInterval(l.current),l.current=setInterval(function(){u?s*=rb:d*=rb;var e=Math.floor(u?s:d);(!r(u,e,!0)||.1>=Math.abs(e))&&clearInterval(l.current)},16)}},"onTouchMove"),u=/* @__PURE__ */A(function(){i.current=!1,n()},"onTouchEnd"),c=/* @__PURE__ */A(function(e){n(),1!==e.touches.length||i.current||(i.current=!0,a.current=Math.ceil(e.touches[0].pageX),o.current=Math.ceil(e.touches[0].pageY),s.current=e.target,s.current.addEventListener("touchmove",d,{passive:!1}),s.current.addEventListener("touchend",u,{passive:!0}))},"onTouchStart");n=/* @__PURE__ */A(function(){s.current&&(s.current.removeEventListener("touchmove",d),s.current.removeEventListener("touchend",u))},"cleanUpEvents"),ra(function(){return e&&t.current.addEventListener("touchstart",c,{passive:!0}),function(){var e;null===(e=t.current)||void 0===e||e.removeEventListener("touchstart",c),n(),clearInterval(l.current)}},[e])}function rR(e,t,r,n,i,a,o,s){var l=U.useRef(),d=eB(U.useState(null),2),u=d[0],c=d[1];return ra(function(){if(u&&u.times<10){if(!e.current){c(function(e){return eL({},e)});return}a();var s=u.targetAlign,l=u.originAlign,d=u.index,h=u.offset,m=e.current.clientHeight,p=!1,g=s,f=null;if(m){for(var v=s||l,_=0,I=0,S=0,C=Math.min(t.length-1,d),y=0;y<=C;y+=1){var b=i(t[y]);I=_;var w=r.get(b);_=S=I+(void 0===w?n:w)}for(var R="top"===v?h:m-h,E=C;E>=0;E-=1){var T=i(t[E]),M=r.get(T);if(void 0===M){p=!0;break}if((R-=M)<=0)break}switch(v){case"top":f=I-h;break;case"bottom":f=S-m+h;break;default:var O=e.current.scrollTop;I<O?g="top":S>O+m&&(g="bottom")}null!==f&&o(f),f!==u.lastTop&&(p=!0)}p&&c(eL(eL({},u),{},{times:u.times+1,targetAlign:g,lastTop:f}))}},[u,e.current]),function(e){if(null==e){s();return}if(rf.cancel(l.current),"number"==typeof e)o(e);else if(e&&"object"===eP(e)){var r,n=e.align;r="index"in e?e.index:t.findIndex(function(t){return i(t)===e.key});var a=e.offset;c({times:0,index:r,offset:void 0===a?0:a,originAlign:n})}}}function rE(e,t){return("touches"in e?e.touches[0]:e)[t?"pageX":"pageY"]}A(rw,"useMobileTouchMove"),A(rR,"useScrollTo"),A(rE,"getPageXY");var rT=/* @__PURE__ */U.forwardRef(function(e,t){var r=e.prefixCls,n=e.rtl,i=e.scrollOffset,a=e.scrollRange,o=e.onStartMove,s=e.onStopMove,l=e.onScroll,d=e.horizontal,u=e.spinSize,c=e.containerSize,h=e.style,m=e.thumbStyle,p=eB(U.useState(!1),2),g=p[0],f=p[1],v=eB(U.useState(null),2),_=v[0],I=v[1],S=eB(U.useState(null),2),C=S[0],y=S[1],b=!n,w=U.useRef(),R=U.useRef(),E=eB(U.useState(!1),2),T=E[0],M=E[1],O=U.useRef(),D=/* @__PURE__ */A(function(){clearTimeout(O.current),M(!0),O.current=setTimeout(function(){M(!1)},3e3)},"delayHidden2"),P=a-c||0,k=c-u||0,N=U.useMemo(function(){return 0===i||0===P?0:i/P*k},[i,P,k]),x=/* @__PURE__ */A(function(e){e.stopPropagation(),e.preventDefault()},"onContainerMouseDown2"),L=U.useRef({top:N,dragging:g,pageY:_,startTop:C});L.current={top:N,dragging:g,pageY:_,startTop:C};var V=/* @__PURE__ */A(function(e){f(!0),I(rE(e,d)),y(L.current.top),o(),e.stopPropagation(),e.preventDefault()},"onThumbMouseDown2");U.useEffect(function(){var e=/* @__PURE__ */A(function(e){e.preventDefault()},"onScrollbarTouchStart2"),t=w.current,r=R.current;return t.addEventListener("touchstart",e,{passive:!1}),r.addEventListener("touchstart",V,{passive:!1}),function(){t.removeEventListener("touchstart",e),r.removeEventListener("touchstart",V)}},[]);var F=U.useRef();F.current=P;var j=U.useRef();j.current=k,U.useEffect(function(){if(g){var e,t=/* @__PURE__ */A(function(t){var r=L.current,n=r.dragging,i=r.pageY,a=r.startTop;rf.cancel(e);var o=w.current.getBoundingClientRect(),s=c/(d?o.width:o.height);if(n){var u=(rE(t,d)-i)*s,h=a;!b&&d?h-=u:h+=u;var m=F.current,p=j.current,g=Math.ceil((p?h/p:0)*m);g=Math.min(g=Math.max(g,0),m),e=rf(function(){l(g,d)})}},"onMouseMove2"),r=/* @__PURE__ */A(function(){f(!1),s()},"onMouseUp2");return window.addEventListener("mousemove",t,{passive:!0}),window.addEventListener("touchmove",t,{passive:!0}),window.addEventListener("mouseup",r,{passive:!0}),window.addEventListener("touchend",r,{passive:!0}),function(){window.removeEventListener("mousemove",t),window.removeEventListener("touchmove",t),window.removeEventListener("mouseup",r),window.removeEventListener("touchend",r),rf.cancel(e)}}},[g]),U.useEffect(function(){return D(),function(){clearTimeout(O.current)}},[i]),U.useImperativeHandle(t,function(){return{delayHidden:D}});var H="".concat(r,"-scrollbar"),$={position:"absolute",visibility:T?null:"hidden"},B={position:"absolute",background:"rgba(0, 0, 0, 0.5)",borderRadius:99,cursor:"pointer",userSelect:"none"};return d?($.height=8,$.left=0,$.right=0,$.bottom=0,B.height="100%",B.width=u,b?B.left=N:B.right=N):($.width=8,$.top=0,$.bottom=0,b?$.right=0:$.left=0,B.width="100%",B.height=u,B.top=N),/* @__PURE__ */U.createElement("div",{ref:w,className:eK(H,eA(eA(eA({},"".concat(H,"-horizontal"),d),"".concat(H,"-vertical"),!d),"".concat(H,"-visible"),T)),style:eL(eL({},$),h),onMouseDown:x,onMouseMove:D},/* @__PURE__ */U.createElement("div",{ref:R,className:eK("".concat(H,"-thumb"),eA({},"".concat(H,"-thumb-moving"),g)),style:eL(eL({},B),m),onMouseDown:V}))});function rM(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e/t*e;return isNaN(r)&&(r=0),Math.floor(r=Math.max(r,20))}A(rM,"getSpinSize");var rO=["prefixCls","className","height","itemHeight","fullHeight","style","data","children","itemKey","virtual","direction","scrollWidth","component","onScroll","onVirtualScroll","onVisibleChange","innerProps","extraRender","styles"],rD=[],rU={overflowY:"auto",overflowAnchor:"none"};function rP(e,t){var r=e.prefixCls,n=void 0===r?"rc-virtual-list":r,i=e.className,a=e.height,o=e.itemHeight,s=e.fullHeight,l=e.style,d=e.data,u=e.children,c=e.itemKey,h=e.virtual,m=e.direction,p=e.scrollWidth,g=e.component,f=e.onScroll,v=e.onVirtualScroll,_=e.onVisibleChange,I=e.innerProps,S=e.extraRender,C=e.styles,y=eG(e,rO),b=U.useCallback(function(e){return"function"==typeof c?c(e):null==e?void 0:e[c]},[c]),w=eB(ry(b),4),R=w[0],E=w[1],T=w[2],M=w[3],O=!!(!1!==h&&a&&o),D=U.useMemo(function(){return Object.values(T.maps).reduce(function(e,t){return e+t},0)},[T.id,T.maps]),k=O&&d&&(Math.max(o*d.length,D)>a||!!p),N="rtl"===m,x=eK(n,eA({},"".concat(n,"-rtl"),N),i),L=d||rD,V=(0,U.useRef)(),F=(0,U.useRef)(),j=(0,U.useRef)(),H=eB((0,U.useState)(0),2),$=H[0],B=H[1],W=eB((0,U.useState)(0),2),G=W[0],Y=W[1],z=eB((0,U.useState)(!1),2),K=z[0],q=z[1],X=/* @__PURE__ */A(function(){q(!0)},"onScrollbarStartMove"),Z=/* @__PURE__ */A(function(){q(!1)},"onScrollbarStopMove");function Q(e){B(function(t){var r=ev("function"==typeof e?e(t):e);return V.current.scrollTop=r,r})}A(Q,"syncScrollTop");var J=(0,U.useRef)({start:0,end:L.length}),ee=(0,U.useRef)(),et=eB(ru(L,b),1)[0];ee.current=et;var er=U.useMemo(function(){if(!O)return{scrollHeight:void 0,start:0,end:L.length-1,offset:void 0};if(!k)return{scrollHeight:(null===(e=F.current)||void 0===e?void 0:e.offsetHeight)||0,start:0,end:L.length-1,offset:void 0};for(var e,t,r,n,i=0,s=L.length,l=0;l<s;l+=1){var d=b(L[l]),u=T.get(d),c=i+(void 0===u?o:u);c>=$&&void 0===t&&(t=l,r=i),c>$+a&&void 0===n&&(n=l),i=c}return void 0===t&&(t=0,r=0,n=Math.ceil(a/o)),void 0===n&&(n=L.length-1),{scrollHeight:i,start:t,end:n=Math.min(n+1,L.length-1),offset:r}},[k,O,$,L,M,a]),en=er.scrollHeight,ei=er.start,ea=er.end,eo=er.offset;J.current.start=ei,J.current.end=ea;var es=eB(U.useState({width:0,height:a}),2),el=es[0],ed=es[1],eu=/* @__PURE__ */A(function(e){ed({width:e.offsetWidth,height:e.offsetHeight})},"onHolderResize"),ec=(0,U.useRef)(),eh=(0,U.useRef)(),em=U.useMemo(function(){return rM(el.width,p)},[el.width,p]),ep=U.useMemo(function(){return rM(el.height,en)},[el.height,en]),eg=en-a,ef=(0,U.useRef)(eg);function ev(e){var t=e;return Number.isNaN(ef.current)||(t=Math.min(t,ef.current)),t=Math.max(t,0)}ef.current=eg,A(ev,"keepInRange");var e_=$<=0,eI=$>=eg,eS=G<=0,eC=G>=p,ey=r_(e_,eI,eS,eC),eb=/* @__PURE__ */A(function(){return{x:N?-G:G,y:$}},"getVirtualScrollInfo"),ew=(0,U.useRef)(eb()),eR=rr(function(e){if(v){var t=eL(eL({},eb()),e);(ew.current.x!==t.x||ew.current.y!==t.y)&&(v(t),ew.current=t)}});function eE(e,t){t?((0,P.flushSync)(function(){Y(e)}),eR()):Q(e)}function eT(e){var t=e.currentTarget.scrollTop;t!==$&&Q(t),null==f||f(e),eR()}A(eE,"onScrollBar"),A(eT,"onFallbackScroll");var eM=/* @__PURE__ */A(function(e){var t=e,r=p?p-el.width:0;return Math.min(t=Math.max(t,0),r)},"keepInHorizontalRange"),eO=eB(rI(O,e_,eI,eS,eC,!!p,rr(function(e,t){t?((0,P.flushSync)(function(){Y(function(t){return eM(t+(N?-e:e))})}),eR()):Q(function(t){return t+e})})),2),eD=eO[0],ek=eO[1];rw(O,V,function(e,t,r){return!ey(e,t,r)&&(eD({preventDefault:/* @__PURE__ */A(function(){},"preventDefault"),deltaX:e?t:0,deltaY:e?0:t}),!0)}),ra(function(){function e(e){O&&e.preventDefault()}A(e,"onMozMousePixelScroll");var t=V.current;return t.addEventListener("wheel",eD,{passive:!1}),t.addEventListener("DOMMouseScroll",ek,{passive:!0}),t.addEventListener("MozMousePixelScroll",e,{passive:!1}),function(){t.removeEventListener("wheel",eD),t.removeEventListener("DOMMouseScroll",ek),t.removeEventListener("MozMousePixelScroll",e)}},[O]),ra(function(){if(p){var e=eM(G);Y(e),eR({x:e})}},[el.width,p]);var eN=/* @__PURE__ */A(function(){var e,t;null===(e=ec.current)||void 0===e||e.delayHidden(),null===(t=eh.current)||void 0===t||t.delayHidden()},"delayHideScrollBar"),ex=rR(V,L,T,o,b,function(){return E(!0)},Q,eN);U.useImperativeHandle(t,function(){return{nativeElement:j.current,getScrollInfo:eb,scrollTo:/* @__PURE__ */A(function(e){function t(e){return e&&"object"===eP(e)&&("left"in e||"top"in e)}A(t,"isPosScroll"),t(e)?(void 0!==e.left&&Y(eM(e.left)),ex(e.top)):ex(e)},"scrollTo")}}),ra(function(){_&&_(L.slice(ei,ea+1),L)},[ei,ea,L]);var eV=rS(L,b,T,o),eF=null==S?void 0:S({start:ei,end:ea,virtual:k,offsetX:G,offsetY:eo,rtl:N,getSize:eV}),ej=rl(L,ei,ea,p,G,R,u,{getKey:b}),eH=null;a&&(eH=eL(eA({},void 0===s||s?"height":"maxHeight",a),rU),O&&(eH.overflowY="hidden",p&&(eH.overflowX="hidden"),K&&(eH.pointerEvents="none")));var e$={};return N&&(e$.dir="rtl"),/* @__PURE__ */U.createElement("div",eU({ref:j,style:eL(eL({},l),{},{position:"relative"}),className:x},e$,y),/* @__PURE__ */U.createElement(rt,{onResize:eu},/* @__PURE__ */U.createElement(void 0===g?"div":g,{className:"".concat(n,"-holder"),style:eH,ref:V,onScroll:eT,onMouseEnter:eN},/* @__PURE__ */U.createElement(ro,{prefixCls:n,height:en,offsetX:G,offsetY:eo,scrollWidth:p,onInnerResize:E,ref:F,innerProps:I,rtl:N,extra:eF},ej))),k&&en>a&&/* @__PURE__ */U.createElement(rT,{ref:ec,prefixCls:n,scrollOffset:$,scrollRange:en,rtl:N,onScroll:eE,onStartMove:X,onStopMove:Z,spinSize:ep,containerSize:el.height,style:null==C?void 0:C.verticalScrollBar,thumbStyle:null==C?void 0:C.verticalScrollBarThumb}),k&&p>el.width&&/* @__PURE__ */U.createElement(rT,{ref:eh,prefixCls:n,scrollOffset:G,scrollRange:p,rtl:N,onScroll:eE,onStartMove:X,onStopMove:Z,spinSize:em,containerSize:el.width,horizontal:!0,style:null==C?void 0:C.horizontalScrollBar,thumbStyle:null==C?void 0:C.horizontalScrollBarThumb}))}A(rP,"RawList");var rk=/* @__PURE__ */U.forwardRef(rP);function rN(e){let{model:r}=e,n=(0,d.useDependency)(d.LocaleService),i=(0,h.useObservable)(r.searchString$,"",!0),a=(0,h.useObservable)(r.filterItems$,void 0,!0),o=n.t("sheets-filter.panel.filter-only"),s=eo(a),l=s.checked>0&&0===s.unchecked,u=s.checked>0&&s.unchecked>0,c=(0,U.useCallback)((e,t)=>{r.onFilterCheckToggled(e,t)},[r]),m=(0,U.useCallback)(e=>{r.onFilterOnly(e)},[r]),p=(0,U.useCallback)(()=>{r.onCheckAllToggled(!l)},[r,l]),g=(0,U.useCallback)(e=>{r.setSearchString(e)},[r]);return /* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelValuesContainer},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Input,{value:i,placeholder:n.t("sheets-filter.panel.search-placeholder"),onChange:g}),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelValuesList},/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelValuesItem},/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelValuesItemInner},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Checkbox,{indeterminate:u,disabled:0===a.length,checked:l,onChange:p}),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:eT.sheetsFilterPanelValuesItemText},`${n.t("sheets-filter.panel.select-all")}`),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:eT.sheetsFilterPanelValuesItemCount},`(${s.checked}/${s.checked+s.unchecked})`))),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelValuesVirtual},/* @__PURE__ *//*@__PURE__*/t(U).createElement(rk,{style:{paddingRight:8},data:a,height:190,itemHeight:32,itemKey:/* @__PURE__ */A(e=>`${e.value}----${e.checked}`,"itemKey")},e=>/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelValuesItem},/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelValuesItemInner},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Checkbox,{checked:e.checked,onChange:/* @__PURE__ */A(()=>c(e,!e.checked),"onChange")}),/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Tooltip,{showIfEllipsis:!0,placement:"top",title:e.value},/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:eT.sheetsFilterPanelValuesItemText},e.value)),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:eT.sheetsFilterPanelValuesItemCount},`(${e.count})`),/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Button,{className:eT.sheetsFilterPanelValuesItemExcludeButton,size:"small",type:"link",onClick:/* @__PURE__ */A(()=>m(e),"onClick")},o)))))))}function rA(){var e;let r=(0,d.useDependency)(eS),n=(0,d.useDependency)(d.LocaleService),i=(0,d.useDependency)(d.ICommandService),a=(0,h.useObservable)(r.filterBy$,void 0,!0),o=(0,h.useObservable)(r.filterByModel$,void 0,!1),s=(0,h.useObservable)(()=>(null==o?void 0:o.canApply$)||(0,I.of)(!1),void 0,!1,[o]),l=rx(n),c=!(0,h.useObservable)(r.hasCriteria$),m=(0,U.useCallback)(e=>{i.executeCommand(eE.id,{filterBy:e})},[i]),p=(0,U.useCallback)(async()=>{await (null==o?void 0:o.clear()),i.executeCommand(eR.id)},[o,i]),g=(0,U.useCallback)(()=>{i.executeCommand(eR.id)},[i]),f=(0,U.useCallback)(async()=>{await (null==o?void 0:o.apply()),i.executeCommand(eR.id)},[o,i]),v=null==(e=(0,d.useDependency)(u.SheetsFilterService).activeFilterModel)?void 0:e.getRange(),_=r.col,S=(0,h.useComponentsOfPart)(T.SheetsUIPart.FILTER_PANEL_EMBED_POINT);return /* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanel},/* @__PURE__ *//*@__PURE__*/t(U).createElement(h.ComponentContainer,{components:S,sharedProps:{range:v,colIndex:_,onClose:g}}),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelHeader},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Segmented,{value:a,options:l,onChange:/* @__PURE__ */A(e=>m(e),"onChange")})),o?/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelContent},a===eI.VALUES?/* @__PURE__ *//*@__PURE__*/t(U).createElement(rN,{model:o}):/* @__PURE__ *//*@__PURE__*/t(U).createElement(eM,{model:o})):null,/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:eT.sheetsFilterPanelFooter},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Button,{type:"link",onClick:p,disabled:c},n.t("sheets-filter.panel.clear-filter")),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:eT.sheetsFilterPanelFooterPrimaryButtons},/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Button,{type:"default",onClick:g},n.t("sheets-filter.panel.cancel")),/* @__PURE__ *//*@__PURE__*/t(U).createElement(O.Button,{disabled:!s,type:"primary",onClick:f},n.t("sheets-filter.panel.confirm")))))}function rx(e){let t=e.getCurrentLocale();return(0,U.useMemo)(()=>[{label:e.t("sheets-filter.panel.by-values"),value:eI.VALUES},{label:e.t("sheets-filter.panel.by-conditions"),value:eI.CONDITIONS}],[t,e])}rk.displayName="List",A(rN,"FilterByValue"),A(rA,"FilterPanel"),A(rx,"useFilterByOptions");let rL={id:K.id,binding:h.KeyCode.L|h.MetaKeys.CTRL_COMMAND|h.MetaKeys.SHIFT,description:"sheets-filter.shortcut.smart-toggle-filter",preconditions:T.whenSheetEditorFocused,group:"4_sheet-edit"},rV=new Path2D("M3.30363 3C2.79117 3 2.51457 3.60097 2.84788 3.99024L6.8 8.60593V12.5662C6.8 12.7184 6.8864 12.8575 7.02289 12.9249L8.76717 13.7863C8.96655 13.8847 9.2 13.7396 9.2 13.5173V8.60593L13.1521 3.99024C13.4854 3.60097 13.2088 3 12.6964 3H3.30363Z"),rF=class{static drawNoCriteria(e,t,r,n){e.save(),(0,M.Rect).drawWith(e,{radius:2,width:16,height:16,fill:n}),e.lineCap="square",e.strokeStyle=r,e.scale(t/16,t/16),e.beginPath(),e.lineWidth=1,e.lineCap="round",e.moveTo(3,4),e.lineTo(13,4),e.moveTo(4.5,8),e.lineTo(11.5,8),e.moveTo(6,12),e.lineTo(10,12),e.stroke(),e.restore()}static drawHasCriteria(e,t,r,n){e.save(),(0,M.Rect).drawWith(e,{radius:2,width:16,height:16,fill:n}),e.scale(t/16,t/16),e.fillStyle=r,e.fill(rV),e.restore()}};A(rF,"FilterButton");var rj=Object.defineProperty,rH=Object.getOwnPropertyDescriptor,r$=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?rH(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&rj(t,r,a),a},"__decorateClass$7"),rB=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let rW=(A(rX=class extends M.Shape{constructor(e,t,r,n,i){super(e,t),x(this,"_cellWidth",0),x(this,"_cellHeight",0),x(this,"_filterParams"),x(this,"_hovered",!1),this._contextService=r,this._commandService=n,this._themeService=i,this.setShapeProps(t),this.onPointerDown$.subscribeEvent(e=>this.onPointerDown(e)),this.onPointerEnter$.subscribeEvent(()=>this.onPointerEnter()),this.onPointerLeave$.subscribeEvent(()=>this.onPointerLeave())}setShapeProps(e){"u">typeof e.cellHeight&&(this._cellHeight=e.cellHeight),"u">typeof e.cellWidth&&(this._cellWidth=e.cellWidth),"u">typeof e.filterParams&&(this._filterParams=e.filterParams),this.transformByState({width:e.width,height:e.height})}_draw(e){let t=this._cellHeight,r=this._cellWidth;e.save();let n=new Path2D;n.rect(16-r,16-t,r,t),e.clip(n);let{hasCriteria:i}=this._filterParams,a=this._themeService.getCurrentTheme().primaryColor,o=this._hovered?this._themeService.getCurrentTheme().grey50:"rgba(255, 255, 255, 1.0)";i?rF.drawHasCriteria(e,16,a,o):rF.drawNoCriteria(e,16,a,o),e.restore()}onPointerDown(e){if(2===e.button)return;let{col:t,unitId:r,subUnitId:n}=this._filterParams;this._contextService.getContextValue(eb)||!this._commandService.hasCommand(ew.id)||setTimeout(()=>{this._commandService.executeCommand(ew.id,{unitId:r,subUnitId:n,col:t})},200)}onPointerEnter(){this._hovered=!0,this.makeDirty(!0)}onPointerLeave(){this._hovered=!1,this.makeDirty(!0)}},"SheetsFilterButtonShape"),rX);rW=r$([rB(2,d.IContextService),rB(3,d.ICommandService),rB(4,(0,d.Inject)(d.ThemeService))],rW);var rG=Object.defineProperty,rY=Object.getOwnPropertyDescriptor,rz=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?rY(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&rG(t,r,a),a},"__decorateClass$6"),rK=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let rq=(rZ=class extends d.RxDisposable{constructor(e,t,r,n,i,a,o,s){super(),x(this,"_filterRangeShape",null),x(this,"_buttonRenderDisposable",null),x(this,"_filterButtonShapes",[]),this._context=e,this._injector=t,this._sheetSkeletonManagerService=r,this._sheetsFilterService=n,this._themeService=i,this._sheetInterceptorService=a,this._commandService=o,this._selectionRenderService=s,this._initRenderer()}dispose(){super.dispose(),this._disposeRendering()}_initRenderer(){this._sheetSkeletonManagerService.currentSkeleton$.pipe((0,w.switchMap)(e=>{var t,r;if(!e)return(0,I.of)(null);let{unit:n,unitId:i}=this._context,a=(null==(t=n.getActiveSheet())?void 0:t.getSheetId())||"",o=null!=(r=this._sheetsFilterService.getFilterModel(i,a))?r:void 0,s=/* @__PURE__ */A(()=>({unitId:i,worksheetId:a,filterModel:o,range:null==o?void 0:o.getRange(),skeleton:e.skeleton}),"getParams");return(0,d.fromCallback)(this._commandService.onCommandExecuted.bind(this._commandService)).pipe((0,f.filter)(([e])=>e.type===d.CommandType.MUTATION&&e.params.unitId===n.getUnitId()&&(0,u.FILTER_MUTATIONS).has(e.id)),(0,E.throttleTime)(20,void 0,{leading:!1,trailing:!0}),(0,v.map)(s),(0,y.startWith)(s()))}),(0,R.takeUntil)(this.dispose$)).subscribe(e=>{this._disposeRendering(),e&&e.range&&(this._renderRange(e.range,e.skeleton),this._renderButtons(e))})}_renderRange(e,t){let{scene:r}=this._context,{rangeWithCoord:n,style:i}=this._selectionRenderService.attachSelectionWithCoord({range:e,primary:null,style:null}),{rowHeaderWidth:a,columnHeaderHeight:o}=t,s=this._filterRangeShape=new T.SelectionShape(r,1e3,this._themeService,!0);s.update(n,a,o,{hasAutoFill:!1,fill:"rgba(0, 0, 0, 0.0)",...i}),s.setEvent(!1),r.makeDirty(!0)}_renderButtons(e){let{range:t,filterModel:r,unitId:n,skeleton:i,worksheetId:a}=e,{scene:o}=this._context;this._interceptCellContent(n,a,e.range);let{startColumn:s,endColumn:l,startRow:d}=t;for(let e=s;e<=l;e++){let t=`sheets-filter-button-${e}`,{startX:s,startY:l,endX:u,endY:c}=(0,T.getCoordByCell)(d,e,o,i),h=u-s,m=c-l;if(m<=1||h<=1)continue;let p=!!r.getFilterColumn(e),g={left:u-16-1,top:c-16-1,height:16,width:16,zIndex:5e3,cellHeight:m,cellWidth:h,filterParams:{unitId:n,subUnitId:a,col:e,hasCriteria:p}},f=this._injector.createInstance(rW,t,g);this._filterButtonShapes.push(f)}o.addObjects(this._filterButtonShapes),o.makeDirty()}_interceptCellContent(e,t,r){let{startRow:n,startColumn:i,endColumn:a}=r;this._buttonRenderDisposable=this._sheetInterceptorService.intercept(D.INTERCEPTOR_POINT.CELL_CONTENT,{handler:/* @__PURE__ */A((r,o,s)=>{let{row:l,col:d,unitId:u,subUnitId:c}=o;return s(u!==e||c!==t||l!==n||d<i||d>a?r:{...r,fontRenderExtension:{...null==r?void 0:r.fontRenderExtension,rightOffset:16}})},"handler"),priority:10})}_disposeRendering(){var e,t;null==(e=this._filterRangeShape)||e.dispose(),this._filterButtonShapes.forEach(e=>e.dispose()),null==(t=this._buttonRenderDisposable)||t.dispose(),this._filterRangeShape=null,this._buttonRenderDisposable=null,this._filterButtonShapes=[]}},A(rZ,"SheetsFilterRenderController"),rZ);rq=rz([rK(1,(0,d.Inject)(d.Injector)),rK(2,(0,d.Inject)(T.SheetSkeletonManagerService)),rK(3,(0,d.Inject)(u.SheetsFilterService)),rK(4,(0,d.Inject)(d.ThemeService)),rK(5,(0,d.Inject)(D.SheetInterceptorService)),rK(6,d.ICommandService),rK(7,T.ISheetSelectionRenderService)],rq);var rX,rZ,rQ,rJ=Object.defineProperty,r0=Object.getOwnPropertyDescriptor,r1=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?r0(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&rJ(t,r,a),a},"__decorateClass$5"),r3=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let r2=(A(rQ=class extends d.RxDisposable{constructor(e,t){super(),this._renderManagerService=e,this._sheetsRenderService=t,[(0,u.SetSheetsFilterRangeMutation),(0,u.SetSheetsFilterCriteriaMutation),(0,u.RemoveSheetsFilterMutation),(0,u.ReCalcSheetsFilterMutation)].forEach(e=>this.disposeWithMe(this._sheetsRenderService.registerSkeletonChangingMutations(e.id))),this.disposeWithMe(this._renderManagerService.registerRenderModule(d.UniverInstanceType.UNIVER_SHEET,[rq]))}},"SheetsFilterUIMobileController"),rQ);function r4(e){let t=e.get(u.SheetsFilterService);return{id:K.id,type:h.MenuItemType.BUTTON_SELECTOR,icon:"FilterSingle",tooltip:"sheets-filter.toolbar.smart-toggle-filter-tooltip",hidden$:(0,h.getMenuHiddenObservable)(e,d.UniverInstanceType.UNIVER_SHEET),activated$:t.activeFilterModel$.pipe((0,v.map)(e=>!!e)),disabled$:(0,T.getObservableWithExclusiveRange$)(e,(0,T.getCurrentRangeDisable$)(e,{worksheetTypes:[D.WorksheetFilterPermission,D.WorksheetViewPermission],rangeTypes:[D.RangeProtectionPermissionViewPoint]}))}}function r9(e){let t=e.get(u.SheetsFilterService);return{id:X.id,type:h.MenuItemType.BUTTON,title:"sheets-filter.toolbar.clear-filter-criteria",hidden$:(0,h.getMenuHiddenObservable)(e,d.UniverInstanceType.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe((0,w.switchMap)(e=>{var t;return null!=(t=null==e?void 0:e.hasCriteria$.pipe((0,v.map)(e=>!e)))?t:(0,I.of)(!0)}))}}function r5(e){let t=e.get(u.SheetsFilterService);return{id:Z.id,type:h.MenuItemType.BUTTON,title:"sheets-filter.toolbar.re-calc-filter-conditions",hidden$:(0,h.getMenuHiddenObservable)(e,d.UniverInstanceType.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe((0,w.switchMap)(e=>{var t;return null!=(t=null==e?void 0:e.hasCriteria$.pipe((0,v.map)(e=>!e)))?t:(0,I.of)(!0)}))}}r2=r1([r3(0,M.IRenderManagerService),r3(1,(0,d.Inject)(T.SheetsRenderService))],r2),A(r4,"SmartToggleFilterMenuItemFactory"),A(r9,"ClearFilterCriteriaMenuItemFactory"),A(r5,"ReCalcFilterMenuItemFactory");let r6={[h.RibbonStartGroup.FORMULAS_INSERT]:{[K.id]:{order:10,menuItemFactory:r4,[X.id]:{order:0,menuItemFactory:r9},[Z.id]:{order:1,menuItemFactory:r5}}}};var r8=Object.defineProperty,r7=Object.getOwnPropertyDescriptor,ne=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?r7(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&r8(t,r,a),a},"__decorateClass$4"),nt=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let nr="FILTER_PANEL_POPUP",nn=(ni=class extends r2{constructor(e,t,r,n,i,a,o,s,l,d,u,c,h){super(h,c),x(this,"_popupDisposable"),this._injector=e,this._componentManager=t,this._sheetsFilterPanelService=r,this._sheetCanvasPopupService=n,this._sheetsFilterService=i,this._localeService=a,this._shortcutService=o,this._commandService=s,this._menuManagerService=l,this._contextService=d,this._messageService=u,this._initCommands(),this._initShortcuts(),this._initMenuItems(),this._initUI()}dispose(){super.dispose(),this._closeFilterPopup()}_initShortcuts(){[rL].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_initCommands(){[K,z,Y,q,X,Z,eE,ew,eR].forEach(e=>{this.disposeWithMe(this._commandService.registerCommand(e))})}_initMenuItems(){this._menuManagerService.mergeMenu(r6)}_initUI(){this.disposeWithMe(this._componentManager.register(nr,rA)),this.disposeWithMe(this._componentManager.register("FilterSingle",G)),this.disposeWithMe(this._contextService.subscribeContextValue$(eb).pipe((0,g.distinctUntilChanged)()).subscribe(e=>{e?this._openFilterPopup():this._closeFilterPopup()})),this.disposeWithMe(this._sheetsFilterService.errorMsg$.subscribe(e=>{e&&this._messageService.show({type:O.MessageType.Error,content:this._localeService.t(e)})}))}_openFilterPopup(){let e=this._sheetsFilterPanelService.filterModel;if(!e)throw Error("[SheetsFilterUIController]: no filter model when opening filter popup!");let t=e.getRange(),r=this._sheetsFilterPanelService.col,{startRow:n}=t;this._popupDisposable=this._sheetCanvasPopupService.attachPopupToCell(n,r,{componentKey:nr,direction:"horizontal",onClickOutside:/* @__PURE__ */A(()=>this._commandService.syncExecuteCommand(eR.id),"onClickOutside"),offset:[5,0]})}_closeFilterPopup(){var e;null==(e=this._popupDisposable)||e.dispose(),this._popupDisposable=null}},A(ni,"SheetsFilterUIDesktopController"),ni);nn=ne([nt(0,(0,d.Inject)(d.Injector)),nt(1,(0,d.Inject)(h.ComponentManager)),nt(2,(0,d.Inject)(eS)),nt(3,(0,d.Inject)(T.SheetCanvasPopManagerService)),nt(4,(0,d.Inject)(u.SheetsFilterService)),nt(5,(0,d.Inject)(d.LocaleService)),nt(6,h.IShortcutService),nt(7,d.ICommandService),nt(8,h.IMenuManagerService),nt(9,d.IContextService),nt(10,h.IMessageService),nt(11,(0,d.Inject)(T.SheetsRenderService)),nt(12,M.IRenderManagerService)],nn);var ni,na,no=Object.defineProperty,ns=Object.getOwnPropertyDescriptor,nl=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ns(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&no(t,r,a),a},"__decorateClass$3"),nd=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let nu=(A(na=class extends d.Disposable{constructor(e,t,r,n,i,a){super(),this._sheetsFilterService=e,this._localeService=t,this._commandService=r,this._sheetPermissionInterceptorBaseController=n,this._injector=i,this._sheetsSelectionService=a,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{var t,r,n;if(e.id===K.id){let e;let n=this._injector.get(d.IUniverInstanceService),i=(0,D.getSheetCommandTarget)(n);if(!i)return;let{unitId:a,subUnitId:o,worksheet:s}=i,l=null==(t=this._sheetsFilterService.getFilterModel(a,o))?void 0:t.getRange();if(l)e=this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({rangeTypes:[D.RangeProtectionPermissionViewPoint],worksheetTypes:[D.WorksheetFilterPermission,D.WorksheetViewPermission]},[l]);else{let t=null==(r=this._sheetsSelectionService.getCurrentLastSelection())?void 0:r.range;if(t){let r={...t};r=t.startColumn===t.endColumn&&t.startRow===t.endRow?(0,D.expandToContinuousRange)(r,{left:!0,right:!0,up:!0,down:!0},s):r,e=this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({rangeTypes:[D.RangeProtectionPermissionViewPoint],worksheetTypes:[D.WorksheetViewPermission,D.WorksheetFilterPermission]},[r],a,o)}else e=this._sheetPermissionInterceptorBaseController.permissionCheckWithoutRange({rangeTypes:[D.RangeProtectionPermissionViewPoint],worksheetTypes:[D.WorksheetViewPermission,D.WorksheetFilterPermission]})}e||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.filterErr"))}if(e.id===ew.id){let t=e.params,{unitId:r,subUnitId:i}=t,a=null==(n=this._sheetsFilterService.getFilterModel(r,i))?void 0:n.getRange(),o=(0,d.Tools).deepClone(a);o&&(o.startColumn=t.col,o.endColumn=t.col,this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({rangeTypes:[D.RangeProtectionPermissionViewPoint],worksheetTypes:[D.WorksheetFilterPermission,D.WorksheetViewPermission]},[o])||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.filterErr")))}}))}},"SheetsFilterPermissionController"),na);nu=nl([nd(0,(0,d.Inject)(u.SheetsFilterService)),nd(1,(0,d.Inject)(d.LocaleService)),nd(2,d.ICommandService),nd(3,(0,d.Inject)(T.SheetPermissionInterceptorBaseController)),nd(4,(0,d.Inject)(d.Injector)),nd(5,(0,d.Inject)(D.SheetsSelectionsService))],nu);let nc="sheets-filter-ui.config",nh={};var nm=Object.defineProperty,np=Object.getOwnPropertyDescriptor,ng=/* @__PURE__ */A((e,t,r)=>t in e?nm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp$1"),nf=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?np(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nm(t,r,a),a},"__decorateClass$2"),nv=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2"),n_=/* @__PURE__ */A((e,t,r)=>ng(e,"symbol"!=typeof t?t+"":t,r),"__publicField$1");let nI=(nT=class extends d.Plugin{constructor(e=nh,t,r,n){super(),this._config=e,this._injector=t,this._configService=r,this._rpcChannelService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(nc,a)}onStarting(){[[eS],[nu],[nn]].forEach(e=>this._injector.add(e)),this._config.useRemoteFilterValuesGenerator&&this._rpcChannelService&&this._injector.add([eh,{useFactory:/* @__PURE__ */A(()=>(0,c.toModule)(this._rpcChannelService.requestChannel(ec)),"useFactory")}])}onReady(){this._injector.get(nu)}onRendered(){this._injector.get(nn)}},A(nT,"UniverSheetsFilterUIPlugin"),nT);n_(nI,"type",d.UniverInstanceType.UNIVER_SHEET),n_(nI,"pluginName","SHEET_FILTER_UI_PLUGIN"),nI=nf([(0,d.DependentOn)(u.UniverSheetsFilterPlugin),nv(1,(0,d.Inject)(d.Injector)),nv(2,d.IConfigService),nv(3,(0,d.Optional)(c.IRPCChannelService))],nI);var nS=Object.defineProperty,nC=Object.getOwnPropertyDescriptor,ny=/* @__PURE__ */A((e,t,r)=>t in e?nS(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),nb=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nC(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nS(t,r,a),a},"__decorateClass$1"),nw=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1"),nR=/* @__PURE__ */A((e,t,r)=>ny(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let nE=(A(nM=class extends d.Plugin{constructor(e=nh,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{menu:n,...i}=this._config;n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(nc,i)}onStarting(){[[nu],[r2]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(nu)}onRendered(){this._injector.get(r2)}},"UniverSheetsFilterMobileUIPlugin"),nM);nR(nE,"type",d.UniverInstanceType.UNIVER_SHEET),nR(nE,"pluginName","SHEET_FILTER_UI_PLUGIN"),nE=nb([(0,d.DependentOn)(u.UniverSheetsFilterPlugin),nw(1,(0,d.Inject)(d.Injector)),nw(2,d.IConfigService)],nE);var nT,nM,nO,nD=Object.defineProperty,nU=Object.getOwnPropertyDescriptor,nP=/* @__PURE__ */A((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nU(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nD(t,r,a),a},"__decorateClass"),nk=/* @__PURE__ */A((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let nN=(A(nO=class extends d.Plugin{constructor(e,t,r){super(),this._config=e,this._injector=t,this._rpcChannelService=r}onStarting(){[[eh,{useClass:em}]].forEach(e=>this._injector.add(e))}onReady(){this._rpcChannelService.registerChannel(ec,(0,c.fromModule)(this._injector.get(eh)))}},"UniverSheetsFilterUIWorkerPlugin"),x(nO,"type",d.UniverInstanceType.UNIVER_SHEET),x(nO,"pluginName","SHEET_FILTER_UI_WORKER_PLUGIN"),nO);nP([nk(1,(0,d.Inject)(d.Injector)),nk(2,c.IRPCChannelService)],nN)}),i("2I3H8",function(r,i){let a;e(r.exports,"AddHyperLinkCommand",function(){return M}),e(r.exports,"CancelHyperLinkCommand",function(){return D}),e(r.exports,"UpdateHyperLinkCommand",function(){return P}),e(r.exports,"SheetsHyperLinkResolverService",function(){return er});var o=n("83KcA"),s=n("kB4bq"),l=n("70MC3"),d=n("D79YY"),u=n("ls2nu"),c=n("1SQ85"),h=n("11kpD"),m=n("cahIb"),p=n("jv4BO"),g=n("bVip2"),f=n("fElJC"),v=n("9e68V"),_=n("3KKCW"),I=n("2Ha4T"),S=n("gQuIR"),C=n("bLx5G"),y=n("kkAWv"),b=n("1dwVM"),w=Object.defineProperty,R=(e,t,r)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,E=(e,t)=>w(e,"name",{value:t,configurable:!0}),T=(e,t,r)=>R(e,"symbol"!=typeof t?t+"":t,r);let M={type:o.CommandType.COMMAND,id:"sheets.command.add-hyper-link",async handler(e,t){var r;let n;if(!t)return!1;let i=e.get(o.ICommandService),a=e.get(o.IUndoRedoService),s=e.get(d.IRenderManagerService),l=e.get(o.IUniverInstanceService),m=e.get(c.HyperLinkModel),{unitId:p,subUnitId:g,link:f}=t,v=l.getUnit(p,o.UniverInstanceType.UNIVER_SHEET),_=s.getRenderById(p);if(!_||!v)return!1;let I=null==v?void 0:v.getSheetBySheetId(g),S=null==(r=_.with(h.SheetSkeletonManagerService).getCurrent())?void 0:r.skeleton;if(!I||!S)return!1;let{payload:C,display:y,row:b,column:w,id:R}=f,E=I.getCell(b,w),T=S.getBlankCellDocumentModel(E),M=T.documentModel.getSnapshot(),O=(0,o.Tools).deepClone(M.body);if(!O||!(n=y?(0,o.BuildTextUtils).selection.replace({selection:{startOffset:0,endOffset:O.dataStream.length-2,collapsed:!0},body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${y}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{startIndex:0,endIndex:y.length+1,rangeType:o.CustomRangeType.HYPERLINK,rangeId:R,properties:{url:C}}]},doc:T.documentModel}):(0,o.BuildTextUtils).customRange.add({body:O,range:{startOffset:0,endOffset:O.dataStream.length-2,collapsed:!1},rangeId:R,rangeType:o.CustomRangeType.HYPERLINK,properties:{url:C,refId:R}})))return!1;let D=(0,o.TextX).apply(O,n.serialize()),U={...M,body:D},P={unitId:p,subUnitId:g,cellValue:{[f.row]:{[f.column]:{p:U,t:o.CellValueType.STRING}}}},k={id:u.SetRangeValuesMutation.id,params:P},N=(0,u.SetRangeValuesUndoMutationFactory)(e,P),A={id:u.SetRangeValuesMutation.id,params:N},x=[k],L=[A],V=m.getHyperLinkByLocation(p,g,b,w);return V&&(x.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:p,subUnitId:g,id:V.id}}),L.push({id:c.AddHyperLinkMutation.id,params:{unitId:p,subUnitId:g,link:V}})),!!await (0,o.sequenceExecuteAsync)(x,i)&&(a.pushUndoRedo({redoMutations:x,undoMutations:L,unitID:p}),!0)}},O={id:"sheets.command.add-rich-hyper-link",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E(async(e,t)=>{if(!t)return!1;let{documentId:r,link:n}=t,i=e.get(o.ICommandService),a=e.get(s.DocSelectionManagerService),d=(0,o.generateRandomId)(),{payload:u}=n;if(!a.getActiveTextRange())return!1;let c=(0,l.addCustomRangeBySelectionFactory)(e,{unitId:r,rangeId:d,rangeType:o.CustomRangeType.HYPERLINK,properties:{url:u,refId:d}});return!!c&&i.syncExecuteCommand(c.id,c.params)},"handler")},D={type:o.CommandType.COMMAND,id:"sheets.command.cancel-hyper-link",handler(e,t){var r,n,i;if(!t)return!1;let a=e.get(o.ICommandService),s=e.get(o.IUndoRedoService),l=e.get(d.IRenderManagerService),m=e.get(o.IUniverInstanceService),p=e.get(c.HyperLinkModel),{unitId:g,subUnitId:f,row:v,column:_,id:I}=t,S=m.getUnit(g,o.UniverInstanceType.UNIVER_SHEET),C=l.getRenderById(g);if(!C||!S)return!1;let y=null==S?void 0:S.getSheetBySheetId(f),b=null==(r=C.with(h.SheetSkeletonManagerService).getCurrent())?void 0:r.skeleton;if(!y||!b)return!1;let w=y.getCell(v,_);if(!w)return!1;let R=b.getCellDocumentModelWithFormula(w);if(!(null!=R&&R.documentModel))return!1;let E=(0,o.Tools).deepClone(R.documentModel.getSnapshot());if(!(null==(i=null==(n=E.body)?void 0:n.customRanges)?void 0:i.find(e=>e.rangeId===I)))return!1;let T=(0,o.BuildTextUtils).customRange.delete(e,{documentDataModel:R.documentModel,rangeId:I});if(!T)return!1;let M=(0,o.TextX).apply(E.body,T.serialize()),O=[],D=[],U={unitId:g,subUnitId:f,cellValue:{[v]:{[_]:{p:{...E,body:M},t:o.CellValueType.STRING}}}};O.push({id:u.SetRangeValuesMutation.id,params:U});let P=(0,u.SetRangeValuesUndoMutationFactory)(e,U);D.push({id:u.SetRangeValuesMutation.id,params:P});let k=p.getHyperLinkByLocation(g,f,v,_);return k&&(O.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:g,subUnitId:f,id:I}}),D.push({id:c.AddHyperLinkMutation.id,params:{unitId:g,subUnitId:f,link:{...k}}})),!!(0,o.sequenceExecute)(O,a).result&&(s.pushUndoRedo({redoMutations:O,undoMutations:D,unitID:g}),!0)}},U={type:o.CommandType.COMMAND,id:"sheets.command.cancel-rich-hyper-link",handler(e,t){var r,n;if(!t)return!1;let{id:i,documentId:a}=t,s=e.get(o.ICommandService),d=e.get(o.IUniverInstanceService).getUnit(a,o.UniverInstanceType.UNIVER_DOC),u=null==(n=null==(r=null==d?void 0:d.getBody())?void 0:r.customRanges)?void 0:n.find(e=>e.rangeId===i),c=null;u&&u.endIndex===d.getBody().dataStream.length-3&&(c={dataStream:" "});let h=(0,l.deleteCustomRangeFactory)(e,{unitId:a,rangeId:i,insert:c});return!!h&&s.syncExecuteCommand(h.id,h.params)}},P={type:o.CommandType.COMMAND,id:"sheets.command.update-hyper-link",async handler(e,t){var r,n,i,a;if(!t)return!1;let s=e.get(o.ICommandService),m=e.get(o.IUndoRedoService),p=e.get(d.IRenderManagerService),g=e.get(o.IUniverInstanceService),f=e.get(c.HyperLinkModel),{unitId:v,subUnitId:_,payload:I,row:S,column:C,id:y}=t,b=g.getUnit(v,o.UniverInstanceType.UNIVER_SHEET),w=p.getRenderById(v);if(!w||!b)return!1;let R=null==b?void 0:b.getSheetBySheetId(_),E=null==(r=w.with(h.SheetSkeletonManagerService).getCurrent())?void 0:r.skeleton;if(!R||!E)return!1;let{payload:T,display:M=""}=I,O=R.getCell(S,C);if(!O)return!1;let D=E.getCellDocumentModelWithFormula(O);if(!(null!=D&&D.documentModel))return!1;let U=D.documentModel.getSnapshot(),P=null==(i=null==(n=U.body)?void 0:n.customRanges)?void 0:i.find(e=>e.rangeId===y);if(!P)return!1;let k=(0,o.generateRandomId)(),N=null==(a=(0,o.getBodySlice)(D.documentModel.getBody(),P.startIndex,P.endIndex+1).textRuns)?void 0:a[0];N&&(N.ed=M.length+1);let A=(0,l.replaceSelectionFactory)(e,{unitId:v,body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${M}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{rangeId:k,rangeType:o.CustomRangeType.HYPERLINK,startIndex:0,endIndex:M.length+1,properties:{url:T}}],textRuns:N?[N]:void 0},selection:{startOffset:P.startIndex,endOffset:P.endIndex+1,collapsed:!1},doc:D.documentModel});if(!A)return!1;let x=(0,o.TextX).apply((0,o.Tools).deepClone(U.body),A.textX.serialize()),L={id:u.SetRangeValuesMutation.id,params:{unitId:v,subUnitId:_,cellValue:{[S]:{[C]:{p:{...U,body:x},t:o.CellValueType.STRING}}}}},V=(0,u.SetRangeValuesUndoMutationFactory)(e,L.params),F={id:u.SetRangeValuesMutation.id,params:V},j=[L],H=[F],$=f.getHyperLinkByLocation(v,_,S,C);return $&&(j.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:v,subUnitId:_,id:$.id}}),H.push({id:c.AddHyperLinkMutation.id,params:{unitId:v,subUnitId:_,link:$}})),!!await (0,o.sequenceExecuteAsync)(j,s)&&(m.pushUndoRedo({redoMutations:j,undoMutations:H,unitID:v}),!0)}},k={type:o.CommandType.COMMAND,id:"sheets.command.update-rich-hyper-link",handler:/* @__PURE__ */E((e,t)=>{var r,n,i,a;if(!t)return!1;let{documentId:s,payload:d,id:u}=t,c=e.get(o.IUniverInstanceService),h=e.get(o.ICommandService),m=c.getUnit(s,o.UniverInstanceType.UNIVER_DOC);if(!m)return!1;let p=null==(n=null==(r=m.getBody())?void 0:r.customRanges)?void 0:n.find(e=>e.rangeId===u);if(!p)return!1;let g=null!=(i=t.payload.display)?i:"",f=(0,o.generateRandomId)(),v=null==(a=(0,o.getBodySlice)(m.getBody(),p.startIndex,p.endIndex+1).textRuns)?void 0:a[0];v&&(v.ed=g.length+1);let _=(0,l.replaceSelectionFactory)(e,{unitId:s,body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${g}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{rangeId:f,rangeType:o.CustomRangeType.HYPERLINK,startIndex:0,endIndex:g.length+1,properties:{url:d.payload}}],textRuns:v?[v]:void 0},selection:{startOffset:p.startIndex,endOffset:p.endIndex+1,collapsed:!1},doc:m});return!!_&&h.syncExecuteCommand(_.id,_.params)},"handler")};var N=((a=N||{}).EDITING="editing",a.VIEWING="viewing",a.ZEN_EDITOR="zen_mode",a),A={exports:{}},x={},L=/*@__PURE__*/t(S),V=Symbol.for("react.element"),F=Symbol.for("react.fragment"),j=Object.prototype.hasOwnProperty,H=L.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,$={key:!0,ref:!0,__self:!0,__source:!0};function B(e,t,r){var n,i={},a=null,o=null;for(n in void 0!==r&&(a=""+r),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(o=t.ref),t)j.call(t,n)&&!$.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:V,type:e,key:a,ref:o,props:i,_owner:H.current}}E(B,"q"),x.Fragment=F,x.jsx=B,x.jsxs=B,A.exports=x;var W=A.exports;function G(e){return(0,o.Tools).isLegalUrl(e)}function Y(e){return/^[a-zA-Z]+:\/\//.test(e)}function z(e){return/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(e)}function K(e){if(G(e)){let t;let r=Y(e)?e:z(e)?`mailto://${e}`:`http://${e}`;try{t=new URL(r)}catch{return e}return t.hostname===location.hostname&&t.port===location.port&&t.protocol===location.protocol&&t.pathname===location.pathname&&t.hash&&!t.search?t.hash:r}return e}E(G,"isLegalLink"),E(Y,"hasProtocol"),E(z,"isEmail"),E(K,"serializeUrl");let q="sheets-hyper-link-ui.config",X={};var Z=Object.defineProperty,Q=Object.getOwnPropertyDescriptor,J=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Q(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&Z(t,r,a),a},"__decorateClass$c"),ee=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$c");function et(e,t){let r=t.getMergeData(),n=t.getMaxColumns()-1,i=t.getMaxRows()-1;if(n<e.endColumn&&(e.endColumn=n),i<e.endRow&&(e.endRow=i),e.rangeType===o.RANGE_TYPE.COLUMN||o.RANGE_TYPE.ROW)return e;let a=[];return r.forEach(t=>{(0,o.Rectangle).intersects(e,t)&&a.push(t)}),(0,o.Rectangle).realUnion(e,...a)}E(et,"getContainRange");let er=(e$=class{constructor(e,t,r,n,i,a){this._univerInstanceService=e,this._commandService=t,this._definedNamesService=r,this._messageService=n,this._localeService=i,this._configService=a}_getURLName(e){var t;let{gid:r,range:n,rangeid:i,unitid:a}=e,s=a?this._univerInstanceService.getUnit(a,o.UniverInstanceType.UNIVER_SHEET):this._univerInstanceService.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET),l={type:c.SheetHyperLinkType.INVALID,name:this._localeService.t("hyperLink.message.refError")};if(!s)return l;let d=r?s.getSheetBySheetId(r):s.getActiveSheet(),u=null!=(t=null==d?void 0:d.getName())?t:"";if(n){if(!d)return l;let e=(0,y.deserializeRangeWithSheet)(n).range;return(0,o.isValidRange)(e,d)&&n!==c.ERROR_RANGE?{type:c.SheetHyperLinkType.RANGE,name:(0,y.serializeRangeWithSheet)(u,e)}:l}if(i){let e=this._definedNamesService.getValueById(s.getUnitId(),i);return e?{type:c.SheetHyperLinkType.DEFINE_NAME,name:e.formulaOrRefString}:l}if(r){let e=s.getSheetBySheetId(r);return e?{type:c.SheetHyperLinkType.SHEET,name:e.getName()}:l}return l}navigateTo(e){let{gid:t,range:r,rangeid:n}=e,i=this._univerInstanceService.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(!i)return;let a=i.getUnitId();if(n&&this.navigateToDefineName(a,n),t){if(r){let e=(0,y.deserializeRangeWithSheet)(r);(0,o.isValidRange)(e.range)&&r!==c.ERROR_RANGE&&this.navigateToRange(a,t,e.range);return}this.navigateToSheetById(a,t)}}buildHyperLink(e,t,r){return`#${c.SheetHyperLinkType.SHEET}=${t}${r?`&${"string"==typeof r?c.SheetHyperLinkType.DEFINE_NAME:c.SheetHyperLinkType.RANGE}=${"string"==typeof r?r:(0,y.serializeRange)(r)}`:""}`}parseHyperLink(e){var t,r,n,i;if(!e.startsWith("#"))return{type:c.SheetHyperLinkType.URL,name:e,url:e,handler:/* @__PURE__ */E(()=>{this.navigateToOtherWebsite(e)},"handler"),searchObj:null};{let a=new URLSearchParams(e.slice(1)),o={gid:null!=(t=a.get("gid"))?t:"",range:null!=(r=a.get("range"))?r:"",rangeid:null!=(n=a.get("rangeid"))?n:"",unitid:null!=(i=a.get("unitid"))?i:""},s=this._getURLName(o);return{type:s.type,name:s.name,url:e,searchObj:o,handler:/* @__PURE__ */E(()=>{this.navigateTo(o)},"handler")}}}async navigateToRange(e,t,r){let n=await this.navigateToSheetById(e,t);if(n){let i=et(r,n);await this._commandService.executeCommand(u.SetSelectionsOperation.id,{unitId:e,subUnitId:t,selections:[{range:i}]}),await this._commandService.executeCommand(h.ScrollToRangeOperation.id,{range:i})}}async navigateToSheet(e,t){let r=this._univerInstanceService.getUnit(e,o.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;let n=r.getActiveSheet();if((null==n?void 0:n.getName())===t)return!0;let i=r.getSheetBySheetName(t);if(!i){this._messageService.show({content:this._localeService.t("hyperLink.message.noSheet"),type:C.MessageType.Error});return}let a=i.getSheetId();return r.getHiddenWorksheets().indexOf(a)>-1&&this._messageService.show({content:this._localeService.t("hyperLink.message.hiddenSheet"),type:C.MessageType.Error}),await this._commandService.executeCommand(u.SetWorksheetActiveOperation.id,{unitId:e,subUnitId:a})}async navigateToSheetById(e,t){let r=this._univerInstanceService.getUnit(e,o.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;let n=r.getActiveSheet();if(!n)return!1;if(n.getSheetId()===t)return n;let i=r.getSheetBySheetId(t);return i?r.getHiddenWorksheets().indexOf(t)>-1?(this._messageService.show({content:this._localeService.t("hyperLink.message.hiddenSheet"),type:C.MessageType.Error}),!1):!!await this._commandService.executeCommand(u.SetWorksheetActiveOperation.id,{unitId:e,subUnitId:t})&&i:(this._messageService.show({content:this._localeService.t("hyperLink.message.noSheet"),type:C.MessageType.Error}),!1)}async navigateToDefineName(e,t){return this._definedNamesService.focusRange(e,t),!0}async navigateToOtherWebsite(e){var t;let r=this._configService.getConfig(q);if(null!=(t=null==r?void 0:r.urlHandler)&&t.navigateToOtherWebsite)return r.urlHandler.navigateToOtherWebsite(e);window.open(e,"_blank","noopener noreferrer")}},E(e$,"SheetsHyperLinkResolverService"),e$);er=J([ee(0,o.IUniverInstanceService),ee(1,o.ICommandService),ee(2,y.IDefinedNamesService),ee(3,m.IMessageService),ee(4,(0,o.Inject)(o.LocaleService)),ee(5,o.IConfigService)],er);let en=class extends o.Disposable{constructor(){super(...arguments),T(this,"_customHyperLinks",/* @__PURE__ */new Map)}isBuiltInLinkType(e){return e!==c.SheetHyperLinkType.URL}getOptions(){return Array.from(this._customHyperLinks.values()).map(({option:e})=>e)}findCustomHyperLink(e){return Array.from(this._customHyperLinks.values()).find(t=>t.match(e))}registerCustomHyperLink(e){this._customHyperLinks.set(e.type,e)}getCustomHyperLink(e){return this._customHyperLinks.get(e)}removeCustomHyperLink(e){let{_customHyperLinks:t}=this;t.delete(e)}dispose(){super.dispose(),this._customHyperLinks.clear()}};E(en,"SheetsHyperLinkSidePanelService");let ei={cellLinkEdit:"univer-cell-link-edit",cellLinkEditButtons:"univer-cell-link-edit-buttons"},ea=/* @__PURE__ */E(()=>{var e;let[t,r]=(0,S.useState)(""),[n,i]=(0,S.useState)(!1),[a,l]=(0,S.useState)(""),[d,p]=(0,S.useState)(!0),[g,f]=(0,S.useState)(c.SheetHyperLinkType.URL),[v,_]=(0,S.useState)(""),I=(0,o.useDependency)(o.LocaleService),b=(0,o.useDependency)(y.IDefinedNamesService),w=(0,o.useDependency)(h.IEditorBridgeService),R=(0,o.useDependency)(o.IUniverInstanceService),T=(0,o.useDependency)(ek),D=(0,m.useObservable)(T.currentEditing$),U=(0,o.useDependency)(er),A=(0,o.useDependency)(o.ICommandService),x=(0,o.useDependency)(en),L=(0,S.useMemo)(()=>x.getOptions(),[x]),V=(0,o.useDependency)(m.IZenZoneService),F=(0,o.useDependency)(h.IMarkSelectionService),j=(0,o.useDependency)(s.DocSelectionManagerService),H=(0,o.useDependency)(o.IContextService),$=(0,S.useMemo)(()=>{if(!x.isBuiltInLinkType(g))return x.getCustomHyperLink(g)},[x,g]),[B,Y]=(0,S.useState)(!1),z=(0,S.useRef)(!1);(0,S.useEffect)(()=>{var e,t,n,i,a,s,d,u,h,m,g,v,I,S,C,b,w;if((null==D?void 0:D.row)!==void 0&&void 0!==D.col){let E;let{label:T,customRange:M,row:O,col:P}=D;if(M)E={id:null!=(e=null==M?void 0:M.rangeId)?e:"",display:null!=T?T:"",payload:null!=(n=null==(t=null==M?void 0:M.properties)?void 0:t.url)?n:"",row:O,column:P};else if(D.type===N.VIEWING){let e=R.getUnit(D.unitId),t=null==e?void 0:e.getSheetBySheetId(D.subUnitId),r=null==t?void 0:t.getCellRaw(D.row,D.col),n=null==(s=null==(a=null==(i=null==r?void 0:r.p)?void 0:i.body)?void 0:a.customRanges)?void 0:s.find(e=>{var t;return e.rangeType===o.CustomRangeType.HYPERLINK&&(null==(t=e.properties)?void 0:t.url)}),l=`${null!=(d=(0,o.getOriginCellValue)(r))?d:""}`;r&&(r.p||l)&&p(!1),E={id:"",display:"",payload:null!=(h=null==(u=null==n?void 0:n.properties)?void 0:u.url)?h:"",row:O,column:P}}else{let e=R.getCurrentUnitForType(o.UniverInstanceType.UNIVER_DOC),t=j.getActiveTextRange(),r=t&&(null==(v=(0,o.BuildTextUtils).customRange.getCustomRangesInterestsWithRange(t,null!=(g=null==(m=null==e?void 0:e.getBody())?void 0:m.customRanges)?g:[]))?void 0:v[0]);p(!1),E={id:"",display:null!=T?T:"",payload:null!=(S=null==(I=null==r?void 0:r.properties)?void 0:I.url)?S:"",row:O,column:P}}r(E.id);let k=x.findCustomHyperLink(E);if(k){let e=k.convert(E);f(e.type),_(e.payload),l(e.display);return}l(E.display);let A=U.parseHyperLink(E.payload);switch(f(A.type===c.SheetHyperLinkType.INVALID?c.SheetHyperLinkType.RANGE:A.type),A.type){case c.SheetHyperLinkType.URL:_(A.url),A.url===E.display&&(z.current=!0);break;case c.SheetHyperLinkType.RANGE:{let e=A.searchObj,t=e.gid&&null!=(w=null==(b=null==(C=R.getUnit(D.unitId))?void 0:C.getSheetBySheetId(e.gid))?void 0:b.getName())?w:"",r=(0,y.serializeRangeWithSheet)(t,(0,y.deserializeRangeWithSheet)(e.range).range);_(r),r===E.display&&(z.current=!0);break}case c.SheetHyperLinkType.SHEET:_(A.searchObj.gid);break;case c.SheetHyperLinkType.DEFINE_NAME:_(A.searchObj.rangeid);break;default:_("")}}},[D,U,x,j,R]),(0,S.useEffect)(()=>{let e=null;return D&&D.type===N.VIEWING&&(0,o.Tools).isDefine(D.row)&&(0,o.Tools).isDefine(D.col)&&(e=F.addShape({range:{startColumn:D.col,endColumn:D.col,startRow:D.row,endRow:D.row},style:{hasAutoFill:!1,fill:"rgb(255, 189, 55, 0.35)",strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null},[],-1)),()=>{e&&F.removeShape(e)}},[D,F]);let q=(0,S.useMemo)(()=>v,[g]);(0,S.useEffect)(()=>()=>{w.disableForceKeepVisible()},[w]);let X=[{label:I.t("hyperLink.form.link"),value:c.SheetHyperLinkType.URL},{label:I.t("hyperLink.form.range"),value:c.SheetHyperLinkType.RANGE},{label:I.t("hyperLink.form.worksheet"),value:c.SheetHyperLinkType.SHEET},{label:I.t("hyperLink.form.definedName"),value:c.SheetHyperLinkType.DEFINE_NAME},...L],Z=R.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(!Z)return;let Q=Z.getHiddenWorksheets(),J=Z.getSheets().map(e=>({label:e.getName(),value:e.getSheetId()})).filter(e=>-1===Q.indexOf(e.value)),ee=Object.values(null!=(e=b.getDefinedNameMap(Z.getUnitId()))?e:{}).map(e=>({label:e.name,value:e.id})),et=/* @__PURE__ */E((e,t)=>{if(e===c.SheetHyperLinkType.URL)return K(t);if(e===c.SheetHyperLinkType.RANGE){let e=(0,y.deserializeRangeWithSheet)(t),r=Z.getSheetBySheetName(e.sheetName);if(r)return`#gid=${r.getSheetId()}&range=${(0,y.serializeRange)(e.range)}`}return`#${e}=${t}`},"formatUrl"),ea=(0,m.useEvent)(e=>{var t;let r=e[0];if(!r||!(0,o.isValidRange)(r.range))return;r.sheetName||(r.sheetName=(null==(t=Z.getActiveSheet())?void 0:t.getName())||"");let n=(0,y.serializeRangeToRefString)(r);_(n),n&&(z.current||!a)&&(l(n),z.current=!0)}),eo=/* @__PURE__ */E(async()=>{if(d&&!a||!v||g===c.SheetHyperLinkType.URL&&!G(v)){Y(!0);return}if(D){if(t){let e=D.type===N.ZEN_EDITOR||D.type===N.EDITING?k.id:P.id;await A.executeCommand(e,{id:t,unitId:D.unitId,subUnitId:D.subUnitId,payload:{display:d?a:"",payload:et(g,v)},row:D.row,column:D.col,documentId:D.type===N.ZEN_EDITOR?o.DOCS_ZEN_EDITOR_UNIT_ID_KEY:w.getCurrentEditorId()})}else{let e=D.type===N.ZEN_EDITOR||D.type===N.EDITING?O.id:M.id;await A.executeCommand(e,{unitId:D.unitId,subUnitId:D.subUnitId,link:{id:(0,o.generateRandomId)(),row:D.row,column:D.col,payload:et(g,v),display:d?a:""},documentId:D.type===N.ZEN_EDITOR?o.DOCS_ZEN_EDITOR_UNIT_ID_KEY:w.getCurrentEditorId()})}}(null==D?void 0:D.type)===N.VIEWING&&(await A.executeCommand(u.SetWorksheetActiveOperation.id,{unitId:D.unitId,subUnitId:D.subUnitId}),await A.executeCommand(h.ScrollToRangeOperation.id,{range:{startRow:Math.max(D.row-1,0),endRow:D.row+1,startColumn:Math.max(D.col-1,0),endColumn:D.col+1}})),A.executeCommand(eV.id)},"handleSubmit");return D?/* @__PURE__ */W.jsxs("div",{className:ei.cellLinkEdit,style:{display:n?"none":"block"},children:[d?/* @__PURE__ */W.jsx(C.FormLayout,{label:I.t("hyperLink.form.label"),error:B&&!a?I.t("hyperLink.form.inputError"):"",children:/* @__PURE__ */W.jsx(C.Input,{value:a,onChange:/* @__PURE__ */E(e=>{l(e),z.current=!1},"onChange"),placeholder:I.t("hyperLink.form.labelPlaceholder"),autoFocus:!0,onKeyDown:/* @__PURE__ */E(e=>{e.keyCode===m.KeyCode.ENTER&&eo()},"onKeyDown")})}):null,/* @__PURE__ */W.jsx(C.FormLayout,{label:I.t("hyperLink.form.type"),contentStyle:{marginBottom:0},children:/* @__PURE__ */W.jsx(C.Select,{options:X,value:g,onChange:/* @__PURE__ */E(e=>{f(e),_("")},"onChange")})}),g===c.SheetHyperLinkType.URL&&/* @__PURE__ */W.jsx(C.FormLayout,{error:B?v?G(v)?"":I.t("hyperLink.form.linkError"):I.t("hyperLink.form.inputError"):"",children:/* @__PURE__ */W.jsx(C.Input,{value:v,onChange:/* @__PURE__ */E(e=>{_(e),e&&(z.current||!a||a===v)&&(l(e),z.current=!0)},"onChange"),placeholder:I.t("hyperLink.form.linkPlaceholder"),autoFocus:!d,onKeyDown:/* @__PURE__ */E(e=>{e.keyCode===m.KeyCode.ENTER&&eo()},"onKeyDown")})}),g===c.SheetHyperLinkType.RANGE&&/* @__PURE__ */W.jsx(C.FormLayout,{error:B&&!v?I.t("hyperLink.form.inputError"):"",children:/* @__PURE__ */W.jsx(m.RangeSelector,{openForSheetUnitId:Z.getUnitId(),id:(0,o.createInternalEditorID)("hyper-link-edit"),isSingleChoice:!0,value:q,onChange:ea,disableInput:D.type===N.ZEN_EDITOR,onSelectorVisibleChange:/* @__PURE__ */E(async e=>{e?(D.type===N.ZEN_EDITOR&&(V.hide(),H.setContextValue(o.FOCUSING_SHEET,!0)),D.type!==N.VIEWING&&w.enableForceKeepVisible(),i(!0)):(await U.navigateToRange(D.unitId,D.subUnitId,{startRow:D.row,endRow:D.row,startColumn:D.col,endColumn:D.col}),D.type===N.ZEN_EDITOR&&(await A.executeCommand(u.SetSelectionsOperation.id,{unitId:D.unitId,subUnitId:D.subUnitId,selections:[{range:{startRow:D.row,endRow:D.row,startColumn:D.col,endColumn:D.col}}]}),V.show(),H.setContextValue(o.FOCUSING_SHEET,!1)),w.disableForceKeepVisible(),i(!1))},"onSelectorVisibleChange")})}),g===c.SheetHyperLinkType.SHEET&&/* @__PURE__ */W.jsx(C.FormLayout,{error:B&&!v?I.t("hyperLink.form.selectError"):"",children:/* @__PURE__ */W.jsx(C.Select,{options:J,value:v,onChange:/* @__PURE__ */E(e=>{var t,r;_(e);let n=null==(t=J.find(t=>t.value===e))?void 0:t.label,i=null==(r=J.find(e=>e.value===v))?void 0:r.label;n&&(z.current||!a||a===i)&&(l(n),z.current=!0)},"onChange")})}),g===c.SheetHyperLinkType.DEFINE_NAME&&/* @__PURE__ */W.jsx(C.FormLayout,{error:B&&!v?I.t("hyperLink.form.selectError"):"",children:/* @__PURE__ */W.jsx(C.Select,{options:ee,value:v,onChange:/* @__PURE__ */E(e=>{var t,r;_(e);let n=null==(t=ee.find(t=>t.value===e))?void 0:t.label,i=null==(r=ee.find(e=>e.value===v))?void 0:r.label;n&&(z.current||!a||a===i)&&(l(n),z.current=!0)},"onChange")})}),(null==$?void 0:$.Form)&&/* @__PURE__ */W.jsx($.Form,{linkId:t,payload:v,display:a,showError:B,setByPayload:z,setDisplay:/* @__PURE__ */E(e=>{l(e),z.current=!0},"setDisplay"),setPayload:_}),/* @__PURE__ */W.jsxs("div",{className:ei.cellLinkEditButtons,children:[/* @__PURE__ */W.jsx(C.Button,{onClick:/* @__PURE__ */E(()=>{D&&U.navigateToRange(D.unitId,D.subUnitId,{startRow:D.row,endRow:D.row,startColumn:D.col,endColumn:D.col}),A.executeCommand(eV.id)},"onClick"),children:I.t("hyperLink.form.cancel")}),/* @__PURE__ */W.jsx(C.Button,{type:"primary",style:{marginLeft:8},onClick:/* @__PURE__ */E(async()=>{eo()},"onClick"),children:I.t("hyperLink.form.ok")})]})]}):null},"CellLinkEdit");ea.componentKey="univer.sheet.cell-link-edit";var eo=function(){return(eo=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},es=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},el=(0,S.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=es(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,S.useRef)("_".concat(eh()));return ed(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},eo({ref:t,className:s},o),a)});function ed(e,t,r,n,i){return(0,S.createElement)(e.tag,eo(eo({key:t},eu(e,r,i)),n),(ec(e,r).children||[]).map(function(n,a){return ed(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function eu(e,t,r){var n=eo({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function ec(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?eo(eo({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?eo(eo({},e),{attrs:eo(eo({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function eh(){return Math.random().toString(36).substring(2,8)}E(ed,"render"),E(eu,"replaceRuntimeIdsAndExtInAttrs"),E(ec,"replaceRuntimeIdsInDefs"),E(eh,"generateShortUuid"),el.displayName="UniverIcon";var em={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.9999 1.12915C8.03875 1.12915 8.07673 1.13284 8.11352 1.13989H12.2599C13.6958 1.13989 14.8599 2.30395 14.8599 3.73989V7.88619C14.867 7.92301 14.8707 7.96102 14.8707 7.9999C14.8707 8.03878 14.867 8.0768 14.8599 8.11362V12.2599C14.8599 13.6958 13.6958 14.8599 12.2599 14.8599H8.11362C8.0768 14.867 8.03878 14.8707 7.9999 14.8707C7.96102 14.8707 7.92301 14.867 7.88619 14.8599H3.73989C2.30396 14.8599 1.13989 13.6958 1.13989 12.2599V8.11352C1.13284 8.07673 1.12915 8.03875 1.12915 7.9999C1.12915 7.96106 1.13284 7.92308 1.13989 7.88629V3.73989C1.13989 2.30396 2.30395 1.13989 3.73989 1.13989H7.88629C7.92308 1.13284 7.96106 1.12915 7.9999 1.12915ZM2.33989 8.5999V12.2599C2.33989 13.0331 2.9667 13.6599 3.73989 13.6599H7.3999V8.5999H2.33989ZM7.3999 7.3999H2.33989V3.73989C2.33989 2.9667 2.96669 2.33989 3.73989 2.33989H7.3999V7.3999ZM8.5999 8.5999V13.6599H12.2599C13.0331 13.6599 13.6599 13.0331 13.6599 12.2599V8.5999H8.5999ZM13.6599 7.3999H8.5999V2.33989H12.2599C13.0331 2.33989 13.6599 2.96669 13.6599 3.73989V7.3999Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ep=(0,S.forwardRef)(function(e,t){return(0,S.createElement)(el,Object.assign({},e,{id:"all-border-single",ref:t,icon:em}))});ep.displayName="AllBorderSingle";var eg={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.1302 12.4251C4.25802 13.7417 5.36779 14.7708 6.71792 14.7708H11.7179C13.1539 14.7708 14.3179 13.6067 14.3179 12.1708V6.1708C14.3179 4.78586 13.2351 3.65383 11.8698 3.57517C11.742 2.25858 10.6323 1.22949 9.28213 1.22949H4.28213C2.84619 1.22949 1.68213 2.39355 1.68213 3.82949V9.82949C1.68213 11.2144 2.76497 12.3465 4.1302 12.4251ZM10.6583 3.5708H6.71792C5.28198 3.5708 4.11792 4.73486 4.11792 6.1708V11.22C3.4221 11.1387 2.88213 10.5471 2.88213 9.82949V3.82949C2.88213 3.05629 3.50893 2.42949 4.28213 2.42949H9.28213C9.96695 2.42949 10.5369 2.92119 10.6583 3.5708ZM13.1179 6.1708C13.1179 5.3976 12.4911 4.7708 11.7179 4.7708H6.71792C5.94472 4.7708 5.31792 5.3976 5.31792 6.1708V12.1708C5.31792 12.944 5.94472 13.5708 6.71792 13.5708H11.7179C12.4911 13.5708 13.1179 12.944 13.1179 12.1708V6.1708Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ef=(0,S.forwardRef)(function(e,t){return(0,S.createElement)(el,Object.assign({},e,{id:"copy-single",ref:t,icon:eg}))});ef.displayName="CopySingle";var ev={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.9564 2.91332C4.91407 1.87102 3.22413 1.87101 2.18182 2.91333L2.18182 2.91333C1.13953 3.95567 1.13952 5.6456 2.18182 6.68791L8.27777 12.7838C9.72408 14.2302 12.069 14.2302 13.5154 12.7839L13.0911 12.3596L13.5154 12.7839C14.9617 11.3375 14.9617 8.99257 13.5154 7.54626L8.39476 2.42566C8.16044 2.19134 7.78054 2.19134 7.54623 2.42566C7.31191 2.65997 7.31191 3.03987 7.54623 3.27419L12.6668 8.39479L13.0911 7.97052L12.6668 8.39479C13.6445 9.37247 13.6445 10.9576 12.6668 11.9353L13.0399 12.3084L12.6668 11.9353C11.6891 12.913 10.104 12.913 9.1263 11.9353L3.03035 5.83938C2.45668 5.26571 2.45667 4.33556 3.03036 3.76184C3.60403 3.18818 4.53416 3.18817 5.10788 3.76185C5.10788 3.76186 5.10788 3.76186 5.10789 3.76186L11.2038 9.8578L11.601 9.46061L11.2038 9.8578C11.3735 10.0275 11.3735 10.3026 11.2038 10.4723L11.2038 10.4723C11.0341 10.642 10.759 10.642 10.5893 10.4723L5.46874 5.35171C5.23442 5.1174 4.85452 5.1174 4.62021 5.35171C4.38589 5.58602 4.38589 5.96592 4.62021 6.20024L9.74078 11.3208C10.3791 11.9591 11.414 11.9591 12.0523 11.3208C12.0523 11.3208 12.0523 11.3208 12.0523 11.3208M12.0523 11.3208C12.6907 10.6825 12.6906 9.64757 12.0523 9.00927L5.95641 2.91333L5.9564 2.91332",fillRule:"evenodd",clipRule:"evenodd"}}]},e_=(0,S.forwardRef)(function(e,t){return(0,S.createElement)(el,Object.assign({},e,{id:"link-single",ref:t,icon:ev}))});e_.displayName="LinkSingle";var eI={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.5935 3.47302C11.6354 2.51492 10.082 2.51492 9.12388 3.47302L7.83534 4.76157C7.60102 4.99588 7.22112 4.99588 6.98681 4.76157 6.75249 4.52725 6.75249 4.14735 6.98681 3.91304L8.27535 2.62449C9.70209 1.19776 12.0153 1.19776 13.442 2.62449 14.8688 4.05123 14.8688 6.36442 13.442 7.79116L12.1535 9.0797C11.9192 9.31402 11.5393 9.31402 11.3049 9.0797 11.0706 8.84539 11.0706 8.46549 11.3049 8.23117L12.5935 6.94263C13.5516 5.98452 13.5516 4.43113 12.5935 3.47302zM3.40637 12.6606C2.44827 11.7025 2.44827 10.1491 3.40637 9.19102L4.69492 7.90248C4.92923 7.66816 4.92923 7.28826 4.69492 7.05395 4.4606 6.81963 4.0807 6.81963 3.84639 7.05395L2.55784 8.34249C1.13111 9.76923 1.13111 12.0824 2.55784 13.5092 3.98458 14.9359 6.29777 14.9359 7.72451 13.5092L9.01305 12.2206C9.24737 11.9863 9.24737 11.6064 9.01305 11.3721 8.77874 11.1378 8.39884 11.1378 8.16452 11.3721L6.87598 12.6606C5.91787 13.6187 4.36448 13.6187 3.40637 12.6606zM3.5852 2.80332C3.35088 2.569 2.97098 2.569 2.73667 2.80332 2.50235 3.03763 2.50235 3.41753 2.73667 3.65185L12.4151 13.3302C12.6494 13.5646 13.0293 13.5646 13.2636 13.3302 13.4979 13.0959 13.4979 12.716 13.2636 12.4817L3.5852 2.80332z"}}]},eS=(0,S.forwardRef)(function(e,t){return(0,S.createElement)(el,Object.assign({},e,{id:"unlink-single",ref:t,icon:eI}))});eS.displayName="UnlinkSingle";var eC={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.6551 1.98906C11.7476 1.08113 10.2757 1.08149 9.3686 1.98987L4.82542 6.53955C4.75087 6.61421 4.69336 6.70411 4.65682 6.80309L3.2461 10.625C3.16506 10.8446 3.21909 11.0912 3.3845 11.2568C3.54991 11.4224 3.79651 11.4767 4.01616 11.3959L7.85031 9.98517C7.94979 9.94856 8.04014 9.89077 8.11508 9.81579L12.6552 5.27327C13.5618 4.36621 13.5618 2.89607 12.6551 1.98906ZM10.2177 2.83779C10.6562 2.39869 11.3677 2.39851 11.8064 2.8374C12.2447 3.27584 12.2447 3.9865 11.8065 4.42497L7.3392 8.89457L4.82213 9.82068L5.74706 7.31487L10.2177 2.83779Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.79238 13.2999C1.46101 13.2999 1.19238 13.5685 1.19238 13.8999C1.19238 14.2313 1.46101 14.4999 1.79238 14.4999H14.4924C14.8238 14.4999 15.0924 14.2313 15.0924 13.8999C15.0924 13.5685 14.8238 13.2999 14.4924 13.2999H1.79238Z"}}]},ey=(0,S.forwardRef)(function(e,t){return(0,S.createElement)(el,Object.assign({},e,{id:"write-single",ref:t,icon:eC}))});ey.displayName="WriteSingle";var eb={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"#35BD4B",d:"M3.4535 1.12549C2.7002 1.12549 2.08954 1.73615 2.08954 2.48945V13.5104C2.08954 14.2637 2.7002 14.8744 3.4535 14.8744H12.5465C13.2998 14.8744 13.9105 14.2637 13.9105 13.5104V5.0992L10.0091 1.12549H3.4535Z"}},{tag:"path",attrs:{fill:"#32A846",d:"M10.0075 1.12549L13.9104 5.09842H10.6742C10.306 5.09842 10.0075 4.79994 10.0075 4.43175V1.12549Z"}},{tag:"path",attrs:{fill:"#fff",d:"M7.8088 10.2949L6.3764 12.403C6.26259 12.5705 6.03455 12.614 5.86705 12.5002C5.69955 12.3864 5.65603 12.1584 5.76984 11.9909L7.3655 9.64252L5.94042 7.54519C5.82661 7.37769 5.87013 7.14964 6.03763 7.03583C6.20512 6.92202 6.43317 6.96555 6.54698 7.13304L7.8088 8.9901L9.07062 7.13304C9.18443 6.96555 9.41248 6.92202 9.57997 7.03583C9.74747 7.14964 9.79099 7.37769 9.67718 7.54519L8.2521 9.64252L9.84776 11.9909C9.96157 12.1584 9.91805 12.3864 9.75055 12.5002C9.58305 12.614 9.35501 12.5705 9.2412 12.403L7.8088 10.2949Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ew=(0,S.forwardRef)(function(e,t){return(0,S.createElement)(el,Object.assign({},e,{id:"xlsx",ref:t,icon:eb}))});ew.displayName="Xlsx";let eR={cellLink:"univer-cell-link",cellLinkType:"univer-cell-link-type",cellLinkContent:"univer-cell-link-content",cellLinkContentError:"univer-cell-link-content-error",cellLinkUrl:"univer-cell-link-url",cellLinkOperations:"univer-cell-link-operations",cellLinkOperation:"univer-cell-link-operation",cellLinkOperationError:"univer-cell-link-operation-error"},eE={[c.SheetHyperLinkType.URL]:/* @__PURE__ */W.jsx(e_,{}),[c.SheetHyperLinkType.SHEET]:/* @__PURE__ */W.jsx(ew,{}),[c.SheetHyperLinkType.RANGE]:/* @__PURE__ */W.jsx(ep,{}),[c.SheetHyperLinkType.DEFINE_NAME]:/* @__PURE__ */W.jsx(ep,{}),[c.SheetHyperLinkType.INVALID]:/* @__PURE__ */W.jsx(ep,{})},eT=/* @__PURE__ */E(()=>{var e,t;let r=(0,o.useDependency)(ek),n=(0,o.useDependency)(o.ICommandService),i=(0,o.useDependency)(m.IMessageService),a=(0,o.useDependency)(o.LocaleService),[s,l]=(0,S.useState)(null),d=(0,o.useDependency)(er),u=(0,o.useDependency)(h.IEditorBridgeService);if((0,S.useEffect)(()=>{l(r.currentPopup);let e=r.currentPopup$.subscribe(e=>{l(e)});return()=>{e.unsubscribe()}},[r.currentPopup,r.currentPopup$]),!s)return null;let{unitId:p,subUnitId:g,customRange:f,row:v,col:_}=s;if(!(null!=(e=null==f?void 0:f.properties)&&e.url))return null;let I=d.parseHyperLink(null!=(t=f.properties.url)?t:""),y=I.type===c.SheetHyperLinkType.INVALID;return /* @__PURE__ */W.jsxs("div",{className:eR.cellLink,onClick:/* @__PURE__ */E(()=>r.hideCurrentPopup(),"onClick"),children:[/* @__PURE__ */W.jsxs("div",{className:(0,b.default)(eR.cellLinkContent,{[eR.cellLinkContentError]:y}),onClick:I.handler,children:[/* @__PURE__ */W.jsx("div",{className:eR.cellLinkType,children:eE[I.type]}),/* @__PURE__ */W.jsx(C.Tooltip,{showIfEllipsis:!0,title:I.name,children:/* @__PURE__ */W.jsx("span",{className:eR.cellLinkUrl,children:I.name})})]}),/* @__PURE__ */W.jsxs("div",{className:eR.cellLinkOperations,children:[s.copyPermission&&/* @__PURE__ */W.jsx("div",{className:(0,b.default)(eR.cellLinkOperation,{[eR.cellLinkOperationError]:y}),onClick:/* @__PURE__ */E(()=>{if(!y){if(I.type!==c.SheetHyperLinkType.URL){let e=new URL(window.location.href);e.hash=I.url.slice(1),navigator.clipboard.writeText(e.href)}else navigator.clipboard.writeText(I.url);i.show({content:a.t("hyperLink.message.coped"),type:C.MessageType.Info})}},"onClick"),children:/* @__PURE__ */W.jsx(C.Tooltip,{placement:"bottom",title:a.t("hyperLink.popup.copy"),children:/* @__PURE__ */W.jsx(ef,{})})}),s.editPermission&&/* @__PURE__ */W.jsxs(W.Fragment,{children:[/* @__PURE__ */W.jsx("div",{className:eR.cellLinkOperation,onClick:/* @__PURE__ */E(()=>{n.executeCommand(eL.id,{unitId:p,subUnitId:g,row:v,col:_,customRangeId:f.rangeId,type:s.type})},"onClick"),children:/* @__PURE__ */W.jsx(C.Tooltip,{placement:"bottom",title:a.t("hyperLink.popup.edit"),children:/* @__PURE__ */W.jsx(ey,{})})}),/* @__PURE__ */W.jsx("div",{className:eR.cellLinkOperation,onClick:/* @__PURE__ */E(()=>{let e=s.type===N.EDITING||s.type===N.ZEN_EDITOR?U.id:D.id;n.syncExecuteCommand(e,{unitId:p,subUnitId:g,id:f.rangeId,row:v,column:_,documentId:s.type===N.ZEN_EDITOR?o.DOCS_ZEN_EDITOR_UNIT_ID_KEY:u.getCurrentEditorId()})&&r.hideCurrentPopup(void 0,!0)},"onClick"),children:/* @__PURE__ */W.jsx(C.Tooltip,{placement:"bottom",title:a.t("hyperLink.popup.cancel"),children:/* @__PURE__ */W.jsx(eS,{})})})]})]})]})},"CellLinkPopup");eT.componentKey="univer.sheet.cell-link-popup";var eM=Object.defineProperty,eO=Object.getOwnPropertyDescriptor,eD=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eO(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eM(t,r,a),a},"__decorateClass$b"),eU=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$b");let eP=/* @__PURE__ */E((e,t)=>{var r,n;return e.unitId===t.unitId&&e.subUnitId===t.subUnitId&&e.row===t.row&&e.col===t.col&&(null==(r=e.customRange)?void 0:r.rangeId)===(null==(n=t.customRange)?void 0:n.rangeId)&&e.type===t.type},"isEqualLink"),ek=(eB=class extends o.Disposable{constructor(e,t,r,n,i,a,o,s,l){super(),T(this,"_currentPopup",null),T(this,"_currentPopup$",new I.Subject),T(this,"currentPopup$",this._currentPopup$.asObservable()),T(this,"_currentEditingPopup",null),T(this,"_currentEditing$",new p.BehaviorSubject(null)),T(this,"currentEditing$",this._currentEditing$.asObservable()),this._sheetCanvasPopManagerService=e,this._injector=t,this._univerInstanceService=r,this._editorBridgeService=n,this._textSelectionManagerService=i,this._docCanvasPopManagerService=a,this._editorService=o,this._rangeSelectorService=s,this._zenZoneService=l,this.disposeWithMe(()=>{this.hideCurrentPopup(),this.endEditing(),this._currentEditing$.complete(),this._currentPopup$.complete()})}get currentPopup(){return this._currentPopup}get currentEditing(){return this._currentEditing$.getValue()}showPopup(e){let t;if(this._currentPopup&&eP(e,this._currentPopup)||(this.hideCurrentPopup(void 0,!0),e.type!==N.ZEN_EDITOR&&this._zenZoneService.visible))return;let r=this._currentEditing$.getValue();if(r&&eP(e,r))return;let{unitId:n,subUnitId:i,row:a,col:s,customRangeRect:l,customRange:d}=e;if(!d)return;let u={componentKey:eT.componentKey,direction:"bottom",onClickOutside:/* @__PURE__ */E(()=>{this.hideCurrentPopup()},"onClickOutside"),onClick:/* @__PURE__ */E(()=>{this.hideCurrentPopup(e.type,!0)},"onClick")};(t=e.type===N.EDITING?l&&this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(l,u):e.type===N.ZEN_EDITOR?this._docCanvasPopManagerService.attachPopupToRange({startOffset:d.startIndex,endOffset:d.endIndex+1,collapsed:!1},u,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY):l&&this._sheetCanvasPopManagerService.attachPopupByPosition(l,u))&&(this._currentPopup={unitId:n,subUnitId:i,disposable:t,row:a,col:s,editPermission:!!e.editPermission,copyPermission:!!e.copyPermission,customRange:d,type:e.type},this._currentPopup$.next(this._currentPopup))}hideCurrentPopup(e,t){var r,n;this._currentPopup&&((!e||e===this._currentPopup.type)&&this._currentPopup.disposable.canDispose()||t)&&(null==(n=null==(r=this._currentPopup)?void 0:r.disposable)||n.dispose(),this._currentPopup=null,this._currentPopup$.next(null))}_getEditingRange(){var e,t,r;let n=this._editorBridgeService.isVisible().visible,i=this._editorBridgeService.getEditCellState();if(n&&i){let n=this._textSelectionManagerService.getActiveTextRange(),a=null==(e=i.documentLayoutObject.documentModel)?void 0:e.getBody();if(!a)return null;if(!n||n.collapsed)return{startOffset:0,endOffset:a.dataStream.length-2,collapsed:a.dataStream.length-2==0,label:(0,o.BuildTextUtils).transform.getPlainText(a.dataStream)};let s=(0,o.BuildTextUtils).customRange.getCustomRangesInterestsWithRange(n,null!=(r=null==(t=a.customRanges)?void 0:t.filter(e=>e.rangeType===o.CustomRangeType.HYPERLINK))?r:[]),l=n.startOffset,d=n.endOffset;return s.forEach(e=>{l=Math.min(l,e.startIndex),d=Math.max(d,e.endIndex+1)}),{startOffset:l,endOffset:d,collapsed:l===d,label:(0,o.BuildTextUtils).transform.getPlainText(a.dataStream.slice(l,d))}}return null}get _editPopup(){return{componentKey:ea.componentKey,direction:"bottom",onClickOutside:/* @__PURE__ */E(()=>{let e=(0,o.createInternalEditorID)("hyper-link-edit");this._editorService.getFocusId()!==e&&(this._rangeSelectorService.getCurrentSelectorId()===e&&this._rangeSelectorService.selectorModalVisible||this.endEditing())},"onClickOutside"),hiddenType:"hide"}}startAddEditing(e){var t,r,n,i,a;let{unitId:s,subUnitId:l,type:d}=e;if(d===N.ZEN_EDITOR){let r=this._univerInstanceService.getUnit(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,o.UniverInstanceType.UNIVER_DOC);if(!r)return;let n=this._textSelectionManagerService.getActiveTextRange();if(!n)return;this._currentEditingPopup=this._docCanvasPopManagerService.attachPopupToRange(n,this._editPopup,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY);let i=null==(t=r.getBody())?void 0:t.dataStream.slice(n.startOffset,n.endOffset-1);this._currentEditing$.next({...e,label:i})}else if(d===N.EDITING){let t=this._getEditingRange();t&&this._textSelectionManagerService.replaceTextRanges([{...t}]),this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToCell(e.row,e.col,this._editPopup,s,l),this._currentEditing$.next({...e,label:null!=(r=null==t?void 0:t.label)?r:""})}else{this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToCell(e.row,e.col,this._editPopup,s,l);let t=this._univerInstanceService.getUnit(s,o.UniverInstanceType.UNIVER_SHEET),r=null==t?void 0:t.getSheetBySheetId(l),d=null==r?void 0:r.getCellRaw(e.row,e.col);this._currentEditing$.next({...e,label:null!=d&&d.p?(0,o.BuildTextUtils).transform.getPlainText(null!=(i=null==(n=d.p.body)?void 0:n.dataStream)?i:""):(null!=(a=null==d?void 0:d.v)?a:"").toString()})}}startEditing(e){var t,r,n,i,a,s;let l,d;null==(t=this._currentEditingPopup)||t.dispose(),this.hideCurrentPopup(void 0,!0);let{unitId:u,subUnitId:c}=e;if(e.type===N.ZEN_EDITOR){let t=this._univerInstanceService.getUnit(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,o.UniverInstanceType.UNIVER_DOC);if(d=(l=null==(n=null==(r=null==t?void 0:t.getBody())?void 0:r.customRanges)?void 0:n.find(t=>t.rangeId===e.customRangeId))?null==(i=null==t?void 0:t.getBody())?void 0:i.dataStream.slice(l.startIndex+1,l.endIndex):"",!l||!d)return;this._textSelectionManagerService.replaceTextRanges([{startOffset:l.startIndex,endOffset:l.endIndex+1}]),this._currentEditingPopup=this._docCanvasPopManagerService.attachPopupToRange({startOffset:l.startIndex,endOffset:l.endIndex,collapsed:!1},this._editPopup,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY)}else if(e.type===N.EDITING){let t=(0,h.getEditingCustomRangePosition)(this._injector,e.unitId,e.subUnitId,e.row,e.col,e.customRangeId);if(!t||!(null!=(a=t.rects)&&a.length))return;l=t.customRange,d=t.label,this._textSelectionManagerService.replaceTextRanges([{startOffset:l.startIndex,endOffset:l.endIndex+1}]),this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(t.rects.pop(),this._editPopup,u,c)}else{let t=(0,h.getCustomRangePosition)(this._injector,e.unitId,e.subUnitId,e.row,e.col,e.customRangeId);if(!t||!(null!=(s=t.rects)&&s.length))return;l=t.customRange,d=t.label,this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupByPosition(t.rects.pop(),this._editPopup,u,c)}this._currentEditing$.next({...e,customRange:l,label:d})}endEditing(e){var t;let r=this._currentEditing$.getValue();r&&(!e||e===r.type)&&(null==(t=this._currentEditingPopup)||t.dispose(),this._currentEditing$.next(null))}},E(eB,"SheetsHyperLinkPopupService"),eB);ek=eD([eU(0,(0,o.Inject)(h.SheetCanvasPopManagerService)),eU(1,(0,o.Inject)(o.Injector)),eU(2,o.IUniverInstanceService),eU(3,h.IEditorBridgeService),eU(4,(0,o.Inject)(s.DocSelectionManagerService)),eU(5,(0,o.Inject)(l.DocCanvasPopManagerService)),eU(6,m.IEditorService),eU(7,m.IRangeSelectorService),eU(8,m.IZenZoneService)],ek);let eN=/* @__PURE__ */E((e,t,r)=>{let n=e.getCell(t,r);if(null!=n&&n.f||null!=n&&n.si)return!0;let i=[o.DataValidationType.CHECKBOX,o.DataValidationType.LIST,o.DataValidationType.LIST_MULTIPLE];return!!(null!=n&&n.dataValidation&&i.includes(n.dataValidation.rule.type))},"getShouldDisableCellLink"),eA=/* @__PURE__ */E(e=>{let t=e.get(o.IUniverInstanceService).getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(!t)return!0;let r=t.getActiveSheet(),n=e.get(u.SheetsSelectionsService).getCurrentSelections();return!n.length||eN(r,n[0].range.startRow,n[0].range.startColumn)},"getShouldDisableCurrentCellLink"),ex=/* @__PURE__ */E(e=>{var t;let r=e.get(s.DocSelectionManagerService),n=e.get(o.IUniverInstanceService),i=r.getDocRanges();if(!i.length||i.length>1)return!0;let a=i[0],l=n.getCurrentUnitForType(o.UniverInstanceType.UNIVER_DOC);if(!l||!a||a.collapsed)return!0;let d=l.getSelfOrHeaderFooterModel(a.segmentId).getBody(),u=null==d?void 0:d.paragraphs;if(!u)return!0;for(let e=0,t=u.length;e<t;e++){let t=u[e];if(a.startOffset<=t.startIndex&&a.endOffset>t.startIndex)return!0;if(t.startIndex>a.endOffset)break}return!(0,o.BuildTextUtils).customRange.getCustomRangesInterestsWithRange(a,null!=(t=d.customRanges)?t:[]).every(e=>e.rangeType===o.CustomRangeType.HYPERLINK)},"shouldDisableAddLink"),eL={type:o.CommandType.OPERATION,id:"sheet.operation.open-hyper-link-edit-panel",handler(e,t){if(!t)return!1;let r=e.get(ek);return t.customRangeId?r.startEditing(t):r.startAddEditing(t),!0}},eV={type:o.CommandType.OPERATION,id:"sheet.operation.close-hyper-link-popup",handler:e=>(e.get(ek).endEditing(),!0)},eF={type:o.CommandType.OPERATION,id:"sheet.operation.insert-hyper-link",handler(e){var t;let r=e.get(o.IUniverInstanceService),n=(0,u.getSheetCommandTarget)(r),i=e.get(h.IEditorBridgeService);if(!n)return!1;let a=e.get(o.ICommandService),s=e.get(u.SheetsSelectionsService).getCurrentLastSelection();if(!s)return!1;let l=s.range.startRow,d=s.range.startColumn,c=i.isVisible(),m=(null==(t=r.getFocusedUnit())?void 0:t.getUnitId())===o.DOCS_ZEN_EDITOR_UNIT_ID_KEY;return a.executeCommand(eL.id,{unitId:n.unitId,subUnitId:n.subUnitId,row:l,col:d,type:m?N.ZEN_EDITOR:c.visible?N.EDITING:N.VIEWING})}},ej={type:o.CommandType.OPERATION,id:"sheet.operation.insert-hyper-link-toolbar",handler(e){if(eA(e))return!1;let t=e.get(o.ICommandService);return e.get(ek).currentEditing?t.executeCommand(eV.id):t.executeCommand(eF.id)}},eH="SHEET_HYPER_LINK_UI_PLUGIN";var e$,eB,eW,eG=Object.defineProperty,eY=Object.getOwnPropertyDescriptor,ez=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eY(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eG(t,r,a),a},"__decorateClass$a"),eK=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$a");let eq=(eW=class extends o.Disposable{constructor(e,t,r,n){super(),T(this,"_plainTextFilter",/* @__PURE__ */new Set),T(this,"_copyInfo"),this._sheetClipboardService=e,this._hyperLinkModel=t,this._injector=r,this._resolverService=n,this._initCopyPaste(),this.disposeWithMe(()=>{this._plainTextFilter.clear()})}registerPlainTextFilter(e){this._plainTextFilter.add(e)}removePlainTextFilter(e){this._plainTextFilter.delete(e)}_filterPlainText(e){return Array.from(this._plainTextFilter).every(t=>t(e))}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:eH,onBeforeCopy:/* @__PURE__ */E((e,t,r)=>this._collect(e,t,r),"onBeforeCopy"),onPasteCells:/* @__PURE__ */E((e,t,r,n)=>{let{copyType:i=h.COPY_TYPE.COPY,pasteType:a}=n,{range:o}=e||{},{range:s,unitId:l,subUnitId:d}=t;return this._generateMutations(s,{copyType:i,pasteType:a,copyRange:o,unitId:l,subUnitId:d})},"onPasteCells"),onPastePlainText:/* @__PURE__ */E((e,t)=>{let r=this._filterPlainText(t);if(G(t)&&r){let{range:t,unitId:r,subUnitId:n}=e,{ranges:[i],mapFunc:a}=(0,h.virtualizeDiscreteRanges)([t]),s=[],l=[];return(0,o.Range).foreach(i,(e,t)=>{let{row:i,col:o}=a(e,t),d=this._hyperLinkModel.getHyperLinkByLocation(r,n,i,o);d&&s.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:r,subUnitId:n,id:d.id}}),d&&l.push({id:c.AddHyperLinkMutation.id,params:{unitId:r,subUnitId:n,link:d}})}),{redos:s,undos:l}}return{undos:[],redos:[]}},"onPastePlainText"),priority:99})}_collect(e,t,r){let n=new o.ObjectMatrix;this._copyInfo={unitId:e,subUnitId:t,matrix:n};let i=this._injector.invoke(n=>(0,h.rangeToDiscreteRange)(r,n,e,t));if(!i)return;let{rows:a,cols:s}=i;a.forEach((r,i)=>{s.forEach((a,o)=>{var s;let l=this._hyperLinkModel.getHyperLinkByLocation(e,t,r,a);n.setValue(i,o,null!=(s=null==l?void 0:l.id)?s:"")})})}_generateMutations(e,t){if(!this._copyInfo||!this._copyInfo||!this._copyInfo.matrix.getSizeOf()||!t.copyRange||[(0,h.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_COL_WIDTH,(0,h.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_VALUE,(0,h.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMAT,(0,h.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMULA].includes(t.pasteType))return{redos:[],undos:[]};let{unitId:r,subUnitId:n}=this._copyInfo,i=[],a=[],{ranges:[s,l],mapFunc:d}=(0,h.virtualizeDiscreteRanges)([t.copyRange,e]);return(0,h.getRepeatRange)(s,l,!0).forEach(({startRange:e})=>{var s;null==(s=this._copyInfo)||s.matrix.forValue((s,l,u)=>{let h=(0,o.Rectangle).getPositionRange({startRow:s,endRow:s,startColumn:l,endColumn:l},e),m=this._hyperLinkModel.getHyperLink(r,n,u),{row:p,col:g}=d(h.startRow,h.startColumn),f=this._hyperLinkModel.getHyperLinkByLocation(t.unitId,t.subUnitId,p,g),v=(0,o.Tools).generateRandomId();f&&i.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,id:f.id}}),m&&(i.push({id:c.AddHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,link:{...m,id:v,row:p,column:g}}}),a.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,id:v}})),f&&a.push({id:c.AddHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,link:f}})})}),{redos:i,undos:a}}},E(eW,"SheetsHyperLinkCopyPasteController"),eW);eq=ez([(0,o.OnLifecycle)(o.LifecycleStages.Ready,eq),eK(0,h.ISheetClipboardService),eK(1,(0,o.Inject)(c.HyperLinkModel)),eK(2,(0,o.Inject)(o.Injector)),eK(3,(0,o.Inject)(er))],eq);let eX=/* @__PURE__ */E(e=>{let t=(0,h.getCurrentRangeDisable$)(e,{workbookTypes:[u.WorkbookEditablePermission],worksheetTypes:[u.WorksheetEditPermission,u.WorksheetSetCellValuePermission,u.WorksheetInsertHyperlinkPermission],rangeTypes:[u.RangeProtectionPermissionEditPoint]}),r=e.get(o.IUniverInstanceService),n=e.get(u.SheetsSelectionsService),i=r.focused$.pipe((0,f.map)(e=>e?r.getUnit(e,o.UniverInstanceType.UNIVER_SHEET):null),(0,v.mergeMap)(e=>e?e.activeSheet$:new _.Observable(e=>{e.next(null)})),(0,v.mergeMap)(e=>n.selectionMoveEnd$.pipe((0,f.map)(t=>e&&{selections:t,sheet:e}))),(0,f.map)(e=>{if(!e)return!0;let{selections:t,sheet:r}=e;return!t.length||eN(r,t[0].range.startRow,t[0].range.startColumn)}));return t.pipe((0,v.mergeMap)(e=>i.pipe((0,f.map)(t=>e||t))))},"getLinkDisable$"),eZ=/* @__PURE__ */E(e=>{let t=e.get(o.IUniverInstanceService);return t.focused$.pipe((0,v.mergeMap)(t=>t&&t===o.DOCS_ZEN_EDITOR_UNIT_ID_KEY?e.get(s.DocSelectionManagerService).textSelection$:new _.Observable(e=>e.next(null))),(0,f.map)(r=>{if(!r||r.unitId!==o.DOCS_ZEN_EDITOR_UNIT_ID_KEY)return!0;let n=e.get(h.IEditorBridgeService).getEditCellState();if(!n)return!0;let i=(0,u.getSheetCommandTarget)(t,{unitId:n.unitId,subUnitId:n.sheetId});return!!(!(null!=i&&i.worksheet)||eN(i.worksheet,n.row,n.column))||ex(e)}))},"getZenLinkDisable$"),eQ={commandId:eF.id,type:m.MenuItemType.BUTTON,positions:[m.MenuPosition.CONTEXT_MENU],title:"hyperLink.menu.add",icon:"LinkSingle"},eJ=/* @__PURE__ */E(e=>`${e}-zen-editor`,"genZenEditorMenuId"),e0=/* @__PURE__ */E(e=>({...eQ,id:eQ.commandId,hidden$:(0,m.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_SHEET),disabled$:eX(e)}),"insertLinkMenuFactory"),e1=/* @__PURE__ */E(e=>({...eQ,id:eJ(eQ.commandId),hidden$:(0,m.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_DOC,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY),disabled$:eZ(e)}),"zenEditorInsertLinkMenuFactory"),e3={tooltip:"hyperLink.form.addTitle",positions:m.MenuPosition.TOOLBAR_START,group:m.MenuGroup.TOOLBAR_OTHERS,commandId:ej.id,type:m.MenuItemType.BUTTON,icon:"LinkSingle"},e2=/* @__PURE__ */E(e=>({...e3,id:e3.commandId,hidden$:(0,m.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_SHEET),disabled$:eX(e)}),"insertLinkMenuToolbarFactory"),e4=/* @__PURE__ */E(e=>({...e3,id:eJ(e3.commandId),hidden$:(0,m.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_DOC,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY),disabled$:eZ(e)}),"zenEditorInsertLinkMenuToolbarFactory"),e9={id:ej.id,binding:m.KeyCode.K|m.MetaKeys.CTRL_COMMAND,preconditions:h.whenSheetEditorFocused};var e5,e6=Object.defineProperty,e8=Object.getOwnPropertyDescriptor,e7=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e8(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e6(t,r,a),a},"__decorateClass$9"),te=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let tt=(e5=class extends o.Disposable{constructor(e,t,r){super(),this._sheetInterceptorService=e,this._univerInstanceService=t,this._hyperLinkModel=r,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */E(e=>{var t;if(e.id===u.RemoveSheetCommand.id){let r=e.params,n=r.unitId?this._univerInstanceService.getUnit(r.unitId):this._univerInstanceService.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(!n)return{redos:[],undos:[]};let i=n.getUnitId(),a=r.subUnitId||(null==(t=n.getActiveSheet())?void 0:t.getSheetId());if(!a)return{redos:[],undos:[]};let s=this._hyperLinkModel.getSubUnit(i,a);return{redos:s.map(e=>({id:c.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:e.id}})),undos:s.map(e=>({id:c.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:e}}))}}return{redos:[],undos:[]}},"getMutations")}))}},E(e5,"SheetsHyperLinkRemoveSheetController"),e5);tt=e7([(0,o.OnLifecycle)(o.LifecycleStages.Ready,tt),te(0,(0,o.Inject)(u.SheetInterceptorService)),te(1,o.IUniverInstanceService),te(2,(0,o.Inject)(c.HyperLinkModel))],tt);var tr,tn=Object.defineProperty,ti=Object.getOwnPropertyDescriptor,ta=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ti(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tn(t,r,a),a},"__decorateClass$8"),to=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");let ts=(tr=class extends o.Disposable{constructor(e,t,r,n){super(),this._context=e,this._hyperLinkModel=t,this._sheetSkeletonManagerService=r,this._renderManagerService=n,this._initSkeletonChange()}_initSkeletonChange(){let e=/* @__PURE__ */E(()=>{var e;let t=this._context.unit,r=t.getUnitId(),n=null==(e=t.getActiveSheet())?void 0:e.getSheetId();if(!n){console.warn("No active sheet found");return}let i=this._sheetSkeletonManagerService.getOrCreateSkeleton({sheetId:n}),a=this._renderManagerService.getRenderById(r);null==i||i.makeDirty(!0),null==i||i.calculate(),a&&a.mainComponent.makeForceDirty()},"markSkeletonDirty");this.disposeWithMe(this._hyperLinkModel.linkUpdate$.pipe((0,g.debounceTime)(16)).subscribe(()=>{e()}))}},E(tr,"SheetsHyperLinkRenderController"),tr);ts=ta([to(1,(0,o.Inject)(c.HyperLinkModel)),to(2,(0,o.Inject)(h.SheetSkeletonManagerService)),to(3,d.IRenderManagerService)],ts);let tl=(td=class extends o.Disposable{constructor(e,t,r){super(),this._sheetInterceptorService=e,this._hyperLinkModel=t,this._themeService=r,this._initViewModelIntercept()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(u.INTERCEPTOR_POINT.CELL_CONTENT,{handler:/* @__PURE__ */E((e,t,r)=>{let{row:n,col:i,unitId:a,subUnitId:o}=t,s=this._hyperLinkModel.getHyperLinkByLocation(a,o,n,i);return r(s?{...e,linkUrl:s.payload,linkId:s.id}:e)},"handler"),priority:100}))}},E(td,"SheetsHyperLinkRenderManagerController"),td);tl=ta([(0,o.OnLifecycle)(o.LifecycleStages.Ready,tl),to(0,(0,o.Inject)(u.SheetInterceptorService)),to(1,(0,o.Inject)(c.HyperLinkModel)),to(2,(0,o.Inject)(o.ThemeService))],tl);var td,tu,tc=Object.defineProperty,th=Object.getOwnPropertyDescriptor,tm=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?th(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tc(t,r,a),a},"__decorateClass$7"),tp=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let tg=(tu=class extends o.Disposable{constructor(e,t,r,n,i,a){super(),this._sheetInterceptorService=e,this._hyperLinkModel=t,this._selectionManagerService=r,this._univerInstanceService=n,this._editorBridgeService=i,this._renderManagerService=a,this._initCommandInterceptor(),this._initAfterEditor()}_initCommandInterceptor(){this._initSetRangeValuesCommandInterceptor(),this._initClearSelectionCommandInterceptor()}_initSetRangeValuesCommandInterceptor(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */E(e=>{if(e.id===u.SetRangeValuesCommand.id){let t=e.params,{unitId:r,subUnitId:n}=t,i=[],a=[];return t.cellValue&&new(0,o.ObjectMatrix)(t.cellValue).forValue((e,t)=>{let o=this._hyperLinkModel.getHyperLinkByLocation(r,n,e,t);o&&(i.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:r,subUnitId:n,id:o.id}}),a.push({id:c.AddHyperLinkMutation.id,params:{unitId:r,subUnitId:n,link:o}}))}),{undos:a,redos:i}}return{redos:[],undos:[]}},"getMutations")}))}_initClearSelectionCommandInterceptor(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */E(e=>{if(e.id===u.ClearSelectionContentCommand.id||e.id===u.ClearSelectionAllCommand.id||e.id===u.ClearSelectionFormatCommand.id){let e=[],t=[],r=this._selectionManagerService.getCurrentLastSelection(),n=(0,u.getSheetCommandTarget)(this._univerInstanceService);if(r&&n){let{unitId:i,subUnitId:a}=n;(0,o.Range).foreach(r.range,(r,n)=>{let o=this._hyperLinkModel.getHyperLinkByLocation(i,a,r,n);o&&(e.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:o.id}}),t.push({id:c.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:o}}))})}return{redos:e,undos:t}}return{redos:[],undos:[]}},"getMutations")}))}_initAfterEditor(){this.disposeWithMe(this._editorBridgeService.interceptor.intercept(this._editorBridgeService.interceptor.getInterceptPoints().AFTER_CELL_EDIT,{handler:/* @__PURE__ */E((e,t,r)=>{if(!e||e.p)return r(e);if("string"==typeof e.v&&(0,o.Tools).isLegalUrl(e.v)&&" "!==e.v[e.v.length-1]){let{unitId:n,subUnitId:i}=t,a=this._renderManagerService.getRenderById(n),s=null==a?void 0:a.with(h.SheetSkeletonManagerService).getWorksheetSkeleton(i);if(!s)return r(e);let l=s.skeleton.getBlankCellDocumentModel(e);if(!l.documentModel)return r(e);let d=(0,o.BuildTextUtils).selection.replace({selection:{startOffset:0,endOffset:e.v.length,collapsed:!1},body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${e.v}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{startIndex:0,endIndex:e.v.length+1,rangeId:(0,o.generateRandomId)(),rangeType:o.CustomRangeType.HYPERLINK,properties:{url:e.v}}]},doc:l.documentModel});if(!d)return r(e);let u=l.documentModel.getBody();return(0,o.TextX).apply(u,d.serialize()),r({...e,p:{id:o.DOCS_NORMAL_EDITOR_UNIT_ID_KEY,body:u,documentStyle:{pageSize:{width:1/0,height:1/0}}}})}return r(e)},"handler")}))}},E(tu,"SheetHyperLinkSetRangeController"),tu);tg=tm([(0,o.OnLifecycle)(o.LifecycleStages.Starting,tg),tp(0,(0,o.Inject)(u.SheetInterceptorService)),tp(1,(0,o.Inject)(c.HyperLinkModel)),tp(2,(0,o.Inject)(u.SheetsSelectionsService)),tp(3,o.IUniverInstanceService),tp(4,h.IEditorBridgeService),tp(5,d.IRenderManagerService)],tg);var tf,tv=Object.defineProperty,t_=Object.getOwnPropertyDescriptor,tI=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?t_(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tv(t,r,a),a},"__decorateClass$6"),tS=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let tC=(E(tf=class extends o.Disposable{constructor(e,t,r,n,i,a,o,s,l,d){super(),this._hoverManagerService=e,this._sheetsHyperLinkPopupService=t,this._renderManagerService=r,this._permissionService=n,this._sheetPermissionInterceptorBaseController=i,this._commandService=a,this._editorBridgeService=o,this._textSelectionManagerService=s,this._univerInstanceService=l,this._zenZoneService=d,this._initHoverListener(),this._initCommandListener(),this._initHoverEditingListener(),this._initTextSelectionListener(),this._initZenEditor()}_getLinkPermission(e){let{unitId:t,subUnitId:r,row:n,col:i}=e;return{viewPermission:this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[u.WorkbookViewPermission],worksheetTypes:[u.WorksheetViewPermission],rangeTypes:[u.RangeProtectionPermissionViewPoint]},[{startRow:n,startColumn:i,endRow:n,endColumn:i}]),editPermission:this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[u.WorkbookEditablePermission],worksheetTypes:[u.WorksheetEditPermission,u.WorksheetInsertHyperlinkPermission],rangeTypes:[u.RangeProtectionPermissionEditPoint]},[{startRow:n,startColumn:i,endRow:n,endColumn:i}]),copyPermission:this._permissionService.composePermission([new u.WorkbookCopyPermission(t).id,new u.WorksheetCopyPermission(t,r).id]).every(e=>e.value)}}_initHoverListener(){this.disposeWithMe(this._hoverManagerService.currentRichText$.pipe((0,g.debounceTime)(200)).subscribe(e=>{var t;if(!e){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}let{unitId:r,subUnitId:n,row:i,col:a}=e,s=this._renderManagerService.getRenderById(r);if(!s)return;if(!s.with(h.HoverRenderController).active){this._sheetsHyperLinkPopupService.hideCurrentPopup(N.VIEWING);return}let l=null==(t=null==s?void 0:s.with(h.SheetSkeletonManagerService).getWorksheetSkeleton(n))?void 0:t.skeleton,d=i,u=a;l&&l.overflowCache.forValue((e,t,r)=>{(0,o.Rectangle).contains(r,{startColumn:a,endColumn:a,startRow:i,endRow:i})&&(d=e,u=t)});let{viewPermission:c,editPermission:m,copyPermission:p}=this._getLinkPermission(e);if(!c||!e.customRange){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}this._sheetsHyperLinkPopupService.showPopup({row:d,col:u,editPermission:m,copyPermission:p,customRange:e.customRange,customRangeRect:e.rect,type:N.VIEWING,unitId:r,subUnitId:n})}))}_initHoverEditingListener(){let e=null;this.disposeWithMe(this._editorBridgeService.currentEditCellState$.pipe((0,v.mergeMap)(e=>this._editorBridgeService.visible$.pipe((0,f.map)(t=>({visible:t,state:e}))))).subscribe(({visible:t,state:r})=>{if(!r||r.editorUnitId!==o.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)return;if(!t.visible){null==e||e.unsubscribe(),this._sheetsHyperLinkPopupService.hideCurrentPopup(N.EDITING),this._sheetsHyperLinkPopupService.endEditing(N.EDITING);return}let{editorUnitId:n,unitId:i,sheetId:a,row:s,column:d}=r,u=this._renderManagerService.getRenderById(n);if(!u)return;let{editPermission:c,viewPermission:m,copyPermission:p}=this._getLinkPermission({unitId:i,subUnitId:a,row:s,col:d}),f=u.with(l.DocEventManagerService);m&&(null==e||e.unsubscribe(),e=f.hoverCustomRanges$.pipe((0,g.debounceTime)(200)).subscribe(e=>{var t,r;let n=e.find(e=>e.range.rangeType===o.CustomRangeType.HYPERLINK);if(!n){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}let l=n.rects[n.rects.length-1];if(!(null==(r=null==(t=this._renderManagerService.getRenderById(i))?void 0:t.with(h.SheetSkeletonManagerService).getWorksheetSkeleton(a))?void 0:r.skeleton)||!l)return;let m=u.engine.getCanvasElement().getBoundingClientRect();this._sheetsHyperLinkPopupService.showPopup({unitId:i,subUnitId:a,row:s,col:d,customRange:n.range,customRangeRect:{left:l.left+m.left,top:l.top+m.top,bottom:l.bottom+m.top,right:l.right+m.left},editPermission:c,copyPermission:p,type:N.EDITING})}))})),this.disposeWithMe(()=>{null==e||e.unsubscribe()})}_initZenEditor(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&(this._sheetsHyperLinkPopupService.hideCurrentPopup(N.VIEWING),this._sheetsHyperLinkPopupService.hideCurrentPopup(N.EDITING),this._sheetsHyperLinkPopupService.endEditing(N.EDITING),this._sheetsHyperLinkPopupService.hideCurrentPopup(N.VIEWING))})),this.disposeWithMe(this._univerInstanceService.focused$.pipe((0,v.mergeMap)(e=>{let t=e===o.DOCS_ZEN_EDITOR_UNIT_ID_KEY?this._renderManagerService.getRenderById(e):null;return t?t.with(l.DocEventManagerService).hoverCustomRanges$.pipe((0,g.debounceTime)(200)):new _.Observable(e=>{e.next(null)})})).subscribe(e=>{let t=null==e?void 0:e.find(e=>e.range.rangeType===o.CustomRangeType.HYPERLINK),r=this._editorBridgeService.getEditCellState();if(t&&r){let{unitId:e,sheetId:n,row:i,column:a}=r,{editPermission:o,viewPermission:s,copyPermission:l}=this._getLinkPermission({unitId:e,subUnitId:n,row:i,col:a});s&&this._sheetsHyperLinkPopupService.showPopup({type:N.ZEN_EDITOR,unitId:e,subUnitId:n,row:i,col:a,customRange:t.range,editPermission:o,copyPermission:l})}else this._sheetsHyperLinkPopupService.hideCurrentPopup(N.ZEN_EDITOR)}))}_initTextSelectionListener(){this.disposeWithMe(this._textSelectionManagerService.textSelection$.subscribe(e=>{e&&e.unitId===o.DOCS_NORMAL_EDITOR_UNIT_ID_KEY&&this._sheetsHyperLinkPopupService.endEditing(N.EDITING)}))}_initCommandListener(){let e=[u.ClearSelectionContentCommand.id,u.ClearSelectionAllCommand.id,u.ClearSelectionFormatCommand.id];this.disposeWithMe(this._commandService.onCommandExecuted(t=>{e.includes(t.id)&&this._sheetsHyperLinkPopupService.hideCurrentPopup()}))}},"SheetsHyperLinkPopupController"),tf);tC=tI([(0,o.OnLifecycle)(o.LifecycleStages.Rendered,tC),tS(0,(0,o.Inject)(h.HoverManagerService)),tS(1,(0,o.Inject)(ek)),tS(2,(0,o.Inject)(d.IRenderManagerService)),tS(3,(0,o.Inject)(o.IPermissionService)),tS(4,(0,o.Inject)(h.SheetPermissionInterceptorBaseController)),tS(5,o.ICommandService),tS(6,h.IEditorBridgeService),tS(7,(0,o.Inject)(s.DocSelectionManagerService)),tS(8,o.IUniverInstanceService),tS(9,m.IZenZoneService)],tC);let ty={[m.RibbonStartGroup.OTHERS]:{[ej.id]:{order:2,menuItemFactory:e2},[eJ(ej.id)]:{order:2,menuItemFactory:e4}},[m.ContextMenuPosition.MAIN_AREA]:{[m.ContextMenuGroup.OTHERS]:{order:1,[ej.id]:{order:0,menuItemFactory:e0},[eJ(ej.id)]:{order:0,menuItemFactory:e1}}}};var tb,tw=Object.defineProperty,tR=Object.getOwnPropertyDescriptor,tE=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tR(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tw(t,r,a),a},"__decorateClass$5"),tT=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let tM=(E(tb=class extends o.Disposable{constructor(e,t,r,n,i){super(),this._componentManager=e,this._commandService=t,this._menuManagerService=r,this._injector=n,this._shortcutService=i,this._initComponents(),this._initCommands(),this._initMenus(),this._initShortCut()}_initComponents(){[[eT,eT.componentKey],[ea,ea.componentKey],[e_,"LinkSingle"]].forEach(([e,t])=>{this._componentManager.register(t,e)})}_initCommands(){[eL,eV,eF,ej,M,P,D,k,U,O].forEach(e=>{this._commandService.registerCommand(e)})}_initMenus(){this._menuManagerService.mergeMenu(ty)}_initShortCut(){this._shortcutService.registerShortcut(e9)}},"SheetsHyperLinkUIController"),tb);tM=tE([(0,o.OnLifecycle)(o.LifecycleStages.Ready,tM),tT(0,(0,o.Inject)(m.ComponentManager)),tT(1,o.ICommandService),tT(2,m.IMenuManagerService),tT(3,(0,o.Inject)(o.Injector)),tT(4,(0,o.Inject)(m.IShortcutService))],tM);var tO,tD=Object.defineProperty,tU=Object.getOwnPropertyDescriptor,tP=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tU(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tD(t,r,a),a},"__decorateClass$4"),tk=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let tN=(tO=class extends o.Disposable{constructor(e,t){super(),this._autoFillService=e,this._hyperLinkModel=t,this._initAutoFill()}_initAutoFill(){let e=/* @__PURE__ */E(()=>({redos:[],undos:[]}),"noopReturnFunc"),t=/* @__PURE__ */E((e,t)=>{let{source:r,target:n,unitId:i,subUnitId:a}=e,s=(0,h.virtualizeDiscreteRanges)([r,n]),[l,d]=s.ranges,{mapFunc:u}=s,m={row:l.startRow,col:l.startColumn},p=(0,h.getAutoFillRepeatRange)(l,d),g=[],f=[];return p.forEach(e=>{let r=e.repeatStartCell,n=e.relativeRange,s={startRow:m.row,startColumn:m.col,endColumn:m.col,endRow:m.row},l={startRow:r.row,startColumn:r.col,endColumn:r.col,endRow:r.row};(0,o.Range).foreach(n,(e,r)=>{let n=(0,o.Rectangle).getPositionRange({startRow:e,startColumn:r,endColumn:r,endRow:e},s),{row:d,col:m}=u(n.startRow,n.startColumn),p=this._hyperLinkModel.getHyperLinkByLocation(i,a,d,m),v=(0,o.Rectangle).getPositionRange({startRow:e,startColumn:r,endColumn:r,endRow:e},l),{row:_,col:I}=u(v.startRow,v.startColumn),S=(0,o.Tools).generateRandomId(),C=this._hyperLinkModel.getHyperLinkByLocation(i,a,_,I);C&&g.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:C.id}}),(h.APPLY_TYPE.COPY===t||h.APPLY_TYPE.SERIES===t)&&p&&(g.push({id:c.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:{...p,id:S,row:_,column:I}}}),f.push({id:c.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:S}})),C&&f.push({id:c.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:C}})})}),{undos:f,redos:g}},"generalApplyFunc"),r={id:eH,onFillData:/* @__PURE__ */E((r,n,i)=>i===h.APPLY_TYPE.COPY||i===h.APPLY_TYPE.ONLY_FORMAT||i===h.APPLY_TYPE.SERIES?t(r,i):e(),"onFillData")};this.disposeWithMe(this._autoFillService.addHook(r))}},E(tO,"SheetsHyperLinkAutoFillController"),tO);tN=tP([(0,o.OnLifecycle)(o.LifecycleStages.Ready,tN),tk(0,h.IAutoFillService),tk(1,(0,o.Inject)(c.HyperLinkModel))],tN);var tA,tx=Object.defineProperty,tL=Object.getOwnPropertyDescriptor,tV=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tL(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tx(t,r,a),a},"__decorateClass$3"),tF=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let tj=(E(tA=class extends o.Disposable{constructor(e){super(),this._resolverService=e,this._handleInitUrl()}_handleInitUrl(){let e=location.hash;e&&this._resolverService.parseHyperLink(e).handler()}},"SheetHyperLinkUrlController"),tA);tj=tV([(0,o.OnLifecycle)(o.LifecycleStages.Rendered,tj),tF(0,(0,o.Inject)(er))],tj);var tH,t$=Object.defineProperty,tB=Object.getOwnPropertyDescriptor,tW=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tB(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&t$(t,r,a),a},"__decorateClass$2"),tG=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let tY=(E(tH=class extends o.Disposable{constructor(e,t,r){super(),this._localeService=e,this._commandService=t,this._sheetPermissionInterceptorBaseController=r,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{e.id===e9.id&&(this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[u.WorkbookEditablePermission],rangeTypes:[u.RangeProtectionPermissionEditPoint],worksheetTypes:[u.WorksheetEditPermission,u.WorksheetSetCellValuePermission,u.WorksheetInsertHyperlinkPermission]})||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.hyperLinkErr")))}))}},"SheetsHyperLinkPermissionController"),tH);tY=tW([(0,o.OnLifecycle)(o.LifecycleStages.Rendered,tY),tG(0,(0,o.Inject)(o.LocaleService)),tG(1,o.ICommandService),tG(2,(0,o.Inject)(h.SheetPermissionInterceptorBaseController))],tY);var tz,tK=Object.defineProperty,tq=Object.getOwnPropertyDescriptor,tX=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tq(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tK(t,r,a),a},"__decorateClass$1"),tZ=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let tQ=(tz=class extends o.Disposable{constructor(e,t,r){super(),T(this,"_refRangeMap",/* @__PURE__ */new Map),this._commandService=e,this._univerInstanceService=t,this._refRangeService=r,this._initWorkbookLoad(),this._initWorkbookUnload(),this._initSetRangesListener()}_enusreMap(e,t){let r=this._refRangeMap.get(e);r||(r=/* @__PURE__ */new Map,this._refRangeMap.set(e,r));let n=r.get(t);return n||(n=new o.ObjectMatrix,r.set(t,n)),n}_isLegalRangeUrl(e,t){var r,n,i;let a=this._univerInstanceService.getUnit(e,o.UniverInstanceType.UNIVER_SHEET);if(!a)return null;if(t&&t.startsWith("#")){let e=new URLSearchParams(t.slice(1)),s={gid:null!=(r=e.get("gid"))?r:"",range:null!=(n=e.get("range"))?n:"",rangeid:null!=(i=e.get("rangeid"))?i:""};if(s.range&&s.gid){let e=s.gid,t=a.getSheetBySheetId(e);if(!t)return null;let r=(0,y.deserializeRangeWithSheet)(s.range).range;if((0,o.isValidRange)(r,t)&&s.range!==c.ERROR_RANGE)return r}}return null}_registerRange(e,t,r,n,i){var a,s,l,d;let h=this._enusreMap(e,t),m=(0,o.Tools).deepClone(i),p=/* @__PURE__ */E(i=>{var a,s;let l=(0,o.Tools).deepClone(m);null==(s=null==(a=l.body)?void 0:a.customRanges)||s.forEach(r=>{var n;if(r.rangeType===o.CustomRangeType.HYPERLINK){let a=null==(n=r.properties)?void 0:n.url,o=this._isLegalRangeUrl(e,a);if(o){let e=(0,u.handleDefaultRangeChangeWithEffectRefCommands)(o,i),n=`#gid=${t}&range=${e?(0,y.serializeRange)(e):c.ERROR_RANGE}`;r.properties.url=n}}});let d=(0,u.handleDefaultRangeChangeWithEffectRefCommands)({startRow:r,endRow:r,startColumn:n,endColumn:n},i);return d?{redos:[{id:u.SetRangeValuesMutation.id,params:{unitId:e,subUnitId:t,cellValue:{[d.startRow]:{[d.startColumn]:{p:l}}}}}],undos:[{id:u.SetRangeValuesMutation.id,params:{unitId:e,subUnitId:t,cellValue:{[r]:{[n]:{p:m}}}}}]}:{redos:[],undos:[]}},"handleRangeChange");if(null!=(s=null==(a=i.body)?void 0:a.customRanges)&&s.some(t=>{var r;return t.rangeType===o.CustomRangeType.HYPERLINK&&this._isLegalRangeUrl(e,null==(r=t.properties)?void 0:r.url)})){let a=new o.DisposableCollection;null==(d=null==(l=i.body)?void 0:l.customRanges)||d.forEach(r=>{var n;if(r.rangeType===o.CustomRangeType.HYPERLINK){let i=null==(n=r.properties)?void 0:n.url,o=this._isLegalRangeUrl(e,i);o&&a.add(this._refRangeService.registerRefRange(o,p,e,t))}}),h.setValue(r,n,a)}}_initWorkbookLoad(){let e=/* @__PURE__ */E(e=>{let t=e.getUnitId();e.getSheets().forEach(e=>{let r=e.getSheetId(),n=this._enusreMap(t,r);e.getCellMatrix().forValue((e,i,a)=>{let o=n.getValue(e,i);o&&o.dispose(),a&&a.p&&this._registerRange(t,r,e,i,a.p)})})},"handleWorkbook");this._univerInstanceService.getAllUnitsForType(o.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this.disposeWithMe(this._univerInstanceService.unitAdded$.subscribe(t=>{t.type===o.UniverInstanceType.UNIVER_SHEET&&e(t)}))}_initWorkbookUnload(){this._univerInstanceService.unitDisposed$.subscribe(e=>{if(e.type===o.UniverInstanceType.UNIVER_SHEET){let t=e.getUnitId();e.getSheets().forEach(e=>{let r=e.getSheetId();this._enusreMap(t,r).forValue((e,t,r)=>{r&&r.dispose()})}),this._refRangeMap.delete(t)}})}_initSetRangesListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===u.SetRangeValuesMutation.id){let{unitId:t,subUnitId:r,cellValue:n}=e.params,i=this._enusreMap(t,r);n&&new(0,o.ObjectMatrix)(n).forValue((e,n,a)=>{let o=i.getValue(e,n);o&&o.dispose(),a&&a.p&&this._registerRange(t,r,e,n,a.p)})}}))}},E(tz,"SheetsHyperLinkRichTextRefRangeController"),tz);tQ=tX([(0,o.OnLifecycle)(o.LifecycleStages.Starting,tQ),tZ(0,o.ICommandService),tZ(1,o.IUniverInstanceService),tZ(2,(0,o.Inject)(u.RefRangeService))],tQ);var tJ,t0=Object.defineProperty,t1=Object.getOwnPropertyDescriptor,t3=/* @__PURE__ */E((e,t,r)=>t in e?t0(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),t2=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?t1(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&t0(t,r,a),a},"__decorateClass"),t4=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),t9=/* @__PURE__ */E((e,t,r)=>t3(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let t5=(E(tJ=class extends o.Plugin{constructor(e=X,t,r,n){super(),this._config=e,this._injector=t,this._renderManagerService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(q,a)}onStarting(){[[er],[ek],[en],[tt],[tl],[tg],[tC],[tM],[tN],[eq],[tY],[tj],[tQ]].forEach(e=>this._injector.add(e))}onReady(){[[ts]].forEach(e=>this._renderManagerService.registerRenderModule(o.UniverInstanceType.UNIVER_SHEET,e))}},"UniverSheetsHyperLinkUIPlugin"),tJ);t9(t5,"pluginName",eH),t9(t5,"type",o.UniverInstanceType.UNIVER_SHEET),t2([(0,o.DependentOn)(c.UniverSheetsHyperLinkPlugin,l.UniverDocsUIPlugin),t4(1,(0,o.Inject)(o.Injector)),t4(2,d.IRenderManagerService),t4(3,o.IConfigService)],t5)}),i("1SQ85",function(t,r){let i,a;e(t.exports,"HyperLinkModel",function(){return I}),e(t.exports,"SheetHyperLinkType",function(){return S}),e(t.exports,"AddHyperLinkMutation",function(){return C}),e(t.exports,"UpdateHyperLinkMutation",function(){return y}),e(t.exports,"UpdateHyperLinkRefMutation",function(){return b}),e(t.exports,"RemoveHyperLinkMutation",function(){return w}),e(t.exports,"ERROR_RANGE",function(){return P}),e(t.exports,"UniverSheetsHyperLinkPlugin",function(){return ee});var o,s=n("2Ha4T"),l=n("83KcA"),d=n("ls2nu"),u=n("kkAWv"),c=Object.defineProperty,h=(e,t,r)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,m=(e,t)=>c(e,"name",{value:t,configurable:!0}),p=(e,t,r)=>h(e,"symbol"!=typeof t?t+"":t,r),g=Object.defineProperty,f=Object.getOwnPropertyDescriptor,v=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?f(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&g(t,r,a),a},"__decorateClass$4"),_=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let I=(o=class extends l.Disposable{constructor(e){super(),p(this,"_linkUpdate$",new s.Subject),p(this,"linkUpdate$",this._linkUpdate$.asObservable()),p(this,"_linkMap",/* @__PURE__ */new Map),p(this,"_linkPositionMap",/* @__PURE__ */new Map),this._univerInstanceService=e,this.disposeWithMe({dispose:/* @__PURE__ */m(()=>{this._linkUpdate$.complete()},"dispose")})}_ensureMap(e,t){let r=this._linkMap.get(e);r||(r=/* @__PURE__ */new Map,this._linkMap.set(e,r));let n=r.get(t);n||(n=new l.ObjectMatrix,r.set(t,n));let i=this._linkPositionMap.get(e);i||(i=/* @__PURE__ */new Map,this._linkPositionMap.set(e,i));let a=i.get(t);return a||(a=/* @__PURE__ */new Map,i.set(t,a)),{matrix:n,positionMap:a}}addHyperLink(e,t,r){let{matrix:n,positionMap:i}=this._ensureMap(e,t);return n.setValue(r.row,r.column,r),i.set(r.id,{row:r.row,column:r.column,link:r}),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:r,type:"add"}),!0}updateHyperLink(e,t,r,n,i=!1){let{matrix:a,positionMap:o}=this._ensureMap(e,t),s=o.get(r);if(!s)return!0;let l=a.getValue(s.row,s.column);return l&&(Object.assign(l,n),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:{display:l.display,payload:l.payload},id:r,type:"update",silent:i})),!0}updateHyperLinkRef(e,t,r,n,i=!1){let{matrix:a,positionMap:o}=this._ensureMap(e,t),s=o.get(r);if(!s)return!0;let l=a.getValue(s.row,s.column);return l&&l.id===r?a.realDeleteValue(s.row,s.column):l=s.link,Object.assign(l,n),o.set(r,{...n,link:l}),a.setValue(n.row,n.column,l),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:n,id:r,type:"updateRef",silent:i}),!0}removeHyperLink(e,t,r){let{matrix:n,positionMap:i}=this._ensureMap(e,t),a=i.get(r);if(!a)return!1;i.delete(r);let o=n.getValue(a.row,a.column);return o&&o.id===r&&n.realDeleteValue(a.row,a.column),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:a.link,type:"remove"}),!0}getHyperLink(e,t,r){let{matrix:n,positionMap:i}=this._ensureMap(e,t),a=i.get(r);if(a)return n.getValue(a.row,a.column)}getHyperLinkByLocation(e,t,r,n){let{matrix:i}=this._ensureMap(e,t);return i.getValue(r,n)}getHyperLinkByLocationSync(e,t,r,n){var i,a,o,s,d;let{matrix:u}=this._ensureMap(e,t),c=this._univerInstanceService.getUnit(e,l.UniverInstanceType.UNIVER_SHEET),h=null==(i=null==c?void 0:c.getSheetBySheetId(t))?void 0:i.getCellRaw(r,n),m=(null!=(d=null!=(s=null==h?void 0:h.v)?s:null==(o=null==(a=null==h?void 0:h.p)?void 0:a.body)?void 0:o.dataStream.slice(0,-2))?d:"").toString(),p=u.getValue(r,n);if(p)return{...p,display:m}}getSubUnit(e,t){let{matrix:r}=this._ensureMap(e,t),n=[];return r.forValue((e,t,r)=>{r&&n.push(r)}),n}getUnit(e){let t=this._linkMap.get(e);return t?Array.from(t.keys()).map(t=>{let r=this.getSubUnit(e,t);return{unitId:e,subUnitId:t,links:r}}):[]}deleteUnit(e){let t=this.getUnit(e);this._linkMap.delete(e),this._linkPositionMap.delete(e),this._linkUpdate$.next({type:"unload",unitId:e,unitLinks:t})}getAll(){return Array.from(this._linkMap.keys()).map(e=>this.getUnit(e))}},m(o,"HyperLinkModel"),o);I=v([_(0,l.IUniverInstanceService)],I);var S=((i=S||{}).SHEET="gid",i.RANGE="range",i.DEFINE_NAME="rangeid",i.INVALID="invalid",i.URL="url",i);let C={type:l.CommandType.MUTATION,id:"sheets.mutation.add-hyper-link",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,link:a}=t;return r.addHyperLink(n,i,a)}},y={type:l.CommandType.MUTATION,id:"sheets.mutation.update-hyper-link",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,payload:a,id:o}=t;return r.updateHyperLink(n,i,o,a,!1)}},b={type:l.CommandType.MUTATION,id:"sheets.mutation.update-hyper-link-ref",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,id:a,row:o,column:s,silent:l}=t;return r.updateHyperLinkRef(n,i,a,{row:o,column:s},l)}},w={type:l.CommandType.MUTATION,id:"sheets.mutation.remove-hyper-link",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,id:a}=t;return r.removeHyperLink(n,i,a)}};var R,E=Object.defineProperty,T=Object.getOwnPropertyDescriptor,M=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?T(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&E(t,r,a),a},"__decorateClass$3"),O=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let D=(m(R=class extends l.Disposable{constructor(e){super(),this._commandService=e,this._registerCommands()}_registerCommands(){[C,y,w,b].forEach(e=>{this._commandService.registerCommand(e)})}},"SheetsHyperLinkController"),R);D=M([(0,l.OnLifecycle)(l.LifecycleStages.Starting,D),O(0,l.ICommandService)],D);let U="SHEET_HYPER_LINK_PLUGIN",P="err";var k,N=((a=N||{})[a.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",a[a.UNIVER_DOC=1]="UNIVER_DOC",a[a.UNIVER_SHEET=2]="UNIVER_SHEET",a[a.UNIVER_SLIDE=3]="UNIVER_SLIDE",a[a.UNIVER_PROJECT=4]="UNIVER_PROJECT",a[a.UNRECOGNIZED=-1]="UNRECOGNIZED",a),A=Object.defineProperty,x=Object.getOwnPropertyDescriptor,L=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?x(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&A(t,r,a),a},"__decorateClass$2"),V=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let F=(k=class extends l.Disposable{constructor(e,t){super(),this._resourceManagerService=e,this._hyperLinkModel=t,this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */m(e=>{let t=this._hyperLinkModel.getUnit(e),r={};return t?(t.forEach(e=>{r[e.subUnitId]=e.links.map(({display:e,...t})=>t)}),JSON.stringify(r)):""},"toJson"),t=/* @__PURE__ */m(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:U,businesses:[N.UNIVER_SHEET],toJson:/* @__PURE__ */m(t=>e(t),"toJson"),parseJson:/* @__PURE__ */m(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */m(e=>{this._hyperLinkModel.deleteUnit(e)},"onUnLoad"),onLoad:/* @__PURE__ */m(async(e,t)=>{Object.keys(t).forEach(r=>{t[r].forEach(t=>{this._hyperLinkModel.addHyperLink(e,r,t)})})},"onLoad")}))}},m(k,"SheetsHyperLinkResourceController"),k);F=L([(0,l.OnLifecycle)(l.LifecycleStages.Starting,F),V(0,l.IResourceManagerService),V(1,(0,l.Inject)(I))],F);var j,H=Object.defineProperty,$=Object.getOwnPropertyDescriptor,B=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?$(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&H(t,r,a),a},"__decorateClass$1"),W=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let G=(j=class extends l.Disposable{constructor(e,t,r,n){super(),p(this,"_disposableMap",/* @__PURE__ */new Map),p(this,"_watchDisposableMap",/* @__PURE__ */new Map),p(this,"_rangeDisableMap",/* @__PURE__ */new Map),p(this,"_rangeWatcherMap",/* @__PURE__ */new Map),p(this,"_handlePositionChange",/* @__PURE__ */m((e,t,r,n,i)=>{let a={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};return n?{redos:[{id:b.id,params:{unitId:e,subUnitId:t,id:r.id,row:n.startRow,column:n.startColumn,silent:i}}],undos:[{id:b.id,params:{unitId:e,subUnitId:t,id:r.id,row:a.startRow,column:a.startColumn,silent:i}}]}:{redos:[{id:w.id,params:{unitId:e,subUnitId:t,id:r.id}}],undos:[{id:C.id,params:{unitId:e,subUnitId:t,link:r}}]}},"_handlePositionChange")),this._refRangeService=e,this._hyperLinkModel=t,this._selectionManagerService=r,this._commandService=n,this._initData(),this._initRefRange()}_registerPosition(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row},a=/* @__PURE__ */m(n=>{let a=(0,d.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests)(i,n,{selectionManagerService:this._selectionManagerService}),o=Array.isArray(a)?a[0]:a;return o&&o.startColumn===i.startColumn&&o.startRow===i.startRow?{undos:[],redos:[]}:this._handlePositionChange(e,t,r,o,!1)},"handleRefRangeChange");this._disposableMap.set(n,this._refRangeService.registerRefRange(i,a,e,t))}_watchPosition(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._watchDisposableMap.set(n,this._refRangeService.watchRange(e,t,i,(n,i)=>{let{redos:a}=this._handlePositionChange(e,t,r,i,!0);(0,l.sequenceExecuteAsync)(a,this._commandService,{onlyLocal:!0})},!0))}_unregisterPosition(e){let t=this._disposableMap.get(e);null==t||t.dispose(),this._disposableMap.delete(e)}_unwatchPosition(e){let t=this._watchDisposableMap.get(e);null==t||t.dispose(),this._watchDisposableMap.delete(e)}_registerRange(e,t,r,n=!1){var i,a,o;if(r.startsWith("#")){let s=new URLSearchParams(r.slice(1)),c={gid:null!=(i=s.get("gid"))?i:"",range:null!=(a=s.get("range"))?a:"",rangeid:null!=(o=s.get("rangeid"))?o:""};if(c.range&&c.gid){let i=c.gid,a=(0,u.deserializeRangeWithSheet)(c.range).range;if((0,l.isValidRange)(a)&&c.range!==P){let o=/* @__PURE__ */m(n=>{let o=(0,d.handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests)(a,n,{selectionManagerService:this._selectionManagerService});return o&&(0,u.serializeRange)(o)===(0,u.serializeRange)(a)?{redos:[],undos:[]}:{redos:[{id:y.id,params:{unitId:e,subUnitId:i,id:t,payload:{payload:`#gid=${i}&range=${o?(0,u.serializeRange)(o):"err"}`}}}],undos:[{id:y.id,params:{unitId:e,subUnitId:i,id:t,payload:{payload:r}}}]}},"handleRangeChange");this._rangeDisableMap.set(t,this._refRangeService.registerRefRange(a,o,e,i)),n||this._rangeWatcherMap.set(t,this._refRangeService.watchRange(e,i,a,(r,n)=>{this._hyperLinkModel.updateHyperLink(e,i,t,{payload:`#gid=${i}&range=${n?(0,u.serializeRange)(n):"err"}`},!0)},!0))}}}}_unregisterRange(e){let t=this._rangeDisableMap.get(e);null==t||t.dispose(),this._rangeDisableMap.delete(e)}_unwatchRange(e){let t=this._rangeWatcherMap.get(e);null==t||t.dispose(),this._rangeWatcherMap.delete(e)}_initData(){this._hyperLinkModel.getAll().forEach(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,links:n}=e;n.forEach(e=>{this._registerPosition(t,r,e),this._watchPosition(t,r,e),this._registerRange(t,e.id,e.payload)})})})}_initRefRange(){this.disposeWithMe(this._hyperLinkModel.linkUpdate$.subscribe(e=>{switch(e.type){case"add":this._registerPosition(e.unitId,e.subUnitId,e.payload),this._watchPosition(e.unitId,e.subUnitId,e.payload),this._registerRange(e.unitId,e.payload.id,e.payload.payload);break;case"remove":this._unregisterPosition(e.payload.id),this._unwatchPosition(e.payload.id),this._unregisterRange(e.payload.id),this._unwatchRange(e.payload.id);break;case"updateRef":{let{unitId:t,subUnitId:r,id:n,silent:i}=e,a=this._hyperLinkModel.getHyperLink(t,r,n);if(!a)return;this._unregisterPosition(n),this._registerPosition(t,r,a),i||(this._unwatchPosition(n),this._watchPosition(t,r,a));break}case"unload":{let{unitLinks:t}=e;t.forEach(e=>{let{links:t}=e;t.forEach(e=>{this._unregisterPosition(e.id),this._unwatchPosition(e.id),this._unregisterRange(e.id),this._unwatchRange(e.id)})});break}case"update":e.silent||this._unwatchRange(e.id),this._unregisterRange(e.id),this._registerRange(e.unitId,e.id,e.payload.payload,e.silent)}})),this.disposeWithMe((0,l.toDisposable)(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}},m(j,"SheetsHyperLinkRefRangeController"),j);G=B([(0,l.OnLifecycle)(l.LifecycleStages.Starting,G),W(0,(0,l.Inject)(d.RefRangeService)),W(1,(0,l.Inject)(I)),W(2,(0,l.Inject)(d.SheetsSelectionsService)),W(3,l.ICommandService)],G);let Y={};var z,K=Object.defineProperty,q=Object.getOwnPropertyDescriptor,X=/* @__PURE__ */m((e,t,r)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),Z=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?q(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&K(t,r,a),a},"__decorateClass"),Q=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),J=/* @__PURE__ */m((e,t,r)=>X(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let ee=(m(z=class extends l.Plugin{constructor(e=Y,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("sheets-hyper-link.config",n)}onStarting(){[[F],[D],[G],[I]].forEach(e=>{this._injector.add(e)})}},"UniverSheetsHyperLinkPlugin"),z);J(ee,"pluginName",U),J(ee,"type",l.UniverInstanceType.UNIVER_SHEET),ee=Z([(0,l.DependentOn)(d.UniverSheetsPlugin),Q(1,(0,l.Inject)(l.Injector)),Q(2,l.IConfigService)],ee)}),i("g2lyD",function(r,i){e(r.exports,"AddCommentCommand",function(){return n("83o4E").AddCommentCommand}),e(r.exports,"DeleteCommentTreeCommand",function(){return n("83o4E").DeleteCommentTreeCommand}),e(r.exports,"SheetsThreadCommentModel",function(){return n("idZOd").SheetsThreadCommentModel});var a=n("83KcA"),o=n("dUpWs"),s=n("11kpD"),l=n("cahIb"),d=n("jv4BO"),u=n("bVip2"),c=n("fElJC"),h=n("idZOd"),m=n("ls2nu"),p=n("D79YY"),g=n("gQuIR"),f=n("kkAWv"),v=n("83o4E"),_=Object.defineProperty,I=(e,t,r)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,S=(e,t)=>_(e,"name",{value:t,configurable:!0}),C=(e,t,r)=>I(e,"symbol"!=typeof t?t+"":t,r);let y="univer.sheet.thread-comment-modal",b="comment-single",w="SHEET_THREAD_COMMENT";var R,E=Object.defineProperty,T=Object.getOwnPropertyDescriptor,M=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?T(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&E(t,r,a),a},"__decorateClass$7"),O=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let D=(R=class extends a.Disposable{constructor(e,t){super(),C(this,"_lastPopup",null),C(this,"_activePopup"),C(this,"_activePopup$",new d.BehaviorSubject(null)),C(this,"activePopup$",this._activePopup$.asObservable()),this._canvasPopupManagerService=e,this._zenZoneService=t,this._initZenVisible(),this.disposeWithMe(()=>{this._activePopup$.complete()})}get activePopup(){return this._activePopup}_initZenVisible(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&this.hidePopup()}))}showPopup(e,t){var r;let{row:n,col:i,unitId:o,subUnitId:s}=e;if(this._activePopup&&n===this._activePopup.row&&i===this._activePopup.col&&o===this._activePopup.unitId&&s===(null==(r=this.activePopup)?void 0:r.subUnitId)){this._activePopup=e,this._activePopup$.next(e);return}if(this._lastPopup&&this._lastPopup.dispose(),this._zenZoneService.visible)return;this._activePopup=e,this._activePopup$.next(e);let l=this._canvasPopupManagerService.attachPopupToCell(n,i,{componentKey:y,onClickOutside:/* @__PURE__ */S(()=>{this.hidePopup()},"onClickOutside"),direction:"horizontal",excludeOutside:[...Array.from(document.querySelectorAll(".univer-thread-comment")),document.getElementById("thread-comment-add")].filter(Boolean)});if(!l)throw Error("[SheetsThreadCommentPopupService]: cannot show popup!");let d=new a.DisposableCollection;d.add(l),d.add({dispose:/* @__PURE__ */S(()=>{null==t||t()},"dispose")}),this._lastPopup=d}hidePopup(){this._activePopup&&(this._lastPopup&&this._lastPopup.dispose(),this._lastPopup=null,this._activePopup=null,this._activePopup$.next(null))}persistPopup(){this._activePopup&&this._activePopup.temp&&(this._activePopup={...this._activePopup,temp:!1},this._activePopup$.next(this._activePopup))}},S(R,"SheetsThreadCommentPopupService"),R);D=M([O(0,(0,a.Inject)(s.SheetCanvasPopManagerService)),O(1,l.IZenZoneService)],D);let U={type:a.CommandType.OPERATION,id:"sheets.operation.show-comment-modal",handler(e){var t;let r=e.get(m.SheetsSelectionsService),n=e.get(a.IUniverInstanceService),i=e.get(D),s=e.get(o.ThreadCommentPanelService),l=null==(t=r.getCurrentLastSelection())?void 0:t.primary,d=e.get(h.SheetsThreadCommentModel);if(!l)return!1;let u=(0,m.getSheetCommandTarget)(n);if(!u)return!1;let{workbook:c,worksheet:p,unitId:g,subUnitId:f}=u,v={workbook:c,worksheet:p,unitId:g,subUnitId:f,row:l.startRow,col:l.startColumn};i.showPopup(v);let _=d.getByLocation(g,f,l.startRow,l.startColumn);return _&&s.setActiveComment({unitId:g,subUnitId:f,commentId:_,trigger:"context-menu"}),!0}},P={};var k,N=Object.defineProperty,A=Object.getOwnPropertyDescriptor,x=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?A(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&N(t,r,a),a},"__decorateClass$6"),L=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let V=(k=class extends a.Disposable{constructor(e,t,r,n){super(),this._sheetInterceptorService=e,this._sheetsThreadCommentModel=t,this._univerInstanceService=r,this._renderManagerService=n,this._initViewModelIntercept(),this._initSkeletonChange()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(m.INTERCEPTOR_POINT.CELL_CONTENT,{handler:/* @__PURE__ */S((e,t,r)=>{let{row:n,col:i,unitId:a,subUnitId:o}=t;return r(this._sheetsThreadCommentModel.showCommentMarker(a,o,n,i)?{...e,markers:{...null==e?void 0:e.markers,tr:{color:"#FFBD37",size:6}}}:e)},"handler"),priority:100}))}_initSkeletonChange(){let e=/* @__PURE__ */S(()=>{var e;let t=this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET);if(!t)return;let r=t.getUnitId(),n=null==(e=t.getActiveSheet())?void 0:e.getSheetId();if(!n){console.warn("No active sheet found");return}let i=this._renderManagerService.getRenderById(r),o=null==i?void 0:i.with(s.SheetSkeletonManagerService).getOrCreateSkeleton({sheetId:n});null==o||o.makeDirty(!0),null==o||o.calculate(),i&&i.mainComponent.makeForceDirty()},"markSkeletonDirty");this.disposeWithMe(this._sheetsThreadCommentModel.commentUpdate$.pipe((0,u.debounceTime)(16)).subscribe(t=>{e()}))}},S(k,"SheetsThreadCommentRenderController"),k);V=x([(0,a.OnLifecycle)(a.LifecycleStages.Ready,V),L(0,(0,a.Inject)(m.SheetInterceptorService)),L(1,(0,a.Inject)(h.SheetsThreadCommentModel)),L(2,a.IUniverInstanceService),L(3,p.IRenderManagerService)],V);var F=function(){return(F=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},j=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},H=(0,g.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=j(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,g.useRef)("_".concat(G()));return $(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},F({ref:t,className:s},o),a)});function $(e,t,r,n,i){return(0,g.createElement)(e.tag,F(F({key:t},B(e,r,i)),n),(W(e,r).children||[]).map(function(n,a){return $(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function B(e,t,r){var n=F({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function W(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?F(F({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?F(F({},e),{attrs:F(F({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function G(){return Math.random().toString(36).substring(2,8)}S($,"render"),S(B,"replaceRuntimeIdsAndExtInAttrs"),S(W,"replaceRuntimeIdsInDefs"),S(G,"generateShortUuid"),H.displayName="UniverIcon";var Y={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521C5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345ZM8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521C8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345ZM11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521C11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521 5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345zM8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521 8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345zM11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521 11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.84351 3.41861C1.84351 3.01861 2.15531 2.69434 2.53993 2.69434H14.9381C15.3228 2.69434 15.6346 3.01861 15.6346 3.41861V12.4611C15.6346 12.8612 15.3228 13.1854 14.9381 13.1854H8.82117L6.06643 14.6179C5.85054 14.7301 5.59416 14.7181 5.38884 14.5862C5.18352 14.4542 5.05855 14.2211 5.05855 13.9701V13.1854H2.53993C2.15531 13.1854 1.84351 12.8612 1.84351 12.4611L1.84351 3.41861ZM6.45141 12.7982L8.34531 12.0135C8.44201 11.9632 8.54864 11.9371 8.65676 11.9371H14.2417C14.3522 11.9371 14.4417 11.8475 14.4417 11.7371V4.14271C14.4417 4.03225 14.3522 3.94271 14.2417 3.94271H3.23636C3.12591 3.94271 3.03636 4.03225 3.03636 4.14271L3.03636 11.7371C3.03636 11.8475 3.12591 11.9371 3.23636 11.9371L5.75498 11.9371C6.1396 11.9371 6.45141 12.0611 6.45141 12.4611V12.7982Z",fillRule:"evenodd",clipRule:"evenodd"}}]},z=(0,g.forwardRef)(function(e,t){return(0,g.createElement)(H,Object.assign({},e,{id:"comment-single",ref:t,icon:Y}))});z.displayName="CommentSingle";let K=/* @__PURE__ */S(()=>{let e=(0,a.useDependency)(a.IUniverInstanceService),r=(0,a.useDependency)(D),n=(0,l.useObservable)(r.activePopup$),i=(0,a.useDependency)(h.SheetsThreadCommentModel);if((0,l.useObservable)(i.commentUpdate$),!n)return null;let{row:s,col:d,unitId:u,subUnitId:c,trigger:m}=n,p=i.getByLocation(u,c,s,d),f=`${(0,a.Tools).chatAtABC(d)}${s+1}`,v=/* @__PURE__ */S(()=>{r.hidePopup()},"onClose"),_=/* @__PURE__ */S(t=>{var r,n,i;return null!=(i=null==(n=null==(r=e.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET))?void 0:r.getSheetBySheetId(t))?void 0:n.getName())?i:""},"getSubUnitName");return /* @__PURE__ *//*@__PURE__*/t(g).createElement(o.ThreadCommentTree,{onClick:/* @__PURE__ */S(()=>{r.persistPopup()},"onClick"),prefix:"cell",id:p,unitId:u,subUnitId:c,type:a.UniverInstanceType.UNIVER_SHEET,refStr:f,onClose:v,getSubUnitName:_,autoFocus:"context-menu"===m})},"SheetsThreadCommentCell"),q=/* @__PURE__ */S(()=>{var e;let r=(0,a.useDependency)(s.IMarkSelectionService),n=(0,a.useDependency)(a.IUniverInstanceService),i=(0,a.useDependency)(D),d=n.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET),u=d.getUnitId(),h=(0,a.useDependency)(a.ICommandService),m=(0,g.useMemo)(()=>d.activeSheet$.pipe((0,c.map)(e=>null==e?void 0:e.getSheetId())),[d.activeSheet$]),p=(0,l.useObservable)(m,null==(e=d.getActiveSheet())?void 0:e.getSheetId()),v=(0,g.useRef)(),_=(0,a.useDependency)(o.ThreadCommentPanelService),I=(0,l.useObservable)(_.activeCommentId$),C=(0,l.useObservable)(_.panelVisible$,_.panelVisible),y=(0,g.useCallback)(e=>{let t=d.getSheets(),r={};t.forEach((e,t)=>{r[e.getSheetId()]=t});let n=/* @__PURE__ */S(e=>e.map(e=>{var t;let n=(0,f.singleReferenceToGrid)(e.ref),i=[null!=(t=r[e.subUnitId])?t:0,n.row,n.column];return{...e,p:i}}).sort((e,t)=>e.p[0]===t.p[0]?e.p[1]===t.p[1]?e.p[2]-t.p[2]:e.p[1]-t.p[1]:e.p[0]-t.p[0]),"sort");return[...n(e.filter(e=>!e.resolved)),...n(e.filter(e=>e.resolved))]},[d]),b=(0,g.useCallback)(e=>{if(e.unitId===u&&e.subUnitId===p&&!e.resolved){let{row:t,column:n}=(0,f.singleReferenceToGrid)(e.ref);if(!Number.isNaN(t)&&!Number.isNaN(n))return r.addShape({range:{startColumn:n,endColumn:n,startRow:t,endRow:t},style:{hasAutoFill:!1,fill:"rgb(255, 189, 55, 0.35)",strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null})}},[r,p,u]),w=/* @__PURE__ */S(e=>{var t,r;return null!=(r=null==(t=d.getSheetBySheetId(e))?void 0:t.getName())?r:""},"getSubUnitName"),R=/* @__PURE__ */S(()=>{h.executeCommand(U.id)},"handleAdd"),E=/* @__PURE__ */S(e=>{I&&I.unitId===e.unitId&&I.subUnitId===e.subUnitId&&I.commentId===e.id||(v.current&&(r.removeShape(v.current),v.current=null),v.current=b(e))},"handleHover"),T=/* @__PURE__ */S(()=>{v.current&&(r.removeShape(v.current),v.current=null)},"handleLeave"),M=/* @__PURE__ */S((e,t)=>{t&&i.hidePopup()},"handleResolve");return(0,g.useEffect)(()=>{!C&&v.current&&r.removeShape(v.current)},[r,C]),/* @__PURE__ *//*@__PURE__*/t(g).createElement(o.ThreadCommentPanel,{unitId:u,subUnitId$:m,type:a.UniverInstanceType.UNIVER_SHEET,onAdd:R,getSubUnitName:w,onResolve:M,sortComments:y,onItemEnter:E,onItemLeave:T,onDeleteComment:/* @__PURE__ */S(()=>(T(),!0),"onDeleteComment")})},"SheetsThreadCommentPanel"),X=/* @__PURE__ */S(e=>({id:U.id,type:l.MenuItemType.BUTTON,icon:b,title:"sheetThreadComment.menu.addComment",hidden$:(0,l.getMenuHiddenObservable)(e,a.UniverInstanceType.UNIVER_SHEET),disabled$:(0,s.getCurrentRangeDisable$)(e,{workbookTypes:[m.WorkbookCommentPermission],worksheetTypes:[m.WorksheetViewPermission],rangeTypes:[m.RangeProtectionPermissionViewPoint]})}),"threadCommentMenuFactory"),Z=/* @__PURE__ */S(e=>({id:o.ToggleSheetCommentPanelOperation.id,type:l.MenuItemType.BUTTON,icon:b,tooltip:"sheetThreadComment.menu.commentManagement",disabled$:(0,s.getCurrentRangeDisable$)(e,{workbookTypes:[m.WorkbookCommentPermission],worksheetTypes:[m.WorksheetViewPermission],rangeTypes:[m.RangeProtectionPermissionViewPoint]}),hidden$:(0,l.getMenuHiddenObservable)(e,a.UniverInstanceType.UNIVER_SHEET)}),"threadPanelMenuFactory"),Q={id:U.id,binding:l.KeyCode.M|l.MetaKeys.CTRL_COMMAND|l.MetaKeys.ALT,preconditions:s.whenSheetEditorFocused},J={[l.RibbonStartGroup.OTHERS]:{[o.ToggleSheetCommentPanelOperation.id]:{order:1,menuItemFactory:Z}},[l.ContextMenuPosition.MAIN_AREA]:{[l.ContextMenuGroup.OTHERS]:{[U.id]:{order:0,menuItemFactory:X}}}};var ee,et=Object.defineProperty,er=Object.getOwnPropertyDescriptor,en=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?er(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&et(t,r,a),a},"__decorateClass$5"),ei=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let ea=(S(ee=class extends a.Disposable{constructor(e,t,r){super(),this._menuManagerService=e,this._componentManager=t,this._shortcutService=r,this._initMenu(),this._initShortcut(),this._initComponent()}_initShortcut(){this._shortcutService.registerShortcut(Q)}_initMenu(){this._menuManagerService.mergeMenu(J)}_initComponent(){[[y,K],[(0,o.THREAD_COMMENT_PANEL),q],[b,z]].forEach(([e,t])=>{this._componentManager.register(e,t)})}},"SheetsThreadCommentController"),ee);ea=en([(0,a.OnLifecycle)(a.LifecycleStages.Starting,ea),ei(0,l.IMenuManagerService),ei(1,(0,a.Inject)(l.ComponentManager)),ei(2,l.IShortcutService)],ea);var eo=Object.defineProperty,es=Object.getOwnPropertyDescriptor,el=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?es(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eo(t,r,a),a},"__decorateClass$4"),ed=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let eu=/* @__PURE__ */S((e,t,r)=>{let n=(0,f.singleReferenceToGrid)(e),i=r.row-t.row,a=r.column-t.column,o={startColumn:n.column+a,startRow:n.row+i,endColumn:n.column+a,endRow:n.row+i};return(0,f.serializeRange)(o)},"transformRef"),ec=(eh=class extends a.Disposable{constructor(e,t,r){super(),C(this,"_copyInfo"),this._sheetClipboardService=e,this._sheetsThreadCommentModel=t,this._threadCommentDataSourceService=r,this._initClipboardHook()}_initClipboardHook(){this.disposeWithMe(this._sheetClipboardService.addClipboardHook({id:w,onBeforeCopy:/* @__PURE__ */S((e,t,r)=>{this._copyInfo={unitId:e,subUnitId:t,range:r}},"onBeforeCopy"),onPasteCells:/* @__PURE__ */S((e,t,r,n)=>{let{unitId:i,subUnitId:o,range:l}=t,d={row:l.rows[0],column:l.cols[0]};if(n.copyType===s.COPY_TYPE.CUT&&this._copyInfo){let{range:e,unitId:t,subUnitId:r}=this._copyInfo,n={row:e.startRow,column:e.startColumn};if(!(i===t&&o===r)){let s=[];(0,a.Range).foreach(e,(e,n)=>{let i=this._sheetsThreadCommentModel.getAllByLocation(t,r,e,n);this._threadCommentDataSourceService.syncUpdateMutationToColla?i.forEach(e=>{s.push(e)}):i.forEach(({children:e,...t})=>{t.parentId||s.push(t)})});let l=[],u=[],c=[],h=[],m=/* @__PURE__ */S(e=>{l.unshift({id:v.DeleteCommentMutation.id,params:{unitId:t,subUnitId:r,commentId:e.id}}),c.push({id:v.AddCommentMutation.id,params:{unitId:i,subUnitId:o,comment:{...e,ref:eu(e.ref,n,d),unitId:i,subUnitId:o},sync:!0}}),u.push({id:v.AddCommentMutation.id,params:{unitId:t,subUnitId:r,comment:e,sync:!0}}),h.unshift({id:v.DeleteCommentMutation.id,params:{unitId:i,subUnitId:o,commentId:e.id}})},"handleCommentItem");return s.forEach(e=>{m(e)}),{redos:[...l,...c],undos:[...h,...u]}}}return{redos:[],undos:[]}},"onPasteCells")}))}},S(eh,"SheetsThreadCommentCopyPasteController"),eh);ec=el([(0,a.OnLifecycle)(a.LifecycleStages.Rendered,ec),ed(0,(0,a.Inject)(s.ISheetClipboardService)),ed(1,(0,a.Inject)(h.SheetsThreadCommentModel)),ed(2,v.IThreadCommentDataSourceService)],ec);var eh,em,ep=Object.defineProperty,eg=Object.getOwnPropertyDescriptor,ef=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eg(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ep(t,r,a),a},"__decorateClass$3"),ev=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let e_=(S(em=class extends a.Disposable{constructor(e,t,r,n){super(),this._hoverManagerService=e,this._sheetsThreadCommentPopupService=t,this._sheetsThreadCommentModel=r,this._sheetPermissionInterceptorBaseController=n,this._initHoverEvent()}_initHoverEvent(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe((0,u.debounceTime)(100)).subscribe(e=>{let t=this._sheetsThreadCommentPopupService.activePopup;if(e&&(t&&t.temp||!t)){let{location:r}=e,{unitId:n,subUnitId:i,row:a,col:o}=r,s=this._sheetsThreadCommentModel.getByLocation(n,i,a,o);if(s){if(!this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[m.WorkbookCommentPermission],worksheetTypes:[m.WorksheetViewPermission],rangeTypes:[m.RangeProtectionPermissionViewPoint]},[{startRow:a,startColumn:o,endRow:a,endColumn:o}]))return;let e=this._sheetsThreadCommentModel.getComment(n,i,s);e&&!e.resolved&&this._sheetsThreadCommentPopupService.showPopup({unitId:n,subUnitId:i,row:a,col:o,commentId:s,temp:!0})}else t&&this._sheetsThreadCommentPopupService.hidePopup()}}))}},"SheetsThreadCommentHoverController"),em);e_=ef([(0,a.OnLifecycle)(a.LifecycleStages.Rendered,e_),ev(0,(0,a.Inject)(s.HoverManagerService)),ev(1,(0,a.Inject)(D)),ev(2,(0,a.Inject)(h.SheetsThreadCommentModel)),ev(3,(0,a.Inject)(s.SheetPermissionInterceptorBaseController))],e_);var eI,eS=Object.defineProperty,eC=Object.getOwnPropertyDescriptor,ey=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eC(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eS(t,r,a),a},"__decorateClass$2"),eb=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let ew=(S(eI=class extends a.Disposable{constructor(e,t,r,n,i,a,o,s,l){super(),C(this,"_isSwitchToCommenting",!1),C(this,"_selectionShapeInfo",null),this._commandService=e,this._sheetsThreadCommentPopupService=t,this._sheetsThreadCommentModel=r,this._threadCommentPanelService=n,this._univerInstanceService=i,this._sheetPermissionInterceptorBaseController=a,this._markSelectionService=o,this._sheetSelectionService=s,this._editorBridgeService=l,this._initCommandListener(),this._initPanelListener(),this._initMarkSelection(),this._initSelectionUpdateListener(),this._initEditorBridge()}_handleSelectionChange(e,t,r){var n,i;let s=null==(n=e[0])?void 0:n.range;if(!s)return;if((null!=(i=s.rangeType)?i:a.RANGE_TYPE.NORMAL)!==a.RANGE_TYPE.NORMAL||s.endColumn-s.startColumn>0||s.endRow-s.startRow>0){this._threadCommentPanelService.activeCommentId&&this._commandService.executeCommand(o.SetActiveCommentOperation.id);return}let l=s.startRow,d=s.startColumn;if(!this._sheetsThreadCommentModel.showCommentMarker(t,r,l,d)){this._threadCommentPanelService.activeCommentId&&this._commandService.executeCommand(o.SetActiveCommentOperation.id);return}let u=this._sheetsThreadCommentModel.getByLocation(t,r,l,d);u&&this._commandService.executeCommand(o.SetActiveCommentOperation.id,{unitId:t,subUnitId:r,commentId:u})}_initSelectionUpdateListener(){this.disposeWithMe(this._sheetSelectionService.selectionMoveEnd$.subscribe(e=>{if(this._isSwitchToCommenting)return;let t=this._sheetSelectionService.currentSelectionParam;t&&this._handleSelectionChange(e,t.unitId,t.sheetId)}))}_initEditorBridge(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(e=>{e.visible&&this._sheetsThreadCommentPopupService.hidePopup()}))}_initCommandListener(){this._commandService.onCommandExecuted(e=>{if(e.id===v.DeleteCommentMutation.id){let t=e.params,r=this._sheetsThreadCommentPopupService.activePopup;if(!r)return;let{unitId:n,subUnitId:i,commentId:a}=r;t.unitId===n&&t.subUnitId===i&&t.commentId===a&&this._sheetsThreadCommentPopupService.hidePopup()}})}_initPanelListener(){this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.subscribe(async e=>{var t;if(e){let{unitId:r,subUnitId:n,commentId:i,trigger:o}=e,l=this._sheetsThreadCommentModel.getComment(r,n,i);if(!l||l.resolved)return;let d=this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET);if(!d||d.getUnitId()!==r)return;this._isSwitchToCommenting=!0,(null==(t=d.getActiveSheet())?void 0:t.getSheetId())!==n&&await this._commandService.executeCommand(m.SetWorksheetActiveOperation.id,{unitId:r,subUnitId:n}),this._isSwitchToCommenting=!1;let u=(0,f.singleReferenceToGrid)(l.ref),{row:c,column:h}=u;if(!this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[m.WorkbookCommentPermission],worksheetTypes:[m.WorksheetViewPermission],rangeTypes:[m.RangeProtectionPermissionViewPoint]},[{startRow:c,startColumn:h,endRow:c,endColumn:h}])||(await this._commandService.executeCommand(s.ScrollToRangeOperation.id,{range:{startRow:Math.max(u.row-1,0),endRow:u.row+1,startColumn:Math.max(u.column-1,0),endColumn:u.column+1}}),this._editorBridgeService.isVisible().visible))return;this._sheetsThreadCommentPopupService.showPopup({unitId:r,subUnitId:n,row:u.row,col:u.column,commentId:l.id,trigger:o})}else this._sheetsThreadCommentPopupService.hidePopup()}))}_initMarkSelection(){this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.pipe((0,u.debounceTime)(100)).subscribe(e=>{if(!e){this._selectionShapeInfo&&(this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId),this._selectionShapeInfo=null);return}let{unitId:t,subUnitId:r,commentId:n}=e;this._selectionShapeInfo&&(this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId),this._selectionShapeInfo=null);let i=this._sheetsThreadCommentModel.getComment(t,r,n);if(!i)return;let{row:a,column:o}=(0,f.singleReferenceToGrid)(i.ref);if(Number.isNaN(a)||Number.isNaN(o))return null;let s=this._markSelectionService.addShape({range:{startColumn:o,endColumn:o,startRow:a,endRow:a},style:{hasAutoFill:!1,fill:"rgb(255, 189, 55, 0.35)",strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null},[],-1);s&&(this._selectionShapeInfo={...e,shapeId:s})}))}},"SheetsThreadCommentPopupController"),eI);ew=ey([(0,a.OnLifecycle)(a.LifecycleStages.Rendered,ew),eb(0,a.ICommandService),eb(1,(0,a.Inject)(D)),eb(2,(0,a.Inject)(h.SheetsThreadCommentModel)),eb(3,(0,a.Inject)(o.ThreadCommentPanelService)),eb(4,a.IUniverInstanceService),eb(5,(0,a.Inject)(s.SheetPermissionInterceptorBaseController)),eb(6,s.IMarkSelectionService),eb(7,(0,a.Inject)(m.SheetsSelectionsService)),eb(8,s.IEditorBridgeService)],ew);var eR,eE=Object.defineProperty,eT=Object.getOwnPropertyDescriptor,eM=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eT(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eE(t,r,a),a},"__decorateClass$1"),eO=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let eD=(eR=class extends a.Disposable{constructor(e,t,r,n){super(),this._sheetInterceptorService=e,this._univerInstanceService=t,this._threadCommentModel=r,this._threadCommentDataSourceService=n,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */S(e=>{var t;if(e.id===m.RemoveSheetCommand.id){let r=e.params,n=r.unitId?this._univerInstanceService.getUnit(r.unitId):this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET);if(!n)return{redos:[],undos:[]};let i=n.getUnitId(),o=r.subUnitId||(null==(t=n.getActiveSheet())?void 0:t.getSheetId());if(!o)return{redos:[],undos:[]};let{commentMap:s}=this._threadCommentModel.ensureMap(i,o),l=Array.from(Object.values(s)).filter(e=>!e.parentId),d=l.map(e=>e.id),u=this._threadCommentDataSourceService.syncUpdateMutationToColla;return{redos:d.map(e=>({id:v.DeleteCommentMutation.id,params:{unitId:i,subUnitId:o,commentId:e}})),undos:l.map(({children:e,...t})=>({id:v.AddCommentMutation.id,params:{unitId:i,subUnitId:o,comment:{...t,children:u?e:void 0},sync:!u}}))}}return{redos:[],undos:[]}},"getMutations")}))}},S(eR,"ThreadCommentRemoveSheetsController"),eR);eD=eM([(0,a.OnLifecycle)(a.LifecycleStages.Ready,eD),eO(0,(0,a.Inject)(m.SheetInterceptorService)),eO(1,a.IUniverInstanceService),eO(2,(0,a.Inject)(v.ThreadCommentModel)),eO(3,v.IThreadCommentDataSourceService)],eD);var eU,eP=Object.defineProperty,ek=Object.getOwnPropertyDescriptor,eN=/* @__PURE__ */S((e,t,r)=>t in e?eP(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),eA=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ek(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eP(t,r,a),a},"__decorateClass"),ex=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),eL=/* @__PURE__ */S((e,t,r)=>eN(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let eV=(S(eU=class extends a.Plugin{constructor(e=P,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig("sheets-thread-comment.config",a)}onStarting(){[[ea],[V],[ec],[e_],[eD],[ew],[D]].forEach(e=>{this._injector.add(e)}),[U].forEach(e=>{this._commandService.registerCommand(e)})}},"UniverSheetsThreadCommentPlugin"),eU);eL(eV,"pluginName",w),eL(eV,"type",a.UniverInstanceType.UNIVER_SHEET),eA([(0,a.DependentOn)(o.UniverThreadCommentUIPlugin,h.UniverSheetsThreadCommentBasePlugin),ex(1,(0,a.Inject)(a.Injector)),ex(2,(0,a.Inject)(a.ICommandService)),ex(3,a.IConfigService)],eV)}),i("dUpWs",function(r,i){e(r.exports,"getDT",function(){return C}),e(r.exports,"THREAD_COMMENT_PANEL",function(){return y}),e(r.exports,"ThreadCommentPanelService",function(){return M}),e(r.exports,"ToggleSheetCommentPanelOperation",function(){return O}),e(r.exports,"SetActiveCommentOperation",function(){return D}),e(r.exports,"UniverThreadCommentUIPlugin",function(){return H}),e(r.exports,"ThreadCommentTree",function(){return e_}),e(r.exports,"ThreadCommentPanel",function(){return eS});var a=n("1RqlY"),o=n("83o4E"),s=n("83KcA"),l=n("cahIb"),d=n("jv4BO"),u=n("a9FIH"),c=n("bLx5G"),h=n("gQuIR"),m=n("1dwVM"),p=n("kB4bq"),g=n("70MC3"),f=n("D79YY"),v=Object.defineProperty,_=(e,t,r)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t)=>v(e,"name",{value:t,configurable:!0}),S=(e,t,r)=>_(e,"symbol"!=typeof t?t+"":t,r);function C(){return /*@__PURE__*/t(a)().format("YYYY/MM/DD HH:mm")}I(C,"getDT");let y="thread-comment-panel";var b,w=Object.defineProperty,R=Object.getOwnPropertyDescriptor,E=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?R(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&w(t,r,a),a},"__decorateClass$1"),T=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let M=(I(b=class extends s.Disposable{constructor(e,t){super(),S(this,"_panelVisible",!1),S(this,"_panelVisible$",new d.BehaviorSubject(!1)),S(this,"_activeCommentId"),S(this,"_activeCommentId$",new d.BehaviorSubject(void 0)),S(this,"panelVisible$",this._panelVisible$.asObservable()),S(this,"activeCommentId$",this._activeCommentId$.asObservable()),this._sidebarService=e,this._univerInstanceService=t,this._init(),this.disposeWithMe(()=>{this._activeCommentId$.complete(),this._panelVisible$.complete()})}_init(){this.disposeWithMe(this._sidebarService.sidebarOptions$.subscribe(e=>{e.visible||this.setPanelVisible(!1)})),this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(s.UniverInstanceType.UNIVER_SHEET).pipe((0,u.filter)(e=>!e)).subscribe(()=>{this._sidebarService.close()}))}get panelVisible(){return this._panelVisible}get activeCommentId(){return this._activeCommentId}setPanelVisible(e){this._panelVisible=e,this._panelVisible$.next(e)}setActiveComment(e){this._activeCommentId=e,this._activeCommentId$.next(e)}},"ThreadCommentPanelService"),b);M=E([T(0,(0,s.Inject)(l.ISidebarService)),T(1,s.IUniverInstanceService)],M);let O={id:"thread-comment-ui.operation.toggle-panel",type:s.CommandType.OPERATION,handler(e){let t=e.get(l.ISidebarService),r=e.get(M);return r.panelVisible?(t.close(),r.setPanelVisible(!1)):(t.open({header:{title:"threadCommentUI.panel.title"},children:{label:y},width:330}),r.setPanelVisible(!0)),!0}},D={id:"thread-comment-ui.operation.set-active-comment",type:s.CommandType.OPERATION,handler:(e,t)=>(e.get(M).setActiveComment(t),!0)},U=class{constructor(){S(this,"dataSource"),S(this,"renderSuggestion"),S(this,"trigger","@")}async getMentions(e,t,r){return this.dataSource?this.dataSource.getMentions(e,t,r):[]}};I(U,"ThreadCommentMentionDataService");let P=(0,s.createIdentifier)("thread-comment.mention-data.service"),k={};var N,A=Object.defineProperty,x=Object.getOwnPropertyDescriptor,L=/* @__PURE__ */I((e,t,r)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),V=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?x(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&A(t,r,a),a},"__decorateClass"),F=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),j=/* @__PURE__ */I((e,t,r)=>L(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let H=(I(N=class extends s.Plugin{constructor(e=k,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig("thread-comment-ui.config",a)}onStarting(){var e;(0,s.mergeOverrideWithDependencies)([[M],[P,{useClass:U}]],null==(e=this._config)?void 0:e.overrides).forEach(e=>{this._injector.add(e)}),[O,D].forEach(e=>{this._commandService.registerCommand(e)})}},"UniverThreadCommentUIPlugin"),N);j(H,"pluginName","UNIVER_THREAD_COMMENT_UI_PLUGIN"),j(H,"type",s.UniverInstanceType.UNIVER_UNKNOWN),H=V([(0,s.DependentOn)(o.UniverThreadCommentPlugin),F(1,(0,s.Inject)(s.Injector)),F(2,s.ICommandService),F(3,s.IConfigService)],H);var $=function(){return($=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},B=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},W=(0,h.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=B(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,h.useRef)("_".concat(K()));return G(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},$({ref:t,className:s},o),a)});function G(e,t,r,n,i){return(0,h.createElement)(e.tag,$($({key:t},Y(e,r,i)),n),(z(e,r).children||[]).map(function(n,a){return G(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function Y(e,t,r){var n=$({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function z(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?$($({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?$($({},e),{attrs:$($({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function K(){return Math.random().toString(36).substring(2,8)}I(G,"render"),I(Y,"replaceRuntimeIdsAndExtInAttrs"),I(z,"replaceRuntimeIdsInDefs"),I(K,"generateShortUuid"),W.displayName="UniverIcon";var q={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993.866699 5.9313.866699H10.069C10.4004.866699 10.669 1.13533 10.669 1.4667 10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667zM1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443 14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443zM6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928 9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171 10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778 9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539 9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263 6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539 5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778 6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},X=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(W,Object.assign({},e,{id:"delete-single",ref:t,icon:q}))});X.displayName="DeleteSingle";var Z={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},Q=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(W,Object.assign({},e,{id:"increase-single",ref:t,icon:Z}))});Q.displayName="IncreaseSingle";var J={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3 9C3.55228 9 4 8.55228 4 8 4 7.44772 3.55228 7 3 7 2.44772 7 2 7.44772 2 8 2 8.55228 2.44772 9 3 9zM8 9C8.55228 9 9 8.55228 9 8 9 7.44772 8.55228 7 8 7 7.44772 7 7 7.44772 7 8 7 8.55228 7.44772 9 8 9zM13 9C13.5523 9 14 8.55228 14 8 14 7.44772 13.5523 7 13 7 12.4477 7 12 7.44772 12 8 12 8.55228 12.4477 9 13 9z"}}]},ee=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(W,Object.assign({},e,{id:"more-horizontal-single",ref:t,icon:J}))});ee.displayName="MoreHorizontalSingle";var et={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{stroke:"currentColor",d:"M7.48389 10.3267V12.1905C7.48389 12.7428 7.9316 13.1905 8.48389 13.1905H11.2216L12.2955 14.2644L13.3695 13.1905H14.1593C14.7116 13.1905 15.1593 12.7428 15.1593 12.1905V8.46289C15.1593 7.91061 14.7116 7.46289 14.1593 7.46289H12.2955",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M0.840332 3.73535C0.840332 2.63078 1.73576 1.73535 2.84033 1.73535H10.2955C11.4001 1.73535 12.2955 2.63078 12.2955 3.73535V8.32676C12.2955 9.43132 11.4001 10.3268 10.2955 10.3268H5.6014L4.1695 11.7587L3.05978 10.3268H2.84033C1.73576 10.3268 0.840332 9.43133 0.840332 8.32676V3.73535Z",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M6.41016 6.1311H6.76813M8.91626 6.1311H9.27424M3.90454 6.1311H4.26252",strokeLinecap:"round",strokeWidth:1.2}}]},er=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(W,Object.assign({},e,{id:"reply-to-comment-single",ref:t,icon:et}))});er.displayName="ReplyToCommentSingle";var en={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6106 15.4036C12.4766 15.4036 15.6106 12.2696 15.6106 8.40356C15.6106 4.53757 12.4766 1.40356 8.6106 1.40356C4.7446 1.40356 1.6106 4.53757 1.6106 8.40356C1.6106 12.2696 4.7446 15.4036 8.6106 15.4036ZM12.3351 6.82773C12.5694 6.59342 12.5694 6.21352 12.3351 5.9792C12.1007 5.74489 11.7208 5.74489 11.4865 5.9792L7.91079 9.55494L6.33506 7.9792C6.10074 7.74489 5.72084 7.74489 5.48653 7.9792C5.25221 8.21352 5.25221 8.59342 5.48653 8.82773L7.48653 10.8277C7.72084 11.062 8.10074 11.062 8.33506 10.8277L12.3351 6.82773Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ei=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(W,Object.assign({},e,{id:"resolved-single",ref:t,icon:en}))});ei.displayName="ResolvedSingle";var ea={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"circle",attrs:{cx:8.73,cy:8.4,r:6.4,stroke:"currentColor",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M6.02637 8.40356L8.02637 10.4036L12.0264 6.40356",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}}]},eo=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(W,Object.assign({},e,{id:"solve-single",ref:t,icon:ea}))});eo.displayName="SolveSingle";let es={threadCommentEditorButtons:"univer-thread-comment-editor-buttons",threadCommentEditorSuggestion:"univer-thread-comment-editor-suggestion",threadCommentEditorSuggestionActive:"univer-thread-comment-editor-suggestionActive",threadCommentEditorSuggestionIcon:"univer-thread-comment-editor-suggestion-icon"},el=/* @__PURE__ */I(e=>{let t=/@\[(.*?)\]\((.*?)\)|(\w+)/g,r,n=0,i=[];for(;null!==(r=t.exec(e));)r.index>n&&i.push({type:"text",content:e.substring(n,r.index)}),r[1]&&r[2]?i.push({type:"mention",content:{label:r[1],id:r[2]}}):r[3]&&i.push({type:"text",content:r[3]}),n=t.lastIndex;return n<e.length&&i.push({type:"text",content:e.substring(n)}),i},"parseMentions"),ed=/* @__PURE__ */I(e=>e.map(e=>"mention"===e.type?`@[${e.content.label}](${e.content.id})`:e.content).join(""),"transformTextNode2Text"),eu=/* @__PURE__ */I(e=>{let{dataStream:t,customRanges:r}=e,n=t.length-2,i=[],a=0;return null==r||r.forEach(e=>{a<e.startIndex&&i.push({type:"text",content:t.slice(a,e.startIndex)}),i.push({type:"mention",content:{label:t.slice(e.startIndex,e.endIndex).slice(1,-1),id:e.rangeId}}),a=e.endIndex}),i.push({type:"text",content:t.slice(a,n)}),i},"transformDocument2TextNodes"),ec=/* @__PURE__ */I(e=>{let t="",r=[];return e.forEach(e=>{switch(e.type){case"text":t+=e.content;break;case"mention":{let n=t.length,i=(t+=`${e.content.label}`).length;r.push({rangeId:e.content.id,rangeType:s.CustomRangeType.MENTION,startIndex:n,endIndex:i})}}}),{textRuns:[],paragraphs:[{startIndex:(t+=`
\r`).length-2,paragraphStyle:{}}],sectionBreaks:[{startIndex:t.length-1}],dataStream:t,customRanges:r}},"transformTextNodes2Document"),eh=/* @__PURE__ */I(e=>({display:e.label,id:`${e.id}`,raw:e}),"transformMention"),em=/* @__PURE__ */I((e,r,n,i,a)=>{var o,s;let l=null==(o=e.raw)?void 0:o.icon;return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:es.threadCommentEditorSuggestion},l?/* @__PURE__ *//*@__PURE__*/t(h).createElement("img",{className:es.threadCommentEditorSuggestionIcon,src:l}):null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,null!=(s=e.display)?s:e.id))},"defaultRenderSuggestion"),ep=(0,h.forwardRef)((e,r)=>{var n,i;let{comment:a,onSave:o,id:l,onCancel:d,autoFocus:u,unitId:m,subUnitId:v}=e,_=(0,s.useDependency)(P),S=(0,s.useDependency)(s.ICommandService),C=(0,s.useDependency)(s.LocaleService),[y,b]=(0,h.useState)({...a}),[w,R]=(0,h.useState)(!1),E=(0,h.useRef)(null),T=(0,s.useDependency)(p.DocSelectionManagerService),M=null==(n=(0,s.useDependency)(f.IRenderManagerService).getCurrentTypeOfRenderer(s.UniverInstanceType.UNIVER_DOC))?void 0:n.with(g.DocSelectionRenderService);(0,h.useImperativeHandle)(r,()=>({reply(e){var t;b({...a,text:e,attachments:[]}),null==(t=E.current)||t.inputElement.focus()}}));let O=/* @__PURE__ */I(()=>{var e;y.text&&(null==o||o({...y,text:y.text}),R(!1),b({text:void 0}),null==(e=E.current)||e.inputElement.blur())},"handleSave");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:es.threadCommentEditor,onClick:/* @__PURE__ */I(e=>e.preventDefault(),"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Mentions,{ref:E,autoFocus:u,style:{width:"100%"},placeholder:C.t("threadCommentUI.editor.placeholder"),value:null!=y&&y.text?ed(eu(y.text)):"",onChange:/* @__PURE__ */I(e=>{e.target.value||b({...a,text:void 0}),null==b||b({...a,text:ec(el(e.target.value))})},"onChange"),onFocus:/* @__PURE__ */I(()=>{let e=T.getActiveTextRange();e&&e.collapsed&&(null==M||M.removeAllRanges()),null==M||M.blur(),R(!0)},"onFocus")},/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Mention,{key:_.trigger,trigger:_.trigger,data:/* @__PURE__ */I((e,t)=>_.getMentions(e,m,v).then(e=>e.map(eh)).then(t),"data"),displayTransform:/* @__PURE__ */I((e,t)=>`@${t} `,"displayTransform"),renderSuggestion:null!=(i=_.renderSuggestion)?i:em})),w?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:es.threadCommentEditorButtons},/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Button,{style:{marginRight:12},onClick:/* @__PURE__ */I(()=>{null==d||d(),R(!1),b({text:void 0}),S.executeCommand(D.id)},"onClick")},C.t("threadCommentUI.editor.cancel")),/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Button,{type:"primary",disabled:!y.text,onClick:O},C.t(l?"threadCommentUI.editor.save":"threadCommentUI.editor.reply"))):null)}),eg={threadComment:"univer-thread-comment",threadCommentActive:"univer-thread-comment-active",threadCommentContent:"univer-thread-comment-content",threadCommentHighlight:"univer-thread-comment-highlight",threadCommentIconContainer:"univer-thread-comment-icon-container",threadCommentIcon:"univer-thread-comment-icon",threadCommentTitle:"univer-thread-comment-title",threadCommentTitlePosition:"univer-thread-comment-title-position",threadCommentTitleHighlight:"univer-thread-comment-title-highlight",threadCommentTitlePositionText:"univer-thread-comment-title-position-text",threadCommentUsername:"univer-thread-comment-username",threadCommentItem:"univer-thread-comment-item",threadCommentItemHead:"univer-thread-comment-item-head",threadCommentItemTitle:"univer-thread-comment-item-title",threadCommentItemTime:"univer-thread-comment-item-time",threadCommentItemContent:"univer-thread-comment-item-content",threadCommentItemAt:"univer-thread-comment-item-at"},ef="__mock__",ev=/* @__PURE__ */I(e=>{let{item:r,unitId:n,subUnitId:i,editing:a,onEditingChange:d,onReply:u,resolved:m,isRoot:p,onClose:g,onDeleteComment:f}=e,v=(0,s.useDependency)(s.ICommandService),_=(0,s.useDependency)(s.LocaleService),S=(0,s.useDependency)(s.UserManagerService),C=S.getUser(r.personId),y=(0,l.useObservable)(S.currentUser$),b=(null==y?void 0:y.userID)===r.personId,w=r.id===ef,[R,E]=(0,h.useState)(!1),T=/* @__PURE__ */I(()=>{(null==f?void 0:f(r))!==!1&&(v.executeCommand(p?o.DeleteCommentTreeCommand.id:o.DeleteCommentCommand.id,{unitId:n,subUnitId:i,commentId:r.id}),p&&(null==g||g()))},"handleDeleteItem");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentItem,onMouseLeave:/* @__PURE__ */I(()=>E(!1),"onMouseLeave"),onMouseEnter:/* @__PURE__ */I(()=>E(!0),"onMouseEnter")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("img",{className:eg.threadCommentItemHead,src:null==C?void 0:C.avatar}),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentItemTitle},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentUsername},(null==C?void 0:C.name)||" "),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,w||m?null:R?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentIcon,onClick:/* @__PURE__ */I(()=>u(C),"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement(er,null)):null,!b||w||m?null:/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Dropdown,{overlay:/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Menu,null,/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.MenuItem,{key:"edit",onClick:/* @__PURE__ */I(()=>null==d?void 0:d(!0),"onClick")},_.t("threadCommentUI.item.edit")),/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.MenuItem,{key:"delete",onClick:T},_.t("threadCommentUI.item.delete")))},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentIcon},/* @__PURE__ *//*@__PURE__*/t(h).createElement(ee,null))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentItemTime},r.dT),a?/* @__PURE__ *//*@__PURE__*/t(h).createElement(ep,{id:r.id,comment:r,onCancel:/* @__PURE__ */I(()=>null==d?void 0:d(!1),"onCancel"),autoFocus:!0,unitId:n,subUnitId:i,onSave:/* @__PURE__ */I(({text:e,attachments:t})=>{null==d||d(!1),v.executeCommand(o.UpdateCommentCommand.id,{unitId:n,subUnitId:i,payload:{commentId:r.id,text:e,attachments:t}})},"onSave")}):/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentItemContent},eu(r.text).map((e,r)=>"mention"===e.type?/* @__PURE__ *//*@__PURE__*/t(h).createElement("a",{className:eg.threadCommentItemAt,key:r},"@",e.content.label," "):e.content)))},"ThreadCommentItem"),e_=/* @__PURE__ */I(e=>{var r,n,i;let{id:a,unitId:d,subUnitId:u,refStr:p,showEdit:g=!0,onClick:f,showHighlight:v,onClose:_,getSubUnitName:S,prefix:y,autoFocus:b,onMouseEnter:w,onMouseLeave:R,onAddComment:E,onDeleteComment:T,onResolve:M}=e,O=(0,s.useDependency)(o.ThreadCommentModel),[U,P]=(0,h.useState)(!1),[k,N]=(0,h.useState)("");(0,l.useObservable)(O.commentMap$);let A=a?O.getCommentWithChildren(d,u,a):null,x=(0,s.useDependency)(s.ICommandService),L=(0,s.useDependency)(s.UserManagerService),V=null==A?void 0:A.root.resolved,F=(0,l.useObservable)(L.currentUser$),j=(0,h.useRef)(null),H=[...A?[A.root]:[{id:ef,text:{dataStream:`
\r`},personId:null!=(r=null==F?void 0:F.userID)?r:"",ref:null!=p?p:"",dT:"",unitId:d,subUnitId:u,threadId:""}],...null!=(n=null==A?void 0:A.children)?n:[]],$=(0,h.useRef)(null),B=/* @__PURE__ */I(e=>{e.stopPropagation(),V?x.executeCommand(D.id,{unitId:d,subUnitId:u,commentId:a}):x.executeCommand(D.id),x.executeCommand(o.ResolveCommentCommand.id,{unitId:d,subUnitId:u,commentId:a,resolved:!V}),null==M||M(!V)},"handleResolve"),W=/* @__PURE__ */I(e=>{e.stopPropagation(),x.executeCommand(D.id),null!=A&&A.root&&(null==T?void 0:T(A.root))===!1||(x.executeCommand(o.DeleteCommentTreeCommand.id,{unitId:d,subUnitId:u,commentId:a}),null==_||_())},"handleDeleteRoot");(0,h.useEffect)(()=>null==R?void 0:R(),[]);let G=S(null!=(i=null==A?void 0:A.root.subUnitId)?i:u),Y=`${p||(null==A?void 0:A.root.ref)||""}${G?"  ":""}${G}`;return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,m.default)(eg.threadComment,{[eg.threadCommentActive]:!V&&(v||U||"cell"===y)}),onClick:f,id:`${y}-${d}-${u}-${a}`,onMouseEnter:/* @__PURE__ */I(()=>{null==w||w(),P(!0)},"onMouseEnter"),onMouseLeave:/* @__PURE__ */I(()=>{null==R||R(),P(!1)},"onMouseLeave")},!V&&v?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentHighlight}):null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentTitle},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentTitlePosition},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentTitleHighlight}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Tooltip,{showIfEllipsis:!0,title:Y},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentTitlePositionText},Y))),A?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentIconContainer},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{onClick:B,className:eg.threadCommentIcon,style:{color:V?"rgb(var(--green-500))":""}},V?/* @__PURE__ *//*@__PURE__*/t(h).createElement(ei,null):/* @__PURE__ *//*@__PURE__*/t(h).createElement(eo,null)),(null==F?void 0:F.userID)===A.root.personId?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentIcon,onClick:W},/* @__PURE__ *//*@__PURE__*/t(h).createElement(X,null)):null):null),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eg.threadCommentContent,ref:$},H.map(e=>/* @__PURE__ *//*@__PURE__*/t(h).createElement(ev,{onClose:_,unitId:d,subUnitId:u,item:e,key:e.id,isRoot:e.id===(null==A?void 0:A.root.id),editing:k===e.id,resolved:null==A?void 0:A.root.resolved,onEditingChange:/* @__PURE__ */I(t=>{N(t?e.id:"")},"onEditingChange"),onReply:/* @__PURE__ */I(e=>{e&&requestAnimationFrame(()=>{var t;null==(t=j.current)||t.reply(ec([{type:"mention",content:{id:e.userID,label:e.name}}]))})},"onReply"),onAddComment:E,onDeleteComment:T}))),!g||k||V?null:/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement(ep,{key:`${b}`,ref:j,unitId:d,subUnitId:u,onSave:/* @__PURE__ */I(async({text:e,attachments:t})=>{let r={text:e,attachments:t,dT:C(),id:(0,s.generateRandomId)(),ref:p,personId:null==F?void 0:F.userID,parentId:null==A?void 0:A.root.id,unitId:d,subUnitId:u,threadId:null==A?void 0:A.root.threadId};(null==E?void 0:E(r))!==!1&&(await x.executeCommand(o.AddCommentCommand.id,{unitId:d,subUnitId:u,comment:r}),$.current&&($.current.scrollTop=$.current.scrollHeight))},"onSave"),autoFocus:b||!A,onCancel:/* @__PURE__ */I(()=>{A||null==_||_()},"onCancel")})))},"ThreadCommentTree"),eI={threadCommentPanel:"univer-thread-comment-panel",threadCommentPanelForms:"univer-thread-comment-panel-forms",threadCommentPanelEmpty:"univer-thread-comment-panel-empty",threadCommentPanelAdd:"univer-thread-comment-panel-add",threadCommentPanelSolved:"univer-thread-comment-panel-solved"},eS=/* @__PURE__ */I(e=>{let{unitId:r,subUnitId$:n,type:i,onAdd:a,getSubUnitName:d,onResolve:u,sortComments:m,onItemLeave:p,onItemEnter:g,disableAdd:f,tempComment:v,onAddComment:_,onDeleteComment:S,showComments:C}=e,[y,b]=(0,h.useState)("all"),[w,R]=(0,h.useState)("all"),E=(0,s.useDependency)(s.LocaleService),T=(0,s.useDependency)(s.UserManagerService),O=(0,s.useDependency)(o.ThreadCommentModel),[U,P]=(0,h.useState)(()=>O.getUnit(r)),k=(0,s.useDependency)(M),N=(0,l.useObservable)(k.activeCommentId$),A=(0,l.useObservable)(O.commentUpdate$),x=(0,s.useDependency)(s.ICommandService),L=(0,l.useObservable)(n),V=(0,h.useRef)(!0),F="panel",j=(0,l.useObservable)(T.currentUser$),H=(0,h.useMemo)(()=>{var e,t;let r=("all"===y?U.map(e=>e[1]).flat():null!=(t=null==(e=U.find(e=>e[0]===L))?void 0:e[1])?t:[]).filter(e=>!e.parentId),n=null!=m?m:e=>e;if(!C)return n(r);{let e=/* @__PURE__ */new Map;return r.forEach(t=>{e.set(t.id,t)}),[...C,""].map(t=>e.get(t)).filter(Boolean)}},[C,y,U,m,L]),$=(0,h.useMemo)(()=>[...H.filter(e=>!e.resolved),...H.filter(e=>e.resolved)],[H]),B=(0,h.useMemo)(()=>"resolved"===w?$.filter(e=>e.resolved):"unsolved"===w?$.filter(e=>!e.resolved):"concern_me"===w&&null!=j&&j.userID?$.map(e=>O.getCommentWithChildren(e.unitId,e.subUnitId,e.id)).map(e=>null!=e&&e.relativeUsers.has(j.userID)?e.root:null).filter(Boolean):$,[$,null==j?void 0:j.userID,w,O]),W=v?[v,...B]:B,G=W.filter(e=>!e.resolved),Y=W.filter(e=>e.resolved),z="all"!==w||"all"!==y,K=/* @__PURE__ */I(()=>{R("all"),b("all")},"onReset");(0,h.useEffect)(()=>{r&&P(O.getUnit(r))},[r,O,A]),(0,h.useEffect)(()=>{var e;if(!N)return;if(!V.current){V.current=!0;return}let{unitId:t,subUnitId:r,commentId:n}=N,i=`${F}-${t}-${r}-${n}`;null==(e=document.getElementById(i))||e.scrollIntoView({block:"center"})},[N]);let q=/* @__PURE__ */I(e=>/* @__PURE__ *//*@__PURE__*/t(h).createElement(e_,{prefix:F,getSubUnitName:d,key:e.id,id:e.id,unitId:e.unitId,subUnitId:e.subUnitId,refStr:e.ref,type:i,showEdit:(null==N?void 0:N.commentId)===e.id,showHighlight:(null==N?void 0:N.commentId)===e.id,onClick:/* @__PURE__ */I(()=>{V.current=!1,e.resolved?x.executeCommand(D.id):x.executeCommand(D.id,{unitId:e.unitId,subUnitId:e.subUnitId,commentId:e.id,temp:!1})},"onClick"),onMouseEnter:/* @__PURE__ */I(()=>null==g?void 0:g(e),"onMouseEnter"),onMouseLeave:/* @__PURE__ */I(()=>null==p?void 0:p(e),"onMouseLeave"),onAddComment:_,onDeleteComment:S,onResolve:/* @__PURE__ */I(t=>null==u?void 0:u(e.id,t),"onResolve")}),"renderComment");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eI.threadCommentPanel},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eI.threadCommentPanelForms},i===s.UniverInstanceType.UNIVER_SHEET?/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Select,{borderless:!0,value:y,onChange:/* @__PURE__ */I(e=>b(e),"onChange"),options:[{value:"current",label:E.t("threadCommentUI.filter.sheet.current")},{value:"all",label:E.t("threadCommentUI.filter.sheet.all")}]}):null,/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Select,{borderless:!0,value:w,onChange:/* @__PURE__ */I(e=>R(e),"onChange"),options:[{value:"all",label:E.t("threadCommentUI.filter.status.all")},{value:"resolved",label:E.t("threadCommentUI.filter.status.resolved")},{value:"unsolved",label:E.t("threadCommentUI.filter.status.unsolved")},{value:"concern_me",label:E.t("threadCommentUI.filter.status.concernMe")}]})),G.map(q),Y.length?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eI.threadCommentPanelSolved},""):null,Y.map(q),W.length?null:/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:eI.threadCommentPanelEmpty},z?E.t("threadCommentUI.panel.filterEmpty"):E.t("threadCommentUI.panel.empty"),z?/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Button,{onClick:K,type:"link"},E.t("threadCommentUI.panel.reset")):/* @__PURE__ *//*@__PURE__*/t(h).createElement(c.Button,{id:"thread-comment-add",className:eI.threadCommentPanelAdd,type:"primary",onClick:a,disabled:f},/* @__PURE__ *//*@__PURE__*/t(h).createElement(Q,null),E.t("threadCommentUI.panel.addComment"))))},"ThreadCommentPanel")}),i("83o4E",function(t,r){let i;e(t.exports,"IThreadCommentDataSourceService",function(){return p}),e(t.exports,"ThreadCommentModel",function(){return S}),e(t.exports,"AddCommentMutation",function(){return O}),e(t.exports,"UpdateCommentRefMutation",function(){return U}),e(t.exports,"DeleteCommentMutation",function(){return k}),e(t.exports,"AddCommentCommand",function(){return N}),e(t.exports,"UpdateCommentCommand",function(){return A}),e(t.exports,"ResolveCommentCommand",function(){return x}),e(t.exports,"DeleteCommentCommand",function(){return L}),e(t.exports,"DeleteCommentTreeCommand",function(){return V}),e(t.exports,"UniverThreadCommentPlugin",function(){return G});var a=n("83KcA"),o=n("jv4BO"),s=n("fElJC"),l=n("2Ha4T"),d=Object.defineProperty,u=(e,t,r)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,c=(e,t)=>d(e,"name",{value:t,configurable:!0}),h=(e,t,r)=>u(e,"symbol"!=typeof t?t+"":t,r);let m=class extends a.Disposable{constructor(){super(),h(this,"_dataSource",null),h(this,"syncUpdateMutationToColla",!0)}set dataSource(e){this._dataSource=e}get dataSource(){return this._dataSource}async getThreadComment(e,t,r){return this._dataSource?(await this._dataSource.listComments(e,t,[r]))[0]:null}async addComment(e){return this._dataSource?this._dataSource.addComment(e):e}async updateComment(e){return!this._dataSource||this._dataSource.updateComment(e)}async resolveComment(e){return!this._dataSource||this._dataSource.resolveComment(e)}async deleteComment(e,t,r,n){return!this._dataSource||this._dataSource.deleteComment(e,t,r,n)}async listThreadComments(e,t,r){return this.dataSource?this.dataSource.listComments(e,t,r):[]}saveToSnapshot(e,t){if(this._dataSource){let t={};return Object.keys(e).forEach(r=>{let n=e[r];t[r]=n.map(this.dataSource.saveCommentToSnapshot)}),t}return e}};c(m,"ThreadCommentDataSourceService");let p=(0,a.createIdentifier)("univer.thread-comment.data-source-service");var g,f=Object.defineProperty,v=Object.getOwnPropertyDescriptor,_=/* @__PURE__ */c((e,t,r,n)=>{for(var i,a=n>1?void 0:n?v(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&f(t,r,a),a},"__decorateClass$2"),I=/* @__PURE__ */c((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let S=(g=class extends a.Disposable{constructor(e,t){super(),h(this,"_commentsMap",{}),h(this,"_commentsTreeMap",/* @__PURE__ */new Map),h(this,"_threadMap",/* @__PURE__ */new Map),h(this,"_commentUpdate$",new l.Subject),h(this,"_commentsMap$",new o.BehaviorSubject({})),h(this,"commentUpdate$",this._commentUpdate$.asObservable()),h(this,"commentMap$",this._commentsMap$.asObservable()),this._dataSourceService=e,this._commandService=t,this.disposeWithMe(()=>{this._commentUpdate$.complete(),this._commentsMap$.complete()})}_ensureCommentMap(e,t){let r=this._commentsMap[e];r||(r={},this._commentsMap[e]=r);let n=r[t];return n||(n={},r[t]=n),n}_ensureCommentChildrenMap(e,t){let r=this._commentsTreeMap.get(e);r||(r=/* @__PURE__ */new Map,this._commentsTreeMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}_ensureThreadMap(e){let t=this._threadMap.get(e);return t||(t=/* @__PURE__ */new Map,this._threadMap.set(e,t)),t}_refreshCommentsMap$(){this._commentsMap$.next({...this._commentsMap})}ensureMap(e,t){return{commentMap:this._ensureCommentMap(e,t),commentChildrenMap:this._ensureCommentChildrenMap(e,t)}}_replaceComment(e,t,r){var n;let{commentMap:i,commentChildrenMap:a}=this.ensureMap(e,t),o=i[r.id];if(o){let s={...r,ref:o.ref};i[r.id]=s,null==(n=r.children)||n.forEach(e=>{i[e.id]={...e,ref:""}}),a.set(r.id,s),this._commentUpdate$.next({unitId:e,subUnitId:t,type:"syncUpdate",payload:s}),!!r.resolved!=!!o.resolved&&this._commentUpdate$.next({unitId:e,subUnitId:t,type:"resolve",payload:{commentId:r.id,resolved:!!r.resolved}})}}async syncThreadComments(e,t,r){let n=await this._dataSourceService.listThreadComments(e,t,r);if(!n.length)return;let i=new Set(r);n.forEach(r=>{this._replaceComment(e,t,r),i.delete(r.threadId)}),i.forEach(t=>{let r=this.getThread(e,t);r&&this.deleteComment(r.unitId,r.subUnitId,r.id)}),this._refreshCommentsMap$()}addComment(e,t,r,n){var i,a;let{commentMap:o,commentChildrenMap:s}=this.ensureMap(e,t),l=/* @__PURE__ */c(r=>{o[r.id]=r,this._commentUpdate$.next({unitId:e,subUnitId:t,type:"add",payload:r,isRoot:!r.parentId})},"addCommentItem"),d=r.parentId;if(d){let e=o[d];e.children=[...null!=(i=e.children)?i:[],r],l(r)}else s.set(r.id,r),this._ensureThreadMap(e).set(r.threadId,r),l(r),null==(a=r.children)||a.forEach(e=>l({...e,ref:""}));return this._refreshCommentsMap$(),n&&this.syncThreadComments(e,t,[r.threadId]),!0}updateComment(e,t,r,n){let{commentMap:i}=this.ensureMap(e,t),a=i[r.commentId];return!!a&&(a.updated=!0,a.text=r.text,a.attachments=r.attachments,a.updateT=r.updateT,this._commentUpdate$.next({unitId:e,subUnitId:t,type:"update",payload:r,silent:n}),this._refreshCommentsMap$(),!0)}updateCommentRef(e,t,r,n){let{commentMap:i}=this.ensureMap(e,t),a=i[r.commentId];return!!a&&(a.ref=r.ref,this._commentUpdate$.next({unitId:e,subUnitId:t,type:"updateRef",payload:r,silent:n}),this._refreshCommentsMap$(),!0)}resolveComment(e,t,r,n){let{commentMap:i}=this.ensureMap(e,t),a=i[r];return!!a&&(a.resolved=n,this._commentUpdate$.next({unitId:e,subUnitId:t,type:"resolve",payload:{commentId:r,resolved:n}}),this._refreshCommentsMap$(),!0)}getComment(e,t,r){let{commentMap:n}=this.ensureMap(e,t);return n[r]}getComment$(e,t,r){return this._commentsMap$.pipe((0,s.map)(n=>n[e][t][r]))}getCommentWithChildren(e,t,r){var n,i;let{commentMap:o,commentChildrenMap:s}=this.ensureMap(e,t),l=o[r];if(!l)return;let d=/* @__PURE__ */new Set,u=s.get(r);if(u)return[u,...null!=(n=u.children)?n:[]].forEach(e=>{var t;d.add(e.personId),null==(t=e.text.customRanges)||t.forEach(e=>{e.rangeType===a.CustomRangeType.MENTION&&d.add(e.rangeId)})}),{root:l,children:null!=(i=u.children)?i:[],relativeUsers:d}}deleteComment(e,t,r){var n;let{commentMap:i,commentChildrenMap:a}=this.ensureMap(e,t),o=i[r];if(!o)return!0;if(o.parentId){let e=a.get(o.parentId);if(e&&e.children){let t=e.children.findIndex(e=>e.id===r);e.children.splice(t,1)}delete i[r]}else{delete i[r];let s=a.get(r);a.delete(r),this._ensureThreadMap(e).delete(o.threadId),null==(n=null==s?void 0:s.children)||n.forEach(r=>{delete i[r.id],this._commentUpdate$.next({unitId:e,subUnitId:t,type:"delete",payload:{commentId:r.id,isRoot:!1,comment:r}})})}return this._commentUpdate$.next({unitId:e,subUnitId:t,type:"delete",payload:{commentId:r,isRoot:!o.parentId,comment:o}}),this._refreshCommentsMap$(),!0}getUnit(e){let t=this._commentsMap[e];return t?Array.from(Object.entries(t)).map(([e,t])=>[e,Array.from(Object.values(t))]):[]}deleteUnit(e){let t=this._commentsMap[e];t&&Object.entries(t).forEach(([t,r])=>{Object.values(r).forEach(r=>{this.deleteComment(e,t,r.id)})})}getRootCommentIds(e,t){return Array.from(this._ensureCommentChildrenMap(e,t).keys())}getAll(){return this._commentsMap}getThread(e,t){return this._ensureThreadMap(e).get(t)}},c(g,"ThreadCommentModel"),g);S=_([I(0,(0,a.Inject)(p)),I(1,a.ICommandService)],S);var C=((i=C||{})[i.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",i[i.UNIVER_DOC=1]="UNIVER_DOC",i[i.UNIVER_SHEET=2]="UNIVER_SHEET",i[i.UNIVER_SLIDE=3]="UNIVER_SLIDE",i[i.UNIVER_PROJECT=4]="UNIVER_PROJECT",i[i.UNRECOGNIZED=-1]="UNRECOGNIZED",i);let y="UNIVER_THREAD_COMMENT_PLUGIN";var b,w=Object.defineProperty,R=Object.getOwnPropertyDescriptor,E=/* @__PURE__ */c((e,t,r,n)=>{for(var i,a=n>1?void 0:n?R(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&w(t,r,a),a},"__decorateClass$1"),T=/* @__PURE__ */c((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let M=(b=class extends a.Disposable{constructor(e,t,r){super(),this._resourceManagerService=e,this._threadCommentModel=t,this._threadCommentDataSourceService=r,this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */c(e=>{let t=this._threadCommentModel.getUnit(e),r={};return t?(t.forEach(([e,t])=>{r[e]=t}),JSON.stringify(this._threadCommentDataSourceService.saveToSnapshot(r,e))):""},"toJson"),t=/* @__PURE__ */c(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:`SHEET_${y}`,businesses:[C.UNIVER_SHEET,C.UNIVER_DOC],toJson:/* @__PURE__ */c(t=>e(t),"toJson"),parseJson:/* @__PURE__ */c(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */c(e=>{this._threadCommentModel.deleteUnit(e)},"onUnLoad"),onLoad:/* @__PURE__ */c(async(e,t)=>{Object.keys(t).forEach(r=>{let n=t[r];n.forEach(t=>{this._threadCommentModel.addComment(e,r,t)}),this._threadCommentModel.syncThreadComments(e,r,n.map(e=>e.threadId))})},"onLoad")}))}},c(b,"ThreadCommentResourceController"),b);M=E([(0,a.OnLifecycle)(a.LifecycleStages.Starting,M),T(0,a.IResourceManagerService),T(1,(0,a.Inject)(S)),T(2,p)],M);let O={id:"thread-comment.mutation.add-comment",type:a.CommandType.MUTATION,handler(e,t,r){if(!t)return!1;let n=e.get(S),{unitId:i,subUnitId:a,comment:o,sync:s}=t,l=s||(null==r?void 0:r.fromChangeset)&&!o.parentId;return n.addComment(i,a,o,l)}},D={id:"thread-comment.mutation.update-comment",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(S),{unitId:n,subUnitId:i,payload:a,silent:o}=t;return r.updateComment(n,i,a,o)}},U={id:"thread-comment.mutation.update-comment-ref",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(S),{unitId:n,subUnitId:i,payload:a,silent:o}=t;return r.updateCommentRef(n,i,a,o)}},P={id:"thread-comment.mutation.resolve-comment",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(S),{unitId:n,subUnitId:i,resolved:a,commentId:o}=t;return r.resolveComment(n,i,o,a)}},k={id:"thread-comment.mutation.delete-comment",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(S),{unitId:n,subUnitId:i,commentId:a}=t;return r.deleteComment(n,i,a)}},N={id:"thread-comment.command.add-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let r=e.get(a.ICommandService),n=e.get(p),{comment:i}=t,o=await n.addComment(i),s=n.syncUpdateMutationToColla,l=!i.parentId,d={id:O.id,params:{...t,comment:o}};return l?await r.executeCommand(d.id,d.params):r.executeCommand(d.id,d.params,{onlyLocal:!s})}},A={id:"thread-comment.command.update-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,payload:i}=t,o=e.get(a.ICommandService),s=e.get(S),l=e.get(p),d=l.syncUpdateMutationToColla,u=s.getComment(r,n,i.commentId);if(!u)return!1;let{children:c,...h}=u;if(!await l.updateComment({...h,...i}))return!1;let m={id:D.id,params:t};return o.executeCommand(m.id,m.params,{onlyLocal:!d}),!0}},x={id:"thread-comment.command.resolve-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,resolved:i,commentId:o}=t,s=e.get(p),l=e.get(S).getComment(r,n,o),d=s.syncUpdateMutationToColla;return!!(l&&await s.resolveComment({...l,resolved:i}))&&e.get(a.ICommandService).executeCommand(P.id,t,{onlyLocal:!d})}},L={id:"thread-comment.command.delete-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let r=e.get(S),n=e.get(p),i=e.get(a.ICommandService),{unitId:o,subUnitId:s,commentId:l}=t,d=n.syncUpdateMutationToColla,u=r.getComment(o,s,l);if(!u||!await n.deleteComment(o,s,u.threadId,l))return!1;let c={id:k.id,params:t};return i.executeCommand(c.id,c.params,{onlyLocal:!d})}},V={id:"thread-comment.command.delete-comment-tree",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let r=e.get(S),n=e.get(a.ICommandService),i=e.get(p),{unitId:o,subUnitId:s,commentId:l}=t,d=r.getCommentWithChildren(o,s,l);return!!(d&&await i.deleteComment(o,s,d.root.threadId,l))&&await n.executeCommand(k.id,{unitId:o,subUnitId:s,commentId:d.root.id})}},F={};var j,H=Object.defineProperty,$=Object.getOwnPropertyDescriptor,B=/* @__PURE__ */c((e,t,r,n)=>{for(var i,a=n>1?void 0:n?$(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&H(t,r,a),a},"__decorateClass"),W=/* @__PURE__ */c((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let G=(c(j=class extends a.Plugin{constructor(e=F,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{...i}=this._config;this._configService.setConfig("thread-comment.config",i)}onStarting(){var e;(0,a.mergeOverrideWithDependencies)([[p,{useClass:m}],[S],[M]],null==(e=this._config)?void 0:e.overrides).forEach(e=>{this._injector.add(e)}),[N,A,L,x,V,O,D,U,k,P].forEach(e=>{this._commandService.registerCommand(e)})}},"UniverThreadCommentPlugin"),h(j,"pluginName",y),h(j,"type",a.UniverInstanceType.UNIVER_UNKNOWN),j);G=B([W(1,(0,a.Inject)(a.Injector)),W(2,a.ICommandService),W(3,a.IConfigService)],G)}),i("idZOd",function(t,r){e(t.exports,"SheetsThreadCommentModel",function(){return _}),e(t.exports,"UniverSheetsThreadCommentBasePlugin",function(){return P});var i,a=n("83KcA"),o=n("ls2nu"),s=n("83o4E"),l=n("kkAWv"),d=n("2Ha4T"),u=Object.defineProperty,c=(e,t,r)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,h=(e,t)=>u(e,"name",{value:t,configurable:!0}),m=(e,t,r)=>c(e,"symbol"!=typeof t?t+"":t,r),p=Object.defineProperty,g=Object.getOwnPropertyDescriptor,f=/* @__PURE__ */h((e,t,r,n)=>{for(var i,a=n>1?void 0:n?g(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&p(t,r,a),a},"__decorateClass$2"),v=/* @__PURE__ */h((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let _=(h(i=class extends a.Disposable{constructor(e,t){super(),m(this,"_matrixMap",/* @__PURE__ */new Map),m(this,"_locationMap",/* @__PURE__ */new Map),m(this,"_commentUpdate$",new d.Subject),m(this,"commentUpdate$",this._commentUpdate$.asObservable()),this._threadCommentModel=e,this._univerInstanceService=t,this._init(),this.disposeWithMe(()=>{this._commentUpdate$.complete()})}_init(){this._initData(),this._initUpdateTransform()}_ensureCommentMatrix(e,t){let r=this._matrixMap.get(e);r||(r=/* @__PURE__ */new Map,this._matrixMap.set(e,r));let n=r.get(t);return n||(n=new a.ObjectMatrix,r.set(t,n)),n}_ensureCommentLocationMap(e,t){let r=this._locationMap.get(e);r||(r=/* @__PURE__ */new Map,this._locationMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}_addCommentToMatrix(e,t,r,n){var i;let a=null!=(i=e.getValue(t,r))?i:/* @__PURE__ */new Set;a.add(n),e.setValue(t,r,a)}_deleteCommentFromMatrix(e,t,r,n){if(t>=0&&r>=0){let i=e.getValue(t,r);i&&i.has(n)&&(i.delete(n),0===i.size&&e.realDeleteValue(t,r))}}_ensure(e,t){return{matrix:this._ensureCommentMatrix(e,t),locationMap:this._ensureCommentLocationMap(e,t)}}_initData(){let e=this._threadCommentModel.getAll();for(let t in e){let r=e[t];for(let e in r){let n=r[e];for(let r in n){let i=n[r];this._addComment(t,e,i)}}}}_addComment(e,t,r){let n=(0,l.singleReferenceToGrid)(r.ref),i=r.parentId,{row:a,column:o}=n,s=r.id,{matrix:d,locationMap:u}=this._ensure(e,t);!i&&a>=0&&o>=0&&(this._addCommentToMatrix(d,a,o,s),u.set(s,{row:a,column:o})),this._commentUpdate$.next({unitId:e,subUnitId:t,payload:r,type:"add",isRoot:!i,...n})}_initUpdateTransform(){this.disposeWithMe(this._threadCommentModel.commentUpdate$.subscribe(e=>{let{unitId:t,subUnitId:r}=e;try{if(this._univerInstanceService.getUnitType(t)!==a.UniverInstanceType.UNIVER_SHEET)return}catch{}let{matrix:n,locationMap:i}=this._ensure(t,r);switch(e.type){case"add":this._addComment(e.unitId,e.subUnitId,e.payload);break;case"delete":{let{isRoot:t,comment:r}=e.payload;if(t){let t=(0,l.singleReferenceToGrid)(r.ref),{row:i,column:a}=t;this._deleteCommentFromMatrix(n,i,a,r.id),this._commentUpdate$.next({...e,...t})}break}case"update":{let{commentId:n}=e.payload,i=this._threadCommentModel.getComment(t,r,n);if(!i)return;let a=(0,l.singleReferenceToGrid)(i.ref);this._commentUpdate$.next({...e,...a});break}case"updateRef":{let t=(0,l.singleReferenceToGrid)(e.payload.ref),{commentId:r}=e.payload,a=i.get(r);if(!a)return;let{row:o,column:s}=a;this._deleteCommentFromMatrix(n,o,s,r),i.delete(r),t.row>=0&&t.column>=0&&(this._addCommentToMatrix(n,t.row,t.column,r),i.set(r,{row:t.row,column:t.column})),this._commentUpdate$.next({...e,...t});break}case"resolve":{let{unitId:t,subUnitId:r,payload:n}=e,{locationMap:i}=this._ensure(t,r),a=i.get(n.commentId);a&&this._commentUpdate$.next({...e,...a})}}}))}getByLocation(e,t,r,n){var i;return null==(i=this.getAllByLocation(e,t,r,n).filter(e=>!e.resolved)[0])?void 0:i.id}getAllByLocation(e,t,r,n){let i=this._ensureCommentMatrix(e,t).getValue(r,n);return i?Array.from(i).map(r=>this.getComment(e,t,r)).filter(Boolean):[]}getComment(e,t,r){return this._threadCommentModel.getComment(e,t,r)}getCommentWithChildren(e,t,r,n){let i=this.getByLocation(e,t,r,n);if(i)return this._threadCommentModel.getCommentWithChildren(e,t,i)}showCommentMarker(e,t,r,n){let i=this.getByLocation(e,t,r,n);if(!i)return!1;let a=this.getComment(e,t,i);return!!(a&&!a.resolved)}getSubUnitAll(e,t){var r,n;return Object.values(null!=(n=null==(r=this._threadCommentModel.getAll()[e])?void 0:r[t])?n:{})}},"SheetsThreadCommentModel"),i);_=f([v(0,(0,a.Inject)(s.ThreadCommentModel)),v(1,a.IUniverInstanceService)],_);var I,S=Object.defineProperty,C=Object.getOwnPropertyDescriptor,y=/* @__PURE__ */h((e,t,r,n)=>{for(var i,a=n>1?void 0:n?C(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&S(t,r,a),a},"__decorateClass$1"),b=/* @__PURE__ */h((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let w=(I=class extends a.Disposable{constructor(e,t,r,n,i){super(),m(this,"_disposableMap",/* @__PURE__ */new Map),m(this,"_watcherMap",/* @__PURE__ */new Map),m(this,"_handleRangeChange",/* @__PURE__ */h((e,t,r,n,i)=>{let a=r.id,o={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};return n?{redos:[{id:s.UpdateCommentRefMutation.id,params:{unitId:e,subUnitId:t,payload:{ref:(0,l.serializeRange)(n),commentId:a},silent:i}}],undos:[{id:s.UpdateCommentRefMutation.id,params:{unitId:e,subUnitId:t,payload:{ref:(0,l.serializeRange)(o),commentId:a},silent:i}}]}:{redos:[{id:s.DeleteCommentMutation.id,params:{unitId:e,subUnitId:t,commentId:a}}],undos:[{id:s.AddCommentMutation.id,params:{unitId:e,subUnitId:t,comment:r,sync:!0}}]}},"_handleRangeChange")),this._refRangeService=e,this._sheetsThreadCommentModel=t,this._threadCommentModel=r,this._selectionManagerService=n,this._commandService=i,this._initData(),this._initRefRange()}_getIdWithUnitId(e,t,r){return`${e}-${t}-${r}`}_register(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._disposableMap.set(this._getIdWithUnitId(e,t,n),this._refRangeService.registerRefRange(i,n=>{let a=(0,o.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests)(i,n,{selectionManagerService:this._selectionManagerService}),s=Array.isArray(a)?a[0]:a;return s&&s.startColumn===i.startColumn&&s.startRow===i.startRow?{undos:[],redos:[]}:this._handleRangeChange(e,t,r,s,!1)},e,t))}_watch(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._watcherMap.set(this._getIdWithUnitId(e,t,n),this._refRangeService.watchRange(e,t,i,(n,i)=>{let{redos:o}=this._handleRangeChange(e,t,r,i,!0);(0,a.sequenceExecuteAsync)(o,this._commandService,{onlyLocal:!0})},!0))}_unwatch(e,t,r){var n;let i=this._getIdWithUnitId(e,t,r);null==(n=this._watcherMap.get(i))||n.dispose(),this._watcherMap.delete(i)}_unregister(e,t,r){var n;let i=this._getIdWithUnitId(e,t,r);null==(n=this._disposableMap.get(i))||n.dispose(),this._disposableMap.delete(i)}_initData(){let e=this._threadCommentModel.getAll();for(let t in e){let r=e[t];for(let e in r){let n=r[e];for(let r in n){let i=n[r],a=i.ref,o=(0,l.singleReferenceToGrid)(a),s={...i,...o};this._register(t,e,s),this._watch(t,e,s)}}}}_initRefRange(){this.disposeWithMe(this._sheetsThreadCommentModel.commentUpdate$.subscribe(e=>{let{unitId:t,subUnitId:r}=e;switch(e.type){case"add":{if(e.payload.parentId)return;let t={...e.payload,row:e.row,column:e.column};this._register(e.unitId,e.subUnitId,t),this._watch(e.unitId,e.subUnitId,t);break}case"delete":this._unregister(t,r,e.payload.commentId),this._unwatch(t,r,e.payload.commentId);break;case"updateRef":{let n=this._sheetsThreadCommentModel.getComment(t,r,e.payload.commentId);if(!n)return;this._unregister(t,r,e.payload.commentId);let i={...n,row:e.row,column:e.column};e.silent||(this._unwatch(t,r,e.payload.commentId),this._watch(t,r,i)),this._register(e.unitId,e.subUnitId,i)}}})),this.disposeWithMe((0,a.toDisposable)(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}},h(I,"SheetsThreadCommentRefRangeController"),I);w=y([(0,a.OnLifecycle)(a.LifecycleStages.Starting,w),b(0,(0,a.Inject)(o.RefRangeService)),b(1,(0,a.Inject)(_)),b(2,(0,a.Inject)(s.ThreadCommentModel)),b(3,(0,a.Inject)(o.SheetsSelectionsService)),b(4,a.ICommandService)],w);var R,E=Object.defineProperty,T=Object.getOwnPropertyDescriptor,M=/* @__PURE__ */h((e,t,r)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),O=/* @__PURE__ */h((e,t,r,n)=>{for(var i,a=n>1?void 0:n?T(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&E(t,r,a),a},"__decorateClass"),D=/* @__PURE__ */h((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),U=/* @__PURE__ */h((e,t,r)=>M(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let P=(h(R=class extends a.Plugin{constructor(e,t,r){super(),this._injector=t,this._commandService=r}onStarting(){[[_],[w]].forEach(e=>{this._injector.add(e)})}},"UniverSheetsThreadCommentBasePlugin"),R);U(P,"pluginName","SHEET_THREAD_COMMENT_BASE_PLUGIN"),U(P,"type",a.UniverInstanceType.UNIVER_SHEET),P=O([(0,a.DependentOn)(s.UniverThreadCommentPlugin),D(1,(0,a.Inject)(a.Injector)),D(2,(0,a.Inject)(a.ICommandService))],P)}),i("inPpN",function(r,i){e(r.exports,"SheetCanvasFloatDomManagerService",function(){return eY});var a,o=n("83KcA"),s=n("jyvj4"),l=n("91LjJ"),d=n("e3ZB7"),u=n("D79YY"),c=n("11kpD"),h=n("cahIb"),m=n("jv4BO"),p=n("5WWyv"),g=n("eSxk0"),f=n("a9FIH"),v=n("fElJC"),_=n("2Ha4T"),I=n("cZW0b"),S=n("ls2nu"),C=n("gQuIR"),y=n("bLx5G"),b=n("1dwVM"),w=Object.defineProperty,R=(e,t,r)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,E=(e,t)=>w(e,"name",{value:t,configurable:!0}),T=(e,t,r)=>R(e,"symbol"!=typeof t?t+"":t,r);let M={id:"sheet.operation.clear-drawing-transformer",type:o.CommandType.MUTATION,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(u.IRenderManagerService);return t.forEach(e=>{var t,n;null==(n=null==(t=r.getRenderById(e))?void 0:t.scene.getTransformer())||n.debounceRefreshControls()}),!0},"handler")},O={id:"sheet.command.remove-sheet-image",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(o.ICommandService),n=e.get(o.IUndoRedoService),i=e.get(l.ISheetDrawingService);if(!t)return!1;let{drawings:a}=t,s=[];a.forEach(e=>{let{unitId:t}=e;s.push(t)});let{unitId:d,subUnitId:u,undo:c,redo:h,objects:m}=i.getBatchRemoveOp(a);return!!r.syncExecuteCommand(l.SetDrawingApplyMutation.id,{unitId:d,subUnitId:u,op:h,objects:m,type:l.DrawingApplyType.REMOVE})&&(n.pushUndoRedo({unitID:d,undoMutations:[{id:l.SetDrawingApplyMutation.id,params:{unitId:d,subUnitId:u,op:c,objects:m,type:l.DrawingApplyType.INSERT}},{id:M.id,params:s}],redoMutations:[{id:l.SetDrawingApplyMutation.id,params:{unitId:d,subUnitId:u,op:h,objects:m,type:l.DrawingApplyType.REMOVE}},{id:M.id,params:s}]}),!0)},"handler")},D="COMPONENT_SHEET_DRAWING_PANEL",U={id:"sidebar.operation.sheet-image",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E(async(e,t)=>{let r=e.get(h.ISidebarService),n=e.get(o.LocaleService),i=e.get(o.IUniverInstanceService),a=e.get(d.IDrawingManagerService);return!!(0,S.getSheetCommandTarget)(i)&&("open"===t.value?r.open({header:{title:n.t("sheetImage.panel.title")},children:{label:D},onClose:/* @__PURE__ */E(()=>{a.focusDrawing(null)},"onClose"),width:360}):r.close(),!0)},"handler")},P={id:"sheet.operation.edit-sheet-image",type:o.CommandType.OPERATION,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(d.IDrawingManagerService),n=e.get(o.ICommandService);return null!=t&&(r.focusDrawing([t]),n.executeCommand(U.id,{value:"open"}),!0)},"handler")},k=/* @__PURE__ */E(()=>{let e=(0,o.useDependency)(d.IImageIoService),r=(0,o.useDependency)(o.LocaleService),[n,i]=/*@__PURE__*/t(C).useState(0);return(0,C.useEffect)(()=>{let t=e.change$.subscribe(e=>{i(e)});return()=>{t.unsubscribe()}},[e]),/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{style:{display:n>0?"block":"none"},className:"univer-upload-loading"},/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:"univer-upload-loading-body"},/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:"univer-upload-loading-body-animation"}),/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:"univer-upload-loading-body-text"},`${r.t("uploadLoading.loading")}: ${n}`)))},"UploadLoading");var N,A=Object.defineProperty,x=Object.getOwnPropertyDescriptor,L=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?x(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&A(t,r,a),a},"__decorateClass$9"),V=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let F=(E(N=class extends o.RxDisposable{constructor(e,t,r,n,i,a,o){super(),T(this,"_initImagePopupMenu",/* @__PURE__ */new Set),this._injector=e,this._drawingManagerService=t,this._canvasPopManagerService=r,this._renderManagerService=n,this._univerInstanceService=i,this._contextService=a,this._uiPartsService=o,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(o.UniverInstanceType.UNIVER_SHEET).pipe((0,I.takeUntil)(this.dispose$)).subscribe(e=>this._create(e)),this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_SHEET).pipe((0,I.takeUntil)(this.dispose$)).subscribe(e=>this._dispose(e)),this._univerInstanceService.getAllUnitsForType(o.UniverInstanceType.UNIVER_SHEET).forEach(e=>this._create(e)),this._uiPartsService.registerComponent(h.BuiltInUIPart.CONTENT,()=>(0,o.connectInjector)(k,this._injector))}_dispose(e){let t=e.getUnitId();this._renderManagerService.removeRender(t)}_create(e){if(!e)return;let t=e.getUnitId();this._renderManagerService.has(t)&&!this._initImagePopupMenu.has(t)&&(this._popupMenuListener(t),this._initImagePopupMenu.add(t))}_hasCropObject(e){for(let t of e.getAllObjectsByOrder())if(t instanceof s.ImageCropperObject)return!0;return!1}_popupMenuListener(e){var t;let r;let n=null==(t=this._renderManagerService.getRenderById(e))?void 0:t.scene;if(!n)return;let i=n.getTransformerByCreate();i&&(this.disposeWithMe((0,o.toDisposable)(i.createControl$.subscribe(()=>{if(this._contextService.setContextValue(o.FOCUSING_COMMON_DRAWINGS,!0),this._hasCropObject(n))return;let e=i.getSelectedObjectMap();if(e.size>1){null==r||r.dispose();return}let t=e.values().next().value;if(!t)return;let a=t.oKey,l=this._drawingManagerService.getDrawingOKey(a);if(!l)return;let{unitId:d,subUnitId:u,drawingId:c,drawingType:h}=l;null==r||r.dispose(),r=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(t,{componentKey:s.COMPONENT_IMAGE_POPUP_MENU,direction:"horizontal",offset:[2,0],extraProps:{menuItems:this._getImageMenuItems(d,u,c,h)}})),this._drawingManagerService.focusDrawing([{unitId:d,subUnitId:u,drawingId:c}])}))),this.disposeWithMe(i.clearControl$.subscribe(()=>{null==r||r.dispose(),this._contextService.setContextValue(o.FOCUSING_COMMON_DRAWINGS,!1),this._drawingManagerService.focusDrawing(null)})),this.disposeWithMe(i.changing$.subscribe(()=>{null==r||r.dispose()})))}_getImageMenuItems(e,t,r,n){return[{label:"image-popup.edit",index:0,commandId:P.id,commandParams:{unitId:e,subUnitId:t,drawingId:r},disable:n===d.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:O.id,commandParams:{unitId:e,drawings:[{unitId:e,subUnitId:t,drawingId:r}]},disable:!1},{label:"image-popup.crop",index:2,commandId:s.OpenImageCropOperation.id,commandParams:{unitId:e,subUnitId:t,drawingId:r},disable:n===d.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:s.ImageResetSizeOperation.id,commandParams:[{unitId:e,subUnitId:t,drawingId:r}],disable:n===d.DrawingTypeEnum.DRAWING_DOM}]}},"DrawingPopupMenuController"),N);function j(e,t,r){let{from:n,to:i,flipY:a=!1,flipX:o=!1,angle:s=0,skewX:l=0,skewY:d=0}=e,{column:h,columnOffset:m,row:p,rowOffset:g}=n,{column:f,columnOffset:v,row:_,rowOffset:I}=i,S=r.getCurrentSkeleton(),C=(0,c.attachRangeWithCoord)(S,{startColumn:h,endColumn:h,startRow:p,endRow:p});if(null==C)return;let y=(0,c.attachRangeWithCoord)(S,{startColumn:f,endColumn:f,startRow:_,endRow:_});if(null==y)return;let{startX:b,startY:w}=C,{startX:R,startY:E}=y,T=(0,u.precisionTo)(b+m,1),M=(0,u.precisionTo)(w+g,1),O=(0,u.precisionTo)(R+v-T,1),D=(0,u.precisionTo)(E+I-M,1);C.startX===y.endX&&(O=0),C.startY===y.endY&&(D=0);let U=S.rowHeaderWidth+S.columnTotalWidth,P=S.columnHeaderHeight+S.rowTotalHeight;return T+O>U&&(T=U-O),M+D>P&&(M=P-D),{flipY:a,flipX:o,angle:s,skewX:l,skewY:d,left:T,top:M,width:O,height:D}}function H(e,t){let{left:r=0,top:n=0,width:i=0,height:a=0,flipY:o=!1,flipX:s=!1,angle:l=0,skewX:d=0,skewY:c=0}=e,h=t.getSelectionCellByPosition(r,n);if(null==h)return;let m={column:h.actualColumn,columnOffset:(0,u.precisionTo)(r-h.startX,1),row:h.actualRow,rowOffset:(0,u.precisionTo)(n-h.startY,1)},p=t.getSelectionCellByPosition(r+i,n+a);if(null!=p)return{flipY:o,flipX:s,angle:l,skewX:d,skewY:c,from:m,to:{column:p.actualColumn,columnOffset:(0,u.precisionTo)(r+i-p.startX,1),row:p.actualRow,rowOffset:(0,u.precisionTo)(n+a-p.startY,1)}}}function $(e){let t=[];return e.forEach(e=>{let{parent:r,children:n}=e,{unitId:i,subUnitId:a,drawingId:o}=r,s=(0,u.getGroupState)(0,0,n.map(e=>e.transform||{})),l=n.map(e=>{let t=e.transform||{left:0,top:0},{unitId:r,subUnitId:n,drawingId:i}=e;return{unitId:r,subUnitId:n,drawingId:i,transform:{...t,left:t.left-s.left,top:t.top-s.top},groupId:o}}),c={unitId:i,subUnitId:a,drawingId:o,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:s};t.push({parent:c,children:l})}),t}function B(e){let t=[];return e.forEach(e=>{let{parent:r,children:n}=e,{unitId:i,subUnitId:a,drawingId:o,transform:s={width:0,height:0}}=r;if(null==s)return;let l=n.map(e=>{let{transform:t}=e,{unitId:r,subUnitId:n,drawingId:i}=e;return{unitId:r,subUnitId:n,drawingId:i,transform:(0,u.transformObjectOutOfGroup)(t||{},s,s.width||0,s.height||0),groupId:void 0}}),c={unitId:i,subUnitId:a,drawingId:o,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:{left:0,top:0}};t.push({parent:c,children:l})}),t}F=L([(0,o.OnLifecycle)(o.LifecycleStages.Steady,F),V(0,(0,o.Inject)(o.Injector)),V(1,d.IDrawingManagerService),V(2,(0,o.Inject)(c.SheetCanvasPopManagerService)),V(3,u.IRenderManagerService),V(4,o.IUniverInstanceService),V(5,o.IContextService),V(6,(0,o.Inject)(h.IUIPartsService))],F),E(j,"drawingPositionToTransform"),E(H,"transformToDrawingPosition"),E($,"ungroupToGroup"),E(B,"groupToUngroup");let W={id:"sheet.command.group-sheet-image",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(o.ICommandService),n=e.get(o.IUndoRedoService),i=e.get(l.ISheetDrawingService);if(!t)return!1;let a=[];t.forEach(({parent:e,children:t})=>{a.push(e.unitId),t.forEach(e=>{a.push(e.unitId)})});let{unitId:s,subUnitId:d,undo:u,redo:c,objects:h}=i.getGroupDrawingOp(t);return!!r.syncExecuteCommand(l.SetDrawingApplyMutation.id,{op:c,unitId:s,subUnitId:d,objects:h,type:l.DrawingApplyType.GROUP})&&(n.pushUndoRedo({unitID:s,undoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:d,objects:B(h),type:l.DrawingApplyType.UNGROUP}},{id:M.id,params:a}],redoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:c,unitId:s,subUnitId:d,objects:h,type:l.DrawingApplyType.GROUP}},{id:M.id,params:a}]}),!0)},"handler")},G={id:"sheet.command.insert-sheet-image",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(o.ICommandService),n=e.get(o.IUndoRedoService),i=e.get(l.ISheetDrawingService);if(!t)return!1;let a=t.drawings,s=a.map(e=>e.unitId),{unitId:d,subUnitId:u,undo:c,redo:h,objects:m}=i.getBatchAddOp(a);return!!r.syncExecuteCommand(l.SetDrawingApplyMutation.id,{op:h,unitId:d,subUnitId:u,objects:m,type:l.DrawingApplyType.INSERT})&&(n.pushUndoRedo({unitID:d,undoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:c,unitId:d,subUnitId:u,objects:m,type:l.DrawingApplyType.REMOVE}},{id:M.id,params:s}],redoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:h,unitId:d,subUnitId:u,objects:m,type:l.DrawingApplyType.INSERT}},{id:M.id,params:s}]}),!0)},"handler")},Y={id:"sheet.command.set-drawing-arrange",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E((e,t)=>{let r;let n=e.get(o.ICommandService),i=e.get(o.IUndoRedoService);if(!t)return!1;let a=e.get(l.ISheetDrawingService),{unitId:s,subUnitId:u,drawingIds:c,arrangeType:h}=t,m={unitId:s,subUnitId:u,drawingIds:c};if(h===d.ArrangeTypeEnum.forward?r=a.getForwardDrawingsOp(m):h===d.ArrangeTypeEnum.backward?r=a.getBackwardDrawingOp(m):h===d.ArrangeTypeEnum.front?r=a.getFrontDrawingsOp(m):h===d.ArrangeTypeEnum.back&&(r=a.getBackDrawingsOp(m)),null==r)return!1;let{objects:p,redo:g,undo:f}=r;return!!n.syncExecuteCommand(l.SetDrawingApplyMutation.id,{op:g,unitId:s,subUnitId:u,objects:p,type:l.DrawingApplyType.ARRANGE})&&(i.pushUndoRedo({unitID:s,undoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:f,unitId:s,subUnitId:u,objects:p,type:l.DrawingApplyType.ARRANGE}}],redoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:g,unitId:s,subUnitId:u,objects:p,type:l.DrawingApplyType.ARRANGE}}]}),!0)},"handler")},z={id:"sheet.command.set-sheet-image",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(o.ICommandService),n=e.get(o.IUndoRedoService),i=e.get(l.ISheetDrawingService);if(!t)return!1;let{drawings:a}=t,{unitId:s,subUnitId:d,undo:u,redo:c,objects:h}=i.getBatchUpdateOp(a);return!!r.syncExecuteCommand(l.SetDrawingApplyMutation.id,{unitId:s,subUnitId:d,op:c,objects:h,type:l.DrawingApplyType.UPDATE})&&(n.pushUndoRedo({unitID:s,undoMutations:[{id:l.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:u,objects:h,type:l.DrawingApplyType.UPDATE}},{id:M.id,params:[s]}],redoMutations:[{id:l.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:c,objects:h,type:l.DrawingApplyType.UPDATE}},{id:M.id,params:[s]}]}),!0)},"handler")},K={id:"sheet.command.ungroup-sheet-image",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(o.ICommandService),n=e.get(o.IUndoRedoService),i=e.get(l.ISheetDrawingService);if(!t)return!1;let a=[];t.forEach(({parent:e,children:t})=>{a.push(e.unitId),t.forEach(e=>{a.push(e.unitId)})});let{unitId:s,subUnitId:d,undo:u,redo:c,objects:h}=i.getUngroupDrawingOp(t);return!!r.syncExecuteCommand(l.SetDrawingApplyMutation.id,{op:c,unitId:s,subUnitId:d,objects:h,type:l.DrawingApplyType.UNGROUP})&&(n.pushUndoRedo({unitID:s,undoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:d,objects:$(h),type:l.DrawingApplyType.GROUP}},{id:M.id,params:a}],redoMutations:[{id:l.SetDrawingApplyMutation.id,params:{op:c,unitId:s,subUnitId:d,objects:h,type:l.DrawingApplyType.UNGROUP}},{id:M.id,params:a}]}),!0)},"handler")};var q,X=Object.defineProperty,Z=Object.getOwnPropertyDescriptor,Q=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&X(t,r,a),a},"__decorateClass$8"),J=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");let ee=(E(q=class extends o.Disposable{constructor(e,t,r,n,i,a,o,s,l,d,u,c){super(),T(this,"_workbookSelections"),this._context=e,this._skeletonManagerService=t,this._commandService=r,this._selectionRenderService=n,this._imageIoService=i,this._fileOpenerService=a,this._sheetDrawingService=o,this._drawingManagerService=s,this._contextService=l,this._messageService=d,this._localeService=u,this._workbookSelections=c.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){let e=await this._fileOpenerService.openFile({multiple:!0,accept:(0,d.DRAWING_IMAGE_ALLOW_IMAGE_LIST).map(e=>`.${e.replace("image/","")}`).join(",")}),t=e.length;return t>d.DRAWING_IMAGE_COUNT_LIMIT?(this._messageService.show({type:y.MessageType.Error,content:this._localeService.t("update-status.exceedMaxCount",String(d.DRAWING_IMAGE_COUNT_LIMIT))}),!1):0!==t&&(e.forEach(async e=>await this._insertFloatImage(e)),!0)}async _insertFloatImage(e){let t;try{t=await this._imageIoService.saveImage(e)}catch(t){let e=t.message;e===d.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:y.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(d.DRAWING_IMAGE_ALLOW_SIZE/1048576))}):e===d.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:y.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):e===d.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:y.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(null==t)return;let{unitId:r,subUnitId:n}=this._getUnitInfo(),{imageId:i,imageSourceType:a,source:o,base64Cache:s}=t,{width:l,height:u,image:c}=await (0,d.getImageSize)(s||""),{width:h,height:m}=this._context.scene;this._imageIoService.addImageSourceCache(o,a,c);let p=1;(l>d.DRAWING_IMAGE_WIDTH_LIMIT||u>d.DRAWING_IMAGE_HEIGHT_LIMIT)&&(p=Math.max(d.DRAWING_IMAGE_WIDTH_LIMIT/l,d.DRAWING_IMAGE_HEIGHT_LIMIT/u));let g=this._getImagePosition(l*p,u*p,h,m);if(null==g)return;let f={unitId:r,subUnitId:n,drawingId:i,drawingType:d.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:a,source:o,transform:j(g,this._selectionRenderService,this._skeletonManagerService),sheetTransform:g};this._commandService.executeCommand(G.id,{unitId:r,drawings:[f]})}_getUnitInfo(){let e=this._context.unit,t=e.getActiveSheet();return{unitId:e.getUnitId(),subUnitId:t.getSheetId()}}_getImagePosition(e,t,r,n){let i=this._workbookSelections.getCurrentSelections(),a={startRow:0,endRow:0,startColumn:0,endColumn:0};i&&i.length>0&&(a=i[i.length-1].range);let o=(0,c.attachRangeWithCoord)(this._skeletonManagerService.getCurrent().skeleton,a);if(null==o)return;let{startColumn:s,startRow:l,startX:d,startY:u}=o,h=!1;if(d+e>r&&((d=r-e)<0&&(d=0,e=r),h=!0),u+t>n&&((u=n-t)<0&&(u=0,t=n),h=!0),h){let e=this._selectionRenderService.getSelectionCellByPosition(d,u);if(null==e)return;d=e.startX,u=e.startY,s=e.actualColumn,l=e.actualRow}let m={column:s,columnOffset:0,row:l,rowOffset:0},p=this._selectionRenderService.getSelectionCellByPosition(d+e,u+t);if(null!=p)return{from:m,to:{column:p.actualColumn,columnOffset:d+e-p.startX,row:p.actualRow,rowOffset:u+t-p.startY}}}_updateOrderListener(){this._drawingManagerService.featurePluginOrderUpdate$.subscribe(e=>{let{unitId:t,subUnitId:r,drawingIds:n,arrangeType:i}=e;this._commandService.executeCommand(Y.id,{unitId:t,subUnitId:r,drawingIds:n,arrangeType:i})})}_updateImageListener(){this._drawingManagerService.featurePluginUpdate$.subscribe(e=>{let t=[];0!==e.length&&(e.forEach(e=>{let{unitId:r,subUnitId:n,drawingId:i,drawingType:a,transform:o}=e;if(null==o)return;let s=this._sheetDrawingService.getDrawingByParam({unitId:r,subUnitId:n,drawingId:i});if(null==s||s.unitId!==this._context.unitId)return;let l=H({...s.transform,...o},this._selectionRenderService);if(null==l)return;let d={...e,transform:{...s.transform,...o,...j(l,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...l}};t.push(d)}),t.length>0&&this._commandService.executeCommand(z.id,{unitId:e[0].unitId,drawings:t}))})}_groupDrawingListener(){this._drawingManagerService.featurePluginGroupUpdate$.subscribe(e=>{this._commandService.executeCommand(W.id,e);let{unitId:t,subUnitId:r,drawingId:n}=e[0].parent;this._drawingManagerService.focusDrawing([{unitId:t,subUnitId:r,drawingId:n}])}),this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(e=>{this._commandService.executeCommand(K.id,e)})}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(e=>{null==e||0===e.length?(this._contextService.setContextValue(o.FOCUSING_COMMON_DRAWINGS,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(o.FOCUSING_COMMON_DRAWINGS,!0),this._sheetDrawingService.focusDrawing(e))}))}},"SheetDrawingUpdateController"),q);ee=Q([J(1,(0,o.Inject)(c.SheetSkeletonManagerService)),J(2,o.ICommandService),J(3,c.ISheetSelectionRenderService),J(4,d.IImageIoService),J(5,h.ILocalFileService),J(6,l.ISheetDrawingService),J(7,d.IDrawingManagerService),J(8,o.IContextService),J(9,h.IMessageService),J(10,(0,o.Inject)(o.LocaleService)),J(11,(0,o.Inject)(S.SheetsSelectionsService))],ee);var et=function(){return(et=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},er=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},en=(0,C.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=er(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,C.useRef)("_".concat(es()));return ei(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},et({ref:t,className:s},o),a)});function ei(e,t,r,n,i){return(0,C.createElement)(e.tag,et(et({key:t},ea(e,r,i)),n),(eo(e,r).children||[]).map(function(n,a){return ei(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function ea(e,t,r){var n=et({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function eo(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?et(et({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?et(et({},e),{attrs:et(et({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function es(){return Math.random().toString(36).substring(2,8)}E(ei,"render"),E(ea,"replaceRuntimeIdsAndExtInAttrs"),E(eo,"replaceRuntimeIdsInDefs"),E(es,"generateShortUuid"),en.displayName="UniverIcon";var el={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M2.2498 3.65005C2.2498 2.87685 2.87661 2.25005 3.64981 2.25005H7.9998C8.33118 2.25005 8.5998 1.98142 8.5998 1.65005C8.5998 1.31868 8.33118 1.05005 7.9998 1.05005H3.64981C2.21387 1.05005 1.0498 2.21411 1.0498 3.65005V12.35C1.0498 13.786 2.21386 14.95 3.6498 14.95H12.3498C13.7857 14.95 14.9498 13.786 14.9498 12.3501V8.00005C14.9498 7.66868 14.6812 7.40005 14.3498 7.40005C14.0184 7.40005 13.7498 7.66868 13.7498 8.00005V9.23974L12.2385 8.1063C11.7252 7.72129 11.0068 7.7723 10.5531 8.22605L9.00869 9.77041L6.73916 7.8251C6.24387 7.40055 5.5095 7.41278 5.02864 7.85359L2.2498 10.4009V3.65005ZM2.2498 12.0287V12.35C2.2498 13.1232 2.87661 13.75 3.6498 13.75H12.3498C13.123 13.75 13.7498 13.1232 13.7498 12.3501V10.7397L11.5186 9.06631C11.4829 9.03956 11.433 9.04314 11.4016 9.07458L9.92249 10.5537L11.1015 11.5642C11.3531 11.7799 11.3822 12.1587 11.1666 12.4103C10.9509 12.6619 10.5721 12.691 10.3205 12.4753L5.9582 8.7362C5.92384 8.70674 5.87288 8.70758 5.83952 8.73816L2.2498 12.0287Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M11.8097 1.14783C12.1411 1.14783 12.4097 1.41646 12.4097 1.74783V3.297H14.1541C14.4855 3.297 14.7541 3.56563 14.7541 3.897C14.7541 4.22837 14.4855 4.497 14.1541 4.497H12.4097V6.24167C12.4097 6.57304 12.1411 6.84167 11.8097 6.84167C11.4783 6.84167 11.2097 6.57304 11.2097 6.24167V4.497H9.6603C9.32893 4.497 9.0603 4.22837 9.0603 3.897C9.0603 3.56563 9.32893 3.297 9.6603 3.297H11.2097V1.74783C11.2097 1.41646 11.4783 1.14783 11.8097 1.14783Z"}}]},ed=(0,C.forwardRef)(function(e,t){return(0,C.createElement)(en,Object.assign({},e,{id:"add-image-single",ref:t,icon:el}))});ed.displayName="AddImageSingle";let eu={id:"sheet.command.insert-float-image",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E(e=>{var t,r;return null!=(r=null==(t=e.get(u.IRenderManagerService).getCurrentTypeOfRenderer(o.UniverInstanceType.UNIVER_SHEET))?void 0:t.with(ee).insertFloatImage())&&r},"handler")},ec="addition-and-subtraction-single",eh="sheet.menu.image";function em(e){return{id:eh,type:h.MenuItemType.SUBITEMS,icon:ec,tooltip:"sheetImage.title",hidden$:(0,h.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_SHEET),disabled$:(0,c.getCurrentRangeDisable$)(e,{workbookTypes:[S.WorkbookEditablePermission],worksheetTypes:[S.WorksheetEditPermission],rangeTypes:[S.RangeProtectionPermissionEditPoint]})}}function ep(e){return{id:eu.id,title:"sheetImage.upload.float",type:h.MenuItemType.BUTTON,hidden$:(0,h.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_SHEET)}}E(em,"ImageMenuFactory"),E(ep,"UploadFloatImageMenuFactory");let eg={imageCommonPanel:"univer-image-common-panel",imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelColumn:"univer-image-common-panel-column"},ef=/* @__PURE__ */E(e=>{var r;let n=(0,o.useDependency)(o.ICommandService),i=(0,o.useDependency)(o.LocaleService),a=(0,o.useDependency)(d.IDrawingManagerService),s=(0,o.useDependency)(u.IRenderManagerService),{drawings:c}=e,h=c[0];if(null==h)return;let{unitId:m}=h,p=s.getRenderById(m),g=null==p?void 0:p.scene;if(null==g)return;let f=g.getTransformerByCreate(),[v,_]=(0,C.useState)(!0),I=null!=(r=h.anchorType)?r:l.SheetDrawingAnchorType.Position,[S,w]=(0,C.useState)(I);function R(e,t){let r=[];return e.forEach(e=>{let{oKey:n}=e,i=t.getDrawingOKey(n);if(null==i)return r.push(null),!0;let{unitId:a,subUnitId:o,drawingId:s,drawingType:l,anchorType:d,sheetTransform:u}=i;r.push({unitId:a,subUnitId:o,drawingId:s,anchorType:d,sheetTransform:u,drawingType:l})}),r}function T(e){w(e);let t=a.getFocusDrawings();if(0===t.length)return;let r=t.map(t=>({unitId:t.unitId,subUnitId:t.subUnitId,drawingId:t.drawingId,anchorType:e}));n.executeCommand(z.id,{unitId:t[0].unitId,drawings:r})}E(R,"getUpdateParams"),(0,C.useEffect)(()=>{let e=f.clearControl$.subscribe(e=>{!0===e&&_(!1)}),t=f.changeStart$.subscribe(e=>{var t;let{objects:r}=e,n=R(r,a);0===n.length?_(!1):n.length>=1&&(_(!0),w((null==(t=n[0])?void 0:t.anchorType)||l.SheetDrawingAnchorType.Position))});return()=>{t.unsubscribe(),e.unsubscribe()}},[]),E(T,"handleChange");let M=/* @__PURE__ */E(e=>e?"block":"none","gridDisplay");return /* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:(0,b.default)(eg.imageCommonPanelGrid,eg.imageCommonPanelBorder),style:{display:M(v)}},/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:eg.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:(0,b.default)(eg.imageCommonPanelColumn,eg.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",null,i.t("drawing-anchor.title")))),/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:(0,b.default)(eg.imageCommonPanelRow)},/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:(0,b.default)(eg.imageCommonPanelColumn)},/* @__PURE__ *//*@__PURE__*/t(C).createElement(y.RadioGroup,{value:S,onChange:T,direction:"vertical"},/* @__PURE__ *//*@__PURE__*/t(C).createElement(y.Radio,{value:l.SheetDrawingAnchorType.Both},i.t("drawing-anchor.both")),/* @__PURE__ *//*@__PURE__*/t(C).createElement(y.Radio,{value:l.SheetDrawingAnchorType.Position},i.t("drawing-anchor.position")),/* @__PURE__ *//*@__PURE__*/t(C).createElement(y.Radio,{value:l.SheetDrawingAnchorType.None},i.t("drawing-anchor.none"))))))},"SheetDrawingAnchor"),ev=/* @__PURE__ */E(()=>{let e=(0,o.useDependency)(d.IDrawingManagerService),r=e.getFocusDrawings(),[n,i]=(0,C.useState)(r);return(0,C.useEffect)(()=>{let t=e.focus$.subscribe(e=>{i(e)});return()=>{t.unsubscribe()}},[]),!!(null!=n&&n.length)&&/* @__PURE__ *//*@__PURE__*/t(C).createElement("div",{className:eg.imageCommonPanel},/* @__PURE__ *//*@__PURE__*/t(C).createElement(s.DrawingCommonPanel,{drawings:n}),/* @__PURE__ *//*@__PURE__*/t(C).createElement(ef,{drawings:n}))},"SheetDrawingPanel"),e_={id:"sheet.command.move-drawing",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E((e,t)=>{let r=e.get(o.ICommandService),n=e.get(l.ISheetDrawingService),i=e.get(c.ISheetSelectionRenderService),{direction:a}=t,s=n.getFocusDrawings();if(0===s.length)return!1;let d=s[0].unitId,u=s.map(e=>{let{transform:t}=e;if(null==t)return null;let r={...t},{left:n=0,top:s=0}=t;return a===o.Direction.UP?r.top=s-1:a===o.Direction.DOWN?r.top=s+1:a===o.Direction.LEFT?r.left=n-1:a===o.Direction.RIGHT&&(r.left=n+1),{...e,transform:r,sheetTransform:H(r,i)}}).filter(e=>null!=e);return!!r.syncExecuteCommand(z.id,{unitId:d,drawings:u})&&(r.syncExecuteCommand(M.id,[d]),!0)},"handler")},eI={id:"sheet.command.delete-drawing",type:o.CommandType.COMMAND,handler:/* @__PURE__ */E(e=>{let t=e.get(o.ICommandService),r=e.get(l.ISheetDrawingService).getFocusDrawings();if(0===r.length)return!1;let n=r[0].unitId,i=r.map(e=>{let{unitId:t,subUnitId:r,drawingId:n,drawingType:i}=e;return{unitId:t,subUnitId:r,drawingId:n,drawingType:i}});return t.executeCommand(O.id,{unitId:n,drawings:i})},"handler")};function eS(e){return!e.getContextValue(o.FOCUSING_FX_BAR_EDITOR)&&!e.getContextValue(o.EDITOR_ACTIVATED)&&e.getContextValue(o.FOCUSING_COMMON_DRAWINGS)}E(eS,"whenSheetDrawingFocused");let eC={id:e_.id,description:"shortcut.sheet.drawing-move-down",group:"4_sheet-drawing-view",binding:h.KeyCode.ARROW_DOWN,priority:100,preconditions:eS,staticParameters:{direction:o.Direction.DOWN}},ey={id:e_.id,description:"shortcut.sheet.drawing-move-up",group:"4_sheet-drawing-view",binding:h.KeyCode.ARROW_UP,priority:100,preconditions:eS,staticParameters:{direction:o.Direction.UP}},eb={id:e_.id,description:"shortcut.sheet.drawing-move-left",group:"4_sheet-drawing-view",binding:h.KeyCode.ARROW_LEFT,priority:100,preconditions:eS,staticParameters:{direction:o.Direction.LEFT}},ew={id:e_.id,description:"shortcut.sheet.drawing-move-right",group:"4_sheet-drawing-view",binding:h.KeyCode.ARROW_RIGHT,priority:100,preconditions:eS,staticParameters:{direction:o.Direction.RIGHT}},eR={id:eI.id,description:"shortcut.sheet.drawing-delete",group:"4_sheet-drawing-view",preconditions:eS,binding:h.KeyCode.DELETE,mac:h.KeyCode.BACKSPACE},eE={[h.RibbonStartGroup.FORMULAS_INSERT]:{[eh]:{order:3,menuItemFactory:em,[eu.id]:{order:0,menuItemFactory:ep}}}};var eT,eM=Object.defineProperty,eO=Object.getOwnPropertyDescriptor,eD=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eO(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eM(t,r,a),a},"__decorateClass$7"),eU=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let eP=(E(eT=class extends o.Disposable{constructor(e,t,r,n,i){super(),this._injector=e,this._componentManager=t,this._menuManagerService=r,this._commandService=n,this._shortcutService=i,this._init()}_initCustomComponents(){let e=this._componentManager;this.disposeWithMe(e.register(ec,ed)),this.disposeWithMe(e.register(D,ev))}_initMenus(){this._menuManagerService.mergeMenu(eE)}_initCommands(){[eu,G,O,z,U,M,P,W,K,e_,eI,Y].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_initShortcuts(){[eC,ey,eb,ew,eR].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}},"SheetDrawingUIController"),eT);eP=eD([(0,o.OnLifecycle)(o.LifecycleStages.Rendered,eP),eU(0,(0,o.Inject)(o.Injector)),eU(1,(0,o.Inject)(h.ComponentManager)),eU(2,h.IMenuManagerService),eU(3,o.ICommandService),eU(4,h.IShortcutService)],eP);var ek=Object.defineProperty,eN=Object.getOwnPropertyDescriptor,eA=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eN(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ek(t,r,a),a},"__decorateClass$6"),ex=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let eL=[S.InsertRowCommand.id,S.InsertColCommand.id,S.RemoveRowCommand.id,S.RemoveColCommand.id,S.DeleteRangeMoveLeftCommand.id,S.DeleteRangeMoveUpCommand.id,S.InsertRangeMoveDownCommand.id,S.InsertRangeMoveRightCommand.id,S.DeltaRowHeightCommand.id,S.SetRowHeightCommand.id,S.DeltaColumnWidthCommand.id,S.SetColWidthCommand.id,S.SetRowHiddenCommand.id,S.SetSpecificRowsVisibleCommand.id,S.SetSpecificColsVisibleCommand.id,S.SetColHiddenCommand.id,S.MoveColsCommand.id,S.MoveRowsCommand.id,S.MoveRangeCommand.id],eV=[S.SetRowVisibleMutation.id,S.SetRowHiddenMutation.id,S.SetColVisibleMutation.id,S.SetColHiddenMutation.id,S.SetWorksheetRowHeightMutation.id,S.SetWorksheetColWidthMutation.id],eF=(ez=class extends o.Disposable{constructor(e,t,r,n,i,a,o,s,l){super(),this._context=e,this._renderManagerService=t,this._commandService=r,this._selectionRenderService=n,this._skeletonManagerService=i,this._sheetInterceptorService=a,this._sheetDrawingService=o,this._drawingManagerService=s,this._univerInstanceService=l,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */E(e=>{if(!eL.includes(e.id)||null==e.params)return{redos:[],undos:[]};let t=e.id;if(t===S.InsertRowCommand.id)return this._moveRowInterceptor(e.params,"insert");if([(0,S.MoveColsCommand).id,(0,S.MoveRowsCommand).id,(0,S.MoveRangeCommand).id].includes(t))return this._moveRangeInterceptor(e.params);if(t===S.InsertColCommand.id)return this._moveColInterceptor(e.params,"insert");if(t===S.RemoveRowCommand.id)return this._moveRowInterceptor(e.params,"remove");if(t===S.RemoveColCommand.id)return this._moveColInterceptor(e.params,"remove");if(t===S.DeleteRangeMoveLeftCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,0)}if(t===S.DeleteRangeMoveUpCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,1)}if(t===S.InsertRangeMoveDownCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,2)}if(t===S.InsertRangeMoveRightCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,3)}if(t===S.SetRowHiddenCommand.id||t===S.SetSpecificRowsVisibleCommand.id){let{unitId:t,subUnitId:r,ranges:n}=e.params;return this._getDrawingUndoForRowVisible(t,r,n)}if(t===S.SetSpecificColsVisibleCommand.id||t===S.SetColHiddenCommand.id){let{unitId:t,subUnitId:r,ranges:n}=e.params;return this._getDrawingUndoForColVisible(t,r,n)}if(t===S.DeltaRowHeightCommand.id||t===S.SetRowHeightCommand.id||t===S.DeltaColumnWidthCommand.id||t===S.SetColWidthCommand.id){let{unitId:r,subUnitId:n,ranges:i}=e.params,a=t===S.DeltaRowHeightCommand.id||t===S.SetRowHeightCommand.id;return this._getDrawingUndoForRowAndColSize(r,n,i,a)}return{redos:[],undos:[]}},"getMutations")}))}_getRangeMoveUndo(e,t){let r=(0,S.getSheetCommandTarget)(this._univerInstanceService);if(null==r)return{redos:[],undos:[]};let n=r.unitId,i=r.subUnitId,a=[],o=[],s=this._sheetDrawingService.getDrawingData(n,i),d=[],u=[];if(Object.keys(s).forEach(r=>{let n=s[r],{updateDrawings:i,deleteDrawings:a}=this._getUpdateOrDeleteDrawings(e,t,n);d.push(...i),u.push(...a)}),0===d.length&&0===u.length)return{redos:[],undos:[]};if(d.length>0){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(d);a.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:r,type:l.DrawingApplyType.UPDATE}}),o.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:e,objects:r,type:l.DrawingApplyType.UPDATE}})}if(u.length>0){let e=this._sheetDrawingService.getBatchRemoveOp(u),t=e.undo,r=e.redo,s=e.objects;a.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:r,objects:s,type:l.DrawingApplyType.REMOVE}}),o.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:s,type:l.DrawingApplyType.INSERT}})}return a.push({id:M.id,params:[n]}),o.push({id:M.id,params:[n]}),{redos:a,undos:o}}_getUpdateOrDeleteDrawings(e,t,r){let n=[],i=[],{sheetTransform:a,anchorType:o=l.SheetDrawingAnchorType.Position,transform:s,unitId:d,subUnitId:u,drawingId:c}=r,{from:h,to:m}=a,{row:p,column:g}=h,{row:f,column:v}=m;if(null==a||null==s)return{updateDrawings:n,deleteDrawings:i};let{startRow:_,endRow:I,startColumn:S,endColumn:C}=e,y=null,b=null;if(0===t&&p>=_&&f<=I){if(g>=S&&v<=C)i.push({unitId:d,subUnitId:u,drawingId:c});else{let e=this._shrinkCol(a,s,S,C,o);y=null==e?void 0:e.newSheetTransform,b=null==e?void 0:e.newTransform}}else if(1===t&&g>=S&&v<=C){if(p>=_&&f<=I)i.push({unitId:d,subUnitId:u,drawingId:c});else{let e=this._shrinkRow(a,s,_,I,o);y=null==e?void 0:e.newSheetTransform,b=null==e?void 0:e.newTransform}}else if(2===t){let e=this._expandRow(a,s,_,I,o);y=null==e?void 0:e.newSheetTransform,b=null==e?void 0:e.newTransform}else if(3===t){let e=this._expandCol(a,s,S,C,o);y=null==e?void 0:e.newSheetTransform,b=null==e?void 0:e.newTransform}if(null!=y&&null!=b){let e=j(y,this._selectionRenderService,this._skeletonManagerService);n.push({...r,sheetTransform:y,transform:e})}return{updateDrawings:n,deleteDrawings:i}}_remainDrawingSize(e,t,r){let n=H({...e},this._selectionRenderService);null!=n&&t.push({...r,sheetTransform:n})}_getDrawingUndoForColVisible(e,t,r){let n=this._drawingManagerService.getDrawingData(e,t),i=[],a=[];if(Object.keys(n).forEach(e=>{let t=n[e],{sheetTransform:o,transform:s,anchorType:d=l.SheetDrawingAnchorType.Position}=t;if(d===l.SheetDrawingAnchorType.None)this._remainDrawingSize(s,i,t);else{let{from:e,to:n}=o,{row:u,column:c}=e,{row:h,column:m}=n;for(let o=0;o<r.length;o++){let{startRow:u,endRow:h,startColumn:p,endColumn:g}=r[o];if(m<p)continue;if(d===l.SheetDrawingAnchorType.Position){let r=null,a=null;if(c>=p&&c<=g){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:c,endColumn:g,startRow:e.row,endRow:n.row});if(null==t)return;a={...s,left:t.startX}}if(null!=a&&null!=(r=H(a,this._selectionRenderService))&&null!=a){i.push({...t,sheetTransform:r,transform:a});break}this._remainDrawingSize(s,i,t);continue}if(c>=p&&m<=g)continue;let f=null,v=null;if(c>=p&&c<=g){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:c,endColumn:g,startRow:e.row,endRow:n.row});if(null==t)return;v={...s,left:(null==t?void 0:t.startX)||0,width:((null==s?void 0:s.width)||0)-t.endX+t.startX}}else if(m>=p&&m<=g){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:p,endColumn:m,startRow:e.row,endRow:n.row});if(null==t)return;v={...s,left:t.startX-((null==s?void 0:s.width)||0)}}else{let r=this._skeletonManagerService.attachRangeWithCoord({startColumn:p,endColumn:g,startRow:e.row,endRow:n.row});if(null==r)return;if(null!=(f=H(v={...s,width:((null==s?void 0:s.width)||0)-r.endX+r.startX},this._selectionRenderService))&&null!=v){a.push({...t,sheetTransform:f,transform:v});break}}if(null!=v&&(f=H(v,this._selectionRenderService)),null!=v&&null!=f){i.push({...t,sheetTransform:f,transform:v});break}this._remainDrawingSize(s,i,t)}}}),0===i.length&&0===a.length)return{redos:[],undos:[]};let{redos:o,undos:s}=this._createUndoAndRedoMutation(e,t,i),d=[],u=[];if(a.length>0){let{redos:r,undos:n}=this._createUndoAndRedoMutation(e,t,a);d.push(...r),u.push(...n)}return{redos:o,undos:s,preRedos:d,preUndos:u}}_createUndoAndRedoMutation(e,t,r){let{undo:n,redo:i,objects:a}=this._sheetDrawingService.getBatchUpdateOp(r);return{redos:[{id:l.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:i,objects:a,type:l.DrawingApplyType.UPDATE}},{id:M.id,params:[e]}],undos:[{id:l.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:n,objects:a,type:l.DrawingApplyType.UPDATE}},{id:M.id,params:[e]}]}}_getDrawingUndoForRowVisible(e,t,r){let n=this._drawingManagerService.getDrawingData(e,t),i=[],a=[];if(Object.keys(n).forEach(e=>{let t=n[e],{sheetTransform:o,transform:s,anchorType:d=l.SheetDrawingAnchorType.Position}=t;if(d===l.SheetDrawingAnchorType.None)this._remainDrawingSize(s,i,t);else{let{from:e,to:n}=o,{row:u,column:c}=e,{row:h,column:m}=n;for(let o=0;o<r.length;o++){let{startRow:c,endRow:m,startColumn:p,endColumn:g}=r[o];if(h<c)continue;if(d===l.SheetDrawingAnchorType.Position){let r=null,a=null;if(u>=c&&u<=m){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:u,endRow:m});if(null==t)return;a={...s,top:t.startY}}if(null!=a&&null!=(r=H(a,this._selectionRenderService))&&null!=a){i.push({...t,sheetTransform:r,transform:a});break}this._remainDrawingSize(s,i,t);continue}if(u>=c&&h<=m)continue;let f=null,v=null;if(u>=c&&u<=m){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:u,endRow:m});if(null==t)return;v={...s,top:(null==t?void 0:t.startY)||0,height:((null==s?void 0:s.height)||0)-t.endY+t.startY}}else if(h>=c&&h<=m){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:c,endRow:h});if(null==t)return;v={...s,top:t.startY-((null==s?void 0:s.height)||0)}}else{let r=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:c,endRow:m});if(null==r)return;if(null!=(f=H(v={...s,height:((null==s?void 0:s.height)||0)-r.endY+r.startY},this._selectionRenderService))&&null!=v){a.push({...t,sheetTransform:f,transform:v});break}}if(null!=v&&(f=H(v,this._selectionRenderService)),null!=v&&null!=f){i.push({...t,sheetTransform:f,transform:v});break}this._remainDrawingSize(s,i,t)}}}),0===i.length&&0===a.length)return{redos:[],undos:[]};let{redos:o,undos:s}=this._createUndoAndRedoMutation(e,t,i),d=[],u=[];if(a.length>0){let{redos:r,undos:n}=this._createUndoAndRedoMutation(e,t,a);d.push(...r),u.push(...n)}return{redos:o,undos:s,preRedos:d,preUndos:u}}_getDrawingUndoForRowAndColSize(e,t,r,n){let i=this._drawingManagerService.getDrawingData(e,t),a=[];return Object.keys(i).forEach(e=>{let t=i[e],{sheetTransform:n,transform:o,anchorType:s=l.SheetDrawingAnchorType.Position}=t;if(s===l.SheetDrawingAnchorType.None)this._remainDrawingSize(o,a,t);else{let{from:e,to:i}=n,{row:d,column:u}=e,{row:c,column:h}=i;for(let e=0;e<r.length;e++){let{startRow:i,endRow:m,startColumn:p,endColumn:g}=r[e];if(c<i||h<p)continue;if(s===l.SheetDrawingAnchorType.Position&&(d<=i&&c>=m||u<=p&&h>=g)){this._remainDrawingSize(o,a,t);continue}let f=j({...n},this._selectionRenderService,this._skeletonManagerService);if(null!=f){a.push({...t,transform:f});break}}}}),0===a.length?{redos:[],undos:[]}:this._createUndoAndRedoMutation(e,t,a)}_getUnitIdAndSubUnitId(e,t){let r,n;if("insert"===t)r=e.unitId,n=e.subUnitId;else{let e=(0,S.getSheetCommandTarget)(this._univerInstanceService);if(null==e)return;r=e.unitId,n=e.subUnitId}return{unitId:r,subUnitId:n}}_moveRangeInterceptor(e){var t,r;let{toRange:n,fromRange:i}=e,a=(0,S.getSheetCommandTarget)(this._univerInstanceService);if(!a)return{redos:[],undos:[]};let{unitId:o,subUnitId:s}=a,d=null==(r=null==(t=this._renderManagerService.getRenderById(o))?void 0:t.with(c.SheetSkeletonManagerService))?void 0:r.getCurrentSkeleton();if(!d)return{redos:[],undos:[]};let u=(0,c.attachRangeWithCoord)(d,i);if(!u)return{redos:[],undos:[]};let{startX:h,endX:m,startY:p,endY:g}=u,f=this._sheetDrawingService.getDrawingData(o,s),v=[];Object.keys(f).forEach(e=>{let t=f[e];if(t.anchorType!==l.SheetDrawingAnchorType.Both)return;let{transform:r}=t;if(!r)return;let{left:n=0,top:i=0,width:a=0,height:o=0}=r,{drawingStartX:s,drawingEndX:d,drawingStartY:u,drawingEndY:c}={drawingStartX:n,drawingEndX:n+a,drawingStartY:i,drawingEndY:i+o};h<=s&&d<=m&&p<=u&&c<=g&&v.push(t)});let _=[],I=[],C=n.startRow-i.startRow,y=n.startColumn-i.startColumn,b=v.map(e=>{let t=e.sheetTransform,r={to:{...t.to,row:t.to.row+C,column:t.to.column+y},from:{...t.from,row:t.from.row+C,column:t.from.column+y}},n=j(r,this._selectionRenderService,this._skeletonManagerService);return{unitId:o,subUnitId:s,drawingId:e.drawingId,transform:n,sheetTransform:r}});if(b.length){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(b);_.push({id:l.SetDrawingApplyMutation.id,params:{unitId:o,subUnitId:s,op:t,objects:r,type:l.DrawingApplyType.UPDATE}}),I.push({id:l.SetDrawingApplyMutation.id,params:{unitId:o,subUnitId:s,op:e,objects:r,type:l.DrawingApplyType.UPDATE}})}return{redos:_,undos:I}}_moveRowInterceptor(e,t){let r=this._getUnitIdAndSubUnitId(e,t);if(null==r)return{redos:[],undos:[]};let{unitId:n,subUnitId:i}=r,{range:a}=e,o=a.startRow,s=a.endRow,d=[],u=[],c=this._sheetDrawingService.getDrawingData(n,i),h=[],m=[];if(Object.keys(c).forEach(e=>{let r,a;let{sheetTransform:d,transform:u,anchorType:p=l.SheetDrawingAnchorType.Position}=c[e];if(null==d||null==u)return;if("insert"===t){let e=this._expandRow(d,u,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}else{let{from:t,to:c}=d,{row:h}=t,{row:g}=c;if(p===l.SheetDrawingAnchorType.Both&&h>=o&&g<=s)m.push({unitId:n,subUnitId:i,drawingId:e});else{let e=this._shrinkRow(d,u,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}}if(!r||!a)return;let g={unitId:n,subUnitId:i,drawingId:e,transform:a,sheetTransform:r};h.push(g)}),0===h.length&&0===m.length)return{redos:[],undos:[]};if(h.length>0){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(h);d.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:r,type:l.DrawingApplyType.UPDATE}}),u.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:e,objects:r,type:l.DrawingApplyType.UPDATE}})}if(m.length>0){let e=this._sheetDrawingService.getBatchRemoveOp(m),t=e.undo,r=e.redo,a=e.objects;d.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:r,objects:a,type:l.DrawingApplyType.REMOVE}}),u.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:a,type:l.DrawingApplyType.INSERT}})}return d.push({id:M.id,params:[n]}),u.push({id:M.id,params:[n]}),{redos:d,undos:u}}_moveColInterceptor(e,t){let r=this._getUnitIdAndSubUnitId(e,t);if(null==r)return{redos:[],undos:[]};let{unitId:n,subUnitId:i}=r,{range:a}=e,o=a.startColumn,s=a.endColumn,d=[],u=[],c=this._sheetDrawingService.getDrawingData(n,i),h=[],m=[];if(Object.keys(c).forEach(e=>{let r,a;let{sheetTransform:d,transform:u,anchorType:p=l.SheetDrawingAnchorType.Position}=c[e];if(null==d||null==u)return;if("insert"===t){let e=this._expandCol(d,u,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}else{let{from:t,to:c}=d,{column:h}=t,{column:g}=c;if(p===l.SheetDrawingAnchorType.Both&&h>=o&&g<=s)m.push({unitId:n,subUnitId:i,drawingId:e});else{let e=this._shrinkCol(d,u,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}}if(!r||!a)return;let g={unitId:n,subUnitId:i,drawingId:e,transform:a,sheetTransform:r};h.push(g)}),0===h.length&&0===m.length)return{redos:[],undos:[]};if(h.length>0){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(h);d.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:r,type:l.DrawingApplyType.UPDATE}}),u.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:e,objects:r,type:l.DrawingApplyType.UPDATE}})}if(m.length>0){let e=this._sheetDrawingService.getBatchRemoveOp(m),t=e.undo,r=e.redo,a=e.objects;d.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:r,objects:a,type:l.DrawingApplyType.REMOVE}}),u.push({id:l.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:a,type:l.DrawingApplyType.INSERT}})}return d.push({id:M.id,params:[n]}),u.push({id:M.id,params:[n]}),{redos:d,undos:u}}_expandCol(e,t,r,n,i=l.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{column:d}=o,{column:u}=s;if(i===l.SheetDrawingAnchorType.None)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};let c=null,h=null;if(d>=r){let e=this._skeletonManagerService.attachRangeWithCoord({startColumn:r,endColumn:n,startRow:o.row,endRow:s.row});if(null==e)return;c=H(h={...t,left:(t.left||0)+e.endX-e.startX},this._selectionRenderService)}else if(u>=n){if(i!==l.SheetDrawingAnchorType.Both)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};h=j(c={from:{...o},to:{...s,column:u+a}},this._selectionRenderService,this._skeletonManagerService)}return null!=c&&null!=h?{newSheetTransform:c,newTransform:h}:null}_shrinkCol(e,t,r,n,i=l.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{column:d}=o,{column:u}=s;if(i===l.SheetDrawingAnchorType.None)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};let c=null,h=null;if(d>n)h=j(c={from:{...o,column:d-a},to:{...s,column:u-a}},this._selectionRenderService,this._skeletonManagerService);else{if(d>=r&&u<=n)return null;if(d<r&&u>n){if(i!==l.SheetDrawingAnchorType.Both)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};h=j(c={from:{...o},to:{...s,column:u-a}},this._selectionRenderService,this._skeletonManagerService)}else if(d>=r&&d<=n){if(d===r)h={...t,left:(t.left||0)-e.from.columnOffset};else{let n=this._skeletonManagerService.attachRangeWithCoord({startColumn:r,endColumn:d-1,startRow:o.row,endRow:s.row});if(null==n)return;h={...t,left:(t.left||0)-n.endX+n.startX-e.from.columnOffset}}c=H(h,this._selectionRenderService)}else if(u>=r&&u<=n&&i===l.SheetDrawingAnchorType.Both){let e=this._skeletonManagerService.attachRangeWithCoord({startColumn:r-1,endColumn:r-1,startRow:o.row,endRow:s.row});if(null==e)return;h=j(c={from:{...o},to:{...s,column:r-1,columnOffset:e.endX-e.startX}},this._selectionRenderService,this._skeletonManagerService)}}return null!=c&&null!=h?{newSheetTransform:c,newTransform:h}:null}_expandRow(e,t,r,n,i=l.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{row:d}=o,{row:u}=s;if(i===l.SheetDrawingAnchorType.None)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};let c=null,h=null;if(d>=r){let e=this._skeletonManagerService.attachRangeWithCoord({startRow:r,endRow:n,startColumn:o.column,endColumn:s.column});if(null==e)return;c=H(h={...t,top:(t.top||0)+e.endY-e.startY},this._selectionRenderService)}else if(u>=n){if(i!==l.SheetDrawingAnchorType.Both)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};h=j(c={from:{...o},to:{...s,row:u+a}},this._selectionRenderService,this._skeletonManagerService)}return null!=c&&null!=h?{newSheetTransform:c,newTransform:h}:null}_shrinkRow(e,t,r,n,i=l.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{row:d}=o,{row:u}=s;if(i===l.SheetDrawingAnchorType.None)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};let c=null,h=null;if(d>n)h=j(c={from:{...o,row:d-a},to:{...s,row:u-a}},this._selectionRenderService,this._skeletonManagerService);else{if(d>=r&&u<=n)return null;if(d<r&&u>n){if(i!==l.SheetDrawingAnchorType.Both)return{newSheetTransform:H({...t},this._selectionRenderService),newTransform:t};h=j(c={from:{...o},to:{...s,row:u-a}},this._selectionRenderService,this._skeletonManagerService)}else if(d>=r&&d<=n){if(d===r)h={...t,top:(t.top||0)-e.from.rowOffset};else{let n=this._skeletonManagerService.attachRangeWithCoord({startRow:r,endRow:d-1,startColumn:o.column,endColumn:s.column});if(null==n)return;h={...t,top:(t.top||0)-n.endY+n.startY-e.from.rowOffset}}c=H(h,this._selectionRenderService)}else if(u>=r&&u<=n&&i===l.SheetDrawingAnchorType.Both){let e=this._skeletonManagerService.attachRangeWithCoord({startColumn:o.column,endColumn:o.column,startRow:r-1,endRow:r-1});if(null==e)return;h=j(c={from:{...o},to:{...s,row:r-1,rowOffset:e.endY-e.startY}},this._selectionRenderService,this._skeletonManagerService)}}return null!=c&&null!=h?{newSheetTransform:c,newTransform:h}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{e.id===S.SetWorksheetActiveOperation.id&&setTimeout(()=>{let{unitId:t,subUnitId:r}=e.params,n=this._drawingManagerService.drawingManagerData,i=[],a=[];Object.keys(n).forEach(e=>{let o=n[e];null!=o&&Object.keys(o).forEach(n=>{let s=o[n].data;null!=s&&Object.keys(s).forEach(o=>{if(e===t&&n===r){let e=s[o];e.transform=j(e.sheetTransform,this._selectionRenderService,this._skeletonManagerService),i.push(s[o])}else a.push(s[o])})})}),this._drawingManagerService.removeNotification(a),this._drawingManagerService.addNotification(i)},0)}))}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{eV.includes(e.id)&&requestIdleCallback(()=>{let{unitId:t,subUnitId:r,ranges:n}=e.params;this._refreshDrawingTransform(t,r,n)})}))}_refreshDrawingTransform(e,t,r){let n=this._drawingManagerService.getDrawingData(e,t),i=[];Object.keys(n).forEach(e=>{let t=n[e],{sheetTransform:a,transform:s,anchorType:d=l.SheetDrawingAnchorType.Position}=t;if(d===l.SheetDrawingAnchorType.None)return!0;let{from:u,to:c}=a,{row:h,column:m}=u,{row:p,column:g}=c;for(let e=0;e<r.length;e++){let{startRow:n,endRow:u,startColumn:c,endColumn:f}=r[e];if((0,o.Rectangle).intersects({startRow:n,endRow:u,startColumn:c,endColumn:f},{startRow:h,endRow:p,startColumn:m,endColumn:g})||h>u||m>f){let e=d===l.SheetDrawingAnchorType.Position,r=j(a,this._selectionRenderService,this._skeletonManagerService);i.push({...t,transform:{...r,width:e?null==s?void 0:s.width:null==r?void 0:r.width,height:e?null==s?void 0:s.height:null==r?void 0:r.height}});break}}}),0!==i.length&&(this._drawingManagerService.refreshTransform(i),this._commandService.syncExecuteCommand(M.id,[e]))}},E(ez,"SheetDrawingTransformAffectedController"),ez);eF=eA([ex(1,u.IRenderManagerService),ex(2,o.ICommandService),ex(3,c.ISheetSelectionRenderService),ex(4,(0,o.Inject)(c.SheetSkeletonManagerService)),ex(5,(0,o.Inject)(S.SheetInterceptorService)),ex(6,l.ISheetDrawingService),ex(7,d.IDrawingManagerService),ex(8,o.IUniverInstanceService)],eF);var ej=Object.defineProperty,eH=Object.getOwnPropertyDescriptor,e$=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eH(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ej(t,r,a),a},"__decorateClass$5"),eB=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");function eW(e,t,r,n){let i,a,o,s;let{scaleX:l,scaleY:d}=t.getAncestorScale(),c=t.getViewport(u.SHEET_VIEWPORT_KEY.VIEW_MAIN),h={left:!0,top:!0};if(!c)return{...e,absolute:h};let{left:m,right:p,top:g,bottom:f}=e,{startColumn:v,startRow:_,xSplit:I,ySplit:S}=n.getFreeze(),C=r.getNoMergeCellPositionByIndexWithNoHeader(_-S,v-I),y=r.getNoMergeCellPositionByIndexWithNoHeader(_,v),{rowHeaderWidth:b,columnHeaderHeight:w}=r,R=y.startX-C.startX,E=y.startY-C.startY,{top:T,left:M,viewportScrollX:O,viewportScrollY:D}=c;return m<M?(h.left=!0,i=(R+b+(m-M))*l,a=Math.max(Math.min((R+b+(p-M))*l,(R+b)*l),(p-O)*l)):(h.left=!1,i=Math.max((m-O)*l,(R+b)*l),a=Math.max((p-O)*l,(R+b)*l)),g<T?(h.top=!0,o=(E+w+(g-T))*d,s=Math.max(Math.min((E+w+(p-T))*d,(E+w)*d),(f-D)*d)):(h.top=!1,o=Math.max((g-D)*d,(E+w)*d),s=Math.max((f-D)*d,(E+w)*d)),{left:i,right:a,top:o,bottom:s,absolute:h}}E(eW,"transformBound2DOMBound");let eG=/* @__PURE__ */E((e,t,r,n)=>{let{scene:i}=t,{left:a,top:o,width:s,height:l,angle:d}=e,u=eW({left:a,right:a+s,top:o,bottom:o+l},i,r,n);return{startX:u.left,endX:u.right,startY:u.top,endY:u.bottom,rotate:d,width:s,height:l,absolute:u.absolute}},"calcPosition"),eY=(eK=class extends o.Disposable{constructor(e,t,r,n,i,a){super(),T(this,"_domLayerMap",/* @__PURE__ */new Map),T(this,"_domLayerInfoMap",/* @__PURE__ */new Map),T(this,"_transformChange$",new _.Subject),T(this,"transformChange$",this._transformChange$.asObservable()),T(this,"_remove$",new _.Subject),T(this,"remove$",this._remove$.asObservable()),T(this,"_hooks",[]),this._renderManagerService=e,this._univerInstanceService=t,this._commandService=r,this._drawingManagerService=n,this._canvasFloatDomService=i,this._sheetDrawingService=a,this._drawingAddListener(),this._scrollUpdateListener(),this._featureUpdateListener(),this._deleteListener()}_ensureMap(e,t){let r=this._domLayerMap.get(e);r||(r=/* @__PURE__ */new Map,this._domLayerMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}_getSceneAndTransformerByDrawingSearch(e){if(null==e)return;let t=this._renderManagerService.getRenderById(e),r=null==t?void 0:t.scene;if(null==t||null==r)return null;let n=r.getTransformerByCreate(),i=t.engine.getCanvasElement();return{scene:r,transformer:n,renderObject:t,canvas:i}}_getFloatDomProps(e){let t;return this._hooks.forEach(r=>{t=r.onGetFloatDomProps(e)}),t}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{e.forEach(e=>{var t,r,n;let{unitId:i,subUnitId:a,drawingId:s}=e,l=(0,S.getSheetCommandTarget)(this._univerInstanceService,{unitId:i,subUnitId:a}),h=this._drawingManagerService.getDrawingByParam(e);if(!h||!l)return;let p=null==(t=this._renderManagerService.getRenderById(i))?void 0:t.with(c.SheetSkeletonManagerService).getWorksheetSkeleton(a);if(!p)return;let{transform:g,drawingType:f,data:v}=h;if(f!==o.DrawingTypeEnum.DRAWING_DOM)return;let _=this._getSceneAndTransformerByDrawingSearch(i);if(null==_)return;let{scene:I,canvas:C}=_;if(null==g)return!0;let{left:y,top:b,width:w,height:R,angle:T,flipX:M,flipY:O,skewX:D,skewY:U}=g,P=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:i,subUnitId:a,drawingId:s}),k=I.getObject(P);if(null!=k){k.transformByState({left:y,top:b,width:w,height:R,angle:T,flipX:M,flipY:O,skewX:D,skewY:U});return}let N={left:y,top:b,width:w,height:R,zIndex:this._drawingManagerService.getDrawingOrder(i,a).length-1},A=new u.Rect(P,N);I.addObject(A,u.DRAWING_OBJECT_LAYER_INDEX),!1!==h.allowTransform&&I.attachTransformerTo(A);let x=this._ensureMap(i,a),L=new o.DisposableCollection,V=eG(A,_.renderObject,p.skeleton,l.worksheet),F=new m.BehaviorSubject(V);this._canvasFloatDomService.addFloatDom({position$:F,id:s,componentKey:h.componentKey,onPointerDown:/* @__PURE__ */E(e=>{C.dispatchEvent(new PointerEvent(e.type,e))},"onPointerDown"),onPointerMove:/* @__PURE__ */E(e=>{C.dispatchEvent(new PointerEvent(e.type,e))},"onPointerMove"),onPointerUp:/* @__PURE__ */E(e=>{C.dispatchEvent(new PointerEvent(e.type,e))},"onPointerUp"),onWheel:/* @__PURE__ */E(e=>{C.dispatchEvent(new WheelEvent(e.type,e))},"onWheel"),props:null!=(n=null==(r=x.get(s))?void 0:r.props)?n:this._getFloatDomProps(s),data:v,unitId:i});let j=A.onTransformChange$.subscribeEvent(()=>{let e=eG(A,_.renderObject,p.skeleton,l.worksheet);F.next(e)});L.add(()=>{this._canvasFloatDomService.removeFloatDom(s)}),j&&L.add(j),this._domLayerInfoMap.set(s,{dispose:L,rect:A,position$:F,unitId:i,subUnitId:a}),x.set(s,{...x.get(s)})})}))}_scrollUpdateListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var t,r;let n=/* @__PURE__ */E((e,t)=>{var r;let n=this._getSceneAndTransformerByDrawingSearch(e),i=Array.from(this._ensureMap(e,t).keys()),a=(0,S.getSheetCommandTarget)(this._univerInstanceService,{unitId:e,subUnitId:t}),o=null==(r=this._renderManagerService.getRenderById(e))?void 0:r.with(c.SheetSkeletonManagerService).getWorksheetSkeleton(t);n&&a&&o&&i.forEach(e=>{let t=this._domLayerInfoMap.get(e);if(t){let e=eG(t.rect,n.renderObject,o.skeleton,a.worksheet);t.position$.next(e)}})},"updateSheet");if(e.id===c.SetScrollOperation.id){let{unitId:t,sheetId:r}=e.params;n(t,r)}else if(e.id===c.SetZoomRatioOperation.id){let{unitId:i}=e.params;Array.from(null!=(r=null==(t=this._domLayerMap.get(i))?void 0:t.keys())?r:[]).forEach(e=>{n(i,e)})}else if(e.id===S.SetFrozenMutation.id){let{unitId:t,subUnitId:r}=e.params;n(t,r)}}))}_getPosition(e,t){var r;let{startX:n,endX:i,startY:a,endY:o}=e,s=null==(r=this._renderManagerService.getRenderById(t))?void 0:r.with(c.ISheetSelectionRenderService);if(null==s)return;let l=s.getSelectionCellByPosition(n,a);if(null==l)return;let d={column:l.actualColumn,columnOffset:n-l.startX,row:l.actualRow,rowOffset:a-l.startY},u=s.getSelectionCellByPosition(i,o);if(null!=u)return{from:d,to:{column:u.actualColumn,columnOffset:i-u.startX,row:u.actualRow,rowOffset:o-u.startY}}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(e=>{e.forEach(e=>{let t=this._drawingManagerService.getDrawingByParam(e);if(!t||t.drawingType!==o.DrawingTypeEnum.DRAWING_DOM)return;let r={...t.transform};this._transformChange$.next({id:e.drawingId,value:r})})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(e=>{this._removeDom(e.drawingId)})}))}addFloatDomToPosition(e,t){let r=(0,S.getSheetCommandTarget)(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!r)throw Error("cannot find current target!");let{unitId:n,subUnitId:i}=r,{initPosition:a,componentKey:s,data:l,allowTransform:d=!0}=e,u=null!=t?t:(0,o.generateRandomId)(),c=this._getPosition(a,n);if(null==c)return;this._ensureMap(n,i).set(u,e);let h={unitId:n,subUnitId:i,drawingId:u,drawingType:o.DrawingTypeEnum.DRAWING_DOM,componentKey:s,sheetTransform:c,transform:{left:a.startX,top:a.startY,width:a.endX-a.startX,height:a.endY-a.startY},data:l,allowTransform:d};return this._commandService.executeCommand(G.id,{unitId:n,drawings:[h]}),{id:u,dispose:/* @__PURE__ */E(()=>{this._removeDom(u,!0)},"dispose")}}_removeDom(e,t=!1){let r=this._domLayerInfoMap.get(e);if(!r)return;let{unitId:n,subUnitId:i}=r;this._domLayerInfoMap.delete(e),r.dispose.dispose();let a=this._getSceneAndTransformerByDrawingSearch(n);if(a&&a.scene.removeObject(r.rect),t){this._ensureMap(n,i).delete(e);let t=this._drawingManagerService.getDrawingByParam({unitId:n,subUnitId:i,drawingId:e});if(!t)return;let{redo:r,objects:a}=this._sheetDrawingService.getBatchRemoveOp([t]);this._commandService.syncExecuteCommand(l.SetDrawingApplyMutation.id,{unitId:n,subUnitId:i,op:r,objects:a,type:l.DrawingApplyType.REMOVE})}}addHook(e){return this._hooks.push(e),{dispose:/* @__PURE__ */E(()=>{let t=this._hooks.findIndex(t=>t===e);this._hooks.splice(t,1)},"dispose")}}},E(eK,"SheetCanvasFloatDomManagerService"),eK);eY=e$([(0,o.OnLifecycle)(o.LifecycleStages.Starting,eY),eB(0,(0,o.Inject)(u.IRenderManagerService)),eB(1,o.IUniverInstanceService),eB(2,(0,o.Inject)(o.ICommandService)),eB(3,d.IDrawingManagerService),eB(4,(0,o.Inject)(h.CanvasFloatDomService)),eB(5,l.ISheetDrawingService)],eY);var ez,eK,eq,eX=Object.defineProperty,eZ=Object.getOwnPropertyDescriptor,eQ=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eZ(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eX(t,r,a),a},"__decorateClass$4"),eJ=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let e0=(eq=class extends o.Disposable{constructor(e,t,r,n){super(),this._sheetPrintInterceptorService=e,this._drawingRenderService=t,this._drawingManagerService=r,this._renderManagerService=n,this._initPrinting()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:/* @__PURE__ */E((e,t,r)=>{let{unitId:n,scene:i,subUnitId:a}=t,o=this._drawingManagerService.getDrawingDataForUnit(n),s=null==o?void 0:o[a];return s&&s.order.forEach(e=>{this._drawingRenderService.renderDrawing(s.data[e],i)}),r()},"handler")})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:/* @__PURE__ */E((e,t,r)=>{let{unitId:n,subUnitId:i}=t,a=this._renderManagerService.getRenderById(n);if(!a)return r(e);let s=a.with(c.SheetSkeletonManagerService).getWorksheetSkeleton(i);if(!s)return r(e);let l=this._drawingManagerService.getDrawingDataForUnit(n),u=null==l?void 0:l[t.subUnitId];if(!u)return r(e);let{scaleX:h,scaleY:m}=a.scene,p=e?{...e}:{startColumn:0,endColumn:0,endRow:0,startRow:0},g=u.order.map(e=>u.data[e]).filter(e=>e.drawingType!==d.DrawingTypeEnum.DRAWING_DOM);return g.length?(g.forEach(e=>{if(!e.groupId&&e.transform&&(0,o.Tools).isDefine(e.transform.left)&&(0,o.Tools).isDefine(e.transform.top)&&(0,o.Tools).isDefine(e.transform.width)&&(0,o.Tools).isDefine(e.transform.height)){let t=s.skeleton.getCellPositionByOffset(e.transform.left,e.transform.top,h,m,{x:0,y:0}),r=s.skeleton.getCellPositionByOffset(e.transform.left+e.transform.width,e.transform.top+e.transform.height,h,m,{x:0,y:0});t.column<p.startColumn&&(p.startColumn=t.column),t.row<p.startRow&&(p.startRow=t.row),p.endRow<r.row&&(p.endRow=r.row),p.endColumn<r.column&&(p.endColumn=r.column)}}),r(p)):r(e)},"handler")}))}},E(eq,"SheetDrawingPrintingController"),eq);e0=eQ([(0,o.OnLifecycle)(o.LifecycleStages.Rendered,e0),eJ(0,(0,o.Inject)(c.SheetPrintInterceptorService)),eJ(1,(0,o.Inject)(s.DrawingRenderService)),eJ(2,d.IDrawingManagerService),eJ(3,u.IRenderManagerService)],e0);var e1,e3=Object.defineProperty,e2=Object.getOwnPropertyDescriptor,e4=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e2(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e3(t,r,a),a},"__decorateClass$3"),e9=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let e5=(e1=class extends o.Disposable{constructor(e,t,r,n,i){super(),this._drawingManagerService=e,this._renderManagerService=t,this._permissionService=r,this._univerInstanceService=n,this._userManagerService=i,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(o.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,p.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{if(!e){this._drawingManagerService.setDrawingVisible(!1);return}e.activeSheet$.subscribe(t=>{if(!t){this._drawingManagerService.setDrawingVisible(!1);return}let r=e.getUnitId(),n=t.getSheetId();if(this._permissionService.composePermission([new S.WorkbookViewPermission(r).id,new S.WorksheetViewPermission(r,n).id]).every(e=>e.value))this._drawingManagerService.setDrawingVisible(!0);else{this._drawingManagerService.setDrawingVisible(!1);let r=e.getUnitId(),n=t.getSheetId(),i=Object.values(this._drawingManagerService.getDrawingData(r,n)),a=this._renderManagerService.getRenderById(r),o=null==a?void 0:a.scene;if(null==o)return;o.getAllObjectsByOrder().forEach(e=>{e.classType===u.RENDER_CLASS_TYPE.IMAGE&&i.some(t=>e.oKey.includes(t.drawingId))&&o.removeObject(e)})}})}))}_initDrawingEditable(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(o.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,p.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{if(!e){this._drawingManagerService.setDrawingEditable(!1);return}e.activeSheet$.subscribe(t=>{if(!t){this._drawingManagerService.setDrawingEditable(!1);return}let r=e.getUnitId(),n=t.getSheetId();if(this._permissionService.composePermission([new S.WorkbookEditablePermission(r).id,new S.WorksheetEditPermission(r,n).id]).every(e=>e.value))this._drawingManagerService.setDrawingEditable(!0);else{this._drawingManagerService.setDrawingEditable(!1);let r=e.getUnitId(),n=t.getSheetId(),i=Object.values(this._drawingManagerService.getDrawingData(r,n)),a=this._renderManagerService.getRenderById(r),o=null==a?void 0:a.scene;if(null==o)return;o.getAllObjectsByOrder().forEach(e=>{e.classType===u.RENDER_CLASS_TYPE.IMAGE&&i.some(t=>e.oKey.includes(t.drawingId))&&o.detachTransformerFrom(e)})}})}))}_initViewPermissionChange(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(o.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,p.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{e&&e.activeSheet$.subscribe(t=>{var r;if(!t)return;let n=e.getUnitId(),i=t.getSheetId(),a=!0,o=this._renderManagerService.getRenderById(n),s=null==o?void 0:o.scene;if(null==s)return;let l=s.getTransformerByCreate(),d=this._permissionService.composePermission$([new S.WorkbookViewPermission(n).id,new S.WorksheetViewPermission(n,i).id]).pipe((0,v.map)(e=>e.every(e=>e.value)));null==d||d.pipe((0,f.filter)(e=>e!==a),(0,g.distinctUntilChanged)()).subscribe({next:/* @__PURE__ */E(e=>{a=e,this._drawingManagerService.setDrawingVisible(e);let t=s.getAllObjectsByOrder(),r=Object.values(this._drawingManagerService.getDrawingData(n,i));e?this._drawingManagerService.addNotification(r):(t.forEach(e=>{e.classType===u.RENDER_CLASS_TYPE.IMAGE&&r.some(t=>e.oKey.includes(t.drawingId))&&s.removeObject(e)}),l.clearSelectedObjects())},"next")}),null==(r=this._permissionService.getPermissionPoint$(new S.WorksheetViewPermission(n,i).id))||r.pipe((0,f.filter)(e=>e.value!==a),(0,g.distinctUntilChanged)()).subscribe({complete:/* @__PURE__ */E(()=>{a=!0,this._drawingManagerService.setDrawingVisible(!0);let e=Object.values(this._drawingManagerService.getDrawingData(n,i));this._drawingManagerService.addNotification(e)},"complete")})})}))}_initEditPermissionChange(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(o.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,p.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{e&&e.activeSheet$.subscribe(t=>{var r;if(!t)return;let n=e.getUnitId(),i=t.getSheetId(),a=!0,o=this._renderManagerService.getRenderById(n),s=null==o?void 0:o.scene;if(null==s)return;let l=s.getTransformerByCreate(),d=this._permissionService.composePermission$([new S.WorkbookEditablePermission(n).id,new S.WorksheetEditPermission(n,i).id]).pipe((0,v.map)(e=>e.every(e=>e.value)));null==d||d.pipe((0,f.filter)(e=>e!==a),(0,g.distinctUntilChanged)()).subscribe({next:/* @__PURE__ */E(e=>{a=e,this._drawingManagerService.setDrawingEditable(e);let t=s.getAllObjectsByOrder(),r=Object.values(this._drawingManagerService.getDrawingData(n,i));e?(t.forEach(e=>{e.classType===u.RENDER_CLASS_TYPE.IMAGE&&r.some(t=>e.oKey.includes(t.drawingId))&&s.attachTransformerTo(e)}),this._drawingManagerService.addNotification(r)):(t.forEach(e=>{e.classType===u.RENDER_CLASS_TYPE.IMAGE&&r.some(t=>e.oKey.includes(t.drawingId))&&s.detachTransformerFrom(e)}),l.clearSelectedObjects())},"next")}),null==(r=this._permissionService.getPermissionPoint$(new S.WorksheetEditPermission(n,i).id))||r.pipe((0,f.filter)(e=>e.value!==a),(0,g.distinctUntilChanged)()).subscribe({complete:/* @__PURE__ */E(()=>{a=!0;let r=e.getUnitId(),n=t.getSheetId(),i=Object.values(this._drawingManagerService.getDrawingData(r,n)),o=this._renderManagerService.getRenderById(r),s=null==o?void 0:o.scene;null!=s&&(this._drawingManagerService.setDrawingEditable(!0),s.getAllObjectsByOrder().forEach(e=>{e.classType===u.RENDER_CLASS_TYPE.IMAGE&&i.some(t=>e.oKey.includes(t.drawingId))&&s.detachTransformerFrom(e)}))},"complete")})})}))}},E(e1,"SheetDrawingPermissionController"),e1);e5=e4([(0,o.OnLifecycle)(o.LifecycleStages.Rendered,e5),e9(0,d.IDrawingManagerService),e9(1,u.IRenderManagerService),e9(2,o.IPermissionService),e9(3,o.IUniverInstanceService),e9(4,(0,o.Inject)(o.UserManagerService))],e5);var e6,e8=Object.defineProperty,e7=Object.getOwnPropertyDescriptor,te=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e7(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e8(t,r,a),a},"__decorateClass$2"),tt=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let tr=(e6=class extends o.Disposable{constructor(e,t,r){super(),T(this,"_copyInfo"),this._sheetClipboardService=e,this._renderManagerService=t,this._sheetDrawingService=r,this._initCopyPaste()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:/* @__PURE__ */E((e,t,r)=>this._collect(e,t,r),"onBeforeCopy"),onPasteCells:/* @__PURE__ */E((e,t,r,n)=>{let{copyType:i=c.COPY_TYPE.COPY,pasteType:a}=n,{range:o}=e||{},{range:s,unitId:l,subUnitId:d}=t;return this._generateMutations(s,{copyType:i,pasteType:a,copyRange:o,unitId:l,subUnitId:d})},"onPasteCells"),onPastePlainText:/* @__PURE__ */E((e,t)=>({undos:[],redos:[]}),"onPastePlainText")})}_collect(e,t,r){var n;let i=null==(n=this._renderManagerService.getRenderById(e))?void 0:n.with(c.SheetSkeletonManagerService);if(!i)return;let a=i.attachRangeWithCoord(r);if(!a)return;let{startX:o,endX:s,startY:d,endY:u}=a,h=this._sheetDrawingService.getDrawingData(e,t),m=[];Object.keys(h).forEach(e=>{let t=h[e],{transform:r}=t;if(t.anchorType!==l.SheetDrawingAnchorType.Both||!r)return;let{left:n=0,top:i=0,width:a=0,height:c=0}=r,{drawingStartX:p,drawingEndX:g,drawingStartY:f,drawingEndY:v}={drawingStartX:n,drawingEndX:n+a,drawingStartY:i,drawingEndY:i+c};o<=p&&g<=s&&d<=f&&v<=u&&m.push(t)}),m.length&&(this._copyInfo={drawings:m,unitId:e,subUnitId:t})}_generateMutations(e,t){var r;if(!this._copyInfo||[(0,c.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_COL_WIDTH,(0,c.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_VALUE,(0,c.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMAT,(0,c.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMULA].includes(t.pasteType))return{redos:[],undos:[]};let{copyRange:n}=t;if(!n)return{redos:[],undos:[]};let{drawings:i,unitId:a,subUnitId:s}=this._copyInfo,{ranges:[d,u],mapFunc:h}=(0,c.virtualizeDiscreteRanges)([n,e]),{row:m,col:p}=h(d.startRow,d.startColumn),{row:g,col:f}=h(u.startRow,u.startColumn),v=null==(r=this._renderManagerService.getRenderById(a))?void 0:r.with(c.SheetSkeletonManagerService);if(!v)return{redos:[],undos:[]};let _=v.attachRangeWithCoord({startRow:m,endRow:m,startColumn:p,endColumn:p}),I=v.attachRangeWithCoord({startRow:g,endRow:g,startColumn:f,endColumn:f});if(!_||!I)return{redos:[],undos:[]};let S=[],C=[],y=I.startX-_.startX,b=I.startY-_.startY,w=g-m,R=f-p,E=t.copyType===c.COPY_TYPE.CUT,{_sheetDrawingService:T}=this;return i.forEach(e=>{let{transform:t,sheetTransform:r}=e;if(!t)return;let n={...e,unitId:a,subUnitId:s,drawingId:E?e.drawingId:(0,o.Tools).generateRandomId(),transform:{...t,left:t.left+y,top:t.top+b},sheetTransform:{to:{...r.to,row:r.to.row+w,column:r.to.column+R},from:{...r.from,row:r.from.row+w,column:r.from.column+R}}};if(E){let{undo:e,redo:t,objects:r}=T.getBatchUpdateOp([n]);S.push({id:l.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:s,type:l.DrawingApplyType.UPDATE,op:t,objects:r}}),C.push({id:l.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:s,type:l.DrawingApplyType.UPDATE,op:e,objects:r}})}else{let{undo:e,redo:t,objects:r}=T.getBatchAddOp([n]);S.push({id:l.SetDrawingApplyMutation.id,params:{op:t,unitId:a,subUnitId:s,objects:r,type:l.DrawingApplyType.INSERT}}),C.push({id:l.SetDrawingApplyMutation.id,params:{op:e,unitId:a,subUnitId:s,objects:r,type:l.DrawingApplyType.REMOVE}})}}),{redos:S,undos:C}}},E(e6,"SheetsDrawingCopyPasteController"),e6);tr=te([(0,o.OnLifecycle)(o.LifecycleStages.Ready,tr),tt(0,c.ISheetClipboardService),tt(1,u.IRenderManagerService),tt(2,l.ISheetDrawingService)],tr);var tn,ti=Object.defineProperty,ta=Object.getOwnPropertyDescriptor,to=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ta(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ti(t,r,a),a},"__decorateClass$1"),ts=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let tl=(E(tn=class extends o.Disposable{constructor(e,t,r,n,i,a){super(),this._context=e,this._sheetDrawingService=t,this._drawingManagerService=r,this._lifecycleService=n,this._sheetSelectionRenderService=i,this._sheetSkeletonManagerService=a,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){if(this._context.type===o.UniverInstanceType.UNIVER_SHEET){this._sheetDrawingService.initializeNotification(this._context.unitId);let e=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(let t in e){let r=e[t];for(let e in r.data){let t=r.data[e];t.transform=j(t.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService)}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}}},"SheetsDrawingRenderController"),tn);tl=to([ts(1,l.ISheetDrawingService),ts(2,d.IDrawingManagerService),ts(3,(0,o.Inject)(o.LifecycleService)),ts(4,(0,o.Inject)(c.ISheetSelectionRenderService)),ts(5,(0,o.Inject)(c.SheetSkeletonManagerService))],tl);let td={};var tu=Object.defineProperty,tc=Object.getOwnPropertyDescriptor,th=/* @__PURE__ */E((e,t,r)=>t in e?tu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),tm=/* @__PURE__ */E((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tc(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tu(t,r,a),a},"__decorateClass"),tp=/* @__PURE__ */E((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),tg=/* @__PURE__ */E((e,t,r)=>th(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let tf=(E(a=class extends o.Plugin{constructor(e=td,t,r,n){super(),this._config=e,this._injector=t,this._renderManagerService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig("sheets-drawing-ui.config",a)}onStarting(){this._initDependencies()}onRendered(){this._registerRenderModules()}_initDependencies(){[[eY],[eP],[F],[e0],[e5],[tr]].forEach(e=>this._injector.add(e))}_registerRenderModules(){[[ee],[eF],[tl]].forEach(e=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(o.UniverInstanceType.UNIVER_SHEET,e))})}},"UniverSheetsDrawingUIPlugin"),a);tg(tf,"type",o.UniverInstanceType.UNIVER_SHEET),tg(tf,"pluginName","SHEET_IMAGE_UI_PLUGIN"),tm([(0,o.DependentOn)(d.UniverDrawingPlugin,s.UniverDrawingUIPlugin,l.UniverSheetsDrawingPlugin),tp(1,(0,o.Inject)(o.Injector)),tp(2,u.IRenderManagerService),tp(3,o.IConfigService)],tf)}),i("jyvj4",function(r,i){let a,o;e(r.exports,"DrawingRenderService",function(){return O}),e(r.exports,"OpenImageCropOperation",function(){return ed}),e(r.exports,"DrawingCommonPanel",function(){return eg}),e(r.exports,"COMPONENT_IMAGE_POPUP_MENU",function(){return e_}),e(r.exports,"ImageResetSizeOperation",function(){return eT}),e(r.exports,"ImageCropperObject",function(){return eA}),e(r.exports,"UniverDrawingUIPlugin",function(){return eQ});var s,l,d=n("e3ZB7"),u=n("D79YY"),c=n("83KcA"),h=n("gQuIR"),m=n("bLx5G"),p=n("1dwVM"),g=n("cahIb"),f=n("a9FIH"),v=n("bTGUS"),_=Object.defineProperty,I=(e,t,r)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,S=(e,t)=>_(e,"name",{value:t,configurable:!0}),C=(e,t,r)=>I(e,"symbol"!=typeof t?t+"":t,r);function y(e,t,r,n){let i=n.getDrawingByParam(e);if(null==i)return;let a=(0,d.getDrawingShapeKeyByDrawingSearch)(e),o=r.getObject(a);if(o&&!(o instanceof u.Group))return;if(null!=o){o.addObject(t);return}let s=new u.Group(a);r.addObject(s,u.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(s),s.addObject(t);let{transform:l}=i;l&&s.transformByState({left:l.left,top:l.top,angle:l.angle})}function b(e,t){var r;let n;let i=t?e.getUnit(t):e.getFocusedUnit();if(null==i)return;let a=i.getUnitId();return i.type===c.UniverInstanceType.UNIVER_SHEET?n=null==(r=i.getActiveSheet())?void 0:r.getSheetId():(i.type===c.UniverInstanceType.UNIVER_DOC||i.type===c.UniverInstanceType.UNIVER_SLIDE)&&(n=a),{unitId:a,subUnitId:n,current:i}}S(y,"insertGroupObject"),S(b,"getCurrentUnitInfo");var w,R=Object.defineProperty,E=Object.getOwnPropertyDescriptor,T=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?E(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&R(t,r,a),a},"__decorateClass$5"),M=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let O=(S(w=class{constructor(e,t){this._drawingManagerService=e,this._imageIoService=t}async renderImages(e,t){let{transform:r,drawingType:n,source:i,imageSourceType:a,srcRect:o,prstGeom:s,groupId:l,unitId:c,subUnitId:h,drawingId:m,isMultiTransform:p,transforms:g}=e;if(n!==d.DrawingTypeEnum.DRAWING_IMAGE||!this._drawingManagerService.getDrawingVisible()||null==r)return;let f=p&&g?g:[r],v=[];for(let e of f){let{left:r,top:n,width:g,height:_,angle:I,flipX:S,flipY:C,skewX:b,skewY:w}=e,R=f.indexOf(e),E=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:c,subUnitId:h,drawingId:m},p?R:void 0),T=t.getObject(E);if(null!=T){T.transformByState({left:r,top:n,width:g,height:_,angle:I,flipX:S,flipY:C,skewX:b,skewY:w});continue}let M=this._drawingManagerService.getDrawingOrder(c,h),O=M.indexOf(m),D={...e,zIndex:-1===O?M.length-1:O},U=this._imageIoService.getImageSourceCache(i,a),P=!1;if(null!=U)D.image=U;else{if(a===d.ImageSourceType.UUID)try{D.url=await this._imageIoService.getImage(i)}catch(e){console.error(e);continue}else D.url=i;P=!0}if(t.getObject(E))continue;D.printable=!0;let k=new u.Image(E,D);if(P&&this._imageIoService.addImageSourceCache(i,a,k.getNative()),!this._drawingManagerService.getDrawingVisible())continue;let N=t.addObject(k,u.DRAWING_OBJECT_LAYER_INDEX);this._drawingManagerService.getDrawingEditable()&&N.attachTransformerTo(k),l&&y({drawingId:l,unitId:c,subUnitId:h},k,t,this._drawingManagerService),null!=s&&k.setPrstGeom(s),null!=o&&k.setSrcRect(o),v.push(k)}return v}renderDrawing(e,t){let r=this._drawingManagerService.getDrawingByParam(e);if(null!=r&&r.drawingType===d.DrawingTypeEnum.DRAWING_IMAGE)return this.renderImages(r,t)}},"DrawingRenderService"),w);function D(e,t){let r=[];return e.forEach(e=>{let{oKey:n,left:i,top:a,height:o,width:s,angle:l}=e,u=t.getDrawingOKey(n);if(null==u)return r.push(null),!0;let{unitId:c,subUnitId:h,drawingId:m,drawingType:p}=u,g={unitId:c,subUnitId:h,drawingId:m,drawingType:p,transform:{left:i,top:a,height:o,width:s,angle:l}};p===d.DrawingTypeEnum.DRAWING_IMAGE&&(g.srcRect=e.srcRect),r.push(g)}),r}O=T([M(0,d.IDrawingManagerService),M(1,d.IImageIoService)],O),S(D,"getUpdateParams");var U=function(){return(U=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},P=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},k=(0,h.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=P(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,h.useRef)("_".concat(L()));return N(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},U({ref:t,className:s},o),a)});function N(e,t,r,n,i){return(0,h.createElement)(e.tag,U(U({key:t},A(e,r,i)),n),(x(e,r).children||[]).map(function(n,a){return N(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function A(e,t,r){var n=U({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function x(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?U(U({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?U(U({},e),{attrs:U(U({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function L(){return Math.random().toString(36).substring(2,8)}S(N,"render"),S(A,"replaceRuntimeIdsAndExtInAttrs"),S(x,"replaceRuntimeIdsInDefs"),S(L,"generateShortUuid"),k.displayName="UniverIcon";var V={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"colorChannel1",d:"M11.0363 12.2367V14.0367C11.0363 14.3681 11.3049 14.6367 11.6363 14.6367C11.9676 14.6367 12.2363 14.3681 12.2363 14.0367V12.2367H14.0364C14.3677 12.2367 14.6364 11.9681 14.6364 11.6367C14.6364 11.3054 14.3677 11.0367 14.0364 11.0367H12.2363V9.23672C12.2363 8.90535 11.9676 8.63672 11.6363 8.63672C11.3049 8.63672 11.0363 8.90535 11.0363 9.23672V11.0367H9.23635C8.90498 11.0367 8.63635 11.3054 8.63635 11.6367C8.63635 11.9681 8.90498 12.2367 9.23635 12.2367H11.0363Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 1.36377C1.90091 1.36377 1.36365 1.90103 1.36365 2.56377V6.16377C1.36365 6.82651 1.90091 7.36377 2.56365 7.36377H6.16365C6.82639 7.36377 7.36365 6.82651 7.36365 6.16377V2.56377C7.36365 1.90103 6.82639 1.36377 6.16365 1.36377H2.56365zM6.16365 2.56377H2.56365L2.56365 6.16377H6.16365V2.56377zM2.56365 8.63647C1.90091 8.63647 1.36365 9.17373 1.36365 9.83647V13.4365C1.36365 14.0992 1.90091 14.6365 2.56365 14.6365H6.16365C6.82639 14.6365 7.36365 14.0992 7.36365 13.4365V9.83647C7.36365 9.17373 6.82639 8.63647 6.16365 8.63647H2.56365zM6.16365 9.83647H2.56365L2.56365 13.4365H6.16365V9.83647zM9.83635 7.36377C9.17361 7.36377 8.63635 6.82651 8.63635 6.16377V2.56377C8.63635 1.90103 9.17361 1.36377 9.83635 1.36377H13.4364C14.0991 1.36377 14.6364 1.90103 14.6364 2.56377V6.16377C14.6364 6.82651 14.0991 7.36377 13.4364 7.36377H9.83635zM9.83635 6.16377V2.56377L13.4364 2.56377V6.16377H9.83635z",fillRule:"evenodd",clipRule:"evenodd"}}]},F=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"autofill",ref:t,icon:V}))});F.displayName="Autofill";var j={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.0045 4.4334C14.8881 4.4334 15.6045 3.71705 15.6045 2.8334 15.6045 1.94974 14.8881 1.2334 14.0045 1.2334H3.70449C2.82084 1.2334 2.10449 1.94974 2.10449 2.8334 2.10449 3.71705 2.82084 4.4334 3.70449 4.4334H14.0045zM14.4045 2.8334C14.4045 3.05431 14.2254 3.2334 14.0045 3.2334H3.70449C3.48358 3.2334 3.30449 3.05431 3.30449 2.8334 3.30449 2.61248 3.48358 2.4334 3.70449 2.4334H14.0045C14.2254 2.4334 14.4045 2.61249 14.4045 2.8334zM14.1544 8.5999C15.038 8.5999 15.7544 7.88356 15.7544 6.9999 15.7544 6.11625 15.038 5.3999 14.1544 5.3999H3.85439C2.97074 5.3999 2.25439 6.11625 2.25439 6.9999 2.25439 7.88356 2.97074 8.5999 3.85439 8.5999H14.1544zM14.5544 6.9999C14.5544 7.22082 14.3753 7.3999 14.1544 7.3999H3.85439C3.63348 7.3999 3.45439 7.22082 3.45439 6.9999 3.45439 6.77899 3.63348 6.5999 3.85439 6.5999H14.1544C14.3753 6.5999 14.5544 6.77899 14.5544 6.9999z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902L6.58023 12.5907C6.34591 12.3564 6.34591 11.9765 6.58023 11.7421 6.81454 11.5078 7.19444 11.5078 7.42876 11.7421L8.40449 12.7179V10.1664C8.40449 9.83504 8.67312 9.56641 9.00449 9.56641 9.33586 9.56641 9.60449 9.83504 9.60449 10.1664V12.7179L10.5802 11.7421C10.8145 11.5078 11.1944 11.5078 11.4288 11.7421 11.6631 11.9765 11.6631 12.3564 11.4288 12.5907L9.42923 14.5902M8.57975 14.5902C8.58121 14.5917 8.58268 14.5931 8.58416 14.5946 8.64077 14.6502 8.70566 14.6923 8.77482 14.7209 8.84557 14.7502 8.92314 14.7664 9.00449 14.7664 9.08585 14.7664 9.16342 14.7502 9.23416 14.7209 9.30332 14.6923 9.36821 14.6502 9.42482 14.5946"}}]},H=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"bottom-single",ref:t,icon:j}))});H.displayName="BottomSingle";var $={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.97705 7.51296C5.97705 7.18159 6.24568 6.91296 6.57705 6.91296H8.48632C8.81769 6.91296 9.08632 7.18159 9.08632 7.51296 9.08632 7.84433 8.81769 8.11296 8.48632 8.11296H6.57705C6.24568 8.11296 5.97705 7.84433 5.97705 7.51296zM6.57705 9.41028C6.24568 9.41028 5.97705 9.67891 5.97705 10.0103 5.97705 10.3416 6.24568 10.6103 6.57705 10.6103H10.8199C11.1512 10.6103 11.4199 10.3416 11.4199 10.0103 11.4199 9.67891 11.1512 9.41028 10.8199 9.41028H6.57705z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.51074 2.37063C3.51074 1.48697 4.22709 0.77063 5.11074 0.77063H9.80318L9.81294 0.770708C9.97168 0.768161 10.1311 0.82824 10.2511 0.95055L14.4317 5.21408C14.5165 5.30049 14.5697 5.406 14.5917 5.51645C14.6041 5.5644 14.6106 5.61467 14.6106 5.66648V11.6406C14.6106 12.5243 13.8943 13.2406 13.0106 13.2406H5.11074C4.22709 13.2406 3.51074 12.5243 3.51074 11.6406V2.37063ZM10.4032 4.66648V2.81964L12.6063 5.06648H10.8032C10.5823 5.06648 10.4032 4.88739 10.4032 4.66648ZM5.11074 1.97063C4.88983 1.97063 4.71074 2.14972 4.71074 2.37063V11.6406C4.71074 11.8615 4.88983 12.0406 5.11074 12.0406H13.0106C13.2316 12.0406 13.4106 11.8615 13.4106 11.6406V6.26648H10.8032C9.91953 6.26648 9.20318 5.55013 9.20318 4.66648V1.97063H5.11074Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.58916 6.6741C2.58916 6.34273 2.32053 6.0741 1.98916 6.0741C1.65779 6.0741 1.38916 6.34273 1.38916 6.6741V12.6294C1.38916 14.0653 2.55322 15.2294 3.98916 15.2294H9.41408C9.74545 15.2294 10.0141 14.9607 10.0141 14.6294C10.0141 14.298 9.74545 14.0294 9.41408 14.0294H3.98916C3.21596 14.0294 2.58916 13.4026 2.58916 12.6294V6.6741Z"}}]},B=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"create-copy-single",ref:t,icon:$}))});B.displayName="CreateCopySingle";var W={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.38125 1.16211C6.49759 1.16211 5.78125 1.87845 5.78125 2.76211V5.6377H2.87783C1.99418 5.6377 1.27783 6.35404 1.27783 7.2377V13.2377C1.27783 14.1214 1.99418 14.8377 2.87783 14.8377H8.87783C9.76149 14.8377 10.4778 14.1214 10.4778 13.2377V10.3621H13.3813C14.2649 10.3621 14.9813 9.64577 14.9813 8.76211V2.76211C14.9813 1.87845 14.2649 1.16211 13.3813 1.16211H7.38125ZM10.4778 9.16211H13.3813C13.6022 9.16211 13.7812 8.98302 13.7812 8.76211V2.76211C13.7812 2.5412 13.6022 2.36211 13.3813 2.36211H7.38125C7.16034 2.36211 6.98125 2.5412 6.98125 2.76211V5.6377H8.87783C9.76149 5.6377 10.4778 6.35404 10.4778 7.2377V9.16211ZM6.98125 6.8377H8.87783C9.09875 6.8377 9.27783 7.01678 9.27783 7.2377V9.16211H7.38125C7.16034 9.16211 6.98125 8.98302 6.98125 8.76211V6.8377ZM5.78125 6.8377V8.76211C5.78125 9.64577 6.49759 10.3621 7.38125 10.3621H9.27783V13.2377C9.27783 13.4586 9.09875 13.6377 8.87783 13.6377H2.87783C2.65692 13.6377 2.47783 13.4586 2.47783 13.2377V7.2377C2.47783 7.01678 2.65692 6.8377 2.87783 6.8377H5.78125Z",fillRule:"evenodd",clipRule:"evenodd"}}]},G=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"group-single",ref:t,icon:W}))});G.displayName="GroupSingle";var Y={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},z=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"more-down-single",ref:t,icon:Y}))});z.displayName="MoreDownSingle";var K={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 2.96401C1.25 3.84767 1.96634 4.56401 2.85 4.56401H13.15C14.0337 4.56401 14.75 3.84767 14.75 2.96401C14.75 2.08036 14.0337 1.36401 13.15 1.36401H2.85C1.96635 1.36401 1.25 2.08036 1.25 2.96401ZM2.85 3.36401C2.62909 3.36401 2.45 3.18493 2.45 2.96401C2.45 2.7431 2.62909 2.56401 2.85 2.56401H13.15C13.3709 2.56401 13.55 2.7431 13.55 2.96401C13.55 3.18493 13.3709 3.36401 13.15 3.36401H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 11.6118C5.80995 11.3774 6.18985 11.3774 6.42417 11.6118L7.3999 12.5875V6.36951C7.3999 6.03814 7.66853 5.76951 7.9999 5.76951C8.33127 5.76951 8.5999 6.03814 8.5999 6.36951V12.5875L9.57564 11.6118C9.80995 11.3774 10.1899 11.3774 10.4242 11.6118C10.6585 11.8461 10.6585 12.226 10.4242 12.4603L8.4324 14.452C8.32324 14.5655 8.16982 14.6362 7.9999 14.6362C7.82998 14.6362 7.67655 14.5655 7.56739 14.452L5.57564 12.4603C5.34132 12.226 5.34132 11.8461 5.57564 11.6118Z"}}]},q=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"move-down-single",ref:t,icon:K}))});q.displayName="MoveDownSingle";var X={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 13.036C1.25 12.1523 1.96634 11.436 2.85 11.436H13.15C14.0337 11.436 14.75 12.1523 14.75 13.036C14.75 13.9196 14.0337 14.636 13.15 14.636H2.85C1.96635 14.636 1.25 13.9196 1.25 13.036ZM2.85 12.636C2.62909 12.636 2.45 12.8151 2.45 13.036C2.45 13.2569 2.62909 13.436 2.85 13.436H13.15C13.3709 13.436 13.55 13.2569 13.55 13.036C13.55 12.8151 13.3709 12.636 13.15 12.636H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 4.38825C5.80995 4.62256 6.18985 4.62256 6.42417 4.38825L7.3999 3.41251V9.63049C7.3999 9.96186 7.66853 10.2305 7.9999 10.2305C8.33127 10.2305 8.5999 9.96186 8.5999 9.63049V3.41251L9.57564 4.38825C9.80995 4.62256 10.1899 4.62256 10.4242 4.38825C10.6585 4.15393 10.6585 3.77403 10.4242 3.53972L8.4324 1.54796C8.32324 1.43445 8.16982 1.36382 7.9999 1.36382C7.82998 1.36382 7.67655 1.43446 7.56739 1.54797L5.57564 3.53972C5.34132 3.77403 5.34132 4.15393 5.57564 4.38825Z"}}]},Z=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"move-up-single",ref:t,icon:X}))});Z.displayName="MoveUpSingle";var Q={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.82994 1.40913C7.88746 1.35161 7.95376 1.30821 8.02453 1.27893C8.09527 1.24959 8.17285 1.2334 8.2542 1.2334C8.33555 1.2334 8.41313 1.24959 8.48387 1.27893C8.55464 1.30821 8.62094 1.35161 8.67846 1.40913L10.6785 3.40913C10.9128 3.64345 10.9128 4.02335 10.6785 4.25766C10.4441 4.49198 10.0642 4.49198 9.82994 4.25766L8.8542 3.28193V5.8334C8.8542 6.16477 8.58557 6.4334 8.2542 6.4334C7.92283 6.4334 7.6542 6.16477 7.6542 5.8334V3.28193L6.67846 4.25766C6.44415 4.49198 6.06425 4.49198 5.82994 4.25766C5.59562 4.02335 5.59562 3.64345 5.82994 3.40913L7.82994 1.40913Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.50439 9C1.50439 8.11634 2.22074 7.4 3.10439 7.4H13.4044C14.288 7.4 15.0044 8.11634 15.0044 9 15.0044 9.88366 14.2881 10.6 13.4044 10.6H3.1044C2.22074 10.6 1.50439 9.88366 1.50439 9zM3.10439 8.6C2.88348 8.6 2.70439 8.77909 2.70439 9 2.70439 9.22091 2.88348 9.4 3.1044 9.4H13.4044C13.6253 9.4 13.8044 9.22091 13.8044 9 13.8044 8.77909 13.6253 8.6 13.4044 8.6H3.10439zM1.6543 13.1665C1.6543 12.2828 2.37064 11.5665 3.2543 11.5665H13.5543C14.438 11.5665 15.1543 12.2828 15.1543 13.1665 15.1543 14.0502 14.438 14.7665 13.5543 14.7665H3.2543C2.37064 14.7665 1.6543 14.0502 1.6543 13.1665zM3.2543 12.7665C3.03338 12.7665 2.8543 12.9456 2.8543 13.1665 2.8543 13.3874 3.03338 13.5665 3.2543 13.5665H13.5543C13.7752 13.5665 13.9543 13.3874 13.9543 13.1665 13.9543 12.9456 13.7752 12.7665 13.5543 12.7665H3.2543z",fillRule:"evenodd",clipRule:"evenodd"}}]},J=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"topmost-single",ref:t,icon:Q}))});J.displayName="TopmostSingle";var ee={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.46855 2.83731C7.46855 2.61639 7.64764 2.4373 7.86855 2.4373H13.8603C14.0812 2.4373 14.2603 2.61639 14.2603 2.8373V9.5049C14.2603 9.72581 14.0812 9.90489 13.8603 9.90489H12.866C12.5346 9.90489 12.266 10.1735 12.266 10.5049C12.266 10.8363 12.5346 11.1049 12.866 11.1049H13.8603C14.7439 11.1049 15.4603 10.3886 15.4603 9.5049V2.8373C15.4603 1.95365 14.7439 1.2373 13.8603 1.2373H7.86855C6.9849 1.2373 6.26855 1.95365 6.26855 2.83731V3.48688C6.26855 3.81825 6.53718 4.08688 6.86855 4.08688C7.19993 4.08688 7.46855 3.81825 7.46855 3.48688V2.83731Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.19888 5.56299C2.31522 5.56299 1.59888 6.27933 1.59888 7.16299V13.163C1.59888 14.0466 2.31522 14.763 3.19888 14.763H9.19888C10.0825 14.763 10.7989 14.0466 10.7989 13.163V7.16299C10.7989 6.27933 10.0825 5.56299 9.19888 5.56299H3.19888ZM2.79888 7.16299C2.79888 6.94207 2.97796 6.76299 3.19888 6.76299H9.19888C9.41979 6.76299 9.59888 6.94207 9.59888 7.16299V13.163C9.59888 13.3839 9.41979 13.563 9.19888 13.563H3.19888C2.97796 13.563 2.79888 13.3839 2.79888 13.163V7.16299Z",fillRule:"evenodd",clipRule:"evenodd"}}]},et=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(k,Object.assign({},e,{id:"ungroup-single",ref:t,icon:ee}))});et.displayName="UngroupSingle";let er={imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelRowVertical:"univer-image-common-panel-row-vertical",imageCommonPanelColumn:"univer-image-common-panel-column",imageCommonPanelColumnCenter:"univer-image-common-panel-column-center",imageCommonPanelInline:"univer-image-common-panel-inline",imageCommonPanelSpan2:"univer-image-common-panel-span2",imageCommonPanelSpan3:"univer-image-common-panel-span3",imageCommonPanelInput:"univer-image-common-panel-input"},en=/* @__PURE__ */S(e=>{let{arrangeShow:r,drawings:n}=e,i=(0,c.useDependency)(c.LocaleService),a=(0,c.useDependency)(d.IDrawingManagerService),o=/* @__PURE__ */S(e=>e?"block":"none","gridDisplay"),[s,l]=(0,h.useState)(n);(0,h.useEffect)(()=>{let e=a.focus$.subscribe(e=>{l(e)});return()=>{e.unsubscribe()}},[]);let u=/* @__PURE__ */S(e=>{let t=s[0].unitId,r=s[0].subUnitId,n=s.map(e=>e.drawingId);a.featurePluginOrderUpdateNotification({unitId:t,subUnitId:r,drawingIds:n,arrangeType:e})},"onArrangeBtnClick");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelGrid,style:{display:o(r)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,i.t("image-panel.arrange.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */S(()=>{u(d.ArrangeTypeEnum.forward)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:er.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(Z,null),i.t("image-panel.arrange.forward")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */S(()=>{u(d.ArrangeTypeEnum.backward)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:er.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(q,null),i.t("image-panel.arrange.backward"))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */S(()=>{u(d.ArrangeTypeEnum.front)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:er.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(J,null),i.t("image-panel.arrange.front")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */S(()=>{u(d.ArrangeTypeEnum.back)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:er.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(H,null),i.t("image-panel.arrange.back"))))))},"DrawingArrange"),ei=[-3600,3600],ea=/* @__PURE__ */S(e=>{var r;let n=(0,c.useDependency)(c.LocaleService),i=(0,c.useDependency)(d.IDrawingManagerService),a=(0,c.useDependency)(u.IRenderManagerService),{drawings:o,transformShow:s}=e,l=o[0];if(null==l)return;let g=l.transform;if(null==g)return;let{unitId:f,subUnitId:v,drawingId:_,drawingType:I}=l,C=a.getRenderById(f),y=null==C?void 0:C.scene;if(null==y)return;let b=null==(r=y.getEngine())?void 0:r.activeScene;if(null==b)return;let w=y.getTransformerByCreate(),{width:R=0,height:E=0,left:T=0,top:M=0,angle:O=0}=g,[U,P]=(0,h.useState)(R),[k,N]=(0,h.useState)(E),[A,x]=(0,h.useState)(T),[L,V]=(0,h.useState)(M),[F,j]=(0,h.useState)(O),[H,$]=(0,h.useState)(w.keepRatio),B=/* @__PURE__ */S((e,t,r,n)=>{let{width:i,height:a}=b,{ancestorLeft:o,ancestorTop:s}=y,l=e,d=t,u=r,c=n;return e+o<0&&(l=-o),t+s<0&&(d=-s),(u=i-l-o)<20&&(u=20),(c=a-d-s)<20&&(c=20),e+u+o>i&&(l=i-r-o),t+c+s>a&&(d=a-n-s),{limitLeft:l,limitTop:d,limitWidth:u,limitHeight:c}},"checkMoveBoundary"),W=/* @__PURE__ */S(e=>{let{objects:t}=e,r=D(t,i);if(1!==r.length)return;let n=r[0];if(null==n)return;let{transform:a}=n;if(null==a)return;let{width:o,height:s,left:l,top:d,angle:u}=a;null!=o&&P(o),null!=s&&N(s),null!=l&&x(l),null!=d&&V(d),null!=u&&j(u)},"changeObs");(0,h.useEffect)(()=>{let e=[w.changeStart$.subscribe(e=>{W(e)}),w.changing$.subscribe(e=>{W(e)}),w.changeEnd$.subscribe(e=>{W(e)}),i.focus$.subscribe(e=>{if(1!==e.length)return;let t=i.getDrawingByParam(e[0]);if(null==t)return;let r=t.transform;if(null==r)return;let{width:n,height:a,left:o,top:s,angle:l}=r;null!=n&&P(n),null!=a&&N(a),null!=o&&x(o),null!=s&&V(s),null!=l&&j(l)})];return()=>{e.forEach(e=>e.unsubscribe())}},[]);let G=(0,c.debounce)(e=>{if(null==e)return;let{limitWidth:t,limitHeight:r}=B(A,L,e=Math.max(e,20),k),n={unitId:f,subUnitId:v,drawingId:_,drawingType:I,transform:{width:e=Math.min(e,t)}};if(H){let t=e/U*k;if((t=Math.max(t,20))>r)return;N(t),n.transform.height=t}P(e),i.featurePluginUpdateNotification([n]),w.refreshControls().changeNotification()},300),Y=(0,c.debounce)(e=>{if(null==e)return;let{limitHeight:t,limitWidth:r}=B(A,L,U,e=Math.max(e,20)),n={unitId:f,subUnitId:v,drawingId:_,drawingType:I,transform:{height:e=Math.min(e,t)}};if(H){let t=e/k*U;if((t=Math.max(t,20))>r)return;P(t),n.transform.width=t}N(e),i.featurePluginUpdateNotification([n]),w.refreshControls().changeNotification()},300),z=(0,c.debounce)(e=>{if(null==e)return;let{limitLeft:t}=B(e,L,U,k),r={unitId:f,subUnitId:v,drawingId:_,drawingType:I,transform:{left:e=t}};x(e),i.featurePluginUpdateNotification([r]),w.refreshControls().changeNotification()},300),K=(0,c.debounce)(e=>{if(null==e)return;let{limitTop:t}=B(A,e,U,k),r={unitId:f,subUnitId:v,drawingId:_,drawingType:I,transform:{top:e=t}};V(e),i.featurePluginUpdateNotification([r]),w.refreshControls().changeNotification()},300),q=/* @__PURE__ */S(e=>{if(null==e)return;let[t,r]=ei;e<t&&(e=t),e>r&&(e=r);let n={unitId:f,subUnitId:v,drawingId:_,drawingType:I,transform:{angle:e}};j(e),i.featurePluginUpdateNotification([n]),w.refreshControls().changeNotification()},"handleRotationChange"),X=/* @__PURE__ */S(e=>{$(e),w.keepRatio=e},"handleLockRatioChange"),Z=/* @__PURE__ */S(e=>e?"block":"none","gridDisplay");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelGrid,er.imageCommonPanelBorder),style:{display:Z(s)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,n.t("image-panel.transform.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},n.t("image-panel.transform.width"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:U,onChange:/* @__PURE__ */S(e=>{G(e)},"onChange"),className:er.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},n.t("image-panel.transform.height"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:k,onChange:/* @__PURE__ */S(e=>{Y(e)},"onChange"),className:er.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},n.t("image-panel.transform.lock"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelRow,er.imageCommonPanelRowVertical)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Checkbox,{checked:H,onChange:X})))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},n.t("image-panel.transform.x"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:A,onChange:/* @__PURE__ */S(e=>{z(e)},"onChange"),className:er.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},n.t("image-panel.transform.y"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:L,onChange:/* @__PURE__ */S(e=>{K(e)},"onChange"),className:er.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},n.t("image-panel.transform.rotate"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:F,onChange:q,className:er.imageCommonPanelInput})))))))},"DrawingTransform");var eo=((a=eo||{}).default="0",a.left="1",a.center="2",a.right="3",a.top="4",a.middle="5",a.bottom="6",a.horizon="7",a.vertical="8",a);let es={id:"sheet.operation.set-image-align",type:c.CommandType.OPERATION,handler:/* @__PURE__ */S((e,t)=>!0,"handler")},el=/* @__PURE__ */S(e=>{let r=(0,c.useDependency)(c.ICommandService),n=(0,c.useDependency)(c.LocaleService),{alignShow:i}=e,[a,o]=(0,h.useState)(eo.default),s=[{label:n.t("image-panel.align.default"),value:eo.default},{options:[{label:n.t("image-panel.align.left"),value:eo.left},{label:n.t("image-panel.align.center"),value:eo.center},{label:n.t("image-panel.align.right"),value:eo.right}]},{options:[{label:n.t("image-panel.align.top"),value:eo.top},{label:n.t("image-panel.align.middle"),value:eo.middle},{label:n.t("image-panel.align.bottom"),value:eo.bottom}]},{options:[{label:n.t("image-panel.align.horizon"),value:eo.horizon},{label:n.t("image-panel.align.vertical"),value:eo.vertical}]}];function l(e){o(e),r.executeCommand(es.id,{alignType:e})}S(l,"handleAlignChange");let d=/* @__PURE__ */S(e=>e?"block":"none","gridDisplay");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelGrid,er.imageCommonPanelBorder),style:{display:d(i)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,n.t("image-panel.align.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Select,{value:a,options:s,onChange:l}))))},"DrawingAlign"),ed={id:"sheet.operation.open-image-crop",type:c.CommandType.OPERATION,handler:/* @__PURE__ */S((e,t)=>!0,"handler")},eu={id:"sheet.operation.close-image-crop",type:c.CommandType.OPERATION,handler:/* @__PURE__ */S((e,t)=>!0,"handler")};var ec=((o=ec||{}).FREE="0",o.R1_1="1",o.R16_9="2",o.R9_16="3",o.R5_4="4",o.R4_5="5",o.R4_3="6",o.R3_4="7",o.R3_2="8",o.R2_3="9",o);let eh={id:"sheet.operation.Auto-image-crop",type:c.CommandType.OPERATION,handler:/* @__PURE__ */S((e,t)=>!0,"handler")},em=/* @__PURE__ */S(e=>{let r=(0,c.useDependency)(c.ICommandService),n=(0,c.useDependency)(c.LocaleService),{drawings:i,cropperShow:a}=e;if(null==i[0])return;let[o,s]=(0,h.useState)(ec.FREE),l=(0,h.useRef)(!1),d=[{label:n.t("image-panel.crop.mode"),value:ec.FREE},{label:"1:1",value:ec.R1_1},{label:"16:9",value:ec.R16_9},{label:"9:16",value:ec.R9_16},{label:"5:4",value:ec.R5_4},{label:"4:5",value:ec.R4_5},{label:"4:3",value:ec.R4_3},{label:"3:4",value:ec.R3_4},{label:"3:2",value:ec.R3_2},{label:"2:3",value:ec.R2_3}];function u(e){s(e),l.current&&r.executeCommand(eh.id,{cropType:e})}(0,h.useEffect)(()=>{let e=r.onCommandExecuted(e=>{if(e.id===eu.id){let t=e.params;null!=t&&t.isAuto||(l.current=!1)}});return()=>{null==e||e.dispose()}},[]),S(u,"handleCropChange");let g=/* @__PURE__ */S(e=>e?"block":"none","gridDisplay"),f=/* @__PURE__ */S(e=>{r.executeCommand(eh.id,{cropType:e}),l.current=!0},"onCropperBtnClick");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelGrid,er.imageCommonPanelBorder),style:{display:g(a)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,n.t("image-panel.crop.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelRow,er.imageCommonPanelRowVertical)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */S(()=>{f(o)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:er.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(B,null),n.t("image-panel.crop.start")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Select,{value:o,options:d,onChange:u}))))},"ImageCropper"),ep=/* @__PURE__ */S(e=>{let r=(0,c.useDependency)(c.LocaleService),n=(0,c.useDependency)(u.IRenderManagerService),i=(0,c.useDependency)(d.IDrawingManagerService),{hasGroup:a,drawings:o}=e,[s,l]=(0,h.useState)(!1),[g,f]=(0,h.useState)(!0),[v,_]=(0,h.useState)(!0),I=/* @__PURE__ */S(e=>e?"block":"none","gridDisplay"),C=/* @__PURE__ */S(()=>{let e=i.getFocusDrawings(),{unitId:t,subUnitId:r}=e[0],n=(0,c.Tools).generateRandomId(10),a=(0,u.getGroupState)(0,0,e.map(e=>e.transform||{})),o={unitId:t,subUnitId:r,drawingId:n,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:a},s=e.map(e=>{let t=e.transform||{left:0,top:0},{unitId:r,subUnitId:i,drawingId:o}=e;return{unitId:r,subUnitId:i,drawingId:o,transform:{...t,left:t.left-a.left,top:t.top-a.top},groupId:n}});i.featurePluginGroupUpdateNotification([{parent:o,children:s}])},"onGroupBtnClick"),y=/* @__PURE__ */S(e=>{if(e.drawingType!==d.DrawingTypeEnum.DRAWING_GROUP)return;let{unitId:t,subUnitId:r,drawingId:n,transform:a={width:0,height:0}}=e;if(null==a)return;let o=i.getDrawingsByGroup({unitId:t,subUnitId:r,drawingId:n});if(0!==o.length)return{parent:e,children:o.map(e=>{let{transform:t}=e,{unitId:r,subUnitId:n,drawingId:i}=e,o=(0,u.transformObjectOutOfGroup)(t||{},a,a.width||0,a.height||0);return{unitId:r,subUnitId:n,drawingId:i,transform:{...t,...o},groupId:void 0}})}},"ungroup"),b=/* @__PURE__ */S(()=>{let e=i.getFocusDrawings().map(e=>y(e)).filter(e=>null!=e);0!==e.length&&i.featurePluginUngroupUpdateNotification(e)},"onUngroupBtnClick");return(0,h.useEffect)(()=>{let e=o[0];if(null==e)return;let{unitId:t}=e,r=n.getRenderById(t),a=null==r?void 0:r.scene;if(null==a)return;let s=a.getTransformerByCreate(),u=s.clearControl$.subscribe(e=>{!0===e&&l(!1)}),c=s.changeStart$.subscribe(e=>{let{objects:t}=e,r=D(t,i),n=r.filter(e=>(null==e?void 0:e.drawingType)===d.DrawingTypeEnum.DRAWING_GROUP),a=!1,o=!1;r.length>1&&(a=!0),n.length>0&&(o=!0),l(a||o),f(a),_(o)});return()=>{c.unsubscribe(),u.unsubscribe()}},[]),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelGrid,er.imageCommonPanelBorder),style:{display:I(!0===a&&s)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,r.t("image-panel.group.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:er.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2,er.imageCommonPanelColumnCenter)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */S(()=>{C()},"onClick"),style:{display:I(g)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:er.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(G,null),r.t("image-panel.group.group")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(er.imageCommonPanelColumn,er.imageCommonPanelSpan2,er.imageCommonPanelColumnCenter)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */S(()=>{b()},"onClick"),style:{display:I(v)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:er.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(et,null),r.t("image-panel.group.unGroup"))))))},"DrawingGroup"),eg=/* @__PURE__ */S(e=>{let r=(0,c.useDependency)(d.IDrawingManagerService),n=(0,c.useDependency)(u.IRenderManagerService),i=(0,c.useDependency)(c.LocaleService),{drawings:a,hasArrange:o=!0,hasTransform:s=!0,hasAlign:l=!0,hasCropper:m=!0,hasGroup:p=!0}=e,g=a[0];if(null==g)return;let{unitId:f}=g,v=n.getRenderById(f),_=null==v?void 0:v.scene;if(null==_)return;let I=_.getTransformerByCreate(),[S,C]=(0,h.useState)(!0),[y,b]=(0,h.useState)(!0),[w,R]=(0,h.useState)(!1),[E,T]=(0,h.useState)(!0),[M,O]=(0,h.useState)(!1);return(0,h.useEffect)(()=>{let e=I.clearControl$.subscribe(e=>{!0===e&&(C(!1),b(!1),R(!1),T(!1),O(!0))}),t=I.changeStart$.subscribe(e=>{let{objects:t}=e,n=D(t,r);0===n.length?(C(!1),b(!1),R(!1),T(!1),O(!0)):(1===n.length?(C(!0),b(!0),R(!1),T(!0)):(C(!0),b(!1),R(!0),T(!1)),O(!1))}),n=r.focus$.subscribe(e=>{0===e.length?(C(!1),b(!1),R(!1),T(!1),O(!0)):(1===e.length?(C(!0),b(!0),R(!1),T(!0)):(C(!0),b(!1),R(!0),T(!1)),O(!1))});return()=>{t.unsubscribe(),e.unsubscribe(),n.unsubscribe()}},[]),/* @__PURE__ *//*@__PURE__*/t(h).createElement(/*@__PURE__*/t(h).Fragment,null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{style:{display:!0===M?"block":"none",height:"100%"}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",top:"50%",marginTop:"-100px"}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",null,i.t("image-panel.null")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement(en,{arrangeShow:!0===o&&S,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(ea,{transformShow:!0===s&&y,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(el,{alignShow:!0===l&&w,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(em,{cropperShow:!0===m&&E,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(ep,{hasGroup:p,drawings:a}))},"DrawingCommonPanel"),ef={imagePopupMenu:"univer-image-popup-menu",imagePopupMenuItem:"univer-image-popup-menu-item",imagePopupMenuItemTitle:"univer-image-popup-menu-item-title",btnContainer:"univer-btn-container",btnContainerExpand:"univer-btn-container-expand"},ev=/* @__PURE__ */S(e=>{var r,n;let i=null==(n=null==(r=e.popup)?void 0:r.extraProps)?void 0:n.menuItems;if(!i)return null;let a=(0,c.useDependency)(c.ICommandService),o=(0,c.useDependency)(c.LocaleService),[s,l]=(0,h.useState)(!1),[d,u]=(0,h.useState)(!1),g=/* @__PURE__ */S(()=>{u(!0)},"handleMouseEnter"),f=/* @__PURE__ */S(()=>{u(!1)},"handleMouseLeave"),v=/* @__PURE__ */S(e=>{l(e)},"onVisibleChange"),_=/* @__PURE__ */S(e=>{a.executeCommand(e.commandId,e.commandParams),l(!1)},"handleClick"),I=s||d,C=i.filter(e=>!e.disable);return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{onMouseEnter:g,onMouseLeave:f},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Dropdown,{placement:"bottomLeft",trigger:["click"],overlay:/* @__PURE__ *//*@__PURE__*/t(h).createElement("ul",{className:ef.imagePopupMenu},C.map(e=>/* @__PURE__ *//*@__PURE__*/t(h).createElement("li",{key:e.index,onClick:/* @__PURE__ */S(()=>_(e),"onClick"),className:ef.imagePopupMenuItem},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:ef.imagePopupMenuItemTitle},o.t(e.label))))),visible:s,onVisibleChange:v},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:(0,p.default)(ef.btnContainer,{[ef.btnContainerExpand]:s})},/* @__PURE__ *//*@__PURE__*/t(h).createElement(F,{style:{color:"#35322B"},extend:{colorChannel1:"rgb(var(--green-700, #409f11))"}}),I&&/* @__PURE__ *//*@__PURE__*/t(h).createElement(z,{style:{color:"#CCCCCC",fontSize:"8px",marginLeft:"8px"}}))))},"ImagePopupMenu"),e_="COMPONENT_IMAGE_POPUP_MENU";var eI,eS=Object.defineProperty,eC=Object.getOwnPropertyDescriptor,ey=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eC(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eS(t,r,a),a},"__decorateClass$4"),eb=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let ew=(S(eI=class extends c.Disposable{constructor(e,t,r,n){super(),C(this,"_sceneListenerOnDrawingMap",/* @__PURE__ */new WeakSet),this._currentUniverService=e,this._commandService=t,this._renderManagerService=r,this._drawingManagerService=n,this._initialize()}dispose(){super.dispose()}_initialize(){this._recoveryImages(),this._drawingAddListener(),this._drawingRemoveListener(),this._drawingUpdateListener(),this._commandExecutedListener(),this._drawingArrangeListener(),this._drawingGroupListener(),this._drawingRefreshListener(),this._drawingVisibleListener()}_recoveryImages(){let e=this._drawingManagerService.drawingManagerData,t=b(this._currentUniverService);if(null==t)return;let{unitId:r,subUnitId:n}=t;Object.keys(e).forEach(t=>{Object.keys(e[t]).forEach(i=>{let a=e[t][i].data;null==a||t!==r||i!==n||Object.keys(a).forEach(e=>{a[e]&&this._insertDrawing([{unitId:t,subUnitId:i,drawingId:e}])})})})}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===es.id){let t=e.params;null!=t&&this._drawingAlign(t)}}))}_drawingGroupListener(){this.disposeWithMe(this._drawingManagerService.group$.subscribe(e=>{this._groupDrawings(e)})),this.disposeWithMe(this._drawingManagerService.ungroup$.subscribe(e=>{this._ungroupDrawings(e)}))}_getSceneAndTransformerByDrawingSearch(e){if(null==e)return;let t=this._renderManagerService.getRenderById(e),r=null==t?void 0:t.scene;if(null==r)return null;let n=r.getTransformerByCreate();return{scene:r,transformer:n}}_groupDrawings(e){e.forEach(e=>{this._groupDrawing(e)})}_groupDrawing(e){let{parent:t,children:r}=e,{unitId:n,subUnitId:i,drawingId:a}=t,o=this._getSceneAndTransformerByDrawingSearch(t.unitId);if(null==o)return;let{scene:s,transformer:l}=o;this._commandService.syncExecuteCommand(eu.id);let c=[];if(r.forEach(e=>{let t=(0,d.getDrawingShapeKeyByDrawingSearch)(e),r=s.getObjectIncludeInGroup(t);if(null==r||c.includes(r))return;c.push(r);let{transform:n}=e;null!=n&&(r.classType===u.RENDER_CLASS_TYPE.GROUP?r.transformByState({left:n.left,top:n.top}):r.transformByState(n))}),0===c.length)return;let h=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:n,subUnitId:i,drawingId:a}),m=new u.Group(h);s.addObject(m,u.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(m),m.addObjects(...c),t.transform&&m.transformByState({left:t.transform.left,top:t.transform.top}),l.clearSelectedObjects(),l.setSelectedControl(m)}_ungroupDrawings(e){e.forEach(e=>{this._ungroupDrawing(e)})}_ungroupDrawing(e){let{parent:t,children:r}=e,n=this._getSceneAndTransformerByDrawingSearch(t.unitId);if(null==n)return;let{scene:i,transformer:a}=n;r.forEach(e=>{let t=(0,d.getDrawingShapeKeyByDrawingSearch)(e),r=i.getObjectIncludeInGroup(t);if(null==r)return!0;if(null==r)return;let{transform:n}=e;null!=n&&(r.classType===u.RENDER_CLASS_TYPE.GROUP?r.transformByState({left:n.left,top:n.top}):r.transformByState(n))});let o=(0,d.getDrawingShapeKeyByDrawingSearch)(t),s=i.getObject(o),{width:l,height:c}=s;s.getObjects().forEach(e=>{s.removeSelfObjectAndTransform(e.oKey,l,c)}),s.dispose(),a.clearSelectedObjects()}_drawingAlign(e){let{alignType:t}=e,r=this._drawingManagerService.getFocusDrawings();if(t===eo.default)return;let n=[],i=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY,l=0;r.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:d,drawingType:u}=e,c=this._drawingManagerService.getDrawingByParam({unitId:t,subUnitId:r,drawingId:d});if(null==c||null==c.transform)return;n.push({unitId:t,subUnitId:r,drawingId:d,drawingType:u,transform:c.transform});let{left:h=0,top:m=0,width:p=0,height:g=0}=c.transform;i=Math.min(i,h),a=Math.min(a,m),o=Math.max(o,h+p),s=Math.max(s,m+g),l++}),0!==l&&(this._sortDrawingTransform(n,t),this._applyAlignType(n,t,i,a,o,s,l))}_applyAlignType(e,t,r,n,i,a,o){let s=Math.round((i-r)/o*10)/10,l=Math.round((a-n)/o*10)/10,d=[],u=this._getSceneAndTransformerByDrawingSearch(e[0].unitId);if(null==u)return;let{scene:c,transformer:h}=u;e.forEach((e,o)=>{let{unitId:u,subUnitId:c,drawingId:h,transform:m,drawingType:p}=e,{left:g=0,top:f=0,width:v=0,height:_=0}=m,I=g,S=f;switch(t){case eo.left:I=r;break;case eo.center:I=r+(i-r)/2-v/2;break;case eo.right:I=i-v;break;case eo.top:S=n;break;case eo.middle:S=n+(a-n)/2-_/2;break;case eo.bottom:S=a-_;break;case eo.horizon:I=r+s*o;break;case eo.vertical:S=n+l*o}(I!==g||S!==f)&&d.push({unitId:u,subUnitId:c,drawingId:h,drawingType:p,transform:{left:I,top:S}})}),this._drawingManagerService.featurePluginUpdateNotification(d),h.refreshControls().changeNotification()}_sortDrawingTransform(e,t){e.sort((e,r)=>{let n=e.transform,i=r.transform,{left:a=0,top:o=0,width:s=0,height:l=0}=n,{left:d=0,top:u=0,width:c=0,height:h=0}=i;switch(t){case eo.left:return a-d;case eo.center:return a+s/2-(d+c/2);case eo.right:return a+s-(d+c);case eo.top:return o-u;case eo.middle:return o+l/2-(u+h/2);case eo.bottom:return o+l-(u+h);case eo.horizon:return a+s/2-(d+c/2);case eo.vertical:return o+l/2-(u+h/2);default:return 0}})}_drawingArrangeListener(){this.disposeWithMe(this._drawingManagerService.order$.subscribe(e=>{this._drawingArrange(e)}))}_drawingArrange(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=this._getSceneAndTransformerByDrawingSearch(t);if(null==i)return;let{scene:a}=i;n.forEach(e=>{let n=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:e}),i=a.fuzzyMathObjects(n,!0);if(null==i||0===i.length)return;let o=this._drawingManagerService.getDrawingOrder(t,r).indexOf(e);for(let e of i)e.setProps({zIndex:o}),e.makeDirty()})}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{this._insertDrawing(e)}))}_insertDrawing(e){let t=[];e.forEach(e=>{let{unitId:r,subUnitId:n,drawingId:i}=e;if(null==this._drawingManagerService.getDrawingByParam(e))return;let a=this._getSceneAndTransformerByDrawingSearch(r);if(null==a)return;let{scene:o,transformer:s}=a;t.includes(o)||t.push(o)}),t.forEach(e=>{this._sceneListenerOnDrawingMap.has(e)||(this._addListenerOnDrawing(e),this._sceneListenerOnDrawingMap.add(e))})}_drawingRemoveListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(e=>{var t;let{unitId:r,subUnitId:n,drawingId:i}=e,a=this._getSceneAndTransformerByDrawingSearch(r);if(null==a)return;let{scene:o}=a,s=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:r,subUnitId:n,drawingId:i}),l=o.fuzzyMathObjects(s,!0);if(l.length>0){for(let e of l)e.dispose();null==(t=o.getTransformer())||t.clearSelectedObjects()}})}))}_drawingUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._drawingManagerService.getDrawingByParam(e);if(null==i)return;let{transform:a,drawingType:o}=i,s=this._getSceneAndTransformerByDrawingSearch(t);if(null==s)return;let{scene:l,transformer:u}=s;if(null==a)return!0;let{left:c=0,top:h=0,width:m=0,height:p=0,angle:g=0,flipX:f=!1,flipY:v=!1,skewX:_=0,skewY:I=0}=a,S=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),C=l.getObject(S);if(null==C)return!0;C.transformByState({left:c,top:h,width:m,height:p,angle:g,flipX:f,flipY:v,skewX:_,skewY:I})})}))}_drawingRefreshListener(){this.disposeWithMe(this._drawingManagerService.refreshTransform$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._getSceneAndTransformerByDrawingSearch(t);if(null==i)return;let a=this._drawingManagerService.getDrawingByParam(e);if(null==a)return;let{transform:o}=a,{scene:s}=i,l=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),u=s.getObject(l);if(null==u||null==o)return!0;let{left:c=0,top:h=0,width:m=0,height:p=0,angle:g=0,flipX:f=!1,flipY:v=!1,skewX:_=0,skewY:I=0}=o;u.transformByState({left:c,top:h,width:m,height:p,angle:g,flipX:f,flipY:v,skewX:_,skewY:I})})}))}_drawingVisibleListener(){this.disposeWithMe(this._drawingManagerService.visible$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n,visible:i}=e,a=this._getSceneAndTransformerByDrawingSearch(t);if(null==a)return;let{scene:o}=a,s=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),l=o.getObject(s);if(null==l)return!0;i?l.show():l.hide()})}))}_filterUpdateParams(e,t){return e.filter((e,r)=>{if(null==e)return!1;let{transform:n}=e;return(0,c.checkIfMove)(n,null==t?void 0:t[r])})}_addListenerOnDrawing(e){let t=e.getTransformerByCreate(),r=null;this.disposeWithMe((0,c.toDisposable)(t.changeStart$.subscribe(e=>{let{objects:t}=e,n=Array.from(t.values()),i=[];r=n.map(e=>{let{left:t,top:r,height:n,width:a,angle:o,oKey:s,isInGroup:l}=e,d=this._drawingManagerService.getDrawingOKey(s);if(l||e instanceof u.Group){let t=e.ancestorGroup;if(null==t&&e instanceof u.Group&&(t=e),null==t)return null;let r=this._drawingManagerService.getDrawingOKey(t.oKey);if(r){let{unitId:e,subUnitId:n,drawingId:a}=r;i.push({unitId:e,subUnitId:n,drawingId:a});let{left:o,top:s,height:l,width:d,angle:u}=t;return{left:o,top:s,height:l,width:d,angle:u}}}else if(null!=d){let{unitId:e,subUnitId:s,drawingId:l}=d;return i.push({unitId:e,subUnitId:s,drawingId:l}),{left:t,top:r,height:n,width:a,angle:o}}return null}).filter(e=>null!=e),i.length>0?this._drawingManagerService.focusDrawing(i):this._drawingManagerService.focusDrawing(null)}))),this.disposeWithMe((0,c.toDisposable)(t.changeEnd$.subscribe(e=>{let{objects:t}=e,n=this._filterUpdateParams(D(t,this._drawingManagerService),r);n.length>0&&this._drawingManagerService.featurePluginUpdateNotification(n)})))}},"DrawingUpdateController"),eI);ew=ey([(0,c.OnLifecycle)(c.LifecycleStages.Rendered,ew),eb(0,c.IUniverInstanceService),eb(1,c.ICommandService),eb(2,u.IRenderManagerService),eb(3,d.IDrawingManagerService)],ew);let eR=/* @__PURE__ */S(e=>{let{src:r}=e;return r?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("img",{src:r,alt:"Univer Image Viewer",style:{width:"100%",height:"100%",position:"relative"}})):null},"ImageViewer"),eE="COMPONENT_IMAGE_VIEWER",eT={id:"sheet.operation.image-reset-size",type:c.CommandType.OPERATION,handler:/* @__PURE__ */S((e,t)=>!0,"handler")};var eM,eO=Object.defineProperty,eD=Object.getOwnPropertyDescriptor,eU=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eD(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eO(t,r,a),a},"__decorateClass$3"),eP=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let ek=(S(eM=class extends c.Disposable{constructor(e,t){super(),this._componentManager=e,this._commandService=t,this._init()}_initCustomComponents(){let e=this._componentManager;this.disposeWithMe(e.register(e_,ev)),this.disposeWithMe(e.register(eE,eR))}_initCommands(){[ed,eu,eT,es,eh].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_init(){this._initCommands(),this._initCustomComponents()}},"DrawingUIController"),eM);ek=eU([(0,c.OnLifecycle)(c.LifecycleStages.Rendered,ek),eP(0,(0,c.Inject)(g.ComponentManager)),eP(1,c.ICommandService)],ek);let eN=class extends u.Shape{constructor(e,t){null==t&&(t={}),t.transformerConfig={keepRatio:!1,isCropper:!0,anchorFill:"rgb(0, 0, 0)",anchorStroke:"rgb(255, 255, 255)",anchorSize:24},super(e,t),C(this,"_srcRect"),C(this,"_prstGeom"),C(this,"_applyTransform"),C(this,"_dragPadding",8),C(this,"_cacheCanvas"),null!=t&&t.srcRect&&(this._srcRect=t.srcRect),null!=t&&t.prstGeom&&(this._prstGeom=t.prstGeom),null!=t&&t.applyTransform&&(this._applyTransform=t.applyTransform),null!=t&&t.dragPadding&&(this._dragPadding=t.dragPadding),this._applyProps()}refreshSrcRect(e,t){this._srcRect=e,this._applyTransform=t,this._applyProps()}get srcRect(){return this._srcRect}dispose(){var e;super.dispose(),null==(e=this._cacheCanvas)||e.dispose(),this._srcRect=null}isHit(e){let t=this.getInverseCoord(e);return t.x>=-this.strokeWidth/2&&t.x<=this.width+this.strokeWidth/2&&t.y>=-this.strokeWidth/2&&t.y<=this.height+this.strokeWidth/2&&!this._inSurround(t)}_inSurround(e){let t=this._dragPadding;return e.x>=t-this.strokeWidth/2&&e.x<=this.width+this.strokeWidth/2-t&&e.y>=t-this.strokeWidth/2&&e.y<=this.height+this.strokeWidth/2-t}render(e,t){return this.visible&&(e.save(),this._draw(e),e.restore()),this.makeDirty(!1),this}_draw(e){var t,r;let{width:n,height:i}=this.getScene().getEngine();this._initialCacheCanvas(),null==(t=this._cacheCanvas)||t.clear();let a=null==(r=this._cacheCanvas)?void 0:r.getContext();null!=a&&(a.save(),(0,u.Rect).drawWith(a,{left:0,top:0,width:n,height:i,fill:"rgba(0, 0, 0, 0.5)"}),a.setTransform(e.getTransform()),this._clipForApplyObject(a),this._applyCache(e),a.restore())}_clipForApplyObject(e){let t=0;if(null!=this._prstGeom&&(t=1),e.globalCompositeOperation="destination-out",e.beginPath(),0===t){let t=this.transform.getMatrix();e.transform(t[0],t[1],t[2],t[3],t[4],t[5]),e.rect(0,0,this.width,this.height),e.fill()}}_applyProps(){if(null==this._applyTransform)return;let e=0,t=0,r=0,n=0,{left:i=0,top:a=0,width:o=0,height:s=0,angle:l}=this._applyTransform;if(null!=this._srcRect){let{left:i=0,top:a=0,right:o=0,bottom:s=0}=this._srcRect;e=i,t=a,r=o,n=s}let d=i+e,u=a+t;this.transformByState({left:d,top:u,width:i+o-r-d,height:a+s-n-u,angle:l})}_applyCache(e){if(!e||null==this._cacheCanvas)return;let t=this._cacheCanvas.getContext();t.save(),e.save(),e.setTransform(1,0,0,1,0,0),t.setTransform(1,0,0,1,0,0),e.drawImage(this._cacheCanvas.getCanvasEle(),0,0),e.restore(),t.restore()}_initialCacheCanvas(){if(null!=this._cacheCanvas)return;let e=this.getScene();if(null==e)return;this._cacheCanvas=new u.Canvas;let t=e.getEngine();this._cacheCanvas.setSize(t.width,t.height),t.onTransformChange$.subscribeEvent(()=>{var e;null==(e=this._cacheCanvas)||e.setSize(t.width,t.height),this.makeDirty(!0)})}};S(eN,"ImageCropperObject");let eA=eN;var ex,eL=Object.defineProperty,eV=Object.getOwnPropertyDescriptor,eF=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eV(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eL(t,r,a),a},"__decorateClass$2"),ej=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let eH=(S(ex=class extends c.Disposable{constructor(e,t,r,n,i,a){super(),C(this,"_sceneListenerOnImageMap",/* @__PURE__ */new WeakSet),this._commandService=e,this._drawingManagerService=t,this._renderManagerService=r,this._univerInstanceService=n,this._messageService=i,this._localeService=a,this._init()}_init(){this._initOpenCrop(),this._initCloseCrop(),this._initAutoCrop()}_initAutoCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==eh.id)return;let t=e.params;if(null==t)return;let{cropType:r}=t,n=this._drawingManagerService.getFocusDrawings();if(1!==n.length)return;let{unitId:i,subUnitId:a,drawingId:o}=n[0],s=this._renderManagerService.getRenderById(i),l=null==s?void 0:s.scene;if(null==l)return!0;null!=this._searchCropObject(l)&&this._commandService.syncExecuteCommand(eu.id,{isAuto:!0});let c=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:i,subUnitId:a,drawingId:o}),h=l.getObject(c);if(!(h instanceof u.Image)){this._messageService.show({type:m.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}null!=h&&(this._updateCropperObject(r,h),this._commandService.executeCommand(ed.id,{unitId:i,subUnitId:a,drawingId:o}))}))}_calculateSrcRectByRatio(e,t,r,n,i,a){let o=i/a,s=r,l=n;r/n>o?s=n*o:l=r/o;let d=(r-s)/2,c=(n-l)/2;return{left:(0,u.precisionTo)(d,1),top:(0,u.precisionTo)(c,1),right:(0,u.precisionTo)(r-(d+s),1),bottom:(0,u.precisionTo)(n-(c+l),1)}}_updateCropperObject(e,t){let r;let{left:n,top:i,width:a,height:o}=t.calculateTransformWithSrcRect();switch(e){case ec.R1_1:r=this._calculateSrcRectByRatio(n,i,a,o,1,1);break;case ec.R16_9:r=this._calculateSrcRectByRatio(n,i,a,o,16,9);break;case ec.R9_16:r=this._calculateSrcRectByRatio(n,i,a,o,9,16);break;case ec.R5_4:r=this._calculateSrcRectByRatio(n,i,a,o,5,4);break;case ec.R4_5:r=this._calculateSrcRectByRatio(n,i,a,o,4,5);break;case ec.R4_3:r=this._calculateSrcRectByRatio(n,i,a,o,4,3);break;case ec.R3_4:r=this._calculateSrcRectByRatio(n,i,a,o,3,4);break;case ec.R3_2:r=this._calculateSrcRectByRatio(n,i,a,o,3,2);break;case ec.R2_3:r=this._calculateSrcRectByRatio(n,i,a,o,2,3);case ec.FREE:}if(null==r)return;t.setSrcRect(r);let{left:s=0,top:l=0,bottom:d=0,right:u=0}=r;t.transformByStateCloseCropper({left:n+s,top:i+l,width:a-u-s,height:o-d-l})}_initOpenCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==ed.id)return;let t=e.params;if(null==t)return;let{unitId:r,subUnitId:n,drawingId:i}=t,a=this._renderManagerService.getRenderById(r),o=null==a?void 0:a.scene;if(null==o)return!0;if(this._sceneListenerOnImageMap.has(o)||(this._addListenerOnImage(o),this._sceneListenerOnImageMap.add(o)),null==this._drawingManagerService.getDrawingByParam({unitId:r,subUnitId:n,drawingId:i}))return;let s=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:r,subUnitId:n,drawingId:i}),l=o.getObject(s);if(null==l)return;if(!(l instanceof u.Image)){this._messageService.show({type:m.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}let c=o.getTransformer();null==c||c.clearControls();let h=new eA(`${s}-crop`,{srcRect:l.srcRect,prstGeom:l.prstGeom,applyTransform:l.calculateTransformWithSrcRect()});o.addObject(h,l.getLayerIndex()+1).attachTransformerTo(h),null==c||c.createControlForCopper(h),this._addHoverForImageCopper(h),l.openRenderByCropper(),null==c||c.refreshControls(),h.makeDirty(!0),this._drawingManagerService.focusDrawing([{unitId:r,subUnitId:n,drawingId:i}])}))}_searchCropObject(e){for(let t of e.getAllObjectsByOrder())if(t instanceof eA)return t}_initCloseCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==eu.id)return;let t=this._univerInstanceService.getFocusedUnit();if(null==t)return;let r=t.getUnitId(),n=this._renderManagerService.getRenderById(r),i=null==n?void 0:n.scene;if(null==i)return!0;let a=this._searchCropObject(i);if(null==a)return;let o=this._getApplyObjectByCropObject(a);if(null==o)return;let s=i.getTransformerByCreate();s.detachFrom(a),s.clearCopperControl();let l=this._getSrcRectByTransformState(o,a),d=this._drawingManagerService.getDrawingOKey(o.oKey);if(null!=d){let{left:e,top:t,height:r,width:n}=a;this._drawingManagerService.featurePluginUpdateNotification([{...d,transform:{...d.transform,left:e,top:t,height:r,width:n},srcRect:l.srcRectAngle}])}o.setSrcRect({...l.srcRectAngle}),o.closeRenderByCropper(),o.makeDirty(!0),null==a||a.dispose()}));let e=this._univerInstanceService.getCurrentTypeOfUnit$(c.UniverInstanceType.UNIVER_SHEET).pipe((0,f.filter)(e=>!!e),(0,v.switchMap)(e=>e.activeSheet$));this.disposeWithMe(e.subscribe(()=>{this._commandService.syncExecuteCommand(eu.id)}))}_getApplyObjectByCropObject(e){let t=e.oKey,r=t.slice(0,t.length-5),n=e.getScene();if(!n)return null;let i=n.getObject(r);return null==i?null:i}_addListenerOnImage(e){let t=e.getTransformerByCreate(),r=null;this.disposeWithMe(t.changeStart$.subscribe(e=>{let{objects:n}=e,i=n.values().next().value;if(null==i||!(i instanceof eA))return;let{left:a,top:o,height:s,width:l,angle:d}=i;r={left:a,top:o,height:s,width:l,angle:d},t.clearCopperControl()})),this.disposeWithMe(t.changeEnd$.subscribe(e=>{let{objects:n}=e,i=n.values().next().value;if(null==i||!(i instanceof eA))return;let{left:a,top:o,height:s,width:l,angle:d}=i;if(!(0,c.checkIfMove)({left:a,top:o,height:s,width:l,angle:d},r))return;let u=this._getApplyObjectByCropObject(i);if(null==u)return;let h=this._getSrcRectByTransformState(u,i);i.refreshSrcRect(h.srcRect,u.getState()),t.createControlForCopper(i)})),this._endCropListener(e)}_addHoverForImageCopper(e){this.disposeWithMe(e.onPointerEnter$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.MOVE})),this.disposeWithMe(e.onPointerLeave$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.DEFAULT}))}_endCropListener(e){let t=e.getTransformerByCreate();this.disposeWithMe(t.clearControl$.subscribe(e=>{!0===e&&this._commandService.syncExecuteCommand(eu.id)}))}_getSrcRectByTransformState(e,t){let{left:r,top:n,height:i,width:a,strokeWidth:o,angle:s}=t,{left:l,top:d,width:c,height:h,angle:m,strokeWidth:p}=e,g=r-l,f=n-d,v={left:g,top:f,right:c-g-a,bottom:h-f-i},_={...v};if(0!==m){let e=new u.Vector2(r+a/2,n+i/2),t=new u.Vector2(c/2+l,h/2+d),o=new u.Vector2(l,d);o.rotateByPoint((0,u.degToRad)(m),t);let s=o.clone();s.rotateByPoint((0,u.degToRad)(-m),e);let p=r-s.x,g=n-s.y;_.left=p,_.top=g,_.right=c-p-a,_.bottom=h-g-i}return{srcRect:v,srcRectAngle:_}}},"ImageCropperController"),ex);eH=eF([(0,c.OnLifecycle)(c.LifecycleStages.Rendered,eH),ej(0,c.ICommandService),ej(1,d.IDrawingManagerService),ej(2,u.IRenderManagerService),ej(3,c.IUniverInstanceService),ej(4,g.IMessageService),ej(5,(0,c.Inject)(c.LocaleService))],eH);var e$=Object.defineProperty,eB=Object.getOwnPropertyDescriptor,eW=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eB(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e$(t,r,a),a},"__decorateClass$1"),eG=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let eY=(s=class extends c.Disposable{constructor(e,t,r,n,i,a,o){super(),this._commandService=e,this._renderManagerService=t,this._drawingManagerService=r,this._dialogService=n,this._imageIoService=i,this._currentUniverService=a,this._drawingRenderService=o,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddListener(),this._commandExecutedListener(),this._imageUpdateListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===eT.id){let t=e.params;null!=t&&this._resetImageSize(t)}}))}_getSceneAndTransformerByDrawingSearch(e){if(null==e)return;let t=this._renderManagerService.getRenderById(e),r=null==t?void 0:t.scene;if(null==r)return null;let n=r.getTransformerByCreate();return{scene:r,transformer:n}}_resetImageSize(e){let t=[],r=[];e.forEach(e=>{let{unitId:n,subUnitId:i,drawingId:a}=e,o=this._getSceneAndTransformerByDrawingSearch(n);if(null==o)return;let{scene:s}=o,l=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:n,subUnitId:i,drawingId:a}),u=s.getObject(l);if(null==u)return!0;let c=this._drawingManagerService.getDrawingByParam(e);if(null==c)return!0;if(c.drawingType!==d.DrawingTypeEnum.DRAWING_IMAGE)return;u.resetSize();let{width:h,height:m}=u.getNativeSize();!1===r.includes(s)&&r.push(s),t.push({...c,transform:{...c.transform,height:m,width:h,angle:0},srcRect:null,prstGeom:null})}),this._drawingManagerService.featurePluginUpdateNotification(t),r.forEach(e=>{e.getTransformerByCreate().refreshControls().changeNotification()}),this._drawingManagerService.focusDrawing(e)}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{this._insertImages(e)}))}_insertImages(e){e.forEach(async e=>{var t;let{unitId:r,subUnitId:n,drawingId:i}=e,a=this._getSceneAndTransformerByDrawingSearch(r),o=null==(t=b(this._currentUniverService,r))?void 0:t.subUnitId;if(null==a||o!==n)return;let s=this._drawingManagerService.getDrawingByParam(e);if(null==s)return;let l=await this._drawingRenderService.renderImages(s,a.scene);if(!(null==l||0===l.length))for(let e of l)this._addHoverForImage(e),this._addDialogForImage(e)})}_imageUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._drawingManagerService.getDrawingByParam(e);if(null==i)return;let{transform:a,drawingType:o,srcRect:s,prstGeom:l,source:u,imageSourceType:c}=i;if(o!==d.DrawingTypeEnum.DRAWING_IMAGE)return;let h=this._getSceneAndTransformerByDrawingSearch(t);if(null==h)return;let{scene:m,transformer:p}=h;if(null==a)return!0;let g=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),f=m.getObject(g);if(null==f)return!0;f.setSrcRect(s),f.setPrstGeom(l)})}))}_addHoverForImage(e){this.disposeWithMe((0,c.toDisposable)(e.onPointerEnter$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.GRAB}))),this.disposeWithMe((0,c.toDisposable)(e.onPointerLeave$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.DEFAULT})))}_addDialogForImage(e){this.disposeWithMe((0,c.toDisposable)(e.onDblclick$.subscribeEvent(()=>{var t;let r=`${e.oKey}-viewer-dialog`,n=e.getNativeSize(),i=window.innerWidth-50,a=window.innerHeight-50,o=this._adjustImageSize(n.width,n.height,i,a),s=this._dialogService.open({width:o.width,id:r,style:{margin:"0",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:{label:{name:eE,props:{src:null==(t=e.getNative())?void 0:t.src,width:o.width,height:o.height}}},destroyOnClose:!0,draggable:!1,onClose:/* @__PURE__ */S(()=>{this._dialogService.close(r),s.dispose()},"onClose")})})))}_adjustImageSize(e,t,r,n){if(e<=r&&t<=n)return{width:e,height:t};let i=Math.min(r/e,n/t);return{width:Math.floor(e*i),height:Math.floor(t*i)}}},S(s,"ImageUpdateController"),s);eY=eW([(0,c.OnLifecycle)(c.LifecycleStages.Rendered,eY),eG(0,c.ICommandService),eG(1,u.IRenderManagerService),eG(2,d.IDrawingManagerService),eG(3,g.IDialogService),eG(4,d.IImageIoService),eG(5,c.IUniverInstanceService),eG(6,(0,c.Inject)(O))],eY);let ez={};var eK=Object.defineProperty,eq=Object.getOwnPropertyDescriptor,eX=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eq(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eK(t,r,a),a},"__decorateClass"),eZ=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let eQ=(S(l=class extends c.Plugin{constructor(e=ez,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{menu:n,...i}=this._config;n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig("drawing-ui.config",i)}onStarting(){this._initDependencies()}_initDependencies(){[[O],[ew],[ek],[eH],[eY]].forEach(e=>this._injector.add(e))}},"UniverDrawingUIPlugin"),C(l,"pluginName","UNIVER_DRAWING_UI_PLUGIN"),l);eQ=eX([eZ(1,(0,c.Inject)(c.Injector)),eZ(2,c.IConfigService)],eQ)}),i("e3ZB7",function(t,i){let a,o,s,l;e(t.exports,"DRAWING_IMAGE_WIDTH_LIMIT",function(){return I}),e(t.exports,"DRAWING_IMAGE_HEIGHT_LIMIT",function(){return S}),e(t.exports,"DRAWING_IMAGE_COUNT_LIMIT",function(){return C}),e(t.exports,"DRAWING_IMAGE_ALLOW_SIZE",function(){return y}),e(t.exports,"DRAWING_IMAGE_ALLOW_IMAGE_LIST",function(){return b}),e(t.exports,"UnitDrawingService",function(){return K}),e(t.exports,"getDrawingShapeKeyByDrawingSearch",function(){return X}),e(t.exports,"getImageSize",function(){return Z}),e(t.exports,"ImageSourceType",function(){return Q}),e(t.exports,"ImageUploadStatusType",function(){return J}),e(t.exports,"IImageIoService",function(){return ee}),e(t.exports,"ArrangeTypeEnum",function(){return er}),e(t.exports,"DrawingTypeEnum",function(){return en}),e(t.exports,"IDrawingManagerService",function(){return ei}),e(t.exports,"UniverDrawingPlugin",function(){return eu});var d,u,c,h,m=n("2Ha4T"),p=n("83KcA"),g=Object.defineProperty,f=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,v=(e,t)=>g(e,"name",{value:t,configurable:!0}),_=(e,t,r)=>f(e,"symbol"!=typeof t?t+"":t,r);let I=500,S=500,C=10,y=5242880,b=["image/png","image/jpeg","image/jpg","image/gif","image/bmp"];var w="u">typeof globalThis?globalThis:"u">typeof window?window:"u">typeof r?r:"u">typeof self?self:{},R={},E={},T={};function M(e,t){if(Array.isArray(t))return!1;for(let r in e)if(!D(e[r],t[r]))return!1;for(let r in t)if(void 0===e[r])return!1;return!0}function O(e,t){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!D(e[r],t[r]))return!1;return!0}function D(e,t){return e===t||null!==e&&null!==t&&"object"==typeof e&&"object"==typeof t&&(Array.isArray(e)?O(e,t):M(e,t))}Object.defineProperty(T,"__esModule",{value:!0}),v(M,"eqObj"),v(O,"eqArr"),v(D,"deepEqual"),T.default=D;var U={};function P(e){if(null===e)return null;if(Array.isArray(e))return e.map(P);if("object"!=typeof e)return e;{let t={};for(let r in e)t[r]=P(e[r]);return t}}Object.defineProperty(U,"__esModule",{value:!0}),v(P,"deepClone"),U.default=P;var k={};!function(e){function t(e,t){if(!e)throw Error(t)}Object.defineProperty(e,"__esModule",{value:!0}),e.eachChildOf=e.advancer=e.readCursor=e.writeCursor=e.WriteCursor=e.ReadCursor=e.isValidPathItem=void 0,v(t,"assert");let r=/* @__PURE__ */v(e=>null!=e&&"object"==typeof e&&!Array.isArray(e),"isObject"),n=/* @__PURE__ */v((e,t)=>typeof e==typeof t?e>t:"string"==typeof e&&"number"==typeof t,"isGreaterKey");function i(e,t){for(let r in e)t.write(r,e[r])}v(i,"copyAll"),e.isValidPathItem=e=>"number"==typeof e||"string"==typeof e&&"__proto__"!==e;let a=class{constructor(e=null){this.parents=[],this.indexes=[],this.lcIdx=-1,this.idx=-1,this.container=e}ascend(){t(this.parents.length===this.indexes.length/2),0===this.idx?this.parents.length?(this.lcIdx=this.indexes.pop(),this.container=this.parents.pop(),this.idx=this.indexes.pop()):(this.lcIdx=0,this.idx=-1):(t(this.idx>0),this.idx--,r(this.container[this.idx])&&this.idx--)}getPath(){let e=[],t=this.container,n=this.parents.length-1,i=this.idx;for(;i>=0;)e.unshift(t[i]),0===i?(i=this.indexes[2*n],t=this.parents[n--]):i-=r(t[i-1])?2:1;return e}};v(a,"Cursor");let o=a,s=class e extends o{get(){return this.container?this.container.slice(this.idx+1):null}getKey(){return t(null!=this.container,"Invalid call to getKey before cursor descended"),this.container[this.idx]}getComponent(){let e;return this.container&&this.container.length>this.idx+1&&r(e=this.container[this.idx+1])?e:null}descendFirst(){let e=this.idx+1;if(!this.container||e>=this.container.length||r(this.container[e])&&e+1>=this.container.length)return!1;r(this.container[e])&&e++;let t=this.container[e];return Array.isArray(t)?(this.indexes.push(this.idx),this.parents.push(this.container),this.indexes.push(e),this.idx=0,this.container=t):this.idx=e,!0}nextSibling(){if(t(this.parents.length===this.indexes.length/2),this.idx>0||0===this.parents.length)return!1;let e=this.indexes[this.indexes.length-1]+1,r=this.parents[this.parents.length-1];return!(e>=r.length)&&(t(!isNaN(e)),this.indexes[this.indexes.length-1]=e,this.container=r[e],!0)}_init(e,t,r,n){this.container=e,this.idx=t,this.parents=r.slice(),this.indexes=n.slice()}clone(){let t=new e;return t._init(this.container,this.idx,this.parents,this.indexes),t}*[Symbol.iterator](){if(this.descendFirst()){do yield this.getKey();while(this.nextSibling())this.ascend()}}traverse(e,t){let r=this.getComponent();for(let n of(r&&t(r,e),this))e&&e.descend(n),this.traverse(e,t),e&&e.ascend()}eachPick(e,t){this.traverse(e,(e,r)=>{null!=e.p&&t(e.p,r)})}eachDrop(e,t){this.traverse(e,(e,r)=>{null!=e.d&&t(e.d,r)})}};v(s,"ReadCursor"),e.ReadCursor=s;let l=class extends o{constructor(e=null){super(e),this.pendingDescent=[],this._op=e}flushDescent(){t(this.parents.length===this.indexes.length/2),null===this.container&&(this._op=this.container=[]);for(let e=0;e<this.pendingDescent.length;e++){let i=this.pendingDescent[e],a=this.idx+1;if(a<this.container.length&&r(this.container[a])&&a++,t(a===this.container.length||!r(this.container[a])),a===this.container.length)this.container.push(i),this.idx=a;else if(this.container[a]===i)this.idx=a;else{if(!Array.isArray(this.container[a])){let e=this.container.splice(a,this.container.length-a);this.container.push(e),this.lcIdx>-1&&(this.lcIdx=a)}for(this.indexes.push(this.idx),this.parents.push(this.container),-1!==this.lcIdx&&(t(n(i,this.container[this.lcIdx][0])),a=this.lcIdx+1,this.lcIdx=-1);a<this.container.length&&n(i,this.container[a][0]);)a++;if(this.indexes.push(a),this.idx=0,a<this.container.length&&this.container[a][0]===i)this.container=this.container[a];else{let e=[i];this.container.splice(a,0,e),this.container=e}}}this.pendingDescent.length=0}reset(){this.lcIdx=-1}getComponent(){this.flushDescent();let e=this.idx+1;if(e<this.container.length&&r(this.container[e]))return this.container[e];{let t={};return this.container.splice(e,0,t),t}}write(e,r){let n=this.getComponent();t(null==n[e]||n[e]===r,"Internal consistency error: Overwritten component. File a bug"),n[e]=r}get(){return this._op}descend(t){if(!e.isValidPathItem(t))throw Error("Invalid JSON key");this.pendingDescent.push(t)}descendPath(e){return this.pendingDescent.push(...e),this}ascend(){this.pendingDescent.length?this.pendingDescent.pop():super.ascend()}mergeTree(e,r=i){if(null===e)return;if(t(Array.isArray(e)),e===this._op)throw Error("Cannot merge into my own tree");let n=this.lcIdx,a=this.parents.length,o=0;for(let t=0;t<e.length;t++){let n=e[t];"string"==typeof n||"number"==typeof n?(o++,this.descend(n)):Array.isArray(n)?this.mergeTree(n,r):"object"==typeof n&&r(n,this)}for(;o--;)this.ascend();this.lcIdx=this.parents.length===a?n:-1}at(e,t){this.descendPath(e),t(this);for(let t=0;t<e.length;t++)this.ascend();return this}writeAtPath(e,t,r){return this.at(e,()=>this.write(t,r)),this.reset(),this}writeMove(e,t,r=0){return this.writeAtPath(e,"p",r).writeAtPath(t,"d",r)}getPath(){let e=super.getPath();return e.push(...this.pendingDescent),e}};function d(e,t,r){let i,a;function o(i){let o;for(;a;){let s=o=e.getKey();if(null!=i){let r=!1;if(t&&"number"==typeof s&&(o=t(s,e.getComponent()))<0&&(o=~o,r=!0),n(o,i))return null;if(o===i&&!r)return e}r&&"number"==typeof o&&r(o,e.getComponent()),a=e.nextSibling()}return null}return a=i=!!e&&e.descendFirst(),v(o,"adv"),o.end=()=>{i&&e.ascend()},o}function u(e,t,r){let i,a,o,s;for(i=a=e&&e.descendFirst(),o=s=t&&t.descendFirst();i||o;){let a=i?e.getKey():null,s=o?t.getKey():null;null!==a&&null!==s&&(n(s,a)?s=null:a!==s&&(a=null)),r(null==a?s:a,null!=a?e:null,null!=s?t:null),null!=a&&i&&(i=e.nextSibling()),null!=s&&o&&(o=t.nextSibling())}a&&e.ascend(),s&&t.ascend()}v(l,"WriteCursor"),e.WriteCursor=l,e.writeCursor=()=>new l,e.readCursor=e=>new s(e),v(d,"advancer"),e.advancer=d,v(u,"eachChildOf"),e.eachChildOf=u}(k);var N={};Object.defineProperty(N,"__esModule",{value:!0}),N.ConflictType=void 0,(A=N.ConflictType||(N.ConflictType={}))[A.RM_UNEXPECTED_CONTENT=1]="RM_UNEXPECTED_CONTENT",A[A.DROP_COLLISION=2]="DROP_COLLISION",A[A.BLACKHOLE=3]="BLACKHOLE";var A,x,L={},V={};function F(){return x||(x=1,Object.defineProperty(V,"__esModule",{value:!0}),V.uniToStrPos=V.strPosToUni=void 0,V.strPosToUni=(e,t=e.length)=>{let r=0,n=0;for(;n<t;n++){let t=e.charCodeAt(n);t>=55296&&t<=57343&&(r++,n++)}if(n!==t)throw Error("Invalid offset - splits unicode bytes");return n-r},V.uniToStrPos=(e,t)=>{let r=0;for(;t>0;t--){let t=e.charCodeAt(r);r+=t>=55296&&t<=57343?2:1}return r}),V}v(F,"requireUnicount");var j,H={};function $(){return j||(j=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.uniSlice=e.dlen=e.eachOp=void 0;let t=F(),r=/* @__PURE__ */v(t=>{if(!Array.isArray(t))throw Error("Op must be an array of components");let r=null;for(let n=0;n<t.length;n++){let i=t[n];switch(typeof i){case"object":if("number"!=typeof i.d&&"string"!=typeof i.d)throw Error("Delete must be number or string");if(0>=e.dlen(i.d))throw Error("Deletes must not be empty");break;case"string":if(!(i.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(i>0))throw Error("Skip components must be >0");if("number"==typeof r)throw Error("Adjacent skip components should be combined")}r=i}if("number"==typeof r)throw Error("Op has a trailing skip")},"checkOp");function n(r,n){let i=0,a=0;for(let o=0;o<r.length;o++){let s=r[o];switch(n(s,i,a),typeof s){case"object":i+=e.dlen(s.d);break;case"string":a+=t.strPosToUni(s);break;case"number":i+=s,a+=s}}}function i(e,t){let r=[],i=s(r);return n(e,(e,r,n)=>{i(t(e,r,n))}),c(r)}v(n,"eachOp"),e.eachOp=n,v(i,"mapOp");let a=/* @__PURE__ */v(e=>e,"id"),o=/* @__PURE__ */v(e=>i(e,a),"normalize");e.dlen=e=>"number"==typeof e?e:t.strPosToUni(e);let s=/* @__PURE__ */v(t=>r=>{if(!(!r||0===r.d||""===r.d)){if(0===t.length)t.push(r);else if(typeof r==typeof t[t.length-1]){if("object"==typeof r){let n=t[t.length-1];n.d="string"==typeof n.d&&"string"==typeof r.d?n.d+r.d:e.dlen(n.d)+e.dlen(r.d)}else t[t.length-1]+=r}else t.push(r)}},"makeAppend"),l=/* @__PURE__ */v(e=>"number"==typeof e?e:"string"==typeof e?t.strPosToUni(e):"number"==typeof e.d?e.d:t.strPosToUni(e.d),"componentLength");e.uniSlice=(e,r,n)=>{let i=t.uniToStrPos(e,r),a=null==n?1/0:t.uniToStrPos(e,n);return e.slice(i,a)};let d=/* @__PURE__ */v((t,r,n)=>"number"==typeof t?null==n?t-r:Math.min(t,n)-r:e.uniSlice(t,r,n),"dslice"),u=/* @__PURE__ */v(r=>{let n=0,i=0;return{take:/* @__PURE__ */v((a,o)=>{let s;if(n===r.length)return -1===a?null:a;let l=r[n];if("number"==typeof l)return -1===a||l-i<=a?(s=l-i,++n,i=0,s):(i+=a,a);if("string"==typeof l){if(-1===a||"i"===o||t.strPosToUni(l.slice(i))<=a)return s=l.slice(i),++n,i=0,s;{let e=i+t.uniToStrPos(l.slice(i),a);return s=l.slice(i,e),i=e,s}}if(-1===a||"d"===o||e.dlen(l.d)-i<=a)return s={d:d(l.d,i)},++n,i=0,s;{let e=d(l.d,i,i+a);return i+=a,{d:e}}},"take"),peek:/* @__PURE__ */v(()=>r[n],"peek")}},"makeTake"),c=/* @__PURE__ */v(e=>(e.length>0&&"number"==typeof e[e.length-1]&&e.pop(),e),"trim");function h(n,i,a){let o;if("left"!==a&&"right"!==a)throw Error("side ("+a+") must be 'left' or 'right'");r(n),r(i);let d=[],h=s(d),{take:m,peek:p}=u(n);for(let r=0;r<i.length;r++){let n,o;let s=i[r];switch(typeof s){case"number":for(n=s;n>0;)h(o=m(n,"i")),"string"!=typeof o&&(n-=l(o));break;case"string":"left"===a&&"string"==typeof p()&&h(m(-1)),h(t.strPosToUni(s));break;case"object":for(n=e.dlen(s.d);n>0;)switch(typeof(o=m(n,"i"))){case"number":n-=o;break;case"string":h(o);break;case"object":n-=e.dlen(o.d)}}}for(;o=m(-1);)h(o);return c(d)}function m(n,i){let a;r(n),r(i);let o=[],h=s(o),{take:m}=u(n);for(let r=0;r<i.length;r++){let n,a;let o=i[r];switch(typeof o){case"number":for(n=o;n>0;)h(a=m(n,"d")),"object"!=typeof a&&(n-=l(a));break;case"string":h(o);break;case"object":n=e.dlen(o.d);let s=0;for(;s<n;)switch(typeof(a=m(n-s,"d"))){case"number":h({d:d(o.d,s,s+a)}),s+=a;break;case"string":s+=t.strPosToUni(a);break;case"object":h(a)}}}for(;a=m(-1);)h(a);return c(o)}v(h,"transform"),v(m,"compose");let p=/* @__PURE__ */v((r,n)=>{let i=0;for(let a=0;a<n.length&&r>i;a++){let o=n[a];switch(typeof o){case"number":i+=o;break;case"string":let s=t.strPosToUni(o);i+=s,r+=s;break;case"object":r-=Math.min(e.dlen(o.d),r-i)}}return r},"transformPosition"),g=/* @__PURE__ */v((e,t)=>"number"==typeof e?p(e,t):e.map(e=>p(e,t)),"transformSelection");function f(e,t,r){return i(e,(e,n)=>"object"==typeof e&&"number"==typeof e.d?{d:r.slice(t,n,n+e.d)}:e)}function _(e){return i(e,e=>{switch(typeof e){case"object":if("number"==typeof e.d)throw Error("Cannot invert text op: Deleted characters missing from operation. makeInvertible must be called first.");return e.d;case"string":return{d:e};case"number":return e}})}function I(e){return i(e,e=>"object"==typeof e&&"string"==typeof e.d?{d:t.strPosToUni(e.d)}:e)}function S(e){let t=!0;return n(e,e=>{"object"==typeof e&&"number"==typeof e.d&&(t=!1)}),t}function C(t){return{name:"text-unicode",uri:"http://sharejs.org/types/text-unicode",trim:c,normalize:o,checkOp:r,create(e=""){if("string"!=typeof e)throw Error("Initial data must be a string");return t.create(e)},apply(n,i){r(i);let a=t.builder(n);for(let t=0;t<i.length;t++){let r=i[t];switch(typeof r){case"number":a.skip(r);break;case"string":a.append(r);break;case"object":a.del(e.dlen(r.d))}}return a.build()},transform:h,compose:m,transformPosition:p,transformSelection:g,isInvertible:S,makeInvertible:(e,r)=>f(e,r,t),stripInvertible:I,invert:_,invertWithDoc:(e,r)=>_(f(e,r,t)),isNoop:/* @__PURE__ */v(e=>0===e.length,"isNoop")}}v(f,"makeInvertible"),v(_,"invert"),v(I,"stripInvertible"),v(S,"isInvertible"),v(C,"makeType"),e.default=C}(H)),H}v($,"requireType");var B,W={};function G(){if(B)return W;B=1,Object.defineProperty(W,"__esModule",{value:!0});let e=$(),t=F();function r(r,n){return{get:r,getLength:()=>r().length,insert:(e,i,a)=>n([t.strPosToUni(r(),e),i],a),remove:(e,i,a)=>n([t.strPosToUni(r(),e),{d:i}],a),_onOp(t){e.eachOp(t,(t,r,n)=>{switch(typeof t){case"string":this.onInsert&&this.onInsert(n,t);break;case"object":let i=e.dlen(t.d);this.onRemove&&this.onRemove(n,i)}})},onInsert:null,onRemove:null}}return v(r,"api$1"),W.default=r,r.provides={text:!0},W}function Y(){return c||(c=1,function(e){var t=w&&w.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:/* @__PURE__ */v(function(){return t[r]},"get")})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),r=w&&w.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=w&&w.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&t(n,e,i);return r(n,e),n},i=w&&w.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.type=e.remove=e.insert=void 0;let a=F(),o=n($()),s=i(G()),l={create:e=>e,toString:e=>e,builder(e){if("string"!=typeof e)throw Error("Invalid document snapshot: "+e);let t=[];return{skip(r){let n=a.uniToStrPos(e,r);if(n>e.length)throw Error("The op is too long for this document");t.push(e.slice(0,n)),e=e.slice(n)},append(e){t.push(e)},del(t){e=e.slice(a.uniToStrPos(e,t))},build:()=>t.join("")+e}},slice:o.uniSlice},d=Object.assign(Object.assign({},o.default(l)),{api:s.default});e.type=d,e.insert=(e,t)=>0===t.length?[]:0===e?[t]:[e,t],e.remove=(e,t)=>0===o.dlen(t)?[]:0===e?[{d:t}]:[e,{d:t}];var u=$();Object.defineProperty(e,"makeType",{enumerable:!0,get:/* @__PURE__ */v(function(){return u.default},"get")})}(L)),L}v(G,"requireApi"),v(Y,"requireDist"),function(e){var t=w&&w.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.editOp=e.replaceOp=e.insertOp=e.moveOp=e.removeOp=e.type=void 0,t(T);let r=t(U);function n(e,t){if(!e)throw Error(t)}v(n,"assert"),e.type={name:"json1",uri:"http://sharejs.org/types/JSONv1",readCursor:k.readCursor,writeCursor:k.writeCursor,create:/* @__PURE__ */v(e=>e,"create"),isNoop:/* @__PURE__ */v(e=>null==e,"isNoop"),setDebug(e){},registerSubtype:p,checkValidOp:b,normalize:R,apply:E,transformPosition:M,compose:O,tryTransform:V,transform:j,makeInvertible:A,invert:D,invertWithDoc:x,RM_UNEXPECTED_CONTENT:N.ConflictType.RM_UNEXPECTED_CONTENT,DROP_COLLISION:N.ConflictType.DROP_COLLISION,BLACKHOLE:N.ConflictType.BLACKHOLE,transformNoConflict:/* @__PURE__ */v((e,t,r)=>B(()=>!0,e,t,r),"transformNoConflict"),typeAllowingConflictsPred:/* @__PURE__ */v(t=>Object.assign(Object.assign({},e.type),{transform:/* @__PURE__ */v((e,r,n)=>B(t,e,r,n),"transform")}),"typeAllowingConflictsPred")};let i=/* @__PURE__ */v(e=>e?e.getComponent():null,"getComponent");function a(e){return e&&"object"==typeof e&&!Array.isArray(e)}v(a,"isObject");let o=/* @__PURE__ */v(e=>Array.isArray(e)?e.slice():null!==e&&"object"==typeof e?Object.assign({},e):e,"shallowClone"),s=/* @__PURE__ */v(e=>e&&(null!=e.p||void 0!==e.r),"hasPick"),l=/* @__PURE__ */v(e=>e&&(null!=e.d||void 0!==e.i),"hasDrop");function d(e,t){return n(null!=e),"number"==typeof t?(n(Array.isArray(e),"Invalid key - child is not an array"),(e=e.slice()).splice(t,1)):(n(a(e),"Invalid key - child is not an object"),delete(e=Object.assign({},e))[t]),e}function u(e,t,r){return"number"==typeof t?(n(null!=e,"Container is missing for key"),n(Array.isArray(e),"Cannot use numerical key for object container"),n(e.length>=t,"Cannot insert into out of bounds index"),e.splice(t,0,r)):(n(a(e),"Cannot insert into missing item"),n(void 0===e[t],"Trying to overwrite value at key. Your op needs to remove it first"),e[t]=r),r}v(d,"removeChild"),v(u,"insertChildMut"),e.removeOp=(e,t=!0)=>k.writeCursor().writeAtPath(e,"r",t).get(),e.moveOp=(e,t)=>k.writeCursor().writeMove(e,t).get(),e.insertOp=(e,t)=>k.writeCursor().writeAtPath(e,"i",t).get(),e.replaceOp=(e,t,r)=>k.writeCursor().at(e,e=>{e.write("r",t),e.write("i",r)}).get(),e.editOp=(e,t,r,n=!1)=>k.writeCursor().at(e,e=>S(e,t,r,n)).get();let c=/* @__PURE__ */v((e,t)=>null!=e&&("number"==typeof t?Array.isArray(e):"object"==typeof e),"isValidKey"),h=/* @__PURE__ */v((e,t)=>c(e,t)?e[t]:void 0,"maybeGetChild"),m={};function p(e){let t=e.type?e.type:e;t.name&&(m[t.name]=t),t.uri&&(m[t.uri]=t)}v(p,"registerSubtype");let g=/* @__PURE__ */v(e=>{let t=m[e];if(t)return t;throw Error("Missing type: "+e)},"typeOrThrow");p(Y());let f=/* @__PURE__ */v((e,t)=>e+t,"add");p({name:"number",apply:f,compose:f,invert:/* @__PURE__ */v(e=>-e,"invert"),transform:/* @__PURE__ */v(e=>e,"transform")});let _=/* @__PURE__ */v(e=>null==e?null:e.et?g(e.et):e.es?m["text-unicode"]:null!=e.ena?m.number:null,"getEditType"),I=/* @__PURE__ */v(e=>e.es?e.es:null!=e.ena?e.ena:e.e,"getEdit"),S=/* @__PURE__ */v((e,t,r,n=!1)=>{let[i,a]="string"==typeof t?[g(t),t]:[t,t.name];!n&&i.isNoop&&i.isNoop(r)||("number"===a?e.write("ena",r):"text-unicode"===a?e.write("es",r):(e.write("et",a),e.write("e",r)))},"writeEdit");function C(e){n("number"==typeof e),n(e>=0),n(e===(0|e))}function y(e){"number"==typeof e?C(e):n("string"==typeof e)}function b(e){if(null===e)return;let t=/* @__PURE__ */new Set,r=/* @__PURE__ */new Set,i=/* @__PURE__ */v(e=>{let i=!0,a=!1;for(let o in e){let s=e[o];if(i=!1,n("p"===o||"r"===o||"d"===o||"i"===o||"e"===o||"es"===o||"ena"===o||"et"===o,"Invalid component item '"+o+"'"),"p"===o)C(s),n(!t.has(s)),t.add(s),n(void 0===e.r);else if("d"===o)C(s),n(!r.has(s)),r.add(s),n(void 0===e.i);else if("e"===o||"es"===o||"ena"===o){n(!a),a=!0;let t=_(e);n(t,"Missing type in edit"),t.checkValidOp&&t.checkValidOp(I(e))}}n(!i)},"checkComponent"),a=/* @__PURE__ */v((e,t,r)=>{if(!Array.isArray(e))throw Error("Op must be null or a list");if(0===e.length)throw Error("Empty descent");t||y(e[0]);let o=1,s=0,l=0;for(let t=0;t<e.length;t++){let r=e[t];if(n(null!=r),Array.isArray(r)){let e=a(r,!1);if(s){let t=typeof l,r=typeof e;t===r?n(l<e,"descent keys are not in order"):n("number"===t&&"string"===r)}l=e,s++,o=3}else"object"==typeof r?(n(1===o,`Prev not scalar - instead ${o}`),i(r),o=2):(n(3!==o),y(r),n(k.isValidPathItem(r),"Invalid path key"),o=1)}return n(1!==s,"Operation makes multiple descents. Remove some []"),n(2===o||3===o),e[0]},"checkDescent");a(e,!0),n(t.size===r.size,"Mismatched picks and drops in op");for(let e=0;e<t.size;e++)n(t.has(e)),n(r.has(e))}function R(e){let t=0,r=[],n=k.writeCursor();return n.mergeTree(e,(e,n)=>{var i;let a=_(e);if(a){let t=I(e);S(n,a,a.normalize?a.normalize(t):t)}for(let a of["r","p","i","d"])if(void 0!==e[a]){let o="p"===a||"d"===a?(null==r[i=e[a]]&&(r[i]=t++),r[i]):e[a];n.write(a,o)}}),n.get()}function E(e,t){if(b(t),null===t)return e;let r=[];return /* @__PURE__ */v(function e(t,i){let a=t,s=0,l={root:t},d=0,m=l,p="root";function g(){for(;d<s;d++){let e=i[d];"object"!=typeof e&&(n(c(m,p)),m=m[p]=o(m[p]),p=e)}}for(v(g,"mut");s<i.length;s++){let t=i[s];if(Array.isArray(t)){let r=e(a,t);r!==a&&void 0!==r&&(g(),a=m[p]=r)}else if("object"==typeof t){null!=t.d?(g(),a=u(m,p,r[t.d])):void 0!==t.i&&(g(),a=u(m,p,t.i));let e=_(t);if(e)g(),a=m[p]=e.apply(a,I(t));else if(void 0!==t.e)throw Error("Subtype "+t.et+" undefined")}else a=h(a,t)}return l.root},"drop")(e=/* @__PURE__ */v(function e(t,i){var a,l;let u=[],c=0;for(;c<i.length;c++){let e=i[c];if(Array.isArray(e))break;"object"!=typeof e&&(u.push(t),t=h(t,e))}for(let r=i.length-1;r>=c;r--)t=e(t,i[r]);for(--c;c>=0;c--){let e=i[c];if("object"!=typeof e){let r=u.pop();t=t===h(r,e)?r:void 0===t?d(r,e):(l=t,(a=o(a=r))[e]=l,a)}else s(e)&&(n(void 0!==t,"Cannot pick up or remove undefined"),null!=e.p&&(r[e.p]=t),t=void 0)}return t},"pick")(e,t),t)}function M(e,t){e=e.slice(),b(t);let r=k.readCursor(t),n,a,o=!1,d=[];for(let t=0;;t++){let i=e[t],l=r.getComponent();if(l&&(void 0!==l.r?o=!0:null!=l.p&&(o=!1,n=l.p,a=t)),t>=e.length)break;let u=0,c=k.advancer(r,void 0,(e,t)=>{s(t)&&u++});d.unshift(c);let h=c(i);if("number"==typeof i&&(e[t]-=u),!h)break}if(d.forEach(e=>e.end()),o)return null;let u=/* @__PURE__ */v(()=>{let t=0;if(null!=n){let n=r.getPath();t=n.length,e=n.concat(e.slice(a))}for(;t<e.length;t++){let n=e[t],a=i(r),o=_(a);if(o){let r=I(a);o.transformPosition&&(e[t]=o.transformPosition(e[t],r));break}let s=0,d=k.advancer(r,(e,t)=>l(t)?~(e-s):e-s,(e,t)=>{l(t)&&s++})(n);if("number"==typeof n&&(e[t]+=s),!d)break}},"handleDrop");return null!=n?r.eachDrop(null,e=>{e===n&&u()}):u(),e}function O(e,t){if(b(e),b(t),null==e)return t;if(null==t)return e;let r=k.readCursor(e),n=k.readCursor(t),i=k.writeCursor(),a=[],o=[],s=[],l=[],d=[],u=[],c=/* @__PURE__ */new Set;r.traverse(null,e=>{null!=e.p&&(s[e.p]=r.clone())}),n.traverse(null,e=>{null!=e.d&&(l[e.d]=n.clone())});let h=k.writeCursor();return /* @__PURE__ */r.clone(),n.clone(),i.reset(),i.mergeTree(h.get()),i.reset(),i.get(),a.map(e=>e.get()),o.map(e=>e.get()),r.traverse(i,(e,t)=>{let r=e.p;if(null!=r){let e=d[r];null!=e&&t.write("p",e);let n=a[r];n&&n.get(),n&&t.mergeTree(n.get())}else void 0!==e.r&&t.write("r",e.r)}),i.reset(),i.get(),n.traverse(i,(e,t)=>{let r=e.d;if(null!=r){let e=u[r];null!=e&&t.write("d",e);let n=o[r];n&&t.mergeTree(n.get())}else void 0!==e.i&&t.write("i",e.i);let n=_(e);n&&!c.has(e)&&S(t,n,I(e))}),i.get()}function D(e){let t;if(null==e)return null;let r=new k.ReadCursor(e),n=new k.WriteCursor,i=[];return /* @__PURE__ */t&&(n.reset(),/* @__PURE__ */r.clone(),i.length&&(n.reset(),r.traverse(n,(e,t)=>{let r=e.p;if(null!=r){let e=i[r];e&&e.get(),e&&t.mergeTree(e.get())}}))),n.get()}v(C,"checkNonNegInteger"),v(y,"checkScalar"),v(b,"checkValidOp"),v(R,"normalize"),v(E,"apply"),v(M,"transformPosition"),v(O,"compose"),v(D,"invert");let P=/* @__PURE__ */v((e,t)=>e.some(e=>"object"==typeof e&&(Array.isArray(e)?P(e,t):t(e))),"anyComponent");function A(e,t){if(null==e||!P(e,e=>{var t;return void 0!==e.r||(null===(t=_(e))||void 0===t?void 0:t.makeInvertible)!=null}))return e;let i=new k.ReadCursor(e),a=new k.WriteCursor,s=!1,l=[],u=[],c=/* @__PURE__ */v((e,t,i)=>{let a=e.getComponent(),m=!1;if(a){null!=a.d&&t.write("d",a.d),void 0!==a.i&&t.write("i",a.i);let r=a.p;if(null!=r&&(l[r]=e.clone(),n(void 0!==i,"Operation picks up at an invalid key"),u[r]=i,t.write("p",a.p)),void 0!==a.r&&void 0===i)throw Error("Invalid doc / op in makeInvertible: removed item missing from doc");let o=_(a);o&&(o.makeInvertible?s=!0:S(t,o,I(a),!0))}let p=0;for(let r of e){t.descend(r);let n="number"==typeof r?r-p:r,a=h(i,n),s=c(e,t,a);a!==s&&(m||(m=!0,i=o(i)),void 0===s?(i=d(i,n),"number"==typeof r&&p++):i[n]=s),t.ascend()}return a&&(void 0!==a.r?(t.write("r",r.default(i)),i=void 0):null!=a.p&&(i=void 0)),i},"traversePick");return c(i,a,t),a.get(),s&&(a.reset(),/* @__PURE__ */i.clone()),a.get()}function x(e,t){return D(A(e,t))}v(A,"makeInvertible"),v(x,"invertWithDoc");let L=/* @__PURE__ */v(e=>{if(null==e)return null;let t=e.slice();for(let r=0;r<e.length;r++){let e=t[r];Array.isArray(e)&&(t[r]=L(e))}return t},"shallowCloneOp");function V(e,t,r){n("left"===r||"right"===r,"Direction must be left or right");let i="left"===r?0:1;if(null==t)return{ok:!0,result:e};b(e),b(t);let a=null,o=[],s=[],l=[],d=[],u=[],c=[],h=[],m=[],p=[],g=[],f=k.readCursor(e),_=k.readCursor(t),I=k.writeCursor();if(/* @__PURE__ *//* @__PURE__ */_.clone(),d.map(e=>e&&e.get()),a)return{ok:!1,conflict:a};c.map(e=>!!e),/* @__PURE__ */_.clone(),I.reset();let S=[];if(/* @__PURE__ */f.clone(),_.clone(),a)return{ok:!1,conflict:a};I.reset();let C=/* @__PURE__ */v((e,t,r)=>e.traverse(t,(t,n)=>{null!=t.d&&r(t.d,e,n)}),"eachDrop");(u.length||h.length)&&(C(_,I,(e,t,r)=>{u[e]&&!c[e]&&r.write("r",!0),h[e]&&r.mergeTree(h[e].get())}),I.reset());let y=[],w=[];if((m.length||u.length)&&!a){let e=k.readCursor(L(I.get()));if(C(e,null,(e,t)=>{y[e]=t.clone()}),m.forEach(e=>{e&&C(k.readCursor(e.get()),null,(e,t)=>{y[e]=t.clone()})}),/* @__PURE__ */e.clone(),I.reset(),a)return{ok:!1,conflict:a};if(I.get(),w.length){let e=w.map(e=>e?e.get():null);if(C(k.readCursor(L(I.get())),I,(t,r,n)=>{let i=e[t];i&&(n.mergeTree(i),e[t]=null)}),e.find(e=>e)){let t=k.writeCursor(),r=k.writeCursor(),n=0,c=0;e.forEach(e=>{null!=e&&C(k.readCursor(e),null,e=>{let a=S[e];t.writeMove(o[a].getPath(),s[a].getPath(),n++);let h=g[a];h&&h.forEach(e=>{u[e]||1!==i&&null!=p[e]||r.writeMove(l[e].getPath(),d[e].getPath(),c++)})})}),a={type:N.ConflictType.BLACKHOLE,op1:t.get(),op2:r.get()}}}}return a?{ok:!1,conflict:a}:{ok:!0,result:I.get()}}v(V,"tryTransform");let F=/* @__PURE__ */v(e=>{let t=Error("Transform detected write conflict");throw t.conflict=e,t.type=t.name="writeConflict",t},"throwConflictErr");function j(e,t,r){let n=V(e,t,r);if(n.ok)return n.result;F(n.conflict)}v(j,"transform");let H=/* @__PURE__ */v(e=>{let t=k.writeCursor();return k.readCursor(e).traverse(t,(e,t)=>{(l(e)||_(e))&&t.write("r",!0)}),t.get()},"opThatRemovesDE"),$=/* @__PURE__ */v((e,t)=>{let{type:r,op1:n,op2:i}=e;switch(r){case N.ConflictType.DROP_COLLISION:return"left"===t?[null,H(i)]:[H(n),null];case N.ConflictType.RM_UNEXPECTED_CONTENT:let a=!1;return k.readCursor(n).traverse(null,e=>{void 0!==e.r&&(a=!0)}),a?[null,H(i)]:[H(n),null];case N.ConflictType.BLACKHOLE:return[H(n),H(i)];default:throw Error("Unrecognised conflict: "+r)}},"resolveConflict");function B(e,t,r,n){let i=null;for(;;){let a=V(t,r,n);if(a.ok)return O(i,a.result);{let{conflict:o}=a;e(o)||F(o);let[s,l]=$(o,n);t=O(R(t),s),r=O(R(r),l),i=O(i,l)}}}v(B,"transformWithConflictsPred")}(E),d=w&&w.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:/* @__PURE__ */v(function(){return t[r]},"get")})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),u=w&&w.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||d(t,e,r)},Object.defineProperty(R,"__esModule",{value:!0}),u(E,R),Object.defineProperty(R,"ReadCursor",{enumerable:!0,get:/* @__PURE__ */v(function(){return k.ReadCursor},"get")}),Object.defineProperty(R,"WriteCursor",{enumerable:!0,get:/* @__PURE__ */v(function(){return k.WriteCursor},"get")}),Object.defineProperty(R,"ConflictType",{enumerable:!0,get:/* @__PURE__ */v(function(){return N.ConflictType},"get")});let z=class{constructor(){_(this,"drawingManagerData",{}),_(this,"_oldDrawingManagerData",{}),_(this,"_focusDrawings",[]),_(this,"_remove$",new m.Subject),_(this,"remove$",this._remove$.asObservable()),_(this,"_add$",new m.Subject),_(this,"add$",this._add$.asObservable()),_(this,"_update$",new m.Subject),_(this,"update$",this._update$.asObservable()),_(this,"_order$",new m.Subject),_(this,"order$",this._order$.asObservable()),_(this,"_group$",new m.Subject),_(this,"group$",this._group$.asObservable()),_(this,"_ungroup$",new m.Subject),_(this,"ungroup$",this._ungroup$.asObservable()),_(this,"_refreshTransform$",new m.Subject),_(this,"refreshTransform$",this._refreshTransform$.asObservable()),_(this,"_visible$",new m.Subject),_(this,"visible$",this._visible$.asObservable()),_(this,"_focus$",new m.Subject),_(this,"focus$",this._focus$.asObservable()),_(this,"_featurePluginUpdate$",new m.Subject),_(this,"featurePluginUpdate$",this._featurePluginUpdate$.asObservable()),_(this,"_featurePluginAdd$",new m.Subject),_(this,"featurePluginAdd$",this._featurePluginAdd$.asObservable()),_(this,"_featurePluginRemove$",new m.Subject),_(this,"featurePluginRemove$",this._featurePluginRemove$.asObservable()),_(this,"_featurePluginOrderUpdate$",new m.Subject),_(this,"featurePluginOrderUpdate$",this._featurePluginOrderUpdate$.asObservable()),_(this,"_featurePluginGroupUpdate$",new m.Subject),_(this,"featurePluginGroupUpdate$",this._featurePluginGroupUpdate$.asObservable()),_(this,"_featurePluginUngroupUpdate$",new m.Subject),_(this,"featurePluginUngroupUpdate$",this._featurePluginUngroupUpdate$.asObservable()),_(this,"_visible",!0),_(this,"_editable",!0)}dispose(){this._remove$.complete(),this._add$.complete(),this._update$.complete(),this._order$.complete(),this._focus$.complete(),this._featurePluginUpdate$.complete(),this._featurePluginAdd$.complete(),this._featurePluginRemove$.complete(),this._featurePluginOrderUpdate$.complete(),this.drawingManagerData={},this._oldDrawingManagerData={}}visibleNotification(e){this._visible$.next(e)}refreshTransform(e){e.forEach(e=>{let t=this._getCurrentBySearch(e);null!=t&&(t.transform=e.transform,t.transforms=e.transforms,t.isMultiTransform=e.isMultiTransform)}),this.refreshTransformNotification(e)}getDrawingDataForUnit(e){return this.drawingManagerData[e]}removeDrawingDataForUnit(e){let t=this.drawingManagerData[e];if(null==t)return;delete this.drawingManagerData[e];let r=[];Object.keys(t).forEach(n=>{let i=t[n];(null==i?void 0:i.data)!=null&&Object.keys(i.data).forEach(t=>{r.push({unitId:e,subUnitId:n,drawingId:t})})}),r.length>0&&this.removeNotification(r)}registerDrawingData(e,t){this.drawingManagerData[e]=t}initializeNotification(e){let t=[],r=this.drawingManagerData[e];null!=r&&(Object.keys(r).forEach(n=>{this._establishDrawingMap(e,n);let i=r[n];Object.keys(i.data).forEach(r=>{let a=i.data[r];a.unitId=e,a.subUnitId=n,t.push(a)})}),t.length>0&&this.addNotification(t))}getDrawingData(e,t){return this._getDrawingData(e,t)}setDrawingData(e,t,r){this.drawingManagerData[e][t].data=r}getBatchAddOp(e){let t=[],r=[],n=[];e.forEach(e=>{let{op:i,invertOp:a}=this._addByParam(e);t.push({unitId:e.unitId,subUnitId:e.subUnitId,drawingId:e.drawingId}),r.push(i),n.push(a)});let i=r.reduce(R.type.compose,null),a=n.reduce(R.type.compose,null),{unitId:o,subUnitId:s}=e[0];return{undo:a,redo:i,unitId:o,subUnitId:s,objects:t}}getBatchRemoveOp(e){let t=[],r=[];e.forEach(e=>{let{op:n,invertOp:i}=this._removeByParam(e);t.unshift(n),r.push(i)});let n=t.reduce(R.type.compose,null),i=r.reduce(R.type.compose,null),{unitId:a,subUnitId:o}=e[0];return{undo:i,redo:n,unitId:a,subUnitId:o,objects:e}}getBatchUpdateOp(e){let t=[],r=[],n=[];e.forEach(e=>{let{op:i,invertOp:a}=this._updateByParam(e);t.push({unitId:e.unitId,subUnitId:e.subUnitId,drawingId:e.drawingId}),r.push(i),n.push(a)});let i=r.reduce(R.type.compose,null),a=n.reduce(R.type.compose,null),{unitId:o,subUnitId:s}=e[0];return{undo:a,redo:i,unitId:o,subUnitId:s,objects:t}}removeNotification(e){this._remove$.next(e)}addNotification(e){this._add$.next(e)}updateNotification(e){this._update$.next(e)}orderNotification(e){this._order$.next(e)}groupUpdateNotification(e){this._group$.next(e)}ungroupUpdateNotification(e){this._ungroup$.next(e)}refreshTransformNotification(e){this._refreshTransform$.next(e)}getGroupDrawingOp(e){let t=[],{unitId:r,subUnitId:n}=e[0].parent;e.forEach(e=>{t.push(this._getGroupDrawingOp(e))});let i=t.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(i,this.drawingManagerData),redo:i,unitId:r,subUnitId:n,objects:e}}getUngroupDrawingOp(e){let t=[],{unitId:r,subUnitId:n}=e[0].parent;e.forEach(e=>{t.push(this._getUngroupDrawingOp(e))});let i=t.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(i,this.drawingManagerData),redo:i,unitId:r,subUnitId:n,objects:e}}getDrawingsByGroup(e){let{unitId:t,subUnitId:r,drawingId:n}=e;if(null==this.getDrawingByParam({unitId:t,subUnitId:r,drawingId:n}))return[];let i=this._getDrawingData(t,r),a=[];return Object.keys(i).forEach(e=>{let t=i[e];t.groupId===n&&a.push(t)}),a}_getGroupDrawingOp(e){let{parent:t,children:r}=e,{unitId:n,subUnitId:i,drawingId:a}=t,o=[];o.push(R.insertOp([n,i,"data",a],t));let s=Number.NEGATIVE_INFINITY;return r.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._hasDrawingOrder({unitId:t,subUnitId:r,drawingId:n});s=Math.max(s,i),o.push(...this._getUpdateParamCompareOp(e,this.getDrawingByParam({unitId:t,subUnitId:r,drawingId:n})))}),s===Number.NEGATIVE_INFINITY&&(s=this._getDrawingOrder(n,i).length),o.push(R.insertOp([n,i,"order",s],a)),o.reduce(R.type.compose,null)}_getUngroupDrawingOp(e){let{parent:t,children:r}=e,{unitId:n,subUnitId:i,drawingId:a}=t,o=[];return r.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e;o.push(...this._getUpdateParamCompareOp(e,this.getDrawingByParam({unitId:t,subUnitId:r,drawingId:n})))}),o.push(R.removeOp([n,i,"data",a],!0)),o.push(R.removeOp([n,i,"order",this._getDrawingOrder(n,i).indexOf(a)],!0)),o.reduce(R.type.compose,null)}applyJson1(e,t,r){this._establishDrawingMap(e,t),this._oldDrawingManagerData={...this.drawingManagerData},this.drawingManagerData=R.type.apply(this.drawingManagerData,r)}featurePluginUpdateNotification(e){this._featurePluginUpdate$.next(e)}featurePluginOrderUpdateNotification(e){this._featurePluginOrderUpdate$.next(e)}featurePluginAddNotification(e){this._featurePluginAdd$.next(e)}featurePluginRemoveNotification(e){this._featurePluginRemove$.next(e)}featurePluginGroupUpdateNotification(e){this._featurePluginGroupUpdate$.next(e)}featurePluginUngroupUpdateNotification(e){this._featurePluginUngroupUpdate$.next(e)}getDrawingByParam(e){return this._getCurrentBySearch(e)}getOldDrawingByParam(e){return this._getOldBySearch(e)}getDrawingOKey(e){let[t,r,n]=e.split("#-#");return this._getCurrentBySearch({unitId:t,subUnitId:r,drawingId:n})}focusDrawing(e){if(null==e){this._focusDrawings=[],this._focus$.next([]);return}let t=[];e.forEach(e=>{var r;let{unitId:n,subUnitId:i,drawingId:a}=e,o=null==(r=this._getDrawingData(n,i))?void 0:r[a];null!=o&&t.push(o)}),t.length>0&&(this._focusDrawings=t,this._focus$.next(t))}getFocusDrawings(){let e=[];return this._focusDrawings.forEach(t=>{var r;let{unitId:n,subUnitId:i,drawingId:a}=t,o=null==(r=this._getDrawingData(n,i))?void 0:r[a];null!=o&&e.push(o)}),e}getDrawingOrder(e,t){return this._getDrawingOrder(e,t)}setDrawingOrder(e,t,r){this.drawingManagerData[e][t].order=r}orderUpdateNotification(e){this._order$.next(e)}getForwardDrawingsOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=[],a=this.getDrawingOrder(t,r),o=[...n];n.forEach(e=>{let n=this._hasDrawingOrder({unitId:t,subUnitId:r,drawingId:e});if(-1===n||n===a.length-1)return;let s=R.moveOp([t,r,"order",n],[t,r,"order",n+1]);i.push(s),o.includes(a[n+1])||o.push(a[n+1])});let s=i.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(s,this.drawingManagerData),redo:s,unitId:t,subUnitId:r,objects:{...e,drawingIds:o}}}getBackwardDrawingOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=[],a=this.getDrawingOrder(t,r),o=[...n];n.forEach(e=>{let n=this._hasDrawingOrder({unitId:t,subUnitId:r,drawingId:e});if(-1===n||0===n)return;let s=R.moveOp([t,r,"order",n],[t,r,"order",n-1]);i.push(s),o.includes(a[n-1])||o.push(a[n-1])});let s=i.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(s,this.drawingManagerData),redo:s,unitId:t,subUnitId:r,objects:{...e,drawingIds:o}}}getFrontDrawingsOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=this._getOrderFromSearchParams(t,r,n),a=[...n],o=this.getDrawingOrder(t,r),s=[];i.forEach(e=>{let{drawingId:n}=e,i=this._getDrawingCount(t,r)-1,l=R.moveOp([t,r,"order",this._getDrawingOrder(t,r).indexOf(n)],[t,r,"order",i]);s.push(l),a.includes(o[i])||a.push(o[i])});let l=s.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(l,this.drawingManagerData),redo:l,unitId:t,subUnitId:r,objects:{...e,drawingIds:a}}}getBackDrawingsOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=this._getOrderFromSearchParams(t,r,n,!0),a=[...n],o=this.getDrawingOrder(t,r),s=[];i.forEach(e=>{let{drawingId:n}=e,i=R.moveOp([t,r,"order",this._getDrawingOrder(t,r).indexOf(n)],[t,r,"order",0]);s.push(i),a.includes(o[0])||a.push(o[0])});let l=s.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(l,this.drawingManagerData),redo:l,unitId:t,subUnitId:r,objects:{...e,drawingIds:a}}}_getDrawingCount(e,t){return this.getDrawingOrder(e,t).length||0}_getOrderFromSearchParams(e,t,r,n=!1){return r.map(r=>{let n=this._hasDrawingOrder({unitId:e,subUnitId:t,drawingId:r});return{drawingId:r,zIndex:n}}).sort(!1===n?p.sortRules:p.sortRulesByDesc)}_hasDrawingOrder(e){if(null==e)return -1;let{unitId:t,subUnitId:r,drawingId:n}=e;return this._establishDrawingMap(t,r),this._getDrawingOrder(t,r).indexOf(n)}_getCurrentBySearch(e){var t,r,n;if(null==e)return;let{unitId:i,subUnitId:a,drawingId:o}=e;return null==(n=null==(r=null==(t=this.drawingManagerData[i])?void 0:t[a])?void 0:r.data)?void 0:n[o]}_getOldBySearch(e){var t,r,n;if(null==e)return;let{unitId:i,subUnitId:a,drawingId:o}=e;return null==(n=null==(r=null==(t=this._oldDrawingManagerData[i])?void 0:t[a])?void 0:r.data)?void 0:n[o]}_establishDrawingMap(e,t,r){var n;return this.drawingManagerData[e]||(this.drawingManagerData[e]={}),this.drawingManagerData[e][t]||(this.drawingManagerData[e][t]={data:{},order:[]}),null==r?null:null==(n=this.drawingManagerData[e][t].data)?void 0:n[r]}_addByParam(e){let{unitId:t,subUnitId:r,drawingId:n}=e;this._establishDrawingMap(t,r,n);let i=[R.insertOp([t,r,"data",n],e),R.insertOp([t,r,"order",this._getDrawingOrder(t,r).length],n)].reduce(R.type.compose,null),a=R.type.invertWithDoc(i,this.drawingManagerData);return{op:i,invertOp:a}}_removeByParam(e){if(null==e)return{op:[],invertOp:[]};let{unitId:t,subUnitId:r,drawingId:n}=e;if(null==this._establishDrawingMap(t,r,n))return{op:[],invertOp:[]};let i=[R.removeOp([t,r,"data",n],!0),R.removeOp([t,r,"order",this._getDrawingOrder(t,r).indexOf(n)],!0)].reduce(R.type.compose,null),a=R.type.invertWithDoc(i,this.drawingManagerData);return{op:i,invertOp:a}}_updateByParam(e){let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._establishDrawingMap(t,r,n);if(null==i)return{op:[],invertOp:[]};let a=this._getUpdateParamCompareOp(e,i).reduce(R.type.compose,null),o=R.type.invertWithDoc(a,this.drawingManagerData);return{op:a,invertOp:o}}_getUpdateParamCompareOp(e,t){let{unitId:r,subUnitId:n,drawingId:i}=e,a=[];return Object.keys(e).forEach(o=>{let s=e[o],l=t[o];l!==s&&a.push(R.replaceOp([r,n,"data",i,o],l,s))}),a}_getDrawingData(e,t){var r,n;return(null==(n=null==(r=this.drawingManagerData[e])?void 0:r[t])?void 0:n.data)||{}}_getDrawingOrder(e,t){var r,n;return(null==(n=null==(r=this.drawingManagerData[e])?void 0:r[t])?void 0:n.order)||[]}getDrawingVisible(){return this._visible}getDrawingEditable(){return this._editable}setDrawingVisible(e){this._visible=e}setDrawingEditable(e){this._editable=e}};v(z,"UnitDrawingService");let K=z,q=class extends K{};function X({unitId:e,subUnitId:t,drawingId:r},n){return"number"==typeof n?`${e}#-#${t}#-#${r}#-#${n}`:`${e}#-#${t}#-#${r}`}v(q,"DrawingManagerService"),v(X,"getDrawingShapeKeyByDrawingSearch");let Z=/* @__PURE__ */v(async e=>new Promise((t,r)=>{let n=new Image;n.src=e,n.onload=()=>{t({width:n.width,height:n.height,image:n})},n.onerror=e=>{r(e)}}),"getImageSize");var Q=((a=Q||{}).URL="URL",a.UUID="UUID",a.BASE64="BASE64",a),J=((o=J||{}).SUCCUSS="0",o.ERROR_EXCEED_SIZE="1",o.ERROR_IMAGE_TYPE="2",o.ERROR_UPLOAD_COUNT_LIMIT="3",o.ERROR_IMAGE="4",o);let ee=(0,p.createIdentifier)("core.image-io.service"),et=class{constructor(){_(this,"_waitCount",0),_(this,"_change$",new m.Subject),_(this,"change$",this._change$),_(this,"_imageSourceCache",/* @__PURE__ */new Map)}setWaitCount(e){this._waitCount=e,this._change$.next(e)}getImageSourceCache(e,t){if(t===Q.BASE64){let t=new Image;return t.src=e,t}return this._imageSourceCache.get(e)}addImageSourceCache(e,t,r){t===Q.BASE64||null==r||this._imageSourceCache.set(e,r)}async getImage(e){return Promise.resolve(e)}async saveImage(e){return new Promise((t,r)=>{if(!b.includes(e.type)){r(Error(J.ERROR_IMAGE_TYPE)),this._decreaseWaiting();return}if(e.size>y){r(Error(J.ERROR_EXCEED_SIZE)),this._decreaseWaiting();return}let n=new FileReader;n.readAsDataURL(e),n.onload=e=>{var n;let i=null==(n=e.target)?void 0:n.result;if(null==i){r(Error(J.ERROR_IMAGE)),this._decreaseWaiting();return}t({imageId:(0,p.Tools).generateRandomId(6),imageSourceType:Q.BASE64,source:i,base64Cache:i,status:J.SUCCUSS}),this._decreaseWaiting()}})}_decreaseWaiting(){this._waitCount-=1,this._change$.next(this._waitCount)}};v(et,"ImageIoService");var er=((s=er||{})[s.forward=0]="forward",s[s.backward=1]="backward",s[s.front=2]="front",s[s.back=3]="back",s),en=((l=en||{})[l.UNRECOGNIZED=-1]="UNRECOGNIZED",l[l.DRAWING_IMAGE=0]="DRAWING_IMAGE",l[l.DRAWING_SHAPE=1]="DRAWING_SHAPE",l[l.DRAWING_CHART=2]="DRAWING_CHART",l[l.DRAWING_TABLE=3]="DRAWING_TABLE",l[l.DRAWING_SMART_ART=4]="DRAWING_SMART_ART",l[l.DRAWING_VIDEO=5]="DRAWING_VIDEO",l[l.DRAWING_GROUP=6]="DRAWING_GROUP",l[l.DRAWING_UNIT=7]="DRAWING_UNIT",l[l.DRAWING_DOM=8]="DRAWING_DOM",l);let ei=(0,p.createIdentifier)("univer.drawing-manager.service"),ea={};var eo=Object.defineProperty,es=Object.getOwnPropertyDescriptor,el=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?es(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eo(t,r,a),a},"__decorateClass"),ed=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let eu=(v(h=class extends p.Plugin{constructor(e=ea,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("drawing.config",n)}onStarting(){this._initDependencies()}_initDependencies(){var e;(0,p.mergeOverrideWithDependencies)([[ee,{useClass:et}],[ei,{useClass:q}]],null==(e=this._config)?void 0:e.override).forEach(e=>this._injector.add(e))}},"UniverDrawingPlugin"),_(h,"pluginName","UNIVER_DRAWING_PLUGIN"),h);eu=el([ed(1,(0,p.Inject)(p.Injector)),ed(2,p.IConfigService)],eu)}),i("91LjJ",function(t,r){let i,a;e(t.exports,"SheetDrawingAnchorType",function(){return c}),e(t.exports,"ISheetDrawingService",function(){return m}),e(t.exports,"DrawingApplyType",function(){return p}),e(t.exports,"SetDrawingApplyMutation",function(){return g}),e(t.exports,"UniverSheetsDrawingPlugin",function(){return D});var o=n("83KcA"),s=n("e3ZB7"),l=Object.defineProperty,d=(e,t)=>l(e,"name",{value:t,configurable:!0});let u={};var c=((i=c||{}).Position="0",i.Both="1",i.None="2",i);let h=class extends s.UnitDrawingService{};d(h,"SheetDrawingService");let m=(0,o.createIdentifier)("sheets-drawing.sheet-drawing.service");var p=((a=p||{})[a.INSERT=0]="INSERT",a[a.REMOVE=1]="REMOVE",a[a.UPDATE=2]="UPDATE",a[a.ARRANGE=3]="ARRANGE",a[a.GROUP=4]="GROUP",a[a.UNGROUP=5]="UNGROUP",a);let g={id:"sheet.mutation.set-drawing-apply",type:o.CommandType.MUTATION,handler:/* @__PURE__ */d((e,t)=>{let r=e.get(s.IDrawingManagerService),n=e.get(m),{op:i,unitId:a,subUnitId:o,type:l,objects:d}=t;switch(r.applyJson1(a,o,i),n.applyJson1(a,o,i),l){case 0:r.addNotification(d),n.addNotification(d);break;case 1:r.removeNotification(d),n.removeNotification(d);break;case 2:r.updateNotification(d),n.updateNotification(d);break;case 3:r.orderNotification(d),n.orderNotification(d);break;case 4:r.groupUpdateNotification(d);break;case 5:r.ungroupUpdateNotification(d)}return!0},"handler")};var f=Object.defineProperty,v=Object.getOwnPropertyDescriptor,_=/* @__PURE__ */d((e,t,r,n)=>{for(var i,a=n>1?void 0:n?v(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&f(t,r,a),a},"__decorateClass$1"),I=/* @__PURE__ */d((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let S="SHEET_DRAWING_PLUGIN",C=(y=class extends o.Disposable{constructor(e,t,r,n){super(),this._commandService=e,this._sheetDrawingService=t,this._drawingManagerService=r,this._resourceManagerService=n,this._initSnapshot(),this.disposeWithMe(this._commandService.registerCommand(g))}_initSnapshot(){let e=/* @__PURE__ */d(e=>{let t=this._sheetDrawingService.getDrawingDataForUnit(e);return t?JSON.stringify(t):""},"toJson"),t=/* @__PURE__ */d(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:S,businesses:[o.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */d(t=>e(t),"toJson"),parseJson:/* @__PURE__ */d(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */d(e=>{this._sheetDrawingService.removeDrawingDataForUnit(e),this._drawingManagerService.removeDrawingDataForUnit(e)},"onUnLoad"),onLoad:/* @__PURE__ */d((e,t)=>{this._sheetDrawingService.registerDrawingData(e,t),this._drawingManagerService.registerDrawingData(e,t)},"onLoad")}))}},d(y,"SheetsDrawingLoadController"),y);C=_([(0,o.OnLifecycle)(o.LifecycleStages.Starting,C),I(0,o.ICommandService),I(1,m),I(2,s.IDrawingManagerService),I(3,o.IResourceManagerService)],C);var y,b,w=Object.defineProperty,R=Object.getOwnPropertyDescriptor,E=/* @__PURE__ */d((e,t,r)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),T=/* @__PURE__ */d((e,t,r,n)=>{for(var i,a=n>1?void 0:n?R(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&w(t,r,a),a},"__decorateClass"),M=/* @__PURE__ */d((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),O=/* @__PURE__ */d((e,t,r)=>E(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let D=(d(b=class extends o.Plugin{constructor(e=u,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("sheets-drawing.config",n)}onStarting(){[[C],[m,{useClass:h}]].forEach(e=>this._injector.add(e))}},"UniverSheetsDrawingPlugin"),b);O(D,"pluginName",S),O(D,"type",o.UniverInstanceType.UNIVER_SHEET),D=T([(0,o.DependentOn)(s.UniverDrawingPlugin),M(1,(0,o.Inject)(o.Injector)),M(2,o.IConfigService)],D)})}();
//# sourceMappingURL=es.812dc271.js.map
