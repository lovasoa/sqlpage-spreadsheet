!function(){function e(e,t,n,i){Object.defineProperty(e,t,{get:n,set:i,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire26fc,n=t.register;n("kB4bq",function(n,i){e(n.exports,"SetTextSelectionsOperation",function(){return h}),e(n.exports,"DocSelectionManagerService",function(){return I}),e(n.exports,"DocSkeletonManagerService",function(){return O}),e(n.exports,"DocStateEmitService",function(){return D}),e(n.exports,"RichTextEditingMutation",function(){return y}),e(n.exports,"UniverDocsPlugin",function(){return L}),e(n.exports,"DocInterceptorService",function(){return F});var r=t("83KcA"),s=t("D79YY"),o=t("jv4BO"),c=t("cZW0b"),a=Object.defineProperty,l=(e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,u=(e,t)=>a(e,"name",{value:t,configurable:!0}),d=(e,t,n)=>l(e,"symbol"!=typeof t?t+"":t,n);let h={id:"doc.operation.set-selections",type:r.CommandType.OPERATION,handler:/* @__PURE__ */u((e,t)=>!0,"handler")};var g,_=Object.defineProperty,f=Object.getOwnPropertyDescriptor,p=/* @__PURE__ */u((e,t,n,i)=>{for(var r,s=i>1?void 0:i?f(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(s=(i?r(t,n,s):r(s))||s);return i&&s&&_(t,n,s),s},"__decorateClass$4"),S=/* @__PURE__ */u((e,t)=>(n,i)=>t(n,i,e),"__decorateParam$4");let I=(u(g=class extends r.RxDisposable{constructor(e,t){super(),d(this,"_currentSelection",null),d(this,"_textSelectionInfo",/* @__PURE__ */new Map),d(this,"_textSelection$",new o.BehaviorSubject(null)),d(this,"textSelection$",this._textSelection$.asObservable()),d(this,"_refreshSelection$",new o.BehaviorSubject(null)),d(this,"refreshSelection$",this._refreshSelection$.asObservable()),this._commandService=e,this._univerInstanceService=t,this._listenCurrentUnit()}_listenCurrentUnit(){this._univerInstanceService.getCurrentTypeOfUnit$(r.UniverInstanceType.UNIVER_DOC).pipe((0,c.takeUntil)(this.dispose$)).subscribe(e=>{if(null==e)return;let t=e.getUnitId();this._setCurrentSelectionNotRefresh({unitId:t,subUnitId:t})})}getCurrentSelection(){return this._currentSelection}getCurrentSelectionInfo(){return this._getTextRanges(this._currentSelection)}refreshSelection(){null!=this._currentSelection&&this._refresh(this._currentSelection)}setCurrentSelection(e){this._currentSelection=e,this._refresh(e)}getCurrentTextRanges(){var e;return null==(e=this._getTextRanges(this._currentSelection))?void 0:e.textRanges}getCurrentRectRanges(){var e;return null==(e=this._getTextRanges(this._currentSelection))?void 0:e.rectRanges}getDocRanges(){var e,t;return[...null!=(e=this.getCurrentTextRanges())?e:[],...null!=(t=this.getCurrentRectRanges())?t:[]].filter(e=>null!=e.startOffset&&null!=e.endOffset).sort((e,t)=>e.startOffset>t.startOffset?1:e.startOffset<t.startOffset?-1:0)}getActiveTextRange(){let e=this._getTextRanges(this._currentSelection);if(null==e)return;let{textRanges:t}=e;return t.find(e=>e.isActive)}getActiveRectRange(){let e=this._getTextRanges(this._currentSelection);if(null==e)return;let{rectRanges:t}=e;return t.find(e=>e.isActive)}add(e,t=!0){null!=this._currentSelection&&this._addByParam({...this._currentSelection,textRanges:e,rectRanges:[],segmentId:"",segmentPage:-1,isEditing:t,style:s.NORMAL_TEXT_SELECTION_PLUGIN_STYLE})}replaceTextRanges(e,t=!0,n){if(null==this._currentSelection)return;let{unitId:i,subUnitId:r}=this._currentSelection;this._refreshSelection$.next({unitId:i,subUnitId:r,docRanges:e,isEditing:t,options:n})}__replaceTextRangesWithNoRefresh(e){if(null==this._currentSelection)return;let t={...this._currentSelection,...e};this._replaceByParam(t),this._textSelection$.next(t);let{unitId:n,subUnitId:i,segmentId:r,style:s,textRanges:o,rectRanges:c,isEditing:a}=t,l=[...o,...c].filter(e=>null!=e.startOffset&&null!=e.endOffset).sort((e,t)=>e.startOffset>t.startOffset?1:e.startOffset<t.startOffset?-1:0);this._commandService.executeCommand(h.id,{unitId:n,subUnitId:i,segmentId:r,style:s,isEditing:a,ranges:l})}dispose(){this._textSelection$.complete()}_setCurrentSelectionNotRefresh(e){var t;let{unitId:n,subUnitId:i}=null!=(t=this._currentSelection)?t:{},{unitId:r,subUnitId:s}=e;(n!==r||i!==s)&&(n&&i&&this._refreshSelection$.next({unitId:n,subUnitId:i,docRanges:[],isEditing:!1}),this._currentSelection=e)}_getTextRanges(e){var t;if(null==e)return;let{unitId:n,subUnitId:i=""}=e;return null==(t=this._textSelectionInfo.get(n))?void 0:t.get(i)}_refresh(e){let t=this._getTextRanges(e);if(null==t)return;let{textRanges:n,rectRanges:i}=t,r=[...n,...i],{unitId:s,subUnitId:o}=e;this._refreshSelection$.next({unitId:s,subUnitId:o,docRanges:r,isEditing:!1})}_replaceByParam(e){let{unitId:t,subUnitId:n,...i}=e;this._textSelectionInfo.has(t)||this._textSelectionInfo.set(t,/* @__PURE__ */new Map),this._textSelectionInfo.get(t).set(n,{...i})}_addByParam(e){let{unitId:t,subUnitId:n,...i}=e;this._textSelectionInfo.has(t)||this._textSelectionInfo.set(t,/* @__PURE__ */new Map);let r=this._textSelectionInfo.get(t);r.has(n)?r.get(n).textRanges.push(...e.textRanges):r.set(n,{...i})}},"DocSelectionManagerService"),g);I=p([S(0,r.ICommandService),S(1,r.IUniverInstanceService)],I);var m,v=Object.defineProperty,x=Object.getOwnPropertyDescriptor,b=/* @__PURE__ */u((e,t,n,i)=>{for(var r,s=i>1?void 0:i?x(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(s=(i?r(t,n,s):r(s))||s);return i&&s&&v(t,n,s),s},"__decorateClass$3"),R=/* @__PURE__ */u((e,t)=>(n,i)=>t(n,i,e),"__decorateParam$3");let O=(u(m=class extends r.RxDisposable{constructor(e,t,n){super(),d(this,"_skeleton"),d(this,"_docViewModel"),d(this,"_currentSkeleton$",new o.BehaviorSubject(null)),d(this,"currentSkeleton$",this._currentSkeleton$.asObservable()),d(this,"_currentSkeletonBefore$",new o.BehaviorSubject(null)),d(this,"currentSkeletonBefore$",this._currentSkeletonBefore$.asObservable()),d(this,"_currentViewModel$",new o.BehaviorSubject(null)),d(this,"currentViewModel$",this._currentViewModel$.asObservable()),this._context=e,this._localeService=t,this._univerInstanceService=n,this._init(),this._univerInstanceService.getCurrentTypeOfUnit$(r.UniverInstanceType.UNIVER_DOC).pipe((0,c.takeUntil)(this.dispose$)).subscribe(e=>{e&&e.getUnitId()===this._context.unitId&&this._update(e)})}dispose(){super.dispose(),this._currentSkeletonBefore$.complete(),this._currentSkeleton$.complete()}getSkeleton(){return this._skeleton}getViewModel(){return this._docViewModel}_init(){let e=this._context.unit;this._update(e)}_update(e){let t=this._context.unitId;if(null==e.getBody())return;this._docViewModel&&(0,r.isInternalEditorID)(t)?(this._docViewModel.reset(e),this._context.unit=e):this._docViewModel||(this._docViewModel=this._buildDocViewModel(e)),this._skeleton||(this._skeleton=this._buildSkeleton(this._docViewModel));let n=this._skeleton;n.calculate(),this._currentSkeletonBefore$.next(n),this._currentSkeleton$.next(n),this._currentViewModel$.next(this._docViewModel)}_buildSkeleton(e){return(0,s.DocumentSkeleton).create(e,this._localeService)}_buildDocViewModel(e){return new s.DocumentViewModel(e)}},"DocSkeletonManagerService"),m);O=b([R(1,(0,r.Inject)(r.LocaleService)),R(2,r.IUniverInstanceService)],O);let C=class extends r.RxDisposable{constructor(){super(),d(this,"_docStateChangeParams$",new o.BehaviorSubject(null)),d(this,"docStateChangeParams$",this._docStateChangeParams$.asObservable())}emitStateChangeInfo(e){this._docStateChangeParams$.next(e)}dispose(){super.dispose(),this._docStateChangeParams$.complete()}};u(C,"DocStateEmitService");let D=C,M="doc.mutation.rich-text-editing",y={id:M,type:r.CommandType.MUTATION,handler:/* @__PURE__ */u((e,t)=>{var n,i;let{unitId:o,segmentId:c="",actions:a,textRanges:l,prevTextRanges:u,trigger:d,noHistory:h,isCompositionEnd:g,noNeedSetTextRange:_,debounce:f}=t,p=e.get(r.IUniverInstanceService),S=e.get(s.IRenderManagerService),m=e.get(D),v=p.getUniverDocInstance(o),x=null==(n=S.getRenderById(o))?void 0:n.with(O).getViewModel();if(null==v||null==x)throw Error(`DocumentDataModel or documentViewModel not found for unitId: ${o}`);let b=e.get(I),R=null!=(i=b.getDocRanges())?i:[],C=!!v.getSnapshot().disabled;if((0,r.JSONX).isNoop(a)||a&&0===a.length||C)return{unitId:o,actions:[],textRanges:R};let y=(0,r.JSONX).invertWithDoc(a,v.getSnapshot());return v.apply(a),x.reset(v),!_&&l&&null!=d&&queueMicrotask(()=>{b.replaceTextRanges(l,!0,t.options)}),m.emitStateChangeInfo({commandId:M,unitId:o,segmentId:c,trigger:d,noHistory:h,debounce:f,redoState:{actions:a,textRanges:l},undoState:{actions:y,textRanges:null!=u?u:R},isCompositionEnd:g}),{unitId:o,actions:y,textRanges:R}},"handler")},U={id:"doc.mutation.rename-doc",type:r.CommandType.MUTATION,handler:/* @__PURE__ */u((e,t)=>{let n=e.get(r.IUniverInstanceService).getUnit(t.unitId,r.UniverInstanceType.UNIVER_DOC);return!!n&&(n.setName(t.name),!0)},"handler")},T={};var w,$=Object.defineProperty,E=Object.getOwnPropertyDescriptor,N=/* @__PURE__ */u((e,t,n,i)=>{for(var r,s=i>1?void 0:i?E(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(s=(i?r(t,n,s):r(s))||s);return i&&s&&$(t,n,s),s},"__decorateClass$2"),P=/* @__PURE__ */u((e,t)=>(n,i)=>t(n,i,e),"__decorateParam$2");let B=(u(w=class extends r.Disposable{constructor(e,t,n){super(),this._commandService=e,this._textSelectionManagerService=t,this._univerInstanceService=n,this._initSelectionChange()}_transformCustomRange(e,t){var n;let{startOffset:i,endOffset:s,collapsed:o}=t,c=null==(n=e.getCustomRanges())?void 0:n.filter(e=>!!e.wholeEntity&&(!(i<=e.startIndex)||!(s>e.endIndex))&&(o?e.startIndex<i&&e.endIndex>=s:(0,r.BuildTextUtils).range.isIntersects(i,s-1,e.startIndex,e.endIndex)));if(null!=c&&c.length){let e=i,n=s;return c.forEach(t=>{e=Math.min(t.startIndex,e),n=Math.max(t.endIndex+1,n)}),{...t,startOffset:e,endOffset:n,collapsed:e===n}}return t}_initSelectionChange(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===h.id){let{unitId:t,ranges:n,isEditing:i}=e.params,r=this._univerInstanceService.getUnit(t);if(!r)return;let s=n.map(e=>this._transformCustomRange(r,e));s.some((e,t)=>n[t]!==e)&&this._textSelectionManagerService.replaceTextRanges(s,i)}}))}},"DocCustomRangeController"),w);B=N([(0,r.OnLifecycle)(r.LifecycleStages.Ready,B),P(0,r.ICommandService),P(1,(0,r.Inject)(I)),P(2,r.IUniverInstanceService)],B);var j=Object.defineProperty,k=Object.getOwnPropertyDescriptor,V=/* @__PURE__ */u((e,t,n,i)=>{for(var r,s=i>1?void 0:i?k(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(s=(i?r(t,n,s):r(s))||s);return i&&s&&j(t,n,s),s},"__decorateClass$1"),A=/* @__PURE__ */u((e,t)=>(n,i)=>t(n,i,e),"__decorateParam$1");let L=(u(G=class extends r.Plugin{constructor(e=T,t,n){super(),this._config=e,this._injector=t,this._configService=n;let{...i}=this._config;this._configService.setConfig("docs.config",i),this._initializeDependencies(t),this._initializeCommands()}_initializeCommands(){[y,U,h].forEach(e=>{this._injector.get(r.ICommandService).registerCommand(e)})}_initializeDependencies(e){[[I],[D],[B]].forEach(t=>e.add(t))}},"UniverDocsPlugin"),d(G,"pluginName","DOCS_PLUGIN"),d(G,"type",r.UniverInstanceType.UNIVER_DOC),G);L=V([A(1,(0,r.Inject)(r.Injector)),A(2,r.IConfigService)],L);let W={CUSTOM_RANGE:(0,r.createInterceptorKey)("CUSTOM_RANGE"),CUSTOM_DECORATION:(0,r.createInterceptorKey)("CUSTOM_DECORATION")};var G,Y,z=Object.defineProperty,K=Object.getOwnPropertyDescriptor,q=/* @__PURE__ */u((e,t,n,i)=>{for(var r,s=i>1?void 0:i?K(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(s=(i?r(t,n,s):r(s))||s);return i&&s&&z(t,n,s),s},"__decorateClass"),X=/* @__PURE__ */u((e,t)=>(n,i)=>t(n,i,e),"__decorateParam");let F=(Y=class extends r.Disposable{constructor(e,t){super(),d(this,"_interceptorsByName",/* @__PURE__ */new Map),this._context=e,this._docSkeletonManagerService=t;let n=this._docSkeletonManagerService.getViewModel(),i=n.getDataModel().getUnitId();if(i===r.DOCS_NORMAL_EDITOR_UNIT_ID_KEY||i===r.DOCS_FORMULA_BAR_EDITOR_UNIT_ID_KEY)return;this.disposeWithMe(this.interceptDocumentViewModel(n)),this.disposeWithMe(this.intercept(W.CUSTOM_RANGE,{priority:-1,handler:/* @__PURE__ */u((e,t,n)=>n(e),"handler")}));let s=new r.DisposableCollection;n.segmentViewModels$.subscribe(e=>{s.dispose(),s=new r.DisposableCollection,e.forEach(e=>{s.add(this.interceptDocumentViewModel(e))})}),this.disposeWithMe(s)}intercept(e,t){this._interceptorsByName.has(e)||this._interceptorsByName.set(e,[]);let n=this._interceptorsByName.get(e);return n.push(t),this._interceptorsByName.set(e,n.sort((e,t)=>{var n,i;return(null!=(n=t.priority)?n:0)-(null!=(i=e.priority)?i:0)})),this.disposeWithMe((0,r.toDisposable)(()=>(0,r.remove)(this._interceptorsByName.get(e),t)))}fetchThroughInterceptors(e){let t=this._interceptorsByName.get(e);return(0,r.composeInterceptors)(t||[])}interceptDocumentViewModel(e){let t=new r.DisposableCollection;return t.add(e.registerCustomRangeInterceptor({getCustomRange:/* @__PURE__ */u(t=>{var n;return this.fetchThroughInterceptors(W.CUSTOM_RANGE)(e.getCustomRangeRaw(t),{index:t,unitId:e.getDataModel().getUnitId(),customRanges:null!=(n=e.getDataModel().getCustomRanges())?n:[]})},"getCustomRange"),getCustomDecoration:/* @__PURE__ */u(t=>{var n;return this.fetchThroughInterceptors(W.CUSTOM_DECORATION)(e.getCustomDecorationRaw(t),{index:t,unitId:e.getDataModel().getUnitId(),customDecorations:null!=(n=e.getDataModel().getCustomDecorations())?n:[]})},"getCustomDecoration")})),t}},u(Y,"DocInterceptorService"),Y);F=q([(0,r.OnLifecycle)(r.LifecycleStages.Starting,F),X(1,(0,r.Inject)(O))],F)}),n("cZW0b",function(n,i){e(n.exports,"takeUntil",function(){return a});var r=t("jaOYC"),s=t("hMcgT"),o=t("jzqEI"),c=t("gyLB6");function a(e){return(0,r.operate)(function(t,n){(0,o.innerFrom)(e).subscribe((0,s.createOperatorSubscriber)(n,function(){return n.complete()},c.noop)),n.closed||t.subscribe(n)})}})}();
//# sourceMappingURL=es.5a078b65.js.map
